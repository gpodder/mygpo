commit ce21597630e4fae0c2cbd7446b69f6474fdcfabc
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Jan 26 16:25:41 2010 +0100

    a Please enter the commit message for your changes.

diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index 710e16e..2b46939 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -11,7 +11,7 @@
    <p class="description">{{ podcast.description }}</p>
   {% endif %}
 
-  {% if anonymous %}
+  {% if not user.is_authenticated %}
     <div class="subscribe">
      <a href="/podcast/{{ podcast.id }}/subscribe">
       {% if podcast.title %}
diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 71f91e1..37d6cdb 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -33,7 +33,8 @@ def login_user(request):
               username = request.POST['user']
               password = request.POST['pwd']
        except:
-              return render_to_response('login.html')
+              current_site = Site.objects.get(id=settings.SITE_ID)
+              return render_to_response('login.html', {'url': current_site})
 
        user = authenticate(username=username, password=password)
        if user is not None:

commit 981b173cf088ba42ee252e73dfd1ac8f9c83c6fe
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Jan 26 15:15:05 2010 +0100

    fixed bug 814
    :

diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index 9abd11c..710e16e 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -11,7 +11,19 @@
    <p class="description">{{ podcast.description }}</p>
   {% endif %}
 
-  {% if devices|length_is:"0" %}
+  {% if anonymous %}
+    <div class="subscribe">
+     <a href="/podcast/{{ podcast.id }}/subscribe">
+      {% if podcast.title %}
+       {% blocktrans with podcast.title as podcasttitle %}Subscribe to {{ podcasttitle }}{% endblocktrans %}
+      {% else %}
+       {% trans "Subscribe to this podcast" %}
+      {% endif %}
+     </a>
+    </div>	
+  {% else %}
+
+  {% if devices|length_is:"0"  %}
 
    {% if can_subscribe %}
     <div class="subscribe">
@@ -97,11 +109,10 @@
      </tr>
     {% endfor %}
    </table>
+  {% endif %} 
   {% endif %}
-
   {% if not podcast.title %}
    <div class="info"><strong>{% trans "Why Unnamed Podcast?" %}</strong> {% trans "Because we display names after we have fetched the information form the feed -- and this may take some time. Until this is completed, the podcast will simply be called this way." %}</div>
   {% endif %}
-
 {% endblock %}
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 270729d..71851ad 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -67,23 +67,32 @@ def create_subscriptionlist(request):
 
     return l.values()
 
-@login_required
 def podcast(request, pid):
-    podcast = Podcast.objects.get(pk=pid)
-    devices = Device.objects.filter(user=request.user)
-    history = SubscriptionAction.objects.filter(podcast=podcast,device__in=devices).order_by('-timestamp')
-    subscribed_devices = [s.device for s in Subscription.objects.filter(podcast=podcast,user=request.user)]
-    subscribe_targets = podcast.subscribe_targets(request.user)
-    episodes = episode_list(podcast, request.user)
-    unsubscribe = '/podcast/' + pid + '/unsubscribe'
-    return render_to_response('podcast.html', {
-        'history': history,
-        'podcast': podcast,
-        'devices': subscribed_devices,
-        'can_subscribe': len(subscribe_targets) > 0,
-        'episodes': episodes,
-        'unsubscribe': unsubscribe,
-    }, context_instance=RequestContext(request))
+    if request.user.is_authenticated():
+        podcast = Podcast.objects.get(pk=pid)
+        devices = Device.objects.filter(user=request.user)
+        history = SubscriptionAction.objects.filter(podcast=podcast,device__in=devices).order_by('-timestamp')
+        subscribed_devices = [s.device for s in Subscription.objects.filter(podcast=podcast,user=request.user)]
+        subscribe_targets = podcast.subscribe_targets(request.user)
+        episodes = episode_list(podcast, request.user)
+        unsubscribe = '/podcast/' + pid + '/unsubscribe'
+        return render_to_response('podcast.html', {
+            'history': history,
+            'podcast': podcast,
+            'devices': subscribed_devices,
+            'can_subscribe': len(subscribe_targets) > 0,
+            'episodes': episodes,
+            'unsubscribe': unsubscribe,
+        }, context_instance=RequestContext(request))
+    else:
+        podcast = Podcast.objects.get(pk=pid)
+        current_site = Site.objects.get_current()
+
+        return render_to_response('podcast.html', {
+            'podcast': podcast,   
+            'url': current_site,
+            'anonymous': True         
+        }, context_instance=RequestContext(request))
 
 def history(request, len=20):
     devices = Device.objects.filter(user=request.user)

commit 5d50e303a8670092094ee431ea1290b066f87d1f
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Jan 26 13:45:00 2010 +0100

    added some features for delete devices

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 0537646..c463095 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -59,7 +59,7 @@ class Podcast(models.Model):
         """
         targets = []
 
-        devices = Device.objects.filter(user=user)
+        devices = Device.objects.filter(user=user, deleted=False)
         for d in devices:
             subscriptions = [x.podcast for x in d.get_subscriptions()]
             if self in subscriptions: continue
@@ -177,7 +177,7 @@ class Device(models.Model):
         """
         returns all Devices and SyncGroups that can be used as a parameter for self.sync_with()
         """
-        sync_targets = list(Device.objects.filter(user=self.user, sync_group=None).exclude(pk=self.id))
+        sync_targets = list(Device.objects.filter(user=self.user, sync_group=None, deleted=False).exclude(pk=self.id))
 
         sync_groups = SyncGroup.objects.filter(user=self.user)
         if self.sync_group != None: sync_groups = sync_groups.exclude(pk=self.sync_group.id)
diff --git a/mygpo/web/templates/device.html b/mygpo/web/templates/device.html
index 0ad295f..09644ef 100644
--- a/mygpo/web/templates/device.html
+++ b/mygpo/web/templates/device.html
@@ -6,6 +6,8 @@
 {% block content %}
   <h1>{{ device.name }}</h1>
 
+  <div class="info">{% if device.deleted %}{% trans "This device was deleted." %}{% endif %}</div>
+
   <h2>{% trans "Podcasts" %}</h2>
   <p>{% trans "You have subscribed the following podcasts on this device" %}
   <table class="list">
@@ -26,6 +28,8 @@
    {% endfor %}
   </table>
 
+  {% if not device.deleted %}
+
   <h2>{% trans "Synchronize" %}</h2>
   <p>{% blocktrans %}If you synchronize devices, they will always have the same subscriptions. A podcast that is subscribed on one device, will automatically be added to all synchronized devices.{% endblocktrans %}</p>
 
@@ -62,6 +66,7 @@
    <input type="submit" value="{% trans "Delete this device" %}" />
   </form>
   <br />
+  {% endif %}
   <div class="info">The <strong>UID</strong> connects your physical device with this page, so you should enter the same text on your device and here.</div>
 
 {% endblock %}

commit d1a371af11b1a9b7154887f7ff7da1bd0efed4a1
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Jan 26 13:21:02 2010 +0100

    Added the function to delete devices on the webpage

diff --git a/install/update-13.sql b/install/update-13.sql
new file mode 100644
index 0000000..1b2c2db
--- /dev/null
+++ b/install/update-13.sql
@@ -0,0 +1,3 @@
+
+-- Bug 785 --
+ALTER TABLE device ADD COLUMN deleted tinyint(1) NOT NULL DEFAULT 0;
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 6e5d47e..0537646 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -160,6 +160,7 @@ class Device(models.Model):
     name = models.CharField(max_length=100, blank=True)
     type = models.CharField(max_length=10, choices=DEVICE_TYPES)
     sync_group = models.ForeignKey(SyncGroup, blank=True, null=True)
+    deleted = models.BooleanField(default=False)
 
     def __unicode__(self):
         return self.name if self.name else _('Unnamed Device (%s)' % self.uid)
diff --git a/mygpo/urls.py b/mygpo/urls.py
index e565af7..6e4fbc5 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -58,6 +58,7 @@ urlpatterns = patterns('',
     (r'^device/(?P<device_id>\d+)$', 'mygpo.web.views.device'),
     (r'^device/(?P<device_id>\d+)/sync$', 'mygpo.web.views.device_sync'),
     (r'^device/(?P<device_id>\d+)/unsync$', 'mygpo.web.views.device_unsync'),
+    (r'^device/(?P<device_id>\d+)/delete$', 'mygpo.web.views.device_delete'),
 
     (r'^search/', include('haystack.urls')),
 
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 15fa6fd..79c03f8 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -20,9 +20,9 @@
 # along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
 #
 -->
-  <title>{% block title %}{% endblock %}{{ url }}</title>
+  <title>{% block title %}{% endblock %}my.gpodder.org</title>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
-  <link rel="shortcut icon" href="http://{{ url }}/favicon.png">
+  <link rel="shortcut icon" href="http://my.gpodder.org/favicon.png">
   <link rel="stylesheet" href="/media/screen.css" type="text/css" />
   <link rel="stylesheet" href="/media/screen-base.css" type="text/css" />
  </head>
diff --git a/mygpo/web/templates/device.html b/mygpo/web/templates/device.html
index 8cbbaf1..0ad295f 100644
--- a/mygpo/web/templates/device.html
+++ b/mygpo/web/templates/device.html
@@ -47,7 +47,7 @@
    </form>
   {% endif %}
 
-  <h2>Edit</h2>
+  <h2>{% trans "Edit" %}</h2>
   {% if success %}
    <div class="success">{% trans "Your settings have been saved." %}</div>
   {% endif %}
@@ -57,6 +57,11 @@
    <input type="submit" value="Save" />
   </form>
 
+  <h2>{% trans "Delete" %}</h2>
+  <form action="/device/{{ device.id }}/delete" method="POST">
+   <input type="submit" value="{% trans "Delete this device" %}" />
+  </form>
+  <br />
   <div class="info">The <strong>UID</strong> connects your physical device with this page, so you should enter the same text on your device and here.</div>
 
 {% endblock %}
diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index adf007d..112c082 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -3,6 +3,10 @@
 {% load devices %}
 
 {% block content %}
+{% if deletedevice_success %}
+   <div class="success">{% blocktrans %}The device {{ device_name }} has been deleted.{% endblocktrans %}</div>
+{% endif %}
+
 <h1>{% trans "Your Subscriptions" %}</h1>
 
  {% if not subscriptionlist|length_is:"0" %}
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index ba605ef..270729d 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -93,7 +93,7 @@ def history(request, len=20):
     }, context_instance=RequestContext(request))
 
 def devices(request):
-    devices = Device.objects.filter(user=request.user)
+    devices = Device.objects.filter(user=request.user,deleted=False)
     return render_to_response('devicelist.html', {
         'devices': devices,
     }, context_instance=RequestContext(request))
@@ -275,6 +275,25 @@ def device(request, device_id):
 
 
 @login_required
+def device_delete(request, device_id):
+    if request.method != 'POST':
+        return HttpResponseNotAllowed(['POST'])
+   
+    device = Device.objects.get(pk=device_id)
+    device.deleted = True
+    device.save()
+
+    current_site = Site.objects.get_current()
+    subscriptionlist = create_subscriptionlist(request)              
+    return render_to_response('home-user.html', {
+         'subscriptionlist': subscriptionlist,
+         'url': current_site,
+	  'deletedevice_success': True,
+         'device_name': device.name
+    }, context_instance=RequestContext(request))
+
+
+@login_required
 def device_sync(request, device_id):
 
     if request.method != 'POST':

commit 51e1b70de2af6c10b36c4c9a3c205737e3ccdc10
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Jan 26 09:46:37 2010 +0100

    simplyfied site handling
    
    replacing Site.objects.get(id=settings.SITE_ID) with Site.objects.get_current()

diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index a741c18..ba605ef 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -32,7 +32,7 @@ from django.conf import settings
 import re
 
 def home(request):
-       current_site = Site.objects.get(id=settings.SITE_ID)
+       current_site = Site.objects.get_current()
        if request.user.is_authenticated():
               subscriptionlist = create_subscriptionlist(request)              
 
@@ -196,7 +196,7 @@ def account(request):
 
 def toplist(request, len=100):
     entries = ToplistEntry.objects.all().order_by('-subscriptions')[:len]
-    current_site = Site.objects.get(id=settings.SITE_ID)
+    current_site = Site.objects.get_current()
     return render_to_response('toplist.html', {
         'entries': entries,
         'url': current_site
@@ -222,7 +222,7 @@ def suggestions(request):
         rated = True
 
     entries = SuggestionEntry.forUser(request.user)
-    current_site = Site.objects.get(id=settings.SITE_ID)
+    current_site = Site.objects.get_current()
     return render_to_response('suggestions.html', {
         'entries': entries,
         'rated'  : rated,
@@ -319,7 +319,7 @@ def podcast_subscribe_url(request):
     
 
 def author(request):
-    current_site = Site.objects.get(id=settings.SITE_ID)
+    current_site = Site.objects.get_current()
     return render_to_response('authors.html', {
         'url': current_site
     }, context_instance=RequestContext(request))

commit fc342e175431b808f012196744ce4b68abc928bf
Merge: 7767946... 071bff2...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Jan 26 09:42:19 2010 +0100

    Merge branch 'master' of /home/armin/mygpo-src

commit 776794620eb5dadc923f45d56ed6c207d69793a7
Merge: 30c744a... c6be80b...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Jan 25 23:15:57 2010 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit 30c744a236b6d7284e6b751c64b8be273bfb6c28
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Jan 25 23:15:30 2010 +0100

    error handling in sanitizing-maintenance

diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
index 3933839..4012993 100644
--- a/mygpo/api/sanitizing.py
+++ b/mygpo/api/sanitizing.py
@@ -57,6 +57,7 @@ def maintenance():
     merged = 0
     updated = 0
     deleted = 0
+    error = 0
 
     count = 0
 
@@ -66,39 +67,63 @@ def maintenance():
     for p in podcasts:
         count += 1
         if (count % 100) == 0: print '%s %% (podcast id %s)' % (((count + 0.0)/podcasts.count()*100), p.id)
-        su = sanitize_url(p.url, rules)
+        try:
+            su = sanitize_url(p.url, rules)
+        except Exception, e:
+            log('failed to sanitize url for podcast %s: %s' % (p.id, e))
+            error += 1
+            continue
+
+        # nothing to do
         if su == p.url: 
             unchanged += 1
             continue
 
+        # invalid podcast, remove
         if su == '':
-            delete_podcast(p)
-            deleted += 1
+            try:
+                delete_podcast(p)
+                deleted += 1
+            except Exception, e:
+                log('failed to delete podcast %s: %s' % (p.id, e))
+                error += 1
+
             continue
-    
+
         try:
             su_podcast = Podcast.objects.get(url=su)
 
-            if p == su_podcast:
-                unchanged += 1
-                continue
+        except Podcast.DoesNotExist, e:
+            # "target" podcast does not exist, we simply change the url
+            log('updating podcast %s - "%s" => "%s"' % (p.id, p.url, su))
+            p.url = su
+            p.save()
+            updated += 1
+            continue
+
+        # nothing to do
+        if p == su_podcast:
+            unchanged += 1
+            continue
 
+        # last option - merge podcasts
+        try:
             rewrite_podcasts(p, su_podcast)
             tmp = Subscription.objects.filter(podcast=p)
             if tmp.count() > 0: print tmp.count()
             p.delete()
             merged += 1
 
-        except Podcast.DoesNotExist, e:
-            log('updating podcast %s - "%s" => "%s"' % (p.id, p.url, su))
-            p.url = su
-            p.save()
-            updated += 1
+        except Exception, e:
+            log('error rewriting podcast %s: %s' % (p.id, e))
+            error += 1
+            continue
 
     print ' * %s unchanged' % unchanged
     print ' * %s merged' % merged
     print ' * %s updated' % updated
     print ' * %s deleted' % deleted
+    print ' * %s error' % error
 
 
 def delete_podcast(p):

commit 071bff2db30459f7879d078c70426d96eb73e4ca
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Jan 25 13:49:53 2010 +0100

    removed my.gpodder.org references

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 5cef0b5..e565af7 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -23,6 +23,7 @@ from registration.forms import RegistrationFormUniqueEmail
 from mygpo.api.models import UserProfile
 from django.contrib.auth.views import logout
 
+
 # Uncomment the next two lines to enable the admin:
 from django.contrib import admin
 admin.autodiscover()
@@ -45,7 +46,6 @@ urlpatterns = patterns('',
     (r'^episode/(?P<id>\d+)$', 'mygpo.web.views.episode'),
 
     (r'account/$', 'mygpo.web.views.account'),
-    (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     (r'^history/$', 'mygpo.web.views.history'),
     (r'^devices/$', 'mygpo.web.views.devices'),
@@ -79,7 +79,9 @@ urlpatterns = patterns('',
 
     #Subscribe with my.gpodder.org
     (r'^subscribe', 'mygpo.web.views.podcast_subscribe_url'),
-    (r'^authors/$', 'django.views.generic.simple.direct_to_template', {'template': 'authors.html'}),
+    #(r'^authors/$', 'django.views.generic.simple.direct_to_template', {'template': 'authors.html'}),
+    (r'^authors/$', 'mygpo.web.views.author'),
+
 
     (r'^online-help', 'django.views.generic.simple.direct_to_template', {'template': 'online-help.html'}),
 
diff --git a/mygpo/web/templates/authors.html b/mygpo/web/templates/authors.html
index 2bd4426..6120af1 100644
--- a/mygpo/web/templates/authors.html
+++ b/mygpo/web/templates/authors.html
@@ -8,6 +8,6 @@
   <p>{% trans "You can paste this code on your website, so users of mygpo can directly subscribe to your podcast!" %}</p>
   <p>{% trans "Change the field 'YOUR_ADRESS' with the adress of your podcast." %}</p>
   <p>
-   <textarea cols="80" rows="1"><a href="http://my.gpodder.org/subscribe?url=YOUR_ADRESS"><img src="http://my.gpodder.org/media/author_subscribe.png" /></a></textarea>
+   <textarea cols="80" rows="1"><a href="http://{{ url }}/subscribe?url=YOUR_ADRESS"><img src="http://{{ url }}/media/author_subscribe.png" /></a></textarea>
   </p>
 {% endblock %}
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 41932ed..15fa6fd 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -20,9 +20,9 @@
 # along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
 #
 -->
-  <title>{% block title %}{% endblock %}my.gPodder.org</title>
+  <title>{% block title %}{% endblock %}{{ url }}</title>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
-  <link rel="shortcut icon" href="http://my.gpodder.org/favicon.png">
+  <link rel="shortcut icon" href="http://{{ url }}/favicon.png">
   <link rel="stylesheet" href="/media/screen.css" type="text/css" />
   <link rel="stylesheet" href="/media/screen-base.css" type="text/css" />
  </head>
@@ -81,7 +81,7 @@
     
    {% else %}
     <ul class="menu">
-     <li class="heading"><strong>my.gpodder.org</strong></li>
+     <li class="heading"><strong>{{ url }}</strong></li>
      <li><a href="/">{% trans "Home" %}</a></li>
      <li><a href="/login/">{% trans "Login" %}</a></li>
      <li><a href="/register/">{% trans "Register" %}</a></li>
diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index fd85bc2..adf007d 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -34,7 +34,7 @@
  {% else %}
 
  <h2>{% trans "Where to start?" %}</h2>
- <p>{% blocktrans with user.username as username %}my.gpodder.org help you to track your podcasts which you have subscribed on your devices - desktop computer, notebook, mobile devices, etc. To start using my.gpodder.org set up <a href="http://gpodder.org">gPodder</a> with your username &ndash; <strong>{{username}}</strong> &ndash; and password and upload your podcasts. They will automatically show up here.{% endblocktrans %}</p>
+ <p>{% blocktrans with user.username as username %}{{ url }} help you to track your podcasts which you have subscribed on your devices - desktop computer, notebook, mobile devices, etc. To start using my.gpodder.org set up <a href="http://gpodder.org">gPodder</a> with your username &ndash; <strong>{{username}}</strong> &ndash; and password and upload your podcasts. They will automatically show up here.{% endblocktrans %}</p>
 
  {% endif %}
 {% endblock %}
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index e51ac44..6a0a6d1 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -2,8 +2,8 @@
 {% load i18n %}
 
 {% block content %}
-  <h1>my.gpodder.org</h1>
-  <p>{% trans "my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications." %}</p>
+  <h1>{{ url }}</h1>
+  <p>{% blocktrans %}{{ url }} is a webservice for synchronizing podcast subscriptions on several devices and applications.{% endblocktrans %}</p>
 <p>
 {% blocktrans %}We are currently tracking {{ podcast_count }} Podcasts!{% endblocktrans %}
 </p>
diff --git a/mygpo/web/templates/migrate.html b/mygpo/web/templates/migrate.html
index 9b0f726..3a74cba 100644
--- a/mygpo/web/templates/migrate.html
+++ b/mygpo/web/templates/migrate.html
@@ -2,8 +2,8 @@
 {% load i18n %}
 
 {% block content %}
-  <h1>my.gpodder.org</h1>
-  <p>{% trans "The new my.gpodder.org uses usernames instead of email addresses. Based on your email address, we think you might like " %}<strong>{{username}}</strong>{% trans ", but you can change that if you want to." %}</p>
+  <h1>{{ url }}</h1>
+  <p>{% blocktrans %}The new {{ url }} uses usernames instead of email addresses. Based on your email address, we think you might like {% endblocktrans %}<strong>{{username}}</strong>{% trans ", but you can change that if you want to." %}</p>
 
   <form action="/migrate/" method="post">
   Username: <input type="text" name="username" value="{{ username }}"/><br /><br />
diff --git a/mygpo/web/templates/suggestions.html b/mygpo/web/templates/suggestions.html
index 40944ce..0f42cbf 100644
--- a/mygpo/web/templates/suggestions.html
+++ b/mygpo/web/templates/suggestions.html
@@ -36,6 +36,6 @@
    </a>
   </div>
 
-  <div class="info"><strong>Get your suggestions on your Client</strong>! Access <a href="http://my.gpodder.org/suggestions/15.opml">http://my.gpodder.org/suggestions/15.opml</a> to get 15 of our recommended podcasts.</div>
+  <div class="info"><strong>Get your suggestions on your Client</strong>! Access <a href="/suggestions/15.opml">http://{{ url }}/suggestions/15.opml</a> to get 15 of our recommended podcasts.</div>
 {% endblock %}
 
diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
index 815fd72..92c1af5 100644
--- a/mygpo/web/templates/toplist.html
+++ b/mygpo/web/templates/toplist.html
@@ -23,6 +23,6 @@
   {% endfor %}
   </table>
 
-  <div class="info"><strong>Get the toplist from your Client</strong>! Access <a href="/toplist/30.opml">http://my.gpodder.org/toplist/30.opml</a> for the Top-30.</div>
+  <div class="info"><strong>Get the toplist from your Client</strong>! Access <a href="/toplist/30.opml">http://{{ url }}/toplist/30.opml</a> for the Top-30.</div>
 {% endblock %}
 
diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 2e0e768..71f91e1 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -25,6 +25,8 @@ from registration.forms import RegistrationForm
 from registration.views import activate, register
 from registration.models import RegistrationProfile
 from mygpo.api.models import UserProfile
+from django.contrib.sites.models import Site
+from django.conf import settings
 
 def login_user(request):
        try:
@@ -36,10 +38,12 @@ def login_user(request):
        user = authenticate(username=username, password=password)
        if user is not None:
               login(request, user)
+              current_site = Site.objects.get(id=settings.SITE_ID)
 
               try:
                   if user.get_profile().generated_id:
                       return render_to_response('migrate.html', {
+                           'url': current_site,
                            'username': user
                       })
               except UserProfile.DoesNotExist:
@@ -63,10 +67,11 @@ def migrate_user(request):
         username = user.username
 
     if user.username != username:
+        current_site = Site.objects.get(id=settings.SITE_ID)
         if User.objects.filter(username__exact=username).count() > 0:
-            return render_to_response('migrate.html', {'error_message': '%s is already taken' % username, 'username': user.username})
+            return render_to_response('migrate.html', {'error_message': '%s is already taken' % username, 'url': current_site, 'username': user.username})
         if slugify(username) != username:
-            return render_to_response('migrate.html', {'error_message': '%s is not a valid username. Please use characters, numbers, underscore and dash only.' % username, 'username': user.username})
+            return render_to_response('migrate.html', {'error_message': '%s is not a valid username. Please use characters, numbers, underscore and dash only.' % username, 'url': current_site, 'username': user.username})
         else:
             user.username = username
             user.save()
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index aa62cf4..a741c18 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -27,20 +27,25 @@ from mygpo.api.basic_auth import require_valid_user
 from django.contrib.auth.decorators import login_required
 from django.db import IntegrityError
 from datetime import datetime
+from django.contrib.sites.models import Site
+from django.conf import settings
 import re
 
 def home(request):
+       current_site = Site.objects.get(id=settings.SITE_ID)
        if request.user.is_authenticated():
               subscriptionlist = create_subscriptionlist(request)              
 
               return render_to_response('home-user.html', {
-                    'subscriptionlist': subscriptionlist
+                    'subscriptionlist': subscriptionlist,
+                    'url': current_site
               }, context_instance=RequestContext(request))
 
        else:
               podcasts = Podcast.objects.count()
               return render_to_response('home.html', {
-                    'podcast_count': podcasts
+                    'podcast_count': podcasts,
+                    'url': current_site
               })
 
 def create_subscriptionlist(request):
@@ -191,8 +196,10 @@ def account(request):
 
 def toplist(request, len=100):
     entries = ToplistEntry.objects.all().order_by('-subscriptions')[:len]
+    current_site = Site.objects.get(id=settings.SITE_ID)
     return render_to_response('toplist.html', {
         'entries': entries,
+        'url': current_site
     }, context_instance=RequestContext(request))
 
 
@@ -215,9 +222,11 @@ def suggestions(request):
         rated = True
 
     entries = SuggestionEntry.forUser(request.user)
+    current_site = Site.objects.get(id=settings.SITE_ID)
     return render_to_response('suggestions.html', {
         'entries': entries,
-        'rated'  : rated
+        'rated'  : rated,
+        'url': current_site
     }, context_instance=RequestContext(request))
 
 
@@ -308,3 +317,11 @@ def podcast_subscribe_url(request):
             
     return HttpResponseRedirect('/podcast/%d/subscribe' % podcast.pk)
     
+
+def author(request):
+    current_site = Site.objects.get(id=settings.SITE_ID)
+    return render_to_response('authors.html', {
+        'url': current_site
+    }, context_instance=RequestContext(request))
+
+

commit c6be80ba0b7c0aa9bc004a7d79ec3b8a72656bd3
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Jan 23 15:26:34 2010 +0100

    catch ValueError when sync devices fails (bug 791)

diff --git a/mygpo/web/forms.py b/mygpo/web/forms.py
index 6ef2244..c545d1a 100644
--- a/mygpo/web/forms.py
+++ b/mygpo/web/forms.py
@@ -1,6 +1,7 @@
 from django import forms
 from django.utils.translation import ugettext as _
 from mygpo.api.models import Device, DEVICE_TYPES, SyncGroup
+from mygpo.log import log
 import re
 
 class UserAccountForm(forms.Form):
@@ -34,12 +35,14 @@ class SyncForm(forms.Form):
 
     def get_target(self):
         if not self.is_valid():
-            raise ValueError()
+            log('no target given in SyncForm')
+            raise ValueError(_('No device selected'))
 
         target = self.cleaned_data['targets']
         m = re.match('^([dg])(\d+)$', target)
         if m == None:
-            raise ValueError()
+            log('invalid target %s given in SyncForm' % target)
+            raise ValueError(_('Invalid device selected: %s') % target)
 
         if m.group(1) == 'd':
             return Device.objects.get(pk=m.group(2))
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 6554786..aa62cf4 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -96,31 +96,36 @@ def devices(request):
 @login_required
 def podcast_subscribe(request, pid):
     podcast = Podcast.objects.get(pk=pid)
+    error_message = None
 
     if request.method == 'POST':
         form = SyncForm(request.POST)
 
-        target = form.get_target()
+        try:
+            target = form.get_target()
 
-        if isinstance(target, SyncGroup):
-            device = target.devices()[0]
-        else:
-            device = target
+            if isinstance(target, SyncGroup):
+                device = target.devices()[0]
+            else:
+                device = target
 
-        SubscriptionAction.objects.create(podcast=podcast, device=device, action=SUBSCRIBE_ACTION)
+            SubscriptionAction.objects.create(podcast=podcast, device=device, action=SUBSCRIBE_ACTION)
 
-        return HttpResponseRedirect('/podcast/%s' % podcast.id)
+            return HttpResponseRedirect('/podcast/%s' % podcast.id)
 
-    else:
-        targets = podcast.subscribe_targets(request.user)
+        except ValueError, e:
+            error_message = _('Could not subscribe to the podcast: %s' % e)
+
+    targets = podcast.subscribe_targets(request.user)
 
-        form = SyncForm()
-        form.set_targets(targets, _('With which client do you want to subscribe?'))
+    form = SyncForm()
+    form.set_targets(targets, _('With which client do you want to subscribe?'))
 
-        return render_to_response('subscribe.html', {
-            'podcast': podcast,
-            'form': form
-        }, context_instance=RequestContext(request))
+    return render_to_response('subscribe.html', {
+        'error_message': error_message,
+        'podcast': podcast,
+        'form': form
+    }, context_instance=RequestContext(request))
 
 @login_required
 def podcast_unsubscribe(request, pid, device_id):
@@ -270,11 +275,14 @@ def device_sync(request, device_id):
     if not form.is_valid():
         return HttpResponseBadRequest('invalid')
 
-    target = form.get_target()
+    try:
+        target = form.get_target()
 
-    device = Device.objects.get(pk=device_id)
+        device = Device.objects.get(pk=device_id)
+        device.sync_with(target)
 
-    device.sync_with(target)
+    except ValueError, e:
+        log('error while syncing device %s: %s' % (device_id, e))
 
     return HttpResponseRedirect('/device/%s' % device_id)
 

commit fb896f204948eed100ee70ea2bb1fe80027aeaab
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Jan 22 16:38:25 2010 +0100

    use current timestamp for sync-actions (bug 819)

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index e80945d..6e5d47e 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -170,7 +170,7 @@ class Device(models.Model):
 
     def sync(self):
         for s in self.get_sync_actions():
-            SubscriptionAction.objects.create(device=self, podcast=s.podcast, timestamp=s.timestamp, action=s.action)
+            SubscriptionAction.objects.create(device=self, podcast=s.podcast, action=s.action)
 
     def sync_targets(self):
         """

commit fc47227ddf1811ff315f18ecc01606e66979cc97
Merge: 18e16dc... 3c139c0...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Jan 21 10:16:21 2010 +0100

    Merge branch 'master' of /home/alex/mygpo-src

commit 18e16dc3718aa1c19224fa1a5032069d48808522
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Jan 20 22:30:09 2010 +0100

    set col type from timestamp to datetime (bug 818)
    
    column type timestamp caused problems when querying the db for start-timestamp
    0, because it was out of range after conversion to UTC.

diff --git a/install/update-12.sql b/install/update-12.sql
index 0c957c8..c1eab97 100644
--- a/install/update-12.sql
+++ b/install/update-12.sql
@@ -54,3 +54,6 @@ create unique index unique_subscription_meta on subscription (user_id, podcast_i
 
 create unique index unique_device_user_uid on device (user_id, uid);
 
+alter table subscription_log change timestamp timestamp datetime not null;
+alter table episode_log change timestamp timestamp datetime not null;
+

commit 9f1df2660d2d47efc1ea6ddfcc14f28aadf3286c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Jan 20 22:15:34 2010 +0100

    fix sanitizing for non-ascii urls (bug 820)

diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
index 2446f7d..4765031 100644
--- a/mygpo/api/sanitizing.py
+++ b/mygpo/api/sanitizing.py
@@ -170,7 +170,7 @@ def rewrite_episode_actions(e_old, e_new):
 def precompile_rules(rules=URLSanitizingRule.objects.all().order_by('priority')):
     rules_p = []
     for rule in rules:
-        r = re.compile(rule.search)
+        r = re.compile(rule.search, re.UNICODE)
         rule.search_precompile = r
         rules_p.append( rule )
 

commit f82b1eb7a9b271bccd72a76e4d04bf67b0116d88
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 21:06:57 2010 +0100

    Fix Advanced API (API spec says: 'update_urls')

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 82dca32..4d4998d 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -70,13 +70,13 @@ def subscriptions(request, username, device_uid):
         rem = actions['remove'] if 'remove' in actions else []
 
         try:
-            updated_urls = update_subscriptions(request.user, d, add, rem)
+            update_urls = update_subscriptions(request.user, d, add, rem)
         except IntegrityError, e:
             return HttpResponseBadRequest(e)
 
         return JsonResponse({
             'timestamp': now_, 
-            'updated_urls': updated_urls 
+            'update_urls': update_urls,
             })
 
     else:

commit d97d386afbf4c6403efac27d795b611444da7a32
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 19:31:12 2010 +0100

    Add transparency to (un-)subscribe buttons

diff --git a/htdocs/media/subscribe.png b/htdocs/media/subscribe.png
index da43815..abf12d0 100644
Binary files a/htdocs/media/subscribe.png and b/htdocs/media/subscribe.png differ
diff --git a/htdocs/media/unsubscribe.png b/htdocs/media/unsubscribe.png
index 83934d0..04c4d87 100644
Binary files a/htdocs/media/unsubscribe.png and b/htdocs/media/unsubscribe.png differ

commit 4552f973e5d35fa5237c12cac75ea136d4f02972
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 19:28:14 2010 +0100

    Fix circular import exception (haystack autodiscover)

diff --git a/mygpo/api/constants.py b/mygpo/api/constants.py
new file mode 100644
index 0000000..a005465
--- /dev/null
+++ b/mygpo/api/constants.py
@@ -0,0 +1,47 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+# Set _ to no-op, because we just want to mark the strings as
+# translatable and will use gettext on these strings later on
+_ = lambda x: x
+
+
+EPISODE_ACTION_TYPES = (
+        ('download', _('downloaded')),
+        ('play',     _('played')),
+        ('delete',   _('deleted')),
+        ('new',      _('marked as new')),
+)
+
+
+DEVICE_TYPES = (
+        ('desktop', _('Desktop')),
+        ('laptop', _('Laptop')),
+        ('mobile', _('Cell phone')),
+        ('server', _('Server')),
+        ('other', _('Other')),
+)
+
+
+SUBSCRIBE_ACTION = 1
+UNSUBSCRIBE_ACTION = -1
+
+SUBSCRIPTION_ACTION_TYPES = (
+        (SUBSCRIBE_ACTION, _('subscribed')),
+        (UNSUBSCRIBE_ACTION, _('unsubscribed')),
+)
+
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 3523778..e80945d 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -21,29 +21,7 @@ from datetime import datetime
 from django.utils.translation import ugettext as _
 import hashlib
 
-EPISODE_ACTION_TYPES = (
-        ('download', _('downloaded')),
-        ('play',     _('played')),
-        ('delete',   _('deleted')),
-        ('new',      _('marked as new'))
-    )
-
-DEVICE_TYPES = (
-        ('desktop', _('Desktop')),
-        ('laptop', _('Laptop')),
-        ('mobile', _('Cell phone')),
-        ('server', _('Server')),
-        ('other', _('Other'))
-    )
-
-
-SUBSCRIBE_ACTION = 1
-UNSUBSCRIBE_ACTION = -1
-
-SUBSCRIPTION_ACTION_TYPES = (
-        (SUBSCRIBE_ACTION, 'subscribed'),
-        (UNSUBSCRIBE_ACTION, 'unsubscribed')
-    )
+from mygpo.api.constants import EPISODE_ACTION_TYPES, DEVICE_TYPES, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, SUBSCRIPTION_ACTION_TYPES
 
 class UserProfile(models.Model):
     user = models.ForeignKey(User, unique=True, db_column='user_ptr_id')
diff --git a/mygpo/web/templatetags/devices.py b/mygpo/web/templatetags/devices.py
index dc9a150..982a951 100644
--- a/mygpo/web/templatetags/devices.py
+++ b/mygpo/web/templatetags/devices.py
@@ -1,6 +1,8 @@
 from django import template
 from django.utils.safestring import mark_safe
-from django.utils.translation import ugettext as _
+from django.utils.translation import ugettext
+
+_ = ugettext
 
 from mygpo.api.models import DEVICE_TYPES
 
@@ -28,6 +30,7 @@ def device_icon(device, size=16):
     caption = DEVICE_TYPES_DICT.get(device.type, None)
 
     if icon is not None and caption is not None:
+        caption = ugettext(caption)
         html = ('<img src="/media/%(size)dx%(size)d/%(icon)s" '+
                 'alt="%(caption)s" class="device_icon"/>') % locals()
         return mark_safe(html)

commit 2ed60ce5cd10d7ea831c1f91ec6aede91bbe07fd
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 19:12:43 2010 +0100

    Assorted website style fixes

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index e2e15d3..e52e80e 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -87,6 +87,11 @@ table.list
     width: 100%;
 }
 
+table.list tr:hover td
+{
+    background-color: #ddd;
+}
+
 table.list th
 {
     text-align: left;
diff --git a/mygpo/web/templates/devicelist.html b/mygpo/web/templates/devicelist.html
index 1699ef2..7a453ea 100644
--- a/mygpo/web/templates/devicelist.html
+++ b/mygpo/web/templates/devicelist.html
@@ -16,7 +16,7 @@
     {% for d in devices %}
      <tr>
       <td><a href="/device/{{ d.id }}">{{ d|device_icon }}{{ d.name }}</a></td>
-      <td>{{ d.type }}</td>
+      <td>{{ d|device_type }}</td>
       <td>{{ d.uid }}</td>
      </tr>
     {% endfor %}
diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index b4c41f6..fd85bc2 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -3,10 +3,9 @@
 {% load devices %}
 
 {% block content %}
- <h1>{% trans "my.gpodder.org" %}
+<h1>{% trans "Your Subscriptions" %}</h1>
 
  {% if not subscriptionlist|length_is:"0" %}
- <h2>{% trans "Your Subscriptions" %}</h2>
  <table class="list">
   <tr>
    <th>&nbsp;</th>
diff --git a/mygpo/web/templatetags/devices.py b/mygpo/web/templatetags/devices.py
index 6d06b8b..dc9a150 100644
--- a/mygpo/web/templatetags/devices.py
+++ b/mygpo/web/templatetags/devices.py
@@ -19,6 +19,10 @@ DEVICE_TYPE_ICONS = {
 }
 
 @register.filter
+def device_type(device):
+    return DEVICE_TYPES_DICT.get(device.type, _('Unknown'))
+
+@register.filter
 def device_icon(device, size=16):
     icon = DEVICE_TYPE_ICONS.get(device.type, None)
     caption = DEVICE_TYPES_DICT.get(device.type, None)

commit e31790412c9e869841b448f3e7f8bb4a965da81d
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 19:04:33 2010 +0100

    Fix problem with device icons

diff --git a/mygpo/web/templatetags/devices.py b/mygpo/web/templatetags/devices.py
index 7b24834..6d06b8b 100644
--- a/mygpo/web/templatetags/devices.py
+++ b/mygpo/web/templatetags/devices.py
@@ -20,8 +20,8 @@ DEVICE_TYPE_ICONS = {
 
 @register.filter
 def device_icon(device, size=16):
-    icon = DEVICE_TYPE_ICONS.get(device, None)
-    caption = DEVICE_TYPES_DICT.get(device, None)
+    icon = DEVICE_TYPE_ICONS.get(device.type, None)
+    caption = DEVICE_TYPES_DICT.get(device.type, None)
 
     if icon is not None and caption is not None:
         html = ('<img src="/media/%(size)dx%(size)d/%(icon)s" '+

commit c6e5c59d0429c0a214ae861a71e5b18c21b4cc45
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 19:02:26 2010 +0100

    Improve device icon display + template tag

diff --git a/htdocs/media/16x16/stock_cell-phone.png b/htdocs/media/16x16/stock_cell-phone.png
new file mode 100644
index 0000000..479987f
Binary files /dev/null and b/htdocs/media/16x16/stock_cell-phone.png differ
diff --git a/htdocs/media/16x16/stock_notebook.png b/htdocs/media/16x16/stock_notebook.png
new file mode 100644
index 0000000..18565b4
Binary files /dev/null and b/htdocs/media/16x16/stock_notebook.png differ
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 9c14ca4..e2e15d3 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -130,6 +130,12 @@ h1, h2
 }
 
 
+img.device_icon
+{
+    padding: 3px;
+    vertical-align: middle;
+}
+
 ul.devices li.desktop
 {
     list-style-image: url('16x16/computer.png');
@@ -137,12 +143,12 @@ ul.devices li.desktop
 
 ul.devices li.laptop
 {
-    list-style-image: url('16x16/pda.png');
+    list-style-image: url('16x16/stock_notebook.png');
 }
 
 ul.devices li.mobile
 {
-    list-style-image: url('16x16/multimedia-player.png');
+    list-style-image: url('16x16/stock_cell-phone.png');
 }
 
 ul.devices li.server
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 4c4d3bc..3523778 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -22,18 +22,18 @@ from django.utils.translation import ugettext as _
 import hashlib
 
 EPISODE_ACTION_TYPES = (
-        ('download', 'downloaded'),
-        ('play',     'played'),
-        ('delete',   'deleted'),
-        ('new',      'marked new')
+        ('download', _('downloaded')),
+        ('play',     _('played')),
+        ('delete',   _('deleted')),
+        ('new',      _('marked as new'))
     )
 
 DEVICE_TYPES = (
-        ('desktop', 'Desktop'),
-        ('laptop', 'Laptop'),
-        ('mobile', 'Mobile'),
-        ('server', 'Server'),
-        ('other', 'Other')
+        ('desktop', _('Desktop')),
+        ('laptop', _('Laptop')),
+        ('mobile', _('Cell phone')),
+        ('server', _('Server')),
+        ('other', _('Other'))
     )
 
 
diff --git a/mygpo/web/templatetags/devices.py b/mygpo/web/templatetags/devices.py
index 68e8eb6..7b24834 100644
--- a/mygpo/web/templatetags/devices.py
+++ b/mygpo/web/templatetags/devices.py
@@ -1,26 +1,36 @@
 from django import template
 from django.utils.safestring import mark_safe
 from django.utils.translation import ugettext as _
-import hashlib
+
+from mygpo.api.models import DEVICE_TYPES
 
 register = template.Library()
 
+# Create a dictionary of device_type -> caption mappings
+DEVICE_TYPES_DICT = dict(DEVICE_TYPES)
+
+# This dictionary maps device types to their icon files
+DEVICE_TYPE_ICONS = {
+        'desktop': 'computer.png',
+        'laptop': 'stock_notebook.png',
+        'mobile': 'stock_cell-phone.png',
+        'server': 'server.png',
+        'other': 'audio-x-generic.png',
+}
+
 @register.filter
-def device_icon(device,size=16):
-    if device.type == 'desktop':
-        s = '<img src="/media/%sx%s/computer.png" alt="%s" />' % (size, size, _('Desktop'))
-    elif device.type == 'laptop':
-        s = '<img src="/media/%sx%s/pda.png" alt="%s" />' % (size, size, _('Laptop'))
-    elif device.type == 'mobile':
-        s = '<img src="/media/%sx%s/multimedia-player.png" alt="%s" />' % (size, size, _('Mobile'))
-    elif device.type == 'server':
-        s = '<img src="/media/%sx%s/server.png" alt="%s" />' % (size, size, _('Server'))
-    else:
-        s = '<img src="/media/%sx%s/audio-x-generic.png" alt="%s" />' % (size, size, _('Other'))
-
-    return mark_safe(s)
+def device_icon(device, size=16):
+    icon = DEVICE_TYPE_ICONS.get(device, None)
+    caption = DEVICE_TYPES_DICT.get(device, None)
+
+    if icon is not None and caption is not None:
+        html = ('<img src="/media/%(size)dx%(size)d/%(icon)s" '+
+                'alt="%(caption)s" class="device_icon"/>') % locals()
+        return mark_safe(html)
+
+    return ''
 
 @register.filter
 def device_list(devices):
     return mark_safe(', '.join([ '<a href="/device/%s">%s&nbsp;%s</a>' % (d.id, device_icon(d), d.name) for d in devices]))
-        
+

commit 3c139c05b9aa789a68024f8a2a8aaaac0fe1a3fc
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Tue Jan 19 18:30:21 2010 +0100

    new for authors logo added

diff --git a/htdocs/media/author_subscribe.png b/htdocs/media/author_subscribe.png
new file mode 100644
index 0000000..588d2da
Binary files /dev/null and b/htdocs/media/author_subscribe.png differ
diff --git a/mygpo/web/templates/authors.html b/mygpo/web/templates/authors.html
index 667ccb3..2bd4426 100644
--- a/mygpo/web/templates/authors.html
+++ b/mygpo/web/templates/authors.html
@@ -4,10 +4,10 @@
 {% block content %}
   <h1>{% trans "For podcast authors" %}</h1>
 
-  <p><img src="/media/subscribe.png" /></p>
+  <p><img src="/media/author_subscribe.png" /></p>
   <p>{% trans "You can paste this code on your website, so users of mygpo can directly subscribe to your podcast!" %}</p>
   <p>{% trans "Change the field 'YOUR_ADRESS' with the adress of your podcast." %}</p>
   <p>
-   <textarea cols="80" rows="1"><a href="http://my.gpodder.org/subscribe?url=YOUR_ADRESS"><img src="http://my.gpodder.org/media/subscribe.png" /></a></textarea>
+   <textarea cols="80" rows="1"><a href="http://my.gpodder.org/subscribe?url=YOUR_ADRESS"><img src="http://my.gpodder.org/media/author_subscribe.png" /></a></textarea>
   </p>
 {% endblock %}

commit 419aca3c036782faf359a6768fe5a05e75749cfd
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 16:05:45 2010 +0100

    Fix syntax errors in the codebase

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 492ed98..82dca32 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -71,7 +71,7 @@ def subscriptions(request, username, device_uid):
 
         try:
             updated_urls = update_subscriptions(request.user, d, add, rem)
-        except IntegrityError as e:
+        except IntegrityError, e:
             return HttpResponseBadRequest(e)
 
         return JsonResponse({
@@ -231,13 +231,12 @@ def update_episodes(user, actions):
 
 @require_valid_user
 def device(request, username, device_uid):
-
     if request.user.username != username:
         return HttpResponseForbidden()
 
     # Workaround for mygpoclient 1.0: It uses "PUT" requests
     # instead of "POST" requests for uploading device settings
-    if request.method ('POST', 'PUT'):
+    if request.method in ('POST', 'PUT'):
         d, created = Device.objects.get_or_create(user=request.user, uid=device_uid)
 
         data = json.loads(request.raw_post_data)
diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
index 3933839..2446f7d 100644
--- a/mygpo/api/sanitizing.py
+++ b/mygpo/api/sanitizing.py
@@ -135,7 +135,7 @@ def rewrite_podcasts(p_old, p_new):
             log('updating subscription action %s (device %s, action %s, timestamp %s, podcast %s => %s)' % (sa.id, sa.device.id, sa.action, sa.timestamp, sa.podcast.id, p_new.id))
             sa.podcast = p_new
             sa.save()
-        except Exception as e:
+        except Exception, e:
             log('error updating subscription action %s: %s, deleting' % (sa.id, e))
             sa.delete()
 
@@ -163,7 +163,7 @@ def rewrite_episode_actions(e_old, e_new):
             ea.epsidode = e_new
             ea.save()
 
-        except Exception as e:
+        except Exception, e:
             log('error updating episode action %s: %s, deleting' % (sa.id, e))
 
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 930e4d8..bb0a484 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -246,7 +246,7 @@ def device(request, device_id):
             try:
                 device.save()
                 success = True
-            except IntegrityError as ie:
+            except IntegrityError, ie:
                 device = Device.objects.get(pk=device_id)
                 error_message = _('You can\'t use the same UID for two devices.')
 

commit edeb9af4e592712a7169785ed90816a09a9deefe
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 15:51:47 2010 +0100

    Add fixes to the database migration code
    
    The script "fix-duplicate-device-uids.py" is
    only needed once when we migrate the database
    from the pre-update-12.sql schema to the new
    one, as update-12.sql already includes the
    necessary constraints to stop this bug from
    happening.
    
    Also make sure that running update-12.sql is
    not a problem if the substitution table exists.

diff --git a/bin/fix-duplicate-device-uids.py b/bin/fix-duplicate-device-uids.py
new file mode 100644
index 0000000..6ad2af4
--- /dev/null
+++ b/bin/fix-duplicate-device-uids.py
@@ -0,0 +1,41 @@
+
+# Fix a bug where older versions of mygpo allowed users to set the
+# UID to the same value for different devices. This is not allowed
+# anymore by update-12.sql from January 2010, but it is needed for
+# migrating the existing user database. -- Thomas Perl, 2010-01-19
+
+import MySQLdb
+import sys
+
+if len(sys.argv) != 3:
+    print >>sys.stderr, """
+    Usage: %s [username] [database]
+    """ % (sys.argv[0],)
+    sys.exit(1)
+
+username, database = sys.argv[-2:]
+connection = MySQLdb.connect(user=username, db=database)
+
+cur = connection.cursor()
+cur.execute('select uid, user_id, count(*) from device'
+          +' group by uid, user_id having count(*) > 1')
+todo = list(cur.fetchall())
+cur.close()
+
+cur = connection.cursor()
+for uid, user_id, count in todo:
+    counter = 1
+    cur.execute('select id from device where uid=%s and user_id=%s',
+            (uid, user_id))
+    for row in list(cur.fetchall()):
+        id = row[0]
+        if counter > 1:
+            new_uid = '%s%d' % (uid, counter)
+            print 'updating uid of %s to %s' % (id, new_uid)
+            cur.execute('update device set uid=%s where id=%s',
+                    (new_uid, id))
+        counter += 1
+cur.close()
+
+connection.close()
+
diff --git a/install/update-12.sql b/install/update-12.sql
index f37deeb..0c957c8 100644
--- a/install/update-12.sql
+++ b/install/update-12.sql
@@ -37,7 +37,7 @@ BEGIN
 END $$
 DELIMITER ;
 
-
+DROP TABLE IF EXISTS `sanitizing_rules`;
 CREATE TABLE `sanitizing_rules` (
     `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
     `use_podcast` bool NOT NULL,

commit dc521b602e4647f8f113166f5a04fdbcc3481793
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Jan 19 15:24:52 2010 +0100

    Use raw_post_data and workaround a mygpoclient 1.0 bug
    
    Instead of using request.POST['data'] (which results in
    an exception), use request.raw_post_data to get the JSON.
    
    mygpoclient 1.0 uses "PUT" instead of "POST" for
    uploading the device list, so we now accept "PUT" as
    additional method for uploading device lists (this is
    unofficial, and not documented in the API docs, as this
    bug will go away when every has updated to a newer
    release of mygpoclient that includes the bugfix.

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 2719b2c..492ed98 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -65,7 +65,7 @@ def subscriptions(request, username, device_uid):
     elif request.method == 'POST':
         d, created = Device.objects.get_or_create(user=request.user, uid=device_uid, defaults = {'type': 'other', 'name': 'New Device'})
 
-        actions = json.loads(request.POST['data'])
+        actions = json.loads(request.raw_post_data)
         add = actions['add'] if 'add' in actions else []
         rem = actions['remove'] if 'remove' in actions else []
 
@@ -148,7 +148,7 @@ def episodes(request, username):
 
     if request.method == 'POST':
         try:
-            actions = json.loads(request.POST['data'])
+            actions = json.loads(request.raw_post_data)
         except KeyError:
             return HttpResponseBadRequest()
 
@@ -235,10 +235,12 @@ def device(request, username, device_uid):
     if request.user.username != username:
         return HttpResponseForbidden()
 
-    if request.method == 'POST':
+    # Workaround for mygpoclient 1.0: It uses "PUT" requests
+    # instead of "POST" requests for uploading device settings
+    if request.method ('POST', 'PUT'):
         d, created = Device.objects.get_or_create(user=request.user, uid=device_uid)
 
-        data = json.loads(request.POST['data'])
+        data = json.loads(request.raw_post_data)
 
         if 'caption' in data:
             d.name = data['caption']

commit ec17bd3ffccd18d7486e2e06c2b63ce67e1e5b4d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Jan 18 16:49:44 2010 +0100

    add missing priorities in sanitizing-rules.sql

diff --git a/install/sanitizing-rules.sql b/install/sanitizing-rules.sql
index 01e54d8..c40d211 100644
--- a/install/sanitizing-rules.sql
+++ b/install/sanitizing-rules.sql
@@ -1,6 +1,6 @@
 INSERT INTO `sanitizing_rules` VALUES (1,1,0,'feeds2\\.feedburner\\.com','feeds.feedburner.com',1,'Rewriting for feedburner should happen as \"feeds2.feedburner.com\" -> \"feeds.feedburner.com\"');
 INSERT INTO `sanitizing_rules` VALUES (2,1,0,'(?P<unchanged>feedburner\\.com.+)\\?format=xml','\\g<unchanged>',2,'Feedburner URLs should have their \"?format=xml\" query string removed: \r\n\r\nhttp://feeds2.feedburner.com/linuxoutlaws?format=xml \r\nhttp://feeds.feedburner.com/linuxoutlaws \r\n');
-INSERT INTO `sanitizing_rules` VALUES (3,1,0,'^\\s+','','Remove leading whitespaces');
-INSERT INTO `sanitizing_rules` VALUES (4,1,0,'\\s+$','','Remove trailing whitespaces');
-INSERT INTO `sanitizing_rules` VALUES (5,1,0,'^[^(https?):].+','','Empty any string that doesn\'t start with either http or https');
+INSERT INTO `sanitizing_rules` VALUES (3,1,0,'^\\s+','',0,'Remove leading whitespaces');
+INSERT INTO `sanitizing_rules` VALUES (4,1,0,'\\s+$','',0,'Remove trailing whitespaces');
+INSERT INTO `sanitizing_rules` VALUES (5,1,0,'^[^(https?):].+','',100,'Empty any string that doesn\'t start with either http or https');
 

commit db1251da8cdf49b86de8f23620353b0b85fc9e4d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Jan 17 22:19:54 2010 +0100

    prevent duplicating uids via web (bug 804)

diff --git a/install/update-12.sql b/install/update-12.sql
index 76f0ad2..f37deeb 100644
--- a/install/update-12.sql
+++ b/install/update-12.sql
@@ -52,3 +52,5 @@ alter table subscription add column id int unique auto_increment;
 
 create unique index unique_subscription_meta on subscription (user_id, podcast_id);
 
+create unique index unique_device_user_uid on device (user_id, uid);
+
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index a3cd82e..930e4d8 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -25,6 +25,7 @@ from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
 from mygpo.api.basic_auth import require_valid_user
 from django.contrib.auth.decorators import login_required
+from django.db import IntegrityError
 from datetime import datetime
 import re
 
@@ -231,6 +232,7 @@ def device(request, device_id):
     synced_with = list(device.sync_group.devices()) if device.sync_group else []
     if device in synced_with: synced_with.remove(device)
     success = False
+    error_message = None
     sync_form = SyncForm()
     sync_form.set_targets(device.sync_targets(), _('Synchronize with the following devices'))
 
@@ -241,8 +243,12 @@ def device(request, device_id):
             device.name = device_form.cleaned_data['name']
             device.type = device_form.cleaned_data['type']
             device.uid  = device_form.cleaned_data['uid']
-            device.save()
-            success = True
+            try:
+                device.save()
+                success = True
+            except IntegrityError as ie:
+                device = Device.objects.get(pk=device_id)
+                error_message = _('You can\'t use the same UID for two devices.')
 
     else:
         device_form = DeviceForm({
@@ -256,6 +262,7 @@ def device(request, device_id):
         'device_form': device_form,
         'sync_form': sync_form,
         'success': success,
+        'error_message': error_message,
         'subscriptions': subscriptions,
         'synced_with': synced_with,
         'has_sync_targets': len(device.sync_targets()) > 0

commit 862c69880e5081657a58f445d59cb822570f025c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Jan 17 16:58:08 2010 +0100

    delete invalid podcasts in sanitizing-maintenance

diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
index 059cce8..3933839 100644
--- a/mygpo/api/sanitizing.py
+++ b/mygpo/api/sanitizing.py
@@ -56,6 +56,7 @@ def maintenance():
     unchanged = 0
     merged = 0
     updated = 0
+    deleted = 0
 
     count = 0
 
@@ -69,6 +70,11 @@ def maintenance():
         if su == p.url: 
             unchanged += 1
             continue
+
+        if su == '':
+            delete_podcast(p)
+            deleted += 1
+            continue
     
         try:
             su_podcast = Podcast.objects.get(url=su)
@@ -92,6 +98,12 @@ def maintenance():
     print ' * %s unchanged' % unchanged
     print ' * %s merged' % merged
     print ' * %s updated' % updated
+    print ' * %s deleted' % deleted
+
+
+def delete_podcast(p):
+    SubscriptionAction.objects.filter(podcast=p).delete()
+    p.delete()
 
 
 def rewrite_podcasts(p_old, p_new):

commit 441807330ce67c18b2d481986dd338eb79c27f09
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Jan 17 16:44:12 2010 +0100

    ignore URLs by sanitizing them to the empty string

diff --git a/install/sanitizing-rules.sql b/install/sanitizing-rules.sql
index 9eba484..01e54d8 100644
--- a/install/sanitizing-rules.sql
+++ b/install/sanitizing-rules.sql
@@ -2,3 +2,5 @@ INSERT INTO `sanitizing_rules` VALUES (1,1,0,'feeds2\\.feedburner\\.com','feeds.
 INSERT INTO `sanitizing_rules` VALUES (2,1,0,'(?P<unchanged>feedburner\\.com.+)\\?format=xml','\\g<unchanged>',2,'Feedburner URLs should have their \"?format=xml\" query string removed: \r\n\r\nhttp://feeds2.feedburner.com/linuxoutlaws?format=xml \r\nhttp://feeds.feedburner.com/linuxoutlaws \r\n');
 INSERT INTO `sanitizing_rules` VALUES (3,1,0,'^\\s+','','Remove leading whitespaces');
 INSERT INTO `sanitizing_rules` VALUES (4,1,0,'\\s+$','','Remove trailing whitespaces');
+INSERT INTO `sanitizing_rules` VALUES (5,1,0,'^[^(https?):].+','','Empty any string that doesn\'t start with either http or https');
+
diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index c81b30f..2719b2c 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -90,13 +90,13 @@ def update_subscriptions(user, device, add, remove):
 
     for u in add:
         us = sanitize_url(u)
-        if u != us: updated_urls.append( (u, us) )
-        add_sanitized.append(us)
+        if u != us:  updated_urls.append( (u, us) )
+        if us != '': add_sanitized.append(us)
 
     for u in remove:
         us = sanitize_url(u)
-        if u != us: updated_urls.append( (u, us) )
-        rem_sanitized.append(us)
+        if u != us:  updated_urls.append( (u, us) )
+        if us != '': rem_sanitized.append(us)
 
     for a in add_sanitized:
         if a in rem_sanitized:
diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 2b647a7..3ae7ac2 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -50,7 +50,10 @@ def upload(request):
     existing_urls = [e.podcast.url for e in existing]
 
     i = Importer(opml)
-    podcast_urls = [ sanitize_url(p['url']) for p in i.items]
+    podcast_urls = []
+    for p in i.items:
+        u = sanitize_url(p['url'])
+        if u != '': podcast_urls.append(u)
 
     new = [item['url'] for item in i.items if item['url'] not in existing_urls]
     rem = [e.podcast.url for e in existing if e.podcast.url not in podcast_urls]
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 3c53b82..49bc44f 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -109,7 +109,10 @@ def parse_subscription(raw_post_data, format, user, device_uid):
         urls = []
         format_ok = False
 
-    urls_sanitized = [ sanitize_url(u) for u in urls ]
+    urls_sanitized = []
+    for u in urls:
+        us = sanitize_url(u)
+        if us != '': urls_sanitized.append(us)
     
     d, created = Device.objects.get_or_create(user=user, uid=device_uid, 
                 defaults = {'type': 'other', 'name': device_uid})

commit 20e750a0f5de249c5a5021adaa4b09bc0fe9047b
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Jan 17 15:49:56 2010 +0100

    added url sanitizing to all apis (bug 747)

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index d326840..c81b30f 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -19,6 +19,7 @@ from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404, HttpResponseNotAllowed
 from mygpo.api.models import Device, Podcast, SubscriptionAction, Episode, EpisodeAction, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, EPISODE_ACTION_TYPES, DEVICE_TYPES, Subscription
 from mygpo.api.httpresponse import JsonResponse
+from mygpo.api.sanitizing import sanitize_url
 from django.core import serializers
 from time import mktime
 from datetime import datetime, timedelta
@@ -68,33 +69,54 @@ def subscriptions(request, username, device_uid):
         add = actions['add'] if 'add' in actions else []
         rem = actions['remove'] if 'remove' in actions else []
 
-        for a in add:
-            if a in rem:
-                return HttpResponseBadRequest('can not add and remove %s at the same time' % a)
-
-        update_subscriptions(request.user, d, add, rem)
+        try:
+            updated_urls = update_subscriptions(request.user, d, add, rem)
+        except IntegrityError as e:
+            return HttpResponseBadRequest(e)
 
-        return JsonResponse({'timestamp': now_})
+        return JsonResponse({
+            'timestamp': now_, 
+            'updated_urls': updated_urls 
+            })
 
     else:
         return HttpResponseNotAllowed(['GET', 'POST'])
 
 
 def update_subscriptions(user, device, add, remove):
-    for a in add:
+    updated_urls = []
+    add_sanitized = []
+    rem_sanitized = []
+
+    for u in add:
+        us = sanitize_url(u)
+        if u != us: updated_urls.append( (u, us) )
+        add_sanitized.append(us)
+
+    for u in remove:
+        us = sanitize_url(u)
+        if u != us: updated_urls.append( (u, us) )
+        rem_sanitized.append(us)
+
+    for a in add_sanitized:
+        if a in rem_sanitized:
+           raise IntegrityError('can not add and remove %s at the same time' % a)
+
+    for a in add_sanitized:
         p, p_created = Podcast.objects.get_or_create(url=a)
         try:
             s = SubscriptionAction.objects.create(podcast=p,device=device,action=SUBSCRIBE_ACTION)
         except IntegrityError, e:
             log('can\'t add subscription %s for user %s: %s' % (a, user, e))
 
-    for r in remove:
+    for r in rem_sanitized:
         p, p_created = Podcast.objects.get_or_create(url=r)
         try:
             s = SubscriptionAction.objects.create(podcast=p,device=device,action=UNSUBSCRIBE_ACTION)
         except IntegrityError, e:
             log('can\'t remove subscription %s for user %s: %s' % (r, user, e))
 
+    return updated_urls
 
 def get_subscription_changes(user, device, since, until):
     actions = {}
diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index fb02db2..2b647a7 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -23,6 +23,7 @@ from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
 from django.db import IntegrityError
 from mygpo.log import log
+from mygpo.api.sanitizing import sanitize_url
 
 LEGACY_DEVICE_NAME = 'Legacy Device'
 LEGACY_DEVICE_UID  = 'legacy'
@@ -49,7 +50,7 @@ def upload(request):
     existing_urls = [e.podcast.url for e in existing]
 
     i = Importer(opml)
-    podcast_urls = [p['url'] for p in i.items]
+    podcast_urls = [ sanitize_url(p['url']) for p in i.items]
 
     new = [item['url'] for item in i.items if item['url'] not in existing_urls]
     rem = [e.podcast.url for e in existing if e.podcast.url not in podcast_urls]
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index bef70a8..3c53b82 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -20,6 +20,7 @@ from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbid
 from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, ToplistEntry
 from mygpo.api.opml import Exporter, Importer
 from mygpo.api.httpresponse import JsonResponse
+from mygpo.api.sanitizing import sanitize_url
 from django.core import serializers
 from datetime import datetime
 from mygpo.api.httpresponse import HttpErrorResponse
@@ -107,14 +108,16 @@ def parse_subscription(raw_post_data, format, user, device_uid):
     else:
         urls = []
         format_ok = False
+
+    urls_sanitized = [ sanitize_url(u) for u in urls ]
     
     d, created = Device.objects.get_or_create(user=user, uid=device_uid, 
                 defaults = {'type': 'other', 'name': device_uid})
 
     podcasts = [p.podcast for p in d.get_subscriptions()]
     old = [p.url for p in podcasts]    
-    new = [p for p in urls if p not in old]
-    rem = [p for p in old if p not in urls]
+    new = [p for p in urls_sanitized if p not in old]
+    rem = [p for p in old if p not in urls_sanitized]
 
     return format_ok, new, rem, d
 

commit c0a2f1f04d9c8282980594168d6fbaa5e7d163a5
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Jan 17 15:26:57 2010 +0100

    using precompiled rules for sanitizing-maintenance

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 22f8548..4c4d3bc 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -408,6 +408,7 @@ class URLSanitizingRule(models.Model):
     use_podcast = models.BooleanField()
     use_episode = models.BooleanField()
     search = models.CharField(max_length=100)
+    search_precompiled = None
     replace = models.CharField(max_length=100, null=False, blank=True)
     priority = models.PositiveIntegerField()
     description = models.TextField(null=False, blank=True)
diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
index 46f35f9..059cce8 100644
--- a/mygpo/api/sanitizing.py
+++ b/mygpo/api/sanitizing.py
@@ -4,9 +4,9 @@ import urlparse
 import re
 import sys
 
-def sanitize_url(url, podcast=True, episode=False):
+def sanitize_url(url, podcast=True, episode=False, rules=URLSanitizingRule.objects.all().order_by('priority')):
     url = basic_sanitizing(url)
-    url = apply_sanitizing_rules(url, podcast, episode)
+    url = apply_sanitizing_rules(url, rules, podcast, episode)
     return url
 
 
@@ -19,22 +19,25 @@ def basic_sanitizing(url):
     r2 = urlparse.SplitResult(r.scheme, netloc, r.path, r.query, r.fragment)
     return r2.geturl()
 
-def apply_sanitizing_rules(url, podcast=True, episode=False):
+def apply_sanitizing_rules(url, rules, podcast=True, episode=False):
     """
     applies all url sanitizing rules to the given url
     setting podcast=True uses only those rules which have use_podcast set to True. 
     When passing podcast=False this check is ommitted. The same is valid
     for episode.
     """
-    rules = URLSanitizingRule.objects.all().order_by('priority')
     if podcast: rules = rules.filter(use_podcast=True)
     if episode: rules = rules.filter(use_podcast=True)
 
     for r in rules:
-        url = re.sub(r.search, r.replace, url)
+        if r.search_precompiled:
+            url = r.rearch_precompiled.sub(r.replace, url)
+        else:
+            url = re.sub(r.search, r.replace, url)
 
     return url
 
+
 def maintenance():
     """
     This currently checks how many podcasts could be removed by 
@@ -46,7 +49,9 @@ def maintenance():
     print ' * %s podcasts' % Podcast.objects.count()
     print ' * %s rules' % URLSanitizingRule.objects.count()
     print
-    print 'working...'
+
+    print 'precompiling regular expressions'
+    rules = precompile_rules()
 
     unchanged = 0
     merged = 0
@@ -60,8 +65,7 @@ def maintenance():
     for p in podcasts:
         count += 1
         if (count % 100) == 0: print '%s %% (podcast id %s)' % (((count + 0.0)/podcasts.count()*100), p.id)
-
-        su = sanitize_url(p.url)
+        su = sanitize_url(p.url, rules)
         if su == p.url: 
             unchanged += 1
             continue
@@ -150,3 +154,14 @@ def rewrite_episode_actions(e_old, e_new):
         except Exception as e:
             log('error updating episode action %s: %s, deleting' % (sa.id, e))
 
+
+def precompile_rules(rules=URLSanitizingRule.objects.all().order_by('priority')):
+    rules_p = []
+    for rule in rules:
+        r = re.compile(rule.search)
+        rule.search_precompile = r
+        rules_p.append( rule )
+
+    return rules_p
+
+

commit b6fab0e215d6da745a02882ce4e9e09b570f5ad4
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Jan 16 18:25:11 2010 +0100

    moved trimming urls to custom rules

diff --git a/install/sanitizing-rules.sql b/install/sanitizing-rules.sql
index 21bce60..9eba484 100644
--- a/install/sanitizing-rules.sql
+++ b/install/sanitizing-rules.sql
@@ -1,3 +1,4 @@
 INSERT INTO `sanitizing_rules` VALUES (1,1,0,'feeds2\\.feedburner\\.com','feeds.feedburner.com',1,'Rewriting for feedburner should happen as \"feeds2.feedburner.com\" -> \"feeds.feedburner.com\"');
 INSERT INTO `sanitizing_rules` VALUES (2,1,0,'(?P<unchanged>feedburner\\.com.+)\\?format=xml','\\g<unchanged>',2,'Feedburner URLs should have their \"?format=xml\" query string removed: \r\n\r\nhttp://feeds2.feedburner.com/linuxoutlaws?format=xml \r\nhttp://feeds.feedburner.com/linuxoutlaws \r\n');
-
+INSERT INTO `sanitizing_rules` VALUES (3,1,0,'^\\s+','','Remove leading whitespaces');
+INSERT INTO `sanitizing_rules` VALUES (4,1,0,'\\s+$','','Remove trailing whitespaces');
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index a414c86..22f8548 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -408,7 +408,7 @@ class URLSanitizingRule(models.Model):
     use_podcast = models.BooleanField()
     use_episode = models.BooleanField()
     search = models.CharField(max_length=100)
-    replace = models.CharField(max_length=100)
+    replace = models.CharField(max_length=100, null=False, blank=True)
     priority = models.PositiveIntegerField()
     description = models.TextField(null=False, blank=True)
 
diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
index d2909e4..46f35f9 100644
--- a/mygpo/api/sanitizing.py
+++ b/mygpo/api/sanitizing.py
@@ -14,7 +14,6 @@ def basic_sanitizing(url):
     """
     does basic sanitizing through urlparse and additionally converts the netloc to lowercase
     """
-    url = url.strip()
     r = urlparse.urlsplit(url)
     netloc = r.netloc.lower()
     r2 = urlparse.SplitResult(r.scheme, netloc, r.path, r.query, r.fragment)
@@ -81,7 +80,7 @@ def maintenance():
             merged += 1
 
         except Podcast.DoesNotExist, e:
-            log('updating podcast %s - %s => %s' % (p.id, p.url, su))
+            log('updating podcast %s - "%s" => "%s"' % (p.id, p.url, su))
             p.url = su
             p.save()
             updated += 1
@@ -93,7 +92,7 @@ def maintenance():
 
 def rewrite_podcasts(p_old, p_new):
 
-    log('merging podcast %s (%s) to correct podcast %s (%s)' % (p_old.id, p_old.url, p_new.id, p_new.url))
+    log('merging podcast %s "%s" to correct podcast %s "%s"' % (p_old.id, p_old.url, p_new.id, p_new.url))
 
     # we simply delete incorrect toplist and suggestions entries, 
     # because we can't re-calculate them
@@ -131,11 +130,11 @@ def rewrite_episodes(p_old, p_new):
             e_new = Episode.objects.get(podcast=p_new, url=e.url)
             log('episode %s (url %s, podcast %s) already exists; updating episode actions for episode %s (url %s, podcast %s)' % (e_new.id, e.url, p_new.id, e.id, e.url, p_old.id))
             rewrite_episode_actions(e, e_new)
-            log('episode actions for episode %s (url %s, podcast %s) updated, deleting.' % (e.id, e.url, p_old.id))
+            log('episode actions for episode %s (url "%s", podcast %s) updated, deleting.' % (e.id, e.url, p_old.id))
             e.delete()
 
         except Episode.DoesNotExist:
-            log('updating episode %s (url %s, podcast %s => %s)' % (e.id, e.url, p_old.id, p_new.od))
+            log('updating episode %s (url "%s", podcast %s => %s)' % (e.id, e.url, p_old.id, p_new.od))
             e.podcast = p_new
             e.save()
 

commit 544eac0a669df5b3a67a84cd9395d373aca6ad57
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Jan 16 15:00:21 2010 +0100

    basic_sanitizing removes leading, trailing spaces

diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
index 99422f1..d2909e4 100644
--- a/mygpo/api/sanitizing.py
+++ b/mygpo/api/sanitizing.py
@@ -14,6 +14,7 @@ def basic_sanitizing(url):
     """
     does basic sanitizing through urlparse and additionally converts the netloc to lowercase
     """
+    url = url.strip()
     r = urlparse.urlsplit(url)
     netloc = r.netloc.lower()
     r2 = urlparse.SplitResult(r.scheme, netloc, r.path, r.query, r.fragment)
@@ -59,7 +60,7 @@ def maintenance():
     sanitized_urls = []
     for p in podcasts:
         count += 1
-        if (count % 1000) == 0: print '%s %% (podcast id %s)' % (((count + 0.0)/podcasts.count()*100), p.id)
+        if (count % 100) == 0: print '%s %% (podcast id %s)' % (((count + 0.0)/podcasts.count()*100), p.id)
 
         su = sanitize_url(p.url)
         if su == p.url: 
@@ -68,7 +69,14 @@ def maintenance():
     
         try:
             su_podcast = Podcast.objects.get(url=su)
+
+            if p == su_podcast:
+                unchanged += 1
+                continue
+
             rewrite_podcasts(p, su_podcast)
+            tmp = Subscription.objects.filter(podcast=p)
+            if tmp.count() > 0: print tmp.count()
             p.delete()
             merged += 1
 

commit 8ba0aa0ff2a03b1a9c2eeb68fecd8779a156c702
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Jan 16 14:28:20 2010 +0100

    add django management cmd sanitizing-maintenance

diff --git a/mygpo/api/management/__init__.py b/mygpo/api/management/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/mygpo/api/management/commands/__init__.py b/mygpo/api/management/commands/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/mygpo/api/management/commands/sanitizing-maintenance.py b/mygpo/api/management/commands/sanitizing-maintenance.py
new file mode 100644
index 0000000..3c542b8
--- /dev/null
+++ b/mygpo/api/management/commands/sanitizing-maintenance.py
@@ -0,0 +1,7 @@
+from django.core.management.base import BaseCommand
+from mygpo.api.sanitizing import maintenance
+
+class Command(BaseCommand):
+    def handle(self, *args, **options):
+        maintenance()
+

commit 8cac0747fde55d0723027c6bfe20261b9cb92080
Merge: bf46b40... d724616...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Jan 16 14:26:58 2010 +0100

    Merge branch 'master' of dgpo:mygpo-src
    
    Conflicts:
    	install/update-12.sql
    	mygpo/api/sanitizing.py

commit bf46b404a3a92b1479c7cb05ef89120cadbbc4b5
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Jan 16 14:23:32 2010 +0100

    finished url sanitizing maintenance

diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
index ceb797c..1307d42 100644
--- a/mygpo/api/sanitizing.py
+++ b/mygpo/api/sanitizing.py
@@ -1,7 +1,13 @@
-from mygpo.api.models import URLSanitizingRule, Podcast
+from mygpo.api.models import URLSanitizingRule, Podcast, ToplistEntry, SuggestionEntry, SubscriptionAction, SubscriptionMeta, Subscription, Episode, EpisodeAction
+from mygpo.log import log
 import urlparse
 import re
+import sys
 
+def sanitize_url(url, podcast=True, episode=False):
+    url = basic_sanitizing(url)
+    url = apply_sanitizing_rules(url, podcast, episode)
+    return url
 
 def basic_sanitizing(url):
     """
@@ -38,18 +44,101 @@ def maintenance():
     print 'Stats'
     print ' * %s podcasts' % Podcast.objects.count()
     print ' * %s rules' % URLSanitizingRule.objects.count()
-    print 
+    print
+    print 'working...'
+
+    unchanged = 0
+    merged = 0
+    updated = 0
 
+    count = 0
     podcasts = Podcast.objects.all()
     duplicates = 0
     sanitized_urls = []
     for p in podcasts:
-        su = p.url
-        su = basic_sanitizing(su)
-        su = apply_sanitizing_rules(su)
-        if su in sanitized_urls:
-            duplicates += 1
-        else:
-            sanitized_urls.append(su)
-    return duplicates
+        count += 1
+        if (count % 1000) == 0: print '%s %% (podcast id %s)' % (((count + 0.0)/podcasts.count()*100), p.id)
+
+        su = sanitize_url(p.url)
+        if su == p.url: 
+            unchanged += 1
+            continue
+    
+        try:
+            su_podcast = Podcast.objects.get(url=su)
+            rewrite_podcasts(p, su_podcast)
+            p.delete()
+            merged += 1
+
+        except Podcast.DoesNotExist, e:
+            log('updating podcast %s - %s => %s' % (p.id, p.url, su))
+            p.url = su
+            p.save()
+            updated += 1
+
+    print ' * %s unchanged' % unchanged
+    print ' * %s merged' % merged
+    print ' * %s updated' % updated
+
+
+def rewrite_podcasts(p_old, p_new):
+
+    log('merging podcast %s (%s) to correct podcast %s (%s)' % (p_old.id, p_old.url, p_new.id, p_new.url))
+
+    # we simply delete incorrect toplist and suggestions entries, 
+    # because we can't re-calculate them
+    ToplistEntry.objects.filter(podcast=p_old).delete()
+    SuggestionEntry.objects.filter(podcast=p_old).delete()
+
+    rewrite_episodes(p_old, p_new)
+
+    for sm in SubscriptionMeta.objects.filter(podcast=p_old):
+        try:
+            sm_new = SubscriptionMeta.objects.get(user=sm.user, podcast=p_new)
+            log('subscription meta %s (user %s, podcast %s) already exists, deleting %s (user %s, podcast %s)' % (sm_new.id, sm.user.id, p_new.id, sm.id, sm.user.id, p_old.id))
+            # meta-info already exist for the correct podcast, delete the other one
+            sm.delete()
+
+        except SubscriptionMeta.DoesNotExist:
+            # meta-info for new podcast does not yet exist, update the old one
+            log('updating subscription meta %s (user %s, podcast %s => %s)' % (sm.id, sm.user, p_old.id, p_new.id))
+            sm.podcast = p_new
+            sm.save()
+
+    for sa in SubscriptionAction.objects.filter(podcast=p_old):
+        try:
+            log('updating subscription action %s (device %s, action %s, timestamp %s, podcast %s => %s)' % (sa.id, sa.device.id, sa.action, sa.timestamp, sa.podcast.id, p_new.id))
+            sa.podcast = p_new
+            sa.save()
+        except Exception as e:
+            log('error updating subscription action %s: %s, deleting' % (sa.id, e))
+            sa.delete()
+
+def rewrite_episodes(p_old, p_new):
+
+    for e in Episode.objects.filter(podcast=p_old):
+        try:
+            e_new = Episode.objects.get(podcast=p_new, url=e.url)
+            log('episode %s (url %s, podcast %s) already exists; updating episode actions for episode %s (url %s, podcast %s)' % (e_new.id, e.url, p_new.id, e.id, e.url, p_old.id))
+            rewrite_episode_actions(e, e_new)
+            log('episode actions for episode %s (url %s, podcast %s) updated, deleting.' % (e.id, e.url, p_old.id))
+            e.delete()
+
+        except Episode.DoesNotExist:
+            log('updating episode %s (url %s, podcast %s => %s)' % (e.id, e.url, p_old.id, p_new.od))
+            e.podcast = p_new
+            e.save()
+
+        
+def rewrite_episode_actions(e_old, e_new):
+    
+    for ea in EpisodeAction.objects.filter(episode=e_old):
+        try:
+            log('updating episode action %s (user %s, timestamp %s, episode %s => %s)' % (ea.id, ea.user.id, ea.timestamp, e_old.id, e_new.id))
+            ea.epsidode = e_new
+            ea.save()
+
+        except Exception as e:
+            log('error updating episode action %s: %s, deleting' % (sa.id, e))
+            ea.delete()
 

commit bb49be22c25985ef1b42b74935a138531d5c4cf5
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Jan 16 13:01:57 2010 +0100

    add unique, id to SubscriptionMeta (subscription)
    
    added an id field to table subscription
    made (user, podcast) unique in model SubscriptionMeta (table subscription)

diff --git a/install/update-12.sql b/install/update-12.sql
index fdabbe3..76f0ad2 100644
--- a/install/update-12.sql
+++ b/install/update-12.sql
@@ -48,3 +48,7 @@ CREATE TABLE `sanitizing_rules` (
     `description` longtext NOT NULL
 );
 
+alter table subscription add column id int unique auto_increment;
+
+create unique index unique_subscription_meta on subscription (user_id, podcast_id);
+
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 04400a3..a414c86 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -369,6 +369,7 @@ class SubscriptionMeta(models.Model):
 
     class Meta:
         db_table = 'subscription'
+        unique_together = ('user', 'podcast')
 
 
 class SubscriptionAction(models.Model):

commit 127048a7c3b6fa0196cbbbe741f0bf54a2ed8451
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Jan 15 17:51:49 2010 +0100

    implemented basic url sanitizing

diff --git a/install/sanitizing-rules.sql b/install/sanitizing-rules.sql
new file mode 100644
index 0000000..21bce60
--- /dev/null
+++ b/install/sanitizing-rules.sql
@@ -0,0 +1,3 @@
+INSERT INTO `sanitizing_rules` VALUES (1,1,0,'feeds2\\.feedburner\\.com','feeds.feedburner.com',1,'Rewriting for feedburner should happen as \"feeds2.feedburner.com\" -> \"feeds.feedburner.com\"');
+INSERT INTO `sanitizing_rules` VALUES (2,1,0,'(?P<unchanged>feedburner\\.com.+)\\?format=xml','\\g<unchanged>',2,'Feedburner URLs should have their \"?format=xml\" query string removed: \r\n\r\nhttp://feeds2.feedburner.com/linuxoutlaws?format=xml \r\nhttp://feeds.feedburner.com/linuxoutlaws \r\n');
+
diff --git a/install/update-12.sql b/install/update-12.sql
index c99ed36..fdabbe3 100644
--- a/install/update-12.sql
+++ b/install/update-12.sql
@@ -36,3 +36,15 @@ BEGIN
 
 END $$
 DELIMITER ;
+
+
+CREATE TABLE `sanitizing_rules` (
+    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
+    `use_podcast` bool NOT NULL,
+    `use_episode` bool NOT NULL,
+    `search` varchar(100) NOT NULL,
+    `replace` varchar(100) NOT NULL,
+    `priority` integer UNSIGNED NOT NULL,
+    `description` longtext NOT NULL
+);
+
diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 7df2be7..7a82e7e 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -68,4 +68,5 @@ admin.site.register(SyncGroup, SyncGroupAdmin)
 admin.site.register(Device, DeviceAdmin)
 admin.site.register(Subscription, SubscriptionAdmin)
 admin.site.register(SubscriptionAction, SubscriptionActionAdmin)
+admin.site.register(URLSanitizingRule)
 
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index b278f24..04400a3 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -403,3 +403,17 @@ class Rating(models.Model):
     def __unicode__(self):
         return '%s rates %s as %s on %s' % (self.user, self.target, self.rating, self.timestamp)
 
+class URLSanitizingRule(models.Model):
+    use_podcast = models.BooleanField()
+    use_episode = models.BooleanField()
+    search = models.CharField(max_length=100)
+    replace = models.CharField(max_length=100)
+    priority = models.PositiveIntegerField()
+    description = models.TextField(null=False, blank=True)
+
+    class Meta:
+        db_table = 'sanitizing_rules'
+
+    def __unicode__(self):
+        return '%s -> %s' % (self.search, self.replace)
+
diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
new file mode 100644
index 0000000..ceb797c
--- /dev/null
+++ b/mygpo/api/sanitizing.py
@@ -0,0 +1,55 @@
+from mygpo.api.models import URLSanitizingRule, Podcast
+import urlparse
+import re
+
+
+def basic_sanitizing(url):
+    """
+    does basic sanitizing through urlparse and additionally converts the netloc to lowercase
+    """
+    r = urlparse.urlsplit(url)
+    netloc = r.netloc.lower()
+    r2 = urlparse.SplitResult(r.scheme, netloc, r.path, r.query, r.fragment)
+    return r2.geturl()
+
+def apply_sanitizing_rules(url, podcast=True, episode=False):
+    """
+    applies all url sanitizing rules to the given url
+    setting podcast=True uses only those rules which have use_podcast set to True. 
+    When passing podcast=False this check is ommitted. The same is valid
+    for episode.
+    """
+    rules = URLSanitizingRule.objects.all().order_by('priority')
+    if podcast: rules = rules.filter(use_podcast=True)
+    if episode: rules = rules.filter(use_podcast=True)
+
+    for r in rules:
+        url = re.sub(r.search, r.replace, url)
+
+    return url
+
+def maintenance():
+    """
+    This currently checks how many podcasts could be removed by 
+    applying both basic sanitizing rules and those from the database.
+
+    This will later be used to replace podcasts!
+    """
+    print 'Stats'
+    print ' * %s podcasts' % Podcast.objects.count()
+    print ' * %s rules' % URLSanitizingRule.objects.count()
+    print 
+
+    podcasts = Podcast.objects.all()
+    duplicates = 0
+    sanitized_urls = []
+    for p in podcasts:
+        su = p.url
+        su = basic_sanitizing(su)
+        su = apply_sanitizing_rules(su)
+        if su in sanitized_urls:
+            duplicates += 1
+        else:
+            sanitized_urls.append(su)
+    return duplicates
+

commit d724616663f244a02d1d4262836e3a5b637f4e15
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Jan 15 17:51:49 2010 +0100

    implemented basic url sanitizing

diff --git a/install/sanitizing-rules.sql b/install/sanitizing-rules.sql
new file mode 100644
index 0000000..21bce60
--- /dev/null
+++ b/install/sanitizing-rules.sql
@@ -0,0 +1,3 @@
+INSERT INTO `sanitizing_rules` VALUES (1,1,0,'feeds2\\.feedburner\\.com','feeds.feedburner.com',1,'Rewriting for feedburner should happen as \"feeds2.feedburner.com\" -> \"feeds.feedburner.com\"');
+INSERT INTO `sanitizing_rules` VALUES (2,1,0,'(?P<unchanged>feedburner\\.com.+)\\?format=xml','\\g<unchanged>',2,'Feedburner URLs should have their \"?format=xml\" query string removed: \r\n\r\nhttp://feeds2.feedburner.com/linuxoutlaws?format=xml \r\nhttp://feeds.feedburner.com/linuxoutlaws \r\n');
+
diff --git a/install/update-12.sql b/install/update-12.sql
index c99ed36..fdabbe3 100644
--- a/install/update-12.sql
+++ b/install/update-12.sql
@@ -36,3 +36,15 @@ BEGIN
 
 END $$
 DELIMITER ;
+
+
+CREATE TABLE `sanitizing_rules` (
+    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
+    `use_podcast` bool NOT NULL,
+    `use_episode` bool NOT NULL,
+    `search` varchar(100) NOT NULL,
+    `replace` varchar(100) NOT NULL,
+    `priority` integer UNSIGNED NOT NULL,
+    `description` longtext NOT NULL
+);
+
diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 7df2be7..7a82e7e 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -68,4 +68,5 @@ admin.site.register(SyncGroup, SyncGroupAdmin)
 admin.site.register(Device, DeviceAdmin)
 admin.site.register(Subscription, SubscriptionAdmin)
 admin.site.register(SubscriptionAction, SubscriptionActionAdmin)
+admin.site.register(URLSanitizingRule)
 
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index b278f24..04400a3 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -403,3 +403,17 @@ class Rating(models.Model):
     def __unicode__(self):
         return '%s rates %s as %s on %s' % (self.user, self.target, self.rating, self.timestamp)
 
+class URLSanitizingRule(models.Model):
+    use_podcast = models.BooleanField()
+    use_episode = models.BooleanField()
+    search = models.CharField(max_length=100)
+    replace = models.CharField(max_length=100)
+    priority = models.PositiveIntegerField()
+    description = models.TextField(null=False, blank=True)
+
+    class Meta:
+        db_table = 'sanitizing_rules'
+
+    def __unicode__(self):
+        return '%s -> %s' % (self.search, self.replace)
+
diff --git a/mygpo/api/sanitizing.py b/mygpo/api/sanitizing.py
new file mode 100644
index 0000000..ceb797c
--- /dev/null
+++ b/mygpo/api/sanitizing.py
@@ -0,0 +1,55 @@
+from mygpo.api.models import URLSanitizingRule, Podcast
+import urlparse
+import re
+
+
+def basic_sanitizing(url):
+    """
+    does basic sanitizing through urlparse and additionally converts the netloc to lowercase
+    """
+    r = urlparse.urlsplit(url)
+    netloc = r.netloc.lower()
+    r2 = urlparse.SplitResult(r.scheme, netloc, r.path, r.query, r.fragment)
+    return r2.geturl()
+
+def apply_sanitizing_rules(url, podcast=True, episode=False):
+    """
+    applies all url sanitizing rules to the given url
+    setting podcast=True uses only those rules which have use_podcast set to True. 
+    When passing podcast=False this check is ommitted. The same is valid
+    for episode.
+    """
+    rules = URLSanitizingRule.objects.all().order_by('priority')
+    if podcast: rules = rules.filter(use_podcast=True)
+    if episode: rules = rules.filter(use_podcast=True)
+
+    for r in rules:
+        url = re.sub(r.search, r.replace, url)
+
+    return url
+
+def maintenance():
+    """
+    This currently checks how many podcasts could be removed by 
+    applying both basic sanitizing rules and those from the database.
+
+    This will later be used to replace podcasts!
+    """
+    print 'Stats'
+    print ' * %s podcasts' % Podcast.objects.count()
+    print ' * %s rules' % URLSanitizingRule.objects.count()
+    print 
+
+    podcasts = Podcast.objects.all()
+    duplicates = 0
+    sanitized_urls = []
+    for p in podcasts:
+        su = p.url
+        su = basic_sanitizing(su)
+        su = apply_sanitizing_rules(su)
+        if su in sanitized_urls:
+            duplicates += 1
+        else:
+            sanitized_urls.append(su)
+    return duplicates
+
diff --git a/mygpo/settings.py b/mygpo/settings.py
index 4e085f2..af99b3a 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -32,8 +32,8 @@ ADMINS = (
 MANAGERS = ADMINS
 
 DATABASE_ENGINE = 'mysql'           # 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.
-DATABASE_NAME = 'mygpo'             # Or path to database file if using sqlite3.
-DATABASE_USER = 'mygpo'             # Not used with sqlite3.
+DATABASE_NAME = 'mygpo_prod'             # Or path to database file if using sqlite3.
+DATABASE_USER = 'mygpo_prod'             # Not used with sqlite3.
 DATABASE_PASSWORD = ''         # Not used with sqlite3.
 DATABASE_HOST = ''             # Set to empty string for localhost. Not used with sqlite3.
 DATABASE_PORT = ''             # Set to empty string for default. Not used with sqlite3.

commit 3d89140bd8440102eb4d02173a418184ce048c87
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Fri Jan 15 14:49:54 2010 +0100

    suggestions in simple API + bugs in simple API

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index bef70a8..ef3b0d8 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -17,7 +17,7 @@
 
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
-from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, ToplistEntry
+from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, ToplistEntry, SuggestionEntry
 from mygpo.api.opml import Exporter, Importer
 from mygpo.api.httpresponse import JsonResponse
 from django.core import serializers
@@ -140,43 +140,34 @@ def set_subscriptions(subscriptions):
     return HttpResponse('', mimetype='text/plain')
 
 #get toplist
-def toplist(request, number, format):
+def toplist(request, count, format):
     if request.method == 'GET':
-        if int(number) not in range(1,100):
-            print number
-            number = 100
-        return format_toplist(get_toplist(number), number, format)
+        if int(count) not in range(1,100):
+            count = 100
+        return format_toplist(get_toplist(count), count, format)
     else:
         return HttpResponseBadRequest('Invalid request')
 
 
-def get_toplist(number):
-    entries = ToplistEntry.objects.all().order_by('-subscriptions')[:number]
-    toplist = []
-    for e in entries:
-        pid = e.podcast_id
-        p = Podcast.objects.get(pk=pid)
-        entry = {'url':p.url, 'title':p.title, 'description':p.description, 'subscribers':e.subscriptions, 'subscribers_last_week':e.oldplace}
-        toplist.append(entry)
-        
-    return toplist
+def get_toplist(count):        
+    return ToplistEntry.objects.all().order_by('-subscriptions')[:int(count)]
 
 
-def format_toplist(toplist, number, format): 
+def format_toplist(toplist, count, format): 
     if format == 'txt':
-        urls = [t['url'] for t in toplist]
+        urls = [t.podcast.url for t in toplist]
         s = '\n'.join(urls)
         s += '\n'
         return HttpResponse(s, mimetype='text/plain')
 
     elif format == 'opml':
-        title = 'Top %d' % number
-        exporter = Exporter(title)
-        opml = exporter.generate(toplist)
+        exporter = Exporter('my.gpodder.org - Top %s' % count)
+        opml = exporter.generate([t.podcast for t in toplist])
         return HttpResponse(opml, mimetype='text/xml')
 
     elif format == 'json':
-        return JsonResponse(toplist)
+        json = [{'url':t.podcast.url, 'title':t.podcast.title, 'description':t.podcast.description, 'subscribers':t.subscriptions, 'subscribers_last_week':t.oldplace} for t in toplist]
+        return JsonResponse(json)
         
     else: 
         return HttpResponseBadRequest('Invalid format')
@@ -212,8 +203,7 @@ def format_results(results, format):
         return HttpResponse(s, mimetype='text/plain')
 
     elif format == 'opml':
-        title = 'Search results'
-        exporter = Exporter(title)
+        exporter = Exporter('my.gpodder.org - Search')
         opml = exporter.generate(results)
         return HttpResponse(opml, mimetype='text/xml')
 
@@ -223,4 +213,37 @@ def format_results(results, format):
         
     else: 
         return HttpResponseBadRequest('Invalid format')
+       
+#get suggestions
+@require_valid_user
+def suggestions(request, count, format):
+    if request.method == 'GET':
+        if int(count) not in range(1,100):
+            count = 100
+        return format_suggestions(get_suggestions(request.user, count), count, format)
+    else:
+        return HttpResponseBadRequest('Invalid request')
+        
+def get_suggestions(user, count):
+    suggestions = SuggestionEntry.forUser(user)[:int(count)]
+    return [s.podcast for s in suggestions]
+    
+def format_suggestions(suggestions, count, format):
+    if format == 'txt':
+        urls = [s.url for s in suggestions]
+        s = '\n'.join(urls)
+        s += '\n'
+        return HttpResponse(s, mimetype='text/plain')
+
+    elif format == 'opml':
+        exporter = Exporter('my.gpodder.org - %s Suggestions' % count)
+        opml = exporter.generate(suggestions)
+        return HttpResponse(opml, mimetype='text/xml')
+
+    elif format == 'json':
+        json = [{'url':p.url, 'title':p.title, 'description':p.description} for p in suggestions]
+        return JsonResponse(json)
+        
+    else: 
+        return HttpResponseBadRequest('Invalid format')
         
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 5ff72b1..5cef0b5 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -51,11 +51,9 @@ urlpatterns = patterns('',
     (r'^devices/$', 'mygpo.web.views.devices'),
 
     (r'^toplist/$', 'mygpo.web.views.toplist'),
-    (r'^toplist/(?P<count>\d+).opml', 'mygpo.web.views.toplist_opml'),
     (r'^toplist.opml$', 'mygpo.web.views.toplist_opml', {'count': 50}),
 
     (r'^suggestions/$', 'mygpo.web.views.suggestions'),
-    (r'^suggestions/(?P<count>\d+).opml$', 'mygpo.web.views.suggestions_opml'),
 
     (r'^device/(?P<device_id>\d+)$', 'mygpo.web.views.device'),
     (r'^device/(?P<device_id>\d+)/sync$', 'mygpo.web.views.device_sync'),
@@ -69,8 +67,9 @@ urlpatterns = patterns('',
 
     #Simple API
     (r'^subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).(?P<format>\w+)', 'mygpo.api.simple.subscriptions'),
-    (r'^toplist/(?P<number>\d+).(?P<format>\w+)', 'mygpo.api.simple.toplist'),
+    (r'^toplist/(?P<count>\d+).(?P<format>\w+)', 'mygpo.api.simple.toplist'),
     (r'^search.(?P<format>\w+)', 'mygpo.api.simple.search'),
+    (r'^suggestions/(?P<count>\d+).(?P<format>\w+)', 'mygpo.api.simple.suggestions'),
 
     #Advanced API
     (r'^api/1/subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.subscriptions'),
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index a3cd82e..223235f 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -215,15 +215,6 @@ def suggestions(request):
     }, context_instance=RequestContext(request))
 
 
-@require_valid_user
-def suggestions_opml(request, count):
-    entries = SuggestionEntry.forUser(request.user)
-    exporter = Exporter(_('my.gpodder.org - %s Suggestions') % count)
-
-    opml = exporter.generate([e.podcast for e in entries])
-
-    return HttpResponse(opml, mimetype='text/xml')
-
 @login_required
 def device(request, device_id):
     device = Device.objects.get(pk=device_id)

commit 9bfa0c777196eb0fe7ce313c2e80cee66ffdbcbf
Merge: 708d948... 638bd07...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Jan 15 11:55:10 2010 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit 638bd07f89ea1c7460696a3f9fba70346f6858b5
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Fri Jan 15 11:15:48 2010 +0100

     Bug 788 -  purge inactive users

diff --git a/install/update-12.sql b/install/update-12.sql
new file mode 100644
index 0000000..c99ed36
--- /dev/null
+++ b/install/update-12.sql
@@ -0,0 +1,38 @@
+DELIMITER $$
+DROP PROCEDURE IF EXISTS delete_inactive_users $$
+CREATE PROCEDURE delete_inactive_users()
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
+    DECLARE done INT DEFAULT 0;
+    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+         DECLARE deadlock_detected CONDITION FOR 1213;
+         DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+         SET deadlock=0;
+               
+         START TRANSACTION;
+
+            delete from auth_user where is_active=0 and datediff(date(now()), date(date_joined)) > 7;
+
+            COMMIT;  
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Inactive users are not deleted!');
+        END IF;         
+
+END $$
+DELIMITER ;

commit 708d9484248e4f6872ebe01ebecbbf859beb1749
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Jan 14 23:40:08 2010 +0100

    don't show "Last week" in toplist for new entries

diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
index 63383fa..815fd72 100644
--- a/mygpo/web/templates/toplist.html
+++ b/mygpo/web/templates/toplist.html
@@ -16,7 +16,7 @@
   {% for entry in entries %}
    <tr>
     <td>{{ forloop.counter }}</td>
-    <td class="numeric">{{ entry.oldplace }}</td>
+    <td class="numeric">{{ entry.oldplace|default_if_none:"" }}</td>
     <td><a href="/podcast/{{ entry.podcast.id }}">{{ entry.podcast }}</a></td>
     <td class="numeric">{{ entry.subscriptions }}</td>
    </tr>

commit 22b9325e0ee3f4c792ce5c2c6991e75e88f0a2c1
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 19:41:51 2010 +0100

    Translation podcast-author

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index 2266d90..3da0f51 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -45,7 +45,7 @@ msgstr "Welche UID besitzt das physikalische Gert?"
 
 #: web/views.py:117
 msgid "With which client do you want to subscribe?"
-msgstr "Auf welchem Benutzer willst du aboonieren?"
+msgstr "Whle ein Gert zum abonnieren:"
 
 #: web/views.py:195
 #, python-format
@@ -106,13 +106,12 @@ msgid "Your settings have been saved."
 msgstr "Ihre Einstellungen wurden gespeichert."
 
 #: web/templates/account.html:11
-#, fuzzy
 msgid "Update the settings for your account."
 msgstr "Aktualisierung der Konto-Einstellungen"
 
 #: web/templates/authors.html:5 web/templates/base.html:100
 msgid "For podcast authors"
-msgstr "Fr die Podcast-Autoren"
+msgstr "Fr Podcast-Autoren"
 
 #: web/templates/authors.html:8
 msgid ""

commit 4c5db054a3caefff71fbd5ca617c87c240c3b0a2
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 19:36:11 2010 +0100

    Style fixes

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index 2edb86b..2266d90 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 19:07+0100\n"
+"POT-Creation-Date: 2010-01-14 19:36+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -106,7 +106,8 @@ msgid "Your settings have been saved."
 msgstr "Ihre Einstellungen wurden gespeichert."
 
 #: web/templates/account.html:11
-msgid "Update the settings for your account"
+#, fuzzy
+msgid "Update the settings for your account."
 msgstr "Aktualisierung der Konto-Einstellungen"
 
 #: web/templates/authors.html:5 web/templates/base.html:100
@@ -421,7 +422,7 @@ msgid "How can I copy single subscriptions between devices?"
 msgstr ""
 
 #: web/templates/online-help.html:29
-msgid "Open the gPodder Podcast-Client on your PC or MAC."
+msgid "Open the &quot;gPodder Podcast-Client&quot; on your PC or MAC."
 msgstr ""
 
 #: web/templates/online-help.html:30
@@ -432,7 +433,7 @@ msgstr ""
 
 #: web/templates/online-help.html:32 web/templates/online-help.html.py:50
 #: web/templates/online-help.html:60
-msgid "Click on your &quot;home&quot;-link."
+msgid "Click on your &quot;Subscriptions&quot;-link."
 msgstr ""
 
 #: web/templates/online-help.html:33
@@ -453,7 +454,8 @@ msgid ""
 msgstr ""
 
 #: web/templates/online-help.html:43
-msgid "Choose a device on your home-screen and click on it."
+msgid ""
+"Choose a device on your &quot;Subscriptions-screen&quot; and click on it."
 msgstr ""
 
 #: web/templates/online-help.html:45
diff --git a/mygpo/locale/en/LC_MESSAGES/django.po b/mygpo/locale/en/LC_MESSAGES/django.po
index 963a4cc..00106a2 100644
--- a/mygpo/locale/en/LC_MESSAGES/django.po
+++ b/mygpo/locale/en/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 19:07+0100\n"
+"POT-Creation-Date: 2010-01-14 19:36+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -102,7 +102,7 @@ msgid "Your settings have been saved."
 msgstr ""
 
 #: web/templates/account.html:11
-msgid "Update the settings for your account"
+msgid "Update the settings for your account."
 msgstr ""
 
 #: web/templates/authors.html:5 web/templates/base.html:100
@@ -395,7 +395,7 @@ msgid "How can I copy single subscriptions between devices?"
 msgstr ""
 
 #: web/templates/online-help.html:29
-msgid "Open the gPodder Podcast-Client on your PC or MAC."
+msgid "Open the &quot;gPodder Podcast-Client&quot; on your PC or MAC."
 msgstr ""
 
 #: web/templates/online-help.html:30
@@ -406,7 +406,7 @@ msgstr ""
 
 #: web/templates/online-help.html:32 web/templates/online-help.html.py:50
 #: web/templates/online-help.html:60
-msgid "Click on your &quot;home&quot;-link."
+msgid "Click on your &quot;Subscriptions&quot;-link."
 msgstr ""
 
 #: web/templates/online-help.html:33
@@ -427,7 +427,8 @@ msgid ""
 msgstr ""
 
 #: web/templates/online-help.html:43
-msgid "Choose a device on your home-screen and click on it."
+msgid ""
+"Choose a device on your &quot;Subscriptions-screen&quot; and click on it."
 msgstr ""
 
 #: web/templates/online-help.html:45
diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
index 6c2c27a..deb1d8a 100644
--- a/mygpo/locale/it/LC_MESSAGES/django.po
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 19:07+0100\n"
+"POT-Creation-Date: 2010-01-14 19:35+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -102,7 +102,7 @@ msgid "Your settings have been saved."
 msgstr ""
 
 #: web/templates/account.html:11
-msgid "Update the settings for your account"
+msgid "Update the settings for your account."
 msgstr ""
 
 #: web/templates/authors.html:5 web/templates/base.html:100
@@ -399,7 +399,7 @@ msgid "How can I copy single subscriptions between devices?"
 msgstr ""
 
 #: web/templates/online-help.html:29
-msgid "Open the gPodder Podcast-Client on your PC or MAC."
+msgid "Open the &quot;gPodder Podcast-Client&quot; on your PC or MAC."
 msgstr ""
 
 #: web/templates/online-help.html:30
@@ -410,7 +410,7 @@ msgstr ""
 
 #: web/templates/online-help.html:32 web/templates/online-help.html.py:50
 #: web/templates/online-help.html:60
-msgid "Click on your &quot;home&quot;-link."
+msgid "Click on your &quot;Subscriptions&quot;-link."
 msgstr ""
 
 #: web/templates/online-help.html:33
@@ -431,7 +431,8 @@ msgid ""
 msgstr ""
 
 #: web/templates/online-help.html:43
-msgid "Choose a device on your home-screen and click on it."
+msgid ""
+"Choose a device on your &quot;Subscriptions-screen&quot; and click on it."
 msgstr ""
 
 #: web/templates/online-help.html:45
diff --git a/mygpo/locale/nb/LC_MESSAGES/django.po b/mygpo/locale/nb/LC_MESSAGES/django.po
index a2af450..511ddae 100644
--- a/mygpo/locale/nb/LC_MESSAGES/django.po
+++ b/mygpo/locale/nb/LC_MESSAGES/django.po
@@ -6,7 +6,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: 2.1\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 19:07+0100\n"
+"POT-Creation-Date: 2010-01-14 19:36+0100\n"
 "PO-Revision-Date: 2010-01-06 11:48+0100\n"
 "Last-Translator: Jim Nygrd <jim@nygard.priv.no>\n"
 "Language-Team: gpodder <>\n"
@@ -104,7 +104,8 @@ msgid "Your settings have been saved."
 msgstr "Dine innstillinger er lagret."
 
 #: web/templates/account.html:11
-msgid "Update the settings for your account"
+#, fuzzy
+msgid "Update the settings for your account."
 msgstr "Oppdater innstillingene for kontoen din"
 
 #: web/templates/authors.html:5 web/templates/base.html:100
@@ -425,7 +426,7 @@ msgid "How can I copy single subscriptions between devices?"
 msgstr ""
 
 #: web/templates/online-help.html:29
-msgid "Open the gPodder Podcast-Client on your PC or MAC."
+msgid "Open the &quot;gPodder Podcast-Client&quot; on your PC or MAC."
 msgstr ""
 
 #: web/templates/online-help.html:30
@@ -436,7 +437,7 @@ msgstr ""
 
 #: web/templates/online-help.html:32 web/templates/online-help.html.py:50
 #: web/templates/online-help.html:60
-msgid "Click on your &quot;home&quot;-link."
+msgid "Click on your &quot;Subscriptions&quot;-link."
 msgstr ""
 
 #: web/templates/online-help.html:33
@@ -457,7 +458,8 @@ msgid ""
 msgstr ""
 
 #: web/templates/online-help.html:43
-msgid "Choose a device on your home-screen and click on it."
+msgid ""
+"Choose a device on your &quot;Subscriptions-screen&quot; and click on it."
 msgstr ""
 
 #: web/templates/online-help.html:45
diff --git a/mygpo/web/templates/account.html b/mygpo/web/templates/account.html
index 31ed0c2..f2938a4 100644
--- a/mygpo/web/templates/account.html
+++ b/mygpo/web/templates/account.html
@@ -8,7 +8,7 @@
    <div class="success">{% trans "Your settings have been saved." %}</div>
  {% endif %}
 
-  <p>{% trans "Update the settings for your account" %} <strong>{{ user.username }}</strong>.</p>
+  <p>{% trans "Update the settings for your account." %}</p>
   <form action="/account/" method="POST">
    {{ form.as_p }}
    <input type="submit" value="Save" />

commit 898b2da06e55b16175e758f3ec9c5146ac17753b
Merge: da739c0... 14afd9c...
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 19:28:07 2010 +0100

    Merge branch 'master' of /home/armin/mygpo-src

commit 14afd9caf0a0edd90c8e648ea5ab1e2caab4239e
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Thu Jan 14 19:17:32 2010 +0100

    added icon to devicelist

diff --git a/mygpo/web/templates/devicelist.html b/mygpo/web/templates/devicelist.html
index d5e7ed7..1699ef2 100644
--- a/mygpo/web/templates/devicelist.html
+++ b/mygpo/web/templates/devicelist.html
@@ -15,7 +15,7 @@
     </tr>
     {% for d in devices %}
      <tr>
-      <td><a href="/device/{{ d.id }}">{{ d.name }}</a></td>
+      <td><a href="/device/{{ d.id }}">{{ d|device_icon }}{{ d.name }}</a></td>
       <td>{{ d.type }}</td>
       <td>{{ d.uid }}</td>
      </tr>

commit 7126b252e8ec3c113993b5e4198870c2691577b3
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 19:08:58 2010 +0100

    Translation devicelist

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index 81290bd..2edb86b 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 18:57+0100\n"
+"POT-Creation-Date: 2010-01-14 19:07+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -43,21 +43,21 @@ msgstr "Welcher Art ist dieses Gert?"
 msgid "What UID is configured on the physical device?"
 msgstr "Welche UID besitzt das physikalische Gert?"
 
-#: web/views.py:111
+#: web/views.py:117
 msgid "With which client do you want to subscribe?"
 msgstr "Auf welchem Benutzer willst du aboonieren?"
 
-#: web/views.py:189
+#: web/views.py:195
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr "my.gpodder.org - Top %s"
 
-#: web/views.py:215
+#: web/views.py:221
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr "my.gpodder.org - %s Empfehlungen"
 
-#: web/views.py:229
+#: web/views.py:235
 msgid "Synchronize with the following devices"
 msgstr "Synchronisierung der folgenden Gerte"
 
@@ -237,6 +237,22 @@ msgstr "Beende die Synchronisation fr %(devicename)s "
 msgid "OK"
 msgstr "OK"
 
+#: web/templates/devicelist.html:7
+msgid "Device List"
+msgstr "Gerte-Liste"
+
+#: web/templates/devicelist.html:12
+msgid "Name"
+msgstr "Name"
+
+#: web/templates/devicelist.html:13
+msgid "Type"
+msgstr "Typ"
+
+#: web/templates/devicelist.html:14
+msgid "UID"
+msgstr "UID"
+
 #: web/templates/episode.html:7
 #, python-format
 msgid ""
diff --git a/mygpo/locale/en/LC_MESSAGES/django.po b/mygpo/locale/en/LC_MESSAGES/django.po
index 5525dd6..963a4cc 100644
--- a/mygpo/locale/en/LC_MESSAGES/django.po
+++ b/mygpo/locale/en/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 18:57+0100\n"
+"POT-Creation-Date: 2010-01-14 19:07+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -41,21 +41,21 @@ msgstr ""
 msgid "What UID is configured on the physical device?"
 msgstr ""
 
-#: web/views.py:111
+#: web/views.py:117
 msgid "With which client do you want to subscribe?"
 msgstr ""
 
-#: web/views.py:189
+#: web/views.py:195
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr ""
 
-#: web/views.py:215
+#: web/views.py:221
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr ""
 
-#: web/views.py:229
+#: web/views.py:235
 msgid "Synchronize with the following devices"
 msgstr ""
 
@@ -228,6 +228,22 @@ msgstr ""
 msgid "OK"
 msgstr ""
 
+#: web/templates/devicelist.html:7
+msgid "Device List"
+msgstr ""
+
+#: web/templates/devicelist.html:12
+msgid "Name"
+msgstr ""
+
+#: web/templates/devicelist.html:13
+msgid "Type"
+msgstr ""
+
+#: web/templates/devicelist.html:14
+msgid "UID"
+msgstr ""
+
 #: web/templates/episode.html:7
 #, python-format
 msgid ""
diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
index 28222b7..6c2c27a 100644
--- a/mygpo/locale/it/LC_MESSAGES/django.po
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 18:57+0100\n"
+"POT-Creation-Date: 2010-01-14 19:07+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -41,21 +41,21 @@ msgstr "Che genere di dispositivo  questo?"
 msgid "What UID is configured on the physical device?"
 msgstr ""
 
-#: web/views.py:111
+#: web/views.py:117
 msgid "With which client do you want to subscribe?"
 msgstr ""
 
-#: web/views.py:189
+#: web/views.py:195
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr "my.gpodder.org - Top %s"
 
-#: web/views.py:215
+#: web/views.py:221
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr "my.gpodder.org - %s suggerimenti"
 
-#: web/views.py:229
+#: web/views.py:235
 msgid "Synchronize with the following devices"
 msgstr ""
 
@@ -230,6 +230,23 @@ msgstr ""
 msgid "OK"
 msgstr "OK"
 
+#: web/templates/devicelist.html:7
+#, fuzzy
+msgid "Device List"
+msgstr "Dispositivo"
+
+#: web/templates/devicelist.html:12
+msgid "Name"
+msgstr ""
+
+#: web/templates/devicelist.html:13
+msgid "Type"
+msgstr ""
+
+#: web/templates/devicelist.html:14
+msgid "UID"
+msgstr ""
+
 #: web/templates/episode.html:7
 #, python-format
 msgid ""
diff --git a/mygpo/locale/nb/LC_MESSAGES/django.po b/mygpo/locale/nb/LC_MESSAGES/django.po
index 64aa069..a2af450 100644
--- a/mygpo/locale/nb/LC_MESSAGES/django.po
+++ b/mygpo/locale/nb/LC_MESSAGES/django.po
@@ -6,7 +6,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: 2.1\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 18:57+0100\n"
+"POT-Creation-Date: 2010-01-14 19:07+0100\n"
 "PO-Revision-Date: 2010-01-06 11:48+0100\n"
 "Last-Translator: Jim Nygrd <jim@nygard.priv.no>\n"
 "Language-Team: gpodder <>\n"
@@ -43,21 +43,21 @@ msgstr "Hva slags enhet er dette?"
 msgid "What UID is configured on the physical device?"
 msgstr "Hvilken UID er konfigurert p den fysiske enheten?"
 
-#: web/views.py:111
+#: web/views.py:117
 msgid "With which client do you want to subscribe?"
 msgstr "Med hvilken klient vil du abonnere?"
 
-#: web/views.py:189
+#: web/views.py:195
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr "my.gpodder.org - Topp %s"
 
-#: web/views.py:215
+#: web/views.py:221
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr "my.gpodder.org - %s Forslag"
 
-#: web/views.py:229
+#: web/views.py:235
 msgid "Synchronize with the following devices"
 msgstr "Synkroniser med disse enhetene"
 
@@ -240,6 +240,23 @@ msgstr "Stopp synkroniserine av %(devicename)s "
 msgid "OK"
 msgstr "OK"
 
+#: web/templates/devicelist.html:7
+#, fuzzy
+msgid "Device List"
+msgstr "Enheter"
+
+#: web/templates/devicelist.html:12
+msgid "Name"
+msgstr ""
+
+#: web/templates/devicelist.html:13
+msgid "Type"
+msgstr ""
+
+#: web/templates/devicelist.html:14
+msgid "UID"
+msgstr ""
+
 #: web/templates/episode.html:7
 #, python-format
 msgid ""

commit da739c090cda1927dcd9af2dd62833b1ba377860
Merge: 317f300... d87dcfd...
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 19:07:33 2010 +0100

    Merge branch 'master' of /home/alex/mygpo-src

commit 30595975ec18e790d0a3f5642b90ce650494ee68
Merge: 9bb31e2... d0060d3...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 19:07:24 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/armin/mygpo-src

commit d0060d38ff8b2e733045ed16d8d4dfc65968cad7
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Thu Jan 14 19:07:03 2010 +0100

    added device list

diff --git a/mygpo/urls.py b/mygpo/urls.py
index f69998a..5ff72b1 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -48,6 +48,7 @@ urlpatterns = patterns('',
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     (r'^history/$', 'mygpo.web.views.history'),
+    (r'^devices/$', 'mygpo.web.views.devices'),
 
     (r'^toplist/$', 'mygpo.web.views.toplist'),
     (r'^toplist/(?P<count>\d+).opml', 'mygpo.web.views.toplist_opml'),
diff --git a/mygpo/web/templates/devicelist.html b/mygpo/web/templates/devicelist.html
new file mode 100644
index 0000000..d5e7ed7
--- /dev/null
+++ b/mygpo/web/templates/devicelist.html
@@ -0,0 +1,26 @@
+{% extends "base.html" %}
+{% load i18n %}
+{% load humanize %}
+{% load devices %}
+
+{% block content %}
+  <h1>{% trans "Device List" %}</h1>
+
+   {% if not devices|length_is:"0" %}
+   <table class="list">
+    <tr>
+     <th>{% trans "Name" %}</th>
+     <th>{% trans "Type" %}</th>
+     <th>{% trans "UID" %}</th>
+    </tr>
+    {% for d in devices %}
+     <tr>
+      <td><a href="/device/{{ d.id }}">{{ d.name }}</a></td>
+      <td>{{ d.type }}</td>
+      <td>{{ d.uid }}</td>
+     </tr>
+    {% endfor %}
+   </table>
+  {% endif %}
+{% endblock %}
+
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 1ea1931..a3cd82e 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -86,6 +86,12 @@ def history(request, len=20):
         'history': history,
     }, context_instance=RequestContext(request))
 
+def devices(request):
+    devices = Device.objects.filter(user=request.user)
+    return render_to_response('devicelist.html', {
+        'devices': devices,
+    }, context_instance=RequestContext(request))
+
 @login_required
 def podcast_subscribe(request, pid):
     podcast = Podcast.objects.get(pk=pid)

commit 9bb31e2751e320ecbde38af08ed37a83aa1f57b6
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 19:05:59 2010 +0100

    Translation de

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index 63c32e3..81290bd 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 18:03+0100\n"
+"POT-Creation-Date: 2010-01-14 18:57+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -40,24 +40,24 @@ msgid "What kind of device is this?"
 msgstr "Welcher Art ist dieses Gert?"
 
 #: web/forms.py:13
-msgid "What UID is configured on the pysical device?"
+msgid "What UID is configured on the physical device?"
 msgstr "Welche UID besitzt das physikalische Gert?"
 
-#: web/views.py:109
+#: web/views.py:111
 msgid "With which client do you want to subscribe?"
 msgstr "Auf welchem Benutzer willst du aboonieren?"
 
-#: web/views.py:174
+#: web/views.py:189
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr "my.gpodder.org - Top %s"
 
-#: web/views.py:200
+#: web/views.py:215
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr "my.gpodder.org - %s Empfehlungen"
 
-#: web/views.py:214
+#: web/views.py:229
 msgid "Synchronize with the following devices"
 msgstr "Synchronisierung der folgenden Gerte"
 
@@ -101,7 +101,7 @@ msgstr ""
 msgid "Account Settings"
 msgstr "Konto-Einstellungen"
 
-#: web/templates/account.html:8 web/templates/device.html:50
+#: web/templates/account.html:8 web/templates/device.html:52
 msgid "Your settings have been saved."
 msgstr "Ihre Einstellungen wurden gespeichert."
 
@@ -109,8 +109,7 @@ msgstr "Ihre Einstellungen wurden gespeichert."
 msgid "Update the settings for your account"
 msgstr "Aktualisierung der Konto-Einstellungen"
 
-#: web/templates/authors.html:5 web/templates/base.html:81
-#: web/templates/base.html.py:93
+#: web/templates/authors.html:5 web/templates/base.html:100
 msgid "For podcast authors"
 msgstr "Fr die Podcast-Autoren"
 
@@ -126,59 +125,74 @@ msgstr ""
 msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
 msgstr "ndere YOUR_ADRESS in die Adresse deines Podcastes um."
 
-#: web/templates/base.html:67
-msgid "'s Home"
-msgstr "'s Home"
-
 #: web/templates/base.html:68
-msgid "Your settings"
-msgstr "Konto-Einstellungen"
+msgid "Subscriptions"
+msgstr "Abonnements"
 
 #: web/templates/base.html:69
+msgid "History"
+msgstr "Verlauf"
+
+#: web/templates/base.html:70 web/templates/podcast.html:29
+#: web/templates/podcast.html.py:83
+msgid "Devices"
+msgstr "Gerte"
+
+#: web/templates/base.html:71
+msgid "Settings"
+msgstr "Einstellungen"
+
+#: web/templates/base.html:72
 msgid "Logout"
 msgstr "Abmelden"
 
-#: web/templates/base.html:73 web/templates/device.html:9
-msgid "Podcasts"
-msgstr "Podcasts"
+#: web/templates/base.html:76 web/templates/base.html.py:91
+msgid "Discover"
+msgstr "Entdecken"
 
-#: web/templates/base.html:74 web/templates/search/search.html:6
+#: web/templates/base.html:77 web/templates/base.html.py:92
+#: web/templates/search/search.html:6
 msgid "Search"
-msgstr "Suche"
+msgstr "Suchen"
 
-#: web/templates/base.html:75 web/templates/toplist.html:5
+#: web/templates/base.html:78 web/templates/base.html.py:93
+#: web/templates/toplist.html:5
 msgid "Toplist"
 msgstr "Topliste"
 
-#: web/templates/base.html:76
+#: web/templates/base.html:79
 msgid "Suggestions"
 msgstr "Empfehlungen"
 
-#: web/templates/base.html:77
-msgid "History"
-msgstr "Verlauf"
-
-#: web/templates/base.html:86
+#: web/templates/base.html:85
 msgid "Home"
 msgstr "Home"
 
-#: web/templates/base.html:87
+#: web/templates/base.html:86
 msgid "Login"
 msgstr "Anmelden"
 
-#: web/templates/base.html:88
+#: web/templates/base.html:87
 msgid "Register"
 msgstr "Registrieren"
 
-#: web/templates/base.html:89
-msgid "Podcast-Toplist"
-msgstr "Podcast-Topliste"
+#: web/templates/base.html:98
+msgid "Documentation"
+msgstr "Dokumentation"
+
+#: web/templates/base.html:99 web/templates/online-help.html:5
+msgid "Online Help"
+msgstr "Online-Hilfe"
+
+#: web/templates/device.html:9
+msgid "Podcasts"
+msgstr "Podcasts"
 
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
 msgstr "Du hast die folgenden Podcasts auf diesem Gert abonniert"
 
-#: web/templates/device.html:14 web/templates/podcast.html:56
+#: web/templates/device.html:14 web/templates/podcast.html:60
 msgid "Title"
 msgstr "Titel"
 
@@ -186,11 +200,15 @@ msgstr "Titel"
 msgid "Since"
 msgstr "Seit"
 
-#: web/templates/device.html:27
+#: web/templates/device.html:16
+msgid "Unsubscribe"
+msgstr "Entfernen"
+
+#: web/templates/device.html:29
 msgid "Synchronize"
-msgstr "Synchronisierung"
+msgstr "Synchronisieren"
 
-#: web/templates/device.html:28
+#: web/templates/device.html:30
 msgid ""
 "If you synchronize devices, they will always have the same subscriptions. A "
 "podcast that is subscribed on one device, will automatically be added to all "
@@ -200,22 +218,22 @@ msgstr ""
 "selbenAbonnements vorhanden sein. Ein Podcast der auf einem Gert abonniert "
 "wurde, wird automatisch an alle synchronisierten Gerte weitergegeben."
 
-#: web/templates/device.html:32
+#: web/templates/device.html:34
 #, python-format
 msgid "%(devicename)s is currently not synchronized with other devices."
 msgstr "%(devicename)s wird zur Zeit mit keinem anderen Gert synchronisiert."
 
-#: web/templates/device.html:36
+#: web/templates/device.html:38
 #, python-format
 msgid "%(devicename)s is currently synchronized with %(synclist)s."
 msgstr "%(devicename)s wird zur Zeit mit %(synclist)s synchronisiert."
 
-#: web/templates/device.html:37
+#: web/templates/device.html:39
 #, python-format
 msgid "Stop synchronisation for %(devicename)s "
 msgstr "Beende die Synchronisation fr %(devicename)s "
 
-#: web/templates/device.html:44 web/templates/subscribe.html:20
+#: web/templates/device.html:46 web/templates/subscribe.html:20
 msgid "OK"
 msgstr "OK"
 
@@ -247,7 +265,7 @@ msgstr "Wo"
 msgid "Why Unnamed Episode?"
 msgstr "Warum unbenannte Episoden?"
 
-#: web/templates/episode.html:41 web/templates/podcast.html:99
+#: web/templates/episode.html:41 web/templates/podcast.html:103
 #: web/templates/subscribe.html:24
 msgid ""
 "Because we display names after we have fetched the information form the feed "
@@ -258,7 +276,7 @@ msgstr ""
 "Anspruch nehmen kann. Bis dies erledigt ist wird der Podcast auf diese Wiese "
 "dargestellt."
 
-#: web/templates/history.html:7 web/templates/podcast.html:74
+#: web/templates/history.html:7 web/templates/podcast.html:78
 msgid "Subscription History"
 msgstr "Abonnementverlauf"
 
@@ -267,11 +285,11 @@ msgstr "Abonnementverlauf"
 msgid "Podcast"
 msgstr "Podcast"
 
-#: web/templates/history.html:13 web/templates/podcast.html:77
+#: web/templates/history.html:13 web/templates/podcast.html:81
 msgid "Timestamp"
 msgstr "Zeitpunkt"
 
-#: web/templates/history.html:14 web/templates/podcast.html:78
+#: web/templates/history.html:14 web/templates/podcast.html:82
 msgid "Action"
 msgstr "Aktivitt"
 
@@ -358,6 +376,119 @@ msgstr ""
 "Version (mit vielen neuen Funktionen) verffentlicht wurde, musst du fr den "
 "Zugang deinen neuen Benutzernamen benutzen."
 
+#: web/templates/online-help.html:9 web/templates/online-help.html.py:27
+msgid "How can I configure my devices?"
+msgstr ""
+
+#: web/templates/online-help.html:11 web/templates/online-help.html.py:28
+msgid "How can I add a new device?"
+msgstr ""
+
+#: web/templates/online-help.html:12 web/templates/online-help.html.py:31
+msgid "How can I edit a device?"
+msgstr ""
+
+#: web/templates/online-help.html:16 web/templates/online-help.html.py:41
+msgid "How can I configure the synchronisation between devices?"
+msgstr ""
+
+#: web/templates/online-help.html:18 web/templates/online-help.html.py:42
+msgid "How can I start a synchronisation?"
+msgstr ""
+
+#: web/templates/online-help.html:19 web/templates/online-help.html.py:49
+msgid "How can I stop a synchronisation?"
+msgstr ""
+
+#: web/templates/online-help.html:22 web/templates/online-help.html.py:59
+msgid "How can I copy single subscriptions between devices?"
+msgstr ""
+
+#: web/templates/online-help.html:29
+msgid "Open the gPodder Podcast-Client on your PC or MAC."
+msgstr ""
+
+#: web/templates/online-help.html:30
+msgid ""
+"Upload your podcasts and if it's asked, enter your username and password. "
+"The server will create you a new device."
+msgstr ""
+
+#: web/templates/online-help.html:32 web/templates/online-help.html.py:50
+#: web/templates/online-help.html:60
+msgid "Click on your &quot;home&quot;-link."
+msgstr ""
+
+#: web/templates/online-help.html:33
+msgid "Now you can see your devices, click on one of them."
+msgstr ""
+
+#: web/templates/online-help.html:35
+msgid ""
+"You are redirected to another page.<br />On the bottom of the page there's a "
+"field named &quot;Edit&quot;"
+msgstr ""
+
+#: web/templates/online-help.html:37
+msgid ""
+"Here you can edit the name, the type and the uid. But pay attention if you "
+"edit the uid! If you enter a false one your subscriptions won't be "
+"synchronize with your device anymore."
+msgstr ""
+
+#: web/templates/online-help.html:43
+msgid "Choose a device on your home-screen and click on it."
+msgstr ""
+
+#: web/templates/online-help.html:45
+msgid ""
+"Go to the field &quot;Synchronize&quot;, choose your desired device and "
+"click on the &quot;OK&quot;-button."
+msgstr ""
+
+#: web/templates/online-help.html:47
+msgid "Now the two devices are synchronized."
+msgstr ""
+
+#: web/templates/online-help.html:51
+msgid ""
+"Choose a device on which you would like to stop the synchronisation and "
+"click on it."
+msgstr ""
+
+#: web/templates/online-help.html:53
+msgid ""
+"Go to the field &quot;Synchronize&quot; and click on &quot;Stop "
+"synchronisation for your device&quot;"
+msgstr ""
+
+#: web/templates/online-help.html:55
+msgid "Now the two devices are unsynchronized again."
+msgstr ""
+
+#: web/templates/online-help.html:61
+msgid ""
+"Choose the podcast which you would like to copy on another device and click "
+"on it."
+msgstr ""
+
+#: web/templates/online-help.html:63
+msgid ""
+"Under the field &quot;Devices&quot; you see the link &quot;Subscribe to ... "
+"on other devices&quot; click on it."
+msgstr ""
+
+#: web/templates/online-help.html:65
+msgid ""
+"On the next page you can choose your desired device on which you want to "
+"copy the subscription."
+msgstr ""
+
+#: web/templates/online-help.html:66
+msgid ""
+"After hitting the &quot;OK&quot;-button, the subscription has been copied."
+msgstr ""
+
 #: web/templates/podcast.html:7
 msgid "Unnamed Podcast"
 msgstr "Unbenannter Podcast"
@@ -371,36 +502,32 @@ msgstr "Abonniere %(podcasttitle)s"
 msgid "Subscribe to this podcast"
 msgstr "Abonniere diesen Podcast"
 
-#: web/templates/podcast.html:29 web/templates/podcast.html.py:79
-msgid "Devices"
-msgstr "Gerte"
-
 #: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr "Dieser Podcast wurde abonniert am"
 
-#: web/templates/podcast.html:41
+#: web/templates/podcast.html:45
 #, python-format
 msgid "Subscribe to %(podcasttitle)s on other devices"
 msgstr "Abonniere %(podcasttitle)s auf einem anderen Gert"
 
-#: web/templates/podcast.html:43
+#: web/templates/podcast.html:47
 msgid "Subscribe to this podcast on other devices"
 msgstr "Abonniere diesen Podcast auf einem anderen Gert"
 
-#: web/templates/podcast.html:52
+#: web/templates/podcast.html:56
 msgid "Episodes"
 msgstr "Episoden"
 
-#: web/templates/podcast.html:57
+#: web/templates/podcast.html:61
 msgid "Description"
 msgstr "Beschreibung"
 
-#: web/templates/podcast.html:58
+#: web/templates/podcast.html:62
 msgid "Released"
 msgstr "Verffentlicht"
 
-#: web/templates/podcast.html:99 web/templates/subscribe.html:24
+#: web/templates/podcast.html:103 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
 msgstr "Warum unbenannte Podcasts?"
 
@@ -527,11 +654,17 @@ msgstr "Logo"
 msgid "No Logo available"
 msgstr "Kein Logo verfgbar"
 
+#~ msgid "'s Home"
+#~ msgstr "'s Home"
+
+#~ msgid "Your settings"
+#~ msgstr "Konto-Einstellungen"
+
+#~ msgid "Podcast-Toplist"
+#~ msgstr "Podcast-Topliste"
+
 #~ msgid "subscribe"
 #~ msgstr "abonniert"
 
-#~ msgid "unsubscribe"
-#~ msgstr "beendet"
-
 #~ msgid "back!"
 #~ msgstr "zurck!"
diff --git a/mygpo/locale/en/LC_MESSAGES/django.po b/mygpo/locale/en/LC_MESSAGES/django.po
index 7ff7085..5525dd6 100644
--- a/mygpo/locale/en/LC_MESSAGES/django.po
+++ b/mygpo/locale/en/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 18:03+0100\n"
+"POT-Creation-Date: 2010-01-14 18:57+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -38,24 +38,24 @@ msgid "What kind of device is this?"
 msgstr ""
 
 #: web/forms.py:13
-msgid "What UID is configured on the pysical device?"
+msgid "What UID is configured on the physical device?"
 msgstr ""
 
-#: web/views.py:109
+#: web/views.py:111
 msgid "With which client do you want to subscribe?"
 msgstr ""
 
-#: web/views.py:174
+#: web/views.py:189
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr ""
 
-#: web/views.py:200
+#: web/views.py:215
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr ""
 
-#: web/views.py:214
+#: web/views.py:229
 msgid "Synchronize with the following devices"
 msgstr ""
 
@@ -97,7 +97,7 @@ msgstr ""
 msgid "Account Settings"
 msgstr ""
 
-#: web/templates/account.html:8 web/templates/device.html:50
+#: web/templates/account.html:8 web/templates/device.html:52
 msgid "Your settings have been saved."
 msgstr ""
 
@@ -105,8 +105,7 @@ msgstr ""
 msgid "Update the settings for your account"
 msgstr ""
 
-#: web/templates/authors.html:5 web/templates/base.html:81
-#: web/templates/base.html.py:93
+#: web/templates/authors.html:5 web/templates/base.html:100
 msgid "For podcast authors"
 msgstr ""
 
@@ -120,59 +119,74 @@ msgstr ""
 msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
 msgstr ""
 
-#: web/templates/base.html:67
-msgid "'s Home"
-msgstr ""
-
 #: web/templates/base.html:68
-msgid "Your settings"
+msgid "Subscriptions"
 msgstr ""
 
 #: web/templates/base.html:69
+msgid "History"
+msgstr ""
+
+#: web/templates/base.html:70 web/templates/podcast.html:29
+#: web/templates/podcast.html.py:83
+msgid "Devices"
+msgstr ""
+
+#: web/templates/base.html:71
+msgid "Settings"
+msgstr ""
+
+#: web/templates/base.html:72
 msgid "Logout"
 msgstr ""
 
-#: web/templates/base.html:73 web/templates/device.html:9
-msgid "Podcasts"
+#: web/templates/base.html:76 web/templates/base.html.py:91
+msgid "Discover"
 msgstr ""
 
-#: web/templates/base.html:74 web/templates/search/search.html:6
+#: web/templates/base.html:77 web/templates/base.html.py:92
+#: web/templates/search/search.html:6
 msgid "Search"
 msgstr ""
 
-#: web/templates/base.html:75 web/templates/toplist.html:5
+#: web/templates/base.html:78 web/templates/base.html.py:93
+#: web/templates/toplist.html:5
 msgid "Toplist"
 msgstr ""
 
-#: web/templates/base.html:76
+#: web/templates/base.html:79
 msgid "Suggestions"
 msgstr ""
 
-#: web/templates/base.html:77
-msgid "History"
+#: web/templates/base.html:85
+msgid "Home"
 msgstr ""
 
 #: web/templates/base.html:86
-msgid "Home"
+msgid "Login"
 msgstr ""
 
 #: web/templates/base.html:87
-msgid "Login"
+msgid "Register"
 msgstr ""
 
-#: web/templates/base.html:88
-msgid "Register"
+#: web/templates/base.html:98
+msgid "Documentation"
 msgstr ""
 
-#: web/templates/base.html:89
-msgid "Podcast-Toplist"
+#: web/templates/base.html:99 web/templates/online-help.html:5
+msgid "Online Help"
+msgstr ""
+
+#: web/templates/device.html:9
+msgid "Podcasts"
 msgstr ""
 
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
 msgstr ""
 
-#: web/templates/device.html:14 web/templates/podcast.html:56
+#: web/templates/device.html:14 web/templates/podcast.html:60
 msgid "Title"
 msgstr ""
 
@@ -180,33 +194,37 @@ msgstr ""
 msgid "Since"
 msgstr ""
 
-#: web/templates/device.html:27
+#: web/templates/device.html:16
+msgid "Unsubscribe"
+msgstr ""
+
+#: web/templates/device.html:29
 msgid "Synchronize"
 msgstr ""
 
-#: web/templates/device.html:28
+#: web/templates/device.html:30
 msgid ""
 "If you synchronize devices, they will always have the same subscriptions. A "
 "podcast that is subscribed on one device, will automatically be added to all "
 "synchronized devices."
 msgstr ""
 
-#: web/templates/device.html:32
+#: web/templates/device.html:34
 #, python-format
 msgid "%(devicename)s is currently not synchronized with other devices."
 msgstr ""
 
-#: web/templates/device.html:36
+#: web/templates/device.html:38
 #, python-format
 msgid "%(devicename)s is currently synchronized with %(synclist)s."
 msgstr ""
 
-#: web/templates/device.html:37
+#: web/templates/device.html:39
 #, python-format
 msgid "Stop synchronisation for %(devicename)s "
 msgstr ""
 
-#: web/templates/device.html:44 web/templates/subscribe.html:20
+#: web/templates/device.html:46 web/templates/subscribe.html:20
 msgid "OK"
 msgstr ""
 
@@ -237,7 +255,7 @@ msgstr ""
 msgid "Why Unnamed Episode?"
 msgstr ""
 
-#: web/templates/episode.html:41 web/templates/podcast.html:99
+#: web/templates/episode.html:41 web/templates/podcast.html:103
 #: web/templates/subscribe.html:24
 msgid ""
 "Because we display names after we have fetched the information form the feed "
@@ -245,7 +263,7 @@ msgid ""
 "simply be called this way."
 msgstr ""
 
-#: web/templates/history.html:7 web/templates/podcast.html:74
+#: web/templates/history.html:7 web/templates/podcast.html:78
 msgid "Subscription History"
 msgstr ""
 
@@ -254,11 +272,11 @@ msgstr ""
 msgid "Podcast"
 msgstr ""
 
-#: web/templates/history.html:13 web/templates/podcast.html:77
+#: web/templates/history.html:13 web/templates/podcast.html:81
 msgid "Timestamp"
 msgstr ""
 
-#: web/templates/history.html:14 web/templates/podcast.html:78
+#: web/templates/history.html:14 web/templates/podcast.html:82
 msgid "Action"
 msgstr ""
 
@@ -332,6 +350,119 @@ msgid ""
 "with your username."
 msgstr ""
 
+#: web/templates/online-help.html:9 web/templates/online-help.html.py:27
+msgid "How can I configure my devices?"
+msgstr ""
+
+#: web/templates/online-help.html:11 web/templates/online-help.html.py:28
+msgid "How can I add a new device?"
+msgstr ""
+
+#: web/templates/online-help.html:12 web/templates/online-help.html.py:31
+msgid "How can I edit a device?"
+msgstr ""
+
+#: web/templates/online-help.html:16 web/templates/online-help.html.py:41
+msgid "How can I configure the synchronisation between devices?"
+msgstr ""
+
+#: web/templates/online-help.html:18 web/templates/online-help.html.py:42
+msgid "How can I start a synchronisation?"
+msgstr ""
+
+#: web/templates/online-help.html:19 web/templates/online-help.html.py:49
+msgid "How can I stop a synchronisation?"
+msgstr ""
+
+#: web/templates/online-help.html:22 web/templates/online-help.html.py:59
+msgid "How can I copy single subscriptions between devices?"
+msgstr ""
+
+#: web/templates/online-help.html:29
+msgid "Open the gPodder Podcast-Client on your PC or MAC."
+msgstr ""
+
+#: web/templates/online-help.html:30
+msgid ""
+"Upload your podcasts and if it's asked, enter your username and password. "
+"The server will create you a new device."
+msgstr ""
+
+#: web/templates/online-help.html:32 web/templates/online-help.html.py:50
+#: web/templates/online-help.html:60
+msgid "Click on your &quot;home&quot;-link."
+msgstr ""
+
+#: web/templates/online-help.html:33
+msgid "Now you can see your devices, click on one of them."
+msgstr ""
+
+#: web/templates/online-help.html:35
+msgid ""
+"You are redirected to another page.<br />On the bottom of the page there's a "
+"field named &quot;Edit&quot;"
+msgstr ""
+
+#: web/templates/online-help.html:37
+msgid ""
+"Here you can edit the name, the type and the uid. But pay attention if you "
+"edit the uid! If you enter a false one your subscriptions won't be "
+"synchronize with your device anymore."
+msgstr ""
+
+#: web/templates/online-help.html:43
+msgid "Choose a device on your home-screen and click on it."
+msgstr ""
+
+#: web/templates/online-help.html:45
+msgid ""
+"Go to the field &quot;Synchronize&quot;, choose your desired device and "
+"click on the &quot;OK&quot;-button."
+msgstr ""
+
+#: web/templates/online-help.html:47
+msgid "Now the two devices are synchronized."
+msgstr ""
+
+#: web/templates/online-help.html:51
+msgid ""
+"Choose a device on which you would like to stop the synchronisation and "
+"click on it."
+msgstr ""
+
+#: web/templates/online-help.html:53
+msgid ""
+"Go to the field &quot;Synchronize&quot; and click on &quot;Stop "
+"synchronisation for your device&quot;"
+msgstr ""
+
+#: web/templates/online-help.html:55
+msgid "Now the two devices are unsynchronized again."
+msgstr ""
+
+#: web/templates/online-help.html:61
+msgid ""
+"Choose the podcast which you would like to copy on another device and click "
+"on it."
+msgstr ""
+
+#: web/templates/online-help.html:63
+msgid ""
+"Under the field &quot;Devices&quot; you see the link &quot;Subscribe to ... "
+"on other devices&quot; click on it."
+msgstr ""
+
+#: web/templates/online-help.html:65
+msgid ""
+"On the next page you can choose your desired device on which you want to "
+"copy the subscription."
+msgstr ""
+
+#: web/templates/online-help.html:66
+msgid ""
+"After hitting the &quot;OK&quot;-button, the subscription has been copied."
+msgstr ""
+
 #: web/templates/podcast.html:7
 msgid "Unnamed Podcast"
 msgstr ""
@@ -345,36 +476,32 @@ msgstr ""
 msgid "Subscribe to this podcast"
 msgstr ""
 
-#: web/templates/podcast.html:29 web/templates/podcast.html.py:79
-msgid "Devices"
-msgstr ""
-
 #: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr ""
 
-#: web/templates/podcast.html:41
+#: web/templates/podcast.html:45
 #, python-format
 msgid "Subscribe to %(podcasttitle)s on other devices"
 msgstr ""
 
-#: web/templates/podcast.html:43
+#: web/templates/podcast.html:47
 msgid "Subscribe to this podcast on other devices"
 msgstr ""
 
-#: web/templates/podcast.html:52
+#: web/templates/podcast.html:56
 msgid "Episodes"
 msgstr ""
 
-#: web/templates/podcast.html:57
+#: web/templates/podcast.html:61
 msgid "Description"
 msgstr ""
 
-#: web/templates/podcast.html:58
+#: web/templates/podcast.html:62
 msgid "Released"
 msgstr ""
 
-#: web/templates/podcast.html:99 web/templates/subscribe.html:24
+#: web/templates/podcast.html:103 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
 msgstr ""
 
diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
index 174abe6..28222b7 100644
--- a/mygpo/locale/it/LC_MESSAGES/django.po
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 18:03+0100\n"
+"POT-Creation-Date: 2010-01-14 18:57+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -38,24 +38,24 @@ msgid "What kind of device is this?"
 msgstr "Che genere di dispositivo  questo?"
 
 #: web/forms.py:13
-msgid "What UID is configured on the pysical device?"
+msgid "What UID is configured on the physical device?"
 msgstr ""
 
-#: web/views.py:109
+#: web/views.py:111
 msgid "With which client do you want to subscribe?"
 msgstr ""
 
-#: web/views.py:174
+#: web/views.py:189
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr "my.gpodder.org - Top %s"
 
-#: web/views.py:200
+#: web/views.py:215
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr "my.gpodder.org - %s suggerimenti"
 
-#: web/views.py:214
+#: web/views.py:229
 msgid "Synchronize with the following devices"
 msgstr ""
 
@@ -97,7 +97,7 @@ msgstr ""
 msgid "Account Settings"
 msgstr "Regolazioni di cliente"
 
-#: web/templates/account.html:8 web/templates/device.html:50
+#: web/templates/account.html:8 web/templates/device.html:52
 msgid "Your settings have been saved."
 msgstr ""
 
@@ -105,8 +105,7 @@ msgstr ""
 msgid "Update the settings for your account"
 msgstr ""
 
-#: web/templates/authors.html:5 web/templates/base.html:81
-#: web/templates/base.html.py:93
+#: web/templates/authors.html:5 web/templates/base.html:100
 msgid "For podcast authors"
 msgstr "Per gli autori dei podcasts"
 
@@ -120,61 +119,75 @@ msgstr ""
 msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
 msgstr ""
 
-#: web/templates/base.html:67
-msgid "'s Home"
+#: web/templates/base.html:68
+msgid "Subscriptions"
 msgstr ""
 
-#: web/templates/base.html:68
+#: web/templates/base.html:69
+msgid "History"
+msgstr ""
+
+#: web/templates/base.html:70 web/templates/podcast.html:29
+#: web/templates/podcast.html.py:83
+msgid "Devices"
+msgstr "Dispositivo"
+
+#: web/templates/base.html:71
 #, fuzzy
-msgid "Your settings"
+msgid "Settings"
 msgstr "Regolazioni di cliente"
 
-#: web/templates/base.html:69
+#: web/templates/base.html:72
 msgid "Logout"
 msgstr ""
 
-#: web/templates/base.html:73 web/templates/device.html:9
-msgid "Podcasts"
-msgstr "Podcasts"
+#: web/templates/base.html:76 web/templates/base.html.py:91
+msgid "Discover"
+msgstr ""
 
-#: web/templates/base.html:74 web/templates/search/search.html:6
+#: web/templates/base.html:77 web/templates/base.html.py:92
+#: web/templates/search/search.html:6
 msgid "Search"
 msgstr ""
 
-#: web/templates/base.html:75 web/templates/toplist.html:5
+#: web/templates/base.html:78 web/templates/base.html.py:93
+#: web/templates/toplist.html:5
 msgid "Toplist"
 msgstr ""
 
-#: web/templates/base.html:76
+#: web/templates/base.html:79
 msgid "Suggestions"
 msgstr ""
 
-#: web/templates/base.html:77
-msgid "History"
+#: web/templates/base.html:85
+msgid "Home"
 msgstr ""
 
 #: web/templates/base.html:86
-msgid "Home"
+msgid "Login"
 msgstr ""
 
 #: web/templates/base.html:87
-msgid "Login"
+msgid "Register"
 msgstr ""
 
-#: web/templates/base.html:88
-msgid "Register"
+#: web/templates/base.html:98
+msgid "Documentation"
 msgstr ""
 
-#: web/templates/base.html:89
-#, fuzzy
-msgid "Podcast-Toplist"
+#: web/templates/base.html:99 web/templates/online-help.html:5
+msgid "Online Help"
+msgstr ""
+
+#: web/templates/device.html:9
+msgid "Podcasts"
 msgstr "Podcasts"
 
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
 msgstr ""
 
-#: web/templates/device.html:14 web/templates/podcast.html:56
+#: web/templates/device.html:14 web/templates/podcast.html:60
 msgid "Title"
 msgstr "Titolo"
 
@@ -182,33 +195,38 @@ msgstr "Titolo"
 msgid "Since"
 msgstr "da"
 
-#: web/templates/device.html:27
+#: web/templates/device.html:16
+#, fuzzy
+msgid "Unsubscribe"
+msgstr "disdica"
+
+#: web/templates/device.html:29
 msgid "Synchronize"
 msgstr "Sincronizzi"
 
-#: web/templates/device.html:28
+#: web/templates/device.html:30
 msgid ""
 "If you synchronize devices, they will always have the same subscriptions. A "
 "podcast that is subscribed on one device, will automatically be added to all "
 "synchronized devices."
 msgstr ""
 
-#: web/templates/device.html:32
+#: web/templates/device.html:34
 #, python-format
 msgid "%(devicename)s is currently not synchronized with other devices."
 msgstr ""
 
-#: web/templates/device.html:36
+#: web/templates/device.html:38
 #, python-format
 msgid "%(devicename)s is currently synchronized with %(synclist)s."
 msgstr ""
 
-#: web/templates/device.html:37
+#: web/templates/device.html:39
 #, python-format
 msgid "Stop synchronisation for %(devicename)s "
 msgstr ""
 
-#: web/templates/device.html:44 web/templates/subscribe.html:20
+#: web/templates/device.html:46 web/templates/subscribe.html:20
 msgid "OK"
 msgstr "OK"
 
@@ -239,7 +257,7 @@ msgstr "Dove"
 msgid "Why Unnamed Episode?"
 msgstr ""
 
-#: web/templates/episode.html:41 web/templates/podcast.html:99
+#: web/templates/episode.html:41 web/templates/podcast.html:103
 #: web/templates/subscribe.html:24
 msgid ""
 "Because we display names after we have fetched the information form the feed "
@@ -247,7 +265,7 @@ msgid ""
 "simply be called this way."
 msgstr ""
 
-#: web/templates/history.html:7 web/templates/podcast.html:74
+#: web/templates/history.html:7 web/templates/podcast.html:78
 msgid "Subscription History"
 msgstr ""
 
@@ -256,11 +274,11 @@ msgstr ""
 msgid "Podcast"
 msgstr ""
 
-#: web/templates/history.html:13 web/templates/podcast.html:77
+#: web/templates/history.html:13 web/templates/podcast.html:81
 msgid "Timestamp"
 msgstr "Data"
 
-#: web/templates/history.html:14 web/templates/podcast.html:78
+#: web/templates/history.html:14 web/templates/podcast.html:82
 msgid "Action"
 msgstr "Azione"
 
@@ -335,6 +353,119 @@ msgid ""
 "with your username."
 msgstr ""
 
+#: web/templates/online-help.html:9 web/templates/online-help.html.py:27
+msgid "How can I configure my devices?"
+msgstr ""
+
+#: web/templates/online-help.html:11 web/templates/online-help.html.py:28
+msgid "How can I add a new device?"
+msgstr ""
+
+#: web/templates/online-help.html:12 web/templates/online-help.html.py:31
+msgid "How can I edit a device?"
+msgstr ""
+
+#: web/templates/online-help.html:16 web/templates/online-help.html.py:41
+msgid "How can I configure the synchronisation between devices?"
+msgstr ""
+
+#: web/templates/online-help.html:18 web/templates/online-help.html.py:42
+msgid "How can I start a synchronisation?"
+msgstr ""
+
+#: web/templates/online-help.html:19 web/templates/online-help.html.py:49
+msgid "How can I stop a synchronisation?"
+msgstr ""
+
+#: web/templates/online-help.html:22 web/templates/online-help.html.py:59
+msgid "How can I copy single subscriptions between devices?"
+msgstr ""
+
+#: web/templates/online-help.html:29
+msgid "Open the gPodder Podcast-Client on your PC or MAC."
+msgstr ""
+
+#: web/templates/online-help.html:30
+msgid ""
+"Upload your podcasts and if it's asked, enter your username and password. "
+"The server will create you a new device."
+msgstr ""
+
+#: web/templates/online-help.html:32 web/templates/online-help.html.py:50
+#: web/templates/online-help.html:60
+msgid "Click on your &quot;home&quot;-link."
+msgstr ""
+
+#: web/templates/online-help.html:33
+msgid "Now you can see your devices, click on one of them."
+msgstr ""
+
+#: web/templates/online-help.html:35
+msgid ""
+"You are redirected to another page.<br />On the bottom of the page there's a "
+"field named &quot;Edit&quot;"
+msgstr ""
+
+#: web/templates/online-help.html:37
+msgid ""
+"Here you can edit the name, the type and the uid. But pay attention if you "
+"edit the uid! If you enter a false one your subscriptions won't be "
+"synchronize with your device anymore."
+msgstr ""
+
+#: web/templates/online-help.html:43
+msgid "Choose a device on your home-screen and click on it."
+msgstr ""
+
+#: web/templates/online-help.html:45
+msgid ""
+"Go to the field &quot;Synchronize&quot;, choose your desired device and "
+"click on the &quot;OK&quot;-button."
+msgstr ""
+
+#: web/templates/online-help.html:47
+msgid "Now the two devices are synchronized."
+msgstr ""
+
+#: web/templates/online-help.html:51
+msgid ""
+"Choose a device on which you would like to stop the synchronisation and "
+"click on it."
+msgstr ""
+
+#: web/templates/online-help.html:53
+msgid ""
+"Go to the field &quot;Synchronize&quot; and click on &quot;Stop "
+"synchronisation for your device&quot;"
+msgstr ""
+
+#: web/templates/online-help.html:55
+msgid "Now the two devices are unsynchronized again."
+msgstr ""
+
+#: web/templates/online-help.html:61
+msgid ""
+"Choose the podcast which you would like to copy on another device and click "
+"on it."
+msgstr ""
+
+#: web/templates/online-help.html:63
+msgid ""
+"Under the field &quot;Devices&quot; you see the link &quot;Subscribe to ... "
+"on other devices&quot; click on it."
+msgstr ""
+
+#: web/templates/online-help.html:65
+msgid ""
+"On the next page you can choose your desired device on which you want to "
+"copy the subscription."
+msgstr ""
+
+#: web/templates/online-help.html:66
+msgid ""
+"After hitting the &quot;OK&quot;-button, the subscription has been copied."
+msgstr ""
+
 #: web/templates/podcast.html:7
 msgid "Unnamed Podcast"
 msgstr ""
@@ -348,36 +479,32 @@ msgstr ""
 msgid "Subscribe to this podcast"
 msgstr ""
 
-#: web/templates/podcast.html:29 web/templates/podcast.html.py:79
-msgid "Devices"
-msgstr "Dispositivo"
-
 #: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr ""
 
-#: web/templates/podcast.html:41
+#: web/templates/podcast.html:45
 #, python-format
 msgid "Subscribe to %(podcasttitle)s on other devices"
 msgstr ""
 
-#: web/templates/podcast.html:43
+#: web/templates/podcast.html:47
 msgid "Subscribe to this podcast on other devices"
 msgstr ""
 
-#: web/templates/podcast.html:52
+#: web/templates/podcast.html:56
 msgid "Episodes"
 msgstr ""
 
-#: web/templates/podcast.html:57
+#: web/templates/podcast.html:61
 msgid "Description"
 msgstr ""
 
-#: web/templates/podcast.html:58
+#: web/templates/podcast.html:62
 msgid "Released"
 msgstr ""
 
-#: web/templates/podcast.html:99 web/templates/subscribe.html:24
+#: web/templates/podcast.html:103 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
 msgstr ""
 
@@ -503,8 +630,13 @@ msgstr ""
 msgid "No Logo available"
 msgstr ""
 
+#, fuzzy
+#~ msgid "Your settings"
+#~ msgstr "Regolazioni di cliente"
+
+#, fuzzy
+#~ msgid "Podcast-Toplist"
+#~ msgstr "Podcasts"
+
 #~ msgid "subscribe"
 #~ msgstr "abboni"
-
-#~ msgid "unsubscribe"
-#~ msgstr "disdica"
diff --git a/mygpo/locale/nb/LC_MESSAGES/django.po b/mygpo/locale/nb/LC_MESSAGES/django.po
index 93fe327..64aa069 100644
--- a/mygpo/locale/nb/LC_MESSAGES/django.po
+++ b/mygpo/locale/nb/LC_MESSAGES/django.po
@@ -6,7 +6,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: 2.1\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-14 18:03+0100\n"
+"POT-Creation-Date: 2010-01-14 18:57+0100\n"
 "PO-Revision-Date: 2010-01-06 11:48+0100\n"
 "Last-Translator: Jim Nygrd <jim@nygard.priv.no>\n"
 "Language-Team: gpodder <>\n"
@@ -39,24 +39,25 @@ msgid "What kind of device is this?"
 msgstr "Hva slags enhet er dette?"
 
 #: web/forms.py:13
-msgid "What UID is configured on the pysical device?"
+#, fuzzy
+msgid "What UID is configured on the physical device?"
 msgstr "Hvilken UID er konfigurert p den fysiske enheten?"
 
-#: web/views.py:109
+#: web/views.py:111
 msgid "With which client do you want to subscribe?"
 msgstr "Med hvilken klient vil du abonnere?"
 
-#: web/views.py:174
+#: web/views.py:189
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr "my.gpodder.org - Topp %s"
 
-#: web/views.py:200
+#: web/views.py:215
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr "my.gpodder.org - %s Forslag"
 
-#: web/views.py:214
+#: web/views.py:229
 msgid "Synchronize with the following devices"
 msgstr "Synkroniser med disse enhetene"
 
@@ -98,7 +99,7 @@ msgstr ""
 msgid "Account Settings"
 msgstr "Kontoinnstillinger"
 
-#: web/templates/account.html:8 web/templates/device.html:50
+#: web/templates/account.html:8 web/templates/device.html:52
 msgid "Your settings have been saved."
 msgstr "Dine innstillinger er lagret."
 
@@ -106,8 +107,7 @@ msgstr "Dine innstillinger er lagret."
 msgid "Update the settings for your account"
 msgstr "Oppdater innstillingene for kontoen din"
 
-#: web/templates/authors.html:5 web/templates/base.html:81
-#: web/templates/base.html.py:93
+#: web/templates/authors.html:5 web/templates/base.html:100
 msgid "For podcast authors"
 msgstr ""
 
@@ -121,65 +121,80 @@ msgstr ""
 msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
 msgstr ""
 
-#: web/templates/base.html:67
-msgid "'s Home"
+#: web/templates/base.html:68
+#, fuzzy
+msgid "Subscriptions"
+msgstr "Dine Abonnement"
+
+#: web/templates/base.html:69
+msgid "History"
 msgstr ""
 
-#: web/templates/base.html:68
+#: web/templates/base.html:70 web/templates/podcast.html:29
+#: web/templates/podcast.html.py:83
+msgid "Devices"
+msgstr "Enheter"
+
+#: web/templates/base.html:71
 #, fuzzy
-msgid "Your settings"
+msgid "Settings"
 msgstr "Kontoinnstillinger"
 
-#: web/templates/base.html:69
+#: web/templates/base.html:72
 #, fuzzy
 msgid "Logout"
 msgstr "Logo"
 
-#: web/templates/base.html:73 web/templates/device.html:9
-msgid "Podcasts"
-msgstr "Podcaster"
+#: web/templates/base.html:76 web/templates/base.html.py:91
+msgid "Discover"
+msgstr ""
 
-#: web/templates/base.html:74 web/templates/search/search.html:6
+#: web/templates/base.html:77 web/templates/base.html.py:92
+#: web/templates/search/search.html:6
 msgid "Search"
 msgstr "Sk"
 
-#: web/templates/base.html:75 web/templates/toplist.html:5
+#: web/templates/base.html:78 web/templates/base.html.py:93
+#: web/templates/toplist.html:5
 msgid "Toplist"
 msgstr "Toppliste"
 
-#: web/templates/base.html:76
+#: web/templates/base.html:79
 #, fuzzy
 msgid "Suggestions"
 msgstr "Podcastforslag"
 
-#: web/templates/base.html:77
-msgid "History"
-msgstr ""
-
-#: web/templates/base.html:86
+#: web/templates/base.html:85
 msgid "Home"
 msgstr ""
 
-#: web/templates/base.html:87
+#: web/templates/base.html:86
 #, fuzzy
 msgid "Login"
 msgstr "Logo"
 
-#: web/templates/base.html:88
+#: web/templates/base.html:87
 #, fuzzy
 msgid "Register"
 msgstr "Registrer!"
 
-#: web/templates/base.html:89
-#, fuzzy
-msgid "Podcast-Toplist"
+#: web/templates/base.html:98
+msgid "Documentation"
+msgstr ""
+
+#: web/templates/base.html:99 web/templates/online-help.html:5
+msgid "Online Help"
+msgstr ""
+
+#: web/templates/device.html:9
+msgid "Podcasts"
 msgstr "Podcaster"
 
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
 msgstr "Du abonnerer p flgende podcaster p denne enheten"
 
-#: web/templates/device.html:14 web/templates/podcast.html:56
+#: web/templates/device.html:14 web/templates/podcast.html:60
 msgid "Title"
 msgstr "Tittel"
 
@@ -187,11 +202,16 @@ msgstr "Tittel"
 msgid "Since"
 msgstr "Siden"
 
-#: web/templates/device.html:27
+#: web/templates/device.html:16
+#, fuzzy
+msgid "Unsubscribe"
+msgstr "avslutt abonnement"
+
+#: web/templates/device.html:29
 msgid "Synchronize"
 msgstr "Synkroniser"
 
-#: web/templates/device.html:28
+#: web/templates/device.html:30
 msgid ""
 "If you synchronize devices, they will always have the same subscriptions. A "
 "podcast that is subscribed on one device, will automatically be added to all "
@@ -201,22 +221,22 @@ msgstr ""
 "podcast som blir lagt til p en enhet vil automatisk bli lagt til p alle "
 "synkroniserte enheter."
 
-#: web/templates/device.html:32
+#: web/templates/device.html:34
 #, python-format
 msgid "%(devicename)s is currently not synchronized with other devices."
 msgstr "%(devicename)s er for yeblikket ikke synkronisert med andre enheter."
 
-#: web/templates/device.html:36
+#: web/templates/device.html:38
 #, python-format
 msgid "%(devicename)s is currently synchronized with %(synclist)s."
 msgstr "%(devicename)s er for yeblikket synkronisert med %(synclist)s."
 
-#: web/templates/device.html:37
+#: web/templates/device.html:39
 #, python-format
 msgid "Stop synchronisation for %(devicename)s "
 msgstr "Stopp synkroniserine av %(devicename)s "
 
-#: web/templates/device.html:44 web/templates/subscribe.html:20
+#: web/templates/device.html:46 web/templates/subscribe.html:20
 msgid "OK"
 msgstr "OK"
 
@@ -248,7 +268,7 @@ msgstr "Hvor"
 msgid "Why Unnamed Episode?"
 msgstr "Episoden uten navn?"
 
-#: web/templates/episode.html:41 web/templates/podcast.html:99
+#: web/templates/episode.html:41 web/templates/podcast.html:103
 #: web/templates/subscribe.html:24
 msgid ""
 "Because we display names after we have fetched the information form the feed "
@@ -258,7 +278,7 @@ msgstr ""
 "Fordi vi viser navnene etter  ha hentet informasjonen i strmmen, dette kan "
 "ta litt tid. I mellomtiden vil podcasten vises uten navn."
 
-#: web/templates/history.html:7 web/templates/podcast.html:74
+#: web/templates/history.html:7 web/templates/podcast.html:78
 msgid "Subscription History"
 msgstr "Abonnementshistorikk"
 
@@ -267,11 +287,11 @@ msgstr "Abonnementshistorikk"
 msgid "Podcast"
 msgstr "Podcast"
 
-#: web/templates/history.html:13 web/templates/podcast.html:77
+#: web/templates/history.html:13 web/templates/podcast.html:81
 msgid "Timestamp"
 msgstr "Tidspunkt"
 
-#: web/templates/history.html:14 web/templates/podcast.html:78
+#: web/templates/history.html:14 web/templates/podcast.html:82
 msgid "Action"
 msgstr "Handling"
 
@@ -358,6 +378,120 @@ msgstr ""
 "(med mange nye funksjoner) er tilgjeng m du bytte ut e-postadressen med "
 "brukernavnet ditt."
 
+#: web/templates/online-help.html:9 web/templates/online-help.html.py:27
+#, fuzzy
+msgid "How can I configure my devices?"
+msgstr "Hvilken UID er konfigurert p den fysiske enheten?"
+
+#: web/templates/online-help.html:11 web/templates/online-help.html.py:28
+msgid "How can I add a new device?"
+msgstr ""
+
+#: web/templates/online-help.html:12 web/templates/online-help.html.py:31
+msgid "How can I edit a device?"
+msgstr ""
+
+#: web/templates/online-help.html:16 web/templates/online-help.html.py:41
+msgid "How can I configure the synchronisation between devices?"
+msgstr ""
+
+#: web/templates/online-help.html:18 web/templates/online-help.html.py:42
+msgid "How can I start a synchronisation?"
+msgstr ""
+
+#: web/templates/online-help.html:19 web/templates/online-help.html.py:49
+msgid "How can I stop a synchronisation?"
+msgstr ""
+
+#: web/templates/online-help.html:22 web/templates/online-help.html.py:59
+msgid "How can I copy single subscriptions between devices?"
+msgstr ""
+
+#: web/templates/online-help.html:29
+msgid "Open the gPodder Podcast-Client on your PC or MAC."
+msgstr ""
+
+#: web/templates/online-help.html:30
+msgid ""
+"Upload your podcasts and if it's asked, enter your username and password. "
+"The server will create you a new device."
+msgstr ""
+
+#: web/templates/online-help.html:32 web/templates/online-help.html.py:50
+#: web/templates/online-help.html:60
+msgid "Click on your &quot;home&quot;-link."
+msgstr ""
+
+#: web/templates/online-help.html:33
+msgid "Now you can see your devices, click on one of them."
+msgstr ""
+
+#: web/templates/online-help.html:35
+msgid ""
+"You are redirected to another page.<br />On the bottom of the page there's a "
+"field named &quot;Edit&quot;"
+msgstr ""
+
+#: web/templates/online-help.html:37
+msgid ""
+"Here you can edit the name, the type and the uid. But pay attention if you "
+"edit the uid! If you enter a false one your subscriptions won't be "
+"synchronize with your device anymore."
+msgstr ""
+
+#: web/templates/online-help.html:43
+msgid "Choose a device on your home-screen and click on it."
+msgstr ""
+
+#: web/templates/online-help.html:45
+msgid ""
+"Go to the field &quot;Synchronize&quot;, choose your desired device and "
+"click on the &quot;OK&quot;-button."
+msgstr ""
+
+#: web/templates/online-help.html:47
+msgid "Now the two devices are synchronized."
+msgstr ""
+
+#: web/templates/online-help.html:51
+msgid ""
+"Choose a device on which you would like to stop the synchronisation and "
+"click on it."
+msgstr ""
+
+#: web/templates/online-help.html:53
+msgid ""
+"Go to the field &quot;Synchronize&quot; and click on &quot;Stop "
+"synchronisation for your device&quot;"
+msgstr ""
+
+#: web/templates/online-help.html:55
+msgid "Now the two devices are unsynchronized again."
+msgstr ""
+
+#: web/templates/online-help.html:61
+msgid ""
+"Choose the podcast which you would like to copy on another device and click "
+"on it."
+msgstr ""
+
+#: web/templates/online-help.html:63
+msgid ""
+"Under the field &quot;Devices&quot; you see the link &quot;Subscribe to ... "
+"on other devices&quot; click on it."
+msgstr ""
+
+#: web/templates/online-help.html:65
+msgid ""
+"On the next page you can choose your desired device on which you want to "
+"copy the subscription."
+msgstr ""
+
+#: web/templates/online-help.html:66
+msgid ""
+"After hitting the &quot;OK&quot;-button, the subscription has been copied."
+msgstr ""
+
 #: web/templates/podcast.html:7
 msgid "Unnamed Podcast"
 msgstr "Podcast uten navn"
@@ -371,37 +505,33 @@ msgstr "Abonner p %(podcasttitle)s"
 msgid "Subscribe to this podcast"
 msgstr "Abonner p denne podcasten"
 
-#: web/templates/podcast.html:29 web/templates/podcast.html.py:79
-msgid "Devices"
-msgstr "Enheter"
-
 #: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr "Du abonnerer p denne podcasten p"
 
-#: web/templates/podcast.html:41
+#: web/templates/podcast.html:45
 #, fuzzy, python-format
 msgid "Subscribe to %(podcasttitle)s on other devices"
 msgstr "Abonner p %(podcasttitle)s"
 
-#: web/templates/podcast.html:43
+#: web/templates/podcast.html:47
 #, fuzzy
 msgid "Subscribe to this podcast on other devices"
 msgstr "Abonner p denne podcasten"
 
-#: web/templates/podcast.html:52
+#: web/templates/podcast.html:56
 msgid "Episodes"
 msgstr "Episoder"
 
-#: web/templates/podcast.html:57
+#: web/templates/podcast.html:61
 msgid "Description"
 msgstr "Beskrivelse"
 
-#: web/templates/podcast.html:58
+#: web/templates/podcast.html:62
 msgid "Released"
 msgstr "Utgitt"
 
-#: web/templates/podcast.html:99 web/templates/subscribe.html:24
+#: web/templates/podcast.html:103 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
 msgstr "Podcast uten navn?"
 
@@ -527,11 +657,16 @@ msgstr "Logo"
 msgid "No Logo available"
 msgstr "Ingen logo tilgjengelig"
 
+#, fuzzy
+#~ msgid "Your settings"
+#~ msgstr "Kontoinnstillinger"
+
+#, fuzzy
+#~ msgid "Podcast-Toplist"
+#~ msgstr "Podcaster"
+
 #~ msgid "subscribe"
 #~ msgstr "abonner"
 
-#~ msgid "unsubscribe"
-#~ msgstr "avslutt abonnement"
-
 #~ msgid "back!"
 #~ msgstr "zurck!"

commit d87dcfd647adb9cb447732cf7a266148734856cb
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Jan 14 19:03:46 2010 +0100

    online-help edited

diff --git a/mygpo/web/templates/online-help.html b/mygpo/web/templates/online-help.html
index 0dcd87f..63ae074 100644
--- a/mygpo/web/templates/online-help.html
+++ b/mygpo/web/templates/online-help.html
@@ -26,10 +26,10 @@
   <div class="ohelp">
    <h2 id="1" class="ohelp">{% trans "How can I configure my devices?" %}</h2>
    <h3 id="1.1">{% trans "How can I add a new device?" %}</h3>
-   <p>{% trans "Open the gPodder Podcast-Client on your PC or MAC." %}</p>
+   <p>{% trans "Open the &quot;gPodder Podcast-Client&quot; on your PC or MAC." %}</p>
    <p>{% trans "Upload your podcasts and if it's asked, enter your username and password. The server will create you a new device." %}</p>
    <h3 id="1.2">{% trans "How can I edit a device?" %}</h3>
-   <p>{% trans "Click on your &quot;home&quot;-link." %}<br />
+   <p>{% trans "Click on your &quot;Subscriptions&quot;-link." %}<br />
    {% trans "Now you can see your devices, click on one of them." %}</p>
    <p><img src="/media/online-help/userhome.png" class="ohelp" /></p>
    <p>{% trans "You are redirected to another page.<br />On the bottom of the page there's a field named &quot;Edit&quot;" %}</p>
@@ -40,14 +40,14 @@
   <div class="ohelp">
    <h2 id="2" class="ohelp">{% trans "How can I configure the synchronisation between devices?" %}</h2>
    <h3 id="2.1">{% trans "How can I start a synchronisation?" %}</h3>
-   <p>{% trans "Choose a device on your home-screen and click on it." %}</p>
+   <p>{% trans "Choose a device on your &quot;Subscriptions-screen&quot; and click on it." %}</p>
    <p><img src="/media/online-help/userhome.png" class="ohelp" /></p>
-   <p>{% trans "Go to the field &quot;Synchronize&quot, choose your desired device and click on the &quot;OK&quot;-button." %}</p>
+   <p>{% trans "Go to the field &quot;Synchronize&quot;, choose your desired device and click on the &quot;OK&quot;-button." %}</p>
    <p><img src="/media/online-help/startsync.png" class="ohelp" /></p>
    <p>{% trans "Now the two devices are synchronized." %}</p>
    
    <h3 id="2.2">{% trans "How can I stop a synchronisation?" %}</h3>
-   <p>{% trans "Click on your &quot;home&quot;-link." %}<br />
+   <p>{% trans "Click on your &quot;Subscriptions&quot;-link." %}<br />
    {% trans "Choose a device on which you would like to stop the synchronisation and click on it." %}</p>
    <p><img src="/media/online-help/userhomesync.png" class="ohelp" /></p>
    <p>{% trans "Go to the field &quot;Synchronize&quot; and click on &quot;Stop synchronisation for your device&quot;" %}</p>
@@ -57,7 +57,7 @@
   
   <div class="ohelp">
    <h2 id="3" class="ohelp">{% trans "How can I copy single subscriptions between devices?" %}</h2>
-   <p>{% trans "Click on your &quot;home&quot;-link." %}<br />
+   <p>{% trans "Click on your &quot;Subscriptions&quot;-link." %}<br />
    {% trans "Choose the podcast which you would like to copy on another device and click on it." %}</p>
    <p><img src="/media/online-help/userhomesingle.png" class="ohelp" /></p>
    <p>{% trans "Under the field &quot;Devices&quot; you see the link &quot;Subscribe to ... on other devices&quot; click on it." %}</p>

commit 86cd32e977f7a49a68b296044e79d8d0aa01fb90
Merge: 317f300... d23927d...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 18:57:18 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/armin/mygpo-src

commit 317f300d134734460c7820e7e6e05e7fb5df4ed0
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:55:11 2010 +0100

    Add documentation for logged in users

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index b7b26e1..65f4ad8 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -91,13 +91,13 @@
      <li><a href="/search/">{% trans "Search" %}</a></li>
      <li><a href="/toplist/">{% trans "Toplist" %}</a></li>
     </ul>
+   {% endif %}
     
     <ul class="menu">
      <li class="heading"><strong>{% trans "Documentation" %}</strong></li>
      <li><a href="/online-help/">{% trans "Online Help" %}</a></li>
      <li><a href="/authors/">{% trans "For podcast authors" %}</a></li>
     </ul>
-   {% endif %}
 
   </div>
 

commit cc0f18e886162ba75933e13facccf1dc83ccf559
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:54:29 2010 +0100

    Make documentation section available

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index abb8458..b7b26e1 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -78,12 +78,6 @@
      <li><a href="/suggestions/">{% trans "Suggestions" %}</a></li>
     </ul>
     
-    <ul class="menu">
-     <li class="heading"><strong>{% trans "Documentation" %}</strong></li>
-     <li><a href="/online-help/">{% trans "Online Help" %}</a></li>
-     <li><a href="/authors/">{% trans "For podcast authors" %}</a></li>
-    </ul>
-    
    {% else %}
     <ul class="menu">
      <li class="heading"><strong>my.gpodder.org</strong></li>
@@ -99,6 +93,8 @@
     </ul>
     
     <ul class="menu">
+     <li class="heading"><strong>{% trans "Documentation" %}</strong></li>
+     <li><a href="/online-help/">{% trans "Online Help" %}</a></li>
      <li><a href="/authors/">{% trans "For podcast authors" %}</a></li>
     </ul>
    {% endif %}

commit d23927de35f9203fc2916aea05f54dcda2e09069
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Thu Jan 14 18:53:02 2010 +0100

    added new menu item

diff --git a/mygpo/web/forms.py b/mygpo/web/forms.py
index c886027..6ef2244 100644
--- a/mygpo/web/forms.py
+++ b/mygpo/web/forms.py
@@ -10,7 +10,7 @@ class UserAccountForm(forms.Form):
 class DeviceForm(forms.Form):
     name = forms.CharField(max_length=100, label=_('Name of this device'))
     type = forms.ChoiceField(choices=DEVICE_TYPES, label=_('What kind of device is this?'))
-    uid = forms.CharField(max_length=50, label=_('What UID is configured on the pysical device?'))
+    uid = forms.CharField(max_length=50, label=_('What UID is configured on the physical device?'))
 
 
 class SyncForm(forms.Form):
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 0fe0323..789cb7d 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -67,6 +67,7 @@
      <li class="heading"><strong>{{ user.username }}</strong></li>
      <li><a href="/">{% trans "Subscriptions" %}</a></li>
      <li><a href="/history/">{% trans "History" %}</a></li>
+     <li><a href="/devices/">{% trans "Devices" %}</a></li>
      <li><a href="/account/">{% trans "Settings" %}</a></li>
      <li><a href="/logout/">{% trans "Logout" %}</a></li>
     </ul>

commit 9ea9572caa8f6ce440e2dbbe5858f0d22f2646fa
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:52:18 2010 +0100

    Fix menu for non-logged-in users

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 0fe0323..abb8458 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -92,7 +92,7 @@
      <li><a href="/register/">{% trans "Register" %}</a></li>
     </ul>
 
-    <ul>
+    <ul class="menu">
      <li class="heading"><strong>{% trans "Discover" %}</strong></li>
      <li><a href="/search/">{% trans "Search" %}</a></li>
      <li><a href="/toplist/">{% trans "Toplist" %}</a></li>

commit f643c49008d5bde5ddcd863e3b175994d71645c4
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:47:08 2010 +0100

    Style fixes (nonbreaking spaces)

diff --git a/mygpo/web/templates/history.html b/mygpo/web/templates/history.html
index b63f2a1..2756ffa 100644
--- a/mygpo/web/templates/history.html
+++ b/mygpo/web/templates/history.html
@@ -26,7 +26,7 @@
         <img src="/media/unsubscribe.png" />
        {% endifequal %}
       </td>
-      <td><a href="/device/{{ s.device.id }}">{{ s.device|device_icon }} {{ s.device.name }}</a></td>
+      <td><a href="/device/{{ s.device.id }}">{{ s.device|device_icon }}&nbsp;{{ s.device.name }}</a></td>
      </tr>
     {% endfor %}
    </table>
diff --git a/mygpo/web/templatetags/devices.py b/mygpo/web/templatetags/devices.py
index 242e7a8..68e8eb6 100644
--- a/mygpo/web/templatetags/devices.py
+++ b/mygpo/web/templatetags/devices.py
@@ -22,5 +22,5 @@ def device_icon(device,size=16):
 
 @register.filter
 def device_list(devices):
-    return mark_safe(', '.join([ '<a href="/device/%s" />%s %s</a>' % (d.id, device_icon(d), d.name) for d in devices]))
+    return mark_safe(', '.join([ '<a href="/device/%s">%s&nbsp;%s</a>' % (d.id, device_icon(d), d.name) for d in devices]))
         

commit d39f98b60fd578680b10be494724e42a554c1c40
Merge: fd69f77... 1eef500...
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:46:19 2010 +0100

    Merge branch 'master' of /home/martin/mygpo-src
    
    Conflicts:
    
    	mygpo/web/templates/base.html
    
    Merge the menu with the translations

commit fd69f776642c55a859a337610cb13af3f44fabbe
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:38:36 2010 +0100

    Update menu style

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index fe1d065..9c14ca4 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -59,6 +59,26 @@ ul.menu
     padding: 0;
 }
 
+ul.menu li {
+    margin: 3px;
+    padding-left: 10px;
+}
+
+ul.menu li.heading {
+    margin-top: 20px;
+    margin-bottom: 10px;
+}
+
+.menu strong {
+    color: #75507b;
+    background-color: white;
+    padding: 3px;
+    padding-left: 10px;
+    padding-right: 10px;
+    -moz-border-radius: 5px;
+    margin-left: -10px;
+}
+
 table.list
 {
     margin-top: 2em;
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index ef3d10a..0319d66 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -62,21 +62,23 @@
 
    {% if user.is_authenticated %}
     <ul class="menu">
-     <li><a href="/">{{ user.username }}'s Home</a></li>
-     <li><a href="/account/">Your settings</a></li>
-     <li><a href="/online-help/">Online Help</a></li>
+     <li class="heading"><strong>{{ user.username }}</strong></li>
+     <li><a href="/">Subscriptions</a></li>
+     <li><a href="/history/">History</a></li>
+     <li><a href="/account/">Settings</a></li>
      <li><a href="/logout/">Logout</a></li>
     </ul>
 
     <ul class="menu">
-     <li><strong>Podcasts</strong></li>
+     <li class="heading"><strong>Discover</strong></li>
      <li><a href="/search/">Search</a></li>
      <li><a href="/toplist/">Toplist</a></li>
      <li><a href="/suggestions/">Suggestions</a></li>
-     <li><a href="/history/">History</a></li>
     </ul>
     
     <ul class="menu">
+     <li class="heading"><strong>Documentation</strong></li>
+     <li><a href="/online-help/">Online Help</a></li>
      <li><a href="/authors/">For podcast authors</a></li>
     </ul>
     

commit 1eef500010cb506e9f54977864f06da6c39c62f8
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 18:18:08 2010 +0100

    translation & toplist error

diff --git a/install/update-11.sql b/install/update-11.sql
index bd2acdd..5be30ee 100644
--- a/install/update-11.sql
+++ b/install/update-11.sql
@@ -168,7 +168,7 @@ BEGIN
             START TRANSACTION;
             DELETE FROM toplist_temp;
             INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription, 
-                                       (select COALESCE((id - (select min(id) from toplist) + 1),0) from toplist where podcast_id = a.podcast_id)
+                                       COALESCE((select (id - (select min(id) from toplist) + 1) from toplist where podcast_id = a.podcast_id),0)
                         FROM (SELECT DISTINCT podcast_id, user_id
                             FROM public_subscription) a
                         GROUP BY podcast_id);
diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index 2a2c3df..63c32e3 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-10 13:06+0100\n"
+"POT-Creation-Date: 2010-01-14 18:03+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -109,7 +109,8 @@ msgstr "Ihre Einstellungen wurden gespeichert."
 msgid "Update the settings for your account"
 msgstr "Aktualisierung der Konto-Einstellungen"
 
-#: web/templates/authors.html:5
+#: web/templates/authors.html:5 web/templates/base.html:81
+#: web/templates/base.html.py:93
 msgid "For podcast authors"
 msgstr "Fr die Podcast-Autoren"
 
@@ -125,10 +126,54 @@ msgstr ""
 msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
 msgstr "ndere YOUR_ADRESS in die Adresse deines Podcastes um."
 
-#: web/templates/device.html:9
+#: web/templates/base.html:67
+msgid "'s Home"
+msgstr "'s Home"
+
+#: web/templates/base.html:68
+msgid "Your settings"
+msgstr "Konto-Einstellungen"
+
+#: web/templates/base.html:69
+msgid "Logout"
+msgstr "Abmelden"
+
+#: web/templates/base.html:73 web/templates/device.html:9
 msgid "Podcasts"
 msgstr "Podcasts"
 
+#: web/templates/base.html:74 web/templates/search/search.html:6
+msgid "Search"
+msgstr "Suche"
+
+#: web/templates/base.html:75 web/templates/toplist.html:5
+msgid "Toplist"
+msgstr "Topliste"
+
+#: web/templates/base.html:76
+msgid "Suggestions"
+msgstr "Empfehlungen"
+
+#: web/templates/base.html:77
+msgid "History"
+msgstr "Verlauf"
+
+#: web/templates/base.html:86
+msgid "Home"
+msgstr "Home"
+
+#: web/templates/base.html:87
+msgid "Login"
+msgstr "Anmelden"
+
+#: web/templates/base.html:88
+msgid "Register"
+msgstr "Registrieren"
+
+#: web/templates/base.html:89
+msgid "Podcast-Toplist"
+msgstr "Podcast-Topliste"
+
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
 msgstr "Du hast die folgenden Podcasts auf diesem Gert abonniert"
@@ -139,7 +184,7 @@ msgstr "Titel"
 
 #: web/templates/device.html:15
 msgid "Since"
-msgstr "seit"
+msgstr "Seit"
 
 #: web/templates/device.html:27
 msgid "Synchronize"
@@ -213,31 +258,27 @@ msgstr ""
 "Anspruch nehmen kann. Bis dies erledigt ist wird der Podcast auf diese Wiese "
 "dargestellt."
 
-#: web/templates/history.html:6 web/templates/podcast.html:74
+#: web/templates/history.html:7 web/templates/podcast.html:74
 msgid "Subscription History"
 msgstr "Abonnementverlauf"
 
-#: web/templates/history.html:11 web/templates/podcast.html:77
+#: web/templates/history.html:12 web/templates/home-user.html:13
+#: web/templates/suggestions.html:17 web/templates/toplist.html:13
+msgid "Podcast"
+msgstr "Podcast"
+
+#: web/templates/history.html:13 web/templates/podcast.html:77
 msgid "Timestamp"
 msgstr "Zeitpunkt"
 
-#: web/templates/history.html:12 web/templates/podcast.html:78
+#: web/templates/history.html:14 web/templates/podcast.html:78
 msgid "Action"
 msgstr "Aktivitt"
 
-#: web/templates/history.html:13 web/templates/podcast.html:29
-#: web/templates/podcast.html.py:79
-msgid "Devices"
+#: web/templates/history.html:15
+msgid "Device"
 msgstr "Gerte"
 
-#: web/templates/history.html:20 web/templates/podcast.html:86
-msgid "subscribe"
-msgstr "abonniert"
-
-#: web/templates/history.html:23 web/templates/podcast.html:89
-msgid "unsubscribe"
-msgstr "beendet"
-
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
 msgstr "my.gpodder.org"
@@ -246,11 +287,6 @@ msgstr "my.gpodder.org"
 msgid "Your Subscriptions"
 msgstr "Deine Abonnements"
 
-#: web/templates/home-user.html:13 web/templates/suggestions.html:17
-#: web/templates/toplist.html:13
-msgid "Podcast"
-msgstr "Podcast"
-
 #: web/templates/home-user.html:14
 msgid "Latest Episode"
 msgstr "Letzte Episode"
@@ -335,6 +371,10 @@ msgstr "Abonniere %(podcasttitle)s"
 msgid "Subscribe to this podcast"
 msgstr "Abonniere diesen Podcast"
 
+#: web/templates/podcast.html:29 web/templates/podcast.html.py:79
+msgid "Devices"
+msgstr "Gerte"
+
 #: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr "Dieser Podcast wurde abonniert am"
@@ -381,10 +421,6 @@ msgstr "URL"
 msgid "Do you like our suggestions?"
 msgstr "Bist du mit den Empfehlungen zufrieden?"
 
-#: web/templates/toplist.html:5
-msgid "Toplist"
-msgstr "Topliste"
-
 #: web/templates/toplist.html:7
 #, python-format
 msgid "These are the %(count)s most subscribed podcasts."
@@ -434,10 +470,6 @@ msgstr ""
 msgid "Create a User Account"
 msgstr "Erstelle ein Benutzer-Konto"
 
-#: web/templates/search/search.html:6
-msgid "Search"
-msgstr "Suche"
-
 #: web/templates/search/search.html:20
 msgid "Results"
 msgstr "Ergebnisse"
@@ -495,5 +527,11 @@ msgstr "Logo"
 msgid "No Logo available"
 msgstr "Kein Logo verfgbar"
 
+#~ msgid "subscribe"
+#~ msgstr "abonniert"
+
+#~ msgid "unsubscribe"
+#~ msgstr "beendet"
+
 #~ msgid "back!"
 #~ msgstr "zurck!"
diff --git a/mygpo/locale/en/LC_MESSAGES/django.po b/mygpo/locale/en/LC_MESSAGES/django.po
index 411cbc8..7ff7085 100644
--- a/mygpo/locale/en/LC_MESSAGES/django.po
+++ b/mygpo/locale/en/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-10 13:06+0100\n"
+"POT-Creation-Date: 2010-01-14 18:03+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -105,7 +105,8 @@ msgstr ""
 msgid "Update the settings for your account"
 msgstr ""
 
-#: web/templates/authors.html:5
+#: web/templates/authors.html:5 web/templates/base.html:81
+#: web/templates/base.html.py:93
 msgid "For podcast authors"
 msgstr ""
 
@@ -119,10 +120,54 @@ msgstr ""
 msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
 msgstr ""
 
-#: web/templates/device.html:9
+#: web/templates/base.html:67
+msgid "'s Home"
+msgstr ""
+
+#: web/templates/base.html:68
+msgid "Your settings"
+msgstr ""
+
+#: web/templates/base.html:69
+msgid "Logout"
+msgstr ""
+
+#: web/templates/base.html:73 web/templates/device.html:9
 msgid "Podcasts"
 msgstr ""
 
+#: web/templates/base.html:74 web/templates/search/search.html:6
+msgid "Search"
+msgstr ""
+
+#: web/templates/base.html:75 web/templates/toplist.html:5
+msgid "Toplist"
+msgstr ""
+
+#: web/templates/base.html:76
+msgid "Suggestions"
+msgstr ""
+
+#: web/templates/base.html:77
+msgid "History"
+msgstr ""
+
+#: web/templates/base.html:86
+msgid "Home"
+msgstr ""
+
+#: web/templates/base.html:87
+msgid "Login"
+msgstr ""
+
+#: web/templates/base.html:88
+msgid "Register"
+msgstr ""
+
+#: web/templates/base.html:89
+msgid "Podcast-Toplist"
+msgstr ""
+
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
 msgstr ""
@@ -200,29 +245,25 @@ msgid ""
 "simply be called this way."
 msgstr ""
 
-#: web/templates/history.html:6 web/templates/podcast.html:74
+#: web/templates/history.html:7 web/templates/podcast.html:74
 msgid "Subscription History"
 msgstr ""
 
-#: web/templates/history.html:11 web/templates/podcast.html:77
-msgid "Timestamp"
-msgstr ""
-
-#: web/templates/history.html:12 web/templates/podcast.html:78
-msgid "Action"
+#: web/templates/history.html:12 web/templates/home-user.html:13
+#: web/templates/suggestions.html:17 web/templates/toplist.html:13
+msgid "Podcast"
 msgstr ""
 
-#: web/templates/history.html:13 web/templates/podcast.html:29
-#: web/templates/podcast.html.py:79
-msgid "Devices"
+#: web/templates/history.html:13 web/templates/podcast.html:77
+msgid "Timestamp"
 msgstr ""
 
-#: web/templates/history.html:20 web/templates/podcast.html:86
-msgid "subscribe"
+#: web/templates/history.html:14 web/templates/podcast.html:78
+msgid "Action"
 msgstr ""
 
-#: web/templates/history.html:23 web/templates/podcast.html:89
-msgid "unsubscribe"
+#: web/templates/history.html:15
+msgid "Device"
 msgstr ""
 
 #: web/templates/home-user.html:6
@@ -233,11 +274,6 @@ msgstr ""
 msgid "Your Subscriptions"
 msgstr ""
 
-#: web/templates/home-user.html:13 web/templates/suggestions.html:17
-#: web/templates/toplist.html:13
-msgid "Podcast"
-msgstr ""
-
 #: web/templates/home-user.html:14
 msgid "Latest Episode"
 msgstr ""
@@ -309,6 +345,10 @@ msgstr ""
 msgid "Subscribe to this podcast"
 msgstr ""
 
+#: web/templates/podcast.html:29 web/templates/podcast.html.py:79
+msgid "Devices"
+msgstr ""
+
 #: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr ""
@@ -355,10 +395,6 @@ msgstr ""
 msgid "Do you like our suggestions?"
 msgstr ""
 
-#: web/templates/toplist.html:5
-msgid "Toplist"
-msgstr ""
-
 #: web/templates/toplist.html:7
 #, python-format
 msgid "These are the %(count)s most subscribed podcasts."
@@ -407,10 +443,6 @@ msgstr ""
 msgid "Create a User Account"
 msgstr ""
 
-#: web/templates/search/search.html:6
-msgid "Search"
-msgstr ""
-
 #: web/templates/search/search.html:20
 msgid "Results"
 msgstr ""
diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
index c26f477..174abe6 100644
--- a/mygpo/locale/it/LC_MESSAGES/django.po
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-10 13:06+0100\n"
+"POT-Creation-Date: 2010-01-14 18:03+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -19,7 +19,7 @@ msgstr ""
 #: api/models.py:187
 #, python-format
 msgid "Unnamed Device (%s)"
-msgstr "Dispositivo non specificato"
+msgstr "Dispositivo non specificato (%s)"
 
 #: web/forms.py:7
 msgid "Your Email Address"
@@ -105,7 +105,8 @@ msgstr ""
 msgid "Update the settings for your account"
 msgstr ""
 
-#: web/templates/authors.html:5
+#: web/templates/authors.html:5 web/templates/base.html:81
+#: web/templates/base.html.py:93
 msgid "For podcast authors"
 msgstr "Per gli autori dei podcasts"
 
@@ -119,10 +120,56 @@ msgstr ""
 msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
 msgstr ""
 
-#: web/templates/device.html:9
+#: web/templates/base.html:67
+msgid "'s Home"
+msgstr ""
+
+#: web/templates/base.html:68
+#, fuzzy
+msgid "Your settings"
+msgstr "Regolazioni di cliente"
+
+#: web/templates/base.html:69
+msgid "Logout"
+msgstr ""
+
+#: web/templates/base.html:73 web/templates/device.html:9
 msgid "Podcasts"
 msgstr "Podcasts"
 
+#: web/templates/base.html:74 web/templates/search/search.html:6
+msgid "Search"
+msgstr ""
+
+#: web/templates/base.html:75 web/templates/toplist.html:5
+msgid "Toplist"
+msgstr ""
+
+#: web/templates/base.html:76
+msgid "Suggestions"
+msgstr ""
+
+#: web/templates/base.html:77
+msgid "History"
+msgstr ""
+
+#: web/templates/base.html:86
+msgid "Home"
+msgstr ""
+
+#: web/templates/base.html:87
+msgid "Login"
+msgstr ""
+
+#: web/templates/base.html:88
+msgid "Register"
+msgstr ""
+
+#: web/templates/base.html:89
+#, fuzzy
+msgid "Podcast-Toplist"
+msgstr "Podcasts"
+
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
 msgstr ""
@@ -200,31 +247,28 @@ msgid ""
 "simply be called this way."
 msgstr ""
 
-#: web/templates/history.html:6 web/templates/podcast.html:74
+#: web/templates/history.html:7 web/templates/podcast.html:74
 msgid "Subscription History"
 msgstr ""
 
-#: web/templates/history.html:11 web/templates/podcast.html:77
+#: web/templates/history.html:12 web/templates/home-user.html:13
+#: web/templates/suggestions.html:17 web/templates/toplist.html:13
+msgid "Podcast"
+msgstr ""
+
+#: web/templates/history.html:13 web/templates/podcast.html:77
 msgid "Timestamp"
 msgstr "Data"
 
-#: web/templates/history.html:12 web/templates/podcast.html:78
+#: web/templates/history.html:14 web/templates/podcast.html:78
 msgid "Action"
 msgstr "Azione"
 
-#: web/templates/history.html:13 web/templates/podcast.html:29
-#: web/templates/podcast.html.py:79
-msgid "Devices"
+#: web/templates/history.html:15
+#, fuzzy
+msgid "Device"
 msgstr "Dispositivo"
 
-#: web/templates/history.html:20 web/templates/podcast.html:86
-msgid "subscribe"
-msgstr "abboni"
-
-#: web/templates/history.html:23 web/templates/podcast.html:89
-msgid "unsubscribe"
-msgstr "disdica"
-
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
 msgstr "my.gpodder.org"
@@ -233,11 +277,6 @@ msgstr "my.gpodder.org"
 msgid "Your Subscriptions"
 msgstr ""
 
-#: web/templates/home-user.html:13 web/templates/suggestions.html:17
-#: web/templates/toplist.html:13
-msgid "Podcast"
-msgstr ""
-
 #: web/templates/home-user.html:14
 msgid "Latest Episode"
 msgstr ""
@@ -309,6 +348,10 @@ msgstr ""
 msgid "Subscribe to this podcast"
 msgstr ""
 
+#: web/templates/podcast.html:29 web/templates/podcast.html.py:79
+msgid "Devices"
+msgstr "Dispositivo"
+
 #: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr ""
@@ -355,10 +398,6 @@ msgstr ""
 msgid "Do you like our suggestions?"
 msgstr ""
 
-#: web/templates/toplist.html:5
-msgid "Toplist"
-msgstr ""
-
 #: web/templates/toplist.html:7
 #, python-format
 msgid "These are the %(count)s most subscribed podcasts."
@@ -407,10 +446,6 @@ msgstr ""
 msgid "Create a User Account"
 msgstr ""
 
-#: web/templates/search/search.html:6
-msgid "Search"
-msgstr ""
-
 #: web/templates/search/search.html:20
 msgid "Results"
 msgstr ""
@@ -467,3 +502,9 @@ msgstr ""
 #: web/templatetags/podcasts.py:14
 msgid "No Logo available"
 msgstr ""
+
+#~ msgid "subscribe"
+#~ msgstr "abboni"
+
+#~ msgid "unsubscribe"
+#~ msgstr "disdica"
diff --git a/mygpo/locale/nb/LC_MESSAGES/django.po b/mygpo/locale/nb/LC_MESSAGES/django.po
index 04d7bf0..93fe327 100644
--- a/mygpo/locale/nb/LC_MESSAGES/django.po
+++ b/mygpo/locale/nb/LC_MESSAGES/django.po
@@ -6,7 +6,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: 2.1\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-10 13:06+0100\n"
+"POT-Creation-Date: 2010-01-14 18:03+0100\n"
 "PO-Revision-Date: 2010-01-06 11:48+0100\n"
 "Last-Translator: Jim Nygrd <jim@nygard.priv.no>\n"
 "Language-Team: gpodder <>\n"
@@ -106,7 +106,8 @@ msgstr "Dine innstillinger er lagret."
 msgid "Update the settings for your account"
 msgstr "Oppdater innstillingene for kontoen din"
 
-#: web/templates/authors.html:5
+#: web/templates/authors.html:5 web/templates/base.html:81
+#: web/templates/base.html.py:93
 msgid "For podcast authors"
 msgstr ""
 
@@ -120,10 +121,60 @@ msgstr ""
 msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
 msgstr ""
 
-#: web/templates/device.html:9
+#: web/templates/base.html:67
+msgid "'s Home"
+msgstr ""
+
+#: web/templates/base.html:68
+#, fuzzy
+msgid "Your settings"
+msgstr "Kontoinnstillinger"
+
+#: web/templates/base.html:69
+#, fuzzy
+msgid "Logout"
+msgstr "Logo"
+
+#: web/templates/base.html:73 web/templates/device.html:9
 msgid "Podcasts"
 msgstr "Podcaster"
 
+#: web/templates/base.html:74 web/templates/search/search.html:6
+msgid "Search"
+msgstr "Sk"
+
+#: web/templates/base.html:75 web/templates/toplist.html:5
+msgid "Toplist"
+msgstr "Toppliste"
+
+#: web/templates/base.html:76
+#, fuzzy
+msgid "Suggestions"
+msgstr "Podcastforslag"
+
+#: web/templates/base.html:77
+msgid "History"
+msgstr ""
+
+#: web/templates/base.html:86
+msgid "Home"
+msgstr ""
+
+#: web/templates/base.html:87
+#, fuzzy
+msgid "Login"
+msgstr "Logo"
+
+#: web/templates/base.html:88
+#, fuzzy
+msgid "Register"
+msgstr "Registrer!"
+
+#: web/templates/base.html:89
+#, fuzzy
+msgid "Podcast-Toplist"
+msgstr "Podcaster"
+
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
 msgstr "Du abonnerer p flgende podcaster p denne enheten"
@@ -207,31 +258,28 @@ msgstr ""
 "Fordi vi viser navnene etter  ha hentet informasjonen i strmmen, dette kan "
 "ta litt tid. I mellomtiden vil podcasten vises uten navn."
 
-#: web/templates/history.html:6 web/templates/podcast.html:74
+#: web/templates/history.html:7 web/templates/podcast.html:74
 msgid "Subscription History"
 msgstr "Abonnementshistorikk"
 
-#: web/templates/history.html:11 web/templates/podcast.html:77
+#: web/templates/history.html:12 web/templates/home-user.html:13
+#: web/templates/suggestions.html:17 web/templates/toplist.html:13
+msgid "Podcast"
+msgstr "Podcast"
+
+#: web/templates/history.html:13 web/templates/podcast.html:77
 msgid "Timestamp"
 msgstr "Tidspunkt"
 
-#: web/templates/history.html:12 web/templates/podcast.html:78
+#: web/templates/history.html:14 web/templates/podcast.html:78
 msgid "Action"
 msgstr "Handling"
 
-#: web/templates/history.html:13 web/templates/podcast.html:29
-#: web/templates/podcast.html.py:79
-msgid "Devices"
+#: web/templates/history.html:15
+#, fuzzy
+msgid "Device"
 msgstr "Enheter"
 
-#: web/templates/history.html:20 web/templates/podcast.html:86
-msgid "subscribe"
-msgstr "abonner"
-
-#: web/templates/history.html:23 web/templates/podcast.html:89
-msgid "unsubscribe"
-msgstr "avslutt abonnement"
-
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
 msgstr "my.gpodder.org"
@@ -240,11 +288,6 @@ msgstr "my.gpodder.org"
 msgid "Your Subscriptions"
 msgstr "Dine Abonnement"
 
-#: web/templates/home-user.html:13 web/templates/suggestions.html:17
-#: web/templates/toplist.html:13
-msgid "Podcast"
-msgstr "Podcast"
-
 #: web/templates/home-user.html:14
 msgid "Latest Episode"
 msgstr "Siste episode"
@@ -328,6 +371,10 @@ msgstr "Abonner p %(podcasttitle)s"
 msgid "Subscribe to this podcast"
 msgstr "Abonner p denne podcasten"
 
+#: web/templates/podcast.html:29 web/templates/podcast.html.py:79
+msgid "Devices"
+msgstr "Enheter"
+
 #: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr "Du abonnerer p denne podcasten p"
@@ -375,10 +422,6 @@ msgstr "URL"
 msgid "Do you like our suggestions?"
 msgstr "Liker du vre anbefalinger?"
 
-#: web/templates/toplist.html:5
-msgid "Toplist"
-msgstr "Toppliste"
-
 #: web/templates/toplist.html:7
 #, python-format
 msgid "These are the %(count)s most subscribed podcasts."
@@ -427,10 +470,6 @@ msgstr "Du m bekrefte kontoen med e-posten du n skal ha mottatt."
 msgid "Create a User Account"
 msgstr "Opprett en brukerkonto"
 
-#: web/templates/search/search.html:6
-msgid "Search"
-msgstr "Sk"
-
 #: web/templates/search/search.html:20
 msgid "Results"
 msgstr "Resultater"
@@ -488,5 +527,11 @@ msgstr "Logo"
 msgid "No Logo available"
 msgstr "Ingen logo tilgjengelig"
 
+#~ msgid "subscribe"
+#~ msgstr "abonner"
+
+#~ msgid "unsubscribe"
+#~ msgstr "avslutt abonnement"
+
 #~ msgid "back!"
 #~ msgstr "zurck!"
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 21df157..f974813 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -1,3 +1,5 @@
+{% load i18n %}
+
 <html>
  <head>
 <!--
@@ -62,33 +64,33 @@
 
    {% if user.is_authenticated %}
     <ul class="menu">
-     <li><a href="/">{{ user.username }}'s Home</a></li>
-     <li><a href="/account/">Your settings</a></li>
-     <li><a href="/logout/">Logout</a></li>
+     <li><a href="/">{{ user.username }}{% trans "'s Home" %}</a></li>
+     <li><a href="/account/">{% trans "Your settings" %}</a></li>
+     <li><a href="/logout/">{% trans "Logout" %}</a></li>
     </ul>
 
     <ul class="menu">
-     <li><strong>Podcasts</strong></li>
-     <li><a href="/search/">Search</a></li>
-     <li><a href="/toplist/">Toplist</a></li>
-     <li><a href="/suggestions/">Suggestions</a></li>
-     <li><a href="/history/">History</a></li>
+     <li><strong>{% trans "Podcasts" %}</strong></li>
+     <li><a href="/search/">{% trans "Search" %}</a></li>
+     <li><a href="/toplist/">{% trans "Toplist" %}</a></li>
+     <li><a href="/suggestions/">{% trans "Suggestions" %}</a></li>
+     <li><a href="/history/">{% trans "History" %}</a></li>
     </ul>
     
     <ul class="menu">
-     <li><a href="/authors/">For podcast authors</a></li>
+     <li><a href="/authors/">{% trans "For podcast authors" %}</a></li>
     </ul>
     
    {% else %}
     <ul class="menu">
-     <li><a href="/">Home</a></li>
-     <li><a href="/login/">Login</a></li>
-     <li><a href="/register/">Register</a></li>
-     <li><a href="/toplist/">Podcast-Toplist</a></li>
+     <li><a href="/">{% trans "Home" %}</a></li>
+     <li><a href="/login/">{% trans "Login" %}</a></li>
+     <li><a href="/register/">{% trans "Register" %}</a></li>
+     <li><a href="/toplist/">{% trans "Podcast-Toplist" %}</a></li>
     </ul>
     
     <ul class="menu">
-     <li><a href="/authors/">For podcast authors</a></li>
+     <li><a href="/authors/">{% trans "For podcast authors" %}</a></li>
     </ul>
    {% endif %}
 

commit b6cb611d3e3cfd0993d0e3961c6036520ff8ef1e
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:04:12 2010 +0100

    Fix typos in online help page

diff --git a/mygpo/web/templates/online-help.html b/mygpo/web/templates/online-help.html
index 0883fcc..ebde0a9 100644
--- a/mygpo/web/templates/online-help.html
+++ b/mygpo/web/templates/online-help.html
@@ -42,7 +42,7 @@
    <h3 id="2.1">{% trans "How can I start a synchronisation?" %}</h3>
    <p>{% trans "Choose a device on your home-screen and click on it." %}</p>
    <p><img src="/media/online-help/userhome.png" class="ohelp" /></p>
-   <p>{% trans "Go to the field &quotSynchronize&quot, choose your desired device and click on the &quot;OK&quot;-button." %}</p>
+   <p>{% trans "Go to the field &quot;Synchronize&quot;, choose your desired device and click on the &quot;OK&quot;-button." %}</p>
    <p><img src="/media/online-help/startsync.png" class="ohelp" /></p>
    <p>{% trans "Now the two devices are synchronized." %}</p>
    

commit f66e0325b5205fa14d5416bcd8c8a01f5959e4d4
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:01:09 2010 +0100

    Fix update-11.sql install script

diff --git a/install/update-11.sql b/install/update-11.sql
index bd2acdd..5be30ee 100644
--- a/install/update-11.sql
+++ b/install/update-11.sql
@@ -168,7 +168,7 @@ BEGIN
             START TRANSACTION;
             DELETE FROM toplist_temp;
             INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription, 
-                                       (select COALESCE((id - (select min(id) from toplist) + 1),0) from toplist where podcast_id = a.podcast_id)
+                                       COALESCE((select (id - (select min(id) from toplist) + 1) from toplist where podcast_id = a.podcast_id),0)
                         FROM (SELECT DISTINCT podcast_id, user_id
                             FROM public_subscription) a
                         GROUP BY podcast_id);

commit 53f837dec367227a03b2c5663ddb21caf3e280ef
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 18:00:49 2010 +0100

    Fix bug in italian translation

diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
index c26f477..7056118 100644
--- a/mygpo/locale/it/LC_MESSAGES/django.po
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -19,7 +19,7 @@ msgstr ""
 #: api/models.py:187
 #, python-format
 msgid "Unnamed Device (%s)"
-msgstr "Dispositivo non specificato"
+msgstr "Dispositivo non specificato (%s)"
 
 #: web/forms.py:7
 msgid "Your Email Address"

commit 58692a5c46ba961d205bab7b1b70b6949ddcc706
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Jan 14 18:00:34 2010 +0100

    online-help ';' added

diff --git a/mygpo/web/templates/online-help.html b/mygpo/web/templates/online-help.html
index 0883fcc..0dcd87f 100644
--- a/mygpo/web/templates/online-help.html
+++ b/mygpo/web/templates/online-help.html
@@ -42,7 +42,7 @@
    <h3 id="2.1">{% trans "How can I start a synchronisation?" %}</h3>
    <p>{% trans "Choose a device on your home-screen and click on it." %}</p>
    <p><img src="/media/online-help/userhome.png" class="ohelp" /></p>
-   <p>{% trans "Go to the field &quotSynchronize&quot, choose your desired device and click on the &quot;OK&quot;-button." %}</p>
+   <p>{% trans "Go to the field &quot;Synchronize&quot, choose your desired device and click on the &quot;OK&quot;-button." %}</p>
    <p><img src="/media/online-help/startsync.png" class="ohelp" /></p>
    <p>{% trans "Now the two devices are synchronized." %}</p>
    

commit 0045d1a71bcf92443c934095df34cda092f9a051
Merge: 0a00cfb... 6310332...
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 16:54:04 2010 +0100

    Merge branch 'master' of dev.gpodder.org:~alex/mygpo-src

commit 0a00cfb10039f620cdcdb23bb95e67c51730fe63
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 14 16:53:48 2010 +0100

    Website toplist count is now 100

diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index b8c13b8..648610d 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -162,7 +162,7 @@ def account(request):
     }, context_instance=RequestContext(request))
 
 
-def toplist(request, len=50):
+def toplist(request, len=100):
     entries = ToplistEntry.objects.all().order_by('-subscriptions')[:len]
     return render_to_response('toplist.html', {
         'entries': entries,

commit 63103329436c02e58aeb597f639a6a8f155a622f
Merge: 3fbd6ac... 4053081...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Jan 14 16:53:10 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/martin/mygpo-src

commit 4053081d9b1fe81d7f0ecdcca1ea1037c0af3484
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 16:52:48 2010 +0100

    toplist coalesce

diff --git a/install/update-11.sql b/install/update-11.sql
index 997f3f5..bd2acdd 100644
--- a/install/update-11.sql
+++ b/install/update-11.sql
@@ -168,7 +168,7 @@ BEGIN
             START TRANSACTION;
             DELETE FROM toplist_temp;
             INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription, 
-                                       (select (id - (select min(id) from toplist) + 1) from toplist where podcast_id = a.podcast_id)
+                                       (select COALESCE((id - (select min(id) from toplist) + 1),0) from toplist where podcast_id = a.podcast_id)
                         FROM (SELECT DISTINCT podcast_id, user_id
                             FROM public_subscription) a
                         GROUP BY podcast_id);

commit 881ce0eeda5f206c2d6915d62dae0af517a32511
Merge: 50e5ccc... 4eb1f80...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 16:52:00 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit 3fbd6acec9abd163f0bbc45faa3f3c8fda060546
Merge: 5e21d74... 50e5ccc...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Jan 14 16:51:40 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/martin/mygpo-src

commit 5e21d74e553ff6993eabcf89fe423172a9bfbfa3
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Jan 14 13:29:49 2010 +0100

    errors in online-help

diff --git a/mygpo/web/templates/online-help.html b/mygpo/web/templates/online-help.html
index fecf4fe..0883fcc 100644
--- a/mygpo/web/templates/online-help.html
+++ b/mygpo/web/templates/online-help.html
@@ -8,7 +8,7 @@
     <li>
      <a href="#1">{% trans "How can I configure my devices?" %}</a>
      <ul>
-      <li><a href="#1.1">{% trans "How can I a new device?" %}</a></li>
+      <li><a href="#1.1">{% trans "How can I add a new device?" %}</a></li>
       <li><a href="#1.2">{% trans "How can I edit a device?" %}</a></li>
      </ul>
     </li>
@@ -25,11 +25,13 @@
   
   <div class="ohelp">
    <h2 id="1" class="ohelp">{% trans "How can I configure my devices?" %}</h2>
-   <h3 id="1.1">{% trans "How can I a new device?" %}</h3>
+   <h3 id="1.1">{% trans "How can I add a new device?" %}</h3>
+   <p>{% trans "Open the gPodder Podcast-Client on your PC or MAC." %}</p>
+   <p>{% trans "Upload your podcasts and if it's asked, enter your username and password. The server will create you a new device." %}</p>
    <h3 id="1.2">{% trans "How can I edit a device?" %}</h3>
    <p>{% trans "Click on your &quot;home&quot;-link." %}<br />
    {% trans "Now you can see your devices, click on one of them." %}</p>
-   <p><img src="/media/online-help/userhomesingle.png" class="ohelp" /></p>
+   <p><img src="/media/online-help/userhome.png" class="ohelp" /></p>
    <p>{% trans "You are redirected to another page.<br />On the bottom of the page there's a field named &quot;Edit&quot;" %}</p>
    <p><img src="/media/online-help/deviceedit.png" class="ohelp" /></p>
    <p>{% trans "Here you can edit the name, the type and the uid. But pay attention if you edit the uid! If you enter a false one your subscriptions won't be synchronize with your device anymore." %}</p>

commit 881a04463cbfc3d5a53ec34e9caa2ed17ee02134
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Jan 14 13:09:30 2010 +0100

    Unsubscribing Podcasts on the Website

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index f7b1651..fe1d065 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -166,4 +166,22 @@ div.ohelp
     margin-bottom: 2em;
 }
 
+div.devicesLeft
+{
+    float:left;
+	width: 10em;
+}
+
+div.devicesRight
+{
+    float:left;
+    margin-top:-5px;
+	width: 26px;
+	height: 26px;
+}
+
+div.devicesClear
+{
+    clear:left;
+}
 
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 009a674..f69998a 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -40,6 +40,7 @@ urlpatterns = patterns('',
 
     (r'^podcast/(?P<pid>\w+)$', 'mygpo.web.views.podcast'),
     (r'^podcast/(?P<pid>\w+)/subscribe$', 'mygpo.web.views.podcast_subscribe'),
+    (r'^podcast/(?P<pid>\w+)/unsubscribe/(?P<device_id>\w+)', 'mygpo.web.views.podcast_unsubscribe'),
 
     (r'^episode/(?P<id>\d+)$', 'mygpo.web.views.episode'),
 
diff --git a/mygpo/web/templates/device.html b/mygpo/web/templates/device.html
index f853292..8cbbaf1 100644
--- a/mygpo/web/templates/device.html
+++ b/mygpo/web/templates/device.html
@@ -13,6 +13,7 @@
     <th></th>
     <th>{% trans "Title" %}</th>
     <th>{% trans "Since" %}</th>
+    <th>{% trans "Unsubscribe" %}</th>
    </tr>
 
    {% for subscription in subscriptions %}
@@ -20,6 +21,7 @@
      <td></td>
      <td><a href="/podcast/{{subscription.podcast.id}}">{{ subscription.podcast }}</a></td>
      <td><abbr title="{{subscription.subscribed_since}}">{{subscription.subscribed_since|naturalday}}</abbr></td>
+     <td><a href="/podcast/{{subscription.podcast.id}}/unsubscribe/{{ device.id }}?return_to=/device/{{ device.id }}"><img src="/media/unsubscribe.png" /></a></td>
     </tr>
    {% endfor %}
   </table>
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index e1373b9..9abd11c 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -30,7 +30,11 @@
    <strong>{% trans "You have subscribed this podcast on" %}</strong>
    <ul class="devices">
    {% for device in devices %}
-    <li class="{{device.type}}"><a href="/device/{{ device.id }}">{{ device }}</a></li>
+    <li class="{{device.type}}">
+     <div class="devicesLeft"><a href="/device/{{ device.id }}">{{ device }}</a></div>
+     <div class="devicesRight"><a href="{{unsubscribe}}/{{ device.id }}?return_to=/podcast/{{ podcast.id }}"><img src="/media/unsubscribe.png" /></a></div>
+     <div class="devicesClear"></div>
+    </li>
    {% endfor %}
    </ul>
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index b8c13b8..433cc7d 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -19,7 +19,7 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect, HttpResponse, HttpResponseBadRequest, HttpResponseNotAllowed, Http404
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
-from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry, Rating, SyncGroup, SUBSCRIBE_ACTION
+from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry, Rating, SyncGroup, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from mygpo.web.forms import UserAccountForm, DeviceForm, SyncForm
 from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
@@ -69,12 +69,14 @@ def podcast(request, pid):
     subscribed_devices = [s.device for s in Subscription.objects.filter(podcast=podcast,user=request.user)]
     subscribe_targets = podcast.subscribe_targets(request.user)
     episodes = episode_list(podcast, request.user)
+    unsubscribe = '/podcast/' + pid + '/unsubscribe'
     return render_to_response('podcast.html', {
         'history': history,
         'podcast': podcast,
         'devices': subscribed_devices,
         'can_subscribe': len(subscribe_targets) > 0,
         'episodes': episodes,
+        'unsubscribe': unsubscribe,
     }, context_instance=RequestContext(request))
 
 def history(request, len=20):
@@ -113,6 +115,19 @@ def podcast_subscribe(request, pid):
             'form': form
         }, context_instance=RequestContext(request))
 
+@login_required
+def podcast_unsubscribe(request, pid, device_id):
+
+    return_to = request.GET.get('return_to')
+    
+    if return_to == None:
+        raise Http404('Wrong URL')
+
+    podcast = Podcast.objects.get(pk=pid)
+    device = Device.objects.get(pk=device_id)
+    SubscriptionAction.objects.create(podcast=podcast, device=device, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now())
+    
+    return HttpResponseRedirect(return_to)
 
 def episode_list(podcast, user):
     list = {}

commit 50e5ccc6f70a459935482b5f42b77fac221d4af8
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 14 10:51:35 2010 +0100

    add temporary tables

diff --git a/install/update-11.sql b/install/update-11.sql
index 86eb173..997f3f5 100644
--- a/install/update-11.sql
+++ b/install/update-11.sql
@@ -10,14 +10,11 @@ BEGIN
     DECLARE cur1 CURSOR FOR SELECT user_ptr_id FROM user where suggestion_up_to_date = 0;
     DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
     
-
-
-    DROP TABLE IF EXISTS suggestion_pod;
-    CREATE TABLE suggestion_pod (
+    CREATE TEMPORARY TABLE suggestion_pod (
        podID INT
     );
-    DROP TABLE IF EXISTS suggestion_user;
-    CREATE TABLE suggestion_user (
+    
+    CREATE TEMPORARY TABLE suggestion_user (
        userID INT
     );
 
@@ -73,10 +70,7 @@ select user_help;
 
         IF deadlock=1 THEN
             call FAIL('Suggestion are not updated!');
-        END IF;
-
-        DROP TABLE IF EXISTS suggestion_user;
-        DROP TABLE IF EXISTS suggestion_pod;         
+        END IF;         
 
 END $$
 DELIMITER ;
@@ -90,12 +84,11 @@ BEGIN
     DECLARE pod_count INT DEFAULT 0;
     DECLARE utd INT DEFAULT 0;
         
-    DROP TABLE IF EXISTS suggestion_pod;
-    CREATE TABLE suggestion_pod (
+    CREATE TEMPORARY TABLE suggestion_pod (
        podID INT
     );
-    DROP TABLE IF EXISTS suggestion_user;
-    CREATE TABLE suggestion_user (
+    
+    CREATE TEMPORARY TABLE suggestion_user (
        userID INT
     );
 
@@ -143,11 +136,71 @@ BEGIN
 
         IF deadlock=1 THEN
             call FAIL('Suggestion are not updated!');
-        END IF;
+        END IF;       
+
+END $$
+DELIMITER ;
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_toplist $$
+CREATE PROCEDURE update_toplist()
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
+
+    CREATE TEMPORARY TABLE toplist_temp (
+            podcast_id INT PRIMARY KEY REFERENCES podcast (id),
+            subscription_count INT NOT NULL DEFAULT 0,
+            old_place INT DEFAULT 0,
+            INDEX(podcast_id)
+    );
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+        DECLARE deadlock_detected CONDITION FOR 1213;
+            DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+            SET deadlock=0;
+
+            START TRANSACTION;
+            DELETE FROM toplist_temp;
+            INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription, 
+                                       (select (id - (select min(id) from toplist) + 1) from toplist where podcast_id = a.podcast_id)
+                        FROM (SELECT DISTINCT podcast_id, user_id
+                            FROM public_subscription) a
+                        GROUP BY podcast_id);
+            DELETE FROM toplist;
+            INSERT INTO toplist (podcast_id, subscription_count, id, old_place) (SELECT podcast_id, subscription_count, NULL, old_place FROM toplist_temp
+                        ORDER BY subscription_count DESC LIMIT 100);
+
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
 
-        DROP TABLE IF EXISTS suggestion_user;
-        DROP TABLE IF EXISTS suggestion_pod;         
+        IF deadlock=1 THEN
+            call FAIL('Toplist is not updated!');
+        END IF;
 
 END $$
 DELIMITER ;
 
+DROP TABLE IF EXISTS podcast_tags;
+CREATE TABLE podcast_tags (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    tag VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+    podcast_id INT NOT NULL,
+    source VARCHAR(1000) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+    user_id INT,
+    weight INT,
+    FOREIGN KEY (user_id) REFERENCES auth_user (id),
+    FOREIGN KEY (podcast_id) REFERENCES podcast (id)
+);
+

commit 4322f23a5b9d3e0fd9805403b6d02e3333caef6a
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Jan 13 21:25:54 2010 +0100

    search added to simple api

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 90249d4..bef70a8 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -25,6 +25,7 @@ from datetime import datetime
 from mygpo.api.httpresponse import HttpErrorResponse
 import re
 from mygpo.log import log
+from haystack.query import SearchQuerySet
 
 try:
     import simplejson as json
@@ -117,6 +118,7 @@ def parse_subscription(raw_post_data, format, user, device_uid):
 
     return format_ok, new, rem, d
 
+
 def set_subscriptions(subscriptions):
     format_ok, new, rem, d = subscriptions
     
@@ -137,6 +139,7 @@ def set_subscriptions(subscriptions):
     # Only an empty response is a successful response
     return HttpResponse('', mimetype='text/plain')
 
+#get toplist
 def toplist(request, number, format):
     if request.method == 'GET':
         if int(number) not in range(1,100):
@@ -146,6 +149,7 @@ def toplist(request, number, format):
     else:
         return HttpResponseBadRequest('Invalid request')
 
+
 def get_toplist(number):
     entries = ToplistEntry.objects.all().order_by('-subscriptions')[:number]
     toplist = []
@@ -157,6 +161,7 @@ def get_toplist(number):
         
     return toplist
 
+
 def format_toplist(toplist, number, format): 
     if format == 'txt':
         urls = [t['url'] for t in toplist]
@@ -175,3 +180,47 @@ def format_toplist(toplist, number, format):
         
     else: 
         return HttpResponseBadRequest('Invalid format')
+
+#get search 
+def search(request, format):
+    if request.method == 'GET':
+        query = request.GET.get('q')
+        
+        if query == None:
+            return HttpErrorResponse(404, '/search.opml|txt|json?q={query}')
+        
+        return format_results(get_results(query), format)
+    else:
+        return HttpResponseBadRequest('Invalid request')
+        
+        
+def get_results(query):
+    search = SearchQuerySet().filter(content=query).models(Podcast)
+    results = []
+    for r in search:
+        p = Podcast.objects.get(pk=r.pk)
+        results.append(p)
+        
+    return results
+    
+    
+def format_results(results, format):
+    if format == 'txt':
+        urls = [r.url for r in results]
+        s = '\n'.join(urls)
+        s += '\n'
+        return HttpResponse(s, mimetype='text/plain')
+
+    elif format == 'opml':
+        title = 'Search results'
+        exporter = Exporter(title)
+        opml = exporter.generate(results)
+        return HttpResponse(opml, mimetype='text/xml')
+
+    elif format == 'json':
+        json = [{'url':p.url, 'title':p.title, 'description':p.description} for p in results]
+        return JsonResponse(json)
+        
+    else: 
+        return HttpResponseBadRequest('Invalid format')
+        
diff --git a/mygpo/urls.py b/mygpo/urls.py
index a58429c..009a674 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -60,7 +60,6 @@ urlpatterns = patterns('',
     (r'^device/(?P<device_id>\d+)/unsync$', 'mygpo.web.views.device_unsync'),
 
     (r'^search/', include('haystack.urls')),
-    #(r'^search.opml', ''),
 
     #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),
@@ -69,6 +68,7 @@ urlpatterns = patterns('',
     #Simple API
     (r'^subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).(?P<format>\w+)', 'mygpo.api.simple.subscriptions'),
     (r'^toplist/(?P<number>\d+).(?P<format>\w+)', 'mygpo.api.simple.toplist'),
+    (r'^search.(?P<format>\w+)', 'mygpo.api.simple.search'),
 
     #Advanced API
     (r'^api/1/subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.subscriptions'),

commit 9718b72b7a2fc89730e77ec51ac7e2448144b396
Merge: 14d067e... 4eb1f80...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Jan 13 19:41:18 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit 4eb1f808d256bdf00208540d6a8d589bafca94b0
Merge: 5a6f474... 5c8b109...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Jan 13 19:39:38 2010 +0100

    Merge branch 'master' of ssh://stefankoegl@repo.or.cz/srv/git/mygpo

commit 5a6f474c5b01da16e637ab95510363395460603e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Jan 13 19:39:10 2010 +0100

    added links, device icons to subscription history

diff --git a/mygpo/web/templates/history.html b/mygpo/web/templates/history.html
index 3947d68..b63f2a1 100644
--- a/mygpo/web/templates/history.html
+++ b/mygpo/web/templates/history.html
@@ -1,6 +1,7 @@
 {% extends "base.html" %}
 {% load i18n %}
 {% load humanize %}
+{% load devices %}
 
 {% block content %}
   <h1>{% trans "Subscription History" %}</h1>
@@ -11,11 +12,11 @@
      <th>{% trans "Podcast" %}</th>
      <th>{% trans "Timestamp" %}</th>
      <th>{% trans "Action" %}</th>
-     <th>{% trans "Devices" %}</th>
+     <th>{% trans "Device" %}</th>
     </tr>
     {% for s in history %}
      <tr>
-      <td>{{ s.podcast }}</td>
+      <td><a href="/podcast/{{ s.podcast.id }}">{{ s.podcast }}</a></td>
       <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
       <td>
        {% ifequal s.action 1 %}
@@ -25,7 +26,7 @@
         <img src="/media/unsubscribe.png" />
        {% endifequal %}
       </td>
-      <td>{{ s.device.name }}</td>
+      <td><a href="/device/{{ s.device.id }}">{{ s.device|device_icon }} {{ s.device.name }}</a></td>
      </tr>
     {% endfor %}
    </table>

commit 7c94114cb3229132e880a2b7bfc1e7964e38a74b
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Wed Jan 13 19:28:05 2010 +0100

    added icons

diff --git a/htdocs/media/subscribe.png b/htdocs/media/subscribe.png
new file mode 100644
index 0000000..da43815
Binary files /dev/null and b/htdocs/media/subscribe.png differ
diff --git a/htdocs/media/unsubscribe.png b/htdocs/media/unsubscribe.png
new file mode 100644
index 0000000..83934d0
Binary files /dev/null and b/htdocs/media/unsubscribe.png differ

commit e6e1dca6fb7e95526c11a85c940ce925c9a917be
Merge: 40253c0... 6b55985...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Wed Jan 13 19:27:06 2010 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src
    
    Conflicts:
    
    	htdocs/media/subscribe.png

commit 40253c079bf269a0709cdebe4cbf1f31a7febc46
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Wed Jan 13 19:24:46 2010 +0100

    subscription history added

diff --git a/htdocs/media/subscribe.png b/htdocs/media/subscribe.png
new file mode 100644
index 0000000..da43815
Binary files /dev/null and b/htdocs/media/subscribe.png differ
diff --git a/htdocs/media/unsubscribe.png b/htdocs/media/unsubscribe.png
new file mode 100644
index 0000000..83934d0
Binary files /dev/null and b/htdocs/media/unsubscribe.png differ
diff --git a/mygpo/web/templates/history.html b/mygpo/web/templates/history.html
index f8afa96..3947d68 100644
--- a/mygpo/web/templates/history.html
+++ b/mygpo/web/templates/history.html
@@ -8,19 +8,21 @@
    {% if not history|length_is:"0" %}
    <table class="list">
     <tr>
+     <th>{% trans "Podcast" %}</th>
      <th>{% trans "Timestamp" %}</th>
      <th>{% trans "Action" %}</th>
      <th>{% trans "Devices" %}</th>
     </tr>
     {% for s in history %}
      <tr>
+      <td>{{ s.podcast }}</td>
       <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
       <td>
        {% ifequal s.action 1 %}
-        {% trans "subscribe" %}
+        <img src="/media/subscribe.png" />
        {% endifequal %}
        {% ifequal s.action -1 %}
-        {% trans "unsubscribe" %}
+        <img src="/media/unsubscribe.png" />
        {% endifequal %}
       </td>
       <td>{{ s.device.name }}</td>
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index 1fdb345..9dce998 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -64,10 +64,10 @@
       <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
       <td>
        {% ifequal s.action 1 %}
-        {% trans "subscribe" %}
+        <img src="/media/subscribe.png" />
        {% endifequal %}
        {% ifequal s.action -1 %}
-        {% trans "unsubscribe" %}
+        <img src="/media/unsubscribe.png" />
        {% endifequal %}
       </td>
       <td>{{ s.device.name }}</td>

commit 14d067e07f9115c22126bf0187a002d2ae8c6b5e
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Jan 13 18:43:20 2010 +0100

    toplist for simple api implementet

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index bc989af..90249d4 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -17,7 +17,7 @@
 
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
-from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
+from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, ToplistEntry
 from mygpo.api.opml import Exporter, Importer
 from mygpo.api.httpresponse import JsonResponse
 from django.core import serializers
@@ -137,3 +137,41 @@ def set_subscriptions(subscriptions):
     # Only an empty response is a successful response
     return HttpResponse('', mimetype='text/plain')
 
+def toplist(request, number, format):
+    if request.method == 'GET':
+        if int(number) not in range(1,100):
+            print number
+            number = 100
+        return format_toplist(get_toplist(number), number, format)
+    else:
+        return HttpResponseBadRequest('Invalid request')
+
+def get_toplist(number):
+    entries = ToplistEntry.objects.all().order_by('-subscriptions')[:number]
+    toplist = []
+    for e in entries:
+        pid = e.podcast_id
+        p = Podcast.objects.get(pk=pid)
+        entry = {'url':p.url, 'title':p.title, 'description':p.description, 'subscribers':e.subscriptions, 'subscribers_last_week':e.oldplace}
+        toplist.append(entry)
+        
+    return toplist
+
+def format_toplist(toplist, number, format): 
+    if format == 'txt':
+        urls = [t['url'] for t in toplist]
+        s = '\n'.join(urls)
+        s += '\n'
+        return HttpResponse(s, mimetype='text/plain')
+
+    elif format == 'opml':
+        title = 'Top %d' % number
+        exporter = Exporter(title)
+        opml = exporter.generate(toplist)
+        return HttpResponse(opml, mimetype='text/xml')
+
+    elif format == 'json':
+        return JsonResponse(toplist)
+        
+    else: 
+        return HttpResponseBadRequest('Invalid format')
diff --git a/mygpo/urls.py b/mygpo/urls.py
index c94ddbb..a58429c 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -68,6 +68,7 @@ urlpatterns = patterns('',
 
     #Simple API
     (r'^subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).(?P<format>\w+)', 'mygpo.api.simple.subscriptions'),
+    (r'^toplist/(?P<number>\d+).(?P<format>\w+)', 'mygpo.api.simple.toplist'),
 
     #Advanced API
     (r'^api/1/subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.subscriptions'),

commit 92cff7820a9917dca20761777ac717447441f420
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Jan 13 16:29:39 2010 +0100

    simple api status codes added + tests | raise http404 removed and created in httprespnonse

diff --git a/mygpo/api/httpresponse.py b/mygpo/api/httpresponse.py
index b9e3d39..cac5cb5 100644
--- a/mygpo/api/httpresponse.py
+++ b/mygpo/api/httpresponse.py
@@ -26,10 +26,10 @@ except ImportError:
     import json
 
 
-def HttpResponseNotAuthorized():
-    response =  HttpResponse(('You\'re not authorized to visit this area!'), mimetype="text/plain")
+def HttpErrorResponse(code, msg):
+    response =  HttpResponse(('%s' % msg), mimetype="text/plain")
     response['WWW-Authenticate'] = 'Basic realm=""'
-    response.status_code = 401
+    response.status_code = code
     return response
 
 #from http://www.djangosnippets.org/snippets/154/
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index c978090..bc989af 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -16,13 +16,13 @@
 #
 
 from mygpo.api.basic_auth import require_valid_user
-from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
+from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
 from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from mygpo.api.opml import Exporter, Importer
 from mygpo.api.httpresponse import JsonResponse
 from django.core import serializers
 from datetime import datetime
-from mygpo.api.httpresponse import HttpResponseNotAuthorized
+from mygpo.api.httpresponse import HttpErrorResponse
 import re
 from mygpo.log import log
 
@@ -35,19 +35,22 @@ except ImportError:
 def subscriptions(request, username, device_uid, format):
     
     if request.user.username != username:
-        #throw 401
-        return HttpResponseNotAuthorized()
+        return HttpErrorResponse(401, 'Invalid user')
 
     if request.method == 'GET':
         return format_subscriptions(get_subscriptions(request.user, device_uid), format, username)
         
     elif request.method == 'PUT':
         return set_subscriptions(parse_subscription(request.raw_post_data, format, request.user, device_uid))
+    
     else:
-        return HttpResponseBadReqest()
+        return HttpResponseBadRequest()
 
 
 def format_subscriptions(subscriptions, format, username):
+    if subscriptions == 404:
+        return HttpErrorResponse(404, 'Invalid device ID')
+
     if format == 'txt':
         #return subscriptions formatted as txt
         urls = [p.url for p in subscriptions]
@@ -64,16 +67,21 @@ def format_subscriptions(subscriptions, format, username):
     elif format == 'json':
         urls = [p.url for p in subscriptions]
         return JsonResponse(urls)
+        
+    else: 
+        return HttpResponseBadRequest('Invalid format')
+
 
 def get_subscriptions(user, device_uid):
     #get and return subscription list from database (use backend to sync)
     try:
         d = Device.objects.get(uid=device_uid, user=user)
     except Device.DoesNotExist:
-        raise Http404('Device doesn\'t exist!')
+        return 404
     return [p.podcast for p in d.get_subscriptions()]
 
 def parse_subscription(raw_post_data, format, user, device_uid):
+    format_ok = True
     if format == 'txt':
         sub = raw_post_data.split('\n')
         p = '^http'
@@ -95,7 +103,9 @@ def parse_subscription(raw_post_data, format, user, device_uid):
         end = raw_post_data.find(']') + 1
         urls = json.loads(raw_post_data[begin:end])
 
-    else: raise ValueError('unsupported format %s' % format)
+    else:
+        urls = []
+        format_ok = False
     
     d, created = Device.objects.get_or_create(user=user, uid=device_uid, 
                 defaults = {'type': 'other', 'name': device_uid})
@@ -105,10 +115,13 @@ def parse_subscription(raw_post_data, format, user, device_uid):
     new = [p for p in urls if p not in old]
     rem = [p for p in old if p not in urls]
 
-    return new, rem, d
+    return format_ok, new, rem, d
 
 def set_subscriptions(subscriptions):
-    new, rem, d = subscriptions
+    format_ok, new, rem, d = subscriptions
+    
+    if format_ok == False:
+        return HttpResponseBadRequest('Invalid format') 
     
     for r in rem:
         p = Podcast.objects.get(url=r)
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 6deb95d..9fd1d42 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -385,3 +385,47 @@ class SimpleAPITest(TestCase):
         get = json.loads(response.content)
         
         self.assertEqual(get, [self.p1, self.p2, self.p3])
+        
+    def test_put_invalid_format(self):
+        device = 'ipod'
+        urls = [self.p1, self.p2, self.p3]
+        reqs = json.dumps(urls)
+        
+        #put json - add 3 podcasts
+        response = self.client.put('/subscriptions/%s/%s.iso' % (self.user.username, device), data={'raw_post_data':reqs})
+        self.assertEqual(response.status_code, 400)
+        self.assertEqual(response.content, 'Invalid format')
+
+
+    def test_put_valid_json_get_invalid_format(self):
+        device = 'ipod'
+        urls = [self.p1, self.p2, self.p3]
+        reqs = json.dumps(urls)
+        
+        #put json - add 3 podcasts
+        response = self.client.put('/subscriptions/%s/%s.json' % (self.user.username, device), data={'raw_post_data':reqs})
+        self.assertEqual(response.status_code, 200)
+        self.assertEqual(response.content, '')        
+        
+        #qerying subscription changes
+        response = self.client.get('/subscriptions/%s/%s.iso' % (self.user.username, device), {})
+        self.assertEqual(response.status_code, 400)
+        self.assertEqual(response.content, 'Invalid format')
+        
+    def test_get_invalid_device(self):
+        device = 'invalid'
+        
+        #qerying subscription changes
+        response = self.client.get('/subscriptions/%s/%s.txt' % (self.user.username, device), {})
+        self.assertEqual(response.status_code, 404)
+        self.assertEqual(response.content, 'Invalid device ID')
+        
+    def test_get_invalid_user(self):
+        username = 'invalid'
+        device = 'invalid'
+        
+        #qerying subscription changes
+        response = self.client.get('/subscriptions/%s/%s.txt' % (username, device), {})
+        self.assertEqual(response.status_code, 401)
+        self.assertEqual(response.content, 'Invalid user')
+        
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 21bfb84..c94ddbb 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -60,13 +60,14 @@ urlpatterns = patterns('',
     (r'^device/(?P<device_id>\d+)/unsync$', 'mygpo.web.views.device_unsync'),
 
     (r'^search/', include('haystack.urls')),
+    #(r'^search.opml', ''),
 
     #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
 
     #Simple API
-    (r'^subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).(?P<format>(txt|opml|json))', 'mygpo.api.simple.subscriptions'),
+    (r'^subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).(?P<format>\w+)', 'mygpo.api.simple.subscriptions'),
 
     #Advanced API
     (r'^api/1/subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.subscriptions'),

commit 5c8b1099b93ebada1d0c74d6c4258fd5db3314fe
Author: Thomas Perl <thp@thpinfo.com>
Date:   Mon Jan 11 23:32:52 2010 +0100

    Use grey boxes for info-only messages (website)

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 29a919d..3bcb366 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -30,8 +30,8 @@ table.register th {
 
 .info
 {
-    background-color: #7277d8;
-    border: #080e73 thin solid;
+    background-color: #eeeeee;
+    border: #aaaaaa thin solid;
     width: 100%;
     padding: 1em 1em 1em 45px;
     background-image: url('info.png');

commit 53b93094e8690dbfc7f00802d4eb95bdaad45d7d
Author: Thomas Perl <thp@thpinfo.com>
Date:   Mon Jan 11 12:49:30 2010 +0100

    Merge DB scripts into run-database-procedure
    
    This allows for better code re-use and correct
    placement of cronjob-related scripts. Also, it
    fixes a bug where the scripts always operated
    on the production database independent of the
    configuration of the server.

diff --git a/bin/run-database-procedure b/bin/run-database-procedure
new file mode 100755
index 0000000..65e64f7
--- /dev/null
+++ b/bin/run-database-procedure
@@ -0,0 +1,50 @@
+#!/usr/bin/python
+# -*- coding: utf-8 -*-
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+import os
+import sys
+import MySQLdb
+
+# Make sure the local "mygpo" package is in our PATH
+sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))
+
+from mygpo.settings import *
+
+# All allowed procedure names should be listed here
+VALID_PROCEDURES = ('update_suggestion', 'update_toplist')
+
+if len(sys.argv) != 2 or sys.argv[-1] not in VALID_PROCEDURES:
+    print >>sys.stderr, """
+    Usage: python %s [%s]
+    """ % (sys.argv[0], '|'.join(VALID_PROCEDURES))
+else:
+    procedure_name = sys.argv[-1]
+    try:
+        connection = MySQLdb.connect(host=DATABASE_HOST, user=DATABASE_USER, \
+                passwd=DATABASE_PASSWORD, db=DATABASE_NAME)
+
+        cur = connection.cursor()
+        cur.callproc(procedure_name, ())
+        cur.close()
+
+        connection.close()
+    except MySQLdb.Error, e:
+        print >>sys.stderr, 'MySQL Error %d:  %s' % (e.args[0], e.args[1])
+        sys.exit(1)
+
diff --git a/mygpo/api/update_UserSuggestion.py b/mygpo/api/update_UserSuggestion.py
deleted file mode 100644
index 2f6198d..0000000
--- a/mygpo/api/update_UserSuggestion.py
+++ /dev/null
@@ -1,22 +0,0 @@
-#!/usr/bin/python
-
-import sys
-import MySQLdb
-
-
-try:
-    mysql = MySQLdb.connect(user="mygpo_prod",passwd="",db="mygpo_prod")
-    mysql_cursor = mysql.cursor() 
-    
-    mysql_cursor.callproc( "update_suggestion_for", (sys.argv[1]) )
-    
-    mysql_cursor.close() 
-    mysql.close()
-
-except MySQLdb.Error, e:
-    print "MySQL Error %d:  %s" % ( e.args[0], e.args[1] )
-    sys.exit(1)
-
-except IndexError, e:
-    print "Usage: python update_UserSuggestion.py [User_id]"
-    sys.exit(1)
diff --git a/mygpo/api/update_allSuggestion.py b/mygpo/api/update_allSuggestion.py
deleted file mode 100644
index d61ec11..0000000
--- a/mygpo/api/update_allSuggestion.py
+++ /dev/null
@@ -1,17 +0,0 @@
-#!/usr/bin/python
-
-import sys
-import MySQLdb
-
-try:
-    mysql = MySQLdb.connect(user="mygpo_prod",passwd="",db="mygpo_prod")
-    mysql_cursor = mysql.cursor() 
-    
-    mysql_cursor.callproc( "update_suggestion", () )
-    
-    mysql_cursor.close() 
-    mysql.close()
-
-except MySQLdb.Error, e:
-    print "MySQL Error %d:  %s" % ( e.args[0], e.args[1] )
-    sys.exit(1)
diff --git a/mygpo/api/update_toplist.py b/mygpo/api/update_toplist.py
deleted file mode 100644
index 480b79f..0000000
--- a/mygpo/api/update_toplist.py
+++ /dev/null
@@ -1,17 +0,0 @@
-#!/usr/bin/python
-
-import sys
-import MySQLdb
-
-try:
-    mysql = MySQLdb.connect(user="mygpo_prod",passwd="",db="mygpo_prod")
-    mysql_cursor = mysql.cursor() 
-    
-    mysql_cursor.callproc( "update_toplist", () )
-    
-    mysql_cursor.close() 
-    mysql.close()
-
-except MySQLdb.Error, e:
-    print "MySQL Error %d:  %s" % ( e.args[0], e.args[1] )
-    sys.exit(1)

commit bbaad6e62ecc860d502b99ea1f4d1c80240f02d6
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sun Jan 10 18:44:00 2010 +0100

    online help

diff --git a/htdocs/media/online-help/deviceedit.png b/htdocs/media/online-help/deviceedit.png
new file mode 100644
index 0000000..bd0e8ce
Binary files /dev/null and b/htdocs/media/online-help/deviceedit.png differ
diff --git a/htdocs/media/online-help/startsync.png b/htdocs/media/online-help/startsync.png
new file mode 100644
index 0000000..8187033
Binary files /dev/null and b/htdocs/media/online-help/startsync.png differ
diff --git a/htdocs/media/online-help/stopsync.png b/htdocs/media/online-help/stopsync.png
new file mode 100644
index 0000000..9b8754a
Binary files /dev/null and b/htdocs/media/online-help/stopsync.png differ
diff --git a/htdocs/media/online-help/subscribetootherdev.png b/htdocs/media/online-help/subscribetootherdev.png
new file mode 100644
index 0000000..b69c15b
Binary files /dev/null and b/htdocs/media/online-help/subscribetootherdev.png differ
diff --git a/htdocs/media/online-help/userhome.png b/htdocs/media/online-help/userhome.png
new file mode 100644
index 0000000..30ea312
Binary files /dev/null and b/htdocs/media/online-help/userhome.png differ
diff --git a/htdocs/media/online-help/userhomesingle.png b/htdocs/media/online-help/userhomesingle.png
new file mode 100644
index 0000000..ff8148b
Binary files /dev/null and b/htdocs/media/online-help/userhomesingle.png differ
diff --git a/htdocs/media/online-help/userhomesync.png b/htdocs/media/online-help/userhomesync.png
new file mode 100644
index 0000000..ed5d4ea
Binary files /dev/null and b/htdocs/media/online-help/userhomesync.png differ
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 29a919d..a3d2497 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -146,3 +146,24 @@ div.subscribe
     padding: 1em 0 1em 0;
 }
 
+h2.ohelp
+{
+    padding-top: 0;
+}
+
+img.ohelp
+{
+    border: 1px solid rgb(40%, 40%, 40%) ; 
+}
+
+div.ohelp
+{
+    width: 50em;
+    padding-left: 3em;
+    padding-right: 3em;    
+    border: 1px solid rgb(40%, 40%, 40%) ;
+    -moz-border-radius: 10px;
+    margin-bottom: 2em;
+}
+
+
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 2ac25af..21bfb84 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -78,6 +78,8 @@ urlpatterns = patterns('',
     (r'^subscribe', 'mygpo.web.views.podcast_subscribe_url'),
     (r'^authors/$', 'django.views.generic.simple.direct_to_template', {'template': 'authors.html'}),
 
+    (r'^online-help', 'django.views.generic.simple.direct_to_template', {'template': 'online-help.html'}),
+
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs'
     # to INSTALLED_APPS to enable admin documentation:
     # (r'^admin/doc/', include('django.contrib.admindocs.urls')),
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 21df157..ef3d10a 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -64,6 +64,7 @@
     <ul class="menu">
      <li><a href="/">{{ user.username }}'s Home</a></li>
      <li><a href="/account/">Your settings</a></li>
+     <li><a href="/online-help/">Online Help</a></li>
      <li><a href="/logout/">Logout</a></li>
     </ul>
 
diff --git a/mygpo/web/templates/online-help.html b/mygpo/web/templates/online-help.html
new file mode 100644
index 0000000..fecf4fe
--- /dev/null
+++ b/mygpo/web/templates/online-help.html
@@ -0,0 +1,67 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>{% trans "Online Help" %}</h1>
+  <div>
+   <ul>
+    <li>
+     <a href="#1">{% trans "How can I configure my devices?" %}</a>
+     <ul>
+      <li><a href="#1.1">{% trans "How can I a new device?" %}</a></li>
+      <li><a href="#1.2">{% trans "How can I edit a device?" %}</a></li>
+     </ul>
+    </li>
+    <li>
+     <a href="#2">{% trans "How can I configure the synchronisation between devices?" %}</a>
+     <ul>
+      <li><a href="#2.1">{% trans "How can I start a synchronisation?" %}</a></li>
+      <li><a href="#2.2">{% trans "How can I stop a synchronisation?" %}</a></li>
+     </ul>
+    </li>
+    <li><a href="#3">{% trans "How can I copy single subscriptions between devices?" %}</a></li>
+   </ul>
+  </div>
+  
+  <div class="ohelp">
+   <h2 id="1" class="ohelp">{% trans "How can I configure my devices?" %}</h2>
+   <h3 id="1.1">{% trans "How can I a new device?" %}</h3>
+   <h3 id="1.2">{% trans "How can I edit a device?" %}</h3>
+   <p>{% trans "Click on your &quot;home&quot;-link." %}<br />
+   {% trans "Now you can see your devices, click on one of them." %}</p>
+   <p><img src="/media/online-help/userhomesingle.png" class="ohelp" /></p>
+   <p>{% trans "You are redirected to another page.<br />On the bottom of the page there's a field named &quot;Edit&quot;" %}</p>
+   <p><img src="/media/online-help/deviceedit.png" class="ohelp" /></p>
+   <p>{% trans "Here you can edit the name, the type and the uid. But pay attention if you edit the uid! If you enter a false one your subscriptions won't be synchronize with your device anymore." %}</p>
+  </div>
+     
+  <div class="ohelp">
+   <h2 id="2" class="ohelp">{% trans "How can I configure the synchronisation between devices?" %}</h2>
+   <h3 id="2.1">{% trans "How can I start a synchronisation?" %}</h3>
+   <p>{% trans "Choose a device on your home-screen and click on it." %}</p>
+   <p><img src="/media/online-help/userhome.png" class="ohelp" /></p>
+   <p>{% trans "Go to the field &quotSynchronize&quot, choose your desired device and click on the &quot;OK&quot;-button." %}</p>
+   <p><img src="/media/online-help/startsync.png" class="ohelp" /></p>
+   <p>{% trans "Now the two devices are synchronized." %}</p>
+   
+   <h3 id="2.2">{% trans "How can I stop a synchronisation?" %}</h3>
+   <p>{% trans "Click on your &quot;home&quot;-link." %}<br />
+   {% trans "Choose a device on which you would like to stop the synchronisation and click on it." %}</p>
+   <p><img src="/media/online-help/userhomesync.png" class="ohelp" /></p>
+   <p>{% trans "Go to the field &quot;Synchronize&quot; and click on &quot;Stop synchronisation for your device&quot;" %}</p>
+   <p><img src="/media/online-help/stopsync.png" class="ohelp" /></p>  
+   <p>{% trans "Now the two devices are unsynchronized again." %}</p> 
+  </div>
+  
+  <div class="ohelp">
+   <h2 id="3" class="ohelp">{% trans "How can I copy single subscriptions between devices?" %}</h2>
+   <p>{% trans "Click on your &quot;home&quot;-link." %}<br />
+   {% trans "Choose the podcast which you would like to copy on another device and click on it." %}</p>
+   <p><img src="/media/online-help/userhomesingle.png" class="ohelp" /></p>
+   <p>{% trans "Under the field &quot;Devices&quot; you see the link &quot;Subscribe to ... on other devices&quot; click on it." %}</p>
+   <p><img src="/media/online-help/subscribetootherdev.png" class="ohelp" /></p>
+   <p>{% trans "On the next page you can choose your desired device on which you want to copy the subscription." %}<br />
+   {% trans "After hitting the &quot;OK&quot;-button, the subscription has been copied." %}</p>
+  </div>
+  
+{% endblock %}

commit 80fe3dfb2e2337f8b36032050d4e2bd64e250289
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sun Jan 10 14:47:29 2010 +0100

     Bug 765 -  Italian Translation

diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
index 411cbc8..c26f477 100644
--- a/mygpo/locale/it/LC_MESSAGES/django.po
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -19,23 +19,23 @@ msgstr ""
 #: api/models.py:187
 #, python-format
 msgid "Unnamed Device (%s)"
-msgstr ""
+msgstr "Dispositivo non specificato"
 
 #: web/forms.py:7
 msgid "Your Email Address"
-msgstr ""
+msgstr "Il vostro email address"
 
 #: web/forms.py:8
 msgid "May we use your subscriptions for the toplist and suggestions?"
-msgstr ""
+msgstr "Possiamo usare i vostri abbonamenti per il toplist ed i suggerimenti?"
 
 #: web/forms.py:11
 msgid "Name of this device"
-msgstr ""
+msgstr "Nome di questo dispositivo"
 
 #: web/forms.py:12
 msgid "What kind of device is this?"
-msgstr ""
+msgstr "Che genere di dispositivo  questo?"
 
 #: web/forms.py:13
 msgid "What UID is configured on the pysical device?"
@@ -48,12 +48,12 @@ msgstr ""
 #: web/views.py:174
 #, python-format
 msgid "my.gpodder.org - Top %s"
-msgstr ""
+msgstr "my.gpodder.org - Top %s"
 
 #: web/views.py:200
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
-msgstr ""
+msgstr "my.gpodder.org - %s suggerimenti"
 
 #: web/views.py:214
 msgid "Synchronize with the following devices"
@@ -69,15 +69,15 @@ msgstr ""
 
 #: web/templates/401.html:4
 msgid "Unauthorized"
-msgstr ""
+msgstr "Non autorizzato"
 
 #: web/templates/401.html:5
 msgid "This page is only available to registered users."
-msgstr ""
+msgstr "Questa pagina  a disposizione soltanto degli utenti registrati."
 
 #: web/templates/404.html:4
 msgid "Not found"
-msgstr ""
+msgstr "Non trovato"
 
 #: web/templates/404.html:5
 msgid "The requested document could not be found."
@@ -85,7 +85,7 @@ msgstr ""
 
 #: web/templates/500.html:4
 msgid "Internal Server Error"
-msgstr ""
+msgstr "Errore del server interno"
 
 #: web/templates/500.html:5
 msgid ""
@@ -95,7 +95,7 @@ msgstr ""
 
 #: web/templates/account.html:5
 msgid "Account Settings"
-msgstr ""
+msgstr "Regolazioni di cliente"
 
 #: web/templates/account.html:8 web/templates/device.html:50
 msgid "Your settings have been saved."
@@ -107,7 +107,7 @@ msgstr ""
 
 #: web/templates/authors.html:5
 msgid "For podcast authors"
-msgstr ""
+msgstr "Per gli autori dei podcasts"
 
 #: web/templates/authors.html:8
 msgid ""
@@ -121,7 +121,7 @@ msgstr ""
 
 #: web/templates/device.html:9
 msgid "Podcasts"
-msgstr ""
+msgstr "Podcasts"
 
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
@@ -129,15 +129,15 @@ msgstr ""
 
 #: web/templates/device.html:14 web/templates/podcast.html:56
 msgid "Title"
-msgstr ""
+msgstr "Titolo"
 
 #: web/templates/device.html:15
 msgid "Since"
-msgstr ""
+msgstr "da"
 
 #: web/templates/device.html:27
 msgid "Synchronize"
-msgstr ""
+msgstr "Sincronizzi"
 
 #: web/templates/device.html:28
 msgid ""
@@ -163,7 +163,7 @@ msgstr ""
 
 #: web/templates/device.html:44 web/templates/subscribe.html:20
 msgid "OK"
-msgstr ""
+msgstr "OK"
 
 #: web/templates/episode.html:7
 #, python-format
@@ -178,15 +178,15 @@ msgstr ""
 
 #: web/templates/episode.html:25
 msgid "When"
-msgstr ""
+msgstr "Quando"
 
 #: web/templates/episode.html:26
 msgid "What"
-msgstr ""
+msgstr "Cosa"
 
 #: web/templates/episode.html:27
 msgid "Where"
-msgstr ""
+msgstr "Dove"
 
 #: web/templates/episode.html:41
 msgid "Why Unnamed Episode?"
@@ -206,28 +206,28 @@ msgstr ""
 
 #: web/templates/history.html:11 web/templates/podcast.html:77
 msgid "Timestamp"
-msgstr ""
+msgstr "Data"
 
 #: web/templates/history.html:12 web/templates/podcast.html:78
 msgid "Action"
-msgstr ""
+msgstr "Azione"
 
 #: web/templates/history.html:13 web/templates/podcast.html:29
 #: web/templates/podcast.html.py:79
 msgid "Devices"
-msgstr ""
+msgstr "Dispositivo"
 
 #: web/templates/history.html:20 web/templates/podcast.html:86
 msgid "subscribe"
-msgstr ""
+msgstr "abboni"
 
 #: web/templates/history.html:23 web/templates/podcast.html:89
 msgid "unsubscribe"
-msgstr ""
+msgstr "disdica"
 
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
-msgstr ""
+msgstr "my.gpodder.org"
 
 #: web/templates/home-user.html:9
 msgid "Your Subscriptions"

commit 6dd32d9a2c678e453354e2c18421cc6c4826c74e
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sun Jan 10 13:15:25 2010 +0100

     Bug 643 -  I18n-ize Website
     Bug 764 -  German Translation

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index 772f5be..2a2c3df 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-07 17:15+0100\n"
+"POT-Creation-Date: 2010-01-10 13:06+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -16,7 +16,7 @@ msgstr ""
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: api/models.py:167
+#: api/models.py:187
 #, python-format
 msgid "Unnamed Device (%s)"
 msgstr "Unbenanntes Gert (%s)"
@@ -27,7 +27,8 @@ msgstr "Deine Email Adresse"
 
 #: web/forms.py:8
 msgid "May we use your subscriptions for the toplist and suggestions?"
-msgstr "Drfen wir deine Abonnements fr die Berechnung der Topliste und "
+msgstr ""
+"Drfen wir deine Abonnements fr die Berechnung der Topliste und "
 "Empfehlungen verwenden?"
 
 #: web/forms.py:11
@@ -42,24 +43,60 @@ msgstr "Welcher Art ist dieses Gert?"
 msgid "What UID is configured on the pysical device?"
 msgstr "Welche UID besitzt das physikalische Gert?"
 
-#: web/views.py:103
+#: web/views.py:109
 msgid "With which client do you want to subscribe?"
 msgstr "Auf welchem Benutzer willst du aboonieren?"
 
-#: web/views.py:168
+#: web/views.py:174
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr "my.gpodder.org - Top %s"
 
-#: web/views.py:194
+#: web/views.py:200
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr "my.gpodder.org - %s Empfehlungen"
 
-#: web/views.py:208
+#: web/views.py:214
 msgid "Synchronize with the following devices"
 msgstr "Synchronisierung der folgenden Gerte"
 
+#: web/templates/400.html:4
+msgid "Bad request"
+msgstr "Unbekannte Anfrage"
+
+#: web/templates/400.html:5
+msgid "There has been an error processing your request."
+msgstr "Bei der Bearbeitung der Anfrage ist ein Fehler aufgetreten."
+
+#: web/templates/401.html:4
+msgid "Unauthorized"
+msgstr "Nicht autorisiert"
+
+#: web/templates/401.html:5
+msgid "This page is only available to registered users."
+msgstr "Diese Seite ist ausschlielich fr registrierte Benutzer."
+
+#: web/templates/404.html:4
+msgid "Not found"
+msgstr "Nicht gefunden"
+
+#: web/templates/404.html:5
+msgid "The requested document could not be found."
+msgstr "Das angefragte Dokument konnte nicht gefunden werden."
+
+#: web/templates/500.html:4
+msgid "Internal Server Error"
+msgstr "Interner Server Fehler"
+
+#: web/templates/500.html:5
+msgid ""
+"An error occured while processing your request. An e-mail with the error "
+"description has been sent to the developers."
+msgstr ""
+"Whrend der Bearbeitung der Anfrage ist ein Fehler aufgetreten. Eine E-mail, "
+"die diesen Vorfall beschreibt wurde an die Entwickler gesendet."
+
 #: web/templates/account.html:5
 msgid "Account Settings"
 msgstr "Konto-Einstellungen"
@@ -96,7 +133,7 @@ msgstr "Podcasts"
 msgid "You have subscribed the following podcasts on this device"
 msgstr "Du hast die folgenden Podcasts auf diesem Gert abonniert"
 
-#: web/templates/device.html:14 web/templates/podcast.html:37
+#: web/templates/device.html:14 web/templates/podcast.html:56
 msgid "Title"
 msgstr "Titel"
 
@@ -165,7 +202,7 @@ msgstr "Wo"
 msgid "Why Unnamed Episode?"
 msgstr "Warum unbenannte Episoden?"
 
-#: web/templates/episode.html:41 web/templates/podcast.html:80
+#: web/templates/episode.html:41 web/templates/podcast.html:99
 #: web/templates/subscribe.html:24
 msgid ""
 "Because we display names after we have fetched the information form the feed "
@@ -176,6 +213,31 @@ msgstr ""
 "Anspruch nehmen kann. Bis dies erledigt ist wird der Podcast auf diese Wiese "
 "dargestellt."
 
+#: web/templates/history.html:6 web/templates/podcast.html:74
+msgid "Subscription History"
+msgstr "Abonnementverlauf"
+
+#: web/templates/history.html:11 web/templates/podcast.html:77
+msgid "Timestamp"
+msgstr "Zeitpunkt"
+
+#: web/templates/history.html:12 web/templates/podcast.html:78
+msgid "Action"
+msgstr "Aktivitt"
+
+#: web/templates/history.html:13 web/templates/podcast.html:29
+#: web/templates/podcast.html.py:79
+msgid "Devices"
+msgstr "Gerte"
+
+#: web/templates/history.html:20 web/templates/podcast.html:86
+msgid "subscribe"
+msgstr "abonniert"
+
+#: web/templates/history.html:23 web/templates/podcast.html:89
+msgid "unsubscribe"
+msgstr "beendet"
+
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
 msgstr "my.gpodder.org"
@@ -230,15 +292,15 @@ msgstr ""
 msgid "We are currently tracking %(podcast_count)s Podcasts!"
 msgstr "Es werden zur Zeit %(podcast_count)s Podcasts verfolgt!"
 
-#: web/templates/home.html:20 web/templates/login.html:14
+#: web/templates/home.html:20 web/templates/login.html:15
 msgid "Not yet a member?"
 msgstr "Noch kein Mitglied?"
 
-#: web/templates/home.html:20 web/templates/login.html:14
+#: web/templates/home.html:20 web/templates/login.html:15
 msgid "Register!"
 msgstr "Registrieren!"
 
-#: web/templates/migrate.html:5
+#: web/templates/migrate.html:6
 msgid ""
 "The new my.gpodder.org uses usernames instead of email addresses. Based on "
 "your email address, we think you might like "
@@ -246,11 +308,11 @@ msgstr ""
 "Das neue my.gpodder.org Benutzername anstatt Emailadressen, der basierend "
 "auf deiner Emailadresse erzeugt wird. Wir denken, du wirst ihn mgen "
 
-#: web/templates/migrate.html:5
+#: web/templates/migrate.html:6
 msgid ", but you can change that if you want to."
 msgstr ", falls nicht kannst du ihn einfach ndern."
 
-#: web/templates/migrate.html:11
+#: web/templates/migrate.html:12
 msgid ""
 "You can keep your old user settings in gPodder. Once the next version (with "
 "lots of new features) is release, you'll have to replace your email address "
@@ -264,56 +326,41 @@ msgstr ""
 msgid "Unnamed Podcast"
 msgstr "Unbenannter Podcast"
 
-#: web/templates/podcast.html:17 web/templates/subscribe.html:7
+#: web/templates/podcast.html:20 web/templates/subscribe.html:7
 #, python-format
 msgid "Subscribe to %(podcasttitle)s"
 msgstr "Abonniere %(podcasttitle)s"
 
-#: web/templates/podcast.html:19 web/templates/subscribe.html:9
+#: web/templates/podcast.html:22 web/templates/subscribe.html:9
 msgid "Subscribe to this podcast"
 msgstr "Abonniere diesen Podcast"
 
-#: web/templates/podcast.html:23 web/templates/podcast.html.py:60
-msgid "Devices"
-msgstr "Gerte"
-
-#: web/templates/podcast.html:24
+#: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr "Dieser Podcast wurde abonniert am"
 
-#: web/templates/podcast.html:33
+#: web/templates/podcast.html:41
+#, python-format
+msgid "Subscribe to %(podcasttitle)s on other devices"
+msgstr "Abonniere %(podcasttitle)s auf einem anderen Gert"
+
+#: web/templates/podcast.html:43
+msgid "Subscribe to this podcast on other devices"
+msgstr "Abonniere diesen Podcast auf einem anderen Gert"
+
+#: web/templates/podcast.html:52
 msgid "Episodes"
 msgstr "Episoden"
 
-#: web/templates/podcast.html:38
+#: web/templates/podcast.html:57
 msgid "Description"
 msgstr "Beschreibung"
 
-#: web/templates/podcast.html:39
+#: web/templates/podcast.html:58
 msgid "Released"
 msgstr "Verffentlicht"
 
-#: web/templates/podcast.html:55
-msgid "Subscription History"
-msgstr "Abonnementverlauf"
-
-#: web/templates/podcast.html:58
-msgid "Timestamp"
-msgstr "Zeitpunkt"
-
-#: web/templates/podcast.html:59
-msgid "Action"
-msgstr "Aktivitt"
-
-#: web/templates/podcast.html:67
-msgid "subscribe"
-msgstr "abonniert"
-
-#: web/templates/podcast.html:70
-msgid "unsubscribe"
-msgstr "beendet"
-
-#: web/templates/podcast.html:80 web/templates/subscribe.html:24
+#: web/templates/podcast.html:99 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
 msgstr "Warum unbenannte Podcasts?"
 
@@ -355,35 +402,35 @@ msgstr "Letzte Woche"
 msgid "Subscribers"
 msgstr "Abonnenten"
 
-#: web/templates/registration/activate.html:5
-#: web/templates/registration/activation_complete.html:4
+#: web/templates/registration/activate.html:6
+#: web/templates/registration/activation_complete.html:5
 msgid "Account activated"
 msgstr "Konto aktiviert"
 
-#: web/templates/registration/activate.html:6
-#: web/templates/registration/activation_complete.html:5
+#: web/templates/registration/activate.html:7
+#: web/templates/registration/activation_complete.html:6
 msgid "Your account has been activated! Enjoy using my.gpodder.org"
 msgstr "Dein Konto wurde aktiviert! Viel Spa mit my.gpodder.org"
 
-#: web/templates/registration/activate.html:8
+#: web/templates/registration/activate.html:9
 msgid "Account not activated"
 msgstr "Konto nicht aktiviert"
 
-#: web/templates/registration/activate.html:9
+#: web/templates/registration/activate.html:10
 msgid "Your account could not be activated successfully."
 msgstr "Dein Konto konnte nicht erfolgreich aktiviert werden."
 
-#: web/templates/registration/registration_complete.html:4
+#: web/templates/registration/registration_complete.html:5
 msgid "Registration complete"
 msgstr "Registrierung abgeschlossen"
 
-#: web/templates/registration/registration_complete.html:5
+#: web/templates/registration/registration_complete.html:6
 msgid ""
 "Please confirm your account using the email you should just have recieved."
 msgstr ""
 "Bitte besttige dein Konto mit Hilfe der Email, die du gerade erhlaten hast."
 
-#: web/templates/registration/registration_form.html:4
+#: web/templates/registration/registration_form.html:5
 msgid "Create a User Account"
 msgstr "Erstelle ein Benutzer-Konto"
 
diff --git a/mygpo/locale/en/LC_MESSAGES/django.po b/mygpo/locale/en/LC_MESSAGES/django.po
index c14a49e..411cbc8 100644
--- a/mygpo/locale/en/LC_MESSAGES/django.po
+++ b/mygpo/locale/en/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-07 16:18+0100\n"
+"POT-Creation-Date: 2010-01-10 13:06+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -16,7 +16,7 @@ msgstr ""
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: api/models.py:167
+#: api/models.py:187
 #, python-format
 msgid "Unnamed Device (%s)"
 msgstr ""
@@ -41,21 +41,21 @@ msgstr ""
 msgid "What UID is configured on the pysical device?"
 msgstr ""
 
-#: web/views.py:103
+#: web/views.py:109
 msgid "With which client do you want to subscribe?"
 msgstr ""
 
-#: web/views.py:168
+#: web/views.py:174
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr ""
 
-#: web/views.py:194
+#: web/views.py:200
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr ""
 
-#: web/views.py:208
+#: web/views.py:214
 msgid "Synchronize with the following devices"
 msgstr ""
 
@@ -109,6 +109,16 @@ msgstr ""
 msgid "For podcast authors"
 msgstr ""
 
+#: web/templates/authors.html:8
+msgid ""
+"You can paste this code on your website, so users of mygpo can directly "
+"subscribe to your podcast!"
+msgstr ""
+
+#: web/templates/authors.html:9
+msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
+msgstr ""
+
 #: web/templates/device.html:9
 msgid "Podcasts"
 msgstr ""
@@ -117,7 +127,7 @@ msgstr ""
 msgid "You have subscribed the following podcasts on this device"
 msgstr ""
 
-#: web/templates/device.html:14 web/templates/podcast.html:37
+#: web/templates/device.html:14 web/templates/podcast.html:56
 msgid "Title"
 msgstr ""
 
@@ -182,7 +192,7 @@ msgstr ""
 msgid "Why Unnamed Episode?"
 msgstr ""
 
-#: web/templates/episode.html:41 web/templates/podcast.html:80
+#: web/templates/episode.html:41 web/templates/podcast.html:99
 #: web/templates/subscribe.html:24
 msgid ""
 "Because we display names after we have fetched the information form the feed "
@@ -190,6 +200,31 @@ msgid ""
 "simply be called this way."
 msgstr ""
 
+#: web/templates/history.html:6 web/templates/podcast.html:74
+msgid "Subscription History"
+msgstr ""
+
+#: web/templates/history.html:11 web/templates/podcast.html:77
+msgid "Timestamp"
+msgstr ""
+
+#: web/templates/history.html:12 web/templates/podcast.html:78
+msgid "Action"
+msgstr ""
+
+#: web/templates/history.html:13 web/templates/podcast.html:29
+#: web/templates/podcast.html.py:79
+msgid "Devices"
+msgstr ""
+
+#: web/templates/history.html:20 web/templates/podcast.html:86
+msgid "subscribe"
+msgstr ""
+
+#: web/templates/history.html:23 web/templates/podcast.html:89
+msgid "unsubscribe"
+msgstr ""
+
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
 msgstr ""
@@ -236,25 +271,25 @@ msgstr ""
 msgid "We are currently tracking %(podcast_count)s Podcasts!"
 msgstr ""
 
-#: web/templates/home.html:20 web/templates/login.html:14
+#: web/templates/home.html:20 web/templates/login.html:15
 msgid "Not yet a member?"
 msgstr ""
 
-#: web/templates/home.html:20 web/templates/login.html:14
+#: web/templates/home.html:20 web/templates/login.html:15
 msgid "Register!"
 msgstr ""
 
-#: web/templates/migrate.html:5
+#: web/templates/migrate.html:6
 msgid ""
 "The new my.gpodder.org uses usernames instead of email addresses. Based on "
 "your email address, we think you might like "
 msgstr ""
 
-#: web/templates/migrate.html:5
+#: web/templates/migrate.html:6
 msgid ", but you can change that if you want to."
 msgstr ""
 
-#: web/templates/migrate.html:11
+#: web/templates/migrate.html:12
 msgid ""
 "You can keep your old user settings in gPodder. Once the next version (with "
 "lots of new features) is release, you'll have to replace your email address "
@@ -265,56 +300,41 @@ msgstr ""
 msgid "Unnamed Podcast"
 msgstr ""
 
-#: web/templates/podcast.html:17 web/templates/subscribe.html:7
+#: web/templates/podcast.html:20 web/templates/subscribe.html:7
 #, python-format
 msgid "Subscribe to %(podcasttitle)s"
 msgstr ""
 
-#: web/templates/podcast.html:19 web/templates/subscribe.html:9
+#: web/templates/podcast.html:22 web/templates/subscribe.html:9
 msgid "Subscribe to this podcast"
 msgstr ""
 
-#: web/templates/podcast.html:23 web/templates/podcast.html.py:60
-msgid "Devices"
-msgstr ""
-
-#: web/templates/podcast.html:24
+#: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr ""
 
-#: web/templates/podcast.html:33
-msgid "Episodes"
+#: web/templates/podcast.html:41
+#, python-format
+msgid "Subscribe to %(podcasttitle)s on other devices"
 msgstr ""
 
-#: web/templates/podcast.html:38
-msgid "Description"
+#: web/templates/podcast.html:43
+msgid "Subscribe to this podcast on other devices"
 msgstr ""
 
-#: web/templates/podcast.html:39
-msgid "Released"
+#: web/templates/podcast.html:52
+msgid "Episodes"
 msgstr ""
 
-#: web/templates/podcast.html:55
-msgid "Subscription History"
+#: web/templates/podcast.html:57
+msgid "Description"
 msgstr ""
 
 #: web/templates/podcast.html:58
-msgid "Timestamp"
-msgstr ""
-
-#: web/templates/podcast.html:59
-msgid "Action"
-msgstr ""
-
-#: web/templates/podcast.html:67
-msgid "subscribe"
-msgstr ""
-
-#: web/templates/podcast.html:70
-msgid "unsubscribe"
+msgid "Released"
 msgstr ""
 
-#: web/templates/podcast.html:80 web/templates/subscribe.html:24
+#: web/templates/podcast.html:99 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
 msgstr ""
 
@@ -356,34 +376,34 @@ msgstr ""
 msgid "Subscribers"
 msgstr ""
 
-#: web/templates/registration/activate.html:5
-#: web/templates/registration/activation_complete.html:4
+#: web/templates/registration/activate.html:6
+#: web/templates/registration/activation_complete.html:5
 msgid "Account activated"
 msgstr ""
 
-#: web/templates/registration/activate.html:6
-#: web/templates/registration/activation_complete.html:5
+#: web/templates/registration/activate.html:7
+#: web/templates/registration/activation_complete.html:6
 msgid "Your account has been activated! Enjoy using my.gpodder.org"
 msgstr ""
 
-#: web/templates/registration/activate.html:8
+#: web/templates/registration/activate.html:9
 msgid "Account not activated"
 msgstr ""
 
-#: web/templates/registration/activate.html:9
+#: web/templates/registration/activate.html:10
 msgid "Your account could not be activated successfully."
 msgstr ""
 
-#: web/templates/registration/registration_complete.html:4
+#: web/templates/registration/registration_complete.html:5
 msgid "Registration complete"
 msgstr ""
 
-#: web/templates/registration/registration_complete.html:5
+#: web/templates/registration/registration_complete.html:6
 msgid ""
 "Please confirm your account using the email you should just have recieved."
 msgstr ""
 
-#: web/templates/registration/registration_form.html:4
+#: web/templates/registration/registration_form.html:5
 msgid "Create a User Account"
 msgstr ""
 
diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
index e17e2ba..411cbc8 100644
--- a/mygpo/locale/it/LC_MESSAGES/django.po
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-07 17:15+0100\n"
+"POT-Creation-Date: 2010-01-10 13:06+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -16,7 +16,7 @@ msgstr ""
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: api/models.py:167
+#: api/models.py:187
 #, python-format
 msgid "Unnamed Device (%s)"
 msgstr ""
@@ -41,24 +41,58 @@ msgstr ""
 msgid "What UID is configured on the pysical device?"
 msgstr ""
 
-#: web/views.py:103
+#: web/views.py:109
 msgid "With which client do you want to subscribe?"
 msgstr ""
 
-#: web/views.py:168
+#: web/views.py:174
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr ""
 
-#: web/views.py:194
+#: web/views.py:200
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr ""
 
-#: web/views.py:208
+#: web/views.py:214
 msgid "Synchronize with the following devices"
 msgstr ""
 
+#: web/templates/400.html:4
+msgid "Bad request"
+msgstr ""
+
+#: web/templates/400.html:5
+msgid "There has been an error processing your request."
+msgstr ""
+
+#: web/templates/401.html:4
+msgid "Unauthorized"
+msgstr ""
+
+#: web/templates/401.html:5
+msgid "This page is only available to registered users."
+msgstr ""
+
+#: web/templates/404.html:4
+msgid "Not found"
+msgstr ""
+
+#: web/templates/404.html:5
+msgid "The requested document could not be found."
+msgstr ""
+
+#: web/templates/500.html:4
+msgid "Internal Server Error"
+msgstr ""
+
+#: web/templates/500.html:5
+msgid ""
+"An error occured while processing your request. An e-mail with the error "
+"description has been sent to the developers."
+msgstr ""
+
 #: web/templates/account.html:5
 msgid "Account Settings"
 msgstr ""
@@ -93,7 +127,7 @@ msgstr ""
 msgid "You have subscribed the following podcasts on this device"
 msgstr ""
 
-#: web/templates/device.html:14 web/templates/podcast.html:37
+#: web/templates/device.html:14 web/templates/podcast.html:56
 msgid "Title"
 msgstr ""
 
@@ -158,7 +192,7 @@ msgstr ""
 msgid "Why Unnamed Episode?"
 msgstr ""
 
-#: web/templates/episode.html:41 web/templates/podcast.html:80
+#: web/templates/episode.html:41 web/templates/podcast.html:99
 #: web/templates/subscribe.html:24
 msgid ""
 "Because we display names after we have fetched the information form the feed "
@@ -166,6 +200,31 @@ msgid ""
 "simply be called this way."
 msgstr ""
 
+#: web/templates/history.html:6 web/templates/podcast.html:74
+msgid "Subscription History"
+msgstr ""
+
+#: web/templates/history.html:11 web/templates/podcast.html:77
+msgid "Timestamp"
+msgstr ""
+
+#: web/templates/history.html:12 web/templates/podcast.html:78
+msgid "Action"
+msgstr ""
+
+#: web/templates/history.html:13 web/templates/podcast.html:29
+#: web/templates/podcast.html.py:79
+msgid "Devices"
+msgstr ""
+
+#: web/templates/history.html:20 web/templates/podcast.html:86
+msgid "subscribe"
+msgstr ""
+
+#: web/templates/history.html:23 web/templates/podcast.html:89
+msgid "unsubscribe"
+msgstr ""
+
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
 msgstr ""
@@ -212,25 +271,25 @@ msgstr ""
 msgid "We are currently tracking %(podcast_count)s Podcasts!"
 msgstr ""
 
-#: web/templates/home.html:20 web/templates/login.html:14
+#: web/templates/home.html:20 web/templates/login.html:15
 msgid "Not yet a member?"
 msgstr ""
 
-#: web/templates/home.html:20 web/templates/login.html:14
+#: web/templates/home.html:20 web/templates/login.html:15
 msgid "Register!"
 msgstr ""
 
-#: web/templates/migrate.html:5
+#: web/templates/migrate.html:6
 msgid ""
 "The new my.gpodder.org uses usernames instead of email addresses. Based on "
 "your email address, we think you might like "
 msgstr ""
 
-#: web/templates/migrate.html:5
+#: web/templates/migrate.html:6
 msgid ", but you can change that if you want to."
 msgstr ""
 
-#: web/templates/migrate.html:11
+#: web/templates/migrate.html:12
 msgid ""
 "You can keep your old user settings in gPodder. Once the next version (with "
 "lots of new features) is release, you'll have to replace your email address "
@@ -241,56 +300,41 @@ msgstr ""
 msgid "Unnamed Podcast"
 msgstr ""
 
-#: web/templates/podcast.html:17 web/templates/subscribe.html:7
+#: web/templates/podcast.html:20 web/templates/subscribe.html:7
 #, python-format
 msgid "Subscribe to %(podcasttitle)s"
 msgstr ""
 
-#: web/templates/podcast.html:19 web/templates/subscribe.html:9
+#: web/templates/podcast.html:22 web/templates/subscribe.html:9
 msgid "Subscribe to this podcast"
 msgstr ""
 
-#: web/templates/podcast.html:23 web/templates/podcast.html.py:60
-msgid "Devices"
-msgstr ""
-
-#: web/templates/podcast.html:24
+#: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr ""
 
-#: web/templates/podcast.html:33
-msgid "Episodes"
+#: web/templates/podcast.html:41
+#, python-format
+msgid "Subscribe to %(podcasttitle)s on other devices"
 msgstr ""
 
-#: web/templates/podcast.html:38
-msgid "Description"
+#: web/templates/podcast.html:43
+msgid "Subscribe to this podcast on other devices"
 msgstr ""
 
-#: web/templates/podcast.html:39
-msgid "Released"
+#: web/templates/podcast.html:52
+msgid "Episodes"
 msgstr ""
 
-#: web/templates/podcast.html:55
-msgid "Subscription History"
+#: web/templates/podcast.html:57
+msgid "Description"
 msgstr ""
 
 #: web/templates/podcast.html:58
-msgid "Timestamp"
-msgstr ""
-
-#: web/templates/podcast.html:59
-msgid "Action"
-msgstr ""
-
-#: web/templates/podcast.html:67
-msgid "subscribe"
-msgstr ""
-
-#: web/templates/podcast.html:70
-msgid "unsubscribe"
+msgid "Released"
 msgstr ""
 
-#: web/templates/podcast.html:80 web/templates/subscribe.html:24
+#: web/templates/podcast.html:99 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
 msgstr ""
 
@@ -332,34 +376,34 @@ msgstr ""
 msgid "Subscribers"
 msgstr ""
 
-#: web/templates/registration/activate.html:5
-#: web/templates/registration/activation_complete.html:4
+#: web/templates/registration/activate.html:6
+#: web/templates/registration/activation_complete.html:5
 msgid "Account activated"
 msgstr ""
 
-#: web/templates/registration/activate.html:6
-#: web/templates/registration/activation_complete.html:5
+#: web/templates/registration/activate.html:7
+#: web/templates/registration/activation_complete.html:6
 msgid "Your account has been activated! Enjoy using my.gpodder.org"
 msgstr ""
 
-#: web/templates/registration/activate.html:8
+#: web/templates/registration/activate.html:9
 msgid "Account not activated"
 msgstr ""
 
-#: web/templates/registration/activate.html:9
+#: web/templates/registration/activate.html:10
 msgid "Your account could not be activated successfully."
 msgstr ""
 
-#: web/templates/registration/registration_complete.html:4
+#: web/templates/registration/registration_complete.html:5
 msgid "Registration complete"
 msgstr ""
 
-#: web/templates/registration/registration_complete.html:5
+#: web/templates/registration/registration_complete.html:6
 msgid ""
 "Please confirm your account using the email you should just have recieved."
 msgstr ""
 
-#: web/templates/registration/registration_form.html:4
+#: web/templates/registration/registration_form.html:5
 msgid "Create a User Account"
 msgstr ""
 
diff --git a/mygpo/locale/nb/LC_MESSAGES/django.po b/mygpo/locale/nb/LC_MESSAGES/django.po
index ce2a53f..04d7bf0 100644
--- a/mygpo/locale/nb/LC_MESSAGES/django.po
+++ b/mygpo/locale/nb/LC_MESSAGES/django.po
@@ -6,7 +6,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: 2.1\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-07 17:15+0100\n"
+"POT-Creation-Date: 2010-01-10 13:06+0100\n"
 "PO-Revision-Date: 2010-01-06 11:48+0100\n"
 "Last-Translator: Jim Nygrd <jim@nygard.priv.no>\n"
 "Language-Team: gpodder <>\n"
@@ -17,7 +17,7 @@ msgstr ""
 "Plural-Forms: nplurals=2; plural=(n != 1);\n"
 "X-Generator: Virtaal 0.3.1\n"
 
-#: api/models.py:167
+#: api/models.py:187
 #, python-format
 msgid "Unnamed Device (%s)"
 msgstr "Enhet uten navn (%s)"
@@ -42,24 +42,58 @@ msgstr "Hva slags enhet er dette?"
 msgid "What UID is configured on the pysical device?"
 msgstr "Hvilken UID er konfigurert p den fysiske enheten?"
 
-#: web/views.py:103
+#: web/views.py:109
 msgid "With which client do you want to subscribe?"
 msgstr "Med hvilken klient vil du abonnere?"
 
-#: web/views.py:168
+#: web/views.py:174
 #, python-format
 msgid "my.gpodder.org - Top %s"
 msgstr "my.gpodder.org - Topp %s"
 
-#: web/views.py:194
+#: web/views.py:200
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
 msgstr "my.gpodder.org - %s Forslag"
 
-#: web/views.py:208
+#: web/views.py:214
 msgid "Synchronize with the following devices"
 msgstr "Synkroniser med disse enhetene"
 
+#: web/templates/400.html:4
+msgid "Bad request"
+msgstr ""
+
+#: web/templates/400.html:5
+msgid "There has been an error processing your request."
+msgstr ""
+
+#: web/templates/401.html:4
+msgid "Unauthorized"
+msgstr ""
+
+#: web/templates/401.html:5
+msgid "This page is only available to registered users."
+msgstr ""
+
+#: web/templates/404.html:4
+msgid "Not found"
+msgstr ""
+
+#: web/templates/404.html:5
+msgid "The requested document could not be found."
+msgstr ""
+
+#: web/templates/500.html:4
+msgid "Internal Server Error"
+msgstr ""
+
+#: web/templates/500.html:5
+msgid ""
+"An error occured while processing your request. An e-mail with the error "
+"description has been sent to the developers."
+msgstr ""
+
 #: web/templates/account.html:5
 msgid "Account Settings"
 msgstr "Kontoinnstillinger"
@@ -94,7 +128,7 @@ msgstr "Podcaster"
 msgid "You have subscribed the following podcasts on this device"
 msgstr "Du abonnerer p flgende podcaster p denne enheten"
 
-#: web/templates/device.html:14 web/templates/podcast.html:37
+#: web/templates/device.html:14 web/templates/podcast.html:56
 msgid "Title"
 msgstr "Tittel"
 
@@ -163,7 +197,7 @@ msgstr "Hvor"
 msgid "Why Unnamed Episode?"
 msgstr "Episoden uten navn?"
 
-#: web/templates/episode.html:41 web/templates/podcast.html:80
+#: web/templates/episode.html:41 web/templates/podcast.html:99
 #: web/templates/subscribe.html:24
 msgid ""
 "Because we display names after we have fetched the information form the feed "
@@ -173,6 +207,31 @@ msgstr ""
 "Fordi vi viser navnene etter  ha hentet informasjonen i strmmen, dette kan "
 "ta litt tid. I mellomtiden vil podcasten vises uten navn."
 
+#: web/templates/history.html:6 web/templates/podcast.html:74
+msgid "Subscription History"
+msgstr "Abonnementshistorikk"
+
+#: web/templates/history.html:11 web/templates/podcast.html:77
+msgid "Timestamp"
+msgstr "Tidspunkt"
+
+#: web/templates/history.html:12 web/templates/podcast.html:78
+msgid "Action"
+msgstr "Handling"
+
+#: web/templates/history.html:13 web/templates/podcast.html:29
+#: web/templates/podcast.html.py:79
+msgid "Devices"
+msgstr "Enheter"
+
+#: web/templates/history.html:20 web/templates/podcast.html:86
+msgid "subscribe"
+msgstr "abonner"
+
+#: web/templates/history.html:23 web/templates/podcast.html:89
+msgid "unsubscribe"
+msgstr "avslutt abonnement"
+
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
 msgstr "my.gpodder.org"
@@ -226,15 +285,15 @@ msgstr ""
 msgid "We are currently tracking %(podcast_count)s Podcasts!"
 msgstr "Vi flger for yeblikket %(podcast_count)s podcaster!"
 
-#: web/templates/home.html:20 web/templates/login.html:14
+#: web/templates/home.html:20 web/templates/login.html:15
 msgid "Not yet a member?"
 msgstr "Ikke medlem enn?"
 
-#: web/templates/home.html:20 web/templates/login.html:14
+#: web/templates/home.html:20 web/templates/login.html:15
 msgid "Register!"
 msgstr "Registrer!"
 
-#: web/templates/migrate.html:5
+#: web/templates/migrate.html:6
 msgid ""
 "The new my.gpodder.org uses usernames instead of email addresses. Based on "
 "your email address, we think you might like "
@@ -242,11 +301,11 @@ msgstr ""
 "Den nye my.gpodder.org bruker brukernavn i stedet for e-postadresse. Basert "
 "p din e-postadresse foreslr vi "
 
-#: web/templates/migrate.html:5
+#: web/templates/migrate.html:6
 msgid ", but you can change that if you want to."
 msgstr ", men du kan endre dette hvis du nsker."
 
-#: web/templates/migrate.html:11
+#: web/templates/migrate.html:12
 msgid ""
 "You can keep your old user settings in gPodder. Once the next version (with "
 "lots of new features) is release, you'll have to replace your email address "
@@ -260,56 +319,42 @@ msgstr ""
 msgid "Unnamed Podcast"
 msgstr "Podcast uten navn"
 
-#: web/templates/podcast.html:17 web/templates/subscribe.html:7
+#: web/templates/podcast.html:20 web/templates/subscribe.html:7
 #, python-format
 msgid "Subscribe to %(podcasttitle)s"
 msgstr "Abonner p %(podcasttitle)s"
 
-#: web/templates/podcast.html:19 web/templates/subscribe.html:9
+#: web/templates/podcast.html:22 web/templates/subscribe.html:9
 msgid "Subscribe to this podcast"
 msgstr "Abonner p denne podcasten"
 
-#: web/templates/podcast.html:23 web/templates/podcast.html.py:60
-msgid "Devices"
-msgstr "Enheter"
-
-#: web/templates/podcast.html:24
+#: web/templates/podcast.html:30
 msgid "You have subscribed this podcast on"
 msgstr "Du abonnerer p denne podcasten p"
 
-#: web/templates/podcast.html:33
+#: web/templates/podcast.html:41
+#, fuzzy, python-format
+msgid "Subscribe to %(podcasttitle)s on other devices"
+msgstr "Abonner p %(podcasttitle)s"
+
+#: web/templates/podcast.html:43
+#, fuzzy
+msgid "Subscribe to this podcast on other devices"
+msgstr "Abonner p denne podcasten"
+
+#: web/templates/podcast.html:52
 msgid "Episodes"
 msgstr "Episoder"
 
-#: web/templates/podcast.html:38
+#: web/templates/podcast.html:57
 msgid "Description"
 msgstr "Beskrivelse"
 
-#: web/templates/podcast.html:39
+#: web/templates/podcast.html:58
 msgid "Released"
 msgstr "Utgitt"
 
-#: web/templates/podcast.html:55
-msgid "Subscription History"
-msgstr "Abonnementshistorikk"
-
-#: web/templates/podcast.html:58
-msgid "Timestamp"
-msgstr "Tidspunkt"
-
-#: web/templates/podcast.html:59
-msgid "Action"
-msgstr "Handling"
-
-#: web/templates/podcast.html:67
-msgid "subscribe"
-msgstr "abonner"
-
-#: web/templates/podcast.html:70
-msgid "unsubscribe"
-msgstr "avslutt abonnement"
-
-#: web/templates/podcast.html:80 web/templates/subscribe.html:24
+#: web/templates/podcast.html:99 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
 msgstr "Podcast uten navn?"
 
@@ -351,34 +396,34 @@ msgstr "Forrige uke"
 msgid "Subscribers"
 msgstr "Abonnenter"
 
-#: web/templates/registration/activate.html:5
-#: web/templates/registration/activation_complete.html:4
+#: web/templates/registration/activate.html:6
+#: web/templates/registration/activation_complete.html:5
 msgid "Account activated"
 msgstr "Konto aktivert"
 
-#: web/templates/registration/activate.html:6
-#: web/templates/registration/activation_complete.html:5
+#: web/templates/registration/activate.html:7
+#: web/templates/registration/activation_complete.html:6
 msgid "Your account has been activated! Enjoy using my.gpodder.org"
 msgstr "Kontoen er aktivert! Velkommen til my.gpodder.org"
 
-#: web/templates/registration/activate.html:8
+#: web/templates/registration/activate.html:9
 msgid "Account not activated"
 msgstr "Kontoen er ikke aktivert"
 
-#: web/templates/registration/activate.html:9
+#: web/templates/registration/activate.html:10
 msgid "Your account could not be activated successfully."
 msgstr "Kontoen kunne ikke aktiveres."
 
-#: web/templates/registration/registration_complete.html:4
+#: web/templates/registration/registration_complete.html:5
 msgid "Registration complete"
 msgstr "Du er n registert"
 
-#: web/templates/registration/registration_complete.html:5
+#: web/templates/registration/registration_complete.html:6
 msgid ""
 "Please confirm your account using the email you should just have recieved."
 msgstr "Du m bekrefte kontoen med e-posten du n skal ha mottatt."
 
-#: web/templates/registration/registration_form.html:4
+#: web/templates/registration/registration_form.html:5
 msgid "Create a User Account"
 msgstr "Opprett en brukerkonto"
 

commit 6b55985bd0625179db35e7ab0b2a060810879276
Merge: da3854c... ff73074...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Jan 8 18:31:54 2010 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit da3854c42faf33357db4f24740a7bf7fdfc2bdae
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Jan 8 18:26:47 2010 +0100

    subscribe to podc despite extisting subscriptions
    
    previously the podcast view /podcast/<id> showed either a list of subscribed
    devices or a link for subscribing.
    
    Now the subscribe-link is always shown if there is a device on which the
    podcast is not yet subscribed.

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 30a510a..29a919d 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -140,3 +140,9 @@ div.rate
     padding-top: 2em;
     padding-bottom: 3em;
 }
+
+div.subscribe
+{
+    padding: 1em 0 1em 0;
+}
+
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index d9bc048..b278f24 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -74,6 +74,26 @@ class Podcast(models.Model):
     def logo_shortname(self):
         return hashlib.sha1(self.logo_url).hexdigest()
 
+    def subscribe_targets(self, user):
+        """
+        returns all Devices and SyncGroups on which this podcast can be subsrbied. This excludes all
+        devices/syncgroups on which the podcast is already subscribed
+        """
+        targets = []
+
+        devices = Device.objects.filter(user=user)
+        for d in devices:
+            subscriptions = [x.podcast for x in d.get_subscriptions()]
+            if self in subscriptions: continue
+
+            if d.sync_group:
+                if not d.sync_group in targets: targets.append(d.sync_group)
+            else:
+                targets.append(d)
+
+        return targets
+
+
     def __unicode__(self):
         return self.title if self.title != '' else self.url
 
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index 1fdb345..33989e3 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -12,21 +12,40 @@
   {% endif %}
 
   {% if devices|length_is:"0" %}
-   <a href="/podcast/{{ podcast.id }}/subscribe">
-    {% if podcast.title %}
-     {% blocktrans with podcast.title as podcasttitle %}Subscribe to {{ podcasttitle }}{% endblocktrans %}
-    {% else %}
-     {% trans "Subscribe to this podcast" %}
-    {% endif %}
-   </a>
+
+   {% if can_subscribe %}
+    <div class="subscribe">
+     <a href="/podcast/{{ podcast.id }}/subscribe">
+      {% if podcast.title %}
+       {% blocktrans with podcast.title as podcasttitle %}Subscribe to {{ podcasttitle }}{% endblocktrans %}
+      {% else %}
+       {% trans "Subscribe to this podcast" %}
+      {% endif %}
+     </a>
+    </div>
+   {% endif %}
+
   {% else %}
    <h2>Devices</h2>
    <strong>You have subscribed this podcast on</strong>
    <ul class="devices">
    {% for device in devices %}
-    <li class="{{device.type}}"><a href="/device/{{ device.id }}">{{ device.name }}</a></li>
+    <li class="{{device.type}}"><a href="/device/{{ device.id }}">{{ device }}</a></li>
    {% endfor %}
    </ul>
+
+   {% if can_subscribe %}
+    <div class="subscribe">
+     <a href="/podcast/{{ podcast.id }}/subscribe">
+      {% if podcast.title %}
+       {% blocktrans with podcast.title as podcasttitle %}Subscribe to {{ podcasttitle }} on other devices{% endblocktrans %}
+      {% else %}
+       {% trans "Subscribe to this podcast on other devices" %}
+      {% endif %}
+     </a>
+    </div>
+   {% endif %}
+
   {% endif %}
 
   {% if not episodes|length_is:"0" %}
diff --git a/mygpo/web/templates/subscribe.html b/mygpo/web/templates/subscribe.html
index 1c81092..900e68b 100644
--- a/mygpo/web/templates/subscribe.html
+++ b/mygpo/web/templates/subscribe.html
@@ -17,7 +17,7 @@
 
   <form action="" method="post">
    {{ form.as_p }}
-   <input type="submit" label="{% trans "OK" %}" />
+   <input type="submit" value="{% trans "OK" %}" />
   </form>
 
   {% if not podcast.title %}
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 3cf7a1f..686a4cd 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -67,11 +67,13 @@ def podcast(request, pid):
     devices = Device.objects.filter(user=request.user)
     history = SubscriptionAction.objects.filter(podcast=podcast,device__in=devices).order_by('-timestamp')
     subscribed_devices = [s.device for s in Subscription.objects.filter(podcast=podcast,user=request.user)]
+    subscribe_targets = podcast.subscribe_targets(request.user)
     episodes = episode_list(podcast, request.user)
     return render_to_response('podcast.html', {
         'history': history,
         'podcast': podcast,
         'devices': subscribed_devices,
+        'can_subscribe': len(subscribe_targets) > 0,
         'episodes': episodes,
     }, context_instance=RequestContext(request))
 
@@ -101,9 +103,7 @@ def podcast_subscribe(request, pid):
         return HttpResponseRedirect('/podcast/%s' % podcast.id)
 
     else:
-        targets = list(Device.objects.filter(user=request.user, sync_group=None))
-        groups = SyncGroup.objects.filter(user=request.user)
-        targets.extend( list(groups) )
+        targets = podcast.subscribe_targets(request.user)
 
         form = SyncForm()
         form.set_targets(targets, _('With which client do you want to subscribe?'))

commit ff73074ea81910d968c2f836fe8cbcf3f5bdd968
Merge: 6a09890... 9eec849...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Jan 7 19:29:59 2010 +0100

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit 6a09890971df63eff18ded70b08e947c7eced7eb
Merge: 68fc519... be365c7...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Jan 7 19:28:39 2010 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src
    
    Conflicts:
    	mygpo/web/templates/login.html

commit be365c74b30b6f3e3786d222933f0cfc05d7b75d
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Jan 7 17:25:30 2010 +0100

    Translation: German

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index b665ba2..772f5be 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-05 23:28+0100\n"
+"POT-Creation-Date: 2010-01-07 17:15+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -19,65 +19,82 @@ msgstr ""
 #: api/models.py:167
 #, python-format
 msgid "Unnamed Device (%s)"
-msgstr ""
+msgstr "Unbenanntes Gert (%s)"
 
 #: web/forms.py:7
 msgid "Your Email Address"
-msgstr ""
+msgstr "Deine Email Adresse"
 
 #: web/forms.py:8
 msgid "May we use your subscriptions for the toplist and suggestions?"
-msgstr ""
+msgstr "Drfen wir deine Abonnements fr die Berechnung der Topliste und "
+"Empfehlungen verwenden?"
 
 #: web/forms.py:11
 msgid "Name of this device"
-msgstr ""
+msgstr "Name dieses Gertes"
 
 #: web/forms.py:12
 msgid "What kind of device is this?"
-msgstr ""
+msgstr "Welcher Art ist dieses Gert?"
 
 #: web/forms.py:13
 msgid "What UID is configured on the pysical device?"
-msgstr ""
+msgstr "Welche UID besitzt das physikalische Gert?"
 
 #: web/views.py:103
 msgid "With which client do you want to subscribe?"
-msgstr ""
+msgstr "Auf welchem Benutzer willst du aboonieren?"
 
 #: web/views.py:168
 #, python-format
 msgid "my.gpodder.org - Top %s"
-msgstr ""
+msgstr "my.gpodder.org - Top %s"
 
 #: web/views.py:194
 #, python-format
 msgid "my.gpodder.org - %s Suggestions"
-msgstr ""
+msgstr "my.gpodder.org - %s Empfehlungen"
 
 #: web/views.py:208
 msgid "Synchronize with the following devices"
-msgstr ""
+msgstr "Synchronisierung der folgenden Gerte"
 
 #: web/templates/account.html:5
 msgid "Account Settings"
-msgstr ""
+msgstr "Konto-Einstellungen"
 
 #: web/templates/account.html:8 web/templates/device.html:50
 msgid "Your settings have been saved."
-msgstr ""
+msgstr "Ihre Einstellungen wurden gespeichert."
 
 #: web/templates/account.html:11
 msgid "Update the settings for your account"
+msgstr "Aktualisierung der Konto-Einstellungen"
+
+#: web/templates/authors.html:5
+msgid "For podcast authors"
+msgstr "Fr die Podcast-Autoren"
+
+#: web/templates/authors.html:8
+msgid ""
+"You can paste this code on your website, so users of mygpo can directly "
+"subscribe to your podcast!"
 msgstr ""
+"Du kannst diesen Code auf deine Webseite geben, damit die Benutzer von mygpo "
+"direkt deinen Podcast abonnieren knnen!"
+
+#: web/templates/authors.html:9
+msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
+msgstr "ndere YOUR_ADRESS in die Adresse deines Podcastes um."
 
 #: web/templates/device.html:9
 msgid "Podcasts"
-msgstr ""
+msgstr "Podcasts"
 
 #: web/templates/device.html:10
 msgid "You have subscribed the following podcasts on this device"
-msgstr ""
+msgstr "Du hast die folgenden Podcasts auf diesem Gert abonniert"
 
 #: web/templates/device.html:14 web/templates/podcast.html:37
 msgid "Title"
@@ -85,11 +102,11 @@ msgstr "Titel"
 
 #: web/templates/device.html:15
 msgid "Since"
-msgstr ""
+msgstr "seit"
 
 #: web/templates/device.html:27
 msgid "Synchronize"
-msgstr ""
+msgstr "Synchronisierung"
 
 #: web/templates/device.html:28
 msgid ""
@@ -97,25 +114,28 @@ msgid ""
 "podcast that is subscribed on one device, will automatically be added to all "
 "synchronized devices."
 msgstr ""
+"Falls du einige Gerte synchronisierst, werden auf diesen Gerten immer die "
+"selbenAbonnements vorhanden sein. Ein Podcast der auf einem Gert abonniert "
+"wurde, wird automatisch an alle synchronisierten Gerte weitergegeben."
 
 #: web/templates/device.html:32
 #, python-format
 msgid "%(devicename)s is currently not synchronized with other devices."
-msgstr ""
+msgstr "%(devicename)s wird zur Zeit mit keinem anderen Gert synchronisiert."
 
 #: web/templates/device.html:36
 #, python-format
 msgid "%(devicename)s is currently synchronized with %(synclist)s."
-msgstr ""
+msgstr "%(devicename)s wird zur Zeit mit %(synclist)s synchronisiert."
 
 #: web/templates/device.html:37
 #, python-format
 msgid "Stop synchronisation for %(devicename)s "
-msgstr ""
+msgstr "Beende die Synchronisation fr %(devicename)s "
 
 #: web/templates/device.html:44 web/templates/subscribe.html:20
 msgid "OK"
-msgstr ""
+msgstr "OK"
 
 #: web/templates/episode.html:7
 #, python-format
@@ -123,27 +143,27 @@ msgid ""
 "An episode of the <a href=\"/podcast/%(podcast_id)s\">%(podcast)s</a> "
 "podcast."
 msgstr ""
+"Eine Episode fr <a href=\"/podcast/%(podcast_id)s\">%(podcast)s</a> Podcast."
 
 #: web/templates/episode.html:22
-#, fuzzy
 msgid "Your Episode History"
-msgstr "Abonnementverlauf"
+msgstr "Dein Episoden Verlauf"
 
 #: web/templates/episode.html:25
 msgid "When"
-msgstr ""
+msgstr "Wann"
 
 #: web/templates/episode.html:26
 msgid "What"
-msgstr ""
+msgstr "Was"
 
 #: web/templates/episode.html:27
 msgid "Where"
-msgstr ""
+msgstr "Wo"
 
 #: web/templates/episode.html:41
 msgid "Why Unnamed Episode?"
-msgstr ""
+msgstr "Warum unbenannte Episoden?"
 
 #: web/templates/episode.html:41 web/templates/podcast.html:80
 #: web/templates/subscribe.html:24
@@ -152,10 +172,13 @@ msgid ""
 "-- and this may take some time. Until this is completed, the podcast will "
 "simply be called this way."
 msgstr ""
+"Da die Beschaffung der Namen und anderer Informationen etwas Zeit in "
+"Anspruch nehmen kann. Bis dies erledigt ist wird der Podcast auf diese Wiese "
+"dargestellt."
 
 #: web/templates/home-user.html:6
 msgid "my.gpodder.org"
-msgstr ""
+msgstr "my.gpodder.org"
 
 #: web/templates/home-user.html:9
 msgid "Your Subscriptions"
@@ -164,20 +187,19 @@ msgstr "Deine Abonnements"
 #: web/templates/home-user.html:13 web/templates/suggestions.html:17
 #: web/templates/toplist.html:13
 msgid "Podcast"
-msgstr ""
+msgstr "Podcast"
 
 #: web/templates/home-user.html:14
 msgid "Latest Episode"
 msgstr "Letzte Episode"
 
 #: web/templates/home-user.html:15
-#, fuzzy
 msgid "Subscribed on"
-msgstr "abonniert"
+msgstr "Abonniert auf"
 
 #: web/templates/home-user.html:37
 msgid "Where to start?"
-msgstr ""
+msgstr "Wie kannst du beginnen?"
 
 #: web/templates/home-user.html:38
 #, python-format
@@ -188,6 +210,12 @@ msgid ""
 "your username &ndash; <strong>%(username)s</strong> &ndash; and password and "
 "upload your podcasts. They will automatically show up here."
 msgstr ""
+"my.gpodder.org hilft dir deine Podcasts zu verwalten, welche du auf deinen "
+"Gerten - PC, Laptop, mobile Gerte, ... - abonniert hast. Zum Einstieg in "
+"my.gpodder.org installiere <a href=\"http://gpodder.org\">gPodder</a> mit "
+"deinem Benutzername &ndash; <strong>%(username)s</strong> &ndash; und deinem "
+"Passwort. Dann lade deine Podcasts rauf und sie werden automatisch hier "
+"angezeigt."
 
 #: web/templates/home.html:6
 msgid ""
@@ -234,16 +262,16 @@ msgstr ""
 
 #: web/templates/podcast.html:7
 msgid "Unnamed Podcast"
-msgstr ""
+msgstr "Unbenannter Podcast"
 
 #: web/templates/podcast.html:17 web/templates/subscribe.html:7
 #, python-format
 msgid "Subscribe to %(podcasttitle)s"
-msgstr ""
+msgstr "Abonniere %(podcasttitle)s"
 
 #: web/templates/podcast.html:19 web/templates/subscribe.html:9
 msgid "Subscribe to this podcast"
-msgstr ""
+msgstr "Abonniere diesen Podcast"
 
 #: web/templates/podcast.html:23 web/templates/podcast.html.py:60
 msgid "Devices"
@@ -251,21 +279,19 @@ msgstr "Gerte"
 
 #: web/templates/podcast.html:24
 msgid "You have subscribed this podcast on"
-msgstr ""
+msgstr "Dieser Podcast wurde abonniert am"
 
 #: web/templates/podcast.html:33
-#, fuzzy
 msgid "Episodes"
-msgstr "Letzte Episode"
+msgstr "Episoden"
 
 #: web/templates/podcast.html:38
-#, fuzzy
 msgid "Description"
-msgstr "Deine Abonnements"
+msgstr "Beschreibung"
 
 #: web/templates/podcast.html:39
 msgid "Released"
-msgstr ""
+msgstr "Verffentlicht"
 
 #: web/templates/podcast.html:55
 msgid "Subscription History"
@@ -289,138 +315,138 @@ msgstr "beendet"
 
 #: web/templates/podcast.html:80 web/templates/subscribe.html:24
 msgid "Why Unnamed Podcast?"
-msgstr ""
+msgstr "Warum unbenannte Podcasts?"
 
 #: web/templates/suggestions.html:10
 msgid "Suggested Podcasts"
-msgstr ""
+msgstr "Vorgeschlagene Podcasts"
 
 #: web/templates/suggestions.html:12
 #, python-format
 msgid "We've selected %(suggestion_count)s podcasts which you might like."
-msgstr ""
+msgstr "Es werden diese %(suggestion_count)s Podcasts vorgeschlagen."
 
 #: web/templates/suggestions.html:18
 msgid "URL"
-msgstr ""
+msgstr "URL"
 
 #: web/templates/suggestions.html:30
 msgid "Do you like our suggestions?"
-msgstr ""
+msgstr "Bist du mit den Empfehlungen zufrieden?"
 
 #: web/templates/toplist.html:5
 msgid "Toplist"
-msgstr ""
+msgstr "Topliste"
 
 #: web/templates/toplist.html:7
 #, python-format
 msgid "These are the %(count)s most subscribed podcasts."
-msgstr ""
+msgstr "Dies sind die %(count)s meist abonnierten Podcasts."
 
 #: web/templates/toplist.html:11
 msgid "#"
-msgstr ""
+msgstr "#"
 
 #: web/templates/toplist.html:12
 msgid "Last week"
-msgstr ""
+msgstr "Letzte Woche"
 
 #: web/templates/toplist.html:14
-#, fuzzy
 msgid "Subscribers"
-msgstr "abonniert"
+msgstr "Abonnenten"
 
 #: web/templates/registration/activate.html:5
 #: web/templates/registration/activation_complete.html:4
 msgid "Account activated"
-msgstr ""
+msgstr "Konto aktiviert"
 
 #: web/templates/registration/activate.html:6
 #: web/templates/registration/activation_complete.html:5
 msgid "Your account has been activated! Enjoy using my.gpodder.org"
-msgstr ""
+msgstr "Dein Konto wurde aktiviert! Viel Spa mit my.gpodder.org"
 
 #: web/templates/registration/activate.html:8
 msgid "Account not activated"
-msgstr ""
+msgstr "Konto nicht aktiviert"
 
 #: web/templates/registration/activate.html:9
 msgid "Your account could not be activated successfully."
-msgstr ""
+msgstr "Dein Konto konnte nicht erfolgreich aktiviert werden."
 
 #: web/templates/registration/registration_complete.html:4
 msgid "Registration complete"
-msgstr ""
+msgstr "Registrierung abgeschlossen"
 
 #: web/templates/registration/registration_complete.html:5
 msgid ""
 "Please confirm your account using the email you should just have recieved."
 msgstr ""
+"Bitte besttige dein Konto mit Hilfe der Email, die du gerade erhlaten hast."
 
 #: web/templates/registration/registration_form.html:4
 msgid "Create a User Account"
-msgstr ""
+msgstr "Erstelle ein Benutzer-Konto"
 
 #: web/templates/search/search.html:6
 msgid "Search"
-msgstr ""
+msgstr "Suche"
 
 #: web/templates/search/search.html:20
 msgid "Results"
-msgstr ""
+msgstr "Ergebnisse"
 
 #: web/templatetags/devices.py:11
 msgid "Desktop"
-msgstr ""
+msgstr "Desktop"
 
 #: web/templatetags/devices.py:13
 msgid "Laptop"
-msgstr ""
+msgstr "Laptop"
 
 #: web/templatetags/devices.py:15
 msgid "Mobile"
-msgstr ""
+msgstr "Handy"
 
 #: web/templatetags/devices.py:17
 msgid "Server"
-msgstr ""
+msgstr "Server"
 
 #: web/templatetags/devices.py:19
 msgid "Other"
-msgstr ""
+msgstr "Andere"
 
 #: web/templatetags/episodes.py:10
 msgid "This episode has not yet been played"
-msgstr ""
+msgstr "Diese Episode wurde noch nicht abgespielt"
 
 #: web/templatetags/episodes.py:13 web/templatetags/episodes.py:14
 #, python-format
 msgid " on %s"
-msgstr ""
+msgstr " an %s"
 
 #: web/templatetags/episodes.py:17
 msgid "This episode has been marked new"
-msgstr ""
+msgstr "Diese Episode wurde als neu markiert"
 
 #: web/templatetags/episodes.py:19
 msgid "This episode has been downloaded"
-msgstr ""
+msgstr "Diese Episode wurde heruntergeladen"
 
 #: web/templatetags/episodes.py:21
 msgid "This episode has been played"
-msgstr ""
+msgstr "Diese Episode wurde abgespielt"
 
 #: web/templatetags/episodes.py:23
 msgid "This episode has been deleted"
-msgstr ""
+msgstr "Diese Episode wurde gelscht"
 
 #: web/templatetags/podcasts.py:12
 msgid "Logo"
-msgstr ""
+msgstr "Logo"
 
 #: web/templatetags/podcasts.py:14
 msgid "No Logo available"
-msgstr ""
+msgstr "Kein Logo verfgbar"
 
 #~ msgid "back!"
 #~ msgstr "zurck!"
diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
index cbe8cb4..e17e2ba 100644
--- a/mygpo/locale/it/LC_MESSAGES/django.po
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-05 23:28+0100\n"
+"POT-Creation-Date: 2010-01-07 17:15+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -71,6 +71,20 @@ msgstr ""
 msgid "Update the settings for your account"
 msgstr ""
 
+#: web/templates/authors.html:5
+msgid "For podcast authors"
+msgstr ""
+
+#: web/templates/authors.html:8
+msgid ""
+"You can paste this code on your website, so users of mygpo can directly "
+"subscribe to your podcast!"
+msgstr ""
+
+#: web/templates/authors.html:9
+msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
+msgstr ""
+
 #: web/templates/device.html:9
 msgid "Podcasts"
 msgstr ""
diff --git a/mygpo/locale/nb/LC_MESSAGES/django.po b/mygpo/locale/nb/LC_MESSAGES/django.po
index 152ed35..ce2a53f 100644
--- a/mygpo/locale/nb/LC_MESSAGES/django.po
+++ b/mygpo/locale/nb/LC_MESSAGES/django.po
@@ -6,14 +6,14 @@ msgid ""
 msgstr ""
 "Project-Id-Version: 2.1\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2010-01-05 23:28+0100\n"
+"POT-Creation-Date: 2010-01-07 17:15+0100\n"
 "PO-Revision-Date: 2010-01-06 11:48+0100\n"
 "Last-Translator: Jim Nygrd <jim@nygard.priv.no>\n"
 "Language-Team: gpodder <>\n"
-"Language: nb\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
+"Language: nb\n"
 "Plural-Forms: nplurals=2; plural=(n != 1);\n"
 "X-Generator: Virtaal 0.3.1\n"
 
@@ -72,6 +72,20 @@ msgstr "Dine innstillinger er lagret."
 msgid "Update the settings for your account"
 msgstr "Oppdater innstillingene for kontoen din"
 
+#: web/templates/authors.html:5
+msgid "For podcast authors"
+msgstr ""
+
+#: web/templates/authors.html:8
+msgid ""
+"You can paste this code on your website, so users of mygpo can directly "
+"subscribe to your podcast!"
+msgstr ""
+
+#: web/templates/authors.html:9
+msgid "Change the field 'YOUR_ADRESS' with the adress of your podcast."
+msgstr ""
+
 #: web/templates/device.html:9
 msgid "Podcasts"
 msgstr "Podcaster"
diff --git a/mygpo/web/templates/authors.html b/mygpo/web/templates/authors.html
index 21c251f..667ccb3 100644
--- a/mygpo/web/templates/authors.html
+++ b/mygpo/web/templates/authors.html
@@ -5,8 +5,8 @@
   <h1>{% trans "For podcast authors" %}</h1>
 
   <p><img src="/media/subscribe.png" /></p>
-  <p>You can paste this code on your website, so users of mygpo can directly subscribe to your podcast!</p>
-  <p>Change the field "YOUR_ADRESS" with the adress of your podcast.</p>
+  <p>{% trans "You can paste this code on your website, so users of mygpo can directly subscribe to your podcast!" %}</p>
+  <p>{% trans "Change the field 'YOUR_ADRESS' with the adress of your podcast." %}</p>
   <p>
    <textarea cols="80" rows="1"><a href="http://my.gpodder.org/subscribe?url=YOUR_ADRESS"><img src="http://my.gpodder.org/media/subscribe.png" /></a></textarea>
   </p>
diff --git a/mygpo/web/templates/info.html b/mygpo/web/templates/info.html
index 8998f7a..032e654 100644
--- a/mygpo/web/templates/info.html
+++ b/mygpo/web/templates/info.html
@@ -1,4 +1,5 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 
 {% block content %}
diff --git a/mygpo/web/templates/login.html b/mygpo/web/templates/login.html
index 315062b..9b2eca3 100644
--- a/mygpo/web/templates/login.html
+++ b/mygpo/web/templates/login.html
@@ -1,4 +1,5 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
   <h1>Login</h1>
diff --git a/mygpo/web/templates/migrate.html b/mygpo/web/templates/migrate.html
index cf13b62..9b0f726 100644
--- a/mygpo/web/templates/migrate.html
+++ b/mygpo/web/templates/migrate.html
@@ -1,4 +1,5 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
   <h1>my.gpodder.org</h1>
diff --git a/mygpo/web/templates/registration/activate.html b/mygpo/web/templates/registration/activate.html
index 6d7beee..b8efa45 100644
--- a/mygpo/web/templates/registration/activate.html
+++ b/mygpo/web/templates/registration/activate.html
@@ -1,4 +1,5 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
   {% if account %}
diff --git a/mygpo/web/templates/registration/activation_complete.html b/mygpo/web/templates/registration/activation_complete.html
index 321cc35..f9d77d1 100644
--- a/mygpo/web/templates/registration/activation_complete.html
+++ b/mygpo/web/templates/registration/activation_complete.html
@@ -1,4 +1,5 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
   <h1>{% trans "Account activated" %}</h1>
diff --git a/mygpo/web/templates/registration/registration_complete.html b/mygpo/web/templates/registration/registration_complete.html
index 1ebfdd5..6ca2bbe 100644
--- a/mygpo/web/templates/registration/registration_complete.html
+++ b/mygpo/web/templates/registration/registration_complete.html
@@ -1,4 +1,5 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
   <h1>{% trans "Registration complete" %}</h1>
diff --git a/mygpo/web/templates/registration/registration_form.html b/mygpo/web/templates/registration/registration_form.html
index 567e6a0..4fa94a0 100644
--- a/mygpo/web/templates/registration/registration_form.html
+++ b/mygpo/web/templates/registration/registration_form.html
@@ -1,4 +1,5 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
   <h1>{% trans "Create a User Account" %}</h1>

commit 68fc5191b033c10bb0a5c547781b763b85deff96
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Jan 7 16:19:04 2010 +0100

    added english django.po

diff --git a/mygpo/locale/en/LC_MESSAGES/django.po b/mygpo/locale/en/LC_MESSAGES/django.po
new file mode 100644
index 0000000..c14a49e
--- /dev/null
+++ b/mygpo/locale/en/LC_MESSAGES/django.po
@@ -0,0 +1,449 @@
+# SOME DESCRIPTIVE TITLE.
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: PACKAGE VERSION\n"
+"Report-Msgid-Bugs-To: \n"
+"POT-Creation-Date: 2010-01-07 16:18+0100\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
+"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
+"Language-Team: LANGUAGE <LL@li.org>\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#: api/models.py:167
+#, python-format
+msgid "Unnamed Device (%s)"
+msgstr ""
+
+#: web/forms.py:7
+msgid "Your Email Address"
+msgstr ""
+
+#: web/forms.py:8
+msgid "May we use your subscriptions for the toplist and suggestions?"
+msgstr ""
+
+#: web/forms.py:11
+msgid "Name of this device"
+msgstr ""
+
+#: web/forms.py:12
+msgid "What kind of device is this?"
+msgstr ""
+
+#: web/forms.py:13
+msgid "What UID is configured on the pysical device?"
+msgstr ""
+
+#: web/views.py:103
+msgid "With which client do you want to subscribe?"
+msgstr ""
+
+#: web/views.py:168
+#, python-format
+msgid "my.gpodder.org - Top %s"
+msgstr ""
+
+#: web/views.py:194
+#, python-format
+msgid "my.gpodder.org - %s Suggestions"
+msgstr ""
+
+#: web/views.py:208
+msgid "Synchronize with the following devices"
+msgstr ""
+
+#: web/templates/400.html:4
+msgid "Bad request"
+msgstr ""
+
+#: web/templates/400.html:5
+msgid "There has been an error processing your request."
+msgstr ""
+
+#: web/templates/401.html:4
+msgid "Unauthorized"
+msgstr ""
+
+#: web/templates/401.html:5
+msgid "This page is only available to registered users."
+msgstr ""
+
+#: web/templates/404.html:4
+msgid "Not found"
+msgstr ""
+
+#: web/templates/404.html:5
+msgid "The requested document could not be found."
+msgstr ""
+
+#: web/templates/500.html:4
+msgid "Internal Server Error"
+msgstr ""
+
+#: web/templates/500.html:5
+msgid ""
+"An error occured while processing your request. An e-mail with the error "
+"description has been sent to the developers."
+msgstr ""
+
+#: web/templates/account.html:5
+msgid "Account Settings"
+msgstr ""
+
+#: web/templates/account.html:8 web/templates/device.html:50
+msgid "Your settings have been saved."
+msgstr ""
+
+#: web/templates/account.html:11
+msgid "Update the settings for your account"
+msgstr ""
+
+#: web/templates/authors.html:5
+msgid "For podcast authors"
+msgstr ""
+
+#: web/templates/device.html:9
+msgid "Podcasts"
+msgstr ""
+
+#: web/templates/device.html:10
+msgid "You have subscribed the following podcasts on this device"
+msgstr ""
+
+#: web/templates/device.html:14 web/templates/podcast.html:37
+msgid "Title"
+msgstr ""
+
+#: web/templates/device.html:15
+msgid "Since"
+msgstr ""
+
+#: web/templates/device.html:27
+msgid "Synchronize"
+msgstr ""
+
+#: web/templates/device.html:28
+msgid ""
+"If you synchronize devices, they will always have the same subscriptions. A "
+"podcast that is subscribed on one device, will automatically be added to all "
+"synchronized devices."
+msgstr ""
+
+#: web/templates/device.html:32
+#, python-format
+msgid "%(devicename)s is currently not synchronized with other devices."
+msgstr ""
+
+#: web/templates/device.html:36
+#, python-format
+msgid "%(devicename)s is currently synchronized with %(synclist)s."
+msgstr ""
+
+#: web/templates/device.html:37
+#, python-format
+msgid "Stop synchronisation for %(devicename)s "
+msgstr ""
+
+#: web/templates/device.html:44 web/templates/subscribe.html:20
+msgid "OK"
+msgstr ""
+
+#: web/templates/episode.html:7
+#, python-format
+msgid ""
+"An episode of the <a href=\"/podcast/%(podcast_id)s\">%(podcast)s</a> "
+"podcast."
+msgstr ""
+
+#: web/templates/episode.html:22
+msgid "Your Episode History"
+msgstr ""
+
+#: web/templates/episode.html:25
+msgid "When"
+msgstr ""
+
+#: web/templates/episode.html:26
+msgid "What"
+msgstr ""
+
+#: web/templates/episode.html:27
+msgid "Where"
+msgstr ""
+
+#: web/templates/episode.html:41
+msgid "Why Unnamed Episode?"
+msgstr ""
+
+#: web/templates/episode.html:41 web/templates/podcast.html:80
+#: web/templates/subscribe.html:24
+msgid ""
+"Because we display names after we have fetched the information form the feed "
+"-- and this may take some time. Until this is completed, the podcast will "
+"simply be called this way."
+msgstr ""
+
+#: web/templates/home-user.html:6
+msgid "my.gpodder.org"
+msgstr ""
+
+#: web/templates/home-user.html:9
+msgid "Your Subscriptions"
+msgstr ""
+
+#: web/templates/home-user.html:13 web/templates/suggestions.html:17
+#: web/templates/toplist.html:13
+msgid "Podcast"
+msgstr ""
+
+#: web/templates/home-user.html:14
+msgid "Latest Episode"
+msgstr ""
+
+#: web/templates/home-user.html:15
+msgid "Subscribed on"
+msgstr ""
+
+#: web/templates/home-user.html:37
+msgid "Where to start?"
+msgstr ""
+
+#: web/templates/home-user.html:38
+#, python-format
+msgid ""
+"my.gpodder.org help you to track your podcasts which you have subscribed on "
+"your devices - desktop computer, notebook, mobile devices, etc. To start "
+"using my.gpodder.org set up <a href=\"http://gpodder.org\">gPodder</a> with "
+"your username &ndash; <strong>%(username)s</strong> &ndash; and password and "
+"upload your podcasts. They will automatically show up here."
+msgstr ""
+
+#: web/templates/home.html:6
+msgid ""
+"my.gpodder.org is a webservice for synchronizing podcast subscriptions on "
+"several devices and applications."
+msgstr ""
+
+#: web/templates/home.html:8
+#, python-format
+msgid "We are currently tracking %(podcast_count)s Podcasts!"
+msgstr ""
+
+#: web/templates/home.html:20 web/templates/login.html:14
+msgid "Not yet a member?"
+msgstr ""
+
+#: web/templates/home.html:20 web/templates/login.html:14
+msgid "Register!"
+msgstr ""
+
+#: web/templates/migrate.html:5
+msgid ""
+"The new my.gpodder.org uses usernames instead of email addresses. Based on "
+"your email address, we think you might like "
+msgstr ""
+
+#: web/templates/migrate.html:5
+msgid ", but you can change that if you want to."
+msgstr ""
+
+#: web/templates/migrate.html:11
+msgid ""
+"You can keep your old user settings in gPodder. Once the next version (with "
+"lots of new features) is release, you'll have to replace your email address "
+"with your username."
+msgstr ""
+
+#: web/templates/podcast.html:7
+msgid "Unnamed Podcast"
+msgstr ""
+
+#: web/templates/podcast.html:17 web/templates/subscribe.html:7
+#, python-format
+msgid "Subscribe to %(podcasttitle)s"
+msgstr ""
+
+#: web/templates/podcast.html:19 web/templates/subscribe.html:9
+msgid "Subscribe to this podcast"
+msgstr ""
+
+#: web/templates/podcast.html:23 web/templates/podcast.html.py:60
+msgid "Devices"
+msgstr ""
+
+#: web/templates/podcast.html:24
+msgid "You have subscribed this podcast on"
+msgstr ""
+
+#: web/templates/podcast.html:33
+msgid "Episodes"
+msgstr ""
+
+#: web/templates/podcast.html:38
+msgid "Description"
+msgstr ""
+
+#: web/templates/podcast.html:39
+msgid "Released"
+msgstr ""
+
+#: web/templates/podcast.html:55
+msgid "Subscription History"
+msgstr ""
+
+#: web/templates/podcast.html:58
+msgid "Timestamp"
+msgstr ""
+
+#: web/templates/podcast.html:59
+msgid "Action"
+msgstr ""
+
+#: web/templates/podcast.html:67
+msgid "subscribe"
+msgstr ""
+
+#: web/templates/podcast.html:70
+msgid "unsubscribe"
+msgstr ""
+
+#: web/templates/podcast.html:80 web/templates/subscribe.html:24
+msgid "Why Unnamed Podcast?"
+msgstr ""
+
+#: web/templates/suggestions.html:10
+msgid "Suggested Podcasts"
+msgstr ""
+
+#: web/templates/suggestions.html:12
+#, python-format
+msgid "We've selected %(suggestion_count)s podcasts which you might like."
+msgstr ""
+
+#: web/templates/suggestions.html:18
+msgid "URL"
+msgstr ""
+
+#: web/templates/suggestions.html:30
+msgid "Do you like our suggestions?"
+msgstr ""
+
+#: web/templates/toplist.html:5
+msgid "Toplist"
+msgstr ""
+
+#: web/templates/toplist.html:7
+#, python-format
+msgid "These are the %(count)s most subscribed podcasts."
+msgstr ""
+
+#: web/templates/toplist.html:11
+msgid "#"
+msgstr ""
+
+#: web/templates/toplist.html:12
+msgid "Last week"
+msgstr ""
+
+#: web/templates/toplist.html:14
+msgid "Subscribers"
+msgstr ""
+
+#: web/templates/registration/activate.html:5
+#: web/templates/registration/activation_complete.html:4
+msgid "Account activated"
+msgstr ""
+
+#: web/templates/registration/activate.html:6
+#: web/templates/registration/activation_complete.html:5
+msgid "Your account has been activated! Enjoy using my.gpodder.org"
+msgstr ""
+
+#: web/templates/registration/activate.html:8
+msgid "Account not activated"
+msgstr ""
+
+#: web/templates/registration/activate.html:9
+msgid "Your account could not be activated successfully."
+msgstr ""
+
+#: web/templates/registration/registration_complete.html:4
+msgid "Registration complete"
+msgstr ""
+
+#: web/templates/registration/registration_complete.html:5
+msgid ""
+"Please confirm your account using the email you should just have recieved."
+msgstr ""
+
+#: web/templates/registration/registration_form.html:4
+msgid "Create a User Account"
+msgstr ""
+
+#: web/templates/search/search.html:6
+msgid "Search"
+msgstr ""
+
+#: web/templates/search/search.html:20
+msgid "Results"
+msgstr ""
+
+#: web/templatetags/devices.py:11
+msgid "Desktop"
+msgstr ""
+
+#: web/templatetags/devices.py:13
+msgid "Laptop"
+msgstr ""
+
+#: web/templatetags/devices.py:15
+msgid "Mobile"
+msgstr ""
+
+#: web/templatetags/devices.py:17
+msgid "Server"
+msgstr ""
+
+#: web/templatetags/devices.py:19
+msgid "Other"
+msgstr ""
+
+#: web/templatetags/episodes.py:10
+msgid "This episode has not yet been played"
+msgstr ""
+
+#: web/templatetags/episodes.py:13 web/templatetags/episodes.py:14
+#, python-format
+msgid " on %s"
+msgstr ""
+
+#: web/templatetags/episodes.py:17
+msgid "This episode has been marked new"
+msgstr ""
+
+#: web/templatetags/episodes.py:19
+msgid "This episode has been downloaded"
+msgstr ""
+
+#: web/templatetags/episodes.py:21
+msgid "This episode has been played"
+msgstr ""
+
+#: web/templatetags/episodes.py:23
+msgid "This episode has been deleted"
+msgstr ""
+
+#: web/templatetags/podcasts.py:12
+msgid "Logo"
+msgstr ""
+
+#: web/templatetags/podcasts.py:14
+msgid "No Logo available"
+msgstr ""

commit 69fa108b0aa829802f9c87e615e0c47e29c0e9d3
Merge: c9413e3... c585b50...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Jan 7 16:03:43 2010 +0100

    Merge branch 'master' of ssh://stefankoegl@repo.or.cz/srv/git/mygpo

commit 9eec849a837dc590bfaf2dbba233e773bc1faf5a
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Jan 7 15:37:45 2010 +0100

    forgot to uncomment

diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 768eca5..6deb95d 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -32,7 +32,7 @@ except ImportError:
     print "No JSON module available - fallback to simplejson (Python < 2.6)"
     import simplejson as json
 
-"""
+
 class SyncTest(TestCase):
     # FIXME: Broken testcase - please fix!
     def tXest_sync_actions(self):
@@ -199,7 +199,7 @@ class AdvancedAPITest(TestCase):
             if hash2[x] != hash1[x]:
                 return False
         return True
-"""
+
 
 class SimpleAPITest(TestCase):
 

commit 79e99304e3b07de3fe8665eb371de118083b6ca7
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Jan 7 15:36:44 2010 +0100

    testcases added - new parsing in simple api

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index e7550d9..c978090 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -76,7 +76,7 @@ def get_subscriptions(user, device_uid):
 def parse_subscription(raw_post_data, format, user, device_uid):
     if format == 'txt':
         sub = raw_post_data.split('\n')
-        p = '^[a-zA-z]'
+        p = '^http'
         urls = []
         for x in sub:
             if re.search(p, x) == None:
@@ -85,11 +85,15 @@ def parse_subscription(raw_post_data, format, user, device_uid):
                 urls.append(x)
 
     elif format == 'opml':
-        i = Importer(content=raw_post_data)
+        begin = raw_post_data.find('<?xml')
+        end = raw_post_data.find('</opml>') + 7
+        i = Importer(content=raw_post_data[begin:end])
         urls = [p['url'] for p in i.items]
 
     elif format == 'json':
-        urls = json.loads(raw_post_data)
+        begin = raw_post_data.find('[')
+        end = raw_post_data.find(']') + 1
+        urls = json.loads(raw_post_data[begin:end])
 
     else: raise ValueError('unsupported format %s' % format)
     
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index c145127..768eca5 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -19,7 +19,6 @@ from django.test import TestCase
 from django.test.client import Client
 from django.contrib.auth.models import User
 from mygpo.api.models import Device, Podcast, Subscription, SubscriptionAction, UserProfile, EpisodeAction
-from put_test import put_data
 from django.http import HttpRequest
 from mygpo.api.simple import subscriptions
 from mygpo.api.advanced import devices
@@ -33,7 +32,7 @@ except ImportError:
     print "No JSON module available - fallback to simplejson (Python < 2.6)"
     import simplejson as json
 
-
+"""
 class SyncTest(TestCase):
     # FIXME: Broken testcase - please fix!
     def tXest_sync_actions(self):
@@ -200,33 +199,37 @@ class AdvancedAPITest(TestCase):
             if hash2[x] != hash1[x]:
                 return False
         return True
-
+"""
 
 class SimpleAPITest(TestCase):
 
     def setUp(self):
         un = 'u'
         pw = 'u'
-        u  = User.objects.create(username=un, password=pw)
-        UserProfile.objects.create(user=u)
+        self.user = User.objects.create(username=un, email='u@mygpo')
+        self.user.set_password(pw)
+        self.user.save()
+        UserProfile.objects.create(user=self.user)
         
         r = HttpRequest()
         r.method = 'PUT'
-        r.user = u
+        r.user = self.user
         
-        self.user = u
         self.req = r
+        self.p1 = 'http://www.podcast1.com'
+        self.p2 = 'http://www.podcast2.com'
+        self.p3 = 'http://www.podcast3.com'
+        
+        self.client = Client()
+        login = self.client.login(username=un, password=pw)
+        self.assertEqual(login, True)
 
     def test_put_get_txt(self):
-        p1 = 'http://www.podcast1.com'
-        p2 = 'http://www.podcast2.com'
-        p3 = 'http://www.podcast3.com'
-    
         d1 = '1'
         f1 = 'txt'
     
-        data_txt_1 = '%s\n%s\n' % (p1, p2)
-        data_txt_2 = '%s\n%s\n' % (p2, p3)
+        data_txt_1 = '%s\n%s\n' % (self.p1, self.p2)
+        data_txt_2 = '%s\n%s\n' % (self.p2, self.p3)
         
         #1. put 2 new podcasts
         self.req.raw_post_data = data_txt_1
@@ -242,8 +245,8 @@ class SimpleAPITest(TestCase):
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual(len(urls), 2)
-        self.assertEqual(urls[0], p1)
-        self.assertEqual(urls[1], p2) 
+        self.assertEqual(urls[0], self.p1)
+        self.assertEqual(urls[1], self.p2) 
         
         #2. put 1 new podcast and delete 1 old
         time.sleep(1)
@@ -254,20 +257,15 @@ class SimpleAPITest(TestCase):
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
-        self.assertEqual(urls[0], p2)
-        self.assertEqual(urls[1], p3) 
-        
-    def test_put_get_json(self):
-    
-        p1 = 'http://www.podcast1.com'
-        p2 = 'http://www.podcast2.com'
-        p3 = 'http://www.podcast3.com'
+        self.assertEqual(urls[0], self.p2)
+        self.assertEqual(urls[1], self.p3) 
 
+    def test_put_get_json(self):
         d2 = '2'
         f2 = 'json'
     
-        data_json_1 = '[\n"%s",\n"%s"\n]' % (p1, p2)
-        data_json_2 = '[\n"%s",\n"%s"\n]' % (p2, p3)
+        data_json_1 = '[\n"%s",\n"%s"\n]' % (self.p1, self.p2)
+        data_json_2 = '[\n"%s",\n"%s"\n]' % (self.p2, self.p3)
     
         #1. put 2 new podcasts
         self.req.raw_post_data = data_json_1
@@ -280,8 +278,8 @@ class SimpleAPITest(TestCase):
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
-        self.assertEqual(urls[0], p1)
-        self.assertEqual(urls[1], p2) 
+        self.assertEqual(urls[0], self.p1)
+        self.assertEqual(urls[1], self.p2) 
 
         #2. put 1 new podcast and delete 1 old
         time.sleep(1)
@@ -292,15 +290,10 @@ class SimpleAPITest(TestCase):
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
-        self.assertEqual(urls[0], p2)
-        self.assertEqual(urls[1], p3) 
+        self.assertEqual(urls[0], self.p2)
+        self.assertEqual(urls[1], self.p3) 
         
     def test_put_get_opml(self):
-        
-        p1 = 'http://www.podcast1.com'
-        p2 = 'http://www.podcast2.com'
-        p3 = 'http://www.podcast3.com'
-    
         d3 = '3'
         f3 = 'opml'  
         
@@ -308,12 +301,12 @@ class SimpleAPITest(TestCase):
                        <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated>\n</head>\n<body>\n\
                        <outline text="p1" title="p1" type="rss" xmlUrl="%s"/>\n\
                        <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\n\
-                       </body>\n</opml>\n' % (p1, p2)
+                       </body>\n</opml>\n' % (self.p1, self.p2)
         data_opml_2 = '<?xml version="1.0" encoding="UTF-8"?><opml version="2.0"><head><title>subscription list</title>\
                        <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated></head><body>\
                        <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\
                        <outline text="p3" title="p3" type="rss" xmlUrl="%s"/>\
-                       </body></opml>' % (p2, p3)
+                       </body></opml>' % (self.p2, self.p3)
       
         #1. put 2 new podcasts
         self.req.raw_post_data = data_opml_1
@@ -326,8 +319,8 @@ class SimpleAPITest(TestCase):
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
-        self.assertEqual(urls[0], p1)
-        self.assertEqual(urls[1], p2) 
+        self.assertEqual(urls[0], self.p1)
+        self.assertEqual(urls[1], self.p2) 
         
         #2. put 1 new podcast and delete 1 old
         time.sleep(1)
@@ -338,6 +331,57 @@ class SimpleAPITest(TestCase):
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
-        self.assertEqual(urls[0], p2)
-        self.assertEqual(urls[1], p3) 
+        self.assertEqual(urls[0], self.p2)
+        self.assertEqual(urls[1], self.p3)
+        
+        
+    def test_put_json_client(self):
+        device = 'ipod'
+        urls = [self.p1, self.p2, self.p3]
+        reqs = json.dumps(urls)
+        
+        #put json - add 3 podcasts
+        response = self.client.put('/subscriptions/%s/%s.json' % (self.user.username, device), data={'raw_post_data':reqs})
+        self.assertEqual(response.status_code, 200)
+        self.assertEqual(response.content, '')
+        
+        #get json - get 3 podcasts
+        response = self.client.get('/subscriptions/%s/%s.json' % (self.user.username, device), {})
+        get = json.loads(response.content)
+        
+        self.assertEqual(get, [self.p1, self.p2, self.p3])
 
+    def test_put_txt_get_json_client(self):
+        device = 'mobdev'
+        reqs = '%s\n%s\n%s\n' % (self.p1, self.p2, self.p3)
+        
+        #put txt - add 3 podcasts
+        response = self.client.put('/subscriptions/%s/%s.txt' % (self.user.username, device), data={'raw_post_data':reqs})
+        self.assertEqual(response.status_code, 200)
+        self.assertEqual(response.content, '')
+        
+        #qerying subscription changes
+        response = self.client.get('/subscriptions/%s/%s.json' % (self.user.username, device), {})
+        get = json.loads(response.content)
+        
+        self.assertEqual(get, [self.p1, self.p2, self.p3])
+        
+    def test_put_opml_get_json_client(self):
+        device = 'pc'
+        reqs = '<?xml version="1.0" encoding="UTF-8"?>\n<opml version="2.0">\n<head>\n<title>subscription list</title>\n\
+                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated>\n</head>\n<body>\n\
+                       <outline text="p1" title="p1" type="rss" xmlUrl="%s"/>\n\
+                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\n\
+                       <outline text="p3" title="p3" type="rss" xmlUrl="%s"/>\n\
+                       </body>\n</opml>\n' % (self.p1, self.p2, self.p3)
+        
+        #put json - add 3 podcasts
+        response = self.client.put('/subscriptions/%s/%s.opml' % (self.user.username, device), data={'raw_post_data':reqs})
+        self.assertEqual(response.status_code, 200)
+        self.assertEqual(response.content, '')
+        
+        #qerying subscription changes
+        response = self.client.get('/subscriptions/%s/%s.json' % (self.user.username, device), {})
+        get = json.loads(response.content)
+        
+        self.assertEqual(get, [self.p1, self.p2, self.p3])

commit c585b50c95f65354ba5b8700415e13d2fa4f53c5
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 7 14:11:44 2010 +0100

    Fix "Invalid block tag: 'trans'" (bug 742)
    
    We have to add {% load i18n %} to all templates
    that use the translation feature.
    
    See also:
    
    http://code.djangoproject.com/ticket/1193

diff --git a/mygpo/web/templates/400.html b/mygpo/web/templates/400.html
index 3480ca4..c6569d5 100644
--- a/mygpo/web/templates/400.html
+++ b/mygpo/web/templates/400.html
@@ -1,5 +1,5 @@
 {% extends "base.html" %}
-
+{% load i18n %}
 {% block content %}
   <h1>400 {% trans "Bad request" %}</h1>
   <p>{% trans "There has been an error processing your request." %}</p>
diff --git a/mygpo/web/templates/401.html b/mygpo/web/templates/401.html
index 497473d..9420b0e 100644
--- a/mygpo/web/templates/401.html
+++ b/mygpo/web/templates/401.html
@@ -1,5 +1,5 @@
 {% extends "base.html" %}
-
+{% load i18n %}
 {% block content %}
   <h1>401 {% trans "Unauthorized" %}</h1>
   <p>{% trans "This page is only available to registered users." %}</p>
diff --git a/mygpo/web/templates/404.html b/mygpo/web/templates/404.html
index 5ddeae3..cde14c2 100644
--- a/mygpo/web/templates/404.html
+++ b/mygpo/web/templates/404.html
@@ -1,5 +1,5 @@
 {% extends "base.html" %}
-
+{% load i18n %}
 {% block content %}
   <h1>404 {% trans "Not found" %}</h1>
   <p>{% trans "The requested document could not be found." %}</p>
diff --git a/mygpo/web/templates/500.html b/mygpo/web/templates/500.html
index d681d7d..edd97b8 100644
--- a/mygpo/web/templates/500.html
+++ b/mygpo/web/templates/500.html
@@ -1,5 +1,5 @@
 {% extends "base.html" %}
-
+{% load i18n %}
 {% block content %}
   <h1>500 {% trans "Internal Server Error" %}</h1>
   <p>{% trans "An error occured while processing your request. An e-mail with the error description has been sent to the developers." %}</p>
diff --git a/mygpo/web/templates/login.html b/mygpo/web/templates/login.html
index 315062b..6ac3262 100644
--- a/mygpo/web/templates/login.html
+++ b/mygpo/web/templates/login.html
@@ -1,5 +1,5 @@
 {% extends "base.html" %}
-
+{% load i18n %}
 {% block content %}
   <h1>Login</h1>
    <form action="../login/" method="post">

commit 4181a889a05eed041ee989a9205468b05b642b68
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 7 14:06:20 2010 +0100

    Add error documents for the website (bug 741)
    
    This avoids bogus 500 errors when the templates
    for the given error documents could not be found.

diff --git a/mygpo/web/templates/400.html b/mygpo/web/templates/400.html
new file mode 100644
index 0000000..3480ca4
--- /dev/null
+++ b/mygpo/web/templates/400.html
@@ -0,0 +1,7 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>400 {% trans "Bad request" %}</h1>
+  <p>{% trans "There has been an error processing your request." %}</p>
+{% endblock %}
+
diff --git a/mygpo/web/templates/401.html b/mygpo/web/templates/401.html
new file mode 100644
index 0000000..497473d
--- /dev/null
+++ b/mygpo/web/templates/401.html
@@ -0,0 +1,7 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>401 {% trans "Unauthorized" %}</h1>
+  <p>{% trans "This page is only available to registered users." %}</p>
+{% endblock %}
+
diff --git a/mygpo/web/templates/404.html b/mygpo/web/templates/404.html
new file mode 100644
index 0000000..5ddeae3
--- /dev/null
+++ b/mygpo/web/templates/404.html
@@ -0,0 +1,7 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>404 {% trans "Not found" %}</h1>
+  <p>{% trans "The requested document could not be found." %}</p>
+{% endblock %}
+
diff --git a/mygpo/web/templates/500.html b/mygpo/web/templates/500.html
new file mode 100644
index 0000000..d681d7d
--- /dev/null
+++ b/mygpo/web/templates/500.html
@@ -0,0 +1,7 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>500 {% trans "Internal Server Error" %}</h1>
+  <p>{% trans "An error occured while processing your request. An e-mail with the error description has been sent to the developers." %}</p>
+{% endblock %}
+

commit fbd6d499be5e9b37a75d7b43fb8643cc0c91e787
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 7 13:57:24 2010 +0100

    Add rewrite rule for favicon.png

diff --git a/mygpo.lighttpd.conf b/mygpo.lighttpd.conf
index 717e10c..b8998d3 100644
--- a/mygpo.lighttpd.conf
+++ b/mygpo.lighttpd.conf
@@ -48,7 +48,7 @@ $HTTP["host"] == mygpo_domain {
 	)
 	url.rewrite-once = (
 		"^(/media.*)$" => "$1",
-		"^/(favicon\.ico|robots\.txt)$" => "/$1",
+		"^/(favicon\.ico|favicon\.png|robots\.txt)$" => "/$1",
 		"^(/.*)$" => "/mygpo.fcgi$1",
 	)
 }

commit 85994b820fb6d3dfad83c6af0e20d3305aad1792
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 7 13:55:39 2010 +0100

    Fix domain name in default config

diff --git a/mygpo.lighttpd.conf b/mygpo.lighttpd.conf
index 0d26706..717e10c 100644
--- a/mygpo.lighttpd.conf
+++ b/mygpo.lighttpd.conf
@@ -29,7 +29,7 @@
 #
 
 var.mygpo_home = "/srv/mygpo"
-var.mygpo_domain = "mygpo.thpinfo.com"
+var.mygpo_domain = "my.gpodder.org"
 
 $HTTP["host"] == mygpo_domain {
 	server.document-root = mygpo_home + "/htdocs",

commit 172e3f03a6f282faefce6609a9cf7b50b45f71e5
Author: Thomas Perl <thp@thpinfo.com>
Date:   Thu Jan 7 13:47:46 2010 +0100

    Fix bug with robots.txt and favicon.ico
    
    Add proper mygpo favicon and make a good
    lighttpd config that does not rewrite the
    robots.txt and favicon.ico requests.

diff --git a/htdocs/favicon.ico b/htdocs/favicon.ico
index 9f78c94..d772df4 100644
Binary files a/htdocs/favicon.ico and b/htdocs/favicon.ico differ
diff --git a/htdocs/favicon.png b/htdocs/favicon.png
new file mode 100644
index 0000000..5fd3cb6
Binary files /dev/null and b/htdocs/favicon.png differ
diff --git a/htdocs/favicon.svg b/htdocs/favicon.svg
new file mode 100644
index 0000000..2c61c6c
--- /dev/null
+++ b/htdocs/favicon.svg
@@ -0,0 +1,2754 @@
+<?xml version="1.0" encoding="UTF-8" standalone="no"?>
+<!-- Created with Inkscape (http://www.inkscape.org/) -->
+
+<svg
+   xmlns:dc="http://purl.org/dc/elements/1.1/"
+   xmlns:cc="http://creativecommons.org/ns#"
+   xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
+   xmlns:svg="http://www.w3.org/2000/svg"
+   xmlns="http://www.w3.org/2000/svg"
+   xmlns:xlink="http://www.w3.org/1999/xlink"
+   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
+   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
+   width="16"
+   height="16"
+   id="svg4380"
+   sodipodi:version="0.32"
+   inkscape:version="0.47pre4 r22446"
+   sodipodi:modified="true"
+   version="1.0"
+   sodipodi:docname="favicon.svg"
+   inkscape:output_extension="org.inkscape.output.svg.inkscape"
+   inkscape:export-filename="/home/thp/favicon.png"
+   inkscape:export-xdpi="90"
+   inkscape:export-ydpi="90">
+  <defs
+     id="defs4382">
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient5265">
+      <stop
+         style="stop-color:#ffffff;stop-opacity:1;"
+         offset="0"
+         id="stop5267" />
+      <stop
+         style="stop-color:#ffffff;stop-opacity:0;"
+         offset="1"
+         id="stop5269" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient5257">
+      <stop
+         style="stop-color:#ffffff;stop-opacity:1;"
+         offset="0"
+         id="stop5259" />
+      <stop
+         style="stop-color:#ffffff;stop-opacity:0;"
+         offset="1"
+         id="stop5261" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient4091">
+      <stop
+         style="stop-color:#ffffff;stop-opacity:1;"
+         offset="0"
+         id="stop4093" />
+      <stop
+         style="stop-color:#ffffff;stop-opacity:0;"
+         offset="1"
+         id="stop4095" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient4073">
+      <stop
+         style="stop-color:#ffffff;stop-opacity:1;"
+         offset="0"
+         id="stop4075" />
+      <stop
+         style="stop-color:#ffffff;stop-opacity:0;"
+         offset="1"
+         id="stop4077" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient3735">
+      <stop
+         style="stop-color:#ffffff;stop-opacity:1;"
+         offset="0"
+         id="stop3737" />
+      <stop
+         style="stop-color:#ffffff;stop-opacity:0;"
+         offset="1"
+         id="stop3739" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient3393">
+      <stop
+         style="stop-color:#888a85;stop-opacity:1;"
+         offset="0"
+         id="stop3395" />
+      <stop
+         style="stop-color:#888a85;stop-opacity:0;"
+         offset="1"
+         id="stop3397" />
+    </linearGradient>
+    <inkscape:perspective
+       sodipodi:type="inkscape:persp3d"
+       inkscape:vp_x="0 : 24 : 1"
+       inkscape:vp_y="6.1230318e-14 : 1000 : 0"
+       inkscape:vp_z="48 : 24 : 1"
+       inkscape:persp3d-origin="24 : 16 : 1"
+       id="perspective85" />
+    <linearGradient
+       id="linearGradient10416">
+      <stop
+         style="stop-color:black;stop-opacity:0.79381442;"
+         offset="0"
+         id="stop10418" />
+      <stop
+         style="stop-color:black;stop-opacity:0;"
+         offset="1"
+         id="stop10420" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416"
+       id="radialGradient10422"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       gradientUnits="userSpaceOnUse" />
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient5029">
+      <stop
+         style="stop-color:#73d216;stop-opacity:1;"
+         offset="0"
+         id="stop5031" />
+      <stop
+         style="stop-color:#73d216;stop-opacity:0;"
+         offset="1"
+         id="stop5033" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient5029"
+       id="linearGradient5035"
+       x1="10.952823"
+       y1="26.389088"
+       x2="30.496004"
+       y2="22.5"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="translate(-0.6985189,1.9743819)" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient4993"
+       x1="2.2180839"
+       y1="22.84971"
+       x2="48.170601"
+       y2="32.007515"
+       gradientUnits="userSpaceOnUse" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient3142"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient3140"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       id="linearGradient7462">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop7464" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop7466" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient3138"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <linearGradient
+       id="linearGradient8357">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop8359" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop8361" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient3136"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient3134"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       id="linearGradient8382">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop8384" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop8386" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient3132"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient5296"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.5564637,-2.3251716e-7,2.3251716e-7,1.5564637,46.099455,-34.145039)"
+       x1="-11.65197"
+       y1="37.298004"
+       x2="-0.57569283"
+       y2="37.298004" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient5298"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="translate(-17.49662,-4.077645)"
+       x1="-16.071386"
+       y1="42.178146"
+       x2="-11.535848"
+       y2="45.960064" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient5300"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.279252,-0.09846639,0.09523896,1.237309,47.519781,-38.414668)"
+       x1="-15.838902"
+       y1="39.956676"
+       x2="-8.8692646"
+       y2="43.916161" />
+    <linearGradient
+       id="linearGradient6569">
+      <stop
+         style="stop-color:#6a6a6a;stop-opacity:1;"
+         offset="0"
+         id="stop6571" />
+      <stop
+         style="stop-color:#121212;stop-opacity:1;"
+         offset="1"
+         id="stop6573" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient5302"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.217805,-0.09373677,0.09373677,1.217805,24.021581,-15.260018)"
+       x1="-16.071386"
+       y1="42.178146"
+       x2="-11.535848"
+       y2="45.960064" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient5304"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.4106687,-8.3468133e-8,8.3468133e-8,1.4106687,-23.372096,-70.361711)"
+       x1="36.81126"
+       y1="66.551888"
+       x2="47.887478"
+       y2="66.551888" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient6346"
+       gradientUnits="userSpaceOnUse"
+       x1="39.53125"
+       y1="24.229225"
+       x2="41.011925"
+       y2="25.125" />
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient4987">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop4989" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop4991" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient6360"
+       gradientUnits="userSpaceOnUse"
+       x1="35.974056"
+       y1="24.223534"
+       x2="37.680836"
+       y2="26.079689" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416"
+       id="radialGradient4475"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient4481"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient4483"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient4485"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient4487"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient4489"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient4491"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416"
+       id="radialGradient2508"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient5029"
+       id="linearGradient2510"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="translate(-0.6985189,1.9743819)"
+       x1="10.952823"
+       y1="26.389088"
+       x2="30.496004"
+       y2="22.5" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient2512"
+       gradientUnits="userSpaceOnUse"
+       x1="2.2180839"
+       y1="22.84971"
+       x2="48.170601"
+       y2="32.007515" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient2514"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient2516"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient2518"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient2520"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient2522"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient2524"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient2526"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.5564637,-2.3251716e-7,2.3251716e-7,1.5564637,46.099455,-34.145039)"
+       x1="-11.65197"
+       y1="37.298004"
+       x2="-0.57569283"
+       y2="37.298004" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient2528"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="translate(-17.49662,-4.077645)"
+       x1="-16.071386"
+       y1="42.178146"
+       x2="-11.535848"
+       y2="45.960064" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient2530"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.279252,-0.09846639,0.09523896,1.237309,47.519781,-38.414668)"
+       x1="-15.838902"
+       y1="39.956676"
+       x2="-8.8692646"
+       y2="43.916161" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient2532"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.217805,-0.09373677,0.09373677,1.217805,24.021581,-15.260018)"
+       x1="-16.071386"
+       y1="42.178146"
+       x2="-11.535848"
+       y2="45.960064" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient2534"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.4106687,-8.3468133e-8,8.3468133e-8,1.4106687,-23.372096,-70.361711)"
+       x1="36.81126"
+       y1="66.551888"
+       x2="47.887478"
+       y2="66.551888" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient2536"
+       gradientUnits="userSpaceOnUse"
+       x1="39.53125"
+       y1="24.229225"
+       x2="41.011925"
+       y2="25.125" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient2538"
+       gradientUnits="userSpaceOnUse"
+       x1="35.974056"
+       y1="24.223534"
+       x2="37.680836"
+       y2="26.079689" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient3393"
+       id="linearGradient3399"
+       x1="38.537319"
+       y1="7.1645832"
+       x2="28.019106"
+       y2="12.821438"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.9999909,-0.00426776,0.00426776,0.9999909,-4.4165644,0.83974157)" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient3393"
+       id="linearGradient3741"
+       gradientUnits="userSpaceOnUse"
+       x1="38.537319"
+       y1="7.1645832"
+       x2="28.019106"
+       y2="12.821438"
+       gradientTransform="matrix(0.3668279,-0.06975091,0.06928175,0.3643606,19.351076,80.200572)" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416"
+       id="radialGradient3743"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient3745"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient3747"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient3749"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient3751"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient3757"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.438803,-7.8045232e-8,8.0536873e-8,0.4356092,38.266472,69.926958)"
+       x1="-11.65197"
+       y1="37.298004"
+       x2="-0.57569283"
+       y2="37.298004" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4987"
+       id="linearGradient3759"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.3623825,-7.2646448e-4,-2.1285489e-5,0.3477047,38.743672,70.105444)"
+       x1="-15.838902"
+       y1="39.956676"
+       x2="-8.8692646"
+       y2="43.916161" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient3761"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.4388525,-7.7134169e-8,8.199892e-8,0.43556,34.276476,70.817633)"
+       x1="-11.65197"
+       y1="37.298004"
+       x2="-0.57569283"
+       y2="37.298004" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416"
+       id="radialGradient2541"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient2543"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient2545"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient2547"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient2549"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient2551"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient2553"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416"
+       id="radialGradient2611"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient2613"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient2615"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient2617"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient2619"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient2621"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient2623"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient2533"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.1754571,-2.1166481e-7,2.1832904e-7,1.1741946,44.16419,-25.791961)"
+       x1="-11.65197"
+       y1="37.298004"
+       x2="-0.57569283"
+       y2="37.298004" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient3735"
+       id="radialGradient3741"
+       cx="33.583714"
+       cy="21.623034"
+       fx="33.583714"
+       fy="21.623034"
+       r="3.8437574"
+       gradientTransform="matrix(0.84120566,3.5007184,-1.6612963,0.30560907,41.373746,-106.78561)"
+       gradientUnits="userSpaceOnUse" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient6569"
+       id="linearGradient3745"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1.0859838,-2.0738081e-7,1.9600053e-7,1.1180378,47.869903,-23.87566)"
+       x1="-11.65197"
+       y1="37.298004"
+       x2="-0.57569283"
+       y2="37.298004" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4073"
+       id="linearGradient4079"
+       x1="65.407379"
+       y1="32.149517"
+       x2="65.407379"
+       y2="11.760777"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.72981367,0,0,0.65027323,14.578588,2.5220684)" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4091"
+       id="linearGradient4097"
+       x1="76.013977"
+       y1="30.145554"
+       x2="76.013977"
+       y2="17.240854"
+       gradientUnits="userSpaceOnUse" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416"
+       id="radialGradient3900"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient3902"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient3904"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient3906"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient3908"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient3910"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient3912"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416"
+       id="radialGradient4001"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient4003"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient4005"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462"
+       id="radialGradient4007"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357"
+       id="radialGradient4009"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient4011"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382"
+       id="linearGradient4013"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <inkscape:perspective
+       id="perspective2976"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient10416-8"
+       id="radialGradient3860-8"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.135603,0,33.52458)"
+       cx="36.641891"
+       cy="38.783783"
+       fx="36.641891"
+       fy="38.783783"
+       r="18.655405" />
+    <linearGradient
+       id="linearGradient10416-8">
+      <stop
+         style="stop-color:black;stop-opacity:0.79381442;"
+         offset="0"
+         id="stop10418-5" />
+      <stop
+         style="stop-color:black;stop-opacity:0;"
+         offset="1"
+         id="stop10420-0" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-6"
+       id="radialGradient3862-9"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <linearGradient
+       id="linearGradient7462-6">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop7464-3" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop7466-8" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-6"
+       id="radialGradient3864-5"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       id="linearGradient8357-6">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop8359-1" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop8361-1" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-6"
+       id="radialGradient3866-5"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <linearGradient
+       id="linearGradient2993">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop2995" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop2997" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-6"
+       id="radialGradient3868-9"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       id="linearGradient3000">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop3002" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop3004" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382-4"
+       id="linearGradient3870-8"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       id="linearGradient8382-4">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop8384-8" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop8386-1" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382-4"
+       id="linearGradient3872-0"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <linearGradient
+       id="linearGradient3011">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop3013" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop3015" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4091-4"
+       id="linearGradient2944-4"
+       gradientUnits="userSpaceOnUse"
+       x1="76.013977"
+       y1="30.145554"
+       x2="76.013977"
+       y2="17.240854"
+       gradientTransform="translate(-51.502679,9.7227183)" />
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient4091-4">
+      <stop
+         style="stop-color:#ffffff;stop-opacity:1;"
+         offset="0"
+         id="stop4093-4" />
+      <stop
+         style="stop-color:#ffffff;stop-opacity:0;"
+         offset="1"
+         id="stop4095-4" />
+    </linearGradient>
+    <linearGradient
+       y2="17.240854"
+       x2="76.013977"
+       y1="30.145554"
+       x1="76.013977"
+       gradientTransform="translate(-51.502679,9.7227183)"
+       gradientUnits="userSpaceOnUse"
+       id="linearGradient3045"
+       xlink:href="#linearGradient4091-4"
+       inkscape:collect="always" />
+    <inkscape:perspective
+       id="perspective4094"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <inkscape:perspective
+       id="perspective4186"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <inkscape:perspective
+       id="perspective4186-7"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <inkscape:perspective
+       id="perspective4227"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <inkscape:perspective
+       id="perspective4573"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-2"
+       id="radialGradient4207-9"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <linearGradient
+       id="linearGradient7462-2">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop7464-4" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop7466-0" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient8357-8">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop8359-3" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop8361-14" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient4588">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop4590" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop4592" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient4595">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop4597" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop4599" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient8382-6">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop8384-5" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop8386-0" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient4606">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop4608" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop4610" />
+    </linearGradient>
+    <inkscape:perspective
+       id="perspective4573-3"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-7"
+       id="radialGradient4207-8"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <linearGradient
+       id="linearGradient7462-7">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop7464-5" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop7466-09" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-5"
+       id="radialGradient4209-5"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       id="linearGradient8357-5">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop8359-0" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop8361-2" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-7"
+       id="radialGradient4211-4"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <linearGradient
+       id="linearGradient4588-5">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop4590-8" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop4592-2" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-5"
+       id="radialGradient4213-1"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       id="linearGradient4595-7">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop4597-2" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop4599-5" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382-9"
+       id="linearGradient4215-16"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       id="linearGradient8382-9">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop8384-3" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop8386-2" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382-9"
+       id="linearGradient4217-6"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <linearGradient
+       id="linearGradient4606-2">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop4608-9" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop4610-8" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-7"
+       id="radialGradient4875"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-5"
+       id="radialGradient4877"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-7"
+       id="radialGradient4879"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-5"
+       id="radialGradient4881"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382-9"
+       id="linearGradient4883"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382-9"
+       id="linearGradient4885"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4606-2"
+       id="linearGradient4931"
+       x1="-125.28645"
+       y1="86.183769"
+       x2="-117.15472"
+       y2="131.26173"
+       gradientUnits="userSpaceOnUse" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-5"
+       id="radialGradient4939"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-5"
+       id="radialGradient4941"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-7"
+       id="radialGradient4945"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-7"
+       id="radialGradient4949"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-7"
+       id="radialGradient4953"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-7"
+       id="radialGradient4957"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(3.4062553,-5.5320811,0.57671503,0.47775115,103.92945,-297.47373)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <inkscape:perspective
+       id="perspective4983"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <filter
+       color-interpolation-filters="sRGB"
+       inkscape:collect="always"
+       id="filter4365-8">
+      <feGaussianBlur
+         inkscape:collect="always"
+         stdDeviation="0.94999387"
+         id="feGaussianBlur4367-40" />
+    </filter>
+    <linearGradient
+       id="linearGradient7462-8">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop7464-6" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop7466-89" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient8357-81">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop8359-4" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop8361-19" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient4998">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop5000" />
+      <stop
+         style="stop-color:#e5e5e5;stop-opacity:1;"
+         offset="1"
+         id="stop5002" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient5005">
+      <stop
+         style="stop-color:black;stop-opacity:1;"
+         offset="0"
+         id="stop5007" />
+      <stop
+         style="stop-color:#6e6e6e;stop-opacity:1;"
+         offset="1"
+         id="stop5009" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient8382-92">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop8384-1" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop8386-3" />
+    </linearGradient>
+    <linearGradient
+       id="linearGradient5016">
+      <stop
+         style="stop-color:white;stop-opacity:1;"
+         offset="0"
+         id="stop5018" />
+      <stop
+         style="stop-color:white;stop-opacity:0;"
+         offset="1"
+         id="stop5020" />
+    </linearGradient>
+    <inkscape:perspective
+       id="perspective5164"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <inkscape:perspective
+       id="perspective5164-7"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <inkscape:perspective
+       id="perspective5164-5"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <inkscape:perspective
+       id="perspective5164-1"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <inkscape:perspective
+       id="perspective5164-2"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient5257"
+       id="linearGradient5263"
+       x1="34.462833"
+       y1="13.05711"
+       x2="21.20458"
+       y2="23.0625"
+       gradientUnits="userSpaceOnUse" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient5265"
+       id="linearGradient5271"
+       x1="15.914215"
+       y1="11.415848"
+       x2="26.986471"
+       y2="24.816383"
+       gradientUnits="userSpaceOnUse" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient5257"
+       id="linearGradient5273"
+       x1="11.22047"
+       y1="18.101835"
+       x2="41.427456"
+       y2="24.846163"
+       gradientUnits="userSpaceOnUse" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-8"
+       id="radialGradient5424"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.885091e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-81"
+       id="radialGradient5426"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient7462-8"
+       id="radialGradient5428"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(5.867644,-1.91396e-7,4.8850908e-8,1.965199,295.216,-70.303)"
+       cx="-60.648643"
+       cy="72.83783"
+       fx="-60.648643"
+       fy="72.83783"
+       r="13.860751" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8357-81"
+       id="radialGradient5430"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(-3.442732,-0.964236,0.539404,-1.925888,19.34944,75.83522)"
+       cx="7.0836134"
+       cy="23.56488"
+       fx="7.0836134"
+       fy="23.56488"
+       r="0.81756759" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382-92"
+       id="linearGradient5432"
+       gradientUnits="userSpaceOnUse"
+       x1="-61.313606"
+       y1="49.155289"
+       x2="-60.337887"
+       y2="69.28846" />
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8382-92"
+       id="linearGradient5434"
+       gradientUnits="userSpaceOnUse"
+       x1="-59.301517"
+       y1="49.863075"
+       x2="-61.212978"
+       y2="68.12606" />
+    <inkscape:perspective
+       id="perspective3199"
+       inkscape:persp3d-origin="0.5 : 0.33333333 : 1"
+       inkscape:vp_z="1 : 0.5 : 1"
+       inkscape:vp_y="0 : 1000 : 0"
+       inkscape:vp_x="0 : 0.5 : 1"
+       sodipodi:type="inkscape:persp3d" />
+    <radialGradient
+       r="10.625"
+       fy="4.625"
+       fx="62.625"
+       cy="4.625"
+       cx="62.625"
+       gradientTransform="matrix(1,0,0,0.341176,0,3.047059)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9169"
+       xlink:href="#linearGradient8838"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient8838"
+       inkscape:collect="always">
+      <stop
+         id="stop8840"
+         offset="0"
+         style="stop-color:#000000;stop-opacity:1;" />
+      <stop
+         id="stop8842"
+         offset="1"
+         style="stop-color:#000000;stop-opacity:0;" />
+    </linearGradient>
+    <radialGradient
+       r="9.7552834"
+       fy="-8.7256308"
+       fx="62.200352"
+       cy="-8.7256308"
+       cx="62.200352"
+       gradientTransform="matrix(1.122354,0,0,1.122379,-7.610472,1.067717)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9171"
+       xlink:href="#linearGradient8647"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient8647">
+      <stop
+         id="stop8649"
+         offset="0"
+         style="stop-color:#8fb1dc;stop-opacity:1;" />
+      <stop
+         id="stop8651"
+         offset="1"
+         style="stop-color:#3465a4;stop-opacity:1;" />
+    </linearGradient>
+    <linearGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient4873"
+       id="linearGradient4879"
+       x1="63.397362"
+       y1="-9.3832779"
+       x2="68.910904"
+       y2="16.839214"
+       gradientUnits="userSpaceOnUse" />
+    <linearGradient
+       inkscape:collect="always"
+       id="linearGradient4873">
+      <stop
+         style="stop-color:#ffffff;stop-opacity:1;"
+         offset="0"
+         id="stop4875" />
+      <stop
+         style="stop-color:#ffffff;stop-opacity:0;"
+         offset="1"
+         id="stop4877" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8752"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient8740"
+       inkscape:collect="always">
+      <stop
+         id="stop8742"
+         offset="0"
+         style="stop-color:#ffffff;stop-opacity:1;" />
+      <stop
+         id="stop8744"
+         offset="1"
+         style="stop-color:#ffffff;stop-opacity:0;" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9173"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8760"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9175"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8766"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9177"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8774"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9179"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8782"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,0.79739)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9181"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8788"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9183"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="8.6174498"
+       fy="18.944481"
+       fx="24.652485"
+       cy="18.94449"
+       cx="24.652573"
+       gradientTransform="matrix(0.07657394,2.760516,-1.969551,0.05463895,60.09901,-55.47179)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9185"
+       xlink:href="#linearGradient8924"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient8924">
+      <stop
+         style="stop-color:#cee14b"
+         offset="0"
+         id="stop8926" />
+      <stop
+         style="stop-color:#9db029"
+         offset="1"
+         id="stop8928" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8812"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="8.6174498"
+       fy="18.944481"
+       fx="24.652485"
+       cy="18.94449"
+       cx="24.652573"
+       gradientTransform="matrix(0.06822876,2.459669,-1.754905,0.04868429,55.12882,-46.82188)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9187"
+       xlink:href="#linearGradient8924"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient3308">
+      <stop
+         style="stop-color:#cee14b"
+         offset="0"
+         id="stop3310" />
+      <stop
+         style="stop-color:#9db029"
+         offset="1"
+         id="stop3312" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(0.891018,0,0,0.828854,1.579517,2.39052)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9189"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="4.1347499"
+       fy="14.542329"
+       fx="25.135332"
+       cy="14.542349"
+       cx="25.135374"
+       gradientTransform="matrix(0.159592,5.753335,-0.8072,0.0223703,32.87305,-131.6974)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9191"
+       xlink:href="#linearGradient8930"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient8930">
+      <stop
+         style="stop-color:#cee14b"
+         offset="0"
+         id="stop8932" />
+      <stop
+         style="stop-color:#9db029"
+         offset="1"
+         id="stop8934" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8816"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="4.1347499"
+       fy="14.542329"
+       fx="25.135332"
+       cy="14.542349"
+       cx="25.135374"
+       gradientTransform="matrix(0.159592,5.753335,-0.8072,0.0223703,32.87305,-130.867)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9193"
+       xlink:href="#linearGradient8930"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient3333">
+      <stop
+         style="stop-color:#cee14b"
+         offset="0"
+         id="stop3335" />
+      <stop
+         style="stop-color:#9db029"
+         offset="1"
+         id="stop3337" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,0.589884)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9195"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="2.9719501"
+       fy="17.573889"
+       fx="24.478539"
+       cy="17.573915"
+       cx="24.478569"
+       gradientTransform="matrix(0.222034,8.004376,-0.597156,0.01656095,29.5454,-182.3268)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9197"
+       xlink:href="#linearGradient8912"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient8912">
+      <stop
+         id="stop8914"
+         offset="0"
+         style="stop-color:#cee14b" />
+      <stop
+         id="stop8916"
+         offset="1"
+         style="stop-color:#9db029" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8820"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="2.9719501"
+       fy="17.573889"
+       fx="24.478539"
+       cy="17.573915"
+       cx="24.478569"
+       gradientTransform="matrix(0.222034,8.004376,-0.597156,0.01656095,29.85665,-181.6002)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9199"
+       xlink:href="#linearGradient8912"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient3358">
+      <stop
+         id="stop3360"
+         offset="0"
+         style="stop-color:#cee14b" />
+      <stop
+         id="stop3362"
+         offset="1"
+         style="stop-color:#9db029" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0.311259,0.486131)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9201"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="9.8222504"
+       fy="17.257843"
+       fx="25.968998"
+       cy="17.257854"
+       cx="25.969097"
+       gradientTransform="matrix(0.06718136,2.42191,-1.629357,0.0451789,52.36869,-50.34012)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9203"
+       xlink:href="#linearGradient8918"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient8918">
+      <stop
+         style="stop-color:#cee14b"
+         offset="0"
+         id="stop8920" />
+      <stop
+         style="stop-color:#9db029"
+         offset="1"
+         id="stop8922" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient8824"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <radialGradient
+       r="9.8222504"
+       fy="17.257843"
+       fx="25.968998"
+       cy="17.257854"
+       cx="25.969097"
+       gradientTransform="matrix(0.06168149,2.223638,-1.495968,0.04148028,50.51125,-44.50839)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9205"
+       xlink:href="#linearGradient8918"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient3383">
+      <stop
+         style="stop-color:#cee14b"
+         offset="0"
+         id="stop3385" />
+      <stop
+         style="stop-color:#9db029"
+         offset="1"
+         id="stop3387" />
+    </linearGradient>
+    <radialGradient
+       r="10.081216"
+       fy="-3.4420195"
+       fx="62.225391"
+       cy="-3.4420195"
+       cx="62.225391"
+       gradientTransform="matrix(0.918134,0,0,0.854079,2.429764,1.490099)"
+       gradientUnits="userSpaceOnUse"
+       id="radialGradient9207"
+       xlink:href="#linearGradient8740"
+       inkscape:collect="always" />
+    <linearGradient
+       id="linearGradient4845">
+      <stop
+         style="stop-color:#ffffff;stop-opacity:1;"
+         offset="0"
+         id="stop4847" />
+      <stop
+         style="stop-color:#b6b6b6;stop-opacity:1;"
+         offset="1"
+         id="stop4849" />
+    </linearGradient>
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3780"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3782"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3784"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3786"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3788"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3790"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8924"
+       id="radialGradient3792"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.07657394,2.760516,-1.969551,0.05463895,60.09901,-55.47179)"
+       cx="24.652573"
+       cy="18.94449"
+       fx="24.652485"
+       fy="18.944481"
+       r="8.6174498" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3794"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8930"
+       id="radialGradient3796"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.159592,5.753335,-0.8072,0.0223703,32.87305,-131.6974)"
+       cx="25.135374"
+       cy="14.542349"
+       fx="25.135332"
+       fy="14.542329"
+       r="4.1347499" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3798"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8912"
+       id="radialGradient3800"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.222034,8.004376,-0.597156,0.01656095,29.5454,-182.3268)"
+       cx="24.478569"
+       cy="17.573915"
+       fx="24.478539"
+       fy="17.573889"
+       r="2.9719501" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3802"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8918"
+       id="radialGradient3804"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(0.06718136,2.42191,-1.629357,0.0451789,52.36869,-50.34012)"
+       cx="25.969097"
+       cy="17.257854"
+       fx="25.968998"
+       fy="17.257843"
+       r="9.8222504" />
+    <radialGradient
+       inkscape:collect="always"
+       xlink:href="#linearGradient8740"
+       id="radialGradient3806"
+       gradientUnits="userSpaceOnUse"
+       gradientTransform="matrix(1,0,0,0.930233,0,-0.240141)"
+       cx="62.225391"
+       cy="-3.4420195"
+       fx="62.225391"
+       fy="-3.4420195"
+       r="10.081216" />
+  </defs>
+  <sodipodi:namedview
+     id="base"
+     pagecolor="#ffffff"
+     bordercolor="#666666"
+     borderopacity="1.0"
+     gridtolerance="10000"
+     guidetolerance="10"
+     objecttolerance="10"
+     inkscape:pageopacity="0.0"
+     inkscape:pageshadow="2"
+     inkscape:zoom="1"
+     inkscape:cx="4.1850109"
+     inkscape:cy="8.0291834"
+     inkscape:document-units="px"
+     inkscape:current-layer="layer1"
+     width="48px"
+     height="48px"
+     inkscape:window-width="1281"
+     inkscape:window-height="865"
+     inkscape:window-x="409"
+     inkscape:window-y="190"
+     showgrid="false"
+     showguides="true"
+     inkscape:guide-bbox="true"
+     inkscape:window-maximized="0" />
+  <metadata
+     id="metadata4385">
+    <rdf:RDF>
+      <cc:Work
+         rdf:about="">
+        <dc:format>image/svg+xml</dc:format>
+        <dc:type
+           rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
+        <dc:title></dc:title>
+      </cc:Work>
+    </rdf:RDF>
+  </metadata>
+  <g
+     inkscape:label="Layer 1"
+     inkscape:groupmode="layer"
+     id="layer1"
+     transform="translate(0,-32)">
+    <g
+       id="g3753"
+       transform="matrix(0.56035927,0,0,0.5599497,-35.337715,46.140053)">
+      <g
+         transform="matrix(1.673435,0,0,1.673435,57.560745,-25.211898)"
+         id="g3020"
+         inkscape:label="Layer 1">
+        <g
+           style="display:inline"
+           id="g8936"
+           transform="matrix(1.284706,0,0,1.284706,-63.89629,19.96894)">
+          <path
+             transform="matrix(1,0,0,1.192473,-0.590821,-2.378705)"
+             d="M 73.25,4.625 C 73.25,6.6270322 68.493025,8.25 62.625,8.25 56.756975,8.25 52,6.6270322 52,4.625 52,2.6229678 56.756975,1 62.625,1 68.493025,1 73.25,2.6229678 73.25,4.625 z"
+             sodipodi:ry="3.625"
+             sodipodi:rx="10.625"
+             sodipodi:cy="4.625"
+             sodipodi:cx="62.625"
+             id="path8836"
+             style="opacity:0.56043958;color:#000000;fill:url(#radialGradient9169);fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:0.99999988;marker:none;visibility:visible;display:inline;overflow:visible"
+             sodipodi:type="arc" />
+          <path
+             id="path6495"
+             d="m 71.455637,-3.5111605 c 0,5.1118327 -4.144037,9.255822 -9.255167,9.255822 -5.111598,0 -9.2554,-4.1440362 -9.2554,-9.255822 0,-5.1115983 4.143802,-9.2551665 9.2554,-9.2551665 5.11113,0 9.255167,4.1435682 9.255167,9.2551665 l 0,0 z"
+             style="fill:url(#radialGradient9171);fill-opacity:1;fill-rule:nonzero;stroke:#204a87;stroke-width:0.83038521;stroke-miterlimit:4;stroke-dasharray:none" />
+          <path
+             style="opacity:0.52747258;fill:none;stroke:url(#linearGradient4879);stroke-width:0.83038568;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
+             d="m 70.945908,-3.5111451 c 0,4.8302718 -3.915782,8.7460091 -8.74539,8.7460091 -4.83005,0 -8.745611,-3.9157817 -8.745611,-8.7460091 0,-4.8300503 3.915561,-8.7453899 8.745611,-8.7453899 4.829608,0 8.74539,3.9153396 8.74539,8.7453899 l 0,0 z"
+             id="path8655" />
+          <g
+             id="g6532"
+             style="fill:#9db029;fill-rule:nonzero;stroke:url(#radialGradient3780);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,50.39042,-14.57365)">
+            <path
+               style="fill:#9db029;stroke:url(#radialGradient9173);stroke-width:1.78522193"
+               id="path6534"
+               d="m 26.0703,9.2363 -0.0732,0.4932 0.5098,0.3291 0.8711,-0.5757 -0.4355,-0.4937 -0.582,0.3296 -0.29,-0.0825" />
+          </g>
+          <g
+             id="g6548"
+             style="fill:#9db029;fill-rule:nonzero;stroke:url(#radialGradient3782);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,49.7717,-14.57365)">
+            <path
+               style="fill:#9db029;stroke:url(#radialGradient9175);stroke-width:1.78522193"
+               id="path6550"
+               d="m 28.833,12.7749 -0.291,-0.7412 -0.5098,0.165 0.1465,0.9043 0.6543,-0.3281" />
+          </g>
+          <g
+             id="g6556"
+             style="fill:#9db029;fill-rule:nonzero;stroke:url(#radialGradient3784);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,49.94848,-14.57365)">
+            <path
+               style="fill:#9db029;stroke:url(#radialGradient9177);stroke-width:1.78522193"
+               id="path6558"
+               d="m 29.123,12.6089 -0.1455,0.9883 0.7998,-0.165 0.5811,-0.5752 -0.5088,-0.4941 C 29.6787,11.9078 29.4824,11.483 29.2685,11.0465 l -0.4355,0 0,0.4932 0.29,0.3291 0,0.7402" />
+          </g>
+          <g
+             id="g6572"
+             style="fill:#9db029;fill-rule:nonzero;stroke:url(#radialGradient3786);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,50.39042,-14.57365)">
+            <path
+               style="fill:#9db029;stroke:url(#radialGradient9179);stroke-width:1.78522193"
+               id="path6574"
+               d="m 16.7656,9.5649 0.7266,0.4937 0.582,0 0,-0.5757 -0.7266,-0.3291 -0.582,0.4111" />
+          </g>
+          <g
+             id="g6608"
+             style="fill:#9db029;fill-rule:nonzero;stroke:url(#radialGradient3788);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,50.96494,-14.52946)">
+            <path
+               style="fill:#9db029;stroke:url(#radialGradient9181);stroke-width:1.78522193"
+               id="path6610"
+               d="m 17.4922,7.887132 0.3638,-0.3286 0.7271,-0.1646 c 0.498,-0.2422 0.998,-0.4053 1.5264,-0.5762 l -0.29,-0.4937 -0.9385,0.1348 -0.4434,0.4419 -0.731,0.106 -0.6499,0.3052 -0.3159,0.1528 -0.1929,0.2583 0.9443,0.1641" />
+          </g>
+          <g
+             id="g6616"
+             style="fill:#9db029;fill-rule:nonzero;stroke:url(#radialGradient3790);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,50.56718,-14.30851)">
+            <path
+               style="fill:#9db029;stroke:url(#radialGradient9183);stroke-width:1.78522193"
+               id="path6618"
+               d="m 18.7285,14.6665 0.4365,-0.6582 -0.6548,-0.4932 0.2183,1.1514" />
+          </g>
+          <g
+             id="g6564"
+             style="fill:url(#radialGradient3792);fill-opacity:1;fill-rule:nonzero;stroke:url(#radialGradient3794);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,50.74397,-14.61784)">
+            <path
+               style="fill:url(#radialGradient9187);fill-opacity:1;stroke:url(#radialGradient9189);stroke-width:1.78522193"
+               id="path6566"
+               d="m 17.943241,27.768799 -0.518573,-1.02672 -0.971477,-0.219726 -0.518127,-1.392215 -1.295183,0.146216 -1.100764,-0.805748 -1.166432,1.025918 0,0.161809 C 12.019842,25.55649 11.586095,25.54259 11.271922,25.349417 l -0.259287,-0.732684 0,-0.806638 -0.777056,0.07306 c 0.06487,-0.513404 0.129197,-1.025918 0.194509,-1.539233 l -0.4537956,0 -0.4529044,0.586468 -0.4537955,0.219279 -0.6478592,-0.365495 -0.064866,-0.806639 0.1296431,-0.879702 0.9719225,-0.732684 0.7770571,0 0.129197,-0.440252 0.971477,0.219279 0.712636,0.880593 0.129643,-1.467061 1.230764,-1.025918 0.45335,-1.099872 0.906699,-0.366298 0.518127,-0.732684 1.165541,-0.220973 0.583439,-0.878811 c -0.582993,0 -1.165987,0 -1.74898,0 l 1.10112,-0.513404 0.776612,0 1.101565,-0.367189 0.129643,-0.438559 -0.388929,-0.367188 -0.45335,-0.147018 0.129643,-0.43945 -0.323707,-0.659532 -0.777502,0.292343 0.129643,-0.586022 -0.9067,-0.513405 -0.71219,1.245554 0.06442,0.440252 -0.71219,0.294125 -0.453796,0.952766 -0.194064,-0.879702 -1.230763,-0.513405 -0.194509,-0.659531 1.619336,-0.953657 0.712636,-0.659532 0.06487,-0.8061926 -0.388483,-0.2201702 -0.518127,-0.073509 -0.323707,0.8066378 c 0,0 -0.54165,0.106121 -0.680916,0.140514 -1.778561,1.638938 -5.372215,5.176904 -6.2070989,11.856064 0.033057,0.154859 0.6051795,1.052827 0.6051795,1.052827 l 1.3600498,0.805747 1.3600499,0.367189 0.5834387,0.733486 0.906254,0.659531 0.518127,-0.07306 0.388484,0.174907 0,0.118327 -0.517771,1.392661 -0.388929,0.586468 0.129643,0.294125 -0.323707,1.098091 1.165987,2.126592 1.16554,1.02672 0.518573,0.732684 -0.06522,1.540125 0.38893,0.878811 -0.38893,1.686341 c 0,0 -0.03047,-0.01043 0.01916,0.158334 0.05007,0.168847 2.07527,1.293045 2.204022,1.19735 0.128307,-0.09748 0.237991,-0.182748 0.237991,-0.182748 l -0.129198,-0.365496 0.517771,-0.513404 0.194509,-0.513405 0.84228,-0.294125 0.647413,-1.613188 -0.194063,-0.438559 0.452458,-0.659532 0.971923,-0.220972 0.518572,-1.172936 -0.129643,-1.465279 0.777057,-1.099873 0.129643,-1.099873 c -1.063341,-0.527304 -2.11795,-1.07029 -3.17336,-1.613188" />
+          </g>
+          <g
+             id="g6540"
+             style="fill:url(#radialGradient3796);fill-opacity:1;fill-rule:nonzero;stroke:url(#radialGradient3798);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,50.523,-14.44107)">
+            <path
+               style="fill:url(#radialGradient9193);fill-opacity:1;stroke:url(#radialGradient9195);stroke-width:1.78522193"
+               id="path6542"
+               d="m 26.8701,6.6933256 -1.8906,-0.7407 -2.1797,0.2466 -2.6904,0.7402 -0.5088,0.4941 1.6719,1.1514 0,0.6582 -0.6543,0.6582 0.873,1.7289984 0.5801,-0.3301 0.7285,-1.151399 c 1.123,-0.3471994 2.1299,-0.7406994 3.1973,-1.2343994 l 0.873,-2.2212" />
+          </g>
+          <g
+             id="g6580"
+             style="fill:url(#radialGradient3800);fill-opacity:1;fill-rule:nonzero;stroke:url(#radialGradient3802);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,50.83236,-14.75043)">
+            <path
+               style="fill:url(#radialGradient9199);fill-opacity:1;stroke:url(#radialGradient9201);stroke-width:1.78522193"
+               id="path6582"
+               d="m 15.187259,9.6334723 -0.3638,0.9047987 0.7271,0 0.3638,-0.8227987 c 0.3135,-0.2217 0.6255,-0.4448 0.9448,-0.6582 l 0.7271,0.2471 c 0.4844,0.3291 0.9688,0.6582 1.4536,0.9867997 l 0.7275,-0.6576997 -0.8003,-0.3291 -0.3638,-0.7407 -1.3809,-0.1646 -0.0728,-0.4116 -0.6543,0.165 -0.2904,0.5758 -0.3638,-0.7407 -0.145,0.3291 0.0728,0.8228 -0.5816,0.494" />
+          </g>
+          <g
+             id="g6626"
+             style="fill:url(#radialGradient3804);fill-opacity:1;fill-rule:nonzero;stroke:url(#radialGradient3806);stroke-width:1.78522193;stroke-miterlimit:4"
+             transform="matrix(0.468894,0,0,0.468894,50.12526,-14.48526)">
+            <path
+               style="fill:url(#radialGradient9205);fill-opacity:1;stroke:url(#radialGradient9207);stroke-width:1.78522193"
+               id="path6628"
+               d="m 42.893123,20.729176 c 0,0.241194 0,0 0,0 l -0.500291,0.566672 c -0.306657,-0.361377 -0.650957,-0.66528 -1.000583,-0.982679 l -0.767468,0.112931 -0.701179,-0.792625 0,0.980934 0.600735,0.454568 0.399848,0.452824 0.534354,-0.604316 c 0.134506,0.251936 0.267177,0.503872 0.400765,0.755808 l 0,0.754982 -0.601653,0.679602 -1.101026,0.755808 -0.83385,0.832105 -0.534354,-0.606152 0.267177,-0.679603 -0.533527,-0.604315 -0.901057,-1.92597 -0.767468,-0.867912 -0.200888,0.225953 0.30124,1.095701 0.566672,0.641959 c 0.323642,0.934293 0.643796,1.82727 1.0688,2.720339 0.659036,0 1.280338,-0.06996 1.934875,-0.15241 l 0,0.529029 -0.800704,1.964072 -0.734324,0.830269 -0.600735,1.285754 c 0,0.70476 0,1.40952 0,2.114188 l 0.200888,0.832105 -0.333558,0.376618 -0.735242,0.45365 -0.767468,0.641959 0.634798,0.717338 -0.867912,0.756727 0.166733,0.489549 -1.301914,1.474064 -0.866994,0 -0.734324,0.45365 -0.468064,0 0,-0.604316 -0.199052,-1.210468 c -0.258271,-0.758562 -0.527192,-1.511708 -0.800705,-2.264853 0,-0.55593 0.03314,-1.106443 0.06638,-1.662282 l 0.334477,-0.754981 -0.468065,-0.907392 0.03406,-1.246275 -0.634798,-0.717338 0.317399,-1.038318 -0.516451,-0.585953 -0.901974,0 -0.300322,-0.339801 -0.901057,0.567131 -0.366702,-0.416466 -0.834768,0.717706 C 27.577179,26.356327 27.009588,25.714368 26.44209,25.072409 l -0.667116,-1.586995 0.600735,-0.905555 -0.333558,-0.377445 0.733405,-1.738579 c 0.602571,-0.749564 1.231952,-1.468647 1.868586,-2.190392 l 1.135089,-0.302158 1.267852,-0.150666 0.867912,0.226871 1.234615,1.245357 0.434001,-0.490467 0.599817,-0.07529 1.135089,0.377445 0.867913,0 0.600735,-0.529029 0.267177,-0.377445 -0.601654,-0.377445 -1.0015,-0.07529 c -0.277919,-0.385524 -0.53619,-0.790789 -0.866168,-1.133344 l -0.334476,0.150665 -0.133589,0.982679 -0.600735,-0.679603 -0.13267,-0.756726 -0.667116,-0.527192 -0.268095,0 0.667942,0.754981 -0.267177,0.679603 -0.533527,0.150666 0.333558,-0.679603 -0.601654,-0.30124 -0.532609,-0.604315 -1.002419,0.225952 -0.13267,0.30124 -0.600735,0.378363 -0.333558,0.831187 -0.83385,0.415088 -0.36762,-0.415088 -0.399848,0 0,-1.360124 0.867912,-0.45365 0.667116,0 -0.134506,-0.52811 -0.53261,-0.529029 0.900231,-0.189228 0.500291,-0.565754 0.399847,-0.680521 0.735242,0 -0.200888,-0.52811 0.468065,-0.302158 0,0.604315 1.000582,0.225953 1.000583,-0.830268 0.06721,-0.378363 0.866994,-0.603857 c -0.313818,0.03902 -0.627636,0.06767 -0.934293,0.151125 l 0,-0.680429 0.333558,-0.755441 -0.333558,0 -0.733038,0.679603 -0.200888,0.377904 0.200888,0.529488 -0.334476,0.905555 -0.533528,-0.302158 -0.466229,-0.52811 -0.735241,0.52811 -0.267177,-1.208172 1.267851,-0.830728 0,-0.4536504 0.801531,-0.5285696 1.267851,-0.302617 0.867912,0.302617 1.601318,0.3021579 -0.399848,0.4528241 -0.867912,0 0.867912,0.906474 0.667117,-0.754982 0.202632,-0.3321814 c 0,0 2.558931,2.2934994 4.021335,4.8023004 1.462404,2.509628 2.149168,5.46758 2.149168,6.068315 z" />
+          </g>
+        </g>
+      </g>
+    </g>
+    <path
+       inkscape:export-ydpi="90.969795"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       style="opacity:0.5;color:#000000;fill:#000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.99999994;marker:none;visibility:visible;display:inline;overflow:visible;filter:url(#filter4365-8);enable-background:accumulate"
+       d="m 18.908219,29.353351 c -0.391288,-3.14353 -3.750382,-17.816059 0.873712,-17.99089 4.624094,-0.17483 8.421675,13.17823 8.870585,17.35476 0.44891,4.17653 -1.034676,7.92279 8.911474,5.63157 4.41816,-1.01777 6.913682,-3.46176 6.608822,2.63073 -0.304861,6.0925 -11.317041,6.27082 -16.519722,6.69139 -13.970653,0.79434 -24.5932327,-0.41429 -24.4535037,-3.86666 0.139739,-3.45238 0.317743,-4.89768 2.884705,-4.42875 17.1612117,3.13501 13.2043307,-2.96608 12.8239277,-6.02215 z"
+       id="path4316-8"
+       sodipodi:nodetypes="czzszcssz"
+       transform="matrix(0.56035927,0,0,0.5599497,-5.4359794,26.248294)" />
+    <path
+       sodipodi:nodetypes="czzszcssz"
+       id="path4800-4"
+       d="m 4.5000931,43.426686 c -0.219262,-1.760219 -0.226561,-10.163595 2.3645931,-10.261491 2.5911518,-0.0979 2.8441618,7.566642 3.0957128,9.905291 0.251551,2.338649 -0.579791,4.436363 4.993627,3.153398 2.475757,-0.569903 3.874146,-1.938413 3.703315,1.473078 -0.170832,3.41149 -6.341609,3.511339 -9.25698,3.746837 -7.8285837,0.444794 -13.7810448,-0.231981 -13.7027463,-2.165132 0.078304,-1.933158 0.1780504,-2.742455 1.616471,-2.479877 9.6164445,1.755444 7.3991694,-1.660856 7.1860074,-3.372104 z"
+       style="color:#000000;fill:#204a87;fill-opacity:1;fill-rule:nonzero;stroke:#0c1c34;stroke-width:0.99999994;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none;stroke-dashoffset:0;marker:none;visibility:visible;display:inline;overflow:visible;enable-background:accumulate"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+    <path
+       sodipodi:type="inkscape:offset"
+       inkscape:radius="-1.1348268"
+       inkscape:original="M 6.875 33.15625 C 4.2838459 33.254146 4.280738 41.677281 4.5 43.4375 C 4.713162 45.148748 6.9289445 48.567944 -2.6875 46.8125 C -4.1259206 46.549922 -4.234196 47.348092 -4.3125 49.28125 C -4.3907985 51.214401 1.5776663 51.882294 9.40625 51.4375 C 12.321621 51.202002 18.485418 51.09899 18.65625 47.6875 C 18.827081 44.276009 17.444507 45.648847 14.96875 46.21875 C 9.395332 47.501715 10.220301 45.401149 9.96875 43.0625 C 9.717199 40.723851 9.4661518 33.05835 6.875 33.15625 z "
+       xlink:href="#path4800-4"
+       style="opacity:0.4;fill:none;stroke:#ffffff;stroke-width:0.98994249;stroke-linecap:butt;stroke-linejoin:miter;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
+       inkscape:href="#path4800-4"
+       d="m 6.46875,32.9375 c 0.025573,-9.66e-4 0.092066,-0.04483 0,0.0625 -0.092066,0.107328 -0.2437932,0.365129 -0.375,0.75 -0.2624137,0.769742 -0.4722977,1.988766 -0.5625,3.25 -0.1804045,2.522467 0.00397,5.404249 0.09375,6.125 0.029211,0.234501 0.2047707,0.779946 0.3125,1.4375 0.1077293,0.657554 0.1380328,1.557245 -0.4375,2.34375 -0.5755328,0.786505 -1.5621097,1.196968 -2.875,1.3125 -1.3128903,0.115532 -3.07068995,-0.01958 -5.53125,-0.46875 -0.1129238,-0.02061 -0.072795,9.86e-4 -0.125,0 -0.024806,0.121718 -0.1164141,0.534105 -0.15625,1.28125 0.02735,0.03251 0.1330563,0.130825 0.375,0.25 0.4838873,0.238349 1.3978813,0.516737 2.5625,0.6875 2.3216533,0.340413 5.7137256,0.404467 9.5625,0.1875 0.012573,-7.09e-4 0.018667,7.15e-4 0.03125,0 1.507733,-0.120857 3.69374,-0.220359 5.4375,-0.65625 0.876819,-0.21918 1.639483,-0.529035 2.09375,-0.875 0.454267,-0.345965 0.630576,-0.643541 0.65625,-1.15625 0.02933,-0.585716 -0.03225,-0.764195 -0.0625,-0.9375 -0.255524,0.08141 -1.033004,0.344855 -2.25,0.625 -1.453362,0.334555 -2.533373,0.473775 -3.4375,0.40625 -0.904127,-0.06753 -1.701577,-0.388171 -2.1875,-1 C 9.1078273,45.950671 8.9899007,45.243638 8.9375,44.65625 8.8850993,44.068862 8.8976522,43.532374 8.84375,43.03125 8.713465,41.820001 8.4747721,39.079439 7.96875,36.6875 7.715739,35.491531 7.3819481,34.378378 7.03125,33.6875 6.855901,33.342061 6.6717523,33.096979 6.5625,33 6.4532477,32.903021 6.4692804,32.93748 6.46875,32.9375 z"
+       id="path117-4" />
+    <path
+       style="opacity:0.2;fill:#ffffff;fill-opacity:1;fill-rule:evenodd;stroke:none"
+       d="m 17.254872,46.49876 c -5.511592,2.976077 -11.9409379,1.674853 -20.611452,3.111147 0.02408,0.01124 0.034107,-0.07576 0.059747,-0.06465 0.5619372,0.243475 1.4980856,0.555724 2.6886544,0.707661 2.3811425,0.303878 5.9942573,0.468296 9.8804766,0.273196 3.373936,-0.167709 6.720861,-0.61555 7.689192,-1.613461 1.638069,-1.392612 0.08397,-3.067834 0.293382,-2.413896 z"
+       id="path3144-3"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795"
+       sodipodi:nodetypes="ccssccc" />
+    <path
+       transform="matrix(0.24322418,0.01152635,-0.01019829,0.20971828,19.400504,25.130852)"
+       d="m -49.351351,72.837837 a 11.297297,24.675676 0 1 1 -22.594593,0 11.297297,24.675676 0 1 1 22.594593,0 z"
+       sodipodi:ry="24.675676"
+       sodipodi:rx="11.297297"
+       sodipodi:cy="72.837837"
+       sodipodi:cx="-60.648647"
+       id="path2892-3"
+       style="fill:url(#radialGradient5424);fill-opacity:1;stroke:#000000;stroke-width:4.42260885;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
+       sodipodi:type="arc"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+    <path
+       transform="matrix(1.1650949,0.05521283,-0.05596096,1.1507874,-3.5476997,13.806989)"
+       d="m 8.1756756,23.621622 a 0.81756759,1.6351352 0 1 1 -1.6351351,0 0.81756759,1.6351352 0 1 1 1.6351351,0 z"
+       sodipodi:ry="1.6351352"
+       sodipodi:rx="0.81756759"
+       sodipodi:cy="23.621622"
+       sodipodi:cx="7.358108"
+       id="path7470-3"
+       style="fill:url(#radialGradient5426);fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:1;marker:none;visibility:visible;display:inline;overflow:visible"
+       sodipodi:type="arc"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+    <path
+       transform="matrix(0.24228353,-0.02413169,0.02130274,0.2088968,23.93342,22.728781)"
+       d="m -49.351351,72.837837 a 11.297297,24.675676 0 1 1 -22.594593,0 11.297297,24.675676 0 1 1 22.594593,0 z"
+       sodipodi:ry="24.675676"
+       sodipodi:rx="11.297297"
+       sodipodi:cy="72.837837"
+       sodipodi:cx="-60.648647"
+       id="path8367-1"
+       style="fill:url(#radialGradient5428);fill-opacity:1;stroke:#000000;stroke-width:4.42260027;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
+       sodipodi:type="arc"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+    <path
+       transform="matrix(1.1558647,0.15502396,-0.15716315,1.1415724,6.4094422,13.068751)"
+       d="m 8.1756756,23.621622 a 0.81756759,1.6351352 0 1 1 -1.6351351,0 0.81756759,1.6351352 0 1 1 1.6351351,0 z"
+       sodipodi:ry="1.6351352"
+       sodipodi:rx="0.81756759"
+       sodipodi:cy="23.621622"
+       sodipodi:cx="7.358108"
+       id="path8369-4"
+       style="fill:url(#radialGradient5430);fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:1;marker:none;visibility:visible;display:inline;overflow:visible"
+       sodipodi:type="arc"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+    <path
+       transform="matrix(0.24322418,0.01152635,-0.01019829,0.20971828,19.400504,25.130852)"
+       d="m -49.351351,72.837837 a 11.297297,24.675676 0 1 1 -22.594593,0 11.297297,24.675676 0 1 1 22.594593,0 z"
+       sodipodi:ry="24.675676"
+       sodipodi:rx="11.297297"
+       sodipodi:cy="72.837837"
+       sodipodi:cx="-60.648647"
+       id="path3030-5"
+       style="opacity:0.5;fill:none;stroke:url(#linearGradient5432);stroke-width:4.42260885;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
+       sodipodi:type="arc"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+    <path
+       transform="matrix(0.24228353,-0.02413169,0.02130274,0.2088968,23.93342,22.728781)"
+       d="m -49.351351,72.837837 a 11.297297,24.675676 0 1 1 -22.594593,0 11.297297,24.675676 0 1 1 22.594593,0 z"
+       sodipodi:ry="24.675676"
+       sodipodi:rx="11.297297"
+       sodipodi:cy="72.837837"
+       sodipodi:cx="-60.648647"
+       id="path3032-1"
+       style="opacity:0.5;fill:none;stroke:url(#linearGradient5434);stroke-width:4.42260027;stroke-miterlimit:4;stroke-opacity:1;stroke-dasharray:none"
+       sodipodi:type="arc"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+    <path
+       sodipodi:type="arc"
+       style="opacity:0.95;fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1.11899996;marker:none;visibility:visible;display:inline;overflow:visible"
+       id="path4983-8"
+       sodipodi:cx="-1.125"
+       sodipodi:cy="19.875"
+       sodipodi:rx="1"
+       sodipodi:ry="1"
+       d="m -0.125,19.875 a 1,1 0 1 1 -2,0 1,1 0 1 1 2,0 z"
+       transform="matrix(0.58537214,0.08614389,-0.08724602,0.57818687,6.0616542,30.911201)"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+    <path
+       sodipodi:type="arc"
+       style="opacity:0.95;fill:#000000;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:1.11899996;marker:none;visibility:visible;display:inline;overflow:visible"
+       id="path4985-2"
+       sodipodi:cx="-1.125"
+       sodipodi:cy="19.875"
+       sodipodi:rx="1"
+       sodipodi:ry="1"
+       d="m -0.125,19.875 a 1,1 0 1 1 -2,0 1,1 0 1 1 2,0 z"
+       transform="matrix(0.4897433,0.32815837,-0.33235698,0.48373187,18.295773,32.580655)"
+       inkscape:export-filename="/home/thp/src/gpodder/data/gpodder.png"
+       inkscape:export-xdpi="90.969795"
+       inkscape:export-ydpi="90.969795" />
+  </g>
+</svg>
diff --git a/mygpo.lighttpd.conf b/mygpo.lighttpd.conf
index af55e33..0d26706 100644
--- a/mygpo.lighttpd.conf
+++ b/mygpo.lighttpd.conf
@@ -48,6 +48,7 @@ $HTTP["host"] == mygpo_domain {
 	)
 	url.rewrite-once = (
 		"^(/media.*)$" => "$1",
+		"^/(favicon\.ico|robots\.txt)$" => "/$1",
 		"^(/.*)$" => "/mygpo.fcgi$1",
 	)
 }
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 66cfce0..51b5377 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -20,7 +20,7 @@
 -->
   <title>{% block title %}{% endblock %}my.gPodder.org</title>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
-  <link rel="shortcut icon" href="http://gpodder.org/favicon.png">
+  <link rel="shortcut icon" href="http://my.gpodder.org/favicon.png">
   <link rel="stylesheet" href="/media/screen.css" type="text/css" />
   <link rel="stylesheet" href="/media/screen-base.css" type="text/css" />
  </head>

commit 51ede2e24c7e65ef698f3f571858612d2ffa0e5c
Merge: 885f5b5... c9413e3...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Jan 6 12:37:53 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit 885f5b5f0806eda011dd583458f528ca436cc83c
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Jan 6 12:36:34 2010 +0100

    subscribe to my.gpodder.org - redirect + missing picture

diff --git a/htdocs/media/subscribe.png b/htdocs/media/subscribe.png
new file mode 100644
index 0000000..a6688c3
Binary files /dev/null and b/htdocs/media/subscribe.png differ
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index bc51ca7..00b0e72 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -272,14 +272,6 @@ def podcast_subscribe_url(request):
          
     podcast, created = Podcast.objects.get_or_create(url=url,
             defaults={'title':url,'description':url,'last_update':datetime.now()})
-    devices = Device.objects.filter(user=request.user)
-    history = SubscriptionAction.objects.filter(podcast=podcast,device__in=devices).order_by('-timestamp')
-    subscribed_devices = [s.device for s in Subscription.objects.filter(podcast=podcast,user=request.user)]
-    episodes = episode_list(podcast, request.user)
-    return render_to_response('podcast.html', {
-        'history': history,
-        'podcast': podcast,
-        'devices': subscribed_devices,
-        'episodes': episodes,
-    }, context_instance=RequestContext(request))
+            
+    return HttpResponseRedirect('/podcast/%d/subscribe' % podcast.pk)
     

commit c9413e3ae0c29039f86e1b2dd2473608f41c4663
Merge: 11661c3... ca107d2...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Jan 6 12:21:37 2010 +0100

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit 11661c3a089a7d64a701d2b972a1c235898691c6
Author: Jim Nygrd <jim@nygard.priv.no>
Date:   Wed Jan 6 12:05:45 2010 +0100

    add translation for Norwegian Bokml

diff --git a/mygpo/locale/nb/LC_MESSAGES/django.po b/mygpo/locale/nb/LC_MESSAGES/django.po
new file mode 100644
index 0000000..152ed35
--- /dev/null
+++ b/mygpo/locale/nb/LC_MESSAGES/django.po
@@ -0,0 +1,433 @@
+# SOME DESCRIPTIVE TITLE.
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+# Jim Nygrd <jim@nygard.priv.no>, 2010, 2010.
+msgid ""
+msgstr ""
+"Project-Id-Version: 2.1\n"
+"Report-Msgid-Bugs-To: \n"
+"POT-Creation-Date: 2010-01-05 23:28+0100\n"
+"PO-Revision-Date: 2010-01-06 11:48+0100\n"
+"Last-Translator: Jim Nygrd <jim@nygard.priv.no>\n"
+"Language-Team: gpodder <>\n"
+"Language: nb\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+"Plural-Forms: nplurals=2; plural=(n != 1);\n"
+"X-Generator: Virtaal 0.3.1\n"
+
+#: api/models.py:167
+#, python-format
+msgid "Unnamed Device (%s)"
+msgstr "Enhet uten navn (%s)"
+
+#: web/forms.py:7
+msgid "Your Email Address"
+msgstr "Din e-postadresse"
+
+#: web/forms.py:8
+msgid "May we use your subscriptions for the toplist and suggestions?"
+msgstr "Kan vi bruke dine abonnement til topplisten og forslagslisten?"
+
+#: web/forms.py:11
+msgid "Name of this device"
+msgstr "Navn p enheten"
+
+#: web/forms.py:12
+msgid "What kind of device is this?"
+msgstr "Hva slags enhet er dette?"
+
+#: web/forms.py:13
+msgid "What UID is configured on the pysical device?"
+msgstr "Hvilken UID er konfigurert p den fysiske enheten?"
+
+#: web/views.py:103
+msgid "With which client do you want to subscribe?"
+msgstr "Med hvilken klient vil du abonnere?"
+
+#: web/views.py:168
+#, python-format
+msgid "my.gpodder.org - Top %s"
+msgstr "my.gpodder.org - Topp %s"
+
+#: web/views.py:194
+#, python-format
+msgid "my.gpodder.org - %s Suggestions"
+msgstr "my.gpodder.org - %s Forslag"
+
+#: web/views.py:208
+msgid "Synchronize with the following devices"
+msgstr "Synkroniser med disse enhetene"
+
+#: web/templates/account.html:5
+msgid "Account Settings"
+msgstr "Kontoinnstillinger"
+
+#: web/templates/account.html:8 web/templates/device.html:50
+msgid "Your settings have been saved."
+msgstr "Dine innstillinger er lagret."
+
+#: web/templates/account.html:11
+msgid "Update the settings for your account"
+msgstr "Oppdater innstillingene for kontoen din"
+
+#: web/templates/device.html:9
+msgid "Podcasts"
+msgstr "Podcaster"
+
+#: web/templates/device.html:10
+msgid "You have subscribed the following podcasts on this device"
+msgstr "Du abonnerer p flgende podcaster p denne enheten"
+
+#: web/templates/device.html:14 web/templates/podcast.html:37
+msgid "Title"
+msgstr "Tittel"
+
+#: web/templates/device.html:15
+msgid "Since"
+msgstr "Siden"
+
+#: web/templates/device.html:27
+msgid "Synchronize"
+msgstr "Synkroniser"
+
+#: web/templates/device.html:28
+msgid ""
+"If you synchronize devices, they will always have the same subscriptions. A "
+"podcast that is subscribed on one device, will automatically be added to all "
+"synchronized devices."
+msgstr ""
+"Nr du synkroniserer enheter vil de alltid ha de samme abonnementene. En "
+"podcast som blir lagt til p en enhet vil automatisk bli lagt til p alle "
+"synkroniserte enheter."
+
+#: web/templates/device.html:32
+#, python-format
+msgid "%(devicename)s is currently not synchronized with other devices."
+msgstr "%(devicename)s er for yeblikket ikke synkronisert med andre enheter."
+
+#: web/templates/device.html:36
+#, python-format
+msgid "%(devicename)s is currently synchronized with %(synclist)s."
+msgstr "%(devicename)s er for yeblikket synkronisert med %(synclist)s."
+
+#: web/templates/device.html:37
+#, python-format
+msgid "Stop synchronisation for %(devicename)s "
+msgstr "Stopp synkroniserine av %(devicename)s "
+
+#: web/templates/device.html:44 web/templates/subscribe.html:20
+msgid "OK"
+msgstr "OK"
+
+#: web/templates/episode.html:7
+#, python-format
+msgid ""
+"An episode of the <a href=\"/podcast/%(podcast_id)s\">%(podcast)s</a> "
+"podcast."
+msgstr ""
+"En episode fra <a href=\"/podcast/%(podcast_id)s\">%(podcast)s</a> podcast."
+
+#: web/templates/episode.html:22
+msgid "Your Episode History"
+msgstr "Din episodehistorikk"
+
+#: web/templates/episode.html:25
+msgid "When"
+msgstr "Nr"
+
+#: web/templates/episode.html:26
+msgid "What"
+msgstr "Hva"
+
+#: web/templates/episode.html:27
+msgid "Where"
+msgstr "Hvor"
+
+#: web/templates/episode.html:41
+msgid "Why Unnamed Episode?"
+msgstr "Episoden uten navn?"
+
+#: web/templates/episode.html:41 web/templates/podcast.html:80
+#: web/templates/subscribe.html:24
+msgid ""
+"Because we display names after we have fetched the information form the feed "
+"-- and this may take some time. Until this is completed, the podcast will "
+"simply be called this way."
+msgstr ""
+"Fordi vi viser navnene etter  ha hentet informasjonen i strmmen, dette kan "
+"ta litt tid. I mellomtiden vil podcasten vises uten navn."
+
+#: web/templates/home-user.html:6
+msgid "my.gpodder.org"
+msgstr "my.gpodder.org"
+
+#: web/templates/home-user.html:9
+msgid "Your Subscriptions"
+msgstr "Dine Abonnement"
+
+#: web/templates/home-user.html:13 web/templates/suggestions.html:17
+#: web/templates/toplist.html:13
+msgid "Podcast"
+msgstr "Podcast"
+
+#: web/templates/home-user.html:14
+msgid "Latest Episode"
+msgstr "Siste episode"
+
+#: web/templates/home-user.html:15
+msgid "Subscribed on"
+msgstr "Abonnert p"
+
+#: web/templates/home-user.html:37
+msgid "Where to start?"
+msgstr "Hvor skal jeg begynne?"
+
+#: web/templates/home-user.html:38
+#, python-format
+msgid ""
+"my.gpodder.org help you to track your podcasts which you have subscribed on "
+"your devices - desktop computer, notebook, mobile devices, etc. To start "
+"using my.gpodder.org set up <a href=\"http://gpodder.org\">gPodder</a> with "
+"your username &ndash; <strong>%(username)s</strong> &ndash; and password and "
+"upload your podcasts. They will automatically show up here."
+msgstr ""
+"my.gpodder.org hjelper deg  holde oversikt over podcastabonnement p flere "
+"enheter - PCer, mobiltelefoner, mp3 spillere, osv. For  komme i gang med my."
+"gpodder.org sett opp <a href=\"http://gpodder.org\">gPodder</a> med "
+"brukernavn &ndash; <strong>%(username)s</strong> &ndash; og passord og last "
+"opp dine podcaster. De vil vises her automatisk."
+
+#: web/templates/home.html:6
+msgid ""
+"my.gpodder.org is a webservice for synchronizing podcast subscriptions on "
+"several devices and applications."
+msgstr ""
+"my.gpodder.org er en nettside for synkroniseringe av pocastabonnementer p "
+"flere enheter og programmer."
+
+#: web/templates/home.html:8
+#, python-format
+msgid "We are currently tracking %(podcast_count)s Podcasts!"
+msgstr "Vi flger for yeblikket %(podcast_count)s podcaster!"
+
+#: web/templates/home.html:20 web/templates/login.html:14
+msgid "Not yet a member?"
+msgstr "Ikke medlem enn?"
+
+#: web/templates/home.html:20 web/templates/login.html:14
+msgid "Register!"
+msgstr "Registrer!"
+
+#: web/templates/migrate.html:5
+msgid ""
+"The new my.gpodder.org uses usernames instead of email addresses. Based on "
+"your email address, we think you might like "
+msgstr ""
+"Den nye my.gpodder.org bruker brukernavn i stedet for e-postadresse. Basert "
+"p din e-postadresse foreslr vi "
+
+#: web/templates/migrate.html:5
+msgid ", but you can change that if you want to."
+msgstr ", men du kan endre dette hvis du nsker."
+
+#: web/templates/migrate.html:11
+msgid ""
+"You can keep your old user settings in gPodder. Once the next version (with "
+"lots of new features) is release, you'll have to replace your email address "
+"with your username."
+msgstr ""
+"Du kan beholde dine gamle innstillinger i gPodder. Nr den neste versjonen "
+"(med mange nye funksjoner) er tilgjeng m du bytte ut e-postadressen med "
+"brukernavnet ditt."
+
+#: web/templates/podcast.html:7
+msgid "Unnamed Podcast"
+msgstr "Podcast uten navn"
+
+#: web/templates/podcast.html:17 web/templates/subscribe.html:7
+#, python-format
+msgid "Subscribe to %(podcasttitle)s"
+msgstr "Abonner p %(podcasttitle)s"
+
+#: web/templates/podcast.html:19 web/templates/subscribe.html:9
+msgid "Subscribe to this podcast"
+msgstr "Abonner p denne podcasten"
+
+#: web/templates/podcast.html:23 web/templates/podcast.html.py:60
+msgid "Devices"
+msgstr "Enheter"
+
+#: web/templates/podcast.html:24
+msgid "You have subscribed this podcast on"
+msgstr "Du abonnerer p denne podcasten p"
+
+#: web/templates/podcast.html:33
+msgid "Episodes"
+msgstr "Episoder"
+
+#: web/templates/podcast.html:38
+msgid "Description"
+msgstr "Beskrivelse"
+
+#: web/templates/podcast.html:39
+msgid "Released"
+msgstr "Utgitt"
+
+#: web/templates/podcast.html:55
+msgid "Subscription History"
+msgstr "Abonnementshistorikk"
+
+#: web/templates/podcast.html:58
+msgid "Timestamp"
+msgstr "Tidspunkt"
+
+#: web/templates/podcast.html:59
+msgid "Action"
+msgstr "Handling"
+
+#: web/templates/podcast.html:67
+msgid "subscribe"
+msgstr "abonner"
+
+#: web/templates/podcast.html:70
+msgid "unsubscribe"
+msgstr "avslutt abonnement"
+
+#: web/templates/podcast.html:80 web/templates/subscribe.html:24
+msgid "Why Unnamed Podcast?"
+msgstr "Podcast uten navn?"
+
+#: web/templates/suggestions.html:10
+msgid "Suggested Podcasts"
+msgstr "Podcastforslag"
+
+#: web/templates/suggestions.html:12
+#, python-format
+msgid "We've selected %(suggestion_count)s podcasts which you might like."
+msgstr "Vi har valgt %(suggestion_count)s podcaster som du kanskje liker."
+
+#: web/templates/suggestions.html:18
+msgid "URL"
+msgstr "URL"
+
+#: web/templates/suggestions.html:30
+msgid "Do you like our suggestions?"
+msgstr "Liker du vre anbefalinger?"
+
+#: web/templates/toplist.html:5
+msgid "Toplist"
+msgstr "Toppliste"
+
+#: web/templates/toplist.html:7
+#, python-format
+msgid "These are the %(count)s most subscribed podcasts."
+msgstr "Dette er de %(count)s mest populre podcastene."
+
+#: web/templates/toplist.html:11
+msgid "#"
+msgstr "#"
+
+#: web/templates/toplist.html:12
+msgid "Last week"
+msgstr "Forrige uke"
+
+#: web/templates/toplist.html:14
+msgid "Subscribers"
+msgstr "Abonnenter"
+
+#: web/templates/registration/activate.html:5
+#: web/templates/registration/activation_complete.html:4
+msgid "Account activated"
+msgstr "Konto aktivert"
+
+#: web/templates/registration/activate.html:6
+#: web/templates/registration/activation_complete.html:5
+msgid "Your account has been activated! Enjoy using my.gpodder.org"
+msgstr "Kontoen er aktivert! Velkommen til my.gpodder.org"
+
+#: web/templates/registration/activate.html:8
+msgid "Account not activated"
+msgstr "Kontoen er ikke aktivert"
+
+#: web/templates/registration/activate.html:9
+msgid "Your account could not be activated successfully."
+msgstr "Kontoen kunne ikke aktiveres."
+
+#: web/templates/registration/registration_complete.html:4
+msgid "Registration complete"
+msgstr "Du er n registert"
+
+#: web/templates/registration/registration_complete.html:5
+msgid ""
+"Please confirm your account using the email you should just have recieved."
+msgstr "Du m bekrefte kontoen med e-posten du n skal ha mottatt."
+
+#: web/templates/registration/registration_form.html:4
+msgid "Create a User Account"
+msgstr "Opprett en brukerkonto"
+
+#: web/templates/search/search.html:6
+msgid "Search"
+msgstr "Sk"
+
+#: web/templates/search/search.html:20
+msgid "Results"
+msgstr "Resultater"
+
+#: web/templatetags/devices.py:11
+msgid "Desktop"
+msgstr "Desktop"
+
+#: web/templatetags/devices.py:13
+msgid "Laptop"
+msgstr "Laptop"
+
+#: web/templatetags/devices.py:15
+msgid "Mobile"
+msgstr "Mobil"
+
+#: web/templatetags/devices.py:17
+msgid "Server"
+msgstr "Server"
+
+#: web/templatetags/devices.py:19
+msgid "Other"
+msgstr "Annen"
+
+#: web/templatetags/episodes.py:10
+msgid "This episode has not yet been played"
+msgstr "Denne episoden er ikke avspilt enn"
+
+#: web/templatetags/episodes.py:13 web/templatetags/episodes.py:14
+#, python-format
+msgid " on %s"
+msgstr "p %s"
+
+#: web/templatetags/episodes.py:17
+msgid "This episode has been marked new"
+msgstr "Denne episoden er markert som ny"
+
+#: web/templatetags/episodes.py:19
+msgid "This episode has been downloaded"
+msgstr "Denne episoden er lastet ned"
+
+#: web/templatetags/episodes.py:21
+msgid "This episode has been played"
+msgstr "Denne episoden er avspilt"
+
+#: web/templatetags/episodes.py:23
+msgid "This episode has been deleted"
+msgstr "Denne episoden er slettet"
+
+#: web/templatetags/podcasts.py:12
+msgid "Logo"
+msgstr "Logo"
+
+#: web/templatetags/podcasts.py:14
+msgid "No Logo available"
+msgstr "Ingen logo tilgjengelig"
+
+#~ msgid "back!"
+#~ msgstr "zurck!"

commit ab9d1cecb00d38ecce2bba1d04db7edb0681dc6a
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Jan 5 23:29:48 2010 +0100

    generated po files for de, it

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index 7fd4c26..b665ba2 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2009-11-30 18:29+0100\n"
+"POT-Creation-Date: 2010-01-05 23:28+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -16,49 +16,178 @@ msgstr ""
 "Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: 8bit\n"
 
-#: web/templates/home-user.html:5
-msgid "Your Subscriptions"
-msgstr "Deine Abonnements"
+#: api/models.py:167
+#, python-format
+msgid "Unnamed Device (%s)"
+msgstr ""
 
-#: web/templates/home-user.html:9
+#: web/forms.py:7
+msgid "Your Email Address"
+msgstr ""
+
+#: web/forms.py:8
+msgid "May we use your subscriptions for the toplist and suggestions?"
+msgstr ""
+
+#: web/forms.py:11
+msgid "Name of this device"
+msgstr ""
+
+#: web/forms.py:12
+msgid "What kind of device is this?"
+msgstr ""
+
+#: web/forms.py:13
+msgid "What UID is configured on the pysical device?"
+msgstr ""
+
+#: web/views.py:103
+msgid "With which client do you want to subscribe?"
+msgstr ""
+
+#: web/views.py:168
+#, python-format
+msgid "my.gpodder.org - Top %s"
+msgstr ""
+
+#: web/views.py:194
+#, python-format
+msgid "my.gpodder.org - %s Suggestions"
+msgstr ""
+
+#: web/views.py:208
+msgid "Synchronize with the following devices"
+msgstr ""
+
+#: web/templates/account.html:5
+msgid "Account Settings"
+msgstr ""
+
+#: web/templates/account.html:8 web/templates/device.html:50
+msgid "Your settings have been saved."
+msgstr ""
+
+#: web/templates/account.html:11
+msgid "Update the settings for your account"
+msgstr ""
+
+#: web/templates/device.html:9
+msgid "Podcasts"
+msgstr ""
+
+#: web/templates/device.html:10
+msgid "You have subscribed the following podcasts on this device"
+msgstr ""
+
+#: web/templates/device.html:14 web/templates/podcast.html:37
 msgid "Title"
 msgstr "Titel"
 
-#: web/templates/home-user.html:10
-msgid "Latest Episode"
-msgstr "Letzte Episode"
+#: web/templates/device.html:15
+msgid "Since"
+msgstr ""
 
-#: web/templates/home-user.html:11
-msgid "Devices"
-msgstr "Gerte"
+#: web/templates/device.html:27
+msgid "Synchronize"
+msgstr ""
 
-#: web/templates/subscriptionhistory.html:5
-msgid "Subscription History"
+#: web/templates/device.html:28
+msgid ""
+"If you synchronize devices, they will always have the same subscriptions. A "
+"podcast that is subscribed on one device, will automatically be added to all "
+"synchronized devices."
+msgstr ""
+
+#: web/templates/device.html:32
+#, python-format
+msgid "%(devicename)s is currently not synchronized with other devices."
+msgstr ""
+
+#: web/templates/device.html:36
+#, python-format
+msgid "%(devicename)s is currently synchronized with %(synclist)s."
+msgstr ""
+
+#: web/templates/device.html:37
+#, python-format
+msgid "Stop synchronisation for %(devicename)s "
+msgstr ""
+
+#: web/templates/device.html:44 web/templates/subscribe.html:20
+msgid "OK"
+msgstr ""
+
+#: web/templates/episode.html:7
+#, python-format
+msgid ""
+"An episode of the <a href=\"/podcast/%(podcast_id)s\">%(podcast)s</a> "
+"podcast."
+msgstr ""
+
+#: web/templates/episode.html:22
+#, fuzzy
+msgid "Your Episode History"
 msgstr "Abonnementverlauf"
 
-#: web/templates/subscriptionhistory.html:8
-msgid "Timestamp"
-msgstr "Zeitpunkt"
+#: web/templates/episode.html:25
+msgid "When"
+msgstr ""
 
-#: web/templates/subscriptionhistory.html:9
-msgid "Action"
-msgstr "Aktivitt"
+#: web/templates/episode.html:26
+msgid "What"
+msgstr ""
 
-#: web/templates/subscriptionhistory.html:10
-msgid "Devices"
-msgstr "Gerte"
+#: web/templates/episode.html:27
+msgid "Where"
+msgstr ""
 
-#: web/templates/subscriptionhistory.html:17
-msgid "subscribe"
+#: web/templates/episode.html:41
+msgid "Why Unnamed Episode?"
+msgstr ""
+
+#: web/templates/episode.html:41 web/templates/podcast.html:80
+#: web/templates/subscribe.html:24
+msgid ""
+"Because we display names after we have fetched the information form the feed "
+"-- and this may take some time. Until this is completed, the podcast will "
+"simply be called this way."
+msgstr ""
+
+#: web/templates/home-user.html:6
+msgid "my.gpodder.org"
+msgstr ""
+
+#: web/templates/home-user.html:9
+msgid "Your Subscriptions"
+msgstr "Deine Abonnements"
+
+#: web/templates/home-user.html:13 web/templates/suggestions.html:17
+#: web/templates/toplist.html:13
+msgid "Podcast"
+msgstr ""
+
+#: web/templates/home-user.html:14
+msgid "Latest Episode"
+msgstr "Letzte Episode"
+
+#: web/templates/home-user.html:15
+#, fuzzy
+msgid "Subscribed on"
 msgstr "abonniert"
 
-#: web/templates/subscriptionhistory.html:20
-msgid "unsubscribe"
-msgstr "beendet"
+#: web/templates/home-user.html:37
+msgid "Where to start?"
+msgstr ""
 
-#: web/templates/subscriptionhistory.html:28
-msgid "back!"
-msgstr "zurck!"
+#: web/templates/home-user.html:38
+#, python-format
+msgid ""
+"my.gpodder.org help you to track your podcasts which you have subscribed on "
+"your devices - desktop computer, notebook, mobile devices, etc. To start "
+"using my.gpodder.org set up <a href=\"http://gpodder.org\">gPodder</a> with "
+"your username &ndash; <strong>%(username)s</strong> &ndash; and password and "
+"upload your podcasts. They will automatically show up here."
+msgstr ""
 
 #: web/templates/home.html:6
 msgid ""
@@ -73,11 +202,11 @@ msgstr ""
 msgid "We are currently tracking %(podcast_count)s Podcasts!"
 msgstr "Es werden zur Zeit %(podcast_count)s Podcasts verfolgt!"
 
-#: web/templates/home.html:20
+#: web/templates/home.html:20 web/templates/login.html:14
 msgid "Not yet a member?"
 msgstr "Noch kein Mitglied?"
 
-#: web/templates/home.html:20
+#: web/templates/home.html:20 web/templates/login.html:14
 msgid "Register!"
 msgstr "Registrieren!"
 
@@ -85,7 +214,9 @@ msgstr "Registrieren!"
 msgid ""
 "The new my.gpodder.org uses usernames instead of email addresses. Based on "
 "your email address, we think you might like "
-msgstr "Das neue my.gpodder.org Benutzername anstatt Emailadressen, der basierend auf deiner Emailadresse erzeugt wird. Wir denken, du wirst ihn mgen "
+msgstr ""
+"Das neue my.gpodder.org Benutzername anstatt Emailadressen, der basierend "
+"auf deiner Emailadresse erzeugt wird. Wir denken, du wirst ihn mgen "
 
 #: web/templates/migrate.html:5
 msgid ", but you can change that if you want to."
@@ -96,4 +227,200 @@ msgid ""
 "You can keep your old user settings in gPodder. Once the next version (with "
 "lots of new features) is release, you'll have to replace your email address "
 "with your username."
-msgstr "Du kannst deine alten Einstellung von gPodder bernehmen. Sobald die nchste Version (mit vielen neuen Funktionen) verffentlicht wurde, musst du fr den Zugang deinen neuen Benutzernamen bentzen."
+msgstr ""
+"Du kannst deine alten Einstellung von gPodder bernehmen. Sobald die nchste "
+"Version (mit vielen neuen Funktionen) verffentlicht wurde, musst du fr den "
+"Zugang deinen neuen Benutzernamen benutzen."
+
+#: web/templates/podcast.html:7
+msgid "Unnamed Podcast"
+msgstr ""
+
+#: web/templates/podcast.html:17 web/templates/subscribe.html:7
+#, python-format
+msgid "Subscribe to %(podcasttitle)s"
+msgstr ""
+
+#: web/templates/podcast.html:19 web/templates/subscribe.html:9
+msgid "Subscribe to this podcast"
+msgstr ""
+
+#: web/templates/podcast.html:23 web/templates/podcast.html.py:60
+msgid "Devices"
+msgstr "Gerte"
+
+#: web/templates/podcast.html:24
+msgid "You have subscribed this podcast on"
+msgstr ""
+
+#: web/templates/podcast.html:33
+#, fuzzy
+msgid "Episodes"
+msgstr "Letzte Episode"
+
+#: web/templates/podcast.html:38
+#, fuzzy
+msgid "Description"
+msgstr "Deine Abonnements"
+
+#: web/templates/podcast.html:39
+msgid "Released"
+msgstr ""
+
+#: web/templates/podcast.html:55
+msgid "Subscription History"
+msgstr "Abonnementverlauf"
+
+#: web/templates/podcast.html:58
+msgid "Timestamp"
+msgstr "Zeitpunkt"
+
+#: web/templates/podcast.html:59
+msgid "Action"
+msgstr "Aktivitt"
+
+#: web/templates/podcast.html:67
+msgid "subscribe"
+msgstr "abonniert"
+
+#: web/templates/podcast.html:70
+msgid "unsubscribe"
+msgstr "beendet"
+
+#: web/templates/podcast.html:80 web/templates/subscribe.html:24
+msgid "Why Unnamed Podcast?"
+msgstr ""
+
+#: web/templates/suggestions.html:10
+msgid "Suggested Podcasts"
+msgstr ""
+
+#: web/templates/suggestions.html:12
+#, python-format
+msgid "We've selected %(suggestion_count)s podcasts which you might like."
+msgstr ""
+
+#: web/templates/suggestions.html:18
+msgid "URL"
+msgstr ""
+
+#: web/templates/suggestions.html:30
+msgid "Do you like our suggestions?"
+msgstr ""
+
+#: web/templates/toplist.html:5
+msgid "Toplist"
+msgstr ""
+
+#: web/templates/toplist.html:7
+#, python-format
+msgid "These are the %(count)s most subscribed podcasts."
+msgstr ""
+
+#: web/templates/toplist.html:11
+msgid "#"
+msgstr ""
+
+#: web/templates/toplist.html:12
+msgid "Last week"
+msgstr ""
+
+#: web/templates/toplist.html:14
+#, fuzzy
+msgid "Subscribers"
+msgstr "abonniert"
+
+#: web/templates/registration/activate.html:5
+#: web/templates/registration/activation_complete.html:4
+msgid "Account activated"
+msgstr ""
+
+#: web/templates/registration/activate.html:6
+#: web/templates/registration/activation_complete.html:5
+msgid "Your account has been activated! Enjoy using my.gpodder.org"
+msgstr ""
+
+#: web/templates/registration/activate.html:8
+msgid "Account not activated"
+msgstr ""
+
+#: web/templates/registration/activate.html:9
+msgid "Your account could not be activated successfully."
+msgstr ""
+
+#: web/templates/registration/registration_complete.html:4
+msgid "Registration complete"
+msgstr ""
+
+#: web/templates/registration/registration_complete.html:5
+msgid ""
+"Please confirm your account using the email you should just have recieved."
+msgstr ""
+
+#: web/templates/registration/registration_form.html:4
+msgid "Create a User Account"
+msgstr ""
+
+#: web/templates/search/search.html:6
+msgid "Search"
+msgstr ""
+
+#: web/templates/search/search.html:20
+msgid "Results"
+msgstr ""
+
+#: web/templatetags/devices.py:11
+msgid "Desktop"
+msgstr ""
+
+#: web/templatetags/devices.py:13
+msgid "Laptop"
+msgstr ""
+
+#: web/templatetags/devices.py:15
+msgid "Mobile"
+msgstr ""
+
+#: web/templatetags/devices.py:17
+msgid "Server"
+msgstr ""
+
+#: web/templatetags/devices.py:19
+msgid "Other"
+msgstr ""
+
+#: web/templatetags/episodes.py:10
+msgid "This episode has not yet been played"
+msgstr ""
+
+#: web/templatetags/episodes.py:13 web/templatetags/episodes.py:14
+#, python-format
+msgid " on %s"
+msgstr ""
+
+#: web/templatetags/episodes.py:17
+msgid "This episode has been marked new"
+msgstr ""
+
+#: web/templatetags/episodes.py:19
+msgid "This episode has been downloaded"
+msgstr ""
+
+#: web/templatetags/episodes.py:21
+msgid "This episode has been played"
+msgstr ""
+
+#: web/templatetags/episodes.py:23
+msgid "This episode has been deleted"
+msgstr ""
+
+#: web/templatetags/podcasts.py:12
+msgid "Logo"
+msgstr ""
+
+#: web/templatetags/podcasts.py:14
+msgid "No Logo available"
+msgstr ""
+
+#~ msgid "back!"
+#~ msgstr "zurck!"
diff --git a/mygpo/locale/it/LC_MESSAGES/django.po b/mygpo/locale/it/LC_MESSAGES/django.po
new file mode 100644
index 0000000..cbe8cb4
--- /dev/null
+++ b/mygpo/locale/it/LC_MESSAGES/django.po
@@ -0,0 +1,411 @@
+# SOME DESCRIPTIVE TITLE.
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: PACKAGE VERSION\n"
+"Report-Msgid-Bugs-To: \n"
+"POT-Creation-Date: 2010-01-05 23:28+0100\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
+"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
+"Language-Team: LANGUAGE <LL@li.org>\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#: api/models.py:167
+#, python-format
+msgid "Unnamed Device (%s)"
+msgstr ""
+
+#: web/forms.py:7
+msgid "Your Email Address"
+msgstr ""
+
+#: web/forms.py:8
+msgid "May we use your subscriptions for the toplist and suggestions?"
+msgstr ""
+
+#: web/forms.py:11
+msgid "Name of this device"
+msgstr ""
+
+#: web/forms.py:12
+msgid "What kind of device is this?"
+msgstr ""
+
+#: web/forms.py:13
+msgid "What UID is configured on the pysical device?"
+msgstr ""
+
+#: web/views.py:103
+msgid "With which client do you want to subscribe?"
+msgstr ""
+
+#: web/views.py:168
+#, python-format
+msgid "my.gpodder.org - Top %s"
+msgstr ""
+
+#: web/views.py:194
+#, python-format
+msgid "my.gpodder.org - %s Suggestions"
+msgstr ""
+
+#: web/views.py:208
+msgid "Synchronize with the following devices"
+msgstr ""
+
+#: web/templates/account.html:5
+msgid "Account Settings"
+msgstr ""
+
+#: web/templates/account.html:8 web/templates/device.html:50
+msgid "Your settings have been saved."
+msgstr ""
+
+#: web/templates/account.html:11
+msgid "Update the settings for your account"
+msgstr ""
+
+#: web/templates/device.html:9
+msgid "Podcasts"
+msgstr ""
+
+#: web/templates/device.html:10
+msgid "You have subscribed the following podcasts on this device"
+msgstr ""
+
+#: web/templates/device.html:14 web/templates/podcast.html:37
+msgid "Title"
+msgstr ""
+
+#: web/templates/device.html:15
+msgid "Since"
+msgstr ""
+
+#: web/templates/device.html:27
+msgid "Synchronize"
+msgstr ""
+
+#: web/templates/device.html:28
+msgid ""
+"If you synchronize devices, they will always have the same subscriptions. A "
+"podcast that is subscribed on one device, will automatically be added to all "
+"synchronized devices."
+msgstr ""
+
+#: web/templates/device.html:32
+#, python-format
+msgid "%(devicename)s is currently not synchronized with other devices."
+msgstr ""
+
+#: web/templates/device.html:36
+#, python-format
+msgid "%(devicename)s is currently synchronized with %(synclist)s."
+msgstr ""
+
+#: web/templates/device.html:37
+#, python-format
+msgid "Stop synchronisation for %(devicename)s "
+msgstr ""
+
+#: web/templates/device.html:44 web/templates/subscribe.html:20
+msgid "OK"
+msgstr ""
+
+#: web/templates/episode.html:7
+#, python-format
+msgid ""
+"An episode of the <a href=\"/podcast/%(podcast_id)s\">%(podcast)s</a> "
+"podcast."
+msgstr ""
+
+#: web/templates/episode.html:22
+msgid "Your Episode History"
+msgstr ""
+
+#: web/templates/episode.html:25
+msgid "When"
+msgstr ""
+
+#: web/templates/episode.html:26
+msgid "What"
+msgstr ""
+
+#: web/templates/episode.html:27
+msgid "Where"
+msgstr ""
+
+#: web/templates/episode.html:41
+msgid "Why Unnamed Episode?"
+msgstr ""
+
+#: web/templates/episode.html:41 web/templates/podcast.html:80
+#: web/templates/subscribe.html:24
+msgid ""
+"Because we display names after we have fetched the information form the feed "
+"-- and this may take some time. Until this is completed, the podcast will "
+"simply be called this way."
+msgstr ""
+
+#: web/templates/home-user.html:6
+msgid "my.gpodder.org"
+msgstr ""
+
+#: web/templates/home-user.html:9
+msgid "Your Subscriptions"
+msgstr ""
+
+#: web/templates/home-user.html:13 web/templates/suggestions.html:17
+#: web/templates/toplist.html:13
+msgid "Podcast"
+msgstr ""
+
+#: web/templates/home-user.html:14
+msgid "Latest Episode"
+msgstr ""
+
+#: web/templates/home-user.html:15
+msgid "Subscribed on"
+msgstr ""
+
+#: web/templates/home-user.html:37
+msgid "Where to start?"
+msgstr ""
+
+#: web/templates/home-user.html:38
+#, python-format
+msgid ""
+"my.gpodder.org help you to track your podcasts which you have subscribed on "
+"your devices - desktop computer, notebook, mobile devices, etc. To start "
+"using my.gpodder.org set up <a href=\"http://gpodder.org\">gPodder</a> with "
+"your username &ndash; <strong>%(username)s</strong> &ndash; and password and "
+"upload your podcasts. They will automatically show up here."
+msgstr ""
+
+#: web/templates/home.html:6
+msgid ""
+"my.gpodder.org is a webservice for synchronizing podcast subscriptions on "
+"several devices and applications."
+msgstr ""
+
+#: web/templates/home.html:8
+#, python-format
+msgid "We are currently tracking %(podcast_count)s Podcasts!"
+msgstr ""
+
+#: web/templates/home.html:20 web/templates/login.html:14
+msgid "Not yet a member?"
+msgstr ""
+
+#: web/templates/home.html:20 web/templates/login.html:14
+msgid "Register!"
+msgstr ""
+
+#: web/templates/migrate.html:5
+msgid ""
+"The new my.gpodder.org uses usernames instead of email addresses. Based on "
+"your email address, we think you might like "
+msgstr ""
+
+#: web/templates/migrate.html:5
+msgid ", but you can change that if you want to."
+msgstr ""
+
+#: web/templates/migrate.html:11
+msgid ""
+"You can keep your old user settings in gPodder. Once the next version (with "
+"lots of new features) is release, you'll have to replace your email address "
+"with your username."
+msgstr ""
+
+#: web/templates/podcast.html:7
+msgid "Unnamed Podcast"
+msgstr ""
+
+#: web/templates/podcast.html:17 web/templates/subscribe.html:7
+#, python-format
+msgid "Subscribe to %(podcasttitle)s"
+msgstr ""
+
+#: web/templates/podcast.html:19 web/templates/subscribe.html:9
+msgid "Subscribe to this podcast"
+msgstr ""
+
+#: web/templates/podcast.html:23 web/templates/podcast.html.py:60
+msgid "Devices"
+msgstr ""
+
+#: web/templates/podcast.html:24
+msgid "You have subscribed this podcast on"
+msgstr ""
+
+#: web/templates/podcast.html:33
+msgid "Episodes"
+msgstr ""
+
+#: web/templates/podcast.html:38
+msgid "Description"
+msgstr ""
+
+#: web/templates/podcast.html:39
+msgid "Released"
+msgstr ""
+
+#: web/templates/podcast.html:55
+msgid "Subscription History"
+msgstr ""
+
+#: web/templates/podcast.html:58
+msgid "Timestamp"
+msgstr ""
+
+#: web/templates/podcast.html:59
+msgid "Action"
+msgstr ""
+
+#: web/templates/podcast.html:67
+msgid "subscribe"
+msgstr ""
+
+#: web/templates/podcast.html:70
+msgid "unsubscribe"
+msgstr ""
+
+#: web/templates/podcast.html:80 web/templates/subscribe.html:24
+msgid "Why Unnamed Podcast?"
+msgstr ""
+
+#: web/templates/suggestions.html:10
+msgid "Suggested Podcasts"
+msgstr ""
+
+#: web/templates/suggestions.html:12
+#, python-format
+msgid "We've selected %(suggestion_count)s podcasts which you might like."
+msgstr ""
+
+#: web/templates/suggestions.html:18
+msgid "URL"
+msgstr ""
+
+#: web/templates/suggestions.html:30
+msgid "Do you like our suggestions?"
+msgstr ""
+
+#: web/templates/toplist.html:5
+msgid "Toplist"
+msgstr ""
+
+#: web/templates/toplist.html:7
+#, python-format
+msgid "These are the %(count)s most subscribed podcasts."
+msgstr ""
+
+#: web/templates/toplist.html:11
+msgid "#"
+msgstr ""
+
+#: web/templates/toplist.html:12
+msgid "Last week"
+msgstr ""
+
+#: web/templates/toplist.html:14
+msgid "Subscribers"
+msgstr ""
+
+#: web/templates/registration/activate.html:5
+#: web/templates/registration/activation_complete.html:4
+msgid "Account activated"
+msgstr ""
+
+#: web/templates/registration/activate.html:6
+#: web/templates/registration/activation_complete.html:5
+msgid "Your account has been activated! Enjoy using my.gpodder.org"
+msgstr ""
+
+#: web/templates/registration/activate.html:8
+msgid "Account not activated"
+msgstr ""
+
+#: web/templates/registration/activate.html:9
+msgid "Your account could not be activated successfully."
+msgstr ""
+
+#: web/templates/registration/registration_complete.html:4
+msgid "Registration complete"
+msgstr ""
+
+#: web/templates/registration/registration_complete.html:5
+msgid ""
+"Please confirm your account using the email you should just have recieved."
+msgstr ""
+
+#: web/templates/registration/registration_form.html:4
+msgid "Create a User Account"
+msgstr ""
+
+#: web/templates/search/search.html:6
+msgid "Search"
+msgstr ""
+
+#: web/templates/search/search.html:20
+msgid "Results"
+msgstr ""
+
+#: web/templatetags/devices.py:11
+msgid "Desktop"
+msgstr ""
+
+#: web/templatetags/devices.py:13
+msgid "Laptop"
+msgstr ""
+
+#: web/templatetags/devices.py:15
+msgid "Mobile"
+msgstr ""
+
+#: web/templatetags/devices.py:17
+msgid "Server"
+msgstr ""
+
+#: web/templatetags/devices.py:19
+msgid "Other"
+msgstr ""
+
+#: web/templatetags/episodes.py:10
+msgid "This episode has not yet been played"
+msgstr ""
+
+#: web/templatetags/episodes.py:13 web/templatetags/episodes.py:14
+#, python-format
+msgid " on %s"
+msgstr ""
+
+#: web/templatetags/episodes.py:17
+msgid "This episode has been marked new"
+msgstr ""
+
+#: web/templatetags/episodes.py:19
+msgid "This episode has been downloaded"
+msgstr ""
+
+#: web/templatetags/episodes.py:21
+msgid "This episode has been played"
+msgstr ""
+
+#: web/templatetags/episodes.py:23
+msgid "This episode has been deleted"
+msgstr ""
+
+#: web/templatetags/podcasts.py:12
+msgid "Logo"
+msgstr ""
+
+#: web/templatetags/podcasts.py:14
+msgid "No Logo available"
+msgstr ""

commit 4b1911c474449ac96ee4c1b0d1424b6e68e5b9bd
Merge: ca107d2... 0e11ed4...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Tue Jan 5 18:38:29 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit ca107d27e2b8cb8dabb2a186d25e03aba557b087
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Tue Jan 5 18:37:21 2010 +0100

    subscribe with mygpodder.org

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 37c4fea..a984915 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -72,6 +72,10 @@ urlpatterns = patterns('',
     (r'^api/1/devices/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.device'),
     (r'^api/1/devices/(?P<username>\w+).json', 'mygpo.api.advanced.devices'),
 
+    #Subscribe with my.gpodder.org
+    (r'^subscribe', 'mygpo.web.views.podcast_subscribe_url'),
+    (r'^authors/$', 'django.views.generic.simple.direct_to_template', {'template': 'authors.html'}),
+
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs'
     # to INSTALLED_APPS to enable admin documentation:
     # (r'^admin/doc/', include('django.contrib.admindocs.urls')),
diff --git a/mygpo/web/templates/authors.html b/mygpo/web/templates/authors.html
new file mode 100644
index 0000000..21c251f
--- /dev/null
+++ b/mygpo/web/templates/authors.html
@@ -0,0 +1,13 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>{% trans "For podcast authors" %}</h1>
+
+  <p><img src="/media/subscribe.png" /></p>
+  <p>You can paste this code on your website, so users of mygpo can directly subscribe to your podcast!</p>
+  <p>Change the field "YOUR_ADRESS" with the adress of your podcast.</p>
+  <p>
+   <textarea cols="80" rows="1"><a href="http://my.gpodder.org/subscribe?url=YOUR_ADRESS"><img src="http://my.gpodder.org/media/subscribe.png" /></a></textarea>
+  </p>
+{% endblock %}
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 66cfce0..cdc9e47 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -73,6 +73,11 @@
      <li><a href="/toplist/">Toplist</a></li>
      <li><a href="/suggestions/">Suggestions</a></li>
     </ul>
+    
+    <ul class="menu">
+     <li><a href="/authors/">For podcast authors</a></li>
+    </ul>
+    
    {% else %}
     <ul class="menu">
      <li><a href="/">Home</a></li>
@@ -80,6 +85,10 @@
      <li><a href="/register/">Register</a></li>
      <li><a href="/toplist/">Podcast-Toplist</a></li>
     </ul>
+    
+    <ul class="menu">
+     <li><a href="/authors/">For podcast authors</a></li>
+    </ul>
    {% endif %}
 
   </div>
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 00aa969..bc51ca7 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -16,7 +16,7 @@
 #
 
 from django.shortcuts import render_to_response
-from django.http import HttpResponseRedirect, HttpResponse, HttpResponseBadRequest, HttpResponseNotAllowed
+from django.http import HttpResponseRedirect, HttpResponse, HttpResponseBadRequest, HttpResponseNotAllowed, Http404
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
 from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry, Rating, SyncGroup, SUBSCRIBE_ACTION
@@ -263,3 +263,23 @@ def device_unsync(request, device_id):
 
     return HttpResponseRedirect('/device/%s' % device_id)
 
+@login_required
+def podcast_subscribe_url(request):
+    url = request.GET.get('url')
+    
+    if url == None:
+        raise Http404('http://my.gpodder.org/subscribe?url=http://www.example.com/podcast.xml')
+         
+    podcast, created = Podcast.objects.get_or_create(url=url,
+            defaults={'title':url,'description':url,'last_update':datetime.now()})
+    devices = Device.objects.filter(user=request.user)
+    history = SubscriptionAction.objects.filter(podcast=podcast,device__in=devices).order_by('-timestamp')
+    subscribed_devices = [s.device for s in Subscription.objects.filter(podcast=podcast,user=request.user)]
+    episodes = episode_list(podcast, request.user)
+    return render_to_response('podcast.html', {
+        'history': history,
+        'podcast': podcast,
+        'devices': subscribed_devices,
+        'episodes': episodes,
+    }, context_instance=RequestContext(request))
+    

commit 0e11ed4020d320415330b6236047791cef265dfd
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Tue Jan 5 16:43:03 2010 +0100

     Bug 643 -  I18n-ize Website

diff --git a/mygpo/web/templates/account.html b/mygpo/web/templates/account.html
index 1999602..31ed0c2 100644
--- a/mygpo/web/templates/account.html
+++ b/mygpo/web/templates/account.html
@@ -8,7 +8,7 @@
    <div class="success">{% trans "Your settings have been saved." %}</div>
  {% endif %}
 
-  <p>Update the settings for your account <strong>{{ user.username }}</strong>.</p>
+  <p>{% trans "Update the settings for your account" %} <strong>{{ user.username }}</strong>.</p>
   <form action="/account/" method="POST">
    {{ form.as_p }}
    <input type="submit" value="Save" />
diff --git a/mygpo/web/templates/device.html b/mygpo/web/templates/device.html
index 53528e5..f853292 100644
--- a/mygpo/web/templates/device.html
+++ b/mygpo/web/templates/device.html
@@ -6,7 +6,7 @@
 {% block content %}
   <h1>{{ device.name }}</h1>
 
-  <h2>Podcasts</h2>
+  <h2>{% trans "Podcasts" %}</h2>
   <p>{% trans "You have subscribed the following podcasts on this device" %}
   <table class="list">
    <tr>
@@ -24,7 +24,7 @@
    {% endfor %}
   </table>
 
-  <h2>Synchronize</h2>
+  <h2>{% trans "Synchronize" %}</h2>
   <p>{% blocktrans %}If you synchronize devices, they will always have the same subscriptions. A podcast that is subscribed on one device, will automatically be added to all synchronized devices.{% endblocktrans %}</p>
 
   {% if synced_with|length_is:"0" %}
diff --git a/mygpo/web/templates/login.html b/mygpo/web/templates/login.html
index ad4f45a..315062b 100644
--- a/mygpo/web/templates/login.html
+++ b/mygpo/web/templates/login.html
@@ -11,7 +11,7 @@
    </form>
 
   <div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px;">
-   Not yet a member? <a href="/register/">Register!</a>
+   {% trans "Not yet a member?" %} <a href="/register/">{% trans "Register!" %}</a>
   </div>
 
 {% endblock %}
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index 1fdb345..12f282e 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -20,8 +20,8 @@
     {% endif %}
    </a>
   {% else %}
-   <h2>Devices</h2>
-   <strong>You have subscribed this podcast on</strong>
+   <h2>{% trans "Devices" %}</h2>
+   <strong>{% trans "You have subscribed this podcast on" %}</strong>
    <ul class="devices">
    {% for device in devices %}
     <li class="{{device.type}}"><a href="/device/{{ device.id }}">{{ device.name }}</a></li>
diff --git a/mygpo/web/templates/registration/activate.html b/mygpo/web/templates/registration/activate.html
index 29f1a6a..6d7beee 100644
--- a/mygpo/web/templates/registration/activate.html
+++ b/mygpo/web/templates/registration/activate.html
@@ -2,11 +2,11 @@
 
 {% block content %}
   {% if account %}
-  <h1>Account activated</h1>
-  <p>Your account has been activated! Enjoy using my.gpodder.org</p>
+  <h1>{% trans "Account activated" %}</h1>
+  <p>{% trans "Your account has been activated! Enjoy using my.gpodder.org" %}</p>
   {% else %}
-  <h1>Account not activated</h1>
-  <p>Your account could not be activated successfully.</p>
+  <h1>{% trans "Account not activated" %}</h1>
+  <p>{% trans "Your account could not be activated successfully." %}</p>
   {% endif %}
 {% endblock %}
 
diff --git a/mygpo/web/templates/registration/activation_complete.html b/mygpo/web/templates/registration/activation_complete.html
index 7696416..321cc35 100644
--- a/mygpo/web/templates/registration/activation_complete.html
+++ b/mygpo/web/templates/registration/activation_complete.html
@@ -1,7 +1,7 @@
 {% extends "base.html" %}
 
 {% block content %}
-  <h1>Account activated</h1>
-  <p>Your account has been activated! Enjoy using my.gpodder.org</p>
+  <h1>{% trans "Account activated" %}</h1>
+  <p>{% trans "Your account has been activated! Enjoy using my.gpodder.org" %}</p>
 {% endblock %}
 
diff --git a/mygpo/web/templates/registration/registration_complete.html b/mygpo/web/templates/registration/registration_complete.html
index 89b1373..1ebfdd5 100644
--- a/mygpo/web/templates/registration/registration_complete.html
+++ b/mygpo/web/templates/registration/registration_complete.html
@@ -1,7 +1,7 @@
 {% extends "base.html" %}
 
 {% block content %}
-  <h1>Registration complete</h1>
-  <p>Please confirm your account using the email you should just have recieved.</p>
+  <h1>{% trans "Registration complete" %}</h1>
+  <p>{% trans "Please confirm your account using the email you should just have recieved." %}</p>
 {% endblock %}
 
diff --git a/mygpo/web/templates/registration/registration_form.html b/mygpo/web/templates/registration/registration_form.html
index 555df23..567e6a0 100644
--- a/mygpo/web/templates/registration/registration_form.html
+++ b/mygpo/web/templates/registration/registration_form.html
@@ -1,7 +1,7 @@
 {% extends "base.html" %}
 
 {% block content %}
-  <h1>Create a User Account</h1>
+  <h1>{% trans "Create a User Account" %}</h1>
 
   <form action="/register/" method="POST">
   <table class="register">
diff --git a/mygpo/web/templates/search/search.html b/mygpo/web/templates/search/search.html
index d2b08f8..4cec0ca 100644
--- a/mygpo/web/templates/search/search.html
+++ b/mygpo/web/templates/search/search.html
@@ -17,7 +17,7 @@
         </table>
 
         {% if query %}
-            <h3>Results</h3>
+            <h3>{% trans "Results" %}</h3>
 
             {% for result in page.object_list %}
                 <p>
diff --git a/mygpo/web/templates/suggestions.html b/mygpo/web/templates/suggestions.html
index 0eb5638..40944ce 100644
--- a/mygpo/web/templates/suggestions.html
+++ b/mygpo/web/templates/suggestions.html
@@ -27,7 +27,7 @@
   </table>
 
   <div class="rate">
-   <strong>Do you like our suggestions?</strong>
+   <strong>{% trans "Do you like our suggestions?" %}</strong>
    <a href="/suggestions/?rate=1">
     <img src="/media/16x16/emblem-default.png" alt="Yes" />
    </a>
diff --git a/mygpo/web/templatetags/episodes.py b/mygpo/web/templatetags/episodes.py
index 06c44c3..0484410 100644
--- a/mygpo/web/templatetags/episodes.py
+++ b/mygpo/web/templatetags/episodes.py
@@ -14,13 +14,13 @@ def episode_status_icon(action):
         device_string = (_(' on %s') % (action.device.name)) if action.device else ''
 
         if action.action == 'new':
-            s = '<img src="/media/16x16/emblem-new.png" alt="new" title="%s" />' % (_('This episode has been marked new%s%s') % (date_string, device_string))
+            s = '<img src="/media/16x16/emblem-new.png" alt="new" title="%s" />' % ('%s%s%s' % (_('This episode has been marked new'),date_string, device_string))
         elif action.action == 'download':
-            s = '<img src="/media/16x16/folder.png" alt="downloaded" title="%s" />' % (_('This episode has been downloaded%s%s') % (date_string, device_string))
+            s = '<img src="/media/16x16/folder.png" alt="downloaded" title="%s" />' % ('%s%s%s' % (_('This episode has been downloaded'),date_string, device_string))
         elif action.action == 'play':
-            s = '<img src="/media/16x16/media-playback-start.png" alt="played" title="%s" />' % (_('This episode has been played%s%s') % (date_string, device_string))
+            s = '<img src="/media/16x16/media-playback-start.png" alt="played" title="%s" />' % ('%s%s%s' % (_('This episode has been played'),date_string, device_string))
         elif action.action == 'delete':
-            s = '<img src="/media/16x16/user-trash-full.png" alt="deleted" title="%s"/>' %s (_('This episode has been deleted%s%s') % (date_string, device_string))
+            s = '<img src="/media/16x16/user-trash-full.png" alt="deleted" title="%s"/>' %s ('%s%s%s' % (_('This episode has been deleted'),date_string, device_string))
         else:
             return action.action #this is not marked safe by intention
 

commit 9f24a8d11fa4947f92b2eef4a644db435de04b79
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Tue Jan 5 15:53:44 2010 +0100

     Bug 726 -  Keeping suggestions up-to-date
    
    > thp@mygpo:/srv/mygpo$ python mygpo/api/update_allSuggestion.py
    > MySQL Error 1136:  Column count doesn't match value count at row 1
    debugged in update-11.sql

diff --git a/install/update-11.sql b/install/update-11.sql
new file mode 100644
index 0000000..86eb173
--- /dev/null
+++ b/install/update-11.sql
@@ -0,0 +1,153 @@
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_suggestion $$
+CREATE PROCEDURE update_suggestion()
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
+    DECLARE done INT DEFAULT 0;
+    DECLARE user_help INT DEFAULT 0;
+    DECLARE pod_count INT DEFAULT 0;
+    DECLARE cur1 CURSOR FOR SELECT user_ptr_id FROM user where suggestion_up_to_date = 0;
+    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
+    
+
+
+    DROP TABLE IF EXISTS suggestion_pod;
+    CREATE TABLE suggestion_pod (
+       podID INT
+    );
+    DROP TABLE IF EXISTS suggestion_user;
+    CREATE TABLE suggestion_user (
+       userID INT
+    );
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+         DECLARE deadlock_detected CONDITION FOR 1213;
+         DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+         SET deadlock=0;
+               
+         START TRANSACTION;
+            OPEN cur1;
+
+            REPEAT
+                FETCH cur1 INTO user_help;
+
+                IF NOT done THEN
+                    DELETE FROM suggestion where user_id=user_help;
+                    DELETE FROM suggestion_pod;
+                    DELETE FROM suggestion_user;
+select user_help;
+                    insert into suggestion_pod (select podcast_id from current_subscription where user_id=user_help);
+
+                    SELECT count(*) into pod_count FROM suggestion_pod;
+
+                    IF pod_count > 0 THEN
+                        insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
+                        insert into suggestion (select user_help, podcast_id, count(podcast_id) as priority, NULL 
+                                     from public_subscription, suggestion_user 
+                                     where user_id=userID and podcast_id not in (select * from suggestion_pod) 
+                                     group by user_help, podcast_id order by priority DESC LIMIT 10);
+                    ELSE
+                        insert into suggestion (select user_help, podcast_id, subscription_count, NULL as priority from toplist 
+                                     group by user_help, podcast_id order by subscription_count DESC LIMIT 10);
+                    END IF;
+                    update user set suggestion_up_to_date = 1 where user_ptr_id = user_help;
+                END IF;
+            UNTIL done END REPEAT;
+
+            CLOSE cur1;
+
+            COMMIT;  
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Suggestion are not updated!');
+        END IF;
+
+        DROP TABLE IF EXISTS suggestion_user;
+        DROP TABLE IF EXISTS suggestion_pod;         
+
+END $$
+DELIMITER ;
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_suggestion_for $$
+CREATE PROCEDURE update_suggestion_for(IN user_par INT)
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
+    DECLARE pod_count INT DEFAULT 0;
+    DECLARE utd INT DEFAULT 0;
+        
+    DROP TABLE IF EXISTS suggestion_pod;
+    CREATE TABLE suggestion_pod (
+       podID INT
+    );
+    DROP TABLE IF EXISTS suggestion_user;
+    CREATE TABLE suggestion_user (
+       userID INT
+    );
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+         DECLARE deadlock_detected CONDITION FOR 1213;
+         DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+         SET deadlock=0;
+               
+         START TRANSACTION;
+            SELECT suggestion_up_to_date into utd FROM user where user_ptr_id = user_par;
+            IF utd < 1 THEN
+               DELETE FROM suggestion where user_id=user_par;
+               DELETE FROM suggestion_pod;
+               DELETE FROM suggestion_user;
+
+               insert into suggestion_pod (select podcast_id from current_subscription where user_id=user_par);
+	    
+               SELECT count(*) into pod_count FROM suggestion_pod;
+
+               IF pod_count > 0 THEN
+                  insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
+                  insert into suggestion (select user_par, podcast_id, count(podcast_id) as priority, NULL 
+                                     from public_subscription, suggestion_user 
+                                     where user_id=userID and podcast_id not in (select * from suggestion_pod) 
+                                     group by user_par, podcast_id order by priority DESC LIMIT 10);
+               ELSE
+                  insert into suggestion (select user_par, podcast_id, subscription_count, NULL as priority from toplist 
+                  group by user_par, podcast_id order by subscription_count DESC LIMIT 10);
+               END IF;
+               update user set suggestion_up_to_date = 1 where user_ptr_id = user_par;
+            END IF;
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Suggestion are not updated!');
+        END IF;
+
+        DROP TABLE IF EXISTS suggestion_user;
+        DROP TABLE IF EXISTS suggestion_pod;         
+
+END $$
+DELIMITER ;
+

commit aaa5141f031d2e5f7dec48ced5afe6068169ea19
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Tue Jan 5 14:22:43 2010 +0100

    separated simple api tests in txt, json and opml tests - tests work

diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 2fb55d2..c145127 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -202,37 +202,9 @@ class AdvancedAPITest(TestCase):
         return True
 
 
-class SimpleTest(TestCase):
-    def test_put_get_data(self):
-        p1 = 'http://www.podcast1.com'
-        p2 = 'http://www.podcast2.com'
-        p3 = 'http://www.podcast3.com'
-    
-        d1 = '1'
-        d2 = '2'
-        d3 = '3'
-    
-        f1 = 'txt'
-        f2 = 'json'
-        f3 = 'opml'
-    
-        data_txt_1 = '%s\n%s\n' % (p1, p2)
-        data_txt_2 = '%s\n%s\n' % (p2, p3)
-    
-        data_json_1 = '[\n"%s",\n"%s"\n]' % (p1, p2)
-        data_json_2 = '[\n"%s",\n"%s"\n]' % (p2, p3)
+class SimpleAPITest(TestCase):
 
-        data_opml_1 = '<?xml version="1.0" encoding="UTF-8"?>\n<opml version="2.0">\n<head>\n<title>subscription list</title>\n\
-                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated>\n</head>\n<body>\n\
-                       <outline text="p1" title="p1" type="rss" xmlUrl="%s"/>\n\
-                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\n\
-                       </body>\n</opml>\n' % (p1, p2)
-        data_opml_2 = '<?xml version="1.0" encoding="UTF-8"?><opml version="2.0"><head><title>subscription list</title>\
-                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated></head><body>\
-                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\
-                       <outline text="p3" title="p3" type="rss" xmlUrl="%s"/>\
-                       </body></opml>' % (p2, p3)
-    
+    def setUp(self):
         un = 'u'
         pw = 'u'
         u  = User.objects.create(username=un, password=pw)
@@ -242,16 +214,31 @@ class SimpleTest(TestCase):
         r.method = 'PUT'
         r.user = u
         
+        self.user = u
+        self.req = r
+
+    def test_put_get_txt(self):
+        p1 = 'http://www.podcast1.com'
+        p2 = 'http://www.podcast2.com'
+        p3 = 'http://www.podcast3.com'
+    
+        d1 = '1'
+        f1 = 'txt'
+    
+        data_txt_1 = '%s\n%s\n' % (p1, p2)
+        data_txt_2 = '%s\n%s\n' % (p2, p3)
+        
         #1. put 2 new podcasts
-        r.raw_post_data = data_txt_1
-        put = subscriptions(request=r, username=un, device_uid=d1, format=f1)
+        self.req.raw_post_data = data_txt_1
+        put = subscriptions(request=self.req, username=self.user.username, device_uid=d1, format=f1)
         # Successful requests should return the empty string + status code 200
         self.assertEqual(put.status_code, 200)
         self.assertEqual(put.content, '')
         
         #device 1 txt
-        device = Device.objects.get(uid=d1, user=u)
+        device = Device.objects.get(uid=d1, user=self.user)
         
+        #get subscriptions
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual(len(urls), 2)
@@ -260,59 +247,94 @@ class SimpleTest(TestCase):
         
         #2. put 1 new podcast and delete 1 old
         time.sleep(1)
-        r.raw_post_data = data_txt_2
-        subscriptions(request=r, username=un, device_uid=d1, format=f1)
+        self.req.raw_post_data = data_txt_2
+        subscriptions(request=self.req, username=self.user.username, device_uid=d1, format=f1)
         
+        #get subscriptions
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
         self.assertEqual(urls[0], p2)
         self.assertEqual(urls[1], p3) 
         
-        #3. put 2 new podcasts
-        time.sleep(1)
-        r.raw_post_data = data_json_1
-        subscriptions(request=r, username=un, device_uid=d2, format=f2)
+    def test_put_get_json(self):
+    
+        p1 = 'http://www.podcast1.com'
+        p2 = 'http://www.podcast2.com'
+        p3 = 'http://www.podcast3.com'
+
+        d2 = '2'
+        f2 = 'json'
+    
+        data_json_1 = '[\n"%s",\n"%s"\n]' % (p1, p2)
+        data_json_2 = '[\n"%s",\n"%s"\n]' % (p2, p3)
+    
+        #1. put 2 new podcasts
+        self.req.raw_post_data = data_json_1
+        subscriptions(request=self.req, username=self.user.username, device_uid=d2, format=f2)
         
         #device 2 json
-        device = Device.objects.get(uid=d2, user=u)
+        device = Device.objects.get(uid=d2, user=self.user)
         
+        #get subscriptions
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
         self.assertEqual(urls[0], p1)
         self.assertEqual(urls[1], p2) 
 
-        #4. put 1 new podcast and delete 1 old
+        #2. put 1 new podcast and delete 1 old
         time.sleep(1)
-        r.raw_post_data = data_json_2
-        subscriptions(request=r, username=un, device_uid=d2, format=f2)
+        self.req.raw_post_data = data_json_2
+        subscriptions(request=self.req, username=self.user.username, device_uid=d2, format=f2)
         
+        #get subscriptions
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
         self.assertEqual(urls[0], p2)
         self.assertEqual(urls[1], p3) 
         
-        #5. put 2 new podcasts
-        time.sleep(1)
-        r.raw_post_data = data_opml_1
-        subscriptions(request=r, username=un, device_uid=d3, format=f3)
+    def test_put_get_opml(self):
         
+        p1 = 'http://www.podcast1.com'
+        p2 = 'http://www.podcast2.com'
+        p3 = 'http://www.podcast3.com'
+    
+        d3 = '3'
+        f3 = 'opml'  
+        
+        data_opml_1 = '<?xml version="1.0" encoding="UTF-8"?>\n<opml version="2.0">\n<head>\n<title>subscription list</title>\n\
+                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated>\n</head>\n<body>\n\
+                       <outline text="p1" title="p1" type="rss" xmlUrl="%s"/>\n\
+                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\n\
+                       </body>\n</opml>\n' % (p1, p2)
+        data_opml_2 = '<?xml version="1.0" encoding="UTF-8"?><opml version="2.0"><head><title>subscription list</title>\
+                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated></head><body>\
+                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\
+                       <outline text="p3" title="p3" type="rss" xmlUrl="%s"/>\
+                       </body></opml>' % (p2, p3)
+      
+        #1. put 2 new podcasts
+        self.req.raw_post_data = data_opml_1
+        subscriptions(request=self.req, username=self.user.username, device_uid=d3, format=f3)
+      
         #device 3 opml
-        device = Device.objects.get(uid=d3, user=u)
+        device = Device.objects.get(uid=d3, user=self.user)
         
+        #get subscriptions
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
         self.assertEqual(urls[0], p1)
         self.assertEqual(urls[1], p2) 
         
-        #6. put 1 new podcast and delete 1 old
+        #2. put 1 new podcast and delete 1 old
         time.sleep(1)
-        r.raw_post_data = data_opml_2
-        subscriptions(request=r, username=un, device_uid=d3, format=f3)
+        self.req.raw_post_data = data_opml_2
+        subscriptions(request=self.req, username=self.user.username, device_uid=d3, format=f3)
         
+        #get subscriptions
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)

commit c447679c93f692d751fdc09b3c7b1be49699132f
Merge: 4f500aa... 37c73b4...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Jan 4 20:56:02 2010 +0100

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 03902aab09792280a5e6c78664090c13be567545
Merge: 37c73b4... 4f500aa...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Jan 4 20:02:10 2010 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit 37c73b4a6ba68aa9f2c504c4f3213e1e979220b9
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Jan 4 20:01:24 2010 +0100

    added the subscription history

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 37c4fea..a6f4f3c 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -46,6 +46,8 @@ urlpatterns = patterns('',
     (r'account/$', 'mygpo.web.views.account'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
+    (r'^history/$', 'mygpo.web.views.history'),
+
     (r'^toplist/$', 'mygpo.web.views.toplist'),
     (r'^toplist/(?P<count>\d+).opml', 'mygpo.web.views.toplist_opml'),
     (r'^toplist.opml$', 'mygpo.web.views.toplist_opml', {'count': 50}),
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 66cfce0..84b98bd 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -72,6 +72,7 @@
      <li><a href="/search/">Search</a></li>
      <li><a href="/toplist/">Toplist</a></li>
      <li><a href="/suggestions/">Suggestions</a></li>
+     <li><a href="/history/">History</a></li>
     </ul>
    {% else %}
     <ul class="menu">
diff --git a/mygpo/web/templates/history.html b/mygpo/web/templates/history.html
new file mode 100644
index 0000000..f8afa96
--- /dev/null
+++ b/mygpo/web/templates/history.html
@@ -0,0 +1,32 @@
+{% extends "base.html" %}
+{% load i18n %}
+{% load humanize %}
+
+{% block content %}
+  <h1>{% trans "Subscription History" %}</h1>
+
+   {% if not history|length_is:"0" %}
+   <table class="list">
+    <tr>
+     <th>{% trans "Timestamp" %}</th>
+     <th>{% trans "Action" %}</th>
+     <th>{% trans "Devices" %}</th>
+    </tr>
+    {% for s in history %}
+     <tr>
+      <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
+      <td>
+       {% ifequal s.action 1 %}
+        {% trans "subscribe" %}
+       {% endifequal %}
+       {% ifequal s.action -1 %}
+        {% trans "unsubscribe" %}
+       {% endifequal %}
+      </td>
+      <td>{{ s.device.name }}</td>
+     </tr>
+    {% endfor %}
+   </table>
+  {% endif %}
+{% endblock %}
+
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 00aa969..3cf7a1f 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -61,7 +61,6 @@ def create_subscriptionlist(request):
 
     return l.values()
 
-
 @login_required
 def podcast(request, pid):
     podcast = Podcast.objects.get(pk=pid)
@@ -76,6 +75,13 @@ def podcast(request, pid):
         'episodes': episodes,
     }, context_instance=RequestContext(request))
 
+def history(request, len=20):
+    devices = Device.objects.filter(user=request.user)
+    history = SubscriptionAction.objects.filter(device__in=devices).order_by('-timestamp')[:len]
+    return render_to_response('history.html', {
+        'history': history,
+    }, context_instance=RequestContext(request))
+
 @login_required
 def podcast_subscribe(request, pid):
     podcast = Podcast.objects.get(pk=pid)

commit 4f500aa4e2189e98803153f48c9d534d21cf6363
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Jan 4 18:29:44 2010 +0100

    bugfixing simple api and tests

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index d98df9a..d9bc048 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -336,7 +336,7 @@ class Subscription(models.Model):
     class Meta:
         db_table = 'current_subscription'
         #not available in Django 1.0 (Debian stable)
-        #managed = False
+        managed = False
 
 
 class SubscriptionMeta(models.Model):
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 6c313d4..e7550d9 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -24,6 +24,7 @@ from django.core import serializers
 from datetime import datetime
 from mygpo.api.httpresponse import HttpResponseNotAuthorized
 import re
+from mygpo.log import log
 
 try:
     import simplejson as json
@@ -76,7 +77,12 @@ def parse_subscription(raw_post_data, format, user, device_uid):
     if format == 'txt':
         sub = raw_post_data.split('\n')
         p = '^[a-zA-z]'
-        urls = [x for x in sub if re.search(p, x) != None]
+        urls = []
+        for x in sub:
+            if re.search(p, x) == None:
+                log('parse_subscription (txt): invalid podcast url: %s' % x)
+            else:
+                urls.append(x)
 
     elif format == 'opml':
         i = Importer(content=raw_post_data)
diff --git a/mygpo/api/sql/subscription.sql b/mygpo/api/sql/subscription.sql
index cd70d2e..63fb07f 100644
--- a/mygpo/api/sql/subscription.sql
+++ b/mygpo/api/sql/subscription.sql
@@ -1,3 +1,5 @@
+--DROP TABLE current_subscription;
+--DROP VIEW current_subscription;
 
 CREATE VIEW current_subscription AS SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since, sum(a.action) as summe
     FROM (subscription_log a JOIN device b on a.device_id=b.id)
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index a330aa9..2fb55d2 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -18,7 +18,7 @@
 from django.test import TestCase
 from django.test.client import Client
 from django.contrib.auth.models import User
-from mygpo.api.models import Device, Podcast, SubscriptionAction, UserProfile, EpisodeAction
+from mygpo.api.models import Device, Podcast, Subscription, SubscriptionAction, UserProfile, EpisodeAction
 from put_test import put_data
 from django.http import HttpRequest
 from mygpo.api.simple import subscriptions
@@ -259,6 +259,7 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p2) 
         
         #2. put 1 new podcast and delete 1 old
+        time.sleep(1)
         r.raw_post_data = data_txt_2
         subscriptions(request=r, username=un, device_uid=d1, format=f1)
         
@@ -269,6 +270,7 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p3) 
         
         #3. put 2 new podcasts
+        time.sleep(1)
         r.raw_post_data = data_json_1
         subscriptions(request=r, username=un, device_uid=d2, format=f2)
         
@@ -282,6 +284,7 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p2) 
 
         #4. put 1 new podcast and delete 1 old
+        time.sleep(1)
         r.raw_post_data = data_json_2
         subscriptions(request=r, username=un, device_uid=d2, format=f2)
         
@@ -292,6 +295,7 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p3) 
         
         #5. put 2 new podcasts
+        time.sleep(1)
         r.raw_post_data = data_opml_1
         subscriptions(request=r, username=un, device_uid=d3, format=f3)
         
@@ -305,6 +309,7 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p2) 
         
         #6. put 1 new podcast and delete 1 old
+        time.sleep(1)
         r.raw_post_data = data_opml_2
         subscriptions(request=r, username=un, device_uid=d3, format=f3)
         

commit 3433d4ebf6a0464ba5da69b1598b29d9df221346
Merge: 38604e1... b5bd24c...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Jan 4 16:46:39 2010 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit b5bd24c73438cdec24a29d09c98d19b01055f98e
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Jan 4 14:23:45 2010 +0100

    advanced toplist in web

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 3f9cff0..d98df9a 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -83,6 +83,7 @@ class Podcast(models.Model):
 
 class ToplistEntry(models.Model):
     podcast = models.ForeignKey(Podcast)
+    oldplace = models.IntegerField(db_column='old_place')
     subscriptions = models.IntegerField(db_column='subscription_count')
 
     def __unicode__(self):
diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
index 485f704..63383fa 100644
--- a/mygpo/web/templates/toplist.html
+++ b/mygpo/web/templates/toplist.html
@@ -9,12 +9,14 @@
   <table class="list">
    <tr>
     <th>{% trans "#" %}</th>
+    <th>{% trans "Last week" %}</th>
     <th>{% trans "Podcast" %}</th>
     <th>{% trans "Subscribers" %}</th>
    </tr>
   {% for entry in entries %}
    <tr>
     <td>{{ forloop.counter }}</td>
+    <td class="numeric">{{ entry.oldplace }}</td>
     <td><a href="/podcast/{{ entry.podcast.id }}">{{ entry.podcast }}</a></td>
     <td class="numeric">{{ entry.subscriptions }}</td>
    </tr>

commit 38604e1a6bed99feed31a16735a479da6c06ae4c
Merge: dbd4186... e1df056...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Jan 3 23:28:21 2010 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit e1df056f6732ef9df99661955cb795e76ca93575
Merge: f553b51... 5adcd64...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Jan 3 17:20:38 2010 +0100

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit f553b51459ce6e72f3c246853f7d288b6828b150
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sat Jan 2 14:25:54 2010 +0100

    toplist history and suggestion delete just the suggstion for one user

diff --git a/install/update-10.sql b/install/update-10.sql
index 5e38c2d..bf0f111 100644
--- a/install/update-10.sql
+++ b/install/update-10.sql
@@ -1,4 +1,4 @@
-ALTER TABLE user ADD COLUMN suggestion_up_to_date INTEGER;
+ALTER TABLE user ADD COLUMN suggestion_up_to_date INTEGER DEFAULT 0;
 
 update user set suggestion_up_to_date = 0;
 
@@ -46,11 +46,11 @@ BEGIN
          START TRANSACTION;
             OPEN cur1;
 
-            DELETE FROM suggestion;
             REPEAT
                 FETCH cur1 INTO user_help;
 
                 IF NOT done THEN
+                    DELETE FROM suggestion where user_id=user_help;
                     DELETE FROM suggestion_pod;
                     DELETE FROM suggestion_user;
 select user_help;
@@ -180,3 +180,57 @@ CREATE TABLE episode_log (
     UNIQUE (user_id, episode_id, timestamp)
 );
 
+ALTER TABLE toplist ADD COLUMN old_place INTEGER DEFAULT 0;
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_toplist $$
+CREATE PROCEDURE update_toplist()
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
+
+    DROP TABLE IF EXISTS toplist_temp;
+    CREATE TABLE toplist_temp (
+            podcast_id INT PRIMARY KEY REFERENCES podcast (id),
+            subscription_count INT NOT NULL DEFAULT 0,
+            old_place INT DEFAULT 0,
+            INDEX(podcast_id)
+    );
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+        DECLARE deadlock_detected CONDITION FOR 1213;
+            DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+            SET deadlock=0;
+
+            START TRANSACTION;
+            DELETE FROM toplist_temp;
+            INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription, 
+                                       (select (id - (select min(id) from toplist) + 1) from toplist where podcast_id = a.podcast_id)
+                        FROM (SELECT DISTINCT podcast_id, user_id
+                            FROM public_subscription) a
+                        GROUP BY podcast_id);
+            DELETE FROM toplist;
+            INSERT INTO toplist (podcast_id, subscription_count, id, old_place) (SELECT podcast_id, subscription_count, NULL, old_place FROM toplist_temp
+                        ORDER BY subscription_count DESC LIMIT 100);
+
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Toplist is not updated!');
+        END IF;
+        DROP TABLE IF EXISTS toplist_temp;
+
+END $$
+DELIMITER ;

commit 9f235c75dff4c77a1a8ba6046b93a027c9de57df
Merge: 7bc8cc9... 71e297a...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sat Jan 2 13:31:38 2010 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit 71e297a5f262568e36f531490a3517dd0169fde1
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Jan 1 18:01:29 2010 +0100

    add proof-of-concept search using haystack, woosh
    
    implemented simple search using django-haystack and woosh

diff --git a/INSTALL b/INSTALL
index de5c1a9..8749c01 100644
--- a/INSTALL
+++ b/INSTALL
@@ -13,6 +13,8 @@ Dependencies:
   * python-feedparser
   * python-dateutil
   * python-json or python-simplejson
+  * django-haystack
+  * woosh
 
 1. Creating the database
 
diff --git a/mygpo/api/search_indexes.py b/mygpo/api/search_indexes.py
new file mode 100644
index 0000000..521ce47
--- /dev/null
+++ b/mygpo/api/search_indexes.py
@@ -0,0 +1,22 @@
+import datetime
+from haystack import indexes
+from haystack import site
+from mygpo.api.models import Podcast, Episode
+
+
+class PodcastIndex(indexes.SearchIndex):
+
+    text = indexes.CharField(document=True, use_template=True)
+
+    def get_queryset(self):
+        """Used when the entire index for model is updated."""
+        return Podcast.objects.all()#Note.objects.filter(pub_date__lte=datetime.datetime.now())
+
+
+class EpisodeIndex(indexes.SearchIndex):
+
+    text = indexes.CharField(document=True, use_template=True)
+
+
+site.register(Podcast, PodcastIndex)
+site.register(Episode, EpisodeIndex)
diff --git a/mygpo/api/templates/search/indexes/api/episode_text.txt b/mygpo/api/templates/search/indexes/api/episode_text.txt
new file mode 100644
index 0000000..8c94d5a
--- /dev/null
+++ b/mygpo/api/templates/search/indexes/api/episode_text.txt
@@ -0,0 +1,6 @@
+{{ object.title|default:"" }}
+{{ object.podcast }}
+{{ object.url }}
+{{ object.link|default:"" }}
+{{ object.description|default:"" }}
+
diff --git a/mygpo/api/templates/search/indexes/api/podcast_text.txt b/mygpo/api/templates/search/indexes/api/podcast_text.txt
new file mode 100644
index 0000000..7b8d1ac
--- /dev/null
+++ b/mygpo/api/templates/search/indexes/api/podcast_text.txt
@@ -0,0 +1,5 @@
+{{ object.title|default:"" }}
+{{ object.url }}
+{{ object.link|default:"" }}
+{{ object.description|default:"" }}
+
diff --git a/mygpo/search_sites.py b/mygpo/search_sites.py
new file mode 100644
index 0000000..3afb2fa
--- /dev/null
+++ b/mygpo/search_sites.py
@@ -0,0 +1,3 @@
+import haystack
+haystack.autodiscover()
+
diff --git a/mygpo/settings.py b/mygpo/settings.py
index fd13d46..4e085f2 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -102,6 +102,7 @@ INSTALLED_APPS = (
     'django.contrib.admin',
     'django.contrib.humanize',
     'registration',
+    'haystack',
     'mygpo.api',
     'mygpo.web'
 )
@@ -119,3 +120,8 @@ AUTH_PROFILE_MODULE = "api.UserProfile"
 
 LOGIN_URL = '/login/'
 
+#see http://haystacksearch.org/docs/
+HAYSTACK_SITECONF = 'mygpo.search_sites'
+HAYSTACK_SEARCH_ENGINE = 'whoosh'
+HAYSTACK_WHOOSH_PATH = os.path.abspath('%s/../search_index' % os.path.dirname(__file__))
+
diff --git a/mygpo/urls.py b/mygpo/urls.py
index ab6b5be..37c4fea 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -57,6 +57,8 @@ urlpatterns = patterns('',
     (r'^device/(?P<device_id>\d+)/sync$', 'mygpo.web.views.device_sync'),
     (r'^device/(?P<device_id>\d+)/unsync$', 'mygpo.web.views.device_unsync'),
 
+    (r'^search/', include('haystack.urls')),
+
     #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index f3cd262..66cfce0 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -69,6 +69,7 @@
 
     <ul class="menu">
      <li><strong>Podcasts</strong></li>
+     <li><a href="/search/">Search</a></li>
      <li><a href="/toplist/">Toplist</a></li>
      <li><a href="/suggestions/">Suggestions</a></li>
     </ul>
diff --git a/mygpo/web/templates/search/search.html b/mygpo/web/templates/search/search.html
new file mode 100644
index 0000000..d2b08f8
--- /dev/null
+++ b/mygpo/web/templates/search/search.html
@@ -0,0 +1,37 @@
+{% extends 'base.html' %}
+
+{% load i18n %}
+
+{% block content %}
+    <h2>{% trans "Search" %}</h2>
+
+    <form method="get" action=".">
+        <table>
+            {{ form.as_table }}
+            <tr>
+                <td>&nbsp;</td>
+                <td>
+                    <input type="submit" value="Search">
+                </td>
+            </tr>
+        </table>
+
+        {% if query %}
+            <h3>Results</h3>
+
+            {% for result in page.object_list %}
+                <p>
+                  {% ifequal result.model_name "podcast" %}
+                    <a href="/podcast/{{ result.pk }}">{{ result.object }}</a>
+                  {% endifequal %}
+                  {% ifequal result.model_name "episode" %}
+                    <a href="/episode/{{ result.pk }}">{{ result.object }}</a>
+                  {% endifequal %}
+                </p>
+            {% endfor %}
+        {% else %}
+            {# Show some example queries to run, maybe query syntax, something else? #}
+        {% endif %}
+    </form>
+{% endblock %}
+

commit 445c442d6c360fd62ce6367893dd15a9a637e8d1
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Jan 1 17:54:28 2010 +0100

    rename mygpo.logging to mygpo.log
    
    renamed due to name clash with other logging api used by haystack and possible
    nose

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index dc4ccbd..d326840 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -23,7 +23,7 @@ from django.core import serializers
 from time import mktime
 from datetime import datetime, timedelta
 import dateutil.parser
-from mygpo.logging import log
+from mygpo.log import log
 from django.db import IntegrityError
 import re
 
diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 0be86c1..fb02db2 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -22,7 +22,7 @@ from mygpo.api.models import Subscription, Podcast, SubscriptionAction, Device,
 from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
 from django.db import IntegrityError
-from mygpo.logging import log
+from mygpo.log import log
 
 LEGACY_DEVICE_NAME = 'Legacy Device'
 LEGACY_DEVICE_UID  = 'legacy'
diff --git a/mygpo/log.py b/mygpo/log.py
new file mode 100644
index 0000000..6aea1f6
--- /dev/null
+++ b/mygpo/log.py
@@ -0,0 +1,26 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+# my.gpodder.org logging module
+
+import syslog
+
+syslog.openlog('my.gpodder.org')
+
+def log(message):
+    syslog.syslog(message)
+
diff --git a/mygpo/logging.py b/mygpo/logging.py
deleted file mode 100644
index 6aea1f6..0000000
--- a/mygpo/logging.py
+++ /dev/null
@@ -1,26 +0,0 @@
-#
-# This file is part of my.gpodder.org.
-#
-# my.gpodder.org is free software: you can redistribute it and/or modify it
-# under the terms of the GNU Affero General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or (at your
-# option) any later version.
-#
-# my.gpodder.org is distributed in the hope that it will be useful, but
-# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
-# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
-# License for more details.
-#
-# You should have received a copy of the GNU Affero General Public License
-# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
-#
-
-# my.gpodder.org logging module
-
-import syslog
-
-syslog.openlog('my.gpodder.org')
-
-def log(message):
-    syslog.syslog(message)
-

commit 9dd11c6086cedfffbc82a8c605a0e0bbef107d50
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Dec 31 16:19:00 2009 +0100

    testing, bugfixing episodes in advanced api

diff --git a/install/update-10.sql b/install/update-10.sql
index 1f03ff8..bd4d8f4 100644
--- a/install/update-10.sql
+++ b/install/update-10.sql
@@ -162,3 +162,21 @@ BEGIN
 
 END $$
 DELIMITER ;
+
+
+
+DROP TABLE IF EXISTS episode_log;
+CREATE TABLE episode_log (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    user_id INT NOT NULL,
+    episode_id INT NOT NULL,
+    device_id INT,
+    action ENUM ('download', 'play', 'delete', 'new') NOT NULL,
+    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
+    playmark INT DEFAULT 0,
+    FOREIGN KEY (user_id) REFERENCES auth_user (id),
+    FOREIGN KEY (episode_id) REFERENCES episode (id),
+    FOREIGN KEY (device_id) REFERENCES device (id),
+    UNIQUE (user_id, episode_id, timestamp)
+);
+
diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 0e39a94..dc4ccbd 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -121,7 +121,8 @@ def episodes(request, username):
     if request.user.username != username:
         return HttpResponseForbidden()
 
-    now = int(mktime(datetime.now().timetuple()))
+    now = datetime.now()
+    now_ = int(mktime(now.timetuple()))
 
     if request.method == 'POST':
         try:
@@ -130,7 +131,8 @@ def episodes(request, username):
             return HttpResponseBadRequest()
 
         update_episodes(request.user, actions)
-        return HttpResponse()
+
+        return JsonResponse({'timestamp': now_})
 
     elif request.method == 'GET':
         podcast_id = request.GET.get('podcast', None)
@@ -143,7 +145,7 @@ def episodes(request, username):
         except:
             raise Http404
 
-        return JsonRequest(get_episode_changes(request.user, podcast, device, since, now))
+        return JsonResponse(get_episode_changes(request.user, podcast, device, since, now))
 
     else:
         return HttpResponseNotAllowed(['POST', 'GET'])
@@ -151,7 +153,18 @@ def episodes(request, username):
 
 def get_episode_changes(user, podcast, device, since, until):
     actions = []
-    for a in EpisodeAction.objects.filter(user=user, podcast=podcast, device=device, timestamp__gt=since, timestamp__lte=until):
+    eactions = EpisodeAction.objects.filter(user=user, timestamp__lte=until)
+
+    if podcast:
+        eactions = eactions.filter(episode__podcast=podcast)
+
+    if device:
+        eactions = eactions.filter(device=device)
+
+    if since: # we can't use None with __gt
+        eactions = eactions.filter(timestamp__gt=since)
+
+    for a in eactions:
         action = {
             'podcast': a.episode.podcast.url,
             'episode': a.episode.url,
@@ -163,7 +176,9 @@ def get_episode_changes(user, podcast, device, since, until):
 
         actions.append(action)
 
-    return {'timestamp': since, 'actions': actions}
+    until_ = int(mktime(until.timetuple()))
+
+    return {'actions': actions, 'timestamp': until_}
 
 
 def update_episodes(user, actions):
@@ -177,10 +192,13 @@ def update_episodes(user, actions):
         except:
             return HttpResponseBadRequest('not all required fields (podcast, episode, action) given')
 
-        device, created = Device.objects.get_or_create(user=user, uid=e['device'], defaults={'name': 'Unknown', 'type': 'other'}) if 'device' in e else None
-        timestamp = dateutil.parser.parse(e['timestamp']) if 'timestamp' in e else None
+        if 'device' in e:
+            device, created = Device.objects.get_or_create(user=user, uid=e['device'], defaults={'name': 'Unknown', 'type': 'other'})
+        else:
+            device, created = None, False
+        timestamp = dateutil.parser.parse(e['timestamp']) if 'timestamp' in e else datetime.now()
         position = parseTimeDelta(e['position']) if 'position' in e else None
-        playmark = position['seconds'] if position else None
+        playmark = position.seconds if position else None
 
         if position and action != 'play':
             return HttpResponseBadRequest('parameter position can only be used with action play')
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 40203e2..3f9cff0 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -118,7 +118,7 @@ class Episode(models.Model):
     timestamp = models.DateTimeField(null=True, blank=True)
 
     def __unicode__(self):
-        return self.title
+        return '%s (%s)' % (self.title, self.podcast)
 
     class Meta:
         db_table = 'episode'
@@ -301,15 +301,15 @@ class Device(models.Model):
         db_table = 'device'
 
 class EpisodeAction(models.Model):
-    user = models.ForeignKey(User, primary_key=True)
+    user = models.ForeignKey(User)
     episode = models.ForeignKey(Episode)
-    device = models.ForeignKey(Device)
+    device = models.ForeignKey(Device,null=True)
     action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
     timestamp = models.DateTimeField(default=datetime.now)
     playmark = models.IntegerField(null=True, blank=True)
 
     def __unicode__(self):
-        return '%s %s %s' % self.user, self.action, self.episode
+        return '%s %s %s' % (self.user, self.action, self.episode)
 
     class Meta:
         db_table = 'episode_log'
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index b7a88d2..a330aa9 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -18,7 +18,7 @@
 from django.test import TestCase
 from django.test.client import Client
 from django.contrib.auth.models import User
-from mygpo.api.models import Device, Podcast, SubscriptionAction, UserProfile
+from mygpo.api.models import Device, Podcast, SubscriptionAction, UserProfile, EpisodeAction
 from put_test import put_data
 from django.http import HttpRequest
 from mygpo.api.simple import subscriptions
@@ -94,6 +94,10 @@ class AdvancedAPITest(TestCase):
         self.user.save()
         self.device1 = Device.objects.create(user=self.user, name='d1', uid='uid1', type='desktop')
         self.device2 = Device.objects.create(user=self.user, name='d2', uid='uid2', type='mobile')
+        self.url1 = 'http://example.com/feed.rss'
+        self.url2 = 'http://example.org/podcast.php'
+        self.url3 = 'http://example.net/foo.xml'
+
         self.client = Client()
         l = self.client.login(username='adv', password='adv1')
         self.assertEqual(l, True)
@@ -124,13 +128,13 @@ class AdvancedAPITest(TestCase):
 
 
     def test_add_remove_subscriptions(self):
-        req = {"add": ["http://example.com/feed.rss", "http://example.org/podcast.php", "http://example.net/foo.xml"]}
+        req = {"add": [self.url1, self.url2, self.url3]}
         reqs = json.dumps(req)
 
         #adding 3 subscriptions
         response = self.client.post('/api/1/subscriptions/%s/%s.json' % (self.user.username, self.device1.uid), data={'data': reqs})
         self.assertEqual(response.status_code, 200)
-        
+
         resp = json.loads(response.content)
         add_timestamp = resp['timestamp']
 
@@ -138,11 +142,11 @@ class AdvancedAPITest(TestCase):
         response = self.client.get('/api/1/subscriptions/%s/%s.json' % (self.user.username, self.device1.uid), {'since': add_timestamp-1})
         changes = json.loads(response.content)
 
-        self.assertEqual(changes['add'], ["http://example.com/feed.rss", "http://example.org/podcast.php", "http://example.net/foo.xml"])
+        self.assertEqual(changes['add'], [self.url1, self.url2, self.url3])
         self.assertEqual(len(changes['remove']), 0)
 
         #removing the 1st and 3rd subscription
-        req = {"add": [], 'remove': ["http://example.com/feed.rss","http://example.net/foo.xml"]}
+        req = {"add": [], 'remove': [self.url1, self.url3]}
         reqs = json.dumps(req)
         time.sleep(1)
         response = self.client.post('/api/1/subscriptions/%s/%s.json' % (self.user.username, self.device1.uid), data={'data': reqs})
@@ -154,10 +158,48 @@ class AdvancedAPITest(TestCase):
         #changes since beginning, should return 1 addition, 2 removals
         response = self.client.get('/api/1/subscriptions/%s/%s.json' % (self.user.username, self.device1.uid), {'since': add_timestamp-1})
         changes = json.loads(response.content)
-        self.assertEqual(changes['add'], ["http://example.org/podcast.php"])
-        self.assertEqual(changes['remove'], ["http://example.com/feed.rss","http://example.net/foo.xml"])
+        self.assertEqual(changes['add'], [self.url2])
+        self.assertEqual(changes['remove'], [self.url1, self.url3])
+
+
+    def test_episode_update(self):
+        req =  [{"podcast": self.url1,
+                 "episode": "http://example.com/files/s01e20.mp3",
+                 "device": self.device1.uid,
+                 "action": "download",
+                 "timestamp": "2009-12-12T09:00:00"},
+                {"podcast": self.url2,
+                 "episode": "http://ftp.example.org/foo.ogg",
+                 "action": "play",
+                 "position": "01:00:00"}]
+        reqs = json.dumps(req)
+        response = self.client.post('/api/1/episodes/%s.json' % self.user.username, data={'data': reqs})
+        self.assertEqual(response.status_code, 200)
 
-        #changes including removal
+        resp = json.loads(response.content)
+        timestamp = resp['timestamp']
+
+        response = self.client.get('/api/1/episodes/%s.json' % self.user.username)
+        changes = json.loads(response.content)
+        self.assertEqual(len(changes['actions']), 2)
+        self.assertTrue(self.hash_subset({u'action': u'download', u'podcast': self.url1, u'episode': u'http://example.com/files/s01e20.mp3'}, changes['actions'][0]))
+        self.assertTrue(self.hash_subset({u'action': u'play', u'podcast': self.url2, u'episode': u'http://ftp.example.org/foo.ogg'}, changes['actions'][1]))
+
+#        #currently fails, seems to be a bug in the test client
+#        response = self.client.get('/api/1/episodes/%s.json' % self.user.username, {'podcast': self.url2})
+#        self.assertEqual(response.status_code, 200)
+#        changes = json.loads(response.content)
+#        self.assertEqual(len(changes['actions']), 1)
+#        self.assertTrue(self.hash_subset({u'action': u'play', u'podcast': self.url2, u'episode': u'http://ftp.example.org/foo.ogg'}, changes['actions'][0]))
+
+
+    def hash_subset(self, hash1, hash2):
+        for x in hash1.keys():
+            if not x in hash2:
+                return False
+            if hash2[x] != hash1[x]:
+                return False
+        return True
 
 
 class SimpleTest(TestCase):

commit 47558d5b36e65dd0288114e3c848fc25accd95cc
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 30 13:02:35 2009 +0100

    fix ordering in SuggestionEntry.forUser(user)

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 40446f1..40203e2 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -99,7 +99,7 @@ class SuggestionEntry(models.Model):
     @staticmethod
     def forUser(user):
         subscriptions = [x.podcast for x in Subscription.objects.filter(user=user)]
-        suggestions = SuggestionEntry.objects.filter(user=user)
+        suggestions = SuggestionEntry.objects.filter(user=user).order_by('-priority')
         return [s for s in suggestions if s.podcast not in subscriptions]
 
     def __unicode__(self):

commit e199bfc1f0a3dbb491b74fc4112b57191bba6a5f
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 30 13:00:12 2009 +0100

    implement SuggestionEntry.forUser(user) (bug 726)

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 3196d80..40446f1 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -96,6 +96,12 @@ class SuggestionEntry(models.Model):
     user = models.ForeignKey(User)
     priority = models.IntegerField()
 
+    @staticmethod
+    def forUser(user):
+        subscriptions = [x.podcast for x in Subscription.objects.filter(user=user)]
+        suggestions = SuggestionEntry.objects.filter(user=user)
+        return [s for s in suggestions if s.podcast not in subscriptions]
+
     def __unicode__(self):
         return '%s (%s)' % (self.podcast, self.priority)
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 87e51d8..00aa969 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -181,7 +181,7 @@ def suggestions(request):
         Rating.objects.create(target='suggestions', user=request.user, rating=request.GET['rate'], timestamp=datetime.now())
         rated = True
 
-    entries = SuggestionEntry.objects.filter(user=request.user).order_by('-priority')
+    entries = SuggestionEntry.forUser(request.user)
     return render_to_response('suggestions.html', {
         'entries': entries,
         'rated'  : rated
@@ -190,7 +190,7 @@ def suggestions(request):
 
 @require_valid_user
 def suggestions_opml(request, count):
-    entries = SuggestionEntry.objects.filter(user=request.user).order_by('-priority')
+    entries = SuggestionEntry.forUser(request.user)
     exporter = Exporter(_('my.gpodder.org - %s Suggestions') % count)
 
     opml = exporter.generate([e.podcast for e in entries])

commit 3b1057a90235832baad142fe6039320145481806
Merge: 4394a39... 2d59b1c...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 30 10:13:34 2009 +0100

    Merge branch 'master' of ssh://stefankoegl@repo.or.cz/srv/git/mygpo

commit 4394a39444809d5b0840f40b5c0a0198f8cc19a3
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 30 10:13:01 2009 +0100

    typo in footer in base.html

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 6109a6c..f3cd262 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -85,7 +85,7 @@
 
   <hr style="clear: both;">
 
-  <address> 2005-2009 <a class="noextlink" href="http://thpinfo.com/">Thomas Perl</a> andthe gPodder Team</address>
+  <address> 2005-2009 <a class="noextlink" href="http://thpinfo.com/">Thomas Perl</a> and the gPodder Team</address>
  </body>
 </html>
 

commit 2d59b1ce621e037c11fecb123b4d8a9f85f39ee2
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Dec 29 15:51:09 2009 +0100

    Fix test cases after Simple API clarifications
    
    Successful Simple API PUT requests should return
    an empty response and HTTP Status code 200.
    
    There has been an error (really and error, not just
    a failure) in a test case, so I've removed it from
    the test runner from now - please fix and re-enable.

diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index df1a891..b7a88d2 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -35,7 +35,8 @@ except ImportError:
 
 
 class SyncTest(TestCase):
-    def test_sync_actions(self):
+    # FIXME: Broken testcase - please fix!
+    def tXest_sync_actions(self):
         # this test does not yet complete when run as a unit test
         # because django does not set up the views
         u  = User.objects.create(username='u')
@@ -202,14 +203,16 @@ class SimpleTest(TestCase):
         #1. put 2 new podcasts
         r.raw_post_data = data_txt_1
         put = subscriptions(request=r, username=un, device_uid=d1, format=f1)
-        self.assertEqual(put.content, "Success\n")
+        # Successful requests should return the empty string + status code 200
+        self.assertEqual(put.status_code, 200)
+        self.assertEqual(put.content, '')
         
         #device 1 txt
-        #device = Device.objects.get(uid=d1, user=u)
+        device = Device.objects.get(uid=d1, user=u)
         
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
-        self.assertEqual( len(urls), 2)
+        self.assertEqual(len(urls), 2)
         self.assertEqual(urls[0], p1)
         self.assertEqual(urls[1], p2) 
         

commit 0a63e238e7d19b1cab760949b2b1440dc7f95b18
Merge: 77fc513... bbcb8e7...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 29 15:29:08 2009 +0100

    Merge branch 'master' of ssh://stefankoegl@repo.or.cz/srv/git/mygpo

commit 7bc8cc9c23949930ebfb73324c4c81866b277220
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Tue Dec 29 15:28:00 2009 +0100

    Suggestion with private subscriptions

diff --git a/install/update-10.sql b/install/update-10.sql
index 1f03ff8..9cb2c97 100644
--- a/install/update-10.sql
+++ b/install/update-10.sql
@@ -54,7 +54,7 @@ BEGIN
                     DELETE FROM suggestion_pod;
                     DELETE FROM suggestion_user;
 select user_help;
-                    insert into suggestion_pod (select podcast_id from public_subscription where user_id=user_help);
+                    insert into suggestion_pod (select podcast_id from current_subscription where user_id=user_help);
 
                     SELECT count(*) into pod_count FROM suggestion_pod;
 
@@ -128,7 +128,7 @@ BEGIN
                DELETE FROM suggestion_pod;
                DELETE FROM suggestion_user;
 
-               insert into suggestion_pod (select podcast_id from public_subscription where user_id=user_par);
+               insert into suggestion_pod (select podcast_id from current_subscription where user_id=user_par);
 	    
                SELECT count(*) into pod_count FROM suggestion_pod;
 

commit 77fc5134173c78276617859a14543cb0a6986696
Merge: e3e66c3... f978d46...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 29 15:01:10 2009 +0100

    Merge branch 'master' of ~/mygpo-src

commit e3e66c3eba6c00c60dc29fa4ccd8b3430ea765fb
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 29 15:00:27 2009 +0100

    updated installation instructions

diff --git a/INSTALL b/INSTALL
index 1cbfe9a..de5c1a9 100644
--- a/INSTALL
+++ b/INSTALL
@@ -5,12 +5,14 @@
 Dependencies:
 
   * python (>= 2.5)
-  * python-django
-  * django-registration
+  * python-django (>= 1.0)
+  * python-django-registration (>= 0.7)
   * MySQL Server (>= 5.0)
   * python-mysqldb
   * lighttpd
   * python-feedparser
+  * python-dateutil
+  * python-json or python-simplejson
 
 1. Creating the database
 
@@ -30,7 +32,7 @@ DB parameters in mygpo/settings.py):
 
   python manage.py syncdb
 
-When asked to create a superuser, say NO.
+When asked to create a superuser, you can say YES.
 
 Now, run every SQL-Script in the install/ subdirectory, starting
 with "create.sql" and working your way all the way through the

commit 5adcd64a017ca9c247ff119aee9c65b18a8bd654
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Tue Dec 29 14:52:52 2009 +0100

    simple api print entfernt + name=device_id

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 6fa908b..6c313d4 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -88,7 +88,7 @@ def parse_subscription(raw_post_data, format, user, device_uid):
     else: raise ValueError('unsupported format %s' % format)
     
     d, created = Device.objects.get_or_create(user=user, uid=device_uid, 
-                defaults = {'type': 'other', 'name': 'unknown_' + device_uid})
+                defaults = {'type': 'other', 'name': device_uid})
 
     podcasts = [p.podcast for p in d.get_subscriptions()]
     old = [p.url for p in podcasts]    
@@ -99,7 +99,6 @@ def parse_subscription(raw_post_data, format, user, device_uid):
 
 def set_subscriptions(subscriptions):
     new, rem, d = subscriptions
-    print new, rem
     
     for r in rem:
         p = Podcast.objects.get(url=r)

commit 264259b64195c77a46cd486eb87f8becacac9bd3
Merge: f978d46... bbcb8e7...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Tue Dec 29 11:31:50 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/thp/mygpo-src

commit 56ea779002fa55b76d18fe21eabf2eb68a73ca64
Merge: 54d7e19... f978d46...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Tue Dec 29 10:47:48 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit dbd4186331e8b5028d70b8ae105af2ae2c7c5e17
Merge: f978d46... 54d7e19...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 28 17:32:43 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit f978d4682423dc8c2146d604e909f712bf027746
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 28 17:29:43 2009 +0100

    cleaning duplicates in /upload (bug 745)
    
    In addition to commit 996a5bc, duplicates are removed before writing them to
    the database.

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 4781b19..0be86c1 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -21,6 +21,8 @@ from mygpo.api.opml import Importer, Exporter
 from mygpo.api.models import Subscription, Podcast, SubscriptionAction, Device, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
+from django.db import IntegrityError
+from mygpo.logging import log
 
 LEGACY_DEVICE_NAME = 'Legacy Device'
 LEGACY_DEVICE_UID  = 'legacy'
@@ -49,20 +51,27 @@ def upload(request):
     i = Importer(opml)
     podcast_urls = [p['url'] for p in i.items]
 
-    new = [item for item in i.items if item['url'] not in existing_urls]
-    rem = [e.podcast for e in existing if e.podcast.url not in podcast_urls]
+    new = [item['url'] for item in i.items if item['url'] not in existing_urls]
+    rem = [e.podcast.url for e in existing if e.podcast.url not in podcast_urls]
+
+    #remove duplicates
+    new = list(set(new))
+    rem = list(set(rem))
 
     for n in new:
-        p, created = Podcast.objects.get_or_create(url=n['url'], defaults={
-                'title' : n['title'],
-                'description': n['description'],
-                'last_update': datetime.now() })
-        s = SubscriptionAction(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
-        s.save()
+        p, created = Podcast.objects.get_or_create(url=n)
+
+        try:
+            SubscriptionAction.objects.create(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
+        except IntegrityError, e:
+            log('/upload: error while adding subscription: user: %s, podcast: %s, error: %s' % (user.id, p.id, e))
 
     for r in rem:
-        s = SubscriptionAction(podcast=r, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
-        s.save()
+        p, created = Podcast.objects.get_or_create(url=r)
+        try:
+            SubscriptionAction.objects.create(podcast=p, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
+        except IntegrityError, e:
+            log('/upload: error while removing subscription: user: %s, podcast: %s, error: %s' % (user.id, p.id, e))
 
     return HttpResponse('@SUCCESS', mimetype='text/plain')
 

commit 466110bb313bed4ac02adf07709f4fc458482137
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 28 17:29:06 2009 +0100

    Revert "handle IntegrityError in /upload (bug 745)"
    
    This reverts commit 19b9683cb26a9821858684fd2eb21f7a1bf4bead.

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 0be86c1..4781b19 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -21,8 +21,6 @@ from mygpo.api.opml import Importer, Exporter
 from mygpo.api.models import Subscription, Podcast, SubscriptionAction, Device, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
-from django.db import IntegrityError
-from mygpo.logging import log
 
 LEGACY_DEVICE_NAME = 'Legacy Device'
 LEGACY_DEVICE_UID  = 'legacy'
@@ -51,27 +49,20 @@ def upload(request):
     i = Importer(opml)
     podcast_urls = [p['url'] for p in i.items]
 
-    new = [item['url'] for item in i.items if item['url'] not in existing_urls]
-    rem = [e.podcast.url for e in existing if e.podcast.url not in podcast_urls]
-
-    #remove duplicates
-    new = list(set(new))
-    rem = list(set(rem))
+    new = [item for item in i.items if item['url'] not in existing_urls]
+    rem = [e.podcast for e in existing if e.podcast.url not in podcast_urls]
 
     for n in new:
-        p, created = Podcast.objects.get_or_create(url=n)
-
-        try:
-            SubscriptionAction.objects.create(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
-        except IntegrityError, e:
-            log('/upload: error while adding subscription: user: %s, podcast: %s, error: %s' % (user.id, p.id, e))
+        p, created = Podcast.objects.get_or_create(url=n['url'], defaults={
+                'title' : n['title'],
+                'description': n['description'],
+                'last_update': datetime.now() })
+        s = SubscriptionAction(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
+        s.save()
 
     for r in rem:
-        p, created = Podcast.objects.get_or_create(url=r)
-        try:
-            SubscriptionAction.objects.create(podcast=p, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
-        except IntegrityError, e:
-            log('/upload: error while removing subscription: user: %s, podcast: %s, error: %s' % (user.id, p.id, e))
+        s = SubscriptionAction(podcast=r, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
+        s.save()
 
     return HttpResponse('@SUCCESS', mimetype='text/plain')
 

commit 19b9683cb26a9821858684fd2eb21f7a1bf4bead
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 28 17:14:27 2009 +0100

    handle IntegrityError in /upload (bug 745)
    
    adding a subscription twice in one upload using the legacy api caused an
    IntegrityError. This error is now catched and logged.
    
    Additionally, the list of podcasts to be added/removed is now cleaned from
    duplicates.

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 4781b19..0be86c1 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -21,6 +21,8 @@ from mygpo.api.opml import Importer, Exporter
 from mygpo.api.models import Subscription, Podcast, SubscriptionAction, Device, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
+from django.db import IntegrityError
+from mygpo.logging import log
 
 LEGACY_DEVICE_NAME = 'Legacy Device'
 LEGACY_DEVICE_UID  = 'legacy'
@@ -49,20 +51,27 @@ def upload(request):
     i = Importer(opml)
     podcast_urls = [p['url'] for p in i.items]
 
-    new = [item for item in i.items if item['url'] not in existing_urls]
-    rem = [e.podcast for e in existing if e.podcast.url not in podcast_urls]
+    new = [item['url'] for item in i.items if item['url'] not in existing_urls]
+    rem = [e.podcast.url for e in existing if e.podcast.url not in podcast_urls]
+
+    #remove duplicates
+    new = list(set(new))
+    rem = list(set(rem))
 
     for n in new:
-        p, created = Podcast.objects.get_or_create(url=n['url'], defaults={
-                'title' : n['title'],
-                'description': n['description'],
-                'last_update': datetime.now() })
-        s = SubscriptionAction(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
-        s.save()
+        p, created = Podcast.objects.get_or_create(url=n)
+
+        try:
+            SubscriptionAction.objects.create(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
+        except IntegrityError, e:
+            log('/upload: error while adding subscription: user: %s, podcast: %s, error: %s' % (user.id, p.id, e))
 
     for r in rem:
-        s = SubscriptionAction(podcast=r, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
-        s.save()
+        p, created = Podcast.objects.get_or_create(url=r)
+        try:
+            SubscriptionAction.objects.create(podcast=p, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
+        except IntegrityError, e:
+            log('/upload: error while removing subscription: user: %s, podcast: %s, error: %s' % (user.id, p.id, e))
 
     return HttpResponse('@SUCCESS', mimetype='text/plain')
 

commit 54d7e190644adbfbb63a014abc1e738c57f7f6fd
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Dec 28 17:12:33 2009 +0100

    Bug 726 Suggestion

diff --git a/install/update-10.sql b/install/update-10.sql
new file mode 100644
index 0000000..1f03ff8
--- /dev/null
+++ b/install/update-10.sql
@@ -0,0 +1,164 @@
+ALTER TABLE user ADD COLUMN suggestion_up_to_date INTEGER;
+
+update user set suggestion_up_to_date = 0;
+
+DELIMITER //
+CREATE TRIGGER suggestion_not_up_to_date_trigger AFTER INSERT ON subscription_log
+FOR EACH ROW
+BEGIN
+    update user set suggestion_up_to_date = 0 where user_ptr_id = (select user_id from device where id = new.device_id);
+END;//
+DELIMITER ;
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_suggestion $$
+CREATE PROCEDURE update_suggestion()
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
+    DECLARE done INT DEFAULT 0;
+    DECLARE user_help INT DEFAULT 0;
+    DECLARE pod_count INT DEFAULT 0;
+    DECLARE cur1 CURSOR FOR SELECT user_ptr_id FROM user where suggestion_up_to_date = 0;
+    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
+    
+
+
+    DROP TABLE IF EXISTS suggestion_pod;
+    CREATE TABLE suggestion_pod (
+       podID INT
+    );
+    DROP TABLE IF EXISTS suggestion_user;
+    CREATE TABLE suggestion_user (
+       userID INT
+    );
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+         DECLARE deadlock_detected CONDITION FOR 1213;
+         DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+         SET deadlock=0;
+               
+         START TRANSACTION;
+            OPEN cur1;
+
+            DELETE FROM suggestion;
+            REPEAT
+                FETCH cur1 INTO user_help;
+
+                IF NOT done THEN
+                    DELETE FROM suggestion_pod;
+                    DELETE FROM suggestion_user;
+select user_help;
+                    insert into suggestion_pod (select podcast_id from public_subscription where user_id=user_help);
+
+                    SELECT count(*) into pod_count FROM suggestion_pod;
+
+                    IF pod_count > 0 THEN
+                        insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
+                        insert into suggestion (select user_help, podcast_id, count(podcast_id) as priority 
+                                     from public_subscription, suggestion_user 
+                                     where user_id=userID and podcast_id not in (select * from suggestion_pod) 
+                                     group by user_help, podcast_id order by priority DESC LIMIT 10);
+                    ELSE
+                        insert into suggestion (select user_help, podcast_id, subscription_count, NULL as priority from toplist 
+                                     group by user_help, podcast_id order by subscription_count DESC LIMIT 10);
+                    END IF;
+                    update user set suggestion_up_to_date = 1 where user_ptr_id = user_help;
+                END IF;
+            UNTIL done END REPEAT;
+
+            CLOSE cur1;
+
+            COMMIT;  
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Suggestion are not updated!');
+        END IF;
+
+        DROP TABLE IF EXISTS suggestion_user;
+        DROP TABLE IF EXISTS suggestion_pod;         
+
+END $$
+DELIMITER ;
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_suggestion_for $$
+CREATE PROCEDURE update_suggestion_for(IN user_par INT)
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
+    DECLARE pod_count INT DEFAULT 0;
+    DECLARE utd INT DEFAULT 0;
+        
+    DROP TABLE IF EXISTS suggestion_pod;
+    CREATE TABLE suggestion_pod (
+       podID INT
+    );
+    DROP TABLE IF EXISTS suggestion_user;
+    CREATE TABLE suggestion_user (
+       userID INT
+    );
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+         DECLARE deadlock_detected CONDITION FOR 1213;
+         DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+         SET deadlock=0;
+               
+         START TRANSACTION;
+            SELECT suggestion_up_to_date into utd FROM user where user_ptr_id = user_par;
+            IF utd < 1 THEN
+               DELETE FROM suggestion where user_id=user_par;
+               DELETE FROM suggestion_pod;
+               DELETE FROM suggestion_user;
+
+               insert into suggestion_pod (select podcast_id from public_subscription where user_id=user_par);
+	    
+               SELECT count(*) into pod_count FROM suggestion_pod;
+
+               IF pod_count > 0 THEN
+                  insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
+                  insert into suggestion (select user_par, podcast_id, count(podcast_id) as priority 
+                                     from public_subscription, suggestion_user 
+                                     where user_id=userID and podcast_id not in (select * from suggestion_pod) 
+                                     group by user_par, podcast_id order by priority DESC LIMIT 10);
+               ELSE
+                  insert into suggestion (select user_par, podcast_id, subscription_count, NULL as priority from toplist 
+                  group by user_par, podcast_id order by subscription_count DESC LIMIT 10);
+               END IF;
+               update user set suggestion_up_to_date = 1 where user_ptr_id = user_par;
+            END IF;
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Suggestion are not updated!');
+        END IF;
+
+        DROP TABLE IF EXISTS suggestion_user;
+        DROP TABLE IF EXISTS suggestion_pod;         
+
+END $$
+DELIMITER ;

commit 42b966a16d14127de6c59a7d175f67dfa22b0064
Merge: f7fd2bc... c9421b9...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 28 17:07:14 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit c9421b9ee175d7a169bc44247b92c224cc15ae89
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 28 10:17:45 2009 +0100

    display 50 entries in toplist by default (bug 744)

diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 773d935..87e51d8 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -156,7 +156,7 @@ def account(request):
     }, context_instance=RequestContext(request))
 
 
-def toplist(request, len=30):
+def toplist(request, len=50):
     entries = ToplistEntry.objects.all().order_by('-subscriptions')[:len]
     return render_to_response('toplist.html', {
         'entries': entries,

commit f7fd2bcfe0a1561d484b8eb8bf98ee693f803e0d
Merge: 0327d01... 1e04e7d...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 27 22:48:45 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit bbcb8e749f1f63326af362c9a2f5434063afc83b
Author: Thomas Perl <thp@thpinfo.com>
Date:   Sun Dec 27 18:33:43 2009 +0100

    Fixes for the Simple API (bug 738, 739)
    
    Fix JSON-related problems with the Simple
    API server code and fix the response message.

diff --git a/mygpo/api/httpresponse.py b/mygpo/api/httpresponse.py
index 9d62a34..b9e3d39 100644
--- a/mygpo/api/httpresponse.py
+++ b/mygpo/api/httpresponse.py
@@ -16,15 +16,14 @@
 #
 
 from django.http import HttpResponse
-from django.core.serializers import json, serialize
+from django.core.serializers import serialize
 from django.db.models.query import QuerySet
 from django.core.serializers.json import DjangoJSONEncoder
+
 try:
-    #try to import the JSON module (if we are on Python 2.6)
-    import json
-except ImportError:
-    # No JSON module available - fallback to simplejson (Python < 2.6)
     import simplejson as json
+except ImportError:
+    import json
 
 
 def HttpResponseNotAuthorized():
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index b319dc7..6fa908b 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -19,20 +19,18 @@ from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
 from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from mygpo.api.opml import Exporter, Importer
-from mygpo.api.json import JsonResponse
+from mygpo.api.httpresponse import JsonResponse
 from django.core import serializers
 from datetime import datetime
 from mygpo.api.httpresponse import HttpResponseNotAuthorized
 import re
+
 try:
-    # Try to import the JSON module (if we are on Python 2.6)
-    import json
-except ImportError:
-    # No JSON module available - fallback to simplejson (Python < 2.6)
     import simplejson as json
-    
+except ImportError:
+    import json
 
-@require_valid_user()
+@require_valid_user
 def subscriptions(request, username, device_uid, format):
     
     if request.user.username != username:
@@ -114,5 +112,6 @@ def set_subscriptions(subscriptions):
         s = SubscriptionAction(podcast=p, action=SUBSCRIBE_ACTION, device=d)
         s.save()
 
-    return HttpResponse('Success\n', mimetype='text/plain')
+    # Only an empty response is a successful response
+    return HttpResponse('', mimetype='text/plain')
 

commit 1e04e7dada14764adf6b6f61fd7008f83b3a9403
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 27 13:19:07 2009 +0100

    linking to podcast-pages on toplist

diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
index c644175..485f704 100644
--- a/mygpo/web/templates/toplist.html
+++ b/mygpo/web/templates/toplist.html
@@ -4,7 +4,7 @@
 {% block content %}
   <h1>{% trans "Toplist" %}</h1>
 
-  <p>{% blocktrans %}These are the {{ count }} most subscribed podcasts.{% endblocktrans %}</p>
+  <p>{% blocktrans with entries|length as count %}These are the {{ count }} most subscribed podcasts.{% endblocktrans %}</p>
 
   <table class="list">
    <tr>
@@ -15,7 +15,7 @@
   {% for entry in entries %}
    <tr>
     <td>{{ forloop.counter }}</td>
-    <td>{{ entry.podcast }}</td>
+    <td><a href="/podcast/{{ entry.podcast.id }}">{{ entry.podcast }}</a></td>
     <td class="numeric">{{ entry.subscriptions }}</td>
    </tr>
   {% endfor %}
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 25610ae..773d935 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -156,11 +156,9 @@ def account(request):
     }, context_instance=RequestContext(request))
 
 
-def toplist(request):
-    len = 30
+def toplist(request, len=30):
     entries = ToplistEntry.objects.all().order_by('-subscriptions')[:len]
     return render_to_response('toplist.html', {
-        'count'  : len,
         'entries': entries,
     }, context_instance=RequestContext(request))
 

commit 377af7cdb5b97214d79a128acdd591fefc39e179
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 27 13:15:30 2009 +0100

    subscribing to podcasts through the website
    
    /podcast/<id> for a podcast that the user has not subscribed yet, lets the user
    subscribe the podcast now

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 6819e49..ab6b5be 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -37,7 +37,9 @@ urlpatterns = patterns('',
     (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/', 'form_class': RegistrationFormUniqueEmail}),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
     (r'^activate/(?P<activation_key>\w+)$', activate),
+
     (r'^podcast/(?P<pid>\w+)$', 'mygpo.web.views.podcast'),
+    (r'^podcast/(?P<pid>\w+)/subscribe$', 'mygpo.web.views.podcast_subscribe'),
 
     (r'^episode/(?P<id>\d+)$', 'mygpo.web.views.episode'),
 
diff --git a/mygpo/web/forms.py b/mygpo/web/forms.py
index 6b23e89..c886027 100644
--- a/mygpo/web/forms.py
+++ b/mygpo/web/forms.py
@@ -1,6 +1,7 @@
 from django import forms
 from django.utils.translation import ugettext as _
-from mygpo.api.models import Device, DEVICE_TYPES
+from mygpo.api.models import Device, DEVICE_TYPES, SyncGroup
+import re
 
 class UserAccountForm(forms.Form):
     email = forms.EmailField(label=_('Your Email Address'))
@@ -15,15 +16,9 @@ class DeviceForm(forms.Form):
 class SyncForm(forms.Form):
     targets = forms.CharField()
 
-#    def __init__(self, device=None, *args, **kwargs):
-#        super( SyncForm, self ).__init__(*args, **kwargs)
-#
-#        targets = self.sync_target_choices(device.sync_targets())
-#        self.fields['targets'] = forms.ChoiceField(choices=targets, label=_('Synchronize with the following devices'))
-#
-    def set_device(self, device):
-        targets = self.sync_target_choices(device.sync_targets())
-        self.fields['targets'] = forms.ChoiceField(choices=targets, label=_('Synchronize with the following devices'))
+    def set_targets(self, sync_targets, label=''):
+        targets = self.sync_target_choices(sync_targets)
+        self.fields['targets'] = forms.ChoiceField(choices=targets, label=label)
 
     def sync_target_choices(self, targets):
         """
@@ -36,3 +31,18 @@ class SyncForm(forms.Form):
         """
         return [('%s%s' % ('d' if isinstance(t, Device) else 'g', t.id), t) for t in targets]
 
+
+    def get_target(self):
+        if not self.is_valid():
+            raise ValueError()
+
+        target = self.cleaned_data['targets']
+        m = re.match('^([dg])(\d+)$', target)
+        if m == None:
+            raise ValueError()
+
+        if m.group(1) == 'd':
+            return Device.objects.get(pk=m.group(2))
+        else:
+            return SyncGroup.objects.get(pk=m.group(2))
+
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index 7cad369..1fdb345 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -11,14 +11,24 @@
    <p class="description">{{ podcast.description }}</p>
   {% endif %}
 
-  <h2>Devices</h2>
-  <strong>You have subscribed this podcast on</strong>
-  <ul class="devices">
-  {% for device in devices %}
-   <li class="{{device.type}}"><a href="/device/{{ device.id }}">{{ device.name }}</a></li>
-  {% endfor %}
-  </ul>
-  
+  {% if devices|length_is:"0" %}
+   <a href="/podcast/{{ podcast.id }}/subscribe">
+    {% if podcast.title %}
+     {% blocktrans with podcast.title as podcasttitle %}Subscribe to {{ podcasttitle }}{% endblocktrans %}
+    {% else %}
+     {% trans "Subscribe to this podcast" %}
+    {% endif %}
+   </a>
+  {% else %}
+   <h2>Devices</h2>
+   <strong>You have subscribed this podcast on</strong>
+   <ul class="devices">
+   {% for device in devices %}
+    <li class="{{device.type}}"><a href="/device/{{ device.id }}">{{ device.name }}</a></li>
+   {% endfor %}
+   </ul>
+  {% endif %}
+
   {% if not episodes|length_is:"0" %}
    <h2>{% trans "Episodes" %}</h2>
    <table class="list">
@@ -41,34 +51,34 @@
    </table>
   {% endif %}
 
-  <h2>{% trans "Subscription History" %}</h2>
-  <table class="list">
-	<tr>
-		<th>{% trans "Timestamp" %}</th>
-              <th>{% trans "Action" %}</th>
-		<th>{% trans "Devices" %}</th>
-	</tr>
-       {% for s in history %}
-	<tr>
-		<td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
-		<td>
-		{% ifequal s.action 1 %}
-			{% trans "subscribe" %}
-		{% endifequal %}
-		{% ifequal s.action -1 %}
-			{% trans "unsubscribe" %}
-		{% endifequal %}
-              </td>
-		<td>{{ s.device.name }}</td>
-	</tr>
-       {% endfor %}
-  </table>
-  <br /><br />
+  {% if not history|length_is:"0" %}
+   <h2>{% trans "Subscription History" %}</h2>
+   <table class="list">
+    <tr>
+     <th>{% trans "Timestamp" %}</th>
+     <th>{% trans "Action" %}</th>
+     <th>{% trans "Devices" %}</th>
+    </tr>
+    {% for s in history %}
+     <tr>
+      <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
+      <td>
+       {% ifequal s.action 1 %}
+        {% trans "subscribe" %}
+       {% endifequal %}
+       {% ifequal s.action -1 %}
+        {% trans "unsubscribe" %}
+       {% endifequal %}
+      </td>
+      <td>{{ s.device.name }}</td>
+     </tr>
+    {% endfor %}
+   </table>
+  {% endif %}
 
   {% if not podcast.title %}
    <div class="info"><strong>{% trans "Why Unnamed Podcast?" %}</strong> {% trans "Because we display names after we have fetched the information form the feed -- and this may take some time. Until this is completed, the podcast will simply be called this way." %}</div>
   {% endif %}
 
-  <a href="/">{% trans "back!" %}</a> 
 {% endblock %}
 
diff --git a/mygpo/web/templates/subscribe.html b/mygpo/web/templates/subscribe.html
new file mode 100644
index 0000000..1c81092
--- /dev/null
+++ b/mygpo/web/templates/subscribe.html
@@ -0,0 +1,28 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>
+   {% if podcast.title %}
+    {% blocktrans with podcast.title as podcasttitle %}Subscribe to {{podcasttitle }}{% endblocktrans %}
+   {% else %}
+    {% trans "Subscribe to this podcast" %}
+   {% endif %}
+  </h1>
+  <a href="{{ podcast.url }}" class="URL">{{ podcast.url }}</a>
+
+  {% if podcast.description %}
+   <p class="description">{{ podcast.description }}</p>
+  {% endif %}
+
+  <form action="" method="post">
+   {{ form.as_p }}
+   <input type="submit" label="{% trans "OK" %}" />
+  </form>
+
+  {% if not podcast.title %}
+   <div class="info"><strong>{% trans "Why Unnamed Podcast?" %}</strong> {% trans "Because we display names after we have fetched the information form the feed -- and this may take some time. Until this is completed, the podcast will simply be called this way." %}</div>
+  {% endif %}
+
+{% endblock %}
+
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 792932b..25610ae 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -19,7 +19,7 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect, HttpResponse, HttpResponseBadRequest, HttpResponseNotAllowed
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
-from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry, Rating, SyncGroup
+from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry, Rating, SyncGroup, SUBSCRIBE_ACTION
 from mygpo.web.forms import UserAccountForm, DeviceForm, SyncForm
 from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
@@ -43,7 +43,12 @@ def home(request):
               })
 
 def create_subscriptionlist(request):
+    #sync all devices first
+    for d in Device.objects.filter(user=request.user):
+        d.sync()
+
     subscriptions = Subscription.objects.filter(user=request.user)
+
     l = {}
     for s in subscriptions:
         if s.podcast in l:
@@ -71,6 +76,38 @@ def podcast(request, pid):
         'episodes': episodes,
     }, context_instance=RequestContext(request))
 
+@login_required
+def podcast_subscribe(request, pid):
+    podcast = Podcast.objects.get(pk=pid)
+
+    if request.method == 'POST':
+        form = SyncForm(request.POST)
+
+        target = form.get_target()
+
+        if isinstance(target, SyncGroup):
+            device = target.devices()[0]
+        else:
+            device = target
+
+        SubscriptionAction.objects.create(podcast=podcast, device=device, action=SUBSCRIBE_ACTION)
+
+        return HttpResponseRedirect('/podcast/%s' % podcast.id)
+
+    else:
+        targets = list(Device.objects.filter(user=request.user, sync_group=None))
+        groups = SyncGroup.objects.filter(user=request.user)
+        targets.extend( list(groups) )
+
+        form = SyncForm()
+        form.set_targets(targets, _('With which client do you want to subscribe?'))
+
+        return render_to_response('subscribe.html', {
+            'podcast': podcast,
+            'form': form
+        }, context_instance=RequestContext(request))
+
+
 def episode_list(podcast, user):
     list = {}
     episodes = Episode.objects.filter(podcast=podcast).order_by('-timestamp')
@@ -170,7 +207,7 @@ def device(request, device_id):
     if device in synced_with: synced_with.remove(device)
     success = False
     sync_form = SyncForm()
-    sync_form.set_device(device)
+    sync_form.set_targets(device.sync_targets(), _('Synchronize with the following devices'))
 
     if request.method == 'POST':
         device_form = DeviceForm(request.POST)
@@ -210,16 +247,7 @@ def device_sync(request, device_id):
     if not form.is_valid():
         return HttpResponseBadRequest('invalid')
 
-    target = form.cleaned_data['targets']
-
-    m = re.match('^([dg])(\d+)$', target)
-    if m == None:
-        return HttpResponseBadRequest()
-
-    if m.group(1) == 'd':
-        target = Device.objects.get(pk=m.group(2))
-    else:
-        target = SyncGroup.objects.get(pk=m.group(2))
+    target = form.get_target()
 
     device = Device.objects.get(pk=device_id)
 

commit 719057a0581236cbd3fe9e8bcc584abdb1235cbc
Merge: 54b4d2c... c02c32f...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 27 11:43:39 2009 +0100

    Merge branch 'master' of dgpo:~thp/mygpo-src

commit c02c32f8983385524c21a7f6c224f1790e9da5c0
Author: Thomas Perl <thp@thpinfo.com>
Date:   Sun Dec 27 03:31:53 2009 +0100

    Add favicon.ico and robots.txt

diff --git a/htdocs/favicon.ico b/htdocs/favicon.ico
new file mode 100644
index 0000000..9f78c94
Binary files /dev/null and b/htdocs/favicon.ico differ
diff --git a/htdocs/robots.txt b/htdocs/robots.txt
new file mode 100644
index 0000000..e69de29

commit 54b4d2cd9944b95c061b26416daa0c358ce418e9
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 20:00:04 2009 +0100

    add @login_required decorators to sync-views

diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 79c89ab..792932b 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -162,6 +162,7 @@ def suggestions_opml(request, count):
 
     return HttpResponse(opml, mimetype='text/xml')
 
+@login_required
 def device(request, device_id):
     device = Device.objects.get(pk=device_id)
     subscriptions = device.get_subscriptions()
@@ -199,6 +200,7 @@ def device(request, device_id):
     }, context_instance=RequestContext(request))
 
 
+@login_required
 def device_sync(request, device_id):
 
     if request.method != 'POST':
@@ -225,7 +227,7 @@ def device_sync(request, device_id):
 
     return HttpResponseRedirect('/device/%s' % device_id)
 
-
+@login_required
 def device_unsync(request, device_id):
     if request.method != 'GET':
         return HttpResponseNotAllowed(['GET'])

commit 847fc6c000e7e48a85499539c2c14ce4f2dd5899
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 19:08:36 2009 +0100

    add model SubscriptionMeta (bug 733)

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 64f8df6..3196d80 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -319,11 +319,31 @@ class Subscription(models.Model):
     def __unicode__(self):
         return '%s - %s on %s' % (self.device.user, self.podcast, self.device)
 
+    def get_meta(self):
+        #this is different than get_or_create because it does not necessarily create a new meta-object
+        try:
+            return SubscriptionMeta.objects.get(user=self.user, podcast=self.podcast)
+        except SubscriptionMeta.DoesNotExist:
+            return SubscriptionMeta(user=self.user, podcast=self.podcast)
+
     class Meta:
         db_table = 'current_subscription'
         #not available in Django 1.0 (Debian stable)
         #managed = False
 
+
+class SubscriptionMeta(models.Model):
+    user = models.ForeignKey(User)
+    podcast = models.ForeignKey(Podcast)
+    public = models.BooleanField(default=True)
+
+    def __unicode__(self):
+        return '%s - %s - %s' % (self.user, self.podcast, self.public)
+
+    class Meta:
+        db_table = 'subscription'
+
+
 class SubscriptionAction(models.Model):
     device = models.ForeignKey(Device)
     podcast = models.ForeignKey(Podcast)

commit df81f8fe65e63e9e8bca669bcce884260d6f90f9
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 18:53:58 2009 +0100

    devices can now be synchronized on the website
    
    On /device/<id> the user can now sync a device with others, and remove the
    device from existing synchronisations

diff --git a/install/update-09.sql b/install/update-09.sql
new file mode 100644
index 0000000..0bc89ab
--- /dev/null
+++ b/install/update-09.sql
@@ -0,0 +1,8 @@
+DROP VIEW IF EXISTS current_subscription;
+
+CREATE VIEW current_subscription AS SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since, sum(a.action) as summe
+    FROM (subscription_log a JOIN device b on a.device_id=b.id)
+        JOIN user c on b.user_id=c.user_ptr_id
+    GROUP BY a.podcast_id, device_id
+    having summe>0;
+
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 53db5e3..64f8df6 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -18,6 +18,7 @@
 from django.db import models
 from django.contrib.auth.models import User, UserManager
 from datetime import datetime
+from django.utils.translation import ugettext as _
 import hashlib
 
 EPISODE_ACTION_TYPES = (
@@ -131,7 +132,7 @@ class SyncGroup(models.Model):
 
     def __unicode__(self):
         devices = [d.name for d in Device.objects.filter(sync_group=self)]
-        return '%s - %s' % (self.user, ', '.join(devices))
+        return ', '.join(devices)
 
     def devices(self):
         return Device.objects.filter(sync_group=self)
@@ -156,10 +157,10 @@ class Device(models.Model):
     sync_group = models.ForeignKey(SyncGroup, blank=True, null=True)
 
     def __unicode__(self):
-        return '%s - %s (%s)' % (self.user, self.name, self.type)
+        return self.name if self.name else _('Unnamed Device (%s)' % self.uid)
 
     def get_subscriptions(self):
-        #self.sync()
+        self.sync()
         return Subscription.objects.filter(device=self)
 
     def sync(self):
@@ -196,18 +197,18 @@ class Device(models.Model):
             a = d.latest_actions()
             for s in a.keys():
                 if not sync_actions.has_key(s):
-		    if a[s].action == SUBSCRIBE_ACTION:
-			sync_actions[s] = a[s]
-		elif a[s].newer_than(sync_actions[s]) and (sync_actions[s].action != a[s].action):
+                    if a[s].action == SUBSCRIBE_ACTION:
                         sync_actions[s] = a[s]
+                elif a[s].newer_than(sync_actions[s]) and (sync_actions[s].action != a[s].action):
+                    sync_actions[s] = a[s]
 
-	#remove actions that did not change
-	current_state = self.latest_actions()
-	for podcast in current_state.keys():
-	    if sync_actions[podcast] == current_state[podcast]:
-		del sync_actions[podcast]
+        #remove actions that did not change
+        current_state = self.latest_actions()
+        for podcast in current_state.keys():
+            if sync_actions[podcast] == current_state[podcast]:
+               del sync_actions[podcast]
 
-        return sync_actions
+        return sync_actions.values()
 
     def latest_actions(self):
         """
@@ -279,6 +280,7 @@ class Device(models.Model):
             raise ValueError('the device is not synced')
 
         g = self.sync_group
+        print g
         self.sync_group = None
         self.save()
 
@@ -287,8 +289,7 @@ class Device(models.Model):
             d = devices[0]
             d.sync_group = None
             d.save()
-
-        g.delete()
+            g.delete()
 
     class Meta:
         db_table = 'device'
@@ -334,7 +335,7 @@ class SubscriptionAction(models.Model):
 
     def newer_than(self, action):
         if (self.timestamp == action.timestamp): return self.id > action.id
-	return self.timestamp > action.timestamp
+        return self.timestamp > action.timestamp
 
     def __unicode__(self):
         return '%s %s %s %s' % (self.device.user, self.device, self.action_string(), self.podcast)
diff --git a/mygpo/urls.py b/mygpo/urls.py
index c3085c8..6819e49 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -52,6 +52,8 @@ urlpatterns = patterns('',
     (r'^suggestions/(?P<count>\d+).opml$', 'mygpo.web.views.suggestions_opml'),
 
     (r'^device/(?P<device_id>\d+)$', 'mygpo.web.views.device'),
+    (r'^device/(?P<device_id>\d+)/sync$', 'mygpo.web.views.device_sync'),
+    (r'^device/(?P<device_id>\d+)/unsync$', 'mygpo.web.views.device_unsync'),
 
     #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),
diff --git a/mygpo/web/forms.py b/mygpo/web/forms.py
index bfbc50b..6b23e89 100644
--- a/mygpo/web/forms.py
+++ b/mygpo/web/forms.py
@@ -1,6 +1,6 @@
 from django import forms
 from django.utils.translation import ugettext as _
-from mygpo.api.models import DEVICE_TYPES
+from mygpo.api.models import Device, DEVICE_TYPES
 
 class UserAccountForm(forms.Form):
     email = forms.EmailField(label=_('Your Email Address'))
@@ -11,3 +11,28 @@ class DeviceForm(forms.Form):
     type = forms.ChoiceField(choices=DEVICE_TYPES, label=_('What kind of device is this?'))
     uid = forms.CharField(max_length=50, label=_('What UID is configured on the pysical device?'))
 
+
+class SyncForm(forms.Form):
+    targets = forms.CharField()
+
+#    def __init__(self, device=None, *args, **kwargs):
+#        super( SyncForm, self ).__init__(*args, **kwargs)
+#
+#        targets = self.sync_target_choices(device.sync_targets())
+#        self.fields['targets'] = forms.ChoiceField(choices=targets, label=_('Synchronize with the following devices'))
+#
+    def set_device(self, device):
+        targets = self.sync_target_choices(device.sync_targets())
+        self.fields['targets'] = forms.ChoiceField(choices=targets, label=_('Synchronize with the following devices'))
+
+    def sync_target_choices(self, targets):
+        """
+        returns a list of tuples that can be used as choices for a ChoiceField.
+        the first item in each tuple is a letter identifying the type of the 
+        sync-target - either d for a Device, or g for a SyncGroup. This letter
+        is followed by the id of the target.
+        The second item in each tuple is the string-representation of the #
+        target.
+        """
+        return [('%s%s' % ('d' if isinstance(t, Device) else 'g', t.id), t) for t in targets]
+
diff --git a/mygpo/web/templates/device.html b/mygpo/web/templates/device.html
index af867f7..53528e5 100644
--- a/mygpo/web/templates/device.html
+++ b/mygpo/web/templates/device.html
@@ -1,6 +1,7 @@
 {% extends "base.html" %}
 {% load i18n %}
 {% load humanize %}
+{% load devices %}
 
 {% block content %}
   <h1>{{ device.name }}</h1>
@@ -23,13 +24,34 @@
    {% endfor %}
   </table>
 
+  <h2>Synchronize</h2>
+  <p>{% blocktrans %}If you synchronize devices, they will always have the same subscriptions. A podcast that is subscribed on one device, will automatically be added to all synchronized devices.{% endblocktrans %}</p>
+
+  {% if synced_with|length_is:"0" %}
+
+   <p>{% blocktrans with device.name as devicename %}{{ devicename }} is currently not synchronized with other devices.{% endblocktrans %}</p>
+
+  {% else %}
+
+   <p>{% blocktrans with device.name as devicename and synced_with|device_list as synclist %}{{ devicename }} is currently synchronized with {{ synclist }}.{% endblocktrans %}</p>
+   <a href="/device/{{ device.id }}/unsync">{% blocktrans with device.name as devicename %}Stop synchronisation for {{ devicename }} {% endblocktrans %}</a>
+  
+  {% endif %}
+
+  {% if has_sync_targets %}
+   <form action="/device/{{ device.id }}/sync" method="POST">
+    {{ sync_form.as_p }}
+    <input type="submit" value="{% trans "OK" %}" />
+   </form>
+  {% endif %}
+
   <h2>Edit</h2>
   {% if success %}
    <div class="success">{% trans "Your settings have been saved." %}</div>
   {% endif %}
 
   <form action="" method="POST">
-   {{ form.as_p }}
+   {{ device_form.as_p }}
    <input type="submit" value="Save" />
   </form>
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index a760733..79c89ab 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -16,16 +16,17 @@
 #
 
 from django.shortcuts import render_to_response
-from django.http import HttpResponseRedirect, HttpResponse
+from django.http import HttpResponseRedirect, HttpResponse, HttpResponseBadRequest, HttpResponseNotAllowed
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
-from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry, Rating
-from mygpo.web.forms import UserAccountForm, DeviceForm
+from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry, Rating, SyncGroup
+from mygpo.web.forms import UserAccountForm, DeviceForm, SyncForm
 from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
 from mygpo.api.basic_auth import require_valid_user
 from django.contrib.auth.decorators import login_required
 from datetime import datetime
+import re
 
 def home(request):
        if request.user.is_authenticated():
@@ -163,21 +164,25 @@ def suggestions_opml(request, count):
 
 def device(request, device_id):
     device = Device.objects.get(pk=device_id)
-    subscriptions = Subscription.objects.filter(device=device)
+    subscriptions = device.get_subscriptions()
+    synced_with = list(device.sync_group.devices()) if device.sync_group else []
+    if device in synced_with: synced_with.remove(device)
     success = False
+    sync_form = SyncForm()
+    sync_form.set_device(device)
 
     if request.method == 'POST':
-        form = DeviceForm(request.POST)
+        device_form = DeviceForm(request.POST)
 
-        if form.is_valid():
-            device.name = form.cleaned_data['name']
-            device.type = form.cleaned_data['type']
-            device.uid  = form.cleaned_data['uid']
+        if device_form.is_valid():
+            device.name = device_form.cleaned_data['name']
+            device.type = device_form.cleaned_data['type']
+            device.uid  = device_form.cleaned_data['uid']
             device.save()
             success = True
 
     else:
-        form = DeviceForm({
+        device_form = DeviceForm({
             'name': device.name,
             'type': device.type,
             'uid' : device.uid
@@ -185,9 +190,48 @@ def device(request, device_id):
 
     return render_to_response('device.html', {
         'device': device,
-        'form': form,
+        'device_form': device_form,
+        'sync_form': sync_form,
         'success': success,
         'subscriptions': subscriptions,
+        'synced_with': synced_with,
+        'has_sync_targets': len(device.sync_targets()) > 0
     }, context_instance=RequestContext(request))
 
 
+def device_sync(request, device_id):
+
+    if request.method != 'POST':
+        return HttpResponseNotAllowed(['POST'])
+        
+    form = SyncForm(request.POST)
+    if not form.is_valid():
+        return HttpResponseBadRequest('invalid')
+
+    target = form.cleaned_data['targets']
+
+    m = re.match('^([dg])(\d+)$', target)
+    if m == None:
+        return HttpResponseBadRequest()
+
+    if m.group(1) == 'd':
+        target = Device.objects.get(pk=m.group(2))
+    else:
+        target = SyncGroup.objects.get(pk=m.group(2))
+
+    device = Device.objects.get(pk=device_id)
+
+    device.sync_with(target)
+
+    return HttpResponseRedirect('/device/%s' % device_id)
+
+
+def device_unsync(request, device_id):
+    if request.method != 'GET':
+        return HttpResponseNotAllowed(['GET'])
+
+    device = Device.objects.get(pk=device_id)
+    device.unsync()
+
+    return HttpResponseRedirect('/device/%s' % device_id)
+

commit 5bd94723c698f9fb1024287f11596f55babe5d2d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 18:53:02 2009 +0100

    fix exception when creating device through api-put

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 939c7e0..0e39a94 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -62,7 +62,7 @@ def subscriptions(request, username, device_uid):
         return JsonResponse(changes)
 
     elif request.method == 'POST':
-        d, created = Device.objects.get_or_create(user=request.user, uid=device_uid)
+        d, created = Device.objects.get_or_create(user=request.user, uid=device_uid, defaults = {'type': 'other', 'name': 'New Device'})
 
         actions = json.loads(request.POST['data'])
         add = actions['add'] if 'add' in actions else []

commit 6e6a0922e13f624d91035abfd6dd794763263b31
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 16:33:46 2009 +0100

    changed table-headings for subscription list

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index 991234b..b4c41f6 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -10,9 +10,9 @@
  <table class="list">
   <tr>
    <th>&nbsp;</th>
-   <th>{% trans "Title" %}</th>
+   <th>{% trans "Podcast" %}</th>
    <th>{% trans "Latest Episode" %}</th>
-   <th>{% trans "Devices" %}</th>
+   <th>{% trans "Subscribed on" %}</th>
   </tr>
   
   {% for s in subscriptionlist %}

commit 9f6d54764f258528ccb6cc3618a239fa2ae1ab52
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 16:32:09 2009 +0100

    linking device-pages on user-home
    
    added template filter device_list(devices) that returns a html-representation
    of a list of devices

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index 0d123ca..991234b 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -1,5 +1,6 @@
 {% extends "base.html" %}
 {% load i18n %}
+{% load devices %}
 
 {% block content %}
  <h1>{% trans "my.gpodder.org" %}
@@ -27,7 +28,7 @@
     {% else %}
      <td></td>
     {% endif %}
-    <td>{{ s.devices|join:", " }}</td>
+    <td>{{ s.devices|device_list }}</td>
    </tr>
   {% endfor %}
   </table>
diff --git a/mygpo/web/templatetags/devices.py b/mygpo/web/templatetags/devices.py
index 76588e8..242e7a8 100644
--- a/mygpo/web/templatetags/devices.py
+++ b/mygpo/web/templatetags/devices.py
@@ -20,3 +20,7 @@ def device_icon(device,size=16):
 
     return mark_safe(s)
 
+@register.filter
+def device_list(devices):
+    return mark_safe(', '.join([ '<a href="/device/%s" />%s %s</a>' % (d.id, device_icon(d), d.name) for d in devices]))
+        
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 1f3ce7f..a760733 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -46,11 +46,11 @@ def create_subscriptionlist(request):
     l = {}
     for s in subscriptions:
         if s.podcast in l:
-            l[s.podcast]['devices'].append(s.device.name)
+            l[s.podcast]['devices'].append(s.device)
         else:
             e = Episode.objects.filter(podcast=s.podcast).order_by('-timestamp')
             episode = e[0] if e.count() > 0 else None
-            devices = [s.device.name]
+            devices = [s.device]
             l[s.podcast] = {'podcast': s.podcast, 'episode': episode, 'devices': devices}
 
     return l.values()

commit 2dffc96399e304e063f9c9d0da5a518e400c411d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 13:07:03 2009 +0100

    added tests for the advanced api
    
    * listing devices
    * renaming devices
    * adding and removing subscriptions

diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index f38d71e..df1a891 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -16,13 +16,24 @@
 #
 
 from django.test import TestCase
+from django.test.client import Client
 from django.contrib.auth.models import User
 from mygpo.api.models import Device, Podcast, SubscriptionAction, UserProfile
 from put_test import put_data
 from django.http import HttpRequest
 from mygpo.api.simple import subscriptions
+from mygpo.api.advanced import devices
 import time
 
+try:
+    #try to import the JSON module (if we are on Python 2.6)
+    import json
+except ImportError:
+    # No JSON module available - fallback to simplejson (Python < 2.6)
+    print "No JSON module available - fallback to simplejson (Python < 2.6)"
+    import simplejson as json
+
+
 class SyncTest(TestCase):
     def test_sync_actions(self):
         # this test does not yet complete when run as a unit test
@@ -75,6 +86,79 @@ class SyncTest(TestCase):
         self.assertEqual( sa2[p1].podcast, p1)
         self.assertEqual( sa2[p1].action, 1)
 
+class AdvancedAPITest(TestCase):
+    def setUp(self):
+        self.user = User.objects.create(username='adv', email='adv@mygpo')
+        self.user.set_password('adv1')
+        self.user.save()
+        self.device1 = Device.objects.create(user=self.user, name='d1', uid='uid1', type='desktop')
+        self.device2 = Device.objects.create(user=self.user, name='d2', uid='uid2', type='mobile')
+        self.client = Client()
+        l = self.client.login(username='adv', password='adv1')
+        self.assertEqual(l, True)
+
+    def test_device_list(self):
+        response = self.client.get('/api/1/devices/%s.json' % self.user.username)
+        json_list = response.content
+        list = json.loads(json_list)
+
+        self.assertEqual(response.status_code, 200)
+        self.assertEqual(len(list), 2)
+        self.assertEqual(list[0], {u'id': u'uid1', u'caption': u'd1', u'type': u'desktop', u'subscriptions': 0})
+        self.assertEqual(list[1], {u'id': u'uid2', u'caption': u'd2', u'type': u'mobile',  u'subscriptions': 0})
+
+    def test_rename_device(self):
+        req = {'caption': 'd2!', 'type': 'server'}
+        reqs = json.dumps(req)
+
+        self.client.post('/api/1/devices/%s/%s.json' % (self.user.username, self.device2.uid), data={'data': reqs})
+
+        response = self.client.get('/api/1/devices/%s.json' % self.user.username)
+        json_list = response.content
+        list = json.loads(json_list)
+        self.assertEqual(response.status_code, 200)
+        self.assertEqual(len(list), 2)
+        self.assertEqual(list[0], {u'id': u'uid1', u'caption': u'd1',  u'type': u'desktop', u'subscriptions': 0})
+        self.assertEqual(list[1], {u'id': u'uid2', u'caption': u'd2!', u'type': u'server',  u'subscriptions': 0})
+
+
+    def test_add_remove_subscriptions(self):
+        req = {"add": ["http://example.com/feed.rss", "http://example.org/podcast.php", "http://example.net/foo.xml"]}
+        reqs = json.dumps(req)
+
+        #adding 3 subscriptions
+        response = self.client.post('/api/1/subscriptions/%s/%s.json' % (self.user.username, self.device1.uid), data={'data': reqs})
+        self.assertEqual(response.status_code, 200)
+        
+        resp = json.loads(response.content)
+        add_timestamp = resp['timestamp']
+
+        #qerying subscription changes
+        response = self.client.get('/api/1/subscriptions/%s/%s.json' % (self.user.username, self.device1.uid), {'since': add_timestamp-1})
+        changes = json.loads(response.content)
+
+        self.assertEqual(changes['add'], ["http://example.com/feed.rss", "http://example.org/podcast.php", "http://example.net/foo.xml"])
+        self.assertEqual(len(changes['remove']), 0)
+
+        #removing the 1st and 3rd subscription
+        req = {"add": [], 'remove': ["http://example.com/feed.rss","http://example.net/foo.xml"]}
+        reqs = json.dumps(req)
+        time.sleep(1)
+        response = self.client.post('/api/1/subscriptions/%s/%s.json' % (self.user.username, self.device1.uid), data={'data': reqs})
+        self.assertEqual(response.status_code, 200)
+
+        resp = json.loads(response.content)
+        timestamp = resp['timestamp']
+
+        #changes since beginning, should return 1 addition, 2 removals
+        response = self.client.get('/api/1/subscriptions/%s/%s.json' % (self.user.username, self.device1.uid), {'since': add_timestamp-1})
+        changes = json.loads(response.content)
+        self.assertEqual(changes['add'], ["http://example.org/podcast.php"])
+        self.assertEqual(changes['remove'], ["http://example.com/feed.rss","http://example.net/foo.xml"])
+
+        #changes including removal
+
+
 class SimpleTest(TestCase):
     def test_put_get_data(self):
         p1 = 'http://www.podcast1.com'

commit 19d2a3eb71b72d03e832e2788be3097ee4e95113
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 13:06:20 2009 +0100

    fix timestamp-boundaries for action queries

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 4c28226..939c7e0 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -98,7 +98,7 @@ def update_subscriptions(user, device, add, remove):
 
 def get_subscription_changes(user, device, since, until):
     actions = {}
-    for a in SubscriptionAction.objects.filter(device=device, timestamp__gt=since, timestamp__lt=until).order_by('timestamp'):
+    for a in SubscriptionAction.objects.filter(device=device, timestamp__gt=since, timestamp__lte=until).order_by('timestamp'):
         #ordered by ascending date; newer entries overwriter older ones
         actions[a.podcast] = a
 
@@ -151,7 +151,7 @@ def episodes(request, username):
 
 def get_episode_changes(user, podcast, device, since, until):
     actions = []
-    for a in EpisodeAction.objects.filter(user=user, podcast=podcast, device=device, timestamp__gt=since, timestamp__lt=until):
+    for a in EpisodeAction.objects.filter(user=user, podcast=podcast, device=device, timestamp__gt=since, timestamp__lte=until):
         action = {
             'podcast': a.episode.podcast.url,
             'episode': a.episode.url,

commit 6aa63d0bd8f16e1d735c9facef5f0816dc6b2bce
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 26 13:05:13 2009 +0100

    reflecting recent refactorings in simple api
    
    moved code from mygpo.api.json into mygpo.api.httpresponse
    refactored decorator require_valid_user

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index b319dc7..24214b6 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -19,7 +19,7 @@ from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
 from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from mygpo.api.opml import Exporter, Importer
-from mygpo.api.json import JsonResponse
+from mygpo.api.httpresponse import JsonResponse
 from django.core import serializers
 from datetime import datetime
 from mygpo.api.httpresponse import HttpResponseNotAuthorized
@@ -32,7 +32,7 @@ except ImportError:
     import simplejson as json
     
 
-@require_valid_user()
+@require_valid_user
 def subscriptions(request, username, device_uid, format):
     
     if request.user.username != username:

commit 32cf54d0bd2072c7a7199e35b1d371f4b9dd2b49
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Dec 25 10:29:10 2009 +0100

    typo

diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
index 374477f..c644175 100644
--- a/mygpo/web/templates/toplist.html
+++ b/mygpo/web/templates/toplist.html
@@ -4,7 +4,7 @@
 {% block content %}
   <h1>{% trans "Toplist" %}</h1>
 
-  <p>{% blocktrans %}These are the {{ count }} most susbscribed podcasts.{% endblocktrans %}</p>
+  <p>{% blocktrans %}These are the {{ count }} most subscribed podcasts.{% endblocktrans %}</p>
 
   <table class="list">
    <tr>

commit d240fe09db2abdd4b6733a150e9bac2af7ea121e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Dec 25 09:53:41 2009 +0100

    appying correct styles to toplist

diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
index ae2ac9e..374477f 100644
--- a/mygpo/web/templates/toplist.html
+++ b/mygpo/web/templates/toplist.html
@@ -6,7 +6,7 @@
 
   <p>{% blocktrans %}These are the {{ count }} most susbscribed podcasts.{% endblocktrans %}</p>
 
-  <table>
+  <table class="list">
    <tr>
     <th>{% trans "#" %}</th>
     <th>{% trans "Podcast" %}</th>
@@ -16,7 +16,7 @@
    <tr>
     <td>{{ forloop.counter }}</td>
     <td>{{ entry.podcast }}</td>
-    <td>{{ entry.subscriptions }}</td>
+    <td class="numeric">{{ entry.subscriptions }}</td>
    </tr>
   {% endfor %}
   </table>

commit 2c26281d94fa8396fc723d9223a9e3c85d0b73e4
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Dec 24 15:57:14 2009 +0100

    fix device icon for mobile devices

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 7464491..30a510a 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -122,7 +122,7 @@ ul.devices li.laptop
 
 ul.devices li.mobile
 {
-    list-style-image: url('16x16/pda.png');
+    list-style-image: url('16x16/multimedia-player.png');
 }
 
 ul.devices li.server

commit 85ce6e2237606d2eed55e78b1f14c2d58bc352cb
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Dec 24 15:55:56 2009 +0100

    add template filter devices.device_icon

diff --git a/mygpo/web/templatetags/devices.py b/mygpo/web/templatetags/devices.py
new file mode 100644
index 0000000..76588e8
--- /dev/null
+++ b/mygpo/web/templatetags/devices.py
@@ -0,0 +1,22 @@
+from django import template
+from django.utils.safestring import mark_safe
+from django.utils.translation import ugettext as _
+import hashlib
+
+register = template.Library()
+
+@register.filter
+def device_icon(device,size=16):
+    if device.type == 'desktop':
+        s = '<img src="/media/%sx%s/computer.png" alt="%s" />' % (size, size, _('Desktop'))
+    elif device.type == 'laptop':
+        s = '<img src="/media/%sx%s/pda.png" alt="%s" />' % (size, size, _('Laptop'))
+    elif device.type == 'mobile':
+        s = '<img src="/media/%sx%s/multimedia-player.png" alt="%s" />' % (size, size, _('Mobile'))
+    elif device.type == 'server':
+        s = '<img src="/media/%sx%s/server.png" alt="%s" />' % (size, size, _('Server'))
+    else:
+        s = '<img src="/media/%sx%s/audio-x-generic.png" alt="%s" />' % (size, size, _('Other'))
+
+    return mark_safe(s)
+

commit dba183e5f31aecb2c631eb5cdac64d075845d095
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Dec 24 13:42:05 2009 +0100

    add template filter podcasts.podcast_logo (bug 711)

diff --git a/mygpo/web/templatetags/podcasts.py b/mygpo/web/templatetags/podcasts.py
new file mode 100644
index 0000000..5c226d1
--- /dev/null
+++ b/mygpo/web/templatetags/podcasts.py
@@ -0,0 +1,17 @@
+from django import template
+from django.utils.safestring import mark_safe
+from django.utils.translation import ugettext as _
+import hashlib
+
+register = template.Library()
+
+@register.filter
+def podcast_logo(podcast):
+    if podcast.logo_url:
+        sha = hashlib.sha1(podcast.logo_url).hexdigest()
+        s = '<img src="/media/logo/%s" alt="%s" />' % (sha, _('Logo'))
+    else:
+        s = '<img src="/media/logo/default.png" alt="%s" />' % _('No Logo available')
+
+    return mark_safe(s)
+

commit 0c73a54dcc59c4054baf8c850215e1717fa58589
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Dec 24 13:33:07 2009 +0100

    add template filter episodes.episode_status_icon

diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index f17b27b..7cad369 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -1,6 +1,7 @@
 {% extends "base.html" %}
 {% load i18n %}
 {% load humanize %}
+{% load episodes %}
 
 {% block content %}
   <h1>{% if podcast.title %}{{ podcast.title }}{% else %}{% trans "Unnamed Podcast" %}{%endif%}</h1>
@@ -30,27 +31,7 @@
  
     {% for episode, action in episodes.items %}
      <tr>
-      <td>
-       {% if not action %} 
-        <img src="/media/16x16/emblem-new.png" alt="new" />
-       {% endif %}
-
-       {% ifequal action.action "new" %}
-        <img src="/media/16x16/emblem-new.png" alt="new" />
-       {% endifequal %}
-
-       {% ifequal action.action "download" %}
-        <img src="/media/16x16/folder.png" alt="downloaded" />
-       {% endifequal %}
-
-       {% ifequal action.action "play" %}
-        <img src="/media/16x16/media-playback-start.png" alt="played" />
-       {% endifequal %}
-
-       {% ifequal action.action "delete" %}
-        <img src="/media/16x16/user-trash-full.png" alt="deleted" />
-       {% endifequal %}
-      </td>
+      <td>{{ action|episode_status_icon }}</td>
       <td><a href="/episode/{{ episode.id }}">{{ episode.title|default:"Unknown Episode" }}</a></td>
       <td class="description">{{ episode.description|default:"" }}</td>
       <td>{{ episode.timestamp|default:""|naturalday }}</td>
diff --git a/mygpo/web/templatetags/__init__.py b/mygpo/web/templatetags/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/mygpo/web/templatetags/episodes.py b/mygpo/web/templatetags/episodes.py
new file mode 100644
index 0000000..06c44c3
--- /dev/null
+++ b/mygpo/web/templatetags/episodes.py
@@ -0,0 +1,28 @@
+from django import template
+from django.utils.safestring import mark_safe
+from django.utils.translation import ugettext as _
+
+register = template.Library()
+
+@register.filter
+def episode_status_icon(action):
+    if not action or not action.action:
+        s = '<img src="/media/16x16/emblem-new.png" alt="new" title="%s" />' % _('This episode has not yet been played')
+
+    else:
+        date_string   = (_(' on %s') % (action.timestamp)) if action.timestamp else ''
+        device_string = (_(' on %s') % (action.device.name)) if action.device else ''
+
+        if action.action == 'new':
+            s = '<img src="/media/16x16/emblem-new.png" alt="new" title="%s" />' % (_('This episode has been marked new%s%s') % (date_string, device_string))
+        elif action.action == 'download':
+            s = '<img src="/media/16x16/folder.png" alt="downloaded" title="%s" />' % (_('This episode has been downloaded%s%s') % (date_string, device_string))
+        elif action.action == 'play':
+            s = '<img src="/media/16x16/media-playback-start.png" alt="played" title="%s" />' % (_('This episode has been played%s%s') % (date_string, device_string))
+        elif action.action == 'delete':
+            s = '<img src="/media/16x16/user-trash-full.png" alt="deleted" title="%s"/>' %s (_('This episode has been deleted%s%s') % (date_string, device_string))
+        else:
+            return action.action #this is not marked safe by intention
+
+    return mark_safe(s)
+

commit b95de087f7d71f8a6466db621f20c5c4d982b18b
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 15:55:12 2009 +0100

    showing latest episode in subscription list

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index f7d3dd2..0d123ca 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -23,7 +23,7 @@
     </td>
     <td><a class="listlink" href="/podcast/{{ s.podcast.id }}">{{ s.podcast }}</a></td>
     {% if s.episode %}
-     <td>{{ s.episode }}</td>
+     <td><a href="/episode/{{s.episode.id}}">{{ s.episode.title|default:"Unnamed Episode" }}</a></td>
     {% else %}
      <td></td>
     {% endif %}

commit b7ded2f223c08d4874bca26ea801f3289c670db8
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 15:48:41 2009 +0100

    showing a intro-text for new users (w/o subscriptions)

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index 1c669de..f7d3dd2 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -2,31 +2,40 @@
 {% load i18n %}
 
 {% block content %}
-  <h1>{% trans "my.gpodder.org" %}
-  <h2>{% trans "Your Subscriptions" %}</h2>
-  <table class="list">
-	<tr>
-		<th>&nbsp;</th>
-		<th>{% trans "Title" %}</th>
-		<th>{% trans "Latest Episode" %}</th>
-		<th>{% trans "Devices" %}</th>
-	</tr>
-       {% for s in subscriptionlist %}
-	<tr>
-		<td> 
-                  {% if s.podcast.logo_url %}
-                  <img src="{{ s.podcast.logo_url }}" style="width:40px; height:30px;" />
-                  {% endif %}                  
-              </td>
-		<td style="font-weight:bold"><a class="listlink" href="/podcast/{{ s.podcast.id }}">{{ s.podcast }}</a></td>
+ <h1>{% trans "my.gpodder.org" %}
+
+ {% if not subscriptionlist|length_is:"0" %}
+ <h2>{% trans "Your Subscriptions" %}</h2>
+ <table class="list">
+  <tr>
+   <th>&nbsp;</th>
+   <th>{% trans "Title" %}</th>
+   <th>{% trans "Latest Episode" %}</th>
+   <th>{% trans "Devices" %}</th>
+  </tr>
+  
+  {% for s in subscriptionlist %}
+   <tr>
+    <td> 
+     {% if s.podcast.logo_url %}
+      <img src="{{ s.podcast.logo_url }}" style="width:40px; height:30px;" />
+     {% endif %}                  
+    </td>
+    <td><a class="listlink" href="/podcast/{{ s.podcast.id }}">{{ s.podcast }}</a></td>
     {% if s.episode %}
-		<td>{{ s.episode }}</td>
+     <td>{{ s.episode }}</td>
     {% else %}
-      <td></td>
+     <td></td>
     {% endif %}
-		<td>{{ s.devices|join:", " }}</td>
-	</tr>
-       {% endfor %}
+    <td>{{ s.devices|join:", " }}</td>
+   </tr>
+  {% endfor %}
   </table>
+ {% else %}
+
+ <h2>{% trans "Where to start?" %}</h2>
+ <p>{% blocktrans with user.username as username %}my.gpodder.org help you to track your podcasts which you have subscribed on your devices - desktop computer, notebook, mobile devices, etc. To start using my.gpodder.org set up <a href="http://gpodder.org">gPodder</a> with your username &ndash; <strong>{{username}}</strong> &ndash; and password and upload your podcasts. They will automatically show up here.{% endblocktrans %}</p>
+
+ {% endif %}
 {% endblock %}
 

commit e94910d494505bfb18862f022e29cc2411c50a3e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 15:37:50 2009 +0100

    styled navigation bar

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 230e0eb..7464491 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -46,12 +46,12 @@ table.register th {
 }
 
 
-#menu a
+.menu a
 {
     color: black;
 }
 
-ul#menu
+ul.menu
 {
     list-style-type: none;
     margin: 1em;
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index f352991..6109a6c 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -59,17 +59,28 @@
   <div id="navigation">
    <span class="spacer1">&nbsp;</span>
    <span class="spacer2">&nbsp;</span>
-   <ul id="menu">
-    <li><a href="/">Home</a></li>
-    {% if user.is_authenticated %}
-     <li>logged in as {{ user.username }}</li>
-     <li><a href="/account/">Account settings</a></li>
-     <li><a href="/logout/">logout!</a></li>
-    {% else %}
-     <li><a href="/login/">login!</a></li>
-    {% endif %}
-    <li><a href="/toplist/">Podcast-Toplist</a></li>
-   </ul>
+
+   {% if user.is_authenticated %}
+    <ul class="menu">
+     <li><a href="/">{{ user.username }}'s Home</a></li>
+     <li><a href="/account/">Your settings</a></li>
+     <li><a href="/logout/">Logout</a></li>
+    </ul>
+
+    <ul class="menu">
+     <li><strong>Podcasts</strong></li>
+     <li><a href="/toplist/">Toplist</a></li>
+     <li><a href="/suggestions/">Suggestions</a></li>
+    </ul>
+   {% else %}
+    <ul class="menu">
+     <li><a href="/">Home</a></li>
+     <li><a href="/login/">Login</a></li>
+     <li><a href="/register/">Register</a></li>
+     <li><a href="/toplist/">Podcast-Toplist</a></li>
+    </ul>
+   {% endif %}
+
   </div>
 
   <hr style="clear: both;">

commit 2abb79844ec64e039a5987ed2c4c5f2e817e25bf
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 15:27:50 2009 +0100

    increase padding above h1, h2

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index a476e26..230e0eb 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -102,8 +102,9 @@ table td.numeric
     text-decoration: underline;
 }
 
-h1
+h1, h2
 {
+    padding-top: 1em;
     margin-bottom: 0;
     padding-bottom: 0;
 }

commit 8491aa00d800e90b914ce370f56a933a5b3d6b0b
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 15:24:34 2009 +0100

    added episode view /episode/<id>

diff --git a/htdocs/media/16x16/emblem-new.png b/htdocs/media/16x16/emblem-new.png
new file mode 100644
index 0000000..ff19e71
Binary files /dev/null and b/htdocs/media/16x16/emblem-new.png differ
diff --git a/htdocs/media/16x16/folder.png b/htdocs/media/16x16/folder.png
new file mode 100644
index 0000000..e45b65b
Binary files /dev/null and b/htdocs/media/16x16/folder.png differ
diff --git a/htdocs/media/16x16/media-playback-start.png b/htdocs/media/16x16/media-playback-start.png
new file mode 100644
index 0000000..4abe4f4
Binary files /dev/null and b/htdocs/media/16x16/media-playback-start.png differ
diff --git a/htdocs/media/16x16/user-trash-full.png b/htdocs/media/16x16/user-trash-full.png
new file mode 100644
index 0000000..2062941
Binary files /dev/null and b/htdocs/media/16x16/user-trash-full.png differ
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 1c4fc3b..c3085c8 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -39,6 +39,8 @@ urlpatterns = patterns('',
     (r'^activate/(?P<activation_key>\w+)$', activate),
     (r'^podcast/(?P<pid>\w+)$', 'mygpo.web.views.podcast'),
 
+    (r'^episode/(?P<id>\d+)$', 'mygpo.web.views.episode'),
+
     (r'account/$', 'mygpo.web.views.account'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
diff --git a/mygpo/web/templates/episode.html b/mygpo/web/templates/episode.html
new file mode 100644
index 0000000..d68066c
--- /dev/null
+++ b/mygpo/web/templates/episode.html
@@ -0,0 +1,45 @@
+{% extends "base.html" %}
+{% load i18n %}
+{% load humanize %}
+
+{% block content %}
+  <h1>{{ episode.title|default:"Unnamed Episode" }}</h1>
+  <div>{%blocktrans with episode.podcast as podcast and episode.podcast.id as podcast_id %}An episode of the <a href="/podcast/{{ podcast_id }}">{{ podcast }}</a> podcast.{% endblocktrans %}</div>
+
+  {% if episode.timestamp %}
+   <div>Released on {{episode.timestamp}}.</div>
+  {% endif %}
+
+  {% if episode.description %}
+   <p class="description">{{ episode.description }}</p>
+  {% endif %}
+
+  <div class="links"><strong>Links: </strong>
+   <a href="{{episode.url}}">Feed</a>
+   {% if episode.link %}<a href="{{episode.link}}">Website</a>{% endif %}
+  </div>
+
+  <h2>{% trans "Your Episode History" %}</h2>
+  <table class="list">
+   <tr>
+    <th>{% trans "When" %}</th>
+    <th>{% trans "What" %}</th>
+    <th>{% trans "Where" %}</th>
+   </tr>
+
+   {% for s in history %}
+    <tr>
+     <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
+     <td>{{ s.action }}</td>
+     <td><a href="/device/{{ s.device.id }}">{{ s.device.name }}</a></td>
+	</tr>
+   {% endfor %}
+  </table>
+  <br /><br />
+
+  {% if not episode.title %}
+   <div class="info"><strong>{% trans "Why Unnamed Episode?" %}</strong> {% trans "Because we display names after we have fetched the information form the feed -- and this may take some time. Until this is completed, the podcast will simply be called this way." %}</div>
+  {% endif %}
+
+{% endblock %}
+
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index 7bf18fa..f17b27b 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -17,6 +17,48 @@
    <li class="{{device.type}}"><a href="/device/{{ device.id }}">{{ device.name }}</a></li>
   {% endfor %}
   </ul>
+  
+  {% if not episodes|length_is:"0" %}
+   <h2>{% trans "Episodes" %}</h2>
+   <table class="list">
+    <tr>
+     <th></th>
+     <th>{% trans "Title" %}</th>
+     <th>{% trans "Description" %}</th>
+     <th>{% trans "Released" %}</th>
+    </tr>
+ 
+    {% for episode, action in episodes.items %}
+     <tr>
+      <td>
+       {% if not action %} 
+        <img src="/media/16x16/emblem-new.png" alt="new" />
+       {% endif %}
+
+       {% ifequal action.action "new" %}
+        <img src="/media/16x16/emblem-new.png" alt="new" />
+       {% endifequal %}
+
+       {% ifequal action.action "download" %}
+        <img src="/media/16x16/folder.png" alt="downloaded" />
+       {% endifequal %}
+
+       {% ifequal action.action "play" %}
+        <img src="/media/16x16/media-playback-start.png" alt="played" />
+       {% endifequal %}
+
+       {% ifequal action.action "delete" %}
+        <img src="/media/16x16/user-trash-full.png" alt="deleted" />
+       {% endifequal %}
+      </td>
+      <td><a href="/episode/{{ episode.id }}">{{ episode.title|default:"Unknown Episode" }}</a></td>
+      <td class="description">{{ episode.description|default:"" }}</td>
+      <td>{{ episode.timestamp|default:""|naturalday }}</td>
+
+     </tr>
+    {% endfor %}
+   </table>
+  {% endif %}
 
   <h2>{% trans "Subscription History" %}</h2>
   <table class="list">
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index a3f5d7d..1f3ce7f 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -62,10 +62,32 @@ def podcast(request, pid):
     devices = Device.objects.filter(user=request.user)
     history = SubscriptionAction.objects.filter(podcast=podcast,device__in=devices).order_by('-timestamp')
     subscribed_devices = [s.device for s in Subscription.objects.filter(podcast=podcast,user=request.user)]
+    episodes = episode_list(podcast, request.user)
     return render_to_response('podcast.html', {
         'history': history,
         'podcast': podcast,
         'devices': subscribed_devices,
+        'episodes': episodes,
+    }, context_instance=RequestContext(request))
+
+def episode_list(podcast, user):
+    list = {}
+    episodes = Episode.objects.filter(podcast=podcast).order_by('-timestamp')
+    for e in episodes:
+        list[e] = None
+        for action in EpisodeAction.objects.filter(episode=e, user=user).order_by('timestamp'):
+            list[e] = action
+
+    return list
+
+@login_required
+def episode(request, id):
+    episode = Episode.objects.get(pk=id)
+    history = EpisodeAction.objects.filter(user=request.user, episode=episode).order_by('-timestamp')
+
+    return render_to_response('episode.html', {
+        'episode': episode,
+        'history': history,
     }, context_instance=RequestContext(request))
 
 

commit e526364036435e6eb755baf5269d3ea2ea3a74d1
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 13:55:15 2009 +0100

    adding feedback for suggestions

diff --git a/htdocs/media/16x16/emblem-default.png b/htdocs/media/16x16/emblem-default.png
new file mode 100644
index 0000000..fb4362c
Binary files /dev/null and b/htdocs/media/16x16/emblem-default.png differ
diff --git a/htdocs/media/16x16/emblem-important.png b/htdocs/media/16x16/emblem-important.png
new file mode 100644
index 0000000..eec57c5
Binary files /dev/null and b/htdocs/media/16x16/emblem-important.png differ
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index f0095ce..a476e26 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -134,3 +134,8 @@ ul.devices li.other
     list-style-image: url('16x16/audio-x-generic.png');
 }
 
+div.rate
+{
+    padding-top: 2em;
+    padding-bottom: 3em;
+}
diff --git a/install/update-08.sql b/install/update-08.sql
index 26eeab6..b7307c3 100644
--- a/install/update-08.sql
+++ b/install/update-08.sql
@@ -2,3 +2,13 @@ alter table suggestion add column id int unique auto_increment;
 
 alter table episode add column timestamp timestamp;
 
+CREATE TABLE `ratings` (
+    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
+    `target` varchar(15) NOT NULL,
+    `user_id` integer NOT NULL,
+    `rating` integer NOT NULL,
+    `timestamp` datetime NOT NULL
+)
+;
+ALTER TABLE `ratings` ADD CONSTRAINT `user_id_refs_id_6cfe3b5b` FOREIGN KEY (`user_id`) REFERENCES `auth_user` (`id`);
+
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index b2cac54..53db5e3 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -343,3 +343,15 @@ class SubscriptionAction(models.Model):
         db_table = 'subscription_log'
         unique_together = ('device', 'podcast', 'timestamp')
 
+class Rating(models.Model):
+    target = models.CharField(max_length=15)
+    user = models.ForeignKey(User)
+    rating = models.IntegerField()
+    timestamp = models.DateTimeField(default=datetime.now)
+
+    class Meta:
+        db_table = 'ratings'
+
+    def __unicode__(self):
+        return '%s rates %s as %s on %s' % (self.user, self.target, self.rating, self.timestamp)
+
diff --git a/mygpo/web/templates/suggestions.html b/mygpo/web/templates/suggestions.html
index db3f95a..0eb5638 100644
--- a/mygpo/web/templates/suggestions.html
+++ b/mygpo/web/templates/suggestions.html
@@ -2,11 +2,16 @@
 {% load i18n %}
 
 {% block content %}
+
+  {% if rated %}
+   <div class="success">Thanks for your feedback!</div>
+  {% endif %}
+
   <h1>{% trans "Suggested Podcasts" %}</h1>
 
   <p>{% blocktrans with entries|length as suggestion_count %}We've selected {{ suggestion_count }} podcasts which you might like.{% endblocktrans %}</p>
 
-  <table>
+  <table class="list">
    <tr>
     <th></th>
     <th>{% trans "Podcast" %}</th>
@@ -15,12 +20,22 @@
   {% for entry in entries %}
    <tr>
     <td>{% if entry.podcast.logo_url %}<img href="{{ entry.podcast.logo_url }}" />{% endif %}</td>
-    <td>{{ entry.podcast }}</td>
+    <td><a href="/podcast/{{entry.podcast.id}}">{{ entry.podcast }}</a></td>
     <td><a href="{{ entry.podcast.url }}">{{ entry.podcast.url }}</a></td>
    </tr>
   {% endfor %}
   </table>
 
+  <div class="rate">
+   <strong>Do you like our suggestions?</strong>
+   <a href="/suggestions/?rate=1">
+    <img src="/media/16x16/emblem-default.png" alt="Yes" />
+   </a>
+   <a href="/suggestions/?rate=-1">
+    <img src="/media/16x16/emblem-important.png" alt="No" />
+   </a>
+  </div>
+
   <div class="info"><strong>Get your suggestions on your Client</strong>! Access <a href="http://my.gpodder.org/suggestions/15.opml">http://my.gpodder.org/suggestions/15.opml</a> to get 15 of our recommended podcasts.</div>
 {% endblock %}
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index e5b1753..a3f5d7d 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -19,12 +19,13 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect, HttpResponse
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
-from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry
+from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry, Rating
 from mygpo.web.forms import UserAccountForm, DeviceForm
 from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
 from mygpo.api.basic_auth import require_valid_user
 from django.contrib.auth.decorators import login_required
+from datetime import datetime
 
 def home(request):
        if request.user.is_authenticated():
@@ -115,9 +116,17 @@ def toplist_opml(request, count):
 
 @login_required
 def suggestions(request):
+
+    rated = False
+
+    if 'rate' in request.GET:
+        Rating.objects.create(target='suggestions', user=request.user, rating=request.GET['rate'], timestamp=datetime.now())
+        rated = True
+
     entries = SuggestionEntry.objects.filter(user=request.user).order_by('-priority')
     return render_to_response('suggestions.html', {
-        'entries': entries
+        'entries': entries,
+        'rated'  : rated
     }, context_instance=RequestContext(request))
 
 

commit 799d01a19d0cb12ffefabe9361999e18dc6c0d4a
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 13:23:45 2009 +0100

    added timestamp to episode

diff --git a/install/update-08.sql b/install/update-08.sql
index 2e6d9fd..26eeab6 100644
--- a/install/update-08.sql
+++ b/install/update-08.sql
@@ -1 +1,4 @@
 alter table suggestion add column id int unique auto_increment;
+
+alter table episode add column timestamp timestamp;
+
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 571bbf9..b2cac54 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -108,6 +108,7 @@ class Episode(models.Model):
     title = models.CharField(max_length=100, blank=True)
     description = models.TextField(null=True, blank=True)
     link = models.URLField(null=True, blank=True)
+    timestamp = models.DateTimeField(null=True, blank=True)
 
     def __unicode__(self):
         return self.title

commit d5349f8747581eee21735aaf49948cd0006f7164
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 11:16:23 2009 +0100

    bugfixing advanced api

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 521a6ef..4c28226 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -17,14 +17,15 @@
 
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404, HttpResponseNotAllowed
-from mygpo.api.models import Device, Podcast, SubscriptionAction, Episode, EpisodeAction, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, EPISODE_ACTION_TYPES, DEVICE_TYPES
+from mygpo.api.models import Device, Podcast, SubscriptionAction, Episode, EpisodeAction, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, EPISODE_ACTION_TYPES, DEVICE_TYPES, Subscription
 from mygpo.api.httpresponse import JsonResponse
 from django.core import serializers
 from time import mktime
-from datetime import datetime
+from datetime import datetime, timedelta
 import dateutil.parser
 from mygpo.logging import log
 from django.db import IntegrityError
+import re
 
 try:
     #try to import the JSON module (if we are on Python 2.6)
@@ -168,22 +169,24 @@ def get_episode_changes(user, podcast, device, since, until):
 def update_episodes(user, actions):
     for e in actions:
         try:
-            podcast = Podcast.objects.get(url=e['podcast'])
-            episode = Episode.objects.get(podcast=podcast, url=e['episode'])
+            podcast, p_created = Podcast.objects.get_or_create(url=e['podcast'])
+            episode, e_created = Episode.objects.get_or_create(podcast=podcast, url=e['episode'])
             action  = e['action']
-            if not action in EPISODE_ACTION_TYPES:
+            if not valid_episodeaction(action):
                 return HttpResponseBadRequest('invalid action %s' % action)
         except:
             return HttpResponseBadRequest('not all required fields (podcast, episode, action) given')
 
         device, created = Device.objects.get_or_create(user=user, uid=e['device'], defaults={'name': 'Unknown', 'type': 'other'}) if 'device' in e else None
         timestamp = dateutil.parser.parse(e['timestamp']) if 'timestamp' in e else None
-        position = datetime.strptime(e['position'], '%H:%M:%S').time() if 'position' in e else None
+        position = parseTimeDelta(e['position']) if 'position' in e else None
+        playmark = position['seconds'] if position else None
 
         if position and action != 'play':
             return HttpResponseBadRequest('parameter position can only be used with action play')
 
-        EpisodeAction.objects.create(user=user, episode=episode, device=device, action=action, timestamp=timestamp, playmark=position)
+        EpisodeAction.objects.create(user=user, episode=episode, device=device, action=action, timestamp=timestamp, playmark=playmark)
+
 
 
 @require_valid_user
@@ -201,7 +204,7 @@ def device(request, username, device_uid):
             d.name = data['caption']
 
         if 'type' in data:
-            if not data['type'] in DEVICE_TYPES:
+            if not valid_devicetype(data['type']):
                 return HttpResponseBadRequest('invalid device type %s' % data['type'])
             d.type = data['type']
 
@@ -212,6 +215,37 @@ def device(request, username, device_uid):
     else:
         return HttpResponseNotAllowed(['POST'])
 
+def valid_devicetype(type):
+    for t in DEVICE_TYPES:
+        if t[0] == type:
+            return True
+    return False
+
+def valid_episodeaction(type):
+    for t in EPISODE_ACTION_TYPES:
+        if t[0] == type:
+            return True
+    return False
+
+# http://kbyanc.blogspot.com/2007/08/python-reconstructing-timedeltas-from.html
+def parseTimeDelta(s):
+    """Create timedelta object representing time delta
+       expressed in a string
+   
+    Takes a string in the format produced by calling str() on
+    a python timedelta object and returns a timedelta instance
+    that would produce that string.
+   
+    Acceptable formats are: "X days, HH:MM:SS" or "HH:MM:SS".
+    """
+    if s is None:
+        return None
+    d = re.match(
+            r'((?P<days>\d+) days, )?(?P<hours>\d+):'
+            r'(?P<minutes>\d+):(?P<seconds>\d+)',
+            str(s)).groupdict(0)
+    return timedelta(**dict(( (key, int(value))
+                              for key, value in d.items() )))
 
 @require_valid_user
 def devices(request, username):
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 8274aed..571bbf9 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -296,7 +296,7 @@ class EpisodeAction(models.Model):
     user = models.ForeignKey(User, primary_key=True)
     episode = models.ForeignKey(Episode)
     device = models.ForeignKey(Device)
-    action = models.IntegerField(choices=EPISODE_ACTION_TYPES)
+    action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
     timestamp = models.DateTimeField(default=datetime.now)
     playmark = models.IntegerField(null=True, blank=True)
 

commit 3f8c688fd4ed2ee5b8ca57fdf04498b5c00873ee
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 10:22:47 2009 +0100

    updated url for advanced api device list
    
    previously: /api/1/devices/{username}/devices.json
    now:        /api/1/devices/{username}.json

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 7ea0085..1c4fc3b 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -62,7 +62,7 @@ urlpatterns = patterns('',
     (r'^api/1/subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.subscriptions'),
     (r'^api/1/episodes/(?P<username>\w+).json', 'mygpo.api.advanced.episodes'),
     (r'^api/1/devices/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.device'),
-    (r'^api/1/devices/(?P<username>\w+)/devices.json', 'mygpo.api.advanced.devices'),
+    (r'^api/1/devices/(?P<username>\w+).json', 'mygpo.api.advanced.devices'),
 
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs'
     # to INSTALLED_APPS to enable admin documentation:

commit 49571139d0fc9d4a1e0e730fc473d78a80174035
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 10:21:55 2009 +0100

    bugfixing advanced api

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 0b13547..521a6ef 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -40,7 +40,8 @@ def subscriptions(request, username, device_uid):
     if request.user.username != username:
         return HttpResponseForbidden()
 
-    now = int(mktime(datetime.now().timetuple()))
+    now = datetime.now()
+    now_ = int(mktime(now.timetuple()))
 
     if request.method == 'GET':
         try:
@@ -49,11 +50,13 @@ def subscriptions(request, username, device_uid):
             raise Http404('device %s does not exist' % device_uid)
 
         try:
-            since = request.GET['since']
+            since_ = request.GET['since']
         except KeyError:
             return HttpResponseBadRequest('parameter since missing')
 
-        changes = get_subscription_changes(request.user, device, since, now)
+        since = datetime.fromtimestamp(float(since_))
+
+        changes = get_subscription_changes(request.user, d, since, now)
 
         return JsonResponse(changes)
 
@@ -70,7 +73,7 @@ def subscriptions(request, username, device_uid):
 
         update_subscriptions(request.user, d, add, rem)
 
-        return JsonResponse({'timestamp': now})
+        return JsonResponse({'timestamp': now_})
 
     else:
         return HttpResponseNotAllowed(['GET', 'POST'])
@@ -101,13 +104,14 @@ def get_subscription_changes(user, device, since, until):
     add = []
     remove = []
 
-    for a in actions:
+    for a in actions.values():
         if a.action == SUBSCRIBE_ACTION:
             add.append(a.podcast.url)
         elif a.action == UNSUBSCRIBE_ACTION:
             remove.append(a.podcast.url)
 
-    return {'add': add, 'remove': remove, 'timestamp': until}
+    until_ = int(mktime(until.timetuple()))
+    return {'add': add, 'remove': remove, 'timestamp': until_}
 
 
 @require_valid_user

commit fe1cde3232e259768b1805da39a8e88200f6e333
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 10:00:50 2009 +0100

    fix usage of require_valid_user

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 50e40dc..0b13547 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -34,7 +34,7 @@ except ImportError:
     print "No JSON module available - fallback to simplejson (Python < 2.6)"
     import simplejson as json
 
-@require_valid_user()
+@require_valid_user
 def subscriptions(request, username, device_uid):
 
     if request.user.username != username:
@@ -110,7 +110,7 @@ def get_subscription_changes(user, device, since, until):
     return {'add': add, 'remove': remove, 'timestamp': until}
 
 
-@require_valid_user()
+@require_valid_user
 def episodes(request, username):
 
     if request.user.username != username:
@@ -182,7 +182,7 @@ def update_episodes(user, actions):
         EpisodeAction.objects.create(user=user, episode=episode, device=device, action=action, timestamp=timestamp, playmark=position)
 
 
-@require_valid_user()
+@require_valid_user
 def device(request, username, device_uid):
 
     if request.user.username != username:
@@ -209,7 +209,7 @@ def device(request, username, device_uid):
         return HttpResponseNotAllowed(['POST'])
 
 
-@require_valid_user()
+@require_valid_user
 def devices(request, username):
 
     if request.user.username != username:

commit 95cb22b8c2393c464f74fc67ea4ab95e75b85665
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 09:45:01 2009 +0100

    using naturalday for timestamps
    
    http://docs.djangoproject.com/en/1.0/ref/contrib/humanize/

diff --git a/mygpo/settings.py b/mygpo/settings.py
index ffe62be..fd13d46 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -100,6 +100,7 @@ INSTALLED_APPS = (
     'django.contrib.sessions',
     'django.contrib.sites',
     'django.contrib.admin',
+    'django.contrib.humanize',
     'registration',
     'mygpo.api',
     'mygpo.web'
diff --git a/mygpo/web/templates/device.html b/mygpo/web/templates/device.html
index a0aeaeb..af867f7 100644
--- a/mygpo/web/templates/device.html
+++ b/mygpo/web/templates/device.html
@@ -1,5 +1,6 @@
 {% extends "base.html" %}
 {% load i18n %}
+{% load humanize %}
 
 {% block content %}
   <h1>{{ device.name }}</h1>
@@ -17,7 +18,7 @@
     <tr>
      <td></td>
      <td><a href="/podcast/{{subscription.podcast.id}}">{{ subscription.podcast }}</a></td>
-     <td>{{subscription.subscribed_since}}</td>
+     <td><abbr title="{{subscription.subscribed_since}}">{{subscription.subscribed_since|naturalday}}</abbr></td>
     </tr>
    {% endfor %}
   </table>
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index bb6ce91..7bf18fa 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -1,5 +1,6 @@
 {% extends "base.html" %}
 {% load i18n %}
+{% load humanize %}
 
 {% block content %}
   <h1>{% if podcast.title %}{{ podcast.title }}{% else %}{% trans "Unnamed Podcast" %}{%endif%}</h1>
@@ -26,7 +27,7 @@
 	</tr>
        {% for s in history %}
 	<tr>
-		<td>{{ s.timestamp }}</td>
+		<td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
 		<td>
 		{% ifequal s.action 1 %}
 			{% trans "subscribe" %}

commit bf17a2fab6f7de0c122a393adef5c34142e01a4d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 09:37:51 2009 +0100

    split h1 in home-user.html

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index bd2495c..1c669de 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -2,7 +2,8 @@
 {% load i18n %}
 
 {% block content %}
-  <h1>{% trans "Your Subscriptions" %}</h1>
+  <h1>{% trans "my.gpodder.org" %}
+  <h2>{% trans "Your Subscriptions" %}</h2>
   <table class="list">
 	<tr>
 		<th>&nbsp;</th>

commit ff99fec303f69886ed4d9609f132a3aa1997da8b
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 09:27:47 2009 +0100

    added device view /device/<id>

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 674ab3f..7ea0085 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -49,6 +49,8 @@ urlpatterns = patterns('',
     (r'^suggestions/$', 'mygpo.web.views.suggestions'),
     (r'^suggestions/(?P<count>\d+).opml$', 'mygpo.web.views.suggestions_opml'),
 
+    (r'^device/(?P<device_id>\d+)$', 'mygpo.web.views.device'),
+
     #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
diff --git a/mygpo/web/forms.py b/mygpo/web/forms.py
index 3b8cb89..bfbc50b 100644
--- a/mygpo/web/forms.py
+++ b/mygpo/web/forms.py
@@ -1,7 +1,13 @@
 from django import forms
 from django.utils.translation import ugettext as _
+from mygpo.api.models import DEVICE_TYPES
 
 class UserAccountForm(forms.Form):
     email = forms.EmailField(label=_('Your Email Address'))
     public = forms.BooleanField(required=False, label=_('May we use your subscriptions for the toplist and suggestions?'))
 
+class DeviceForm(forms.Form):
+    name = forms.CharField(max_length=100, label=_('Name of this device'))
+    type = forms.ChoiceField(choices=DEVICE_TYPES, label=_('What kind of device is this?'))
+    uid = forms.CharField(max_length=50, label=_('What UID is configured on the pysical device?'))
+
diff --git a/mygpo/web/templates/device.html b/mygpo/web/templates/device.html
new file mode 100644
index 0000000..a0aeaeb
--- /dev/null
+++ b/mygpo/web/templates/device.html
@@ -0,0 +1,38 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>{{ device.name }}</h1>
+
+  <h2>Podcasts</h2>
+  <p>{% trans "You have subscribed the following podcasts on this device" %}
+  <table class="list">
+   <tr>
+    <th></th>
+    <th>{% trans "Title" %}</th>
+    <th>{% trans "Since" %}</th>
+   </tr>
+
+   {% for subscription in subscriptions %}
+    <tr>
+     <td></td>
+     <td><a href="/podcast/{{subscription.podcast.id}}">{{ subscription.podcast }}</a></td>
+     <td>{{subscription.subscribed_since}}</td>
+    </tr>
+   {% endfor %}
+  </table>
+
+  <h2>Edit</h2>
+  {% if success %}
+   <div class="success">{% trans "Your settings have been saved." %}</div>
+  {% endif %}
+
+  <form action="" method="POST">
+   {{ form.as_p }}
+   <input type="submit" value="Save" />
+  </form>
+
+  <div class="info">The <strong>UID</strong> connects your physical device with this page, so you should enter the same text on your device and here.</div>
+
+{% endblock %}
+
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index d165e09..bb6ce91 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -13,7 +13,7 @@
   <strong>You have subscribed this podcast on</strong>
   <ul class="devices">
   {% for device in devices %}
-   <li class="{{device.type}}">{{ device.name }}</li>
+   <li class="{{device.type}}"><a href="/device/{{ device.id }}">{{ device.name }}</a></li>
   {% endfor %}
   </ul>
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index eef810e..e5b1753 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -20,7 +20,7 @@ from django.http import HttpResponseRedirect, HttpResponse
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
 from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry
-from mygpo.web.forms import UserAccountForm
+from mygpo.web.forms import UserAccountForm, DeviceForm
 from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
 from mygpo.api.basic_auth import require_valid_user
@@ -130,3 +130,33 @@ def suggestions_opml(request, count):
 
     return HttpResponse(opml, mimetype='text/xml')
 
+def device(request, device_id):
+    device = Device.objects.get(pk=device_id)
+    subscriptions = Subscription.objects.filter(device=device)
+    success = False
+
+    if request.method == 'POST':
+        form = DeviceForm(request.POST)
+
+        if form.is_valid():
+            device.name = form.cleaned_data['name']
+            device.type = form.cleaned_data['type']
+            device.uid  = form.cleaned_data['uid']
+            device.save()
+            success = True
+
+    else:
+        form = DeviceForm({
+            'name': device.name,
+            'type': device.type,
+            'uid' : device.uid
+            })
+
+    return render_to_response('device.html', {
+        'device': device,
+        'form': form,
+        'success': success,
+        'subscriptions': subscriptions,
+    }, context_instance=RequestContext(request))
+
+

commit 3b6c42e53e8ca2707bc3860854d454eb9dbcfeab
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 23 08:49:06 2009 +0100

    displaying subscribed devices for each podcast

diff --git a/htdocs/media/16x16/audio-x-generic.png b/htdocs/media/16x16/audio-x-generic.png
new file mode 100644
index 0000000..5c34baa
Binary files /dev/null and b/htdocs/media/16x16/audio-x-generic.png differ
diff --git a/htdocs/media/16x16/computer.png b/htdocs/media/16x16/computer.png
new file mode 100644
index 0000000..8676b5d
Binary files /dev/null and b/htdocs/media/16x16/computer.png differ
diff --git a/htdocs/media/16x16/multimedia-player.png b/htdocs/media/16x16/multimedia-player.png
new file mode 100644
index 0000000..dab3f00
Binary files /dev/null and b/htdocs/media/16x16/multimedia-player.png differ
diff --git a/htdocs/media/16x16/pda.png b/htdocs/media/16x16/pda.png
new file mode 100644
index 0000000..fed8bb7
Binary files /dev/null and b/htdocs/media/16x16/pda.png differ
diff --git a/htdocs/media/16x16/server.png b/htdocs/media/16x16/server.png
new file mode 100644
index 0000000..82c9b4b
Binary files /dev/null and b/htdocs/media/16x16/server.png differ
diff --git a/htdocs/media/32x32/audio-x-generic.png b/htdocs/media/32x32/audio-x-generic.png
new file mode 100644
index 0000000..d66563f
Binary files /dev/null and b/htdocs/media/32x32/audio-x-generic.png differ
diff --git a/htdocs/media/32x32/computer.png b/htdocs/media/32x32/computer.png
new file mode 100644
index 0000000..367e4ec
Binary files /dev/null and b/htdocs/media/32x32/computer.png differ
diff --git a/htdocs/media/32x32/multimedia-player.png b/htdocs/media/32x32/multimedia-player.png
new file mode 100644
index 0000000..9e65d20
Binary files /dev/null and b/htdocs/media/32x32/multimedia-player.png differ
diff --git a/htdocs/media/32x32/pda.png b/htdocs/media/32x32/pda.png
new file mode 100644
index 0000000..672325b
Binary files /dev/null and b/htdocs/media/32x32/pda.png differ
diff --git a/htdocs/media/32x32/server.png b/htdocs/media/32x32/server.png
new file mode 100644
index 0000000..4f863f9
Binary files /dev/null and b/htdocs/media/32x32/server.png differ
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 2ecd369..f0095ce 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -107,3 +107,30 @@ h1
     margin-bottom: 0;
     padding-bottom: 0;
 }
+
+
+ul.devices li.desktop
+{
+    list-style-image: url('16x16/computer.png');
+}
+
+ul.devices li.laptop
+{
+    list-style-image: url('16x16/pda.png');
+}
+
+ul.devices li.mobile
+{
+    list-style-image: url('16x16/pda.png');
+}
+
+ul.devices li.server
+{
+    list-style-image: url('16x16/server.png');
+}
+
+ul.devices li.other
+{
+    list-style-image: url('16x16/audio-x-generic.png');
+}
+
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index c54b9e5..d165e09 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -11,9 +11,9 @@
 
   <h2>Devices</h2>
   <strong>You have subscribed this podcast on</strong>
-  <ul>
+  <ul class="devices">
   {% for device in devices %}
-   <li>{{ device }}</li>
+   <li class="{{device.type}}">{{ device.name }}</li>
   {% endfor %}
   </ul>
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 226ccf1..eef810e 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -60,9 +60,11 @@ def podcast(request, pid):
     podcast = Podcast.objects.get(pk=pid)
     devices = Device.objects.filter(user=request.user)
     history = SubscriptionAction.objects.filter(podcast=podcast,device__in=devices).order_by('-timestamp')
+    subscribed_devices = [s.device for s in Subscription.objects.filter(podcast=podcast,user=request.user)]
     return render_to_response('podcast.html', {
         'history': history,
-        'podcast': podcast
+        'podcast': podcast,
+        'devices': subscribed_devices,
     }, context_instance=RequestContext(request))
 
 
@@ -119,7 +121,7 @@ def suggestions(request):
     }, context_instance=RequestContext(request))
 
 
-@require_valid_user()
+@require_valid_user
 def suggestions_opml(request, count):
     entries = SuggestionEntry.objects.filter(user=request.user).order_by('-priority')
     exporter = Exporter(_('my.gpodder.org - %s Suggestions') % count)

commit e383a5c507a0fd1641ec6bd0660ba61dc40f22f7
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 22 22:18:52 2009 +0100

    show list of subscribed devices for each podcast

diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index eeb0449..c54b9e5 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -9,6 +9,14 @@
    <p class="description">{{ podcast.description }}</p>
   {% endif %}
 
+  <h2>Devices</h2>
+  <strong>You have subscribed this podcast on</strong>
+  <ul>
+  {% for device in devices %}
+   <li>{{ device }}</li>
+  {% endfor %}
+  </ul>
+
   <h2>{% trans "Subscription History" %}</h2>
   <table class="list">
 	<tr>

commit f3048be358b6c92a0418d372343bea1051eba2f9
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Dec 22 21:55:42 2009 +0100

    Refactored basic_auth decorator

diff --git a/mygpo/api/basic_auth.py b/mygpo/api/basic_auth.py
index 4fc379f..3428482 100644
--- a/mygpo/api/basic_auth.py
+++ b/mygpo/api/basic_auth.py
@@ -15,9 +15,6 @@
 # along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
 #
 
-#from http://www.djangosnippets.org/snippets/243/
-import base64
-
 from django.http import HttpResponse
 from django.contrib.auth import authenticate, login
 
@@ -25,28 +22,28 @@ from django.contrib.auth import authenticate, login
 #
 def view_or_basicauth(view, request, test_func, realm = "", *args, **kwargs):
     """
-    This is a helper function used by both 'logged_in_or_basicauth' and
+    This is a helper function used by both 'require_valid_user' and
     'has_perm_or_basicauth' that does the nitty of determining if they
     are already logged in or if they have provided proper http-authorization
     and returning the view if all goes well, otherwise responding with a 401.
     """
     if test_func(request.user):
         # Already logged in, just return the view.
-        #
         return view(request, *args, **kwargs)
 
     # They are not logged in. See if they provided login credentials
-    #
     if 'HTTP_AUTHORIZATION' in request.META:
-        auth = request.META['HTTP_AUTHORIZATION'].split()
+        auth = request.META['HTTP_AUTHORIZATION'].split(None, 1)
         if len(auth) == 2:
+            auth_type, credentials = auth
+
             # NOTE: We are only support basic authentication for now.
-            #
-            if auth[0].lower() == "basic":
-                uname, passwd = base64.b64decode(auth[1]).split(':')
-                user = authenticate(username=uname, password=passwd)
-                if user is not None:
-                    if user.is_active:
+            if auth_type.lower() == 'basic':
+                credentials = credentials.decode('base64').split(':', 1)
+                if len(credentials) == 2:
+                    uname, passwd = credentials
+                    user = authenticate(username=uname, password=passwd)
+                    if user is not None and user.is_active:
                         login(request, user)
                         request.user = user
                         return view(request, *args, **kwargs)
@@ -54,7 +51,6 @@ def view_or_basicauth(view, request, test_func, realm = "", *args, **kwargs):
     # Either they did not provide an authorization header or
     # something in the authorization attempt failed. Send a 401
     # back to them to ask them to authenticate.
-    #
     response = HttpResponse()
     response.status_code = 401
     response['WWW-Authenticate'] = 'Basic realm="%s"' % realm
@@ -62,7 +58,7 @@ def view_or_basicauth(view, request, test_func, realm = "", *args, **kwargs):
 
 #############################################################################
 #
-def require_valid_user(realm = ""):
+def require_valid_user(protected_view):
     """
     A simple decorator that requires a user to be logged in. If they are not
     logged in the request is examined for a 'authorization' header.
@@ -83,21 +79,19 @@ def require_valid_user(realm = ""):
     auth (and they do NOT support a redirect to a form where they post a
     username/password.)
 
-    Use is simple:
-
-    @logged_in_or_basicauth
-    def your_view:
-        ...
-
-    You can provide the name of the realm to ask for authentication within.
+    XXX: Fix usage descriptions, ideally provide an example as doctest.
     """
-    def view_decorator(func):
-        def wrapper(request, *args, **kwargs):
-            return view_or_basicauth(func, request,
-                                     lambda u: u.is_authenticated(),
-                                     realm, *args, **kwargs)
-        return wrapper
-    return view_decorator
+    def wrapper(request, *args, **kwargs):
+        def check_valid_user(user):
+            return user.is_authenticated()
+
+        return view_or_basicauth(protected_view, \
+                                 request, \
+                                 check_valid_user, \
+                                 '', \
+                                 *args, \
+                                 **kwargs)
+    return wrapper
 
 #############################################################################
 #

commit 18f787b33014a986b4fc1178a0775eec7b32b07e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 22 21:19:26 2009 +0100

    extended podcast view /podcast/<id>
    
    separated headers, displaying title, description and info if no title is available

diff --git a/htdocs/media/screen-base.css b/htdocs/media/screen-base.css
index 7f7b205..5ace9f4 100644
--- a/htdocs/media/screen-base.css
+++ b/htdocs/media/screen-base.css
@@ -6,11 +6,6 @@ body
     padding-right: 50px;
 }
 
-h2 
-{ 
-    margin-top:0px;
-}
-
 h3 
 { 
     color: #535;
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 4b4221d..2ecd369 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -86,3 +86,24 @@ table td.numeric
     text-align: right;
 }
 
+.description
+{
+    color: #666;
+}
+
+.URL
+{
+    text-decoration: none;
+    color: black;
+}
+
+.URL:hover
+{
+    text-decoration: underline;
+}
+
+h1
+{
+    margin-bottom: 0;
+    padding-bottom: 0;
+}
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
index 17f6b29..eeb0449 100644
--- a/mygpo/web/templates/podcast.html
+++ b/mygpo/web/templates/podcast.html
@@ -2,7 +2,14 @@
 {% load i18n %}
 
 {% block content %}
-  <h1>{% trans "Subscription History" %}: {{ podcastname }}</h1>
+  <h1>{% if podcast.title %}{{ podcast.title }}{% else %}{% trans "Unnamed Podcast" %}{%endif%}</h1>
+  <a href="{{ podcast.url }}" class="URL">{{ podcast.url }}</a>
+
+  {% if podcast.description %}
+   <p class="description">{{ podcast.description }}</p>
+  {% endif %}
+
+  <h2>{% trans "Subscription History" %}</h2>
   <table class="list">
 	<tr>
 		<th>{% trans "Timestamp" %}</th>
@@ -25,6 +32,11 @@
        {% endfor %}
   </table>
   <br /><br />
+
+  {% if not podcast.title %}
+   <div class="info"><strong>{% trans "Why Unnamed Podcast?" %}</strong> {% trans "Because we display names after we have fetched the information form the feed -- and this may take some time. Until this is completed, the podcast will simply be called this way." %}</div>
+  {% endif %}
+
   <a href="/">{% trans "back!" %}</a> 
 {% endblock %}
 

commit 2c9a4c1e5b3606dcf2cc9243187badc9b2f3ad0f
Merge: 7ebadfc... e936023...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 22 21:02:15 2009 +0100

    Merge branch 'master' of ~/mygpo-src

commit 7ebadfc845de27195b18edbb8529a24000e9a057
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 22 21:01:16 2009 +0100

    raising Http404s instead of returning them

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 58c8eae..791368d 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -47,7 +47,7 @@ def subscriptions(request, username, device_uid):
         try:
             d = Device.objects.get(user=request.user, uid=device_uid)
         except Device.DoesNotExist:
-            return Http404('device %s does not exist' % device_uid)
+            raise Http404('device %s does not exist' % device_uid)
 
         try:
             since = request.GET['since']
@@ -131,7 +131,7 @@ def episodes(request, username):
             podcast = Podcast.objects.get(pk=podcast_id) if podcast_id else None
             device  = Device.objects.get(pk=device_id) if device_id else None
         except:
-            return Http404
+            raise Http404
 
         return JsonRequest(get_episode_changes(request.user, podcast, device, since, now))
 

commit e936023d13cc4de1a5de3c350b0138d0e147c794
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 22 20:42:32 2009 +0100

    added some logging to advanced api

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 58c8eae..4c2f78a 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -23,6 +23,8 @@ from django.core import serializers
 from time import mktime
 from datetime import datetime
 import dateutil.parser
+from mygpo.logging import log
+from django.db import IntegrityError
 
 try:
     #try to import the JSON module (if we are on Python 2.6)
@@ -32,9 +34,6 @@ except ImportError:
     print "No JSON module available - fallback to simplejson (Python < 2.6)"
     import simplejson as json
 
-print dir(json)
-
-
 @require_valid_user()
 def subscriptions(request, username, device_uid):
 
@@ -80,11 +79,17 @@ def subscriptions(request, username, device_uid):
 def update_subscriptions(user, device, add, remove):
     for a in add:
         p, p_created = Podcast.objects.get_or_create(url=a)
-        s = SubscriptionAction.objects.create(podcast=p,device=device,action=SUBSCRIBE_ACTION)
+        try:
+            s = SubscriptionAction.objects.create(podcast=p,device=device,action=SUBSCRIBE_ACTION)
+        except IntegrityError, e:
+            log('can\'t add subscription %s for user %s: %s' % (a, user, e))
 
     for r in remove:
         p, p_created = Podcast.objects.get_or_create(url=r)
-        s = SubscriptionAction.objects.create(podcast=p,device=device,action=UNSUBSCRIBE_ACTION)
+        try:
+            s = SubscriptionAction.objects.create(podcast=p,device=device,action=UNSUBSCRIBE_ACTION)
+        except IntegrityError, e:
+            log('can\'t remove subscription %s for user %s: %s' % (r, user, e))
 
 
 def get_subscription_changes(user, device, since, until):

commit 3530e6a042ac9a4513a5190541518eeff7662fdb
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 22 19:59:48 2009 +0100

    requiring the user to be logged in in all views

diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
index 431219b..ae2ac9e 100644
--- a/mygpo/web/templates/toplist.html
+++ b/mygpo/web/templates/toplist.html
@@ -21,6 +21,6 @@
   {% endfor %}
   </table>
 
-  <div class="info"><strong>Get the toplist from your Client</strong>! Access <a href="http://my.gpodder.org/toplist/30.opml">http://my.gpodder.org/toplist/30.opml</a> for the Top-30.</div>
+  <div class="info"><strong>Get the toplist from your Client</strong>! Access <a href="/toplist/30.opml">http://my.gpodder.org/toplist/30.opml</a> for the Top-30.</div>
 {% endblock %}
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 7eaabd5..226ccf1 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -23,6 +23,8 @@ from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeActio
 from mygpo.web.forms import UserAccountForm
 from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
+from mygpo.api.basic_auth import require_valid_user
+from django.contrib.auth.decorators import login_required
 
 def home(request):
        if request.user.is_authenticated():
@@ -53,6 +55,7 @@ def create_subscriptionlist(request):
     return l.values()
 
 
+@login_required
 def podcast(request, pid):
     podcast = Podcast.objects.get(pk=pid)
     devices = Device.objects.filter(user=request.user)
@@ -63,6 +66,7 @@ def podcast(request, pid):
     }, context_instance=RequestContext(request))
 
 
+@login_required
 def account(request):
     success = False
 
@@ -88,6 +92,7 @@ def account(request):
         'success': success
     }, context_instance=RequestContext(request))
 
+
 def toplist(request):
     len = 30
     entries = ToplistEntry.objects.all().order_by('-subscriptions')[:len]
@@ -106,12 +111,15 @@ def toplist_opml(request, count):
     return HttpResponse(opml, mimetype='text/xml')
  
 
+@login_required
 def suggestions(request):
     entries = SuggestionEntry.objects.filter(user=request.user).order_by('-priority')
     return render_to_response('suggestions.html', {
         'entries': entries
     }, context_instance=RequestContext(request))
 
+
+@require_valid_user()
 def suggestions_opml(request, count):
     entries = SuggestionEntry.objects.filter(user=request.user).order_by('-priority')
     exporter = Exporter(_('my.gpodder.org - %s Suggestions') % count)

commit e5338e9971f35fe84f0943f5eb6a68a60a1e7e92
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 22 16:30:09 2009 +0100

    fixed wrong heading in account.html

diff --git a/mygpo/web/templates/account.html b/mygpo/web/templates/account.html
index 09f3a37..1999602 100644
--- a/mygpo/web/templates/account.html
+++ b/mygpo/web/templates/account.html
@@ -2,7 +2,7 @@
 {% load i18n %}
 
 {% block content %}
-  <h1>{% trans "Your Subscriptions" %}</h1>
+  <h1>{% trans "Account Settings" %}</h1>
 
  {% if success %}
    <div class="success">{% trans "Your settings have been saved." %}</div>

commit 51414b7c115675cf6ef22112d162171f2276e7c2
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 22 16:28:56 2009 +0100

    web and opml interface for podcast suggestions
    
    web:  /suggestions/
    opml: /suggestions/15.opml (or any other number)

diff --git a/install/update-08.sql b/install/update-08.sql
new file mode 100644
index 0000000..2e6d9fd
--- /dev/null
+++ b/install/update-08.sql
@@ -0,0 +1 @@
+alter table suggestion add column id int unique auto_increment;
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index d6db622..8274aed 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -90,6 +90,17 @@ class ToplistEntry(models.Model):
     class Meta:
         db_table = 'toplist'
 
+class SuggestionEntry(models.Model):
+    podcast = models.ForeignKey(Podcast)
+    user = models.ForeignKey(User)
+    priority = models.IntegerField()
+
+    def __unicode__(self):
+        return '%s (%s)' % (self.podcast, self.priority)
+
+    class Meta:
+        db_table = 'suggestion'
+
 
 class Episode(models.Model):
     podcast = models.ForeignKey(Podcast)
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 184d9bf..674ab3f 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -46,6 +46,9 @@ urlpatterns = patterns('',
     (r'^toplist/(?P<count>\d+).opml', 'mygpo.web.views.toplist_opml'),
     (r'^toplist.opml$', 'mygpo.web.views.toplist_opml', {'count': 50}),
 
+    (r'^suggestions/$', 'mygpo.web.views.suggestions'),
+    (r'^suggestions/(?P<count>\d+).opml$', 'mygpo.web.views.suggestions_opml'),
+
     #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
diff --git a/mygpo/web/templates/suggestions.html b/mygpo/web/templates/suggestions.html
new file mode 100644
index 0000000..db3f95a
--- /dev/null
+++ b/mygpo/web/templates/suggestions.html
@@ -0,0 +1,26 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>{% trans "Suggested Podcasts" %}</h1>
+
+  <p>{% blocktrans with entries|length as suggestion_count %}We've selected {{ suggestion_count }} podcasts which you might like.{% endblocktrans %}</p>
+
+  <table>
+   <tr>
+    <th></th>
+    <th>{% trans "Podcast" %}</th>
+    <th>{% trans "URL" %}</th>
+   </tr>
+  {% for entry in entries %}
+   <tr>
+    <td>{% if entry.podcast.logo_url %}<img href="{{ entry.podcast.logo_url }}" />{% endif %}</td>
+    <td>{{ entry.podcast }}</td>
+    <td><a href="{{ entry.podcast.url }}">{{ entry.podcast.url }}</a></td>
+   </tr>
+  {% endfor %}
+  </table>
+
+  <div class="info"><strong>Get your suggestions on your Client</strong>! Access <a href="http://my.gpodder.org/suggestions/15.opml">http://my.gpodder.org/suggestions/15.opml</a> to get 15 of our recommended podcasts.</div>
+{% endblock %}
+
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index cd0fa71..7eaabd5 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -19,7 +19,7 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect, HttpResponse
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
-from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription
+from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription, SuggestionEntry
 from mygpo.web.forms import UserAccountForm
 from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
@@ -106,4 +106,17 @@ def toplist_opml(request, count):
     return HttpResponse(opml, mimetype='text/xml')
  
 
+def suggestions(request):
+    entries = SuggestionEntry.objects.filter(user=request.user).order_by('-priority')
+    return render_to_response('suggestions.html', {
+        'entries': entries
+    }, context_instance=RequestContext(request))
+
+def suggestions_opml(request, count):
+    entries = SuggestionEntry.objects.filter(user=request.user).order_by('-priority')
+    exporter = Exporter(_('my.gpodder.org - %s Suggestions') % count)
+
+    opml = exporter.generate([e.podcast for e in entries])
+
+    return HttpResponse(opml, mimetype='text/xml')
 

commit 009bad77d5494d07932a6275a4da9528d8d9489c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 19 17:44:49 2009 +0100

    fixing subscription history

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 235cc4a..184d9bf 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -37,7 +37,7 @@ urlpatterns = patterns('',
     (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/', 'form_class': RegistrationFormUniqueEmail}),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
     (r'^activate/(?P<activation_key>\w+)$', activate),
-    (r'^podcast/(?P<pid>\w+)$', 'mygpo.web.views.create_subscriptionhistory'),
+    (r'^podcast/(?P<pid>\w+)$', 'mygpo.web.views.podcast'),
 
     (r'account/$', 'mygpo.web.views.account'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
diff --git a/mygpo/web/templates/podcast.html b/mygpo/web/templates/podcast.html
new file mode 100644
index 0000000..17f6b29
--- /dev/null
+++ b/mygpo/web/templates/podcast.html
@@ -0,0 +1,30 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>{% trans "Subscription History" %}: {{ podcastname }}</h1>
+  <table class="list">
+	<tr>
+		<th>{% trans "Timestamp" %}</th>
+              <th>{% trans "Action" %}</th>
+		<th>{% trans "Devices" %}</th>
+	</tr>
+       {% for s in history %}
+	<tr>
+		<td>{{ s.timestamp }}</td>
+		<td>
+		{% ifequal s.action 1 %}
+			{% trans "subscribe" %}
+		{% endifequal %}
+		{% ifequal s.action -1 %}
+			{% trans "unsubscribe" %}
+		{% endifequal %}
+              </td>
+		<td>{{ s.device.name }}</td>
+	</tr>
+       {% endfor %}
+  </table>
+  <br /><br />
+  <a href="/">{% trans "back!" %}</a> 
+{% endblock %}
+
diff --git a/mygpo/web/templates/subscriptionhistory.html b/mygpo/web/templates/subscriptionhistory.html
deleted file mode 100644
index 924c510..0000000
--- a/mygpo/web/templates/subscriptionhistory.html
+++ /dev/null
@@ -1,30 +0,0 @@
-{% extends "base.html" %}
-{% load i18n %}
-
-{% block content %}
-  <h1>{% trans "Subscription History" %}: {{ podcastname }}</h1>
-  <table class="list">
-	<tr>
-		<th>{% trans "Timestamp" %}</th>
-              <th>{% trans "Action" %}</th>
-		<th>{% trans "Devices" %}</th>
-	</tr>
-       {% for s in subscriptionhistorylist %}
-	<tr>
-		<td>{{ s.timestamp }}</td>
-		<td>
-		{% ifequal s.action 1 %}
-			{% trans "subscribe" %}
-		{% endifequal %}
-		{% ifequal s.action -1 %}
-			{% trans "unsubscribe" %}
-		{% endifequal %}
-              </td>
-		<td>{{ s.device }}</td>
-	</tr>
-       {% endfor %}
-  </table>
-  <br /><br />
-  <a href="/">{% trans "back!" %}</a> 
-{% endblock %}
-
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 698e91e..cd0fa71 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -53,24 +53,14 @@ def create_subscriptionlist(request):
     return l.values()
 
 
-def create_subscriptionhistory(request, pid): 
-    podcastname = Podcast.objects.filter(id=pid).values_list('title', flat=True)
-    sublog = SubscriptionAction.objects.filter(podcast__id = pid).order_by('-timestamp')
-    subscriptionhistorylist = [{'timestamp': s.timestamp.strftime('%d.%m.%Y %H:%M'), 'device_id': s.device_id, 'action': s.action} for s in sublog]
-    for index, entry in enumerate(subscriptionhistorylist):
-        dev = Device.objects.filter(id=subscriptionhistorylist[index]['device_id']).values_list('name', flat=True)
-        subscriptionhistorylist[index]['device'] = ''
-            
-        for i, d in enumerate(dev):
-            if i == 0:
-               subscriptionhistorylist [index]['device'] += d
-            else:
-               subscriptionhistorylist [index]['device'] += ", "  + d 
-
-    return render_to_response('subscriptionhistory.html', {
-                    'subscriptionhistorylist': subscriptionhistorylist,
-                    'podcastname': podcastname[0]
-              }, context_instance=RequestContext(request))
+def podcast(request, pid):
+    podcast = Podcast.objects.get(pk=pid)
+    devices = Device.objects.filter(user=request.user)
+    history = SubscriptionAction.objects.filter(podcast=podcast,device__in=devices).order_by('-timestamp')
+    return render_to_response('podcast.html', {
+        'history': history,
+        'podcast': podcast
+    }, context_instance=RequestContext(request))
 
 
 def account(request):

commit 1ed9168d8d9462e941709bcc5c415eb2a7453333
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 19 17:33:35 2009 +0100

    fixing subscription list

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index 8dd2fdb..bd2495c 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -13,13 +13,17 @@
        {% for s in subscriptionlist %}
 	<tr>
 		<td> 
-                  {% if s.logo %}
-                  <img src="{{ s.logo }}" style="width:40px; height:30px;" />
+                  {% if s.podcast.logo_url %}
+                  <img src="{{ s.podcast.logo_url }}" style="width:40px; height:30px;" />
                   {% endif %}                  
               </td>
-		<td style="font-weight:bold"><a class="listlink" href="/podcast/{{ s.id }}">{{ s.title }}</a></td>
+		<td style="font-weight:bold"><a class="listlink" href="/podcast/{{ s.podcast.id }}">{{ s.podcast }}</a></td>
+    {% if s.episode %}
 		<td>{{ s.episode }}</td>
-		<td>{{ s.device }}</td>
+    {% else %}
+      <td></td>
+    {% endif %}
+		<td>{{ s.devices|join:", " }}</td>
 	</tr>
        {% endfor %}
   </table>
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 904ef32..698e91e 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -19,7 +19,7 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect, HttpResponse
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
-from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry
+from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry, Subscription
 from mygpo.web.forms import UserAccountForm
 from mygpo.api.opml import Exporter
 from django.utils.translation import ugettext as _
@@ -39,33 +39,19 @@ def home(request):
               })
 
 def create_subscriptionlist(request):
-      userid = UserProfile.objects.filter(user=request.user)[0].id
-      device = Device.objects.filter(user__id=userid)
-      device_ids = [d.id for d in device]
-      sublog = SubscriptionAction.objects.filter(device__in=device_ids)
-      sublog_podcastids = [s.podcast_id for s in sublog]
-
-      podcast = Podcast.objects.filter(id__in=sublog_podcastids).order_by('title')
-      subscriptionlist = [{'title': p.title, 'logo': p.logo_url, 'id': p.id} for p in podcast]
-
-      for index, entry in enumerate(subscriptionlist):
-            sublog_for_device = SubscriptionAction.objects.filter(podcast__id=subscriptionlist[index]['id'])
-            sublog_devids = [s.device.id for s in sublog_for_device]
-            dev = Device.objects.filter(id__in=sublog_devids, user__id=userid).values_list('name', flat=True)
-            latest_actions = EpisodeAction.objects.filter(episode__podcast__id=subscriptionlist[index]['id']).order_by('-timestamp')
-            subscriptionlist[index]['episode'] = ''            
-            if latest_actions.count() > 0:
-                 episode = latest_actions[0].episode.title
-                 timestamp = latest_actions[0].timestamp.strftime('%d.%m.%Y %H:%M')
-                 subscriptionlist[index]['episode'] += episode + ", " + timestamp
-            subscriptionlist[index]['device'] = ''
-            
-            for i, d in enumerate(dev):
-                 if i == 0:
-                       subscriptionlist[index]['device'] += d
-                 else:
-                       subscriptionlist[index]['device'] += ", "  + d           
-      return subscriptionlist
+    subscriptions = Subscription.objects.filter(user=request.user)
+    l = {}
+    for s in subscriptions:
+        if s.podcast in l:
+            l[s.podcast]['devices'].append(s.device.name)
+        else:
+            e = Episode.objects.filter(podcast=s.podcast).order_by('-timestamp')
+            episode = e[0] if e.count() > 0 else None
+            devices = [s.device.name]
+            l[s.podcast] = {'podcast': s.podcast, 'episode': episode, 'devices': devices}
+
+    return l.values()
+
 
 def create_subscriptionhistory(request, pid): 
     podcastname = Podcast.objects.filter(id=pid).values_list('title', flat=True)

commit e1e777b3c3fbc9fbd8081e76ae311d968d9ed2fb
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sat Dec 19 17:29:37 2009 +0100

    new update_toplist

diff --git a/install/update-07.sql b/install/update-07.sql
index d713103..49d866d 100644
--- a/install/update-07.sql
+++ b/install/update-07.sql
@@ -29,7 +29,7 @@ BEGIN
                             FROM public_subscription) a
                         GROUP BY podcast_id);
             DELETE FROM toplist;
-            INSERT INTO toplist (podcast_id, subscription_count, id) VALUES (SELECT podcast_id, subscription_count, NULL FROM toplist_temp
+            INSERT INTO toplist (podcast_id, subscription_count, id) (SELECT podcast_id, subscription_count, NULL FROM toplist_temp
                         ORDER BY subscription_count DESC LIMIT 100);
 
             COMMIT;

commit 06d966203daf3bd5f5a83cb019265fb3425e65f3
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sat Dec 19 17:18:07 2009 +0100

    id in toplist

diff --git a/install/update-07.sql b/install/update-07.sql
index 4b324ed..d713103 100644
--- a/install/update-07.sql
+++ b/install/update-07.sql
@@ -29,7 +29,7 @@ BEGIN
                             FROM public_subscription) a
                         GROUP BY podcast_id);
             DELETE FROM toplist;
-            INSERT INTO toplist (podcast_id, subscription_count) VALUES (SELECT podcast_id, subscription_count FROM toplist_temp
+            INSERT INTO toplist (podcast_id, subscription_count, id) VALUES (SELECT podcast_id, subscription_count, NULL FROM toplist_temp
                         ORDER BY subscription_count DESC LIMIT 100);
 
             COMMIT;

commit d32d2b652649ea1d6bdb6a2037c935936e07a7d7
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 19 17:07:21 2009 +0100

    fixing toplist-update procedure

diff --git a/install/update-07.sql b/install/update-07.sql
new file mode 100644
index 0000000..4b324ed
--- /dev/null
+++ b/install/update-07.sql
@@ -0,0 +1,51 @@
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_toplist $$
+CREATE PROCEDURE update_toplist()
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+        DECLARE attempts INT DEFAULT 0;
+
+    DROP TABLE IF EXISTS toplist_temp;
+    CREATE TABLE toplist_temp (
+            podcast_id INT PRIMARY KEY REFERENCES podcast (id),
+            subscription_count INT NOT NULL DEFAULT 0,
+            INDEX(podcast_id)
+    );
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+        DECLARE deadlock_detected CONDITION FOR 1213;
+            DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+            SET deadlock=0;
+
+            START TRANSACTION;
+            DELETE FROM toplist_temp;
+            INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription
+                        FROM (SELECT DISTINCT podcast_id, user_id
+                            FROM public_subscription) a
+                        GROUP BY podcast_id);
+            DELETE FROM toplist;
+            INSERT INTO toplist (podcast_id, subscription_count) VALUES (SELECT podcast_id, subscription_count FROM toplist_temp
+                        ORDER BY subscription_count DESC LIMIT 100);
+
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Toplist is not updated!');
+        END IF;
+        DROP TABLE IF EXISTS toplist_temp;
+
+END $$
+DELIMITER ;
+

commit 4340b2dcb10e7fe720d9192835d2eebf09cb2790
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 19 16:56:25 2009 +0100

    added column toplist.id

diff --git a/install/update-06.sql b/install/update-06.sql
new file mode 100644
index 0000000..ff4418a
--- /dev/null
+++ b/install/update-06.sql
@@ -0,0 +1,2 @@
+ALTER TABLE toplist ADD COLUMN id INTEGER UNIQUE AUTO_INCREMENT;
+

commit ac45d7f5d245f45065384cf37c9abf95a52a239f
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 19 16:08:05 2009 +0100

    updated styles of subcription history

diff --git a/mygpo/web/templates/subscriptionhistory.html b/mygpo/web/templates/subscriptionhistory.html
index 98a8da4..924c510 100644
--- a/mygpo/web/templates/subscriptionhistory.html
+++ b/mygpo/web/templates/subscriptionhistory.html
@@ -3,7 +3,7 @@
 
 {% block content %}
   <h1>{% trans "Subscription History" %}: {{ podcastname }}</h1>
-  <table class="subscriptionlist" style="width:100%;">
+  <table class="list">
 	<tr>
 		<th>{% trans "Timestamp" %}</th>
               <th>{% trans "Action" %}</th>

commit 8a7fdf7fdee22c446678ece8da60b277a548b25f
Merge: 4e0979a... 3cc08c0...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 19 16:04:37 2009 +0100

    Merge branch 'master' of dgpo:~armin/mygpo-src
    
    Conflicts:
    	htdocs/media/screen.css
    	mygpo/web/templates/home-user.html
    	mygpo/web/views.py

commit 4e0979aad1b6c77b4f89faa0a9dbc6533cf74f6b
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Dec 19 15:49:46 2009 +0100

    move update of subscription_log.action to update-03.sql
    
    the sql commands have already been executed with update-03.sql

diff --git a/install/update-03.sql b/install/update-03.sql
index 99c8430..3446360 100644
--- a/install/update-03.sql
+++ b/install/update-03.sql
@@ -132,4 +132,10 @@ create index action_index on subscription_log(action);
 create index timestamp_index on subscription_log(timestamp);
 create index device_index on subscription_log(device_id);
 
+-- converting the column subscription_log.action from varchar to tinyint(1)
+alter table subscription_log add column action_tmp tinyint(1);
+update subscription_log set action_tmp = 1 where action = 'subscribe';
+update subscription_log set action_tmp = -1 where action = 'unsubscribe';
+alter table subscription_log drop column action;
+alter table subscription_log change action_tmp action tinyint(1);
 
diff --git a/install/update-04.sql b/install/update-04.sql
index dc5090b..ae62699 100644
--- a/install/update-04.sql
+++ b/install/update-04.sql
@@ -54,13 +54,6 @@ BEGIN
 END $$
 DELIMITER ;
 
--- converting the column subscription_log.action from varchar to tinyint(1)
-alter table subscription_log add column action_tmp tinyint(1);
-update subscription_log set action_tmp = 1 where action = 'subscribe';
-update subscription_log set action_tmp = -1 where action = 'unsubscribe';
-alter table subscription_log drop column action;
-alter table subscription_log change action_tmp action tinyint(1);
-
 CREATE UNIQUE INDEX unique_subscription_log ON subscription_log (device_id, podcast_id, timestamp);
 CREATE UNIQUE INDEX unique_episode_lg ON episode_log (user_id, episode_id, timestamp);
 

commit 3cc08c0800d924c2817cf4bf6231a15b0feeecfb
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Fri Dec 18 00:17:17 2009 +0100

    Added Subscription History, i18n in subscription list, layout bug
    :

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index caca843..cd8ded8 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -36,3 +36,22 @@ ul#navigation
     padding: 0;
 }
 
+table.subscriptionlist {
+   border-collapse:collapse;
+}
+
+table.subscriptionlist th {
+   border-bottom: 1px solid #b3b3b3;
+   font-weight:bold;
+   color:#b3b3b3;
+   font-style:italic;
+   text-align:left;
+}
+
+a.listlink {
+   color:#b3b3b3;
+}
+
+a.listlink:hover {
+   text-decoration:underline;
+}
\ No newline at end of file
diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index e5e6549..7fd4c26 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -20,9 +20,45 @@ msgstr ""
 msgid "Your Subscriptions"
 msgstr "Deine Abonnements"
 
-#: web/templates/home-user.html:6
-msgid "This page is currently in development."
-msgstr "Diese Seite befindet sich im Aufbau."
+#: web/templates/home-user.html:9
+msgid "Title"
+msgstr "Titel"
+
+#: web/templates/home-user.html:10
+msgid "Latest Episode"
+msgstr "Letzte Episode"
+
+#: web/templates/home-user.html:11
+msgid "Devices"
+msgstr "Gerte"
+
+#: web/templates/subscriptionhistory.html:5
+msgid "Subscription History"
+msgstr "Abonnementverlauf"
+
+#: web/templates/subscriptionhistory.html:8
+msgid "Timestamp"
+msgstr "Zeitpunkt"
+
+#: web/templates/subscriptionhistory.html:9
+msgid "Action"
+msgstr "Aktivitt"
+
+#: web/templates/subscriptionhistory.html:10
+msgid "Devices"
+msgstr "Gerte"
+
+#: web/templates/subscriptionhistory.html:17
+msgid "subscribe"
+msgstr "abonniert"
+
+#: web/templates/subscriptionhistory.html:20
+msgid "unsubscribe"
+msgstr "beendet"
+
+#: web/templates/subscriptionhistory.html:28
+msgid "back!"
+msgstr "zurck!"
 
 #: web/templates/home.html:6
 msgid ""
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 54ffe19..03aff5b 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -37,6 +37,7 @@ urlpatterns = patterns('',
     (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/', 'form_class': RegistrationFormUniqueEmail}),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
     (r'^activate/(?P<activation_key>\w+)$', activate),
+    (r'^podcast/(?P<pid>\w+)$', 'mygpo.web.views.create_subscriptionhistory'),
 
     (r'account/$', 'mygpo.web.views.account'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index fe1b737..d1a6a32 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -3,13 +3,12 @@
 
 {% block content %}
   <h1>{% trans "Your Subscriptions" %}</h1>
-  <p>{% trans "This page is currently in development." %}</p>
   <table class="subscriptionlist" style="width:100%;">
 	<tr>
-		<th style="padding-right:100px;">&nbsp;</th>
-		<th class="subscription" style="padding-right:200px;">Title</th>
-		<th style="padding-right:200px;">Latest Episode</th>
-		<th style="padding-right:200px;">Devices</th>
+		<th>&nbsp;</th>
+		<th class="subscription" style="padding-right:200px;">{% trans "Title" %}</th>
+		<th>{% trans "Latest Episode" %}</th>
+		<th>{% trans "Devices" %}</th>
 	</tr>
        {% for s in subscriptionlist %}
 	<tr>
@@ -18,7 +17,7 @@
                   <img src="{{ s.logo }}" style="width:40px; height:30px;" />
                   {% endif %}                  
               </td>
-		<td style="font-weight:bold">{{ s.title }}</td>
+		<td style="font-weight:bold"><a class="listlink" href="/podcast/{{ s.id }}">{{ s.title }}</a></td>
 		<td>{{ s.episode }}</td>
 		<td>{{ s.device }}</td>
 	</tr>
diff --git a/mygpo/web/templates/subscriptionhistory.html b/mygpo/web/templates/subscriptionhistory.html
new file mode 100644
index 0000000..98a8da4
--- /dev/null
+++ b/mygpo/web/templates/subscriptionhistory.html
@@ -0,0 +1,30 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>{% trans "Subscription History" %}: {{ podcastname }}</h1>
+  <table class="subscriptionlist" style="width:100%;">
+	<tr>
+		<th>{% trans "Timestamp" %}</th>
+              <th>{% trans "Action" %}</th>
+		<th>{% trans "Devices" %}</th>
+	</tr>
+       {% for s in subscriptionhistorylist %}
+	<tr>
+		<td>{{ s.timestamp }}</td>
+		<td>
+		{% ifequal s.action 1 %}
+			{% trans "subscribe" %}
+		{% endifequal %}
+		{% ifequal s.action -1 %}
+			{% trans "unsubscribe" %}
+		{% endifequal %}
+              </td>
+		<td>{{ s.device }}</td>
+	</tr>
+       {% endfor %}
+  </table>
+  <br /><br />
+  <a href="/">{% trans "back!" %}</a> 
+{% endblock %}
+
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 3da1cde..e14683f 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -65,6 +65,25 @@ def create_subscriptionlist(request):
                        subscriptionlist[index]['device'] += ", "  + d           
       return subscriptionlist
 
+def create_subscriptionhistory(request, pid): 
+    podcastname = Podcast.objects.filter(id=pid).values_list('title', flat=True)
+    sublog = SubscriptionAction.objects.filter(podcast__id = pid).order_by('-timestamp')
+    subscriptionhistorylist = [{'timestamp': s.timestamp.strftime('%d.%m.%Y %H:%M'), 'device_id': s.device_id, 'action': s.action} for s in sublog]
+    for index, entry in enumerate(subscriptionhistorylist):
+        dev = Device.objects.filter(id=subscriptionhistorylist[index]['device_id']).values_list('name', flat=True)
+        subscriptionhistorylist[index]['device'] = ''
+            
+        for i, d in enumerate(dev):
+            if i == 0:
+               subscriptionhistorylist [index]['device'] += d
+            else:
+               subscriptionhistorylist [index]['device'] += ", "  + d 
+
+    return render_to_response('subscriptionhistory.html', {
+                    'subscriptionhistorylist': subscriptionhistorylist,
+                    'podcastname': podcastname[0]
+              }, context_instance=RequestContext(request))
+
 
 def account(request):
     success = False
@@ -91,8 +110,3 @@ def account(request):
         'success': success
     }, context_instance=RequestContext(request))
 
-
-#sl = SubscriptionAction.objects.filter(podcast=podcast_ids[listindex])
-#sldev_ids = [s.device.id for s in sl]  
-#dev = Device.objects.filter(id__in=sldev_ids)
-#dev_names = [d.name for d in dev]

commit 2a1eaa3201079b5191ca0e6f85e75d8507fe2b5f
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 16 15:46:00 2009 +0100

    add info about opml-toplist on web-toplist
    
    using new style .info, added to style-guide

diff --git a/doc/style-guide.html b/doc/style-guide.html
index 4a69fcd..78763e0 100644
--- a/doc/style-guide.html
+++ b/doc/style-guide.html
@@ -62,6 +62,9 @@
     </tr>
    </table>
 
+   <div class="info">This style can be used to style infos and remarks. CSS-Class: <strong>info</strong></div>
+
+
   </div>
   <div id="navigation">
    <span class="spacer1">&nbsp;</span>
diff --git a/htdocs/media/info.png b/htdocs/media/info.png
new file mode 100644
index 0000000..c3c07e1
Binary files /dev/null and b/htdocs/media/info.png differ
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 8850f2c..7362c95 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -28,6 +28,24 @@ table.register th {
     margin: .5em;
 }
 
+.info
+{
+    background-color: #7277d8;
+    border: #080e73 thin solid;
+    width: 100%;
+    padding: 1em 1em 1em 45px;
+    background-image: url('info.png');
+    background-repeat: no-repeat;
+    background-position: 3px 50%;
+    margin: .5em;
+}
+
+.info a
+{
+    color: black;
+}
+
+
 #menu a
 {
     color: black;
diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
index e95e8b3..431219b 100644
--- a/mygpo/web/templates/toplist.html
+++ b/mygpo/web/templates/toplist.html
@@ -21,5 +21,6 @@
   {% endfor %}
   </table>
 
+  <div class="info"><strong>Get the toplist from your Client</strong>! Access <a href="http://my.gpodder.org/toplist/30.opml">http://my.gpodder.org/toplist/30.opml</a> for the Top-30.</div>
 {% endblock %}
 

commit 9e2ea7c493db4b73cc654f263b52b58a933da8cf
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 16 15:38:03 2009 +0100

    added home link in navigation

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 4391127..f352991 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -60,6 +60,7 @@
    <span class="spacer1">&nbsp;</span>
    <span class="spacer2">&nbsp;</span>
    <ul id="menu">
+    <li><a href="/">Home</a></li>
     {% if user.is_authenticated %}
      <li>logged in as {{ user.username }}</li>
      <li><a href="/account/">Account settings</a></li>

commit fd47779d2fcd5a0275f67516b17c3f0b0bd166c9
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 16 15:37:00 2009 +0100

    added link to toplist in base.html

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index c6abec9..4391127 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -59,17 +59,16 @@
   <div id="navigation">
    <span class="spacer1">&nbsp;</span>
    <span class="spacer2">&nbsp;</span>
-   {% if user.is_authenticated %}
-    <ul id="menu">
+   <ul id="menu">
+    {% if user.is_authenticated %}
      <li>logged in as {{ user.username }}</li>
      <li><a href="/account/">Account settings</a></li>
      <li><a href="/logout/">logout!</a></li>
-    </ul>
-   {% else %}
-    <ul id="menu">
+    {% else %}
      <li><a href="/login/">login!</a></li>
-    </ul>
-   {% endif %}
+    {% endif %}
+    <li><a href="/toplist/">Podcast-Toplist</a></li>
+   </ul>
   </div>
 
   <hr style="clear: both;">

commit f7002535e7bc8e9087652ed8d40d4e663524b981
Merge: e6b6ba6... 036bab9...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 15 00:10:30 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit e6b6ba645732f8bb6524c1f93407ba70d15f2ea4
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 15 00:04:38 2009 +0100

    table.list{ width: 100%; }

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index a8d496f..8850f2c 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -46,6 +46,7 @@ table.list
     margin-top: 2em;
     font-size: 1em;
     border-collapse: collapse;
+    width: 100%;
 }
 
 table.list th

commit e7cd42bbf0e709cfab001a9fd8fc773a85d5ad3d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 15 00:02:33 2009 +0100

    simplified layout of subscription list

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index fe1b737..6f02f36 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -4,12 +4,12 @@
 {% block content %}
   <h1>{% trans "Your Subscriptions" %}</h1>
   <p>{% trans "This page is currently in development." %}</p>
-  <table class="subscriptionlist" style="width:100%;">
+  <table class="list">
 	<tr>
-		<th style="padding-right:100px;">&nbsp;</th>
-		<th class="subscription" style="padding-right:200px;">Title</th>
-		<th style="padding-right:200px;">Latest Episode</th>
-		<th style="padding-right:200px;">Devices</th>
+		<th>&nbsp;</th>
+		<th>Title</th>
+		<th>Latest Episode</th>
+		<th>Devices</th>
 	</tr>
        {% for s in subscriptionlist %}
 	<tr>

commit aa0ad181d9e6225c5af0da60234a030fb4eab14c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 23:47:25 2009 +0100

    style guide for tables

diff --git a/doc/style-guide.html b/doc/style-guide.html
index 1fd091f..4a69fcd 100644
--- a/doc/style-guide.html
+++ b/doc/style-guide.html
@@ -49,6 +49,19 @@
 
    <div class="error">Use such boxes to indicate failure. CSS-Class: <strong>error</strong></div>
 
+   <table class="list">
+    <tr>
+     <th>Column 1</th>
+     <th>Column 2</td>
+     <th>Numeric column</th>
+    </tr>
+    <tr>
+     <td>This is a sample list table</td>
+     <td>You can indicate numeric columns like this:</td>
+     <td class="numeric">1234</td>
+    </tr>
+   </table>
+
   </div>
   <div id="navigation">
    <span class="spacer1">&nbsp;</span>
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index a7f8be2..a8d496f 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -41,3 +41,28 @@ ul#menu
     padding: 0;
 }
 
+table.list
+{
+    margin-top: 2em;
+    font-size: 1em;
+    border-collapse: collapse;
+}
+
+table.list th
+{
+    text-align: left;
+    border-bottom: thin solid black;
+    padding: 0;
+    margin: 0;
+}
+
+table.list th,
+table.list td
+{
+    padding-right: 1em;
+}
+
+table td.numeric
+{
+    text-align: right;
+}

commit 036bab9d7d613201ab5be9aabe437f5fc3f6ff18
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Dec 14 20:18:54 2009 +0100

    Suggestion python

diff --git a/mygpo/api/update_UserSuggestion.py b/mygpo/api/update_UserSuggestion.py
new file mode 100644
index 0000000..2f6198d
--- /dev/null
+++ b/mygpo/api/update_UserSuggestion.py
@@ -0,0 +1,22 @@
+#!/usr/bin/python
+
+import sys
+import MySQLdb
+
+
+try:
+    mysql = MySQLdb.connect(user="mygpo_prod",passwd="",db="mygpo_prod")
+    mysql_cursor = mysql.cursor() 
+    
+    mysql_cursor.callproc( "update_suggestion_for", (sys.argv[1]) )
+    
+    mysql_cursor.close() 
+    mysql.close()
+
+except MySQLdb.Error, e:
+    print "MySQL Error %d:  %s" % ( e.args[0], e.args[1] )
+    sys.exit(1)
+
+except IndexError, e:
+    print "Usage: python update_UserSuggestion.py [User_id]"
+    sys.exit(1)
diff --git a/mygpo/api/update_allSuggestion.py b/mygpo/api/update_allSuggestion.py
new file mode 100644
index 0000000..d61ec11
--- /dev/null
+++ b/mygpo/api/update_allSuggestion.py
@@ -0,0 +1,17 @@
+#!/usr/bin/python
+
+import sys
+import MySQLdb
+
+try:
+    mysql = MySQLdb.connect(user="mygpo_prod",passwd="",db="mygpo_prod")
+    mysql_cursor = mysql.cursor() 
+    
+    mysql_cursor.callproc( "update_suggestion", () )
+    
+    mysql_cursor.close() 
+    mysql.close()
+
+except MySQLdb.Error, e:
+    print "MySQL Error %d:  %s" % ( e.args[0], e.args[1] )
+    sys.exit(1)

commit fd794f0624d1160dc3cdf5caedf18ebd208fbab5
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Dec 14 20:17:06 2009 +0100

    Suggestion

diff --git a/install/update-05.sql b/install/update-05.sql
index 38c55d0..8668013 100644
--- a/install/update-05.sql
+++ b/install/update-05.sql
@@ -14,8 +14,10 @@ BEGIN
     DECLARE attempts INT DEFAULT 0;
     DECLARE done INT DEFAULT 0;
     DECLARE user_help INT DEFAULT 0;
+    DECLARE pod_count INT DEFAULT 0;
     DECLARE cur1 CURSOR FOR SELECT user_ptr_id FROM user;
     DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
+    
 
 
     DROP TABLE IF EXISTS suggestion_pod;
@@ -44,17 +46,24 @@ BEGIN
             REPEAT
                 FETCH cur1 INTO user_help;
 
-            IF NOT done THEN
+                IF NOT done THEN
                     DELETE FROM suggestion_pod;
                     DELETE FROM suggestion_user;
 select user_help;
                     insert into suggestion_pod (select podcast_id from public_subscription where user_id=user_help);
-                    insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
-                    insert into suggestion (select user_help, podcast_id, count(podcast_id) as priority 
+
+                    SELECT count(*) into pod_count FROM suggestion_pod;
+
+                    IF pod_count > 0 THEN
+                        insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
+                        insert into suggestion (select user_help, podcast_id, count(podcast_id) as priority 
                                      from public_subscription, suggestion_user 
                                      where user_id=userID and podcast_id not in (select * from suggestion_pod) 
                                      group by user_help, podcast_id order by priority DESC LIMIT 10);
-         
+                    ELSE
+                        insert into suggestion (select user_help, podcast_id, subscription_count as priority from toplist 
+                                     group by user_help, podcast_id order by subscription_count DESC LIMIT 10);
+                    END IF;
                 END IF;
             UNTIL done END REPEAT;
 
@@ -85,6 +94,7 @@ CREATE PROCEDURE update_suggestion_for(IN user_par INT)
 BEGIN
     DECLARE deadlock INT DEFAULT 0;
     DECLARE attempts INT DEFAULT 0;
+    DECLARE pod_count INT DEFAULT 0;
         
     DROP TABLE IF EXISTS suggestion_pod;
     CREATE TABLE suggestion_pod (
@@ -112,12 +122,19 @@ BEGIN
             DELETE FROM suggestion_user;
 
             insert into suggestion_pod (select podcast_id from public_subscription where user_id=user_par);
-            insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
-            insert into suggestion (select user_par, podcast_id, count(podcast_id) as priority 
+	    
+            SELECT count(*) into pod_count FROM suggestion_pod;
+
+            IF pod_count > 0 THEN
+                insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
+                insert into suggestion (select user_par, podcast_id, count(podcast_id) as priority 
                                      from public_subscription, suggestion_user 
                                      where user_id=userID and podcast_id not in (select * from suggestion_pod) 
                                      group by user_par, podcast_id order by priority DESC LIMIT 10);
-         
+            ELSE
+                insert into suggestion (select user_par, podcast_id, subscription_count as priority from toplist 
+                group by user_par, podcast_id order by subscription_count DESC LIMIT 10);
+            END IF;
             COMMIT;
         END;
         IF deadlock=0 THEN

commit 4a20a854abd4cb6f49e36ad089834ffb47adea5b
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Dec 14 19:32:22 2009 +0100

    delete doku.txt

diff --git a/install/doku.txt b/install/doku.txt
deleted file mode 100644
index db97095..0000000
--- a/install/doku.txt
+++ /dev/null
@@ -1,86 +0,0 @@
-Dokumentation der Empfehlungen
-
-User_id:	1
-Zeit:		1 min 53.25 sec
-+------------+----------+
-| podcast_id | priority |
-+------------+----------+
-|      11093 |       42 | 
-|      11092 |       19 | 
-|      11094 |       18 | 
-|      11096 |       13 | 
-|      11205 |       11 | 
-|      11090 |       10 | 
-|      11091 |        9 | 
-|      11207 |        9 | 
-|      11211 |        8 | 
-|      11206 |        8 | 
-+------------+----------+
-
-
-
-User_id: 	5
-Zeit:		1 min 52.65 sec
-+------------+----------+
-| podcast_id | priority |
-+------------+----------+
-|      11094 |      224 | 
-|      11207 |      108 | 
-|      11200 |       88 | 
-|      11092 |       69 | 
-|      11206 |       60 | 
-|      11210 |       50 | 
-|      11179 |       50 | 
-|      11175 |       47 | 
-|      11174 |       37 | 
-|      11171 |       36 | 
-+------------+----------+
-
-
-User_id: 	23
-Zeit:		1 min 47.44 sec
-+------------+----------+
-| podcast_id | priority |
-+------------+----------+
-|      11094 |      224 | 
-|      11207 |      108 | 
-|      11200 |       88 | 
-|      11092 |       69 | 
-|      11206 |       60 | 
-|      11210 |       50 | 
-|      11179 |       50 | 
-|      11175 |       47 | 
-|      11174 |       37 | 
-|      11171 |       36 | 
-+------------+----------+
-
-User_id: 	3333
-Zeit:		1 min 49.99 sec
-
-Empty set 
-
-select count(*) from public_subscription where user_id=3333;
-+----------+
-| count(*) |
-+----------+
-|        0 | 
-+----------+
-
-User_id: 	2323
-Zeit:		1 min 57.31 sec
-+------------+----------+
-| podcast_id | priority |
-+------------+----------+
-|      11189 |       55 | 
-|      11191 |       27 | 
-|      11192 |       23 | 
-|      11205 |       21 | 
-|      11207 |       18 | 
-|      11094 |       18 | 
-|      11190 |       16 | 
-|      11211 |       13 | 
-|      11174 |       12 | 
-|      11200 |       12 | 
-+------------+----------+
-
-

commit 0658ad7b7a08ca5bf447310868909bac0dbd2f6c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 18:50:50 2009 +0100

    added style guide, rewrite css-class error

diff --git a/doc/style-guide.html b/doc/style-guide.html
new file mode 100644
index 0000000..1fd091f
--- /dev/null
+++ b/doc/style-guide.html
@@ -0,0 +1,66 @@
+<html>
+ <head>
+<!--
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+-->
+  <title>my.gpodder.org Style Guide</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+  <link rel="shortcut icon" href="http://gpodder.org/favicon.png">
+  <link rel="stylesheet" href="../htdocs/media/screen.css" type="text/css" />
+  <link rel="stylesheet" href="../htdocs/media/screen-base.css" type="text/css" />
+ </head>
+ <body>
+  <h1 id="logo">
+   <strong><img alt="gPodder" title="gPodder" src="http://gpodder.org/images/weblogo64.png" /></strong>
+  </h1>
+  <div id="topnav">
+   <ul id="gpodder-menu">
+    <li><a href="http://gpodder.org/"><img src="http://gpodder.org/images/icons/go-home.png" alt="">Home</a></li>
+    <li><a href="http://gpodder.org/news.html"><img src="http://gpodder.org/images/icons/accessories-text-editor.png" alt="">News</a></li>
+    <li><a href="http://gpodder.org/downloads.html"><img src="http://gpodder.org/images/icons/package-x-generic.png" alt="">Download</a></li>
+    <li><a href="http://gpodder.org/documentation.html"><img src="http://gpodder.org/images/icons/help-browser.png" alt="">Help</a></li>
+    <li><a href="http://bugs.gpodder.org/"><img src="http://gpodder.org/images/icons/dialog-warning.png" alt="">Bugs</a></li>
+    <li><strong><img src="http://gpodder.org/images/icons/mygpo.png" alt="">Web Service</strong></li>
+   </ul>
+  </div>
+
+  <hr>
+
+  <div id="body">
+
+    <h1>my.gpodder.org Style Guide</h1>
+
+    <div class="success">Such boxes can be used to indicate the successful competion of some action. CSS-Class: <strong>success</strong></div>
+
+   <div class="error">Use such boxes to indicate failure. CSS-Class: <strong>error</strong></div>
+
+  </div>
+  <div id="navigation">
+   <span class="spacer1">&nbsp;</span>
+   <span class="spacer2">&nbsp;</span>
+    <ul id="menu">
+     <li></li>
+    </ul>
+  </div>
+
+  <hr style="clear: both;">
+
+  <address> 2005-2009 <a class="noextlink" href="http://thpinfo.com/">Thomas Perl</a> andthe gPodder Team</address>
+ </body>
+</html>
+
diff --git a/htdocs/media/dialog-error.png b/htdocs/media/dialog-error.png
new file mode 100644
index 0000000..e71bba3
Binary files /dev/null and b/htdocs/media/dialog-error.png differ
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 371634c..a7f8be2 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -1,9 +1,13 @@
 div.error
 {
-    border: thin solid: #7d0c0c;
-    padding: 2em;
-    font-weight: bold;
-    color: #c20000;
+    background-color: #fa7080;
+    border: #f5001d thin solid;
+    width: 100%;
+    padding: 1em 1em 1em 45px;
+    background-image: url('dialog-error.png');
+    background-repeat: no-repeat;
+    background-position: 3px 50%;
+    margin: .5em;
 }
 
 table.register th {
@@ -21,6 +25,7 @@ table.register th {
     background-image: url('emblem-default.png');
     background-repeat: no-repeat;
     background-position: 3px 50%;
+    margin: .5em;
 }
 
 #menu a

commit 62ced32df66f4a576de702214c46c77b26f82686
Merge: 0fae7d3... f2967eb...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 18:42:01 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit f2967eb6d371d155586b91f9543c4e48ef792174
Merge: e96731d... e840f64...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 18:40:03 2009 +0100

    Merge branch 'master' of ~/mygpo-src

commit e96731def83924c65e834525595a6ea4edc4fd4d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 18:39:14 2009 +0100

    cleaning up base.html

diff --git a/htdocs/media/screen-base.css b/htdocs/media/screen-base.css
new file mode 100644
index 0000000..7f7b205
--- /dev/null
+++ b/htdocs/media/screen-base.css
@@ -0,0 +1,226 @@
+body 
+{ 
+    font-family: DeJaVu Sans, Bitstream Vera Sans, sans-serif; 
+    font-size: 12px; 
+    padding-left: 50px; 
+    padding-right: 50px;
+}
+
+h2 
+{ 
+    margin-top:0px;
+}
+
+h3 
+{ 
+    color: #535;
+}
+
+hr 
+{ 
+    border-width: 0px; 
+    border-bottom: 1px #aaa dotted; 
+}
+
+img 
+{ 
+    border-width: 0px; 
+}
+
+ul#gpodder-menu 
+{ 
+    margin: 10px;
+    padding-top: 10px; 
+    z-index: 900; 
+    text-align: center; 
+}
+
+ul#gpodder-menu li 
+{ 
+    display: inline; 
+    font-weight: bold; 
+    padding-right: 4px; 
+    margin-bottom: 5px; 
+}
+
+ul#gpodder-menu li a 
+{ 
+    text-decoration: none; 
+    color: rgb(70%, 70%, 70%); 
+    padding: 6px; 
+    border: 1px rgb(40%, 40%, 40%) solid; 
+    -moz-border-radius: 5px; 
+}
+
+ul#gpodder-menu li a:hover 
+{ 
+    color: rgb(10%, 10%, 10%); 
+    background-color: white; 
+    border-bottom: 1px rgb(60%, 60%, 60%) solid;
+    border-right: 1px rgb(40%, 60%, 40%) solid; 
+    border-left: 1px rgb(70%, 70%, 70%) solid;
+    border-top: 1px rgb(70%, 70%, 70%) solid; 
+}
+
+ul#gpodder-menu li strong 
+{ 
+    background-color: white; 
+    padding: 6px; 
+    border-top: 1px solid rgb(60%, 60%, 60%); 
+    border-left: 1px solid rgb(60%, 60%, 60%); 
+    border-bottom: 1px solid rgb(70%, 70%, 70%); 
+    color: black; -moz-border-radius: 5px;
+}
+
+ul#gpodder-menu li img 
+{ 
+    vertical-align: middle; 
+    padding-right: 2px; 
+}
+
+a 
+{ 
+    color: blue; 
+    text-decoration: none; 
+}
+
+a:hover 
+{ 
+    text-decoration: underline; 
+}
+
+p#version-info 
+{ 
+    position: absolute; 
+    top: 10px; 
+    right: 10px; 
+    text-align: right; 
+}
+
+ul.highlights 
+{ 
+    padding-left: 10px; 
+    list-style-type: none; 
+}
+
+ul.highlights strong 
+{ 
+    font-size: 13pt; 
+} 
+
+address 
+{
+    font-style: normal; 
+    color: #aaa; 
+    text-align:center;
+} 
+
+address a 
+{ 
+    color: #aaaaff; 
+}
+
+table.downloads td 
+{ 
+    background-color: #eee; 
+}
+
+a[href^="http://"]:after, a[href^="https://"]:after {
+    content: url(http://gpodder.org/images/external.png);
+    padding-left: 2px;
+}
+
+/* ..but not URLs linking to the bug tracker or mygpo */
+a[href^="http://gpodder.org"]:after, 
+a.noextlink:after,
+a.imgonlylink:after 
+{
+    content: '';
+    padding-left: 0px;
+}
+
+a[href^="http://bugs.gpodder.org"]:after, 
+a.noextlink:after,
+a.imgonlylink:after 
+{
+    content: '';
+    padding-left: 0px;
+}
+
+a[href^="http://my.gpodder.org"]:after,
+a.noextlink:after,
+a.imgonlylink:after 
+{
+    content: '';
+    padding-left: 0px;
+}
+
+#logo
+{
+    margin: 0px; 
+    padding: 0px; 
+    position: absolute; 
+    top: 0px; 
+    left: 20px; 
+    height: 70px; 
+    z-index: 100;
+}
+
+#logo img
+{
+    padding-top: 10px; 
+    width: 64px; 
+    height: 64px;
+}
+
+#topnav
+{
+    position: absolute; 
+    z-index: 10; 
+    top: 0px; 
+    left: 0px; 
+    right: 0px; 
+    background-color: rgb(102, 102, 102); 
+    padding-bottom: 10px;
+}
+
+#body
+{
+    margin-right: 5%; 
+    padding-top: 80px; 
+    padding-bottom: 10px; 
+    float:left; 
+    width: 70%
+}
+
+#navigation
+{
+    padding-top: 80px; 
+    width:200px; 
+    height:70%; 
+    margin-right:-58px; 
+    padding-bottom: 10px; 
+    float:right; 
+    background-color: rgb(102, 102, 102); 
+    -moz-border-radius-bottomleft: 30px;
+}
+
+#navigation .spacer1
+{
+    width:20px; 
+    position:absolute; 
+    margin-top:-32px; 
+    margin-left:-20px; 
+    background-color:rgb(102, 102, 102);
+}
+
+#navigation .spacer2
+{
+    width:20px; 
+    position:absolute; 
+    margin-top:-32px; 
+    margin-left:-20px; 
+    -moz-border-radius-topright: 30px; 
+    background-color:rgb(255,255,255);
+}
+
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index caca843..371634c 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -23,12 +23,12 @@ table.register th {
     background-position: 3px 50%;
 }
 
-#navigation a
+#menu a
 {
     color: black;
 }
 
-ul#navigation
+ul#menu
 {
     list-style-type: none;
     margin: 1em;
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index f5071f8..c6abec9 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -1,4 +1,5 @@
-<html><head>
+<html>
+ <head>
 <!--
 #
 # This file is part of my.gpodder.org.
@@ -21,93 +22,59 @@
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <link rel="shortcut icon" href="http://gpodder.org/favicon.png">
   <link rel="stylesheet" href="/media/screen.css" type="text/css" />
-  <style type="text/css">
-      	body { font-family: DeJaVu Sans, Bitstream Vera Sans, sans-serif; font-size: 12px; padding-left: 50px; padding-right: 50px;}
-	h2 { margin-top:0px;}
-      	h3 { color: #535;}
-        hr { border-width: 0px; border-bottom: 1px #aaa dotted; }
-        img { border-width: 0px; }
-        ul#gpodder-menu { margin: 10px; padding-top: 10px; z-index: 900; text-align: center; }
-        ul#gpodder-menu li { display: inline; font-weight: bold; padding-right: 4px; margin-bottom: 5px; }
-        ul#gpodder-menu li a { text-decoration: none; color: rgb(70%, 70%, 70%); padding: 6px; border: 1px rgb(40%, 40%, 40%) solid; -moz-border-radius: 5px; }
-        ul#gpodder-menu li a:hover { color: rgb(10%, 10%, 10%); background-color: white; border-bottom: 1px rgb(60%, 60%, 60%) solid;border-right: 1px rgb(40%, 60%, 40%) solid; border-left: 1px rgb(70%, 70%, 70%) solid;border-top: 1px rgb(70%, 70%, 70%) solid; }
-        ul#gpodder-menu li strong { background-color: white; padding: 6px; border-top: 1px solid rgb(60%, 60%, 60%); border-left: 1px solid rgb(60%, 60%, 60%); border-bottom: 1px solid rgb(70%, 70%, 70%); color: black; -moz-border-radius: 5px;}
-        ul#gpodder-menu li img { vertical-align: middle; padding-right: 2px; }
-        a { color: blue; text-decoration: none; }
-        a:hover { text-decoration: underline; }
-        p#version-info { position: absolute; top: 10px; right: 10px; text-align: right; }
-        ul.highlights { padding-left: 10px; list-style-type: none; }
-        ul.highlights strong { font-size: 13pt; } address {font-style: normal; color: #aaa; text-align:center;} address a { color: #aaaaff; }
-        table.downloads td { background-color: #eee; }
-        a[href^="http://"]:after, a[href^="https://"]:after {
-            content: url(http://gpodder.org/images/external.png);
-            padding-left: 2px;
-        }
-        /* ..but not URLs linking to the bug tracker or mygpo */
-        a[href^="http://gpodder.org"]:after, a.noextlink:after,
-          a.imgonlylink:after {
-            content: '';
-            padding-left: 0px;
-        }
-        a[href^="http://bugs.gpodder.org"]:after, a.noextlink:after,
-          a.imgonlylink:after {
-            content: '';
-            padding-left: 0px;
-        }
-        a[href^="http://my.gpodder.org"]:after, a.noextlink:after,
-          a.imgonlylink:after {
-            content: '';
-            padding-left: 0px;
-        }
-    </style>
-</head><body>
-<h1 style="margin: 0px; padding: 0px; position: absolute; top: 0px; left: 20px; height: 70px; z-index: 100;">
-    <strong><img style="padding-top: 10px; width: 64px; height: 64px;" alt="gPodder" title="gPodder" src="http://gpodder.org/images/weblogo64.png"></strong>
-</h1>
-<div style="position: absolute; z-index: 10; top: 0px; left: 0px; right: 0px; background-color: rgb(102, 102, 102); padding-bottom: 10px;">
-<ul id="gpodder-menu">
-  <li><a href="http://gpodder.org/"><img src="http://gpodder.org/images/icons/go-home.png" alt="">Home</a></li>
-  <li><a href="http://gpodder.org/news.html"><img src="http://gpodder.org/images/icons/accessories-text-editor.png" alt="">News</a></li>
-  <li><a href="http://gpodder.org/downloads.html"><img src="http://gpodder.org/images/icons/package-x-generic.png" alt="">Download</a></li>
-  <li><a href="http://gpodder.org/documentation.html"><img src="http://gpodder.org/images/icons/help-browser.png" alt="">Help</a></li>
-  <li><a href="http://bugs.gpodder.org/"><img src="http://gpodder.org/images/icons/dialog-warning.png" alt="">Bugs</a></li>
-  <li><strong><img src="http://gpodder.org/images/icons/mygpo.png" alt="">Web Service</strong></li>
-</ul>
-</div>
-<hr>
+  <link rel="stylesheet" href="/media/screen-base.css" type="text/css" />
+ </head>
+ <body>
+  <h1 id="logo">
+   <strong><img alt="gPodder" title="gPodder" src="http://gpodder.org/images/weblogo64.png" /></strong>
+  </h1>
+  <div id="topnav">
+   <ul id="gpodder-menu">
+    <li><a href="http://gpodder.org/"><img src="http://gpodder.org/images/icons/go-home.png" alt="">Home</a></li>
+    <li><a href="http://gpodder.org/news.html"><img src="http://gpodder.org/images/icons/accessories-text-editor.png" alt="">News</a></li>
+    <li><a href="http://gpodder.org/downloads.html"><img src="http://gpodder.org/images/icons/package-x-generic.png" alt="">Download</a></li>
+    <li><a href="http://gpodder.org/documentation.html"><img src="http://gpodder.org/images/icons/help-browser.png" alt="">Help</a></li>
+    <li><a href="http://bugs.gpodder.org/"><img src="http://gpodder.org/images/icons/dialog-warning.png" alt="">Bugs</a></li>
+    <li><strong><img src="http://gpodder.org/images/icons/mygpo.png" alt="">Web Service</strong></li>
+   </ul>
+  </div>
 
+  <hr>
 
-<div style="margin-right: 5%; padding-top: 80px; padding-bottom: 10px; float:left; width: 70%">
+  <div id="body">
 
-{% if error_message %}
- <div class="error">{{ error_message }}</div>
-{% endif %}
+   {% if error_message %}
+    <div class="error">{{ error_message }}</div>
+   {% endif %}
 
-{% block content %}
+   {% block content %}
     <h1>gPodder Web Service</h1>
     <p>...will go online soon...</p>
     <ul>
-        <li><a href="http://gpodder.org/wiki/Web_Services">Wiki page</a></li>
-        <li><a href="toplist.opml">Toplist as OPML</a></li>
+     <li><a href="http://gpodder.org/wiki/Web_Services">Wiki page</a></li>
+     <li><a href="toplist.opml">Toplist as OPML</a></li>
     </ul>
-{% endblock %}
-</div>
-<div style="padding-top: 80px; width:200px; height:70%; margin-right:-58px; padding-bottom: 10px; float:right; background-color: rgb(102, 102, 102); -moz-border-radius-bottomleft: 30px;">
-	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; background-color:rgb(102, 102, 102);">&nbsp;</span>
-	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; -moz-border-radius-topright: 30px; background-color:rgb(255,255,255);">&nbsp;</span>
-	{% if user.is_authenticated %}
-	<p style="margin-left:10px; color:rgb(70%,70%,70%);">logged in as {{ user.username }}</p>
-    <ul id="navigation">
+   {% endblock %}
+  </div>
+  <div id="navigation">
+   <span class="spacer1">&nbsp;</span>
+   <span class="spacer2">&nbsp;</span>
+   {% if user.is_authenticated %}
+    <ul id="menu">
+     <li>logged in as {{ user.username }}</li>
      <li><a href="/account/">Account settings</a></li>
-	 <li><a href="/logout/">logout!</a></li>
+     <li><a href="/logout/">logout!</a></li>
     </ul>
-  	{% else %}
-    <ul id="navigation">
-	 <li><a href="/login/">login!</a></li>
+   {% else %}
+    <ul id="menu">
+     <li><a href="/login/">login!</a></li>
     </ul>
-	{% endif %}
-</div>
-<hr style="clear: both;">
-<address> 2005-2009 <a class="noextlink" href="http://thpinfo.com/">Thomas Perl</a> and
-the gPodder Team</address>
-</body></html>
+   {% endif %}
+  </div>
+
+  <hr style="clear: both;">
+
+  <address> 2005-2009 <a class="noextlink" href="http://thpinfo.com/">Thomas Perl</a> andthe gPodder Team</address>
+ </body>
+</html>
+

commit 0fae7d331428f9d6f998204cfb572baf3d6290c8
Merge: e840f64... 4e16b26...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 17:17:33 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit e840f6474f3c271d82535d3a8b22a5ad7af71767
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 17:02:07 2009 +0100

    removed doku.txt

diff --git a/install/doku.txt b/install/doku.txt
deleted file mode 100644
index db97095..0000000
--- a/install/doku.txt
+++ /dev/null
@@ -1,86 +0,0 @@
-Dokumentation der Empfehlungen
-
-User_id:	1
-Zeit:		1 min 53.25 sec
-+------------+----------+
-| podcast_id | priority |
-+------------+----------+
-|      11093 |       42 | 
-|      11092 |       19 | 
-|      11094 |       18 | 
-|      11096 |       13 | 
-|      11205 |       11 | 
-|      11090 |       10 | 
-|      11091 |        9 | 
-|      11207 |        9 | 
-|      11211 |        8 | 
-|      11206 |        8 | 
-+------------+----------+
-
-
-
-User_id: 	5
-Zeit:		1 min 52.65 sec
-+------------+----------+
-| podcast_id | priority |
-+------------+----------+
-|      11094 |      224 | 
-|      11207 |      108 | 
-|      11200 |       88 | 
-|      11092 |       69 | 
-|      11206 |       60 | 
-|      11210 |       50 | 
-|      11179 |       50 | 
-|      11175 |       47 | 
-|      11174 |       37 | 
-|      11171 |       36 | 
-+------------+----------+
-
-
-User_id: 	23
-Zeit:		1 min 47.44 sec
-+------------+----------+
-| podcast_id | priority |
-+------------+----------+
-|      11094 |      224 | 
-|      11207 |      108 | 
-|      11200 |       88 | 
-|      11092 |       69 | 
-|      11206 |       60 | 
-|      11210 |       50 | 
-|      11179 |       50 | 
-|      11175 |       47 | 
-|      11174 |       37 | 
-|      11171 |       36 | 
-+------------+----------+
-
-User_id: 	3333
-Zeit:		1 min 49.99 sec
-
-Empty set 
-
-select count(*) from public_subscription where user_id=3333;
-+----------+
-| count(*) |
-+----------+
-|        0 | 
-+----------+
-
-User_id: 	2323
-Zeit:		1 min 57.31 sec
-+------------+----------+
-| podcast_id | priority |
-+------------+----------+
-|      11189 |       55 | 
-|      11191 |       27 | 
-|      11192 |       23 | 
-|      11205 |       21 | 
-|      11207 |       18 | 
-|      11094 |       18 | 
-|      11190 |       16 | 
-|      11211 |       13 | 
-|      11174 |       12 | 
-|      11200 |       12 | 
-+------------+----------+
-
-

commit ed8aedca08f384f7eaff08faeba0e9a7f35050cc
Merge: 9738614... 2c8a156...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 16:50:03 2009 +0100

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 97386149aee680696a944a984c372bae08541167
Merge: 1219003... 5405183...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 16:49:57 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit 40c05747e4b071353fb652dea741fc691e23b357
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 14:37:54 2009 +0100

    added legacy-link for podcast-toplist (bug 710)
    
    legacy clients expect the toplist to be at /toplist.opml

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 053e8a8..c2adcef 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -43,6 +43,7 @@ urlpatterns = patterns('',
 
     (r'^toplist/$', 'mygpo.web.views.toplist'),
     (r'^toplist/(?P<count>\d+).opml', 'mygpo.web.views.toplist_opml'),
+    (r'^toplist.opml$', 'mygpo.web.views.toplist_opml', {'count': 50}),
 
     #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),

commit 4e16b26dc67abec46acf72d39f8402d0df08aa8e
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Dec 14 13:41:16 2009 +0100

    Suggestion

diff --git a/install/update-05.sql b/install/update-05.sql
index 872ed48..38c55d0 100644
--- a/install/update-05.sql
+++ b/install/update-05.sql
@@ -12,26 +12,54 @@ CREATE PROCEDURE update_suggestion()
 BEGIN
     DECLARE deadlock INT DEFAULT 0;
     DECLARE attempts INT DEFAULT 0;
+    DECLARE done INT DEFAULT 0;
+    DECLARE user_help INT DEFAULT 0;
+    DECLARE cur1 CURSOR FOR SELECT user_ptr_id FROM user;
+    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = 1;
+
+
+    DROP TABLE IF EXISTS suggestion_pod;
+    CREATE TABLE suggestion_pod (
+       podID INT
+    );
+    DROP TABLE IF EXISTS suggestion_user;
+    CREATE TABLE suggestion_user (
+       userID INT
+    );
 
     try_loop:WHILE (attempts<3) DO
     BEGIN
-        DECLARE deadlock_detected CONDITION FOR 1213;
-            DECLARE EXIT HANDLER FOR deadlock_detected
+         DECLARE deadlock_detected CONDITION FOR 1213;
+         DECLARE EXIT HANDLER FOR deadlock_detected
                 BEGIN
                     ROLLBACK;
                     SET deadlock=1;
                 END;
-            SET deadlock=0;
+         SET deadlock=0;
                
-            START TRANSACTION;
+         START TRANSACTION;
+            OPEN cur1;
+
             DELETE FROM suggestion;
+            REPEAT
+                FETCH cur1 INTO user_help;
+
+            IF NOT done THEN
+                    DELETE FROM suggestion_pod;
+                    DELETE FROM suggestion_user;
+select user_help;
+                    insert into suggestion_pod (select podcast_id from public_subscription where user_id=user_help);
+                    insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
+                    insert into suggestion (select user_help, podcast_id, count(podcast_id) as priority 
+                                     from public_subscription, suggestion_user 
+                                     where user_id=userID and podcast_id not in (select * from suggestion_pod) 
+                                     group by user_help, podcast_id order by priority DESC LIMIT 10);
+         
+                END IF;
+            UNTIL done END REPEAT;
+
+            CLOSE cur1;
 
-            INSERT INTO suggestion select user_ptr_id, podcast_id, count(podcast_id) as priority 
-                 from public_subscription, user 
-                    where user_id in (select user_id from public_subscription 
-                                      where podcast_id = (select min(podcast_id) from public_subscription where user_id=user_ptr_id)) 
-               group by podcast_id order by priority DESC LIMIT 10;
-                        
             COMMIT;
         END;
         IF deadlock=0 THEN
@@ -44,7 +72,68 @@ BEGIN
         IF deadlock=1 THEN
             call FAIL('Suggestion are not updated!');
         END IF;
+
+        DROP TABLE IF EXISTS suggestion_user;
+        DROP TABLE IF EXISTS suggestion_pod;         
+
+END $$
+DELIMITER ;
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_suggestion_for $$
+CREATE PROCEDURE update_suggestion_for(IN user_par INT)
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
         
+    DROP TABLE IF EXISTS suggestion_pod;
+    CREATE TABLE suggestion_pod (
+       podID INT
+    );
+    DROP TABLE IF EXISTS suggestion_user;
+    CREATE TABLE suggestion_user (
+       userID INT
+    );
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+         DECLARE deadlock_detected CONDITION FOR 1213;
+         DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+         SET deadlock=0;
+               
+         START TRANSACTION;
+
+            DELETE FROM suggestion where user_id=user_par;
+            DELETE FROM suggestion_pod;
+            DELETE FROM suggestion_user;
+
+            insert into suggestion_pod (select podcast_id from public_subscription where user_id=user_par);
+            insert into suggestion_user (select user_id from public_subscription, suggestion_pod where podcast_id=podID group by user_id);
+            insert into suggestion (select user_par, podcast_id, count(podcast_id) as priority 
+                                     from public_subscription, suggestion_user 
+                                     where user_id=userID and podcast_id not in (select * from suggestion_pod) 
+                                     group by user_par, podcast_id order by priority DESC LIMIT 10);
+         
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Suggestion are not updated!');
+        END IF;
+
+        DROP TABLE IF EXISTS suggestion_user;
+        DROP TABLE IF EXISTS suggestion_pod;         
+
 END $$
 DELIMITER ;
 

commit 54051833366fa4bb29809fc653f121dc6b05ce2c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 13:03:03 2009 +0100

    added opml toplist with dynamic length (bug 710)

diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 730019a..b666791 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -16,11 +16,13 @@
 #
 
 from django.shortcuts import render_to_response
-from django.http import HttpResponseRedirect
+from django.http import HttpResponseRedirect, HttpResponse
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
 from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry
 from mygpo.web.forms import UserAccountForm
+from mygpo.api.opml import Exporter
+from django.utils.translation import ugettext as _
 
 def home(request):
        if request.user.is_authenticated():
@@ -91,6 +93,15 @@ def toplist(request):
     }, context_instance=RequestContext(request))
 
 
+def toplist_opml(request, count):
+    entries = ToplistEntry.objects.all().order_by('-subscriptions')[:count]
+    exporter = Exporter(_('my.gpodder.org - Top %s') % count)
+
+    opml = exporter.generate([e.podcast for e in entries])
+
+    return HttpResponse(opml, mimetype='text/xml')
+ 
+
 #sl = SubscriptionAction.objects.filter(podcast=podcast_ids[listindex])
 #sldev_ids = [s.device.id for s in sl]  
 #dev = Device.objects.filter(id__in=sldev_ids)

commit 9e595f9962d98585e89d243e8bfb56c9ead05bbb
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 12:57:11 2009 +0100

    implement toplist web view (bug 710)

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index ed4056f..d6db622 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -79,6 +79,18 @@ class Podcast(models.Model):
     class Meta:
         db_table = 'podcast'
 
+
+class ToplistEntry(models.Model):
+    podcast = models.ForeignKey(Podcast)
+    subscriptions = models.IntegerField(db_column='subscription_count')
+
+    def __unicode__(self):
+        return '%s (%s)' % (self.podcast, self.subscriptions)
+
+    class Meta:
+        db_table = 'toplist'
+
+
 class Episode(models.Model):
     podcast = models.ForeignKey(Podcast)
     url = models.URLField(unique=True)
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 54ffe19..053e8a8 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -41,6 +41,9 @@ urlpatterns = patterns('',
     (r'account/$', 'mygpo.web.views.account'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
+    (r'^toplist/$', 'mygpo.web.views.toplist'),
+    (r'^toplist/(?P<count>\d+).opml', 'mygpo.web.views.toplist_opml'),
+
     #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
diff --git a/mygpo/web/templates/toplist.html b/mygpo/web/templates/toplist.html
new file mode 100644
index 0000000..e95e8b3
--- /dev/null
+++ b/mygpo/web/templates/toplist.html
@@ -0,0 +1,25 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>{% trans "Toplist" %}</h1>
+
+  <p>{% blocktrans %}These are the {{ count }} most susbscribed podcasts.{% endblocktrans %}</p>
+
+  <table>
+   <tr>
+    <th>{% trans "#" %}</th>
+    <th>{% trans "Podcast" %}</th>
+    <th>{% trans "Subscribers" %}</th>
+   </tr>
+  {% for entry in entries %}
+   <tr>
+    <td>{{ forloop.counter }}</td>
+    <td>{{ entry.podcast }}</td>
+    <td>{{ entry.subscriptions }}</td>
+   </tr>
+  {% endfor %}
+  </table>
+
+{% endblock %}
+
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 77a5c57..730019a 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -19,7 +19,7 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
-from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction
+from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction, ToplistEntry
 from mygpo.web.forms import UserAccountForm
 
 def home(request):
@@ -82,6 +82,14 @@ def account(request):
         'success': success
     }, context_instance=RequestContext(request))
 
+def toplist(request):
+    len = 30
+    entries = ToplistEntry.objects.all().order_by('-subscriptions')[:len]
+    return render_to_response('toplist.html', {
+        'count'  : len,
+        'entries': entries,
+    }, context_instance=RequestContext(request))
+
 
 #sl = SubscriptionAction.objects.filter(podcast=podcast_ids[listindex])
 #sldev_ids = [s.device.id for s in sl]  

commit 2c8a15629b8a1375507307e96297b95d081ab4f8
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Dec 14 10:35:47 2009 +0100

    Finished Subscriptionlist

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index 829be0e..fe1b737 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -4,10 +4,10 @@
 {% block content %}
   <h1>{% trans "Your Subscriptions" %}</h1>
   <p>{% trans "This page is currently in development." %}</p>
-  <table style="width:100%;">
+  <table class="subscriptionlist" style="width:100%;">
 	<tr>
-		<th style="padding-right:100px;">{{ test }}</th>
-		<th style="padding-right:200px;">Title</th>
+		<th style="padding-right:100px;">&nbsp;</th>
+		<th class="subscription" style="padding-right:200px;">Title</th>
 		<th style="padding-right:200px;">Latest Episode</th>
 		<th style="padding-right:200px;">Devices</th>
 	</tr>
@@ -18,7 +18,7 @@
                   <img src="{{ s.logo }}" style="width:40px; height:30px;" />
                   {% endif %}                  
               </td>
-		<td>{{ s.title }}</td>
+		<td style="font-weight:bold">{{ s.title }}</td>
 		<td>{{ s.episode }}</td>
 		<td>{{ s.device }}</td>
 	</tr>

commit 201187fbdbf2b26ba1eb60a192ef2064ae08baa2
Merge: 7116c38... 2bdab8b...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Dec 14 10:16:17 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit 0327d01b368e1049d66bdb1eca9c24c8238403ee
Merge: 2bdab8b... 7116c38...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Dec 14 00:28:11 2009 +0100

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 2bdab8bb1e8a89ae2d4b02eda4ff66864e9aa72e
Merge: 629e49a... 453088e...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 23:59:54 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit 7116c383743121920179d087f292bd2c14bd84b1
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Sun Dec 13 22:33:56 2009 +0100

    Added the subscription list

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index e6c0eaa..829be0e 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -8,7 +8,7 @@
 	<tr>
 		<th style="padding-right:100px;">{{ test }}</th>
 		<th style="padding-right:200px;">Title</th>
-		<!-- th style="padding-right:200px;">Latest Episode</th -->
+		<th style="padding-right:200px;">Latest Episode</th>
 		<th style="padding-right:200px;">Devices</th>
 	</tr>
        {% for s in subscriptionlist %}
@@ -19,7 +19,7 @@
                   {% endif %}                  
               </td>
 		<td>{{ s.title }}</td>
-		<!-- td>{{ s.episode }}</td -->
+		<td>{{ s.episode }}</td>
 		<td>{{ s.device }}</td>
 	</tr>
        {% endfor %}
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 77a5c57..3da1cde 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -50,10 +50,19 @@ def create_subscriptionlist(request):
             sublog_for_device = SubscriptionAction.objects.filter(podcast__id=subscriptionlist[index]['id'])
             sublog_devids = [s.device.id for s in sublog_for_device]
             dev = Device.objects.filter(id__in=sublog_devids, user__id=userid).values_list('name', flat=True)
+            latest_actions = EpisodeAction.objects.filter(episode__podcast__id=subscriptionlist[index]['id']).order_by('-timestamp')
+            subscriptionlist[index]['episode'] = ''            
+            if latest_actions.count() > 0:
+                 episode = latest_actions[0].episode.title
+                 timestamp = latest_actions[0].timestamp.strftime('%d.%m.%Y %H:%M')
+                 subscriptionlist[index]['episode'] += episode + ", " + timestamp
             subscriptionlist[index]['device'] = ''
-            for d in dev:
-                 subscriptionlist[index]['device'] += d + ", "
-            subscriptionlist[index]['episode'] = 'epi'
+            
+            for i, d in enumerate(dev):
+                 if i == 0:
+                       subscriptionlist[index]['device'] += d
+                 else:
+                       subscriptionlist[index]['device'] += ", "  + d           
       return subscriptionlist
 
 

commit 453088e3222600bcaeab1092aaa68024d99cef8c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 20:59:59 2009 +0100

    removing "managed = False" in Subscription model
    
    Option is not available in Django 1.0 which is currently shipped with Debian
    stable
    http://docs.djangoproject.com/en/dev/ref/models/options/#managed

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 4c58409..ed4056f 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -296,7 +296,8 @@ class Subscription(models.Model):
 
     class Meta:
         db_table = 'current_subscription'
-        managed = False
+        #not available in Django 1.0 (Debian stable)
+        #managed = False
 
 class SubscriptionAction(models.Model):
     device = models.ForeignKey(Device)

commit 1219003b3ec53d4e058ae17c2d4ee7da335117c2
Merge: b535259... 629e49a...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 18:56:14 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit 629e49a8635f9830db6487e662d0e40745d65af7
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sun Dec 13 16:11:05 2009 +0100

    Suggestion

diff --git a/install/doku.txt b/install/doku.txt
new file mode 100644
index 0000000..db97095
--- /dev/null
+++ b/install/doku.txt
@@ -0,0 +1,86 @@
+Dokumentation der Empfehlungen
+
+User_id:	1
+Zeit:		1 min 53.25 sec
++------------+----------+
+| podcast_id | priority |
++------------+----------+
+|      11093 |       42 | 
+|      11092 |       19 | 
+|      11094 |       18 | 
+|      11096 |       13 | 
+|      11205 |       11 | 
+|      11090 |       10 | 
+|      11091 |        9 | 
+|      11207 |        9 | 
+|      11211 |        8 | 
+|      11206 |        8 | 
++------------+----------+
+
+
+
+User_id: 	5
+Zeit:		1 min 52.65 sec
++------------+----------+
+| podcast_id | priority |
++------------+----------+
+|      11094 |      224 | 
+|      11207 |      108 | 
+|      11200 |       88 | 
+|      11092 |       69 | 
+|      11206 |       60 | 
+|      11210 |       50 | 
+|      11179 |       50 | 
+|      11175 |       47 | 
+|      11174 |       37 | 
+|      11171 |       36 | 
++------------+----------+
+
+
+User_id: 	23
+Zeit:		1 min 47.44 sec
++------------+----------+
+| podcast_id | priority |
++------------+----------+
+|      11094 |      224 | 
+|      11207 |      108 | 
+|      11200 |       88 | 
+|      11092 |       69 | 
+|      11206 |       60 | 
+|      11210 |       50 | 
+|      11179 |       50 | 
+|      11175 |       47 | 
+|      11174 |       37 | 
+|      11171 |       36 | 
++------------+----------+
+
+User_id: 	3333
+Zeit:		1 min 49.99 sec
+
+Empty set 
+
+select count(*) from public_subscription where user_id=3333;
++----------+
+| count(*) |
++----------+
+|        0 | 
++----------+
+
+User_id: 	2323
+Zeit:		1 min 57.31 sec
++------------+----------+
+| podcast_id | priority |
++------------+----------+
+|      11189 |       55 | 
+|      11191 |       27 | 
+|      11192 |       23 | 
+|      11205 |       21 | 
+|      11207 |       18 | 
+|      11094 |       18 | 
+|      11190 |       16 | 
+|      11211 |       13 | 
+|      11174 |       12 | 
+|      11200 |       12 | 
++------------+----------+
+
+

commit b5352599cc0fbc25d564ae18533c845547a363c6
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 14:35:49 2009 +0100

    fix reference to user-object in advanced api

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index c5463b4..58c8eae 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -54,7 +54,7 @@ def subscriptions(request, username, device_uid):
         except KeyError:
             return HttpResponseBadRequest('parameter since missing')
 
-        changes = get_subscription_changes(user, device, since, now)
+        changes = get_subscription_changes(request.user, device, since, now)
 
         return JsonResponse(changes)
 

commit d6a61e4115d2b704c12cf9b07d26e8df25acf3ba
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 14:29:33 2009 +0100

    timestamps as integers

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index e0e152b..c5463b4 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -41,7 +41,7 @@ def subscriptions(request, username, device_uid):
     if request.user.username != username:
         return HttpResponseForbidden()
 
-    now = mktime(datetime.now().timetuple())
+    now = int(mktime(datetime.now().timetuple()))
 
     if request.method == 'GET':
         try:
@@ -111,7 +111,7 @@ def episodes(request, username):
     if request.user.username != username:
         return HttpResponseForbidden()
 
-    now = mktime(datetime.now().timetuple())
+    now = int(mktime(datetime.now().timetuple()))
 
     if request.method == 'POST':
         try:

commit 45921782f2192058411c0f28f59c34455ef8afdf
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 14:26:05 2009 +0100

    fixing class reference in httpresponse.py

diff --git a/mygpo/api/httpresponse.py b/mygpo/api/httpresponse.py
index 794b1a8..9d62a34 100644
--- a/mygpo/api/httpresponse.py
+++ b/mygpo/api/httpresponse.py
@@ -18,6 +18,7 @@
 from django.http import HttpResponse
 from django.core.serializers import json, serialize
 from django.db.models.query import QuerySet
+from django.core.serializers.json import DjangoJSONEncoder
 try:
     #try to import the JSON module (if we are on Python 2.6)
     import json
@@ -38,8 +39,8 @@ class JsonResponse(HttpResponse):
         if isinstance(object, QuerySet):
             content = serialize('json', object)
         else:
-            content = simplejson.dumps(
-                object, indent=2, cls=json.DjangoJSONEncoder,
+            content = json.dumps(
+                object, indent=2, cls=DjangoJSONEncoder,
                 ensure_ascii=False)
         super(JsonResponse, self).__init__(
             content, content_type='application/json')

commit 6bf44fe01cb9228f50fdd067013cbf25508733f6
Merge: 7de164e... ff1494c...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 14:21:27 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit 7de164ea1089a30b47c12654fc586cdb75d89b60
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 14:20:59 2009 +0100

    bugfixing advanced api

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index a1ed8a4..e0e152b 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -59,12 +59,16 @@ def subscriptions(request, username, device_uid):
         return JsonResponse(changes)
 
     elif request.method == 'POST':
-        d = Device.objects.get_or_create(user=request.user, uid=device_uid)
+        d, created = Device.objects.get_or_create(user=request.user, uid=device_uid)
 
         actions = json.loads(request.POST['data'])
         add = actions['add'] if 'add' in actions else []
         rem = actions['remove'] if 'remove' in actions else []
 
+        for a in add:
+            if a in rem:
+                return HttpResponseBadRequest('can not add and remove %s at the same time' % a)
+
         update_subscriptions(request.user, d, add, rem)
 
         return JsonResponse({'timestamp': now})
@@ -75,11 +79,11 @@ def subscriptions(request, username, device_uid):
 
 def update_subscriptions(user, device, add, remove):
     for a in add:
-        p = Podcast.objects.get_or_create(url=a)
+        p, p_created = Podcast.objects.get_or_create(url=a)
         s = SubscriptionAction.objects.create(podcast=p,device=device,action=SUBSCRIBE_ACTION)
 
     for r in remove:
-        p = Podcast.objects.get_or_create(url=r)
+        p, p_created = Podcast.objects.get_or_create(url=r)
         s = SubscriptionAction.objects.create(podcast=p,device=device,action=UNSUBSCRIBE_ACTION)
 
 
@@ -163,7 +167,7 @@ def update_episodes(user, actions):
         except:
             return HttpResponseBadRequest('not all required fields (podcast, episode, action) given')
 
-        device = Device.objects.get_or_create(user=user, uid=e['device'], defaults={'name': 'Unknown', 'type': 'other'}) if 'device' in e else None
+        device, created = Device.objects.get_or_create(user=user, uid=e['device'], defaults={'name': 'Unknown', 'type': 'other'}) if 'device' in e else None
         timestamp = dateutil.parser.parse(e['timestamp']) if 'timestamp' in e else None
         position = datetime.strptime(e['position'], '%H:%M:%S').time() if 'position' in e else None
 
@@ -180,7 +184,7 @@ def device(request, username, device_uid):
         return HttpResponseForbidden()
 
     if request.method == 'POST':
-        d = Device.objects.get_or_create(user=request.user, uid=device_uid)
+        d, created = Device.objects.get_or_create(user=request.user, uid=device_uid)
 
         data = json.loads(request.POST['data'])
 

commit e815101a4b716f41b3bcff19ef35ace68d914cf8
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 13:57:15 2009 +0100

    fixing advanced.update_subscriptions()

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 4ffd89a..a1ed8a4 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -74,13 +74,13 @@ def subscriptions(request, username, device_uid):
 
 
 def update_subscriptions(user, device, add, remove):
-    for add in actions['add']:
-        p = Podcast.objects.get_or_create(url=add)
-        s = SubscriptionAction.objects.create(podcast=p,device=d,action=SUBSCRIBE_ACTION)
+    for a in add:
+        p = Podcast.objects.get_or_create(url=a)
+        s = SubscriptionAction.objects.create(podcast=p,device=device,action=SUBSCRIBE_ACTION)
 
-    for remove in actions['remove']:
-        p = Podcast.objects.get_or_create(url=remove)
-        s = SubscriptionAction.objects.create(podcast=p,device=d,action=UNSUBSCRIBE_ACTION)
+    for r in remove:
+        p = Podcast.objects.get_or_create(url=r)
+        s = SubscriptionAction.objects.create(podcast=p,device=device,action=UNSUBSCRIBE_ACTION)
 
 
 def get_subscription_changes(user, device, since, until):

commit 3562e7847e6c5c7b9eee33c90e4d1b58c28211ac
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 13:54:14 2009 +0100

    moved class JsonResponse to mygpo.api.httpresponse
    
    avoiding namespace clashes by removing package mygpo.api.json

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 08a73c5..4ffd89a 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -18,13 +18,22 @@
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404, HttpResponseNotAllowed
 from mygpo.api.models import Device, Podcast, SubscriptionAction, Episode, EpisodeAction, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, EPISODE_ACTION_TYPES, DEVICE_TYPES
-from mygpo.api.json import JsonResponse
+from mygpo.api.httpresponse import JsonResponse
 from django.core import serializers
 from time import mktime
 from datetime import datetime
-import json
 import dateutil.parser
 
+try:
+    #try to import the JSON module (if we are on Python 2.6)
+    import json
+except ImportError:
+    # No JSON module available - fallback to simplejson (Python < 2.6)
+    print "No JSON module available - fallback to simplejson (Python < 2.6)"
+    import simplejson as json
+
+print dir(json)
+
 
 @require_valid_user()
 def subscriptions(request, username, device_uid):
diff --git a/mygpo/api/httpresponse.py b/mygpo/api/httpresponse.py
index 9f76e8c..794b1a8 100644
--- a/mygpo/api/httpresponse.py
+++ b/mygpo/api/httpresponse.py
@@ -1,4 +1,30 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.http import HttpResponse
+from django.core.serializers import json, serialize
+from django.db.models.query import QuerySet
+try:
+    #try to import the JSON module (if we are on Python 2.6)
+    import json
+except ImportError:
+    # No JSON module available - fallback to simplejson (Python < 2.6)
+    import simplejson as json
+
 
 def HttpResponseNotAuthorized():
     response =  HttpResponse(('You\'re not authorized to visit this area!'), mimetype="text/plain")
@@ -6,3 +32,15 @@ def HttpResponseNotAuthorized():
     response.status_code = 401
     return response
 
+#from http://www.djangosnippets.org/snippets/154/
+class JsonResponse(HttpResponse):
+    def __init__(self, object):
+        if isinstance(object, QuerySet):
+            content = serialize('json', object)
+        else:
+            content = simplejson.dumps(
+                object, indent=2, cls=json.DjangoJSONEncoder,
+                ensure_ascii=False)
+        super(JsonResponse, self).__init__(
+            content, content_type='application/json')
+
diff --git a/mygpo/api/json.py b/mygpo/api/json.py
deleted file mode 100644
index 70fbd6f..0000000
--- a/mygpo/api/json.py
+++ /dev/null
@@ -1,35 +0,0 @@
-#
-# This file is part of my.gpodder.org.
-#
-# my.gpodder.org is free software: you can redistribute it and/or modify it
-# under the terms of the GNU Affero General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or (at your
-# option) any later version.
-#
-# my.gpodder.org is distributed in the hope that it will be useful, but
-# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
-# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
-# License for more details.
-#
-# You should have received a copy of the GNU Affero General Public License
-# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
-#
-
-#from http://www.djangosnippets.org/snippets/154/
-
-from django.core.serializers import json, serialize
-from django.db.models.query import QuerySet
-from django.http import HttpResponse
-from django.utils import simplejson
-
-class JsonResponse(HttpResponse):
-    def __init__(self, object):
-        if isinstance(object, QuerySet):
-            content = serialize('json', object)
-        else:
-            content = simplejson.dumps(
-                object, indent=2, cls=json.DjangoJSONEncoder,
-                ensure_ascii=False)
-        super(JsonResponse, self).__init__(
-            content, content_type='application/json')
-

commit 6d1e4859dd39200c344bf2da816ef166ede35073
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 13:17:05 2009 +0100

    typo

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 134b3cc..08a73c5 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -126,7 +126,7 @@ def episodes(request, username):
         return HttpResponseNotAllowed(['POST', 'GET'])
 
 
-def get_episode_changes(user, podcast, device, since, until).
+def get_episode_changes(user, podcast, device, since, until):
     actions = []
     for a in EpisodeAction.objects.filter(user=user, podcast=podcast, device=device, timestamp__gt=since, timestamp__lt=until):
         action = {

commit b956909e00be96a82d96d34ac3641b4d6769d923
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Dec 13 13:15:27 2009 +0100

    using python-dateutil for parsing iso8601 dates
    
    xml.utils.iso8601 of python-xml seems to be not maintained anymore.

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index e0b17d0..134b3cc 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -23,7 +23,7 @@ from django.core import serializers
 from time import mktime
 from datetime import datetime
 import json
-import xml.utils.iso8601
+import dateutil.parser
 
 
 @require_valid_user()
@@ -155,7 +155,7 @@ def update_episodes(user, actions):
             return HttpResponseBadRequest('not all required fields (podcast, episode, action) given')
 
         device = Device.objects.get_or_create(user=user, uid=e['device'], defaults={'name': 'Unknown', 'type': 'other'}) if 'device' in e else None
-        timestamp = iso8601.parse(e['timestamp']) if 'timestamp' in e else None
+        timestamp = dateutil.parser.parse(e['timestamp']) if 'timestamp' in e else None
         position = datetime.strptime(e['position'], '%H:%M:%S').time() if 'position' in e else None
 
         if position and action != 'play':

commit ff1494c775474ee1c9862525caf16aa7ed25c019
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sat Dec 12 14:27:48 2009 +0100

    suggestions

diff --git a/install/update-05.sql b/install/update-05.sql
new file mode 100644
index 0000000..872ed48
--- /dev/null
+++ b/install/update-05.sql
@@ -0,0 +1,50 @@
+DROP TABLE IF EXISTS suggestion;
+CREATE TABLE suggestion (
+    user_id INT REFERENCES user (user_ptr_id),
+    podcast_id INT REFERENCES podcast (id),
+    priority INT,
+    PRIMARY KEY(user_id, podcast_id)
+);
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_suggestion $$
+CREATE PROCEDURE update_suggestion()
+BEGIN
+    DECLARE deadlock INT DEFAULT 0;
+    DECLARE attempts INT DEFAULT 0;
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+        DECLARE deadlock_detected CONDITION FOR 1213;
+            DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+            SET deadlock=0;
+               
+            START TRANSACTION;
+            DELETE FROM suggestion;
+
+            INSERT INTO suggestion select user_ptr_id, podcast_id, count(podcast_id) as priority 
+                 from public_subscription, user 
+                    where user_id in (select user_id from public_subscription 
+                                      where podcast_id = (select min(podcast_id) from public_subscription where user_id=user_ptr_id)) 
+               group by podcast_id order by priority DESC LIMIT 10;
+                        
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
+
+        IF deadlock=1 THEN
+            call FAIL('Suggestion are not updated!');
+        END IF;
+        
+END $$
+DELIMITER ;
+

commit 4dea5a2de9618a640c639d79a28eeaa6724ea6d9
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Dec 11 16:27:24 2009 +0100

    add delay to satisfy unique constraint for subscription_logs

diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index fe18098..f38d71e 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -21,6 +21,7 @@ from mygpo.api.models import Device, Podcast, SubscriptionAction, UserProfile
 from put_test import put_data
 from django.http import HttpRequest
 from mygpo.api.simple import subscriptions
+import time
 
 class SyncTest(TestCase):
     def test_sync_actions(self):
@@ -35,15 +36,21 @@ class SyncTest(TestCase):
         p4 = Podcast.objects.create(title='p4', url='http://p4.com/')
 
         s1 = SubscriptionAction.objects.create(device=d1, podcast=p1, action='1')
+        time.sleep(1)
         s2 = SubscriptionAction.objects.create(device=d2, podcast=p2, action='1')
+        time.sleep(1)
         u2 = SubscriptionAction.objects.create(device=d2, podcast=p2, action='-1')
+        time.sleep(1)
         s3 = SubscriptionAction.objects.create(device=d1, podcast=p3, action='1')
+        time.sleep(1)
         s3_= SubscriptionAction.objects.create(device=d2, podcast=p3, action='1')
+        time.sleep(1)
         s4 = SubscriptionAction.objects.create(device=d2, podcast=p4, action='1')
+        time.sleep(1)
         u3 = SubscriptionAction.objects.create(device=d2, podcast=p3, action='-1')
 
-	#d1: p1, p3
-	#d2: p2, -p2, p3, p4, -p3
+        #d1: p1, p3
+        #d2: p2, -p2, p3, p4, -p3
 
         d1.sync_with(d2)
 

commit 7d51806f896fa1a016e11cf6634546c782609882
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Dec 11 16:25:23 2009 +0100

    adding view current_subscription for tests

diff --git a/mygpo/api/sql/subscription.sql b/mygpo/api/sql/subscription.sql
new file mode 100644
index 0000000..cd70d2e
--- /dev/null
+++ b/mygpo/api/sql/subscription.sql
@@ -0,0 +1,7 @@
+
+CREATE VIEW current_subscription AS SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since, sum(a.action) as summe
+    FROM (subscription_log a JOIN device b on a.device_id=b.id)
+        JOIN user c on b.user_id=c.user_ptr_id
+    GROUP BY a.podcast_id, b.user_id
+    having summe>0;
+

commit b8a64ec70b0dcefb43fbdabb6fc569975d1b3411
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Dec 11 15:49:54 2009 +0100

    restrict null- and blank values for model fields
    
    The models now correspond to the database layout regarding null values. blank
    values are used for further restrictions.

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 788b2bf..4c58409 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -35,9 +35,15 @@ DEVICE_TYPES = (
         ('other', 'Other')
     )
 
+
 SUBSCRIBE_ACTION = 1
 UNSUBSCRIBE_ACTION = -1
 
+SUBSCRIPTION_ACTION_TYPES = (
+        (SUBSCRIBE_ACTION, 'subscribed'),
+        (UNSUBSCRIBE_ACTION, 'unsubscribed')
+    )
+
 class UserProfile(models.Model):
     user = models.ForeignKey(User, unique=True, db_column='user_ptr_id')
 
@@ -52,15 +58,15 @@ class UserProfile(models.Model):
 
 class Podcast(models.Model):
     url = models.URLField(unique=True)
-    title = models.CharField(max_length=100)
-    description = models.TextField()
-    link = models.URLField()
+    title = models.CharField(max_length=100, blank=True)
+    description = models.TextField(blank=True, null=True)
+    link = models.URLField(blank=True, null=True)
     last_update = models.DateTimeField(null=True,blank=True)
-    logo_url = models.CharField(max_length=1000)
-    
+    logo_url = models.CharField(max_length=1000,null=True,blank=True)
+
     def subscriptions(self):
         return Subscription.objects.filter(podcast=self)
-    
+
     def subscription_count(self):
         return self.subscriptions().count()
 
@@ -69,20 +75,20 @@ class Podcast(models.Model):
 
     def __unicode__(self):
         return self.title if self.title != '' else self.url
-    
+
     class Meta:
         db_table = 'podcast'
 
 class Episode(models.Model):
     podcast = models.ForeignKey(Podcast)
     url = models.URLField(unique=True)
-    title = models.CharField(max_length=100)
-    description = models.TextField()
-    link = models.URLField()
+    title = models.CharField(max_length=100, blank=True)
+    description = models.TextField(null=True, blank=True)
+    link = models.URLField(null=True, blank=True)
 
     def __unicode__(self):
         return self.title
-    
+
     class Meta:
         db_table = 'episode'
 
@@ -121,7 +127,7 @@ class SyncGroup(models.Model):
 class Device(models.Model):
     user = models.ForeignKey(User)
     uid = models.SlugField(max_length=50)
-    name = models.CharField(max_length=100)
+    name = models.CharField(max_length=100, blank=True)
     type = models.CharField(max_length=10, choices=DEVICE_TYPES)
     sync_group = models.ForeignKey(SyncGroup, blank=True, null=True)
 
@@ -266,10 +272,10 @@ class Device(models.Model):
 class EpisodeAction(models.Model):
     user = models.ForeignKey(User, primary_key=True)
     episode = models.ForeignKey(Episode)
-    device = models.ForeignKey(Device,)
+    device = models.ForeignKey(Device)
     action = models.IntegerField(choices=EPISODE_ACTION_TYPES)
     timestamp = models.DateTimeField(default=datetime.now)
-    playmark = models.IntegerField()
+    playmark = models.IntegerField(null=True, blank=True)
 
     def __unicode__(self):
         return '%s %s %s' % self.user, self.action, self.episode
@@ -287,14 +293,15 @@ class Subscription(models.Model):
 
     def __unicode__(self):
         return '%s - %s on %s' % (self.device.user, self.podcast, self.device)
-    
+
     class Meta:
         db_table = 'current_subscription'
+        managed = False
 
 class SubscriptionAction(models.Model):
     device = models.ForeignKey(Device)
     podcast = models.ForeignKey(Podcast)
-    action = models.IntegerField()
+    action = models.IntegerField(choices=SUBSCRIPTION_ACTION_TYPES)
     timestamp = models.DateTimeField(blank=True, default=datetime.now)
 
     def action_string(self):

commit f9a1a092521f012809712ac743835a06de25507f
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Fri Dec 11 15:06:21 2009 +0100

    put_test erweitert...

diff --git a/mygpo/api/put_test.py b/mygpo/api/put_test.py
index 9e9f852..ef87783 100644
--- a/mygpo/api/put_test.py
+++ b/mygpo/api/put_test.py
@@ -1,6 +1,7 @@
 import sys
 import httplib
 import base64
+import time
 
 def put_data(dev_uid, format, data, username, password):
     cmd = '/subscriptions/%s/%d.%s' % (username, dev_uid, format)
@@ -26,13 +27,25 @@ def get_data(dev_uid, format, username, password):
 if __name__ == "__main__":
     u = 'ale'
     p = 'ale'
-    p1 = 'http://www.podcast1.com\n'
-    p2 = 'http://www.podcast2.com\n'
-    p3 = 'http://www.podcast3.com\n'
-    data_txt_1 = '%s%s\n' % (p1, p2)
-    data_txt_2 = '%s%s\n' % (p2, p3)
-    
-    put_data(1, 'txt', data_txt_1, u, p)
-    get_data(1, 'txt', u, p)
-    put_data(1, 'txt', data_txt_2, u, p)
-    get_data(1, 'txt', u, p)
+    p1 = 'http://www.podcast1.com'
+    p2 = 'http://www.podcast2.com'
+    p3 = 'http://www.podcast3.com'
+    p4 = 'http://www.podcast4.com'
+    data_txt_1 = '%s\n%s\n\n' % (p1, p2)
+    data_txt_2 = '%s\n%s\n\n' % (p2, p3)
+    data_txt_3 = '%s\n%s\n%s\n\n' % (p1, p3, p4)
+    d1 = 1
+    print 'put %s and %s on device %d' % (p1, p2, d1)
+    put_data(d1, 'txt', data_txt_1, u, p)
+    print 'get subscriptions'
+    get_data(d1, 'txt', u, p)
+    time.sleep(2)
+    print 'put %s and %s on device %d' % (p2, p3, d1)
+    put_data(d1, 'txt', data_txt_2, u, p)
+    print 'get subscriptions'
+    get_data(d1, 'txt', u, p)
+    time.sleep(2)
+    print 'put %s, %s and %s on device %d' % (p1, p3, p4, d1)
+    put_data(d1, 'txt', data_txt_3, u, p)
+    print 'get subscriptions'
+    get_data(d1, 'txt', u, p)
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 48e45b1..b319dc7 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -52,8 +52,8 @@ def format_subscriptions(subscriptions, format, username):
     if format == 'txt':
         #return subscriptions formatted as txt
         urls = [p.url for p in subscriptions]
-        s = "\n".join(urls)
-        s += "\n"
+        s = '\n'.join(urls)
+        s += '\n'
         return HttpResponse(s, mimetype='text/plain')
 
     elif format == 'opml':
@@ -91,7 +91,7 @@ def parse_subscription(raw_post_data, format, user, device_uid):
     
     d, created = Device.objects.get_or_create(user=user, uid=device_uid, 
                 defaults = {'type': 'other', 'name': 'unknown_' + device_uid})
-    
+
     podcasts = [p.podcast for p in d.get_subscriptions()]
     old = [p.url for p in podcasts]    
     new = [p for p in urls if p not in old]
@@ -101,19 +101,18 @@ def parse_subscription(raw_post_data, format, user, device_uid):
 
 def set_subscriptions(subscriptions):
     new, rem, d = subscriptions
-
-    if new != []:
-        for n in new:
-            p, created = Podcast.objects.get_or_create(url=n,
-                        defaults={'title':n,'description':n,'last_update':datetime.now()})
-            s = SubscriptionAction(podcast=p, action=SUBSCRIBE_ACTION, device=d)
-            s.save()
+    print new, rem
+    
+    for r in rem:
+        p = Podcast.objects.get(url=r)
+        s = SubscriptionAction(podcast=p, device=d, action=UNSUBSCRIBE_ACTION)
+        s.save()
     
-    if rem != []:
-        for r in rem:
-            p = Podcast.objects.get(url=r)
-            s = SubscriptionAction(podcast=p, device=d, action=UNSUBSCRIBE_ACTION)
-            s.save()
+    for n in new:
+        p, created = Podcast.objects.get_or_create(url=n,
+            defaults={'title':n,'description':n,'last_update':datetime.now()})
+        s = SubscriptionAction(podcast=p, action=SUBSCRIBE_ACTION, device=d)
+        s.save()
 
     return HttpResponse('Success\n', mimetype='text/plain')
 

commit ae90fc80674e698403859cb7e38c6b19a043a1f5
Merge: e47b16a... 111b10b...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Fri Dec 11 11:40:11 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src
    
    Conflicts:
    	mygpo/api/models.py

commit e47b16aafae9b3f5c1c6f419df9819197ad76f69
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Fri Dec 11 11:33:10 2009 +0100

    	modified:   models.py

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index ee8ab6f..d085318 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -23,8 +23,9 @@ import hashlib
 EPISODE_ACTION_TYPES = (
         ('download', 'downloaded'),
         ('play',     'played'),
-        ('delete',   'deleted'),
-        ('new'),     'marked new')
+        ('sync',     'synced'),
+        ('lock',     'locked'),
+        ('delete',   'deleted')
     )
 
 DEVICE_TYPES = (

commit 111b10b37280685e55b4b419c300d8f29d7a5e54
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Dec 10 18:27:15 2009 +0100

    implemented user account settings (bug 719)
    
    The user account settings can be reached via the navigation bar.
    
    The view uses the mygpo.web.forms.UserAccountForm to display and validate its
    data.

diff --git a/htdocs/media/emblem-default.png b/htdocs/media/emblem-default.png
new file mode 100644
index 0000000..05bff57
Binary files /dev/null and b/htdocs/media/emblem-default.png differ
diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 159a3bb..caca843 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -12,3 +12,27 @@ table.register th {
     text-align:left;
 }
 
+.success
+{
+    background-color: #b7f46e;
+    border: #539800 thin solid;
+    width: 100%;
+    padding: 1em 1em 1em 45px;
+    background-image: url('emblem-default.png');
+    background-repeat: no-repeat;
+    background-position: 3px 50%;
+}
+
+#navigation a
+{
+    color: black;
+}
+
+ul#navigation
+{
+    list-style-type: none;
+    margin: 1em;
+    border: 0;
+    padding: 0;
+}
+
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 97eb6e2..54ffe19 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -37,6 +37,8 @@ urlpatterns = patterns('',
     (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/', 'form_class': RegistrationFormUniqueEmail}),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
     (r'^activate/(?P<activation_key>\w+)$', activate),
+
+    (r'account/$', 'mygpo.web.views.account'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     #Legacy API
diff --git a/mygpo/web/forms.py b/mygpo/web/forms.py
new file mode 100644
index 0000000..3b8cb89
--- /dev/null
+++ b/mygpo/web/forms.py
@@ -0,0 +1,7 @@
+from django import forms
+from django.utils.translation import ugettext as _
+
+class UserAccountForm(forms.Form):
+    email = forms.EmailField(label=_('Your Email Address'))
+    public = forms.BooleanField(required=False, label=_('May we use your subscriptions for the toplist and suggestions?'))
+
diff --git a/mygpo/web/templates/account.html b/mygpo/web/templates/account.html
new file mode 100644
index 0000000..09f3a37
--- /dev/null
+++ b/mygpo/web/templates/account.html
@@ -0,0 +1,19 @@
+{% extends "base.html" %}
+{% load i18n %}
+
+{% block content %}
+  <h1>{% trans "Your Subscriptions" %}</h1>
+
+ {% if success %}
+   <div class="success">{% trans "Your settings have been saved." %}</div>
+ {% endif %}
+
+  <p>Update the settings for your account <strong>{{ user.username }}</strong>.</p>
+  <form action="/account/" method="POST">
+   {{ form.as_p }}
+   <input type="submit" value="Save" />
+  </form>
+
+
+{% endblock %}
+
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 33521f4..f5071f8 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -96,13 +96,15 @@
 	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; background-color:rgb(102, 102, 102);">&nbsp;</span>
 	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; -moz-border-radius-topright: 30px; background-color:rgb(255,255,255);">&nbsp;</span>
 	{% if user.is_authenticated %}
-	<p style="margin-left:10px; color:rgb(70%,70%,70%);">logged in as {{ user.username }}<br />
-	<a href="/logout/">logout!</a>
-	</p>
-    	{% else %}
-	<p style="margin-left:10px; color:rgb(70%,70%,70%);">
-	<a href="/login/">login!</a>
-	</p>
+	<p style="margin-left:10px; color:rgb(70%,70%,70%);">logged in as {{ user.username }}</p>
+    <ul id="navigation">
+     <li><a href="/account/">Account settings</a></li>
+	 <li><a href="/logout/">logout!</a></li>
+    </ul>
+  	{% else %}
+    <ul id="navigation">
+	 <li><a href="/login/">login!</a></li>
+    </ul>
 	{% endif %}
 </div>
 <hr style="clear: both;">
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index feb662e..77a5c57 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -20,6 +20,7 @@ from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
 from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction
+from mygpo.web.forms import UserAccountForm
 
 def home(request):
        if request.user.is_authenticated():
@@ -56,6 +57,30 @@ def create_subscriptionlist(request):
       return subscriptionlist
 
 
+def account(request):
+    success = False
+
+    if request.method == 'POST':
+        form = UserAccountForm(request.POST)
+
+        if form.is_valid():
+            request.user.email = form.cleaned_data['email']
+            request.user.save()
+            request.user.get_profile().public_profile = form.cleaned_data['public']
+            request.user.get_profile().save()
+
+            success = True
+
+    else:
+        form = UserAccountForm({
+            'email': request.user.email,
+            'public': request.user.get_profile().public_profile
+            })
+
+    return render_to_response('account.html', {
+        'form': form,
+        'success': success
+    }, context_instance=RequestContext(request))
 
 
 #sl = SubscriptionAction.objects.filter(podcast=podcast_ids[listindex])

commit 2b5ead7ff066b062c7abb7575e473aed5bb70d9e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Dec 10 18:11:40 2009 +0100

    fix type in api/models.py

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index ee8ab6f..788b2bf 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -24,7 +24,7 @@ EPISODE_ACTION_TYPES = (
         ('download', 'downloaded'),
         ('play',     'played'),
         ('delete',   'deleted'),
-        ('new'),     'marked new')
+        ('new',      'marked new')
     )
 
 DEVICE_TYPES = (

commit 2112f3d4aee197f95f90245a0b3901354c21ff2b
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Dec 10 18:05:48 2009 +0100

    quick fix for the broken layout (bug 712)

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index ec28d94..33521f4 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -77,7 +77,7 @@
 <hr>
 
 
-<div style="margin-right: 5%; padding-top: 80px; padding-bottom: 10px; float:left;">
+<div style="margin-right: 5%; padding-top: 80px; padding-bottom: 10px; float:left; width: 70%">
 
 {% if error_message %}
  <div class="error">{{ error_message }}</div>

commit 177cbc2330d004bb162f194b3f077d8145eb905b
Merge: 0abf6fa... 9923474...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 9 14:44:10 2009 +0100

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit 0abf6fafbed9a117099e6bc043274b9507970647
Merge: c0ee5a1... 21048c2...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 9 14:43:44 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit 99234740c76f1bf22874004e882a4302098707ff
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Dec 9 14:33:17 2009 +0100

    verbessern von simple api und testfllen

diff --git a/mygpo/api/put_test.py b/mygpo/api/put_test.py
index 6c67479..9e9f852 100644
--- a/mygpo/api/put_test.py
+++ b/mygpo/api/put_test.py
@@ -9,11 +9,11 @@ def put_data(dev_uid, format, data, username, password):
     headers['Authorization'] = ' '.join(('Basic', base64.encodestring(':'.join((username, password)))))
     connection.request('PUT', cmd, data, headers)
     response = connection.getresponse()
-    #print response.read()
+    print response.read()
     connection.close()
 
 def get_data(dev_uid, format, username, password):
-    data = ''
+    data = None
     cmd = '/subscriptions/%s/%d.%s' % (username, dev_uid, format)
     connection = httplib.HTTPConnection('127.0.0.1:8000')
     headers = {}
@@ -29,12 +29,10 @@ if __name__ == "__main__":
     p1 = 'http://www.podcast1.com\n'
     p2 = 'http://www.podcast2.com\n'
     p3 = 'http://www.podcast3.com\n'
-    data_txt_1 = '%s\n%s\n' % (p1, p2)
-    data_txt_2 = '%s\n%s\n' % (p2, p3)
+    data_txt_1 = '%s%s\n' % (p1, p2)
+    data_txt_2 = '%s%s\n' % (p2, p3)
     
     put_data(1, 'txt', data_txt_1, u, p)
-    print "1.get"
     get_data(1, 'txt', u, p)
     put_data(1, 'txt', data_txt_2, u, p)
-    print "2. get"
-    get_data(1, 'json', u, p)
+    get_data(1, 'txt', u, p)
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index b8b0ba4..48e45b1 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -24,6 +24,13 @@ from django.core import serializers
 from datetime import datetime
 from mygpo.api.httpresponse import HttpResponseNotAuthorized
 import re
+try:
+    # Try to import the JSON module (if we are on Python 2.6)
+    import json
+except ImportError:
+    # No JSON module available - fallback to simplejson (Python < 2.6)
+    import simplejson as json
+    
 
 @require_valid_user()
 def subscriptions(request, username, device_uid, format):
@@ -78,9 +85,7 @@ def parse_subscription(raw_post_data, format, user, device_uid):
         urls = [p['url'] for p in i.items]
 
     elif format == 'json':
-        sub = raw_post_data[1:-1].split('"')
-        pattern = '^[a-zA-z]'
-        urls = [x for x in sub if re.search(pattern, x) != None]
+        urls = json.loads(raw_post_data)
 
     else: raise ValueError('unsupported format %s' % format)
     
@@ -91,13 +96,12 @@ def parse_subscription(raw_post_data, format, user, device_uid):
     old = [p.url for p in podcasts]    
     new = [p for p in urls if p not in old]
     rem = [p for p in old if p not in urls]
-    
-    return new, rem, d
 
+    return new, rem, d
 
 def set_subscriptions(subscriptions):
     new, rem, d = subscriptions
-    
+
     if new != []:
         for n in new:
             p, created = Podcast.objects.get_or_create(url=n,
@@ -105,11 +109,11 @@ def set_subscriptions(subscriptions):
             s = SubscriptionAction(podcast=p, action=SUBSCRIBE_ACTION, device=d)
             s.save()
     
-    if rem != []: 
+    if rem != []:
         for r in rem:
             p = Podcast.objects.get(url=r)
-            s = SubscriptionAction(podcast=p, action=UNSUBSCRIBE_ACTION, device=d)
+            s = SubscriptionAction(podcast=p, device=d, action=UNSUBSCRIBE_ACTION)
             s.save()
-	
-    return HttpResponse('Success', mimetype='text/plain')
+
+    return HttpResponse('Success\n', mimetype='text/plain')
 
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index f1ff7dc..fe18098 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -19,6 +19,8 @@ from django.test import TestCase
 from django.contrib.auth.models import User
 from mygpo.api.models import Device, Podcast, SubscriptionAction, UserProfile
 from put_test import put_data
+from django.http import HttpRequest
+from mygpo.api.simple import subscriptions
 
 class SyncTest(TestCase):
     def test_sync_actions(self):
@@ -72,9 +74,9 @@ class SimpleTest(TestCase):
         p2 = 'http://www.podcast2.com'
         p3 = 'http://www.podcast3.com'
     
-        d1 = 1
-        d2 = 2
-        d3 = 3
+        d1 = '1'
+        d2 = '2'
+        d3 = '3'
     
         f1 = 'txt'
         f2 = 'json'
@@ -86,11 +88,11 @@ class SimpleTest(TestCase):
         data_json_1 = '[\n"%s",\n"%s"\n]' % (p1, p2)
         data_json_2 = '[\n"%s",\n"%s"\n]' % (p2, p3)
 
-        data_opml_1 = '<?xml version="1.0" encoding="UTF-8"?><opml version="2.0"><head><title>subscription list</title>\
-                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated></head><body>\
-                       <outline text="p1" title="p1" type="rss" xmlUrl="%s"/>\
-                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\
-                       </body></opml>' % (p1, p2)
+        data_opml_1 = '<?xml version="1.0" encoding="UTF-8"?>\n<opml version="2.0">\n<head>\n<title>subscription list</title>\n\
+                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated>\n</head>\n<body>\n\
+                       <outline text="p1" title="p1" type="rss" xmlUrl="%s"/>\n\
+                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\n\
+                       </body>\n</opml>\n' % (p1, p2)
         data_opml_2 = '<?xml version="1.0" encoding="UTF-8"?><opml version="2.0"><head><title>subscription list</title>\
                        <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated></head><body>\
                        <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\
@@ -102,21 +104,28 @@ class SimpleTest(TestCase):
         u  = User.objects.create(username=un, password=pw)
         UserProfile.objects.create(user=u)
         
+        r = HttpRequest()
+        r.method = 'PUT'
+        r.user = u
+        
         #1. put 2 new podcasts
-        p = put_data(d1, f1, data_txt_1, un, pw)
-        #self.assertEqual(p, 'Success')
+        r.raw_post_data = data_txt_1
+        put = subscriptions(request=r, username=un, device_uid=d1, format=f1)
+        self.assertEqual(put.content, "Success\n")
         
         #device 1 txt
-        device = Device.objects.get(uid=d1, user=u)
+        #device = Device.objects.get(uid=d1, user=u)
         
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
-        self.assertEqual( len(s), 2)
+        self.assertEqual( len(urls), 2)
         self.assertEqual(urls[0], p1)
         self.assertEqual(urls[1], p2) 
         
         #2. put 1 new podcast and delete 1 old
-        put_data(d1, f1, data_txt_2, un, pw)
+        r.raw_post_data = data_txt_2
+        subscriptions(request=r, username=un, device_uid=d1, format=f1)
+        
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
@@ -124,7 +133,8 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p3) 
         
         #3. put 2 new podcasts
-        put_data(d2, f2, data_json_1, un, pw)
+        r.raw_post_data = data_json_1
+        subscriptions(request=r, username=un, device_uid=d2, format=f2)
         
         #device 2 json
         device = Device.objects.get(uid=d2, user=u)
@@ -136,7 +146,9 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p2) 
 
         #4. put 1 new podcast and delete 1 old
-        put_data(d2, f2, data_json_2, un, pw)
+        r.raw_post_data = data_json_2
+        subscriptions(request=r, username=un, device_uid=d2, format=f2)
+        
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)
@@ -144,7 +156,8 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p3) 
         
         #5. put 2 new podcasts
-        put_data(d3, f3, data_opml_1, un, pw)
+        r.raw_post_data = data_opml_1
+        subscriptions(request=r, username=un, device_uid=d3, format=f3)
         
         #device 3 opml
         device = Device.objects.get(uid=d3, user=u)
@@ -156,7 +169,9 @@ class SimpleTest(TestCase):
         self.assertEqual(urls[1], p2) 
         
         #6. put 1 new podcast and delete 1 old
-        put_data(d3, f3, data_opml_2, un, pw)
+        r.raw_post_data = data_opml_2
+        subscriptions(request=r, username=un, device_uid=d3, format=f3)
+        
         s = [p.podcast for p in device.get_subscriptions()]
         urls = [p.url for p in s]
         self.assertEqual( len(s), 2)

commit 21048c210e3b3bc10c7542b0b01e5dc9469b371a
Merge: 1d01978... 36ab057...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Dec 4 13:11:30 2009 +0100

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit 1d01978a2c7afb3c7037f2989c6b98fdf0f7e169
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Wed Dec 2 19:44:09 2009 +0100

     Bug 707 -  update toplist as cron job

diff --git a/mygpo/api/update_toplist.py b/mygpo/api/update_toplist.py
new file mode 100644
index 0000000..480b79f
--- /dev/null
+++ b/mygpo/api/update_toplist.py
@@ -0,0 +1,17 @@
+#!/usr/bin/python
+
+import sys
+import MySQLdb
+
+try:
+    mysql = MySQLdb.connect(user="mygpo_prod",passwd="",db="mygpo_prod")
+    mysql_cursor = mysql.cursor() 
+    
+    mysql_cursor.callproc( "update_toplist", () )
+    
+    mysql_cursor.close() 
+    mysql.close()
+
+except MySQLdb.Error, e:
+    print "MySQL Error %d:  %s" % ( e.args[0], e.args[1] )
+    sys.exit(1)

commit 36ab057708627b33c7ac963037b2892e4a7fe8e5
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Dec 2 11:23:36 2009 +0100

    	modified:   put_test.py
    	modified:   simple.py

diff --git a/mygpo/api/put_test.py b/mygpo/api/put_test.py
index 6e2b778..6c67479 100644
--- a/mygpo/api/put_test.py
+++ b/mygpo/api/put_test.py
@@ -11,3 +11,30 @@ def put_data(dev_uid, format, data, username, password):
     response = connection.getresponse()
     #print response.read()
     connection.close()
+
+def get_data(dev_uid, format, username, password):
+    data = ''
+    cmd = '/subscriptions/%s/%d.%s' % (username, dev_uid, format)
+    connection = httplib.HTTPConnection('127.0.0.1:8000')
+    headers = {}
+    headers['Authorization'] = ' '.join(('Basic', base64.encodestring(':'.join((username, password)))))
+    connection.request('GET', cmd, data, headers)
+    response = connection.getresponse()
+    print response.read()
+    connection.close()
+    
+if __name__ == "__main__":
+    u = 'ale'
+    p = 'ale'
+    p1 = 'http://www.podcast1.com\n'
+    p2 = 'http://www.podcast2.com\n'
+    p3 = 'http://www.podcast3.com\n'
+    data_txt_1 = '%s\n%s\n' % (p1, p2)
+    data_txt_2 = '%s\n%s\n' % (p2, p3)
+    
+    put_data(1, 'txt', data_txt_1, u, p)
+    print "1.get"
+    get_data(1, 'txt', u, p)
+    put_data(1, 'txt', data_txt_2, u, p)
+    print "2. get"
+    get_data(1, 'json', u, p)
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index db825b2..b8b0ba4 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -70,14 +70,15 @@ def get_subscriptions(user, device_uid):
 def parse_subscription(raw_post_data, format, user, device_uid):
     if format == 'txt':
         sub = raw_post_data.split('\n')
-        urls = [x for x in sub if x != '\r']
+        p = '^[a-zA-z]'
+        urls = [x for x in sub if re.search(p, x) != None]
 
     elif format == 'opml':
         i = Importer(content=raw_post_data)
         urls = [p['url'] for p in i.items]
 
     elif format == 'json':
-        sub = raw_post_data.split('"')
+        sub = raw_post_data[1:-1].split('"')
         pattern = '^[a-zA-z]'
         urls = [x for x in sub if re.search(pattern, x) != None]
 

commit 7d5573c415f261b5c6a58135c9f2a7e9c5228535
Merge: df813b2... cdcbce5...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Dec 2 10:35:23 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit cdcbce547835903996dc00461c7e89aa641f53e4
Merge: 15f7c6e... 8fab322...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Wed Dec 2 08:44:59 2009 +0000

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit 15f7c6ed5f7536e26d29b5e70b512ff9d4a8b191
Merge: 92d6761... 8138990...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Wed Dec 2 08:44:52 2009 +0000

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit df813b2d69f19284e3605746326b4555ee0b0728
Merge: 8fab322... 92d6761...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Dec 2 00:50:48 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit 8fab3227460e3da4bcbd7a4fba8de6508293d0c0
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Wed Dec 2 00:49:30 2009 +0100

    testcases added + 401 error simple api
    	new file:   httpresponse.py
    	new file:   put_test.py
    	modified:   simple.py
    	modified:   tests.py

diff --git a/mygpo/api/httpresponse.py b/mygpo/api/httpresponse.py
new file mode 100644
index 0000000..9f76e8c
--- /dev/null
+++ b/mygpo/api/httpresponse.py
@@ -0,0 +1,8 @@
+from django.http import HttpResponse
+
+def HttpResponseNotAuthorized():
+    response =  HttpResponse(('You\'re not authorized to visit this area!'), mimetype="text/plain")
+    response['WWW-Authenticate'] = 'Basic realm=""'
+    response.status_code = 401
+    return response
+
diff --git a/mygpo/api/put_test.py b/mygpo/api/put_test.py
new file mode 100644
index 0000000..6e2b778
--- /dev/null
+++ b/mygpo/api/put_test.py
@@ -0,0 +1,13 @@
+import sys
+import httplib
+import base64
+
+def put_data(dev_uid, format, data, username, password):
+    cmd = '/subscriptions/%s/%d.%s' % (username, dev_uid, format)
+    connection = httplib.HTTPConnection('127.0.0.1:8000')
+    headers = {}
+    headers['Authorization'] = ' '.join(('Basic', base64.encodestring(':'.join((username, password)))))
+    connection.request('PUT', cmd, data, headers)
+    response = connection.getresponse()
+    #print response.read()
+    connection.close()
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index a659301..db825b2 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -22,19 +22,21 @@ from mygpo.api.opml import Exporter, Importer
 from mygpo.api.json import JsonResponse
 from django.core import serializers
 from datetime import datetime
+from mygpo.api.httpresponse import HttpResponseNotAuthorized
 import re
 
 @require_valid_user()
 def subscriptions(request, username, device_uid, format):
     
     if request.user.username != username:
-        return HttpResponseForbidden()
+        #throw 401
+        return HttpResponseNotAuthorized()
 
     if request.method == 'GET':
-        return format_subscriptions(get_subscriptions(username, device_uid), format, username)
+        return format_subscriptions(get_subscriptions(request.user, device_uid), format, username)
         
     elif request.method == 'PUT':
-        return set_subscriptions(parse_subscription(request.raw_post_data, format, username, device_uid))
+        return set_subscriptions(parse_subscription(request.raw_post_data, format, request.user, device_uid))
     else:
         return HttpResponseBadReqest()
 
@@ -44,6 +46,7 @@ def format_subscriptions(subscriptions, format, username):
         #return subscriptions formatted as txt
         urls = [p.url for p in subscriptions]
         s = "\n".join(urls)
+        s += "\n"
         return HttpResponse(s, mimetype='text/plain')
 
     elif format == 'opml':
@@ -56,18 +59,18 @@ def format_subscriptions(subscriptions, format, username):
         urls = [p.url for p in subscriptions]
         return JsonResponse(urls)
 
-def get_subscriptions(username, device_uid):
+def get_subscriptions(user, device_uid):
     #get and return subscription list from database (use backend to sync)
     try:
-        d = Device.objects.get(uid=device_uid, user__username=username)
+        d = Device.objects.get(uid=device_uid, user=user)
     except Device.DoesNotExist:
-        raise Http404
+        raise Http404('Device doesn\'t exist!')
     return [p.podcast for p in d.get_subscriptions()]
 
-def parse_subscription(raw_post_data, format, username, device_uid):
+def parse_subscription(raw_post_data, format, user, device_uid):
     if format == 'txt':
-	    urls = raw_post_data.split('\n')
-	    urls = [x for x in urls if x != '\r']
+        sub = raw_post_data.split('\n')
+        urls = [x for x in sub if x != '\r']
 
     elif format == 'opml':
         i = Importer(content=raw_post_data)
@@ -75,32 +78,37 @@ def parse_subscription(raw_post_data, format, username, device_uid):
 
     elif format == 'json':
         sub = raw_post_data.split('"')
-        pattern = '^[a-zA-z]+'
+        pattern = '^[a-zA-z]'
         urls = [x for x in sub if re.search(pattern, x) != None]
 
     else: raise ValueError('unsupported format %s' % format)
-
-    d, created = Device.objects.get_or_create(user__username=username, uid=device_uid, defaults = {'type': 'other', 'name': 'unknown'})
+    
+    d, created = Device.objects.get_or_create(user=user, uid=device_uid, 
+                defaults = {'type': 'other', 'name': 'unknown_' + device_uid})
+    
     podcasts = [p.podcast for p in d.get_subscriptions()]
-    old = [p.url for p in podcasts]
+    old = [p.url for p in podcasts]    
     new = [p for p in urls if p not in old]
     rem = [p for p in old if p not in urls]
-    return new, rem, username, d
+    
+    return new, rem, d
 
 
 def set_subscriptions(subscriptions):
-    new, rem, username, d = subscriptions
+    new, rem, d = subscriptions
     
-    print new
-    for r in rem:
-	    s = SubscriptionAction(podcast=r, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
-	    s.save()
+    if new != []:
+        for n in new:
+            p, created = Podcast.objects.get_or_create(url=n,
+                        defaults={'title':n,'description':n,'last_update':datetime.now()})
+            s = SubscriptionAction(podcast=p, action=SUBSCRIBE_ACTION, device=d)
+            s.save()
+    
+    if rem != []: 
+        for r in rem:
+            p = Podcast.objects.get(url=r)
+            s = SubscriptionAction(podcast=p, action=UNSUBSCRIBE_ACTION, device=d)
+            s.save()
 	
-    for n in new:
-        p, created = Podcast.objects.get_or_create(url=n,defaults={'title':n,'description':n,'last_update':datetime.now()})
-        
-        s = SubscriptionAction(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
-        s.save()
-        
     return HttpResponse('Success', mimetype='text/plain')
 
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 09a5ad4..f1ff7dc 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -17,7 +17,8 @@
 
 from django.test import TestCase
 from django.contrib.auth.models import User
-from mygpo.api.models import Device, Podcast, SubscriptionAction
+from mygpo.api.models import Device, Podcast, SubscriptionAction, UserProfile
+from put_test import put_data
 
 class SyncTest(TestCase):
     def test_sync_actions(self):
@@ -65,5 +66,100 @@ class SyncTest(TestCase):
         self.assertEqual( sa2[p1].podcast, p1)
         self.assertEqual( sa2[p1].action, 1)
 
+class SimpleTest(TestCase):
+    def test_put_get_data(self):
+        p1 = 'http://www.podcast1.com'
+        p2 = 'http://www.podcast2.com'
+        p3 = 'http://www.podcast3.com'
+    
+        d1 = 1
+        d2 = 2
+        d3 = 3
+    
+        f1 = 'txt'
+        f2 = 'json'
+        f3 = 'opml'
+    
+        data_txt_1 = '%s\n%s\n' % (p1, p2)
+        data_txt_2 = '%s\n%s\n' % (p2, p3)
+    
+        data_json_1 = '[\n"%s",\n"%s"\n]' % (p1, p2)
+        data_json_2 = '[\n"%s",\n"%s"\n]' % (p2, p3)
 
+        data_opml_1 = '<?xml version="1.0" encoding="UTF-8"?><opml version="2.0"><head><title>subscription list</title>\
+                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated></head><body>\
+                       <outline text="p1" title="p1" type="rss" xmlUrl="%s"/>\
+                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\
+                       </body></opml>' % (p1, p2)
+        data_opml_2 = '<?xml version="1.0" encoding="UTF-8"?><opml version="2.0"><head><title>subscription list</title>\
+                       <dateCreated>Tue, 01 Dec 2009 10:06:18 +0000</dateCreated></head><body>\
+                       <outline text="p2" title="p2" type="rss" xmlUrl="%s"/>\
+                       <outline text="p3" title="p3" type="rss" xmlUrl="%s"/>\
+                       </body></opml>' % (p2, p3)
+    
+        un = 'u'
+        pw = 'u'
+        u  = User.objects.create(username=un, password=pw)
+        UserProfile.objects.create(user=u)
+        
+        #1. put 2 new podcasts
+        p = put_data(d1, f1, data_txt_1, un, pw)
+        #self.assertEqual(p, 'Success')
+        
+        #device 1 txt
+        device = Device.objects.get(uid=d1, user=u)
+        
+        s = [p.podcast for p in device.get_subscriptions()]
+        urls = [p.url for p in s]
+        self.assertEqual( len(s), 2)
+        self.assertEqual(urls[0], p1)
+        self.assertEqual(urls[1], p2) 
+        
+        #2. put 1 new podcast and delete 1 old
+        put_data(d1, f1, data_txt_2, un, pw)
+        s = [p.podcast for p in device.get_subscriptions()]
+        urls = [p.url for p in s]
+        self.assertEqual( len(s), 2)
+        self.assertEqual(urls[0], p2)
+        self.assertEqual(urls[1], p3) 
+        
+        #3. put 2 new podcasts
+        put_data(d2, f2, data_json_1, un, pw)
+        
+        #device 2 json
+        device = Device.objects.get(uid=d2, user=u)
+        
+        s = [p.podcast for p in device.get_subscriptions()]
+        urls = [p.url for p in s]
+        self.assertEqual( len(s), 2)
+        self.assertEqual(urls[0], p1)
+        self.assertEqual(urls[1], p2) 
+
+        #4. put 1 new podcast and delete 1 old
+        put_data(d2, f2, data_json_2, un, pw)
+        s = [p.podcast for p in device.get_subscriptions()]
+        urls = [p.url for p in s]
+        self.assertEqual( len(s), 2)
+        self.assertEqual(urls[0], p2)
+        self.assertEqual(urls[1], p3) 
+        
+        #5. put 2 new podcasts
+        put_data(d3, f3, data_opml_1, un, pw)
+        
+        #device 3 opml
+        device = Device.objects.get(uid=d3, user=u)
+        
+        s = [p.podcast for p in device.get_subscriptions()]
+        urls = [p.url for p in s]
+        self.assertEqual( len(s), 2)
+        self.assertEqual(urls[0], p1)
+        self.assertEqual(urls[1], p2) 
+        
+        #6. put 1 new podcast and delete 1 old
+        put_data(d3, f3, data_opml_2, un, pw)
+        s = [p.podcast for p in device.get_subscriptions()]
+        urls = [p.url for p in s]
+        self.assertEqual( len(s), 2)
+        self.assertEqual(urls[0], p2)
+        self.assertEqual(urls[1], p3) 
 

commit c0ee5a105bb9836ed95ac48c20ccb25b67927154
Merge: 92d6761... 8138990...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 2 00:41:53 2009 +0100

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 92d6761e3824230e81b5676b00f81bfb20c2b213
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 2 00:27:04 2009 +0100

    updated advanced api to new specifications

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 78aa1c5..e0b17d0 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -63,6 +63,7 @@ def subscriptions(request, username, device_uid):
     else:
         return HttpResponseNotAllowed(['GET', 'POST'])
 
+
 def update_subscriptions(user, device, add, remove):
     for add in actions['add']:
         p = Podcast.objects.get_or_create(url=add)
@@ -72,9 +73,10 @@ def update_subscriptions(user, device, add, remove):
         p = Podcast.objects.get_or_create(url=remove)
         s = SubscriptionAction.objects.create(podcast=p,device=d,action=UNSUBSCRIBE_ACTION)
 
+
 def get_subscription_changes(user, device, since, until):
     actions = {}
-    for a in SubscriptionAction.objects.filter(device=device, timestamp__gt=since).order_by('timestamp'):
+    for a in SubscriptionAction.objects.filter(device=device, timestamp__gt=since, timestamp__lt=until).order_by('timestamp'):
         #ordered by ascending date; newer entries overwriter older ones
         actions[a.podcast] = a
 
@@ -89,6 +91,7 @@ def get_subscription_changes(user, device, since, until):
 
     return {'add': add, 'remove': remove, 'timestamp': until}
 
+
 @require_valid_user()
 def episodes(request, username):
 
@@ -106,8 +109,38 @@ def episodes(request, username):
         update_episodes(request.user, actions)
         return HttpResponse()
 
+    elif request.method == 'GET':
+        podcast_id = request.GET.get('podcast', None)
+        device_id  = request.GET.get('device', None)
+        since      = request.GET.get('since', None)
+
+        try:
+            podcast = Podcast.objects.get(pk=podcast_id) if podcast_id else None
+            device  = Device.objects.get(pk=device_id) if device_id else None
+        except:
+            return Http404
+
+        return JsonRequest(get_episode_changes(request.user, podcast, device, since, now))
+
     else:
-        return HttpResponseNotAllowed(['POST'])
+        return HttpResponseNotAllowed(['POST', 'GET'])
+
+
+def get_episode_changes(user, podcast, device, since, until).
+    actions = []
+    for a in EpisodeAction.objects.filter(user=user, podcast=podcast, device=device, timestamp__gt=since, timestamp__lt=until):
+        action = {
+            'podcast': a.episode.podcast.url,
+            'episode': a.episode.url,
+            'action':  a.action,
+            'timestamp': a.timestamp
+        }
+
+        if a.action == 'play': action['time'] = a.playmark
+
+        actions.append(action)
+
+    return {'timestamp': since, 'actions': actions}
 
 
 def update_episodes(user, actions):
@@ -130,6 +163,7 @@ def update_episodes(user, actions):
 
         EpisodeAction.objects.create(user=user, episode=episode, device=device, action=action, timestamp=timestamp, playmark=position)
 
+
 @require_valid_user()
 def device(request, username, device_uid):
 
@@ -146,7 +180,7 @@ def device(request, username, device_uid):
 
         if 'type' in data:
             if not data['type'] in DEVICE_TYPES:
-                return 
+                return HttpResponseBadRequest('invalid device type %s' % data['type'])
             d.type = data['type']
 
         d.save()

commit 415f7651eb367b95fe3502bdfca729567438a33e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Wed Dec 2 00:25:49 2009 +0100

    updated episode actions in db and models

diff --git a/install/update-04.sql b/install/update-04.sql
index 76027a5..dc5090b 100644
--- a/install/update-04.sql
+++ b/install/update-04.sql
@@ -83,4 +83,5 @@ END;//
 DELIMITER ;
 
 
+ALTER TABLE episode_log MODIFY action ENUM ('download', 'play', 'delete', 'new') NOT NULL;
 
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index d085318..ee8ab6f 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -23,9 +23,8 @@ import hashlib
 EPISODE_ACTION_TYPES = (
         ('download', 'downloaded'),
         ('play',     'played'),
-        ('sync',     'synced'),
-        ('lock',     'locked'),
-        ('delete',   'deleted')
+        ('delete',   'deleted'),
+        ('new'),     'marked new')
     )
 
 DEVICE_TYPES = (

commit 8138990c3fc217e936c566fb77d4a81a7eb797a7
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Wed Dec 2 00:16:55 2009 +0100

    Added the first draft of a basic subscriptionlist

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index b25325e..e6c0eaa 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -8,15 +8,19 @@
 	<tr>
 		<th style="padding-right:100px;">{{ test }}</th>
 		<th style="padding-right:200px;">Title</th>
-		<th style="padding-right:200px;">Latest Episode</th>
+		<!-- th style="padding-right:200px;">Latest Episode</th -->
 		<th style="padding-right:200px;">Devices</th>
 	</tr>
        {% for s in subscriptionlist %}
 	<tr>
-		<td>{{ s.logo_url }}</td>
+		<td> 
+                  {% if s.logo %}
+                  <img src="{{ s.logo }}" style="width:40px; height:30px;" />
+                  {% endif %}                  
+              </td>
 		<td>{{ s.title }}</td>
-		<td>Episode</td>
-		<td>device</td>
+		<!-- td>{{ s.episode }}</td -->
+		<td>{{ s.device }}</td>
 	</tr>
        {% endfor %}
   </table>
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 6098c6b..feb662e 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -41,9 +41,24 @@ def create_subscriptionlist(request):
       device_ids = [d.id for d in device]
       sublog = SubscriptionAction.objects.filter(device__in=device_ids)
       sublog_podcastids = [s.podcast_id for s in sublog]
-      podcast = Podcast.objects.filter(id__in=sublog_podcastids)
+
+      podcast = Podcast.objects.filter(id__in=sublog_podcastids).order_by('title')
       subscriptionlist = [{'title': p.title, 'logo': p.logo_url, 'id': p.id} for p in podcast]
+
       for index, entry in enumerate(subscriptionlist):
+            sublog_for_device = SubscriptionAction.objects.filter(podcast__id=subscriptionlist[index]['id'])
+            sublog_devids = [s.device.id for s in sublog_for_device]
+            dev = Device.objects.filter(id__in=sublog_devids, user__id=userid).values_list('name', flat=True)
+            subscriptionlist[index]['device'] = ''
+            for d in dev:
+                 subscriptionlist[index]['device'] += d + ", "
             subscriptionlist[index]['episode'] = 'epi'
       return subscriptionlist
 
+
+
+
+#sl = SubscriptionAction.objects.filter(podcast=podcast_ids[listindex])
+#sldev_ids = [s.device.id for s in sl]  
+#dev = Device.objects.filter(id__in=sldev_ids)
+#dev_names = [d.name for d in dev]

commit f4919ead9793ee5622122d90db1bf859d88bf4da
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Dec 1 23:38:41 2009 +0100

    Podcasts are read and displayed in the subscriptionlist - todo: read episodes and devices

diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index 56a0987..b25325e 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -6,19 +6,19 @@
   <p>{% trans "This page is currently in development." %}</p>
   <table style="width:100%;">
 	<tr>
-		<th style="padding-right:100px;"></th>
+		<th style="padding-right:100px;">{{ test }}</th>
 		<th style="padding-right:200px;">Title</th>
 		<th style="padding-right:200px;">Latest Episode</th>
 		<th style="padding-right:200px;">Devices</th>
 	</tr>
        {% for s in subscriptionlist %}
 	<tr>
-		<td>{{ s.logo }}</td>
+		<td>{{ s.logo_url }}</td>
 		<td>{{ s.title }}</td>
 		<td>Episode</td>
-		<td>{{ s.device }}</td>
+		<td>device</td>
 	</tr>
-       {% endfor %} 
+       {% endfor %}
   </table>
 {% endblock %}
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 87eb69a..6098c6b 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -23,31 +23,10 @@ from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeActio
 
 def home(request):
        if request.user.is_authenticated():
-              userid = UserProfile.objects.filter(user=request.user)[0].id
-              device = Device.objects.filter(user=userid)
-              device_ids = [d.id for d in device]
-              sublog = SubscriptionAction.objects.filter(device__in=device_ids)
-              sublog_podcastids = [s.podcast_id for s in sublog]
-              podcast = Podcast.objects.filter(id__in=sublog_podcastids)
-              podcast_titles = [p.title for p in podcast]
-              podcast_logourls = [p.logo_url for p in podcast]
-              podcast_ids = [p.id for p in podcast]
-                       
-              subscriptionlist = Ddict( dict )
-
-              for listindex, title in enumerate(podcast_titles):
-                    subscriptionlist[listindex]['logo'] = podcast_logourls[listindex]
-                    subscriptionlist[listindex]['title'] = title                     
-                    
-                    sl = SubscriptionAction.objects.filter(podcast=podcast_ids[listindex])
-                    sldev_ids = [s.device.id for s in sl]  
-                    dev = Device.objects.filter(id__in=sldev_ids)
-                    dev_names = [d.name for d in dev]
-                    subscriptionlist[listindex]['device'] = dev_names                          
+              subscriptionlist = create_subscriptionlist(request)              
 
               return render_to_response('home-user.html', {
-                    'subscriptionlist': subscriptionlist,
-                    'test': subscriptionlist[0]['device']
+                    'subscriptionlist': subscriptionlist
               }, context_instance=RequestContext(request))
 
        else:
@@ -56,12 +35,15 @@ def home(request):
                     'podcast_count': podcasts
               })
 
-class Ddict(dict):
-    def __init__(self, default=None):
-        self.default = default
-
-    def __getitem__(self, key):
-        if not self.has_key(key):
-            self[key] = self.default()
-        return dict.__getitem__(self, key)
+def create_subscriptionlist(request):
+      userid = UserProfile.objects.filter(user=request.user)[0].id
+      device = Device.objects.filter(user__id=userid)
+      device_ids = [d.id for d in device]
+      sublog = SubscriptionAction.objects.filter(device__in=device_ids)
+      sublog_podcastids = [s.podcast_id for s in sublog]
+      podcast = Podcast.objects.filter(id__in=sublog_podcastids)
+      subscriptionlist = [{'title': p.title, 'logo': p.logo_url, 'id': p.id} for p in podcast]
+      for index, entry in enumerate(subscriptionlist):
+            subscriptionlist[index]['episode'] = 'epi'
+      return subscriptionlist
 

commit 4a3b08f09673c547de395b1f0e5e2a46408a0396
Merge: af4546c... 3b32dcc...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Dec 1 19:58:20 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit c419221c34c8e2dd315faaa848e840a615b4e2bb
Merge: 3b32dcc... af4546c...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 1 16:52:24 2009 +0100

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 3b32dccfb3870085ac797fe52fcc0caf9e90567d
Merge: 44c4c58... 6bdf21d...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 1 16:39:44 2009 +0100

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit 44c4c58bc33e30f54a3bd0517fcc1bb6b8459b0e
Merge: e9e1b64... 16529b8...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 1 16:29:02 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src
    
    Conflicts:
    	install/update-04.sql

commit e9e1b646b74e79e7f8a54856141618f1d8df4c27
Merge: 18c7f83... 1f66fe9...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Dec 1 15:58:39 2009 +0100

    Merge branch 'master' of sk:~/mygpo-src

commit 6bdf21df4bb3bc630e0aa46687576a93c8957922
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Tue Dec 1 15:29:49 2009 +0100

    simple api 404 error
    	modified:   simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index e1f245a..a659301 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -58,7 +58,10 @@ def format_subscriptions(subscriptions, format, username):
 
 def get_subscriptions(username, device_uid):
     #get and return subscription list from database (use backend to sync)
-    d = Device.objects.get(uid=device_uid, user__username=username)
+    try:
+        d = Device.objects.get(uid=device_uid, user__username=username)
+    except Device.DoesNotExist:
+        raise Http404
     return [p.podcast for p in d.get_subscriptions()]
 
 def parse_subscription(raw_post_data, format, username, device_uid):

commit af4546c84a2f0b729fa2d248d053253a26452034
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Dec 1 14:50:23 2009 +0100

    Started with subscription list

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 8b81a38..ec28d94 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -99,6 +99,10 @@
 	<p style="margin-left:10px; color:rgb(70%,70%,70%);">logged in as {{ user.username }}<br />
 	<a href="/logout/">logout!</a>
 	</p>
+    	{% else %}
+	<p style="margin-left:10px; color:rgb(70%,70%,70%);">
+	<a href="/login/">login!</a>
+	</p>
 	{% endif %}
 </div>
 <hr style="clear: both;">
diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index efd807b..56a0987 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -4,5 +4,21 @@
 {% block content %}
   <h1>{% trans "Your Subscriptions" %}</h1>
   <p>{% trans "This page is currently in development." %}</p>
+  <table style="width:100%;">
+	<tr>
+		<th style="padding-right:100px;"></th>
+		<th style="padding-right:200px;">Title</th>
+		<th style="padding-right:200px;">Latest Episode</th>
+		<th style="padding-right:200px;">Devices</th>
+	</tr>
+       {% for s in subscriptionlist %}
+	<tr>
+		<td>{{ s.logo }}</td>
+		<td>{{ s.title }}</td>
+		<td>Episode</td>
+		<td>{{ s.device }}</td>
+	</tr>
+       {% endfor %} 
+  </table>
 {% endblock %}
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 8f5386e..87eb69a 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -19,11 +19,36 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
 from django.template import RequestContext
-from mygpo.api.models import Podcast
+from mygpo.api.models import Podcast, UserProfile, Episode, Device, EpisodeAction, SubscriptionAction
 
 def home(request):
        if request.user.is_authenticated():
-              return render_to_response('home-user.html', context_instance=RequestContext(request))
+              userid = UserProfile.objects.filter(user=request.user)[0].id
+              device = Device.objects.filter(user=userid)
+              device_ids = [d.id for d in device]
+              sublog = SubscriptionAction.objects.filter(device__in=device_ids)
+              sublog_podcastids = [s.podcast_id for s in sublog]
+              podcast = Podcast.objects.filter(id__in=sublog_podcastids)
+              podcast_titles = [p.title for p in podcast]
+              podcast_logourls = [p.logo_url for p in podcast]
+              podcast_ids = [p.id for p in podcast]
+                       
+              subscriptionlist = Ddict( dict )
+
+              for listindex, title in enumerate(podcast_titles):
+                    subscriptionlist[listindex]['logo'] = podcast_logourls[listindex]
+                    subscriptionlist[listindex]['title'] = title                     
+                    
+                    sl = SubscriptionAction.objects.filter(podcast=podcast_ids[listindex])
+                    sldev_ids = [s.device.id for s in sl]  
+                    dev = Device.objects.filter(id__in=sldev_ids)
+                    dev_names = [d.name for d in dev]
+                    subscriptionlist[listindex]['device'] = dev_names                          
+
+              return render_to_response('home-user.html', {
+                    'subscriptionlist': subscriptionlist,
+                    'test': subscriptionlist[0]['device']
+              }, context_instance=RequestContext(request))
 
        else:
               podcasts = Podcast.objects.count()
@@ -31,3 +56,12 @@ def home(request):
                     'podcast_count': podcasts
               })
 
+class Ddict(dict):
+    def __init__(self, default=None):
+        self.default = default
+
+    def __getitem__(self, key):
+        if not self.has_key(key):
+            self[key] = self.default()
+        return dict.__getitem__(self, key)
+

commit 16529b837e2f663a6d006e921f0059025174dff6
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Tue Dec 1 14:01:52 2009 +0100

    Bug 607 trigger for episode

diff --git a/install/update-03.sql b/install/update-03.sql
index 528dda6..99c8430 100644
--- a/install/update-03.sql
+++ b/install/update-03.sql
@@ -5,23 +5,23 @@ DELIMITER //
 CREATE TRIGGER subscription_log_trigger BEFORE INSERT ON subscription_log
 FOR EACH ROW
 BEGIN
-	declare help_id INT;
-	set help_id = 0;
-
-	SELECT count(a.user_id) into help_id FROM current_subscription a 
-			where a.device_id = new.device_id
-			and a.podcast_id = new.podcast_id;
-
-	IF new.action = 1 THEN
-		
-		IF help_id > 0 THEN
-			call Fail('This subscription already exists!');
-		END IF;
-    	ELSE
-    		IF help_id < 1 THEN
-			call Fail('This subscription not exists!');
-		END IF;
-    	END IF;
+    declare help_id INT;
+    set help_id = 0;
+
+    SELECT count(a.user_id) into help_id FROM current_subscription a 
+            where a.device_id = new.device_id
+            and a.podcast_id = new.podcast_id;
+
+    IF new.action = 1 THEN
+        
+        IF help_id > 0 THEN
+            call Fail('This subscription already exists!');
+        END IF;
+        ELSE
+            IF help_id < 1 THEN
+            call Fail('This subscription not exists!');
+        END IF;
+        END IF;
 
 END;//
 DELIMITER ;
@@ -32,14 +32,14 @@ DELIMITER //
 CREATE TRIGGER podcast_trig_url_unique BEFORE INSERT ON podcast
 FOR EACH ROW
 BEGIN
-	declare help_url varchar(3000);
-	set help_url = 0;
+    declare help_url INT;
+    set help_url = 0;
   
-   	SELECT count(a.url) into help_url FROM podcast a where a.url=new.url;
+       SELECT count(a.url) into help_url FROM podcast a where a.url=new.url;
 
-	IF help_url > 0 THEN
-		call Fail('This URL already exists!');
-	END IF;
+    IF help_url > 0 THEN
+        call Fail('This URL already exists!');
+    END IF;
 
 END;//
 DELIMITER ;
@@ -65,38 +65,38 @@ DELIMITER $$
 DROP PROCEDURE IF EXISTS update_toplist $$
 CREATE PROCEDURE update_toplist()
 BEGIN
-	DECLARE deadlock INT DEFAULT 0;
-    	DECLARE attempts INT DEFAULT 0;
-
-	try_loop:WHILE (attempts<3) DO
-	BEGIN
-		DECLARE deadlock_detected CONDITION FOR 1213;
-    		DECLARE EXIT HANDLER FOR deadlock_detected
-    			BEGIN
-    				ROLLBACK;
-    				SET deadlock=1;
-    			END;
-    		SET deadlock=0;
-   			
-    		START TRANSACTION;
-			DELETE FROM toplist;
-			INSERT INTO toplist (SELECT a.podcast_id, COUNT(*) AS count_subscription
-						FROM (SELECT DISTINCT podcast_id, user_id 
-							FROM public_subscription) a 
-						GROUP BY podcast_id);
-			
-			COMMIT;
-		END;
-		IF deadlock=0 THEN
-    			LEAVE try_loop;
-    		ELSE
-    			SET attempts=attempts+1;
-    		END IF;
-    	END WHILE try_loop;
-
-	IF deadlock=1 THEN
-		call FAIL('Toplist is not updated!');
-	END IF;
+    DECLARE deadlock INT DEFAULT 0;
+        DECLARE attempts INT DEFAULT 0;
+
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+        DECLARE deadlock_detected CONDITION FOR 1213;
+            DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+            SET deadlock=0;
+               
+            START TRANSACTION;
+            DELETE FROM toplist;
+            INSERT INTO toplist (SELECT a.podcast_id, COUNT(*) AS count_subscription
+                        FROM (SELECT DISTINCT podcast_id, user_id 
+                            FROM public_subscription) a 
+                        GROUP BY podcast_id);
+            
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+        END WHILE try_loop;
+
+    IF deadlock=1 THEN
+        call FAIL('Toplist is not updated!');
+    END IF;
 
 END $$
 DELIMITER ;
diff --git a/install/update-04.sql b/install/update-04.sql
index e793225..d5d0ab9 100644
--- a/install/update-04.sql
+++ b/install/update-04.sql
@@ -7,49 +7,49 @@ DELIMITER $$
 DROP PROCEDURE IF EXISTS update_toplist $$
 CREATE PROCEDURE update_toplist()
 BEGIN
-	DECLARE deadlock INT DEFAULT 0;
-    	DECLARE attempts INT DEFAULT 0;
+    DECLARE deadlock INT DEFAULT 0;
+        DECLARE attempts INT DEFAULT 0;
 
-	DROP TABLE IF EXISTS toplist_temp;
-	CREATE TABLE toplist_temp (
-    		podcast_id INT PRIMARY KEY REFERENCES podcast (id),
-    		subscription_count INT NOT NULL DEFAULT 0,
-        	INDEX(podcast_id)
-	);
+    DROP TABLE IF EXISTS toplist_temp;
+    CREATE TABLE toplist_temp (
+            podcast_id INT PRIMARY KEY REFERENCES podcast (id),
+            subscription_count INT NOT NULL DEFAULT 0,
+            INDEX(podcast_id)
+    );
 
-	try_loop:WHILE (attempts<3) DO
-	BEGIN
-		DECLARE deadlock_detected CONDITION FOR 1213;
-    		DECLARE EXIT HANDLER FOR deadlock_detected
-    			BEGIN
-    				ROLLBACK;
-    				SET deadlock=1;
-    			END;
-    		SET deadlock=0;
-   			
-    		START TRANSACTION;
-			DELETE FROM toplist_temp;
-			INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription
-						FROM (SELECT DISTINCT podcast_id, user_id 
-							FROM public_subscription) a 
-						GROUP BY podcast_id);
-			DELETE FROM toplist;
-			INSERT INTO toplist (SELECT podcast_id, subscription_count FROM toplist_temp
-						ORDER BY subscription_count DESC LIMIT 100);
-			
-			COMMIT;
-		END;
-		IF deadlock=0 THEN
-    			LEAVE try_loop;
-    		ELSE
-    			SET attempts=attempts+1;
-    		END IF;
-    		END WHILE try_loop;
+    try_loop:WHILE (attempts<3) DO
+    BEGIN
+        DECLARE deadlock_detected CONDITION FOR 1213;
+            DECLARE EXIT HANDLER FOR deadlock_detected
+                BEGIN
+                    ROLLBACK;
+                    SET deadlock=1;
+                END;
+            SET deadlock=0;
+               
+            START TRANSACTION;
+            DELETE FROM toplist_temp;
+            INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription
+                        FROM (SELECT DISTINCT podcast_id, user_id 
+                            FROM public_subscription) a 
+                        GROUP BY podcast_id);
+            DELETE FROM toplist;
+            INSERT INTO toplist (SELECT podcast_id, subscription_count FROM toplist_temp
+                        ORDER BY subscription_count DESC LIMIT 100);
+            
+            COMMIT;
+        END;
+        IF deadlock=0 THEN
+                LEAVE try_loop;
+            ELSE
+                SET attempts=attempts+1;
+            END IF;
+            END WHILE try_loop;
 
-		IF deadlock=1 THEN
-			call FAIL('Toplist is not updated!');
-		END IF;
-		DROP TABLE IF EXISTS toplist_temp;
+        IF deadlock=1 THEN
+            call FAIL('Toplist is not updated!');
+        END IF;
+        DROP TABLE IF EXISTS toplist_temp;
 
 END $$
 DELIMITER ;
@@ -61,4 +61,23 @@ update subscription_log set action_tmp = -1 where action = 'unsubscribe';
 alter table subscription_log drop column action;
 alter table subscription_log change action_tmp action tinyint(1);
 
+DROP TRIGGER IF EXISTS episode_trig_unique;
+
+DELIMITER //
+CREATE TRIGGER episode_trig_unique BEFORE INSERT ON episode
+FOR EACH ROW
+BEGIN
+    declare help_url INT;
+    set help_url = 0;
+  
+       SELECT count(a.id) into help_url FROM episode a where a.url=new.url and a.podcast_id=new.podcast_id;
+
+    IF help_url > 0 THEN
+        call Fail('This episode already exists!');
+    END IF;
+
+END;//
+DELIMITER ;
+
+
 

commit 7f37d4ac3bf74ee419c9f5fa43aa7bcd2d885034
Merge: 6edd71b... 18c7f83...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Tue Dec 1 13:47:20 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit 67306a780b43cfddc59368a71da0c5a6d70e983e
Merge: 18c7f83... 6edd71b...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Tue Dec 1 10:52:22 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/martin/mygpo-src

commit 1f66fe90bc56b20577bc8031b32e4b069d5472c1
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Mon Nov 30 22:30:33 2009 +0000

    basic (untested) advanced api (bug 653)

diff --git a/install/update-04.sql b/install/update-04.sql
index e793225..31c992b 100644
--- a/install/update-04.sql
+++ b/install/update-04.sql
@@ -61,4 +61,7 @@ update subscription_log set action_tmp = -1 where action = 'unsubscribe';
 alter table subscription_log drop column action;
 alter table subscription_log change action_tmp action tinyint(1);
 
+CREATE UNIQUE INDEX unique_subscription_log ON subscription_log (device_id, podcast_id, timestamp);
+CREATE UNIQUE INDEX unique_episode_lg ON episode_log (user_id, episode_id, timestamp);
+
 
diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index 71e55fd..78aa1c5 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -16,13 +16,15 @@
 #
 
 from mygpo.api.basic_auth import require_valid_user
-from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
-from mygpo.api.models import Device
+from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404, HttpResponseNotAllowed
+from mygpo.api.models import Device, Podcast, SubscriptionAction, Episode, EpisodeAction, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION, EPISODE_ACTION_TYPES, DEVICE_TYPES
 from mygpo.api.json import JsonResponse
 from django.core import serializers
 from time import mktime
 from datetime import datetime
 import json
+import xml.utils.iso8601
+
 
 @require_valid_user()
 def subscriptions(request, username, device_uid):
@@ -30,28 +32,149 @@ def subscriptions(request, username, device_uid):
     if request.user.username != username:
         return HttpResponseForbidden()
 
-    timestamp = mktime(datetime.now().timetuple())
+    now = mktime(datetime.now().timetuple())
 
     if request.method == 'GET':
+        try:
+            d = Device.objects.get(user=request.user, uid=device_uid)
+        except Device.DoesNotExist:
+            return Http404('device %s does not exist' % device_uid)
+
+        try:
+            since = request.GET['since']
+        except KeyError:
+            return HttpResponseBadRequest('parameter since missing')
+
+        changes = get_subscription_changes(user, device, since, now)
 
+        return JsonResponse(changes)
 
     elif request.method == 'POST':
+        d = Device.objects.get_or_create(user=request.user, uid=device_uid)
+
         actions = json.loads(request.POST['data'])
+        add = actions['add'] if 'add' in actions else []
+        rem = actions['remove'] if 'remove' in actions else []
+
+        update_subscriptions(request.user, d, add, rem)
+
+        return JsonResponse({'timestamp': now})
+
+    else:
+        return HttpResponseNotAllowed(['GET', 'POST'])
+
+def update_subscriptions(user, device, add, remove):
+    for add in actions['add']:
+        p = Podcast.objects.get_or_create(url=add)
+        s = SubscriptionAction.objects.create(podcast=p,device=d,action=SUBSCRIBE_ACTION)
+
+    for remove in actions['remove']:
+        p = Podcast.objects.get_or_create(url=remove)
+        s = SubscriptionAction.objects.create(podcast=p,device=d,action=UNSUBSCRIBE_ACTION)
+
+def get_subscription_changes(user, device, since, until):
+    actions = {}
+    for a in SubscriptionAction.objects.filter(device=device, timestamp__gt=since).order_by('timestamp'):
+        #ordered by ascending date; newer entries overwriter older ones
+        actions[a.podcast] = a
 
-    else
-        return HttpResponseBadRequest()
+    add = []
+    remove = []
+
+    for a in actions:
+        if a.action == SUBSCRIBE_ACTION:
+            add.append(a.podcast.url)
+        elif a.action == UNSUBSCRIBE_ACTION:
+            remove.append(a.podcast.url)
+
+    return {'add': add, 'remove': remove, 'timestamp': until}
 
 @require_valid_user()
 def episodes(request, username):
-    pass
 
+    if request.user.username != username:
+        return HttpResponseForbidden()
+
+    now = mktime(datetime.now().timetuple())
+
+    if request.method == 'POST':
+        try:
+            actions = json.loads(request.POST['data'])
+        except KeyError:
+            return HttpResponseBadRequest()
+
+        update_episodes(request.user, actions)
+        return HttpResponse()
+
+    else:
+        return HttpResponseNotAllowed(['POST'])
+
+
+def update_episodes(user, actions):
+    for e in actions:
+        try:
+            podcast = Podcast.objects.get(url=e['podcast'])
+            episode = Episode.objects.get(podcast=podcast, url=e['episode'])
+            action  = e['action']
+            if not action in EPISODE_ACTION_TYPES:
+                return HttpResponseBadRequest('invalid action %s' % action)
+        except:
+            return HttpResponseBadRequest('not all required fields (podcast, episode, action) given')
+
+        device = Device.objects.get_or_create(user=user, uid=e['device'], defaults={'name': 'Unknown', 'type': 'other'}) if 'device' in e else None
+        timestamp = iso8601.parse(e['timestamp']) if 'timestamp' in e else None
+        position = datetime.strptime(e['position'], '%H:%M:%S').time() if 'position' in e else None
+
+        if position and action != 'play':
+            return HttpResponseBadRequest('parameter position can only be used with action play')
+
+        EpisodeAction.objects.create(user=user, episode=episode, device=device, action=action, timestamp=timestamp, playmark=position)
 
 @require_valid_user()
 def device(request, username, device_uid):
-    pass
+
+    if request.user.username != username:
+        return HttpResponseForbidden()
+
+    if request.method == 'POST':
+        d = Device.objects.get_or_create(user=request.user, uid=device_uid)
+
+        data = json.loads(request.POST['data'])
+
+        if 'caption' in data:
+            d.name = data['caption']
+
+        if 'type' in data:
+            if not data['type'] in DEVICE_TYPES:
+                return 
+            d.type = data['type']
+
+        d.save()
+
+        return HttpResponse()
+
+    else:
+        return HttpResponseNotAllowed(['POST'])
 
 
 @require_valid_user()
 def devices(request, username):
-    pass
+
+    if request.user.username != username:
+        return HttpResponseForbidden()
+
+    if request.method == 'GET':
+        devices = []
+        for d in Device.objects.filter(user=request.user):
+            devices.append({
+                'id': d.uid,
+                'caption': d.name,
+                'type': d.type,
+                'subscriptions': Subscription.objects.filter(device=d).count()
+            })
+
+        return JsonResponse(devices)
+
+    else:
+        return HttpResponseNotAllowed(['GET'])
 
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 4a30970..d085318 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -52,7 +52,7 @@ class UserProfile(models.Model):
         db_table = 'user'
 
 class Podcast(models.Model):
-    url = models.URLField()
+    url = models.URLField(unique=True)
     title = models.CharField(max_length=100)
     description = models.TextField()
     link = models.URLField()
@@ -76,7 +76,7 @@ class Podcast(models.Model):
 
 class Episode(models.Model):
     podcast = models.ForeignKey(Podcast)
-    url = models.URLField()
+    url = models.URLField(unique=True)
     title = models.CharField(max_length=100)
     description = models.TextField()
     link = models.URLField()
@@ -267,7 +267,7 @@ class Device(models.Model):
 class EpisodeAction(models.Model):
     user = models.ForeignKey(User, primary_key=True)
     episode = models.ForeignKey(Episode)
-    device = models.ForeignKey(Device)
+    device = models.ForeignKey(Device,)
     action = models.IntegerField(choices=EPISODE_ACTION_TYPES)
     timestamp = models.DateTimeField(default=datetime.now)
     playmark = models.IntegerField()
@@ -277,6 +277,7 @@ class EpisodeAction(models.Model):
 
     class Meta:
         db_table = 'episode_log'
+        unique_together = ('user', 'episode', 'timestamp')
 
 
 class Subscription(models.Model):
@@ -309,5 +310,5 @@ class SubscriptionAction(models.Model):
 
     class Meta:
         db_table = 'subscription_log'
-        unique_together = ('device', 'podcast', 'action', 'timestamp')
+        unique_together = ('device', 'podcast', 'timestamp')
 
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 8bf040c..5d563f0 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -50,7 +50,7 @@ urlpatterns = patterns('',
     (r'^api/1/subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.subscriptions'),
     (r'^api/1/episodes/(?P<username>\w+).json', 'mygpo.api.advanced.episodes'),
     (r'^api/1/devices/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.device'),
-    (r'^api/1/devices/(?P<username>\w+)/devices.json', 'mygpo.apo.advaced.devices'),
+    (r'^api/1/devices/(?P<username>\w+)/devices.json', 'mygpo.api.advanced.devices'),
 
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs'
     # to INSTALLED_APPS to enable admin documentation:

commit 5177d374e633036511ce92879dbb32e1fc1032c5
Merge: a353fc6... 18c7f83...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Nov 30 22:10:56 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit 18c7f83ecad037b9fa8cfa034db05cd568dc2c05
Merge: a608dac... 9f05f8c...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Nov 30 21:28:25 2009 +0100

    Merge branch 'master' of /home/alex/mygpo-src
    
    Conflicts:
    
    	mygpo/urls.py

commit 6edd71ba3598a27464db1007ac92f2926c2157a4
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Nov 30 18:43:07 2009 +0100

    internationalisation

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index c0d495a..e5e6549 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2009-11-29 13:26+0100\n"
+"POT-Creation-Date: 2009-11-30 18:29+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -33,10 +33,9 @@ msgstr ""
 "Abonnements auf verschiedenen Gerten und Anwendungen."
 
 #: web/templates/home.html:8
-msgid "We are currently tracking one Podcast!"
-msgid_plural "We are currently tracking %(podcast_count)s Podcasts!"
-msgstr[0] "Es wird zur Zeit ein Podcast verfolgt!"
-msgstr[1] "Es werden zur Zeit %(podcast_count)s Podcast verfolgt!"
+#, python-format
+msgid "We are currently tracking %(podcast_count)s Podcasts!"
+msgstr "Es werden zur Zeit %(podcast_count)s Podcasts verfolgt!"
 
 #: web/templates/home.html:20
 msgid "Not yet a member?"
@@ -46,3 +45,19 @@ msgstr "Noch kein Mitglied?"
 msgid "Register!"
 msgstr "Registrieren!"
 
+#: web/templates/migrate.html:5
+msgid ""
+"The new my.gpodder.org uses usernames instead of email addresses. Based on "
+"your email address, we think you might like "
+msgstr "Das neue my.gpodder.org Benutzername anstatt Emailadressen, der basierend auf deiner Emailadresse erzeugt wird. Wir denken, du wirst ihn mgen "
+
+#: web/templates/migrate.html:5
+msgid ", but you can change that if you want to."
+msgstr ", falls nicht kannst du ihn einfach ndern."
+
+#: web/templates/migrate.html:11
+msgid ""
+"You can keep your old user settings in gPodder. Once the next version (with "
+"lots of new features) is release, you'll have to replace your email address "
+"with your username."
+msgstr "Du kannst deine alten Einstellung von gPodder bernehmen. Sobald die nchste Version (mit vielen neuen Funktionen) verffentlicht wurde, musst du fr den Zugang deinen neuen Benutzernamen bentzen."
diff --git a/mygpo/web/templates/migrate.html b/mygpo/web/templates/migrate.html
index 3cc2e3c..cf13b62 100644
--- a/mygpo/web/templates/migrate.html
+++ b/mygpo/web/templates/migrate.html
@@ -2,11 +2,12 @@
 
 {% block content %}
   <h1>my.gpodder.org</h1>
-  <p>The new my.gpodder.org uses usernames instead of email addresses. Based on your email address, we think you might like <strong>{{username}}</strong>, but you can change that if you want to.</p>
+  <p>{% trans "The new my.gpodder.org uses usernames instead of email addresses. Based on your email address, we think you might like " %}<strong>{{username}}</strong>{% trans ", but you can change that if you want to." %}</p>
+
   <form action="/migrate/" method="post">
   Username: <input type="text" name="username" value="{{ username }}"/><br /><br />
   <input type="submit" name="submit" value="Submit" />
   </form>
-  <p>You can keep your old user settings in gPodder. Once the next version (with lots of new features) is release, you'll have to replace your email address with your username.</p>
+  <p>{% trans "You can keep your old user settings in gPodder. Once the next version (with lots of new features) is release, you'll have to replace your email address with your username." %}</p>
 {% endblock %}
 

commit 1ddb37793c1f27e19a495c3d624a2b5476074b78
Merge: 77e083f... a608dac...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Nov 30 18:17:52 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit 77e083fa6f74b7ff295a903e2112c3abdde357cf
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Mon Nov 30 18:17:38 2009 +0100

    merge

diff --git a/mygpo/urls.py b/mygpo/urls.py
index b75383e..6c439c6 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -56,3 +56,4 @@ urlpatterns = patterns('',
     (r'^media/(?P<path>.*)$', 'django.views.static.serve', {'document_root': os.path.abspath('%s/../htdocs/media/' % os.path.dirname(__file__))}),
 
 )
+

commit a353fc60b173cfee57d9ce72d56d0667f0c51709
Merge: 4bc1e68... a608dac...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Nov 30 14:17:11 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit a608dac6c13266e3c201770d77f9f6194b52d88c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Nov 30 13:23:02 2009 +0100

    remove unnecessary singular form in home.html

diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 1c1add3..e51ac44 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -5,7 +5,7 @@
   <h1>my.gpodder.org</h1>
   <p>{% trans "my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications." %}</p>
 <p>
-{% blocktrans count list|length as podcast_count %}We are currently tracking one Podcast!{% plural %}We are currently tracking {{ podcast_count }} Podcasts!{% endblocktrans %}
+{% blocktrans %}We are currently tracking {{ podcast_count }} Podcasts!{% endblocktrans %}
 </p>
    <h2>Login</h2>
    <form action="../login/" method="post">

commit 4bc1e68f0c108dcb6a64758690f48bc2af98da25
Merge: 326a56c... 0977948...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Nov 30 11:39:37 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit 0977948d5523910da66cd320a4c832c4d790293d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Nov 30 00:08:37 2009 +0100

    extended advanced api stubs

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
index baf7cf4..71e55fd 100644
--- a/mygpo/api/advanced.py
+++ b/mygpo/api/advanced.py
@@ -20,13 +20,26 @@ from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbid
 from mygpo.api.models import Device
 from mygpo.api.json import JsonResponse
 from django.core import serializers
+from time import mktime
+from datetime import datetime
+import json
 
 @require_valid_user()
 def subscriptions(request, username, device_uid):
-    
+
     if request.user.username != username:
         return HttpResponseForbidden()
 
+    timestamp = mktime(datetime.now().timetuple())
+
+    if request.method == 'GET':
+
+
+    elif request.method == 'POST':
+        actions = json.loads(request.POST['data'])
+
+    else
+        return HttpResponseBadRequest()
 
 @require_valid_user()
 def episodes(request, username):

commit e97a98f1f547d7702c19c055b3f5a8091bff7c18
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 29 17:09:55 2009 +0100

    add missing handler in urls.py

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 2e067a0..8bf040c 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -50,7 +50,7 @@ urlpatterns = patterns('',
     (r'^api/1/subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.subscriptions'),
     (r'^api/1/episodes/(?P<username>\w+).json', 'mygpo.api.advanced.episodes'),
     (r'^api/1/devices/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.device'),
-    (r'^api/1/devices/(?P<username>\w+)/devices.json'),
+    (r'^api/1/devices/(?P<username>\w+)/devices.json', 'mygpo.apo.advaced.devices'),
 
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs'
     # to INSTALLED_APPS to enable admin documentation:

commit 9f05f8c4afe3701b8f2753c8473d15e8466b63b6
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sun Nov 29 16:33:44 2009 +0100

    simple api parse error beseitigt
    	modified:   api/simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index a6e6911..e1f245a 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -78,7 +78,8 @@ def parse_subscription(raw_post_data, format, username, device_uid):
     else: raise ValueError('unsupported format %s' % format)
 
     d, created = Device.objects.get_or_create(user__username=username, uid=device_uid, defaults = {'type': 'other', 'name': 'unknown'})
-    old = [p.url for p in d.get_subscriptions()]
+    podcasts = [p.podcast for p in d.get_subscriptions()]
+    old = [p.url for p in podcasts]
     new = [p for p in urls if p not in old]
     rem = [p for p in old if p not in urls]
     return new, rem, username, d
@@ -87,6 +88,7 @@ def parse_subscription(raw_post_data, format, username, device_uid):
 def set_subscriptions(subscriptions):
     new, rem, username, d = subscriptions
     
+    print new
     for r in rem:
 	    s = SubscriptionAction(podcast=r, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
 	    s.save()

commit b40b8310c3390ed7ebef47b39da22e6b7cb85b7f
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 29 16:22:03 2009 +0100

    add urls and stubs for the Advanced API (bug 653)

diff --git a/mygpo/api/advanced.py b/mygpo/api/advanced.py
new file mode 100644
index 0000000..baf7cf4
--- /dev/null
+++ b/mygpo/api/advanced.py
@@ -0,0 +1,44 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+from mygpo.api.basic_auth import require_valid_user
+from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
+from mygpo.api.models import Device
+from mygpo.api.json import JsonResponse
+from django.core import serializers
+
+@require_valid_user()
+def subscriptions(request, username, device_uid):
+    
+    if request.user.username != username:
+        return HttpResponseForbidden()
+
+
+@require_valid_user()
+def episodes(request, username):
+    pass
+
+
+@require_valid_user()
+def device(request, username, device_uid):
+    pass
+
+
+@require_valid_user()
+def devices(request, username):
+    pass
+
diff --git a/mygpo/urls.py b/mygpo/urls.py
index b75383e..2e067a0 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -39,11 +39,19 @@ urlpatterns = patterns('',
     (r'^activate/(?P<activation_key>\w+)$', activate),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
+    #Legacy API
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
 
+    #Simple API
     (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>(txt|opml|json))', 'mygpo.api.simple.subscriptions'),
 
+    #Advanced API
+    (r'^api/1/subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.subscriptions'),
+    (r'^api/1/episodes/(?P<username>\w+).json', 'mygpo.api.advanced.episodes'),
+    (r'^api/1/devices/(?P<username>\w+)/(?P<device_uid>\w+).json', 'mygpo.api.advanced.device'),
+    (r'^api/1/devices/(?P<username>\w+)/devices.json'),
+
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs'
     # to INSTALLED_APPS to enable admin documentation:
     # (r'^admin/doc/', include('django.contrib.admindocs.urls')),

commit 917a96fda05538f6286321f3eb21f9231e0c8930
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sun Nov 29 14:50:54 2009 +0100

    simple api json parsing geaendert
    	modified:   simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 8711e68..a6e6911 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -22,6 +22,7 @@ from mygpo.api.opml import Exporter, Importer
 from mygpo.api.json import JsonResponse
 from django.core import serializers
 from datetime import datetime
+import re
 
 @require_valid_user()
 def subscriptions(request, username, device_uid, format):
@@ -70,9 +71,9 @@ def parse_subscription(raw_post_data, format, username, device_uid):
         urls = [p['url'] for p in i.items]
 
     elif format == 'json':
-        #deserialize json
-        sub = raw_post_data[3:-1].split(',')
-        urls = [x[1:-1] for x in sub]
+        sub = raw_post_data.split('"')
+        pattern = '^[a-zA-z]+'
+        urls = [x for x in sub if re.search(pattern, x) != None]
 
     else: raise ValueError('unsupported format %s' % format)
 

commit de5f436a9435167fc2d66933e1db85983fa183c5
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 29 14:31:14 2009 +0100

    removing unnecessary binary file

diff --git a/mygpo/locale/de/LC_MESSAGES/django.mo b/mygpo/locale/de/LC_MESSAGES/django.mo
deleted file mode 100644
index c396662..0000000
Binary files a/mygpo/locale/de/LC_MESSAGES/django.mo and /dev/null differ

commit 53fd7329f1b4f28aa6f4a93fa9ad613fdd995713
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 29 14:25:21 2009 +0100

    removing backup file

diff --git a/mygpo/locale/de/LC_MESSAGES/django.po~ b/mygpo/locale/de/LC_MESSAGES/django.po~
deleted file mode 100644
index e559e31..0000000
--- a/mygpo/locale/de/LC_MESSAGES/django.po~
+++ /dev/null
@@ -1,59 +0,0 @@
-# SOME DESCRIPTIVE TITLE.
-# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
-# This file is distributed under the same license as the PACKAGE package.
-# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
-#
-#, fuzzy
-msgid ""
-msgstr ""
-"Project-Id-Version: PACKAGE VERSION\n"
-"Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2009-11-29 10:35+0100\n"
-"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
-"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
-"Language-Team: LANGUAGE <LL@li.org>\n"
-"MIME-Version: 1.0\n"
-"Content-Type: text/plain; charset=UTF-8\n"
-"Content-Transfer-Encoding: 8bit\n"
-
-#: web/templates/home-user.html:5
-msgid "Your Subscriptions"
-msgstr "Deine Abonnements"
-
-#: web/templates/home-user.html:6
-msgid "This page is currently in development."
-msgstr "Diese Seite befindet sich im Aufbau."
-
-#: web/templates/home.html:6
-msgid ""
-"my.gpodder.org is a webservice for synchronizing podcast subscriptions on "
-"several devices and applications."
-msgstr ""
-"my.gpodder.org ist ein Webservice fr das Synchronisieren von Podcast-"
-"Abonnements auf verschiedenen Gerten und Anwendungen."
-
-#: web/templates/home.html:8
-#, fuzzy, python-format
-msgid ""
-"\n"
-"  We are currently tracking one Podcast!\n"
-msgid_plural ""
-"\n"
-"  We are currently tracking %(podcast_count)s Podcasts!\n"
-msgstr[0] ""
-" \n"
-" Es wird zur Zeit ein Podcast verfolgt!\n"
-msgstr[1] ""
-" \n"
-" Es werden zur Zeit %(podcast_count)s Podcasts verfolgt!\n"
-
-#: web/templates/home.html:24
-msgid "Not yet a member?"
-msgstr "Noch kein Mitglied?"
-
-#: web/templates/home.html:24
-msgid "<a href="
-msgstr ""
-
-#~ msgid "Register!"
-#~ msgstr "Registrieren!"

commit c956485614f62aa887b055aa2b432062d90e60d3
Merge: e4a2635... 692a823...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 29 14:24:36 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit 86eeca1f418d59ec372b246cc86959bb32339484
Merge: 733ade8... 692a823...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sun Nov 29 13:49:23 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/martin/mygpo-src

commit 733ade8698277ba16a12f54367af7cdd4d52d3ce
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sun Nov 29 13:48:18 2009 +0100

    simple api (create device geht nicht)
    	modified:   api/simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 056c59e..8711e68 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -17,10 +17,11 @@
 
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
-from mygpo.api.models import Device, SubscriptionAction
+from mygpo.api.models import Device, SubscriptionAction, Podcast, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from mygpo.api.opml import Exporter, Importer
 from mygpo.api.json import JsonResponse
 from django.core import serializers
+from datetime import datetime
 
 @require_valid_user()
 def subscriptions(request, username, device_uid, format):
@@ -32,8 +33,7 @@ def subscriptions(request, username, device_uid, format):
         return format_subscriptions(get_subscriptions(username, device_uid), format, username)
         
     elif request.method == 'PUT':
-	    return HttpResponse(request.raw_post_data.split('\''), mimetype='text/xml')
-        #return set_subscriptions(device_uid, parse_subscription(request.raw_post_data, format))
+        return set_subscriptions(parse_subscription(request.raw_post_data, format, username, device_uid))
     else:
         return HttpResponseBadReqest()
 
@@ -62,7 +62,8 @@ def get_subscriptions(username, device_uid):
 
 def parse_subscription(raw_post_data, format, username, device_uid):
     if format == 'txt':
-	urls = raw_post_data.split('\n')
+	    urls = raw_post_data.split('\n')
+	    urls = [x for x in urls if x != '\r']
 
     elif format == 'opml':
         i = Importer(content=raw_post_data)
@@ -70,31 +71,30 @@ def parse_subscription(raw_post_data, format, username, device_uid):
 
     elif format == 'json':
         #deserialize json
-        urls = []
+        sub = raw_post_data[3:-1].split(',')
+        urls = [x[1:-1] for x in sub]
 
     else: raise ValueError('unsupported format %s' % format)
 
-    old = [p.url for p in get_subscriptions(username, device_uid)]
-    new = [p for p in urls if urls not in old]
-    rem = [p for p in old if old not in urls]
-    return new, rem, username, device_uid
+    d, created = Device.objects.get_or_create(user__username=username, uid=device_uid, defaults = {'type': 'other', 'name': 'unknown'})
+    old = [p.url for p in d.get_subscriptions()]
+    new = [p for p in urls if p not in old]
+    rem = [p for p in old if p not in urls]
+    return new, rem, username, d
 
 
 def set_subscriptions(subscriptions):
-    new = subscriptions[0]
-    rem = subscriptions[1]
-
-    d, created = Device.objects.get_or_create(uid=subscriptions[2], user__username=subscriptions[3])
-
+    new, rem, username, d = subscriptions
+    
     for r in rem:
-	    s=SubscriptionAction(podcast=r, action='unsubscribe', timestamp=datetime.now(), device=d)
+	    s = SubscriptionAction(podcast=r, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
 	    s.save()
 	
     for n in new:
-        p, created = Podcast.objects.get_or_create(url=n['url'], defaults={'title' : n['title'], 'description': n['description'], 'last_update': datetime.now() })
+        p, created = Podcast.objects.get_or_create(url=n,defaults={'title':n,'description':n,'last_update':datetime.now()})
         
-        s=SubscriptionAction(podcast=p, action='subscribe', timestamp=datetime.now(), device=d)
+        s = SubscriptionAction(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
         s.save()
-
+        
     return HttpResponse('Success', mimetype='text/plain')
 

commit 692a8234e95428eb035029d3b8ca67676c4b42ad
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sun Nov 29 13:34:13 2009 +0100

    An Error with fuzzy

diff --git a/mygpo/locale/de/LC_MESSAGES/django.mo b/mygpo/locale/de/LC_MESSAGES/django.mo
index 7dab58c..c396662 100644
Binary files a/mygpo/locale/de/LC_MESSAGES/django.mo and b/mygpo/locale/de/LC_MESSAGES/django.mo differ
diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
index 5fca52c..c0d495a 100644
--- a/mygpo/locale/de/LC_MESSAGES/django.po
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -8,7 +8,7 @@ msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
 "Report-Msgid-Bugs-To: \n"
-"POT-Creation-Date: 2009-11-29 10:39+0100\n"
+"POT-Creation-Date: 2009-11-29 13:26+0100\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
@@ -33,20 +33,16 @@ msgstr ""
 "Abonnements auf verschiedenen Gerten und Anwendungen."
 
 #: web/templates/home.html:8
-#, fuzzy, python-format
-msgid ""
-"\n"
-"  We are currently tracking one Podcast!\n"
-msgid_plural ""
-"\n"
-"  We are currently tracking %(podcast_count)s Podcasts!\n"
-msgstr[0] ""
-" \n"
-" Es wird zur Zeit ein Podcast verfolgt!\n"
-msgstr[1] ""
-" \n"
-" Es werden zur Zeit %(podcast_count)s Podcasts verfolgt!\n"
+msgid "We are currently tracking one Podcast!"
+msgid_plural "We are currently tracking %(podcast_count)s Podcasts!"
+msgstr[0] "Es wird zur Zeit ein Podcast verfolgt!"
+msgstr[1] "Es werden zur Zeit %(podcast_count)s Podcast verfolgt!"
 
-#: web/templates/home.html:24
+#: web/templates/home.html:20
 msgid "Not yet a member?"
 msgstr "Noch kein Mitglied?"
+
+#: web/templates/home.html:20
+msgid "Register!"
+msgstr "Registrieren!"
+
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index f07064d..1c1add3 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -4,12 +4,8 @@
 {% block content %}
   <h1>my.gpodder.org</h1>
   <p>{% trans "my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications." %}</p>
-  <p>
-{% blocktrans count list|length as podcast_count%}
-  We are currently tracking one Podcast!
-{% plural %}
-  We are currently tracking {{ podcast_count }} Podcasts!
-{% endblocktrans %}
+<p>
+{% blocktrans count list|length as podcast_count %}We are currently tracking one Podcast!{% plural %}We are currently tracking {{ podcast_count }} Podcasts!{% endblocktrans %}
 </p>
    <h2>Login</h2>
    <form action="../login/" method="post">
@@ -21,7 +17,7 @@
    </form>
 
   <div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px;">
-   {% trans "Not yet a member?" %} <a href="/register/">Register!</a>
+   {% trans "Not yet a member?" %} <a href="/register/">{% trans "Register!" %}</a>
   </div>
 {% endblock %}
 

commit e8ddb169ab9e7a1f97757d982b2bd4363146c564
Merge: f16ec4e... 505ff09...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sun Nov 29 12:37:47 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/martin/mygpo-src

commit f16ec4edd6b606c35dda6ff225ec3044c10b8e61
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sun Nov 29 12:37:00 2009 +0100

    simple api
    	modified:   mygpo/api/simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 738d814..056c59e 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -17,14 +17,7 @@
 
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
-<<<<<<< HEAD:mygpo/api/simple.py
-<<<<<<< HEAD:mygpo/api/simple.py
 from mygpo.api.models import Device, SubscriptionAction
-=======
-=======
->>>>>>> e4a263586e9b47bdb14c14a7b3d299e58b7d699c:mygpo/api/simple.py
-from mygpo.api.models import Device
->>>>>>> 0d1d0b4ff5e300df602b0e88e8798fd9fc52fe62:mygpo/api/simple.py
 from mygpo.api.opml import Exporter, Importer
 from mygpo.api.json import JsonResponse
 from django.core import serializers
@@ -69,7 +62,7 @@ def get_subscriptions(username, device_uid):
 
 def parse_subscription(raw_post_data, format, username, device_uid):
     if format == 'txt':
-	    urls = raw_post_data.split('\n')
+	urls = raw_post_data.split('\n')
 
     elif format == 'opml':
         i = Importer(content=raw_post_data)

commit 8cfd4e828c10a9bae38177aa2932becd3eb9ae54
Merge: 36c2d7b... e4a2635...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sun Nov 29 12:36:08 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src
    
    Conflicts:
    	mygpo/api/simple.py

commit 505ff09204b0afb01c433cf0639bee17057f725a
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Sun Nov 29 10:44:00 2009 +0100

    internationalisation

diff --git a/mygpo/locale/de/LC_MESSAGES/django.mo b/mygpo/locale/de/LC_MESSAGES/django.mo
new file mode 100644
index 0000000..7dab58c
Binary files /dev/null and b/mygpo/locale/de/LC_MESSAGES/django.mo differ
diff --git a/mygpo/locale/de/LC_MESSAGES/django.po b/mygpo/locale/de/LC_MESSAGES/django.po
new file mode 100644
index 0000000..5fca52c
--- /dev/null
+++ b/mygpo/locale/de/LC_MESSAGES/django.po
@@ -0,0 +1,52 @@
+# SOME DESCRIPTIVE TITLE.
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: PACKAGE VERSION\n"
+"Report-Msgid-Bugs-To: \n"
+"POT-Creation-Date: 2009-11-29 10:39+0100\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
+"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
+"Language-Team: LANGUAGE <LL@li.org>\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#: web/templates/home-user.html:5
+msgid "Your Subscriptions"
+msgstr "Deine Abonnements"
+
+#: web/templates/home-user.html:6
+msgid "This page is currently in development."
+msgstr "Diese Seite befindet sich im Aufbau."
+
+#: web/templates/home.html:6
+msgid ""
+"my.gpodder.org is a webservice for synchronizing podcast subscriptions on "
+"several devices and applications."
+msgstr ""
+"my.gpodder.org ist ein Webservice fr das Synchronisieren von Podcast-"
+"Abonnements auf verschiedenen Gerten und Anwendungen."
+
+#: web/templates/home.html:8
+#, fuzzy, python-format
+msgid ""
+"\n"
+"  We are currently tracking one Podcast!\n"
+msgid_plural ""
+"\n"
+"  We are currently tracking %(podcast_count)s Podcasts!\n"
+msgstr[0] ""
+" \n"
+" Es wird zur Zeit ein Podcast verfolgt!\n"
+msgstr[1] ""
+" \n"
+" Es werden zur Zeit %(podcast_count)s Podcasts verfolgt!\n"
+
+#: web/templates/home.html:24
+msgid "Not yet a member?"
+msgstr "Noch kein Mitglied?"
diff --git a/mygpo/locale/de/LC_MESSAGES/django.po~ b/mygpo/locale/de/LC_MESSAGES/django.po~
new file mode 100644
index 0000000..e559e31
--- /dev/null
+++ b/mygpo/locale/de/LC_MESSAGES/django.po~
@@ -0,0 +1,59 @@
+# SOME DESCRIPTIVE TITLE.
+# Copyright (C) YEAR THE PACKAGE'S COPYRIGHT HOLDER
+# This file is distributed under the same license as the PACKAGE package.
+# FIRST AUTHOR <EMAIL@ADDRESS>, YEAR.
+#
+#, fuzzy
+msgid ""
+msgstr ""
+"Project-Id-Version: PACKAGE VERSION\n"
+"Report-Msgid-Bugs-To: \n"
+"POT-Creation-Date: 2009-11-29 10:35+0100\n"
+"PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
+"Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
+"Language-Team: LANGUAGE <LL@li.org>\n"
+"MIME-Version: 1.0\n"
+"Content-Type: text/plain; charset=UTF-8\n"
+"Content-Transfer-Encoding: 8bit\n"
+
+#: web/templates/home-user.html:5
+msgid "Your Subscriptions"
+msgstr "Deine Abonnements"
+
+#: web/templates/home-user.html:6
+msgid "This page is currently in development."
+msgstr "Diese Seite befindet sich im Aufbau."
+
+#: web/templates/home.html:6
+msgid ""
+"my.gpodder.org is a webservice for synchronizing podcast subscriptions on "
+"several devices and applications."
+msgstr ""
+"my.gpodder.org ist ein Webservice fr das Synchronisieren von Podcast-"
+"Abonnements auf verschiedenen Gerten und Anwendungen."
+
+#: web/templates/home.html:8
+#, fuzzy, python-format
+msgid ""
+"\n"
+"  We are currently tracking one Podcast!\n"
+msgid_plural ""
+"\n"
+"  We are currently tracking %(podcast_count)s Podcasts!\n"
+msgstr[0] ""
+" \n"
+" Es wird zur Zeit ein Podcast verfolgt!\n"
+msgstr[1] ""
+" \n"
+" Es werden zur Zeit %(podcast_count)s Podcasts verfolgt!\n"
+
+#: web/templates/home.html:24
+msgid "Not yet a member?"
+msgstr "Noch kein Mitglied?"
+
+#: web/templates/home.html:24
+msgid "<a href="
+msgstr ""
+
+#~ msgid "Register!"
+#~ msgstr "Registrieren!"
diff --git a/mygpo/settings.py b/mygpo/settings.py
index b057e2a..ffe62be 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -83,6 +83,7 @@ MIDDLEWARE_CLASSES = (
     'django.middleware.common.CommonMiddleware',
     'django.contrib.sessions.middleware.SessionMiddleware',
     'django.contrib.auth.middleware.AuthenticationMiddleware',
+    'django.middleware.locale.LocaleMiddleware',
 )
 
 ROOT_URLCONF = 'mygpo.urls'
diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
index 24c829b..efd807b 100644
--- a/mygpo/web/templates/home-user.html
+++ b/mygpo/web/templates/home-user.html
@@ -1,7 +1,8 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
-  <h1>Your Subscriptions</h1>
-  <p>This page is currently in development.</p>
+  <h1>{% trans "Your Subscriptions" %}</h1>
+  <p>{% trans "This page is currently in development." %}</p>
 {% endblock %}
 
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 244415f..f07064d 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -2,16 +2,15 @@
 {% load i18n %}
 
 {% block content %}
-{% blocktrans %}
   <h1>my.gpodder.org</h1>
-  <p>my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications.</p>
-{% endblocktrans %}
+  <p>{% trans "my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications." %}</p>
+  <p>
 {% blocktrans count list|length as podcast_count%}
-  <p>We are currently tracking one Podcast!</p>
+  We are currently tracking one Podcast!
 {% plural %}
-  <p>We are currently tracking {{ podcast_count }} Podcasts!</p>
+  We are currently tracking {{ podcast_count }} Podcasts!
 {% endblocktrans %}
-{% blocktrans %}
+</p>
    <h2>Login</h2>
    <form action="../login/" method="post">
     Username or Email-Address:<br />
@@ -22,8 +21,7 @@
    </form>
 
   <div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px;">
-   Not yet a member? <a href="/register/">Register!</a>
+   {% trans "Not yet a member?" %} <a href="/register/">Register!</a>
   </div>
-{% endblocktrans %}
 {% endblock %}
 

commit 36c2d7b01346cda1e9d94971aafe1d32a8a1d4e3
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sat Nov 28 18:07:03 2009 +0100

    	modified:   api/simple.py
    	modified:   api/simple.py

diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 633152a..7df2be7 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -53,11 +53,19 @@ class PodcastAdmin(admin.ModelAdmin):
 class DeviceAdmin(admin.ModelAdmin):
     inlines = [SubscriptionActionInline]
 
+class SubscriptionAdmin(admin.ModelAdmin):
+    #empty ModelAdmin to work around bug 685
+    pass
+
+class SubscriptionActionAdmin(admin.ModelAdmin):
+    #empty ModelAdmin to work around bug 685
+    pass
+
 admin.site.unregister(User)
 admin.site.register(User, UserProfileAdmin)
 admin.site.register(Podcast, PodcastAdmin)
 admin.site.register(SyncGroup, SyncGroupAdmin)
 admin.site.register(Device, DeviceAdmin)
-admin.site.register(Subscription)
-admin.site.register(SubscriptionAction)
+admin.site.register(Subscription, SubscriptionAdmin)
+admin.site.register(SubscriptionAction, SubscriptionActionAdmin)
 
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 314a842..4a30970 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -88,6 +88,16 @@ class Episode(models.Model):
         db_table = 'episode'
 
 class SyncGroup(models.Model):
+    """
+    Devices that should be synced with each other need to be grouped
+    in a SyncGroup.
+
+    SyncGroups are automatically created by calling
+    device.sync_with(other_device), but can also be created manually.
+
+    device.sync() synchronizes the device for which the method is called
+    with the other devices in its SyncGroup.
+    """
     user = models.ForeignKey(User)
 
     def __unicode__(self):
@@ -97,6 +107,14 @@ class SyncGroup(models.Model):
     def devices(self):
         return Device.objects.filter(sync_group=self)
 
+    def add(self, device):
+        if device.sync_group == self: return
+        if device.sync_group != None:
+            device.unsync()
+
+        device.sync_group = self
+        device.save()
+
     class Meta:
         db_table = 'sync_group'
 
@@ -119,6 +137,19 @@ class Device(models.Model):
         for s in self.get_sync_actions():
             SubscriptionAction.objects.create(device=self, podcast=s.podcast, timestamp=s.timestamp, action=s.action)
 
+    def sync_targets(self):
+        """
+        returns all Devices and SyncGroups that can be used as a parameter for self.sync_with()
+        """
+        sync_targets = list(Device.objects.filter(user=self.user, sync_group=None).exclude(pk=self.id))
+
+        sync_groups = SyncGroup.objects.filter(user=self.user)
+        if self.sync_group != None: sync_groups = sync_groups.exclude(pk=self.sync_group.id)
+
+        sync_targets.extend( list(sync_groups) )
+        return sync_targets
+
+
     def get_sync_actions(self):
         """
         returns the SyncGroupSubscriptionActions correspond to the
@@ -176,21 +207,25 @@ class Device(models.Model):
 
     def sync_with(self, other):
         """
-        set the device to be synchronized with the other device.
-        this method places them in the same SyncGroup. get_sync_actions() can 
-        then return the SyncGroupSubscriptionActions for brining the device 
+        set the device to be synchronized with other, which can either be a Device or a SyncGroup.
+        this method places them in the same SyncGroup. get_sync_actions() can
+        then return the SyncGroupSubscriptionActions for brining the device
         in sync with its group
         """
         if self.user != other.user:
             raise ValueError('the devices belong to different users')
 
+        if isinstance(other, SyncGroup):
+            other.add(self)
+            self.save()
+            return
+
         if self.sync_group == other.sync_group and self.sync_group != None:
             return
 
         if self.sync_group != None:
             if other.sync_group == None:
-                other.sync_group = self.sync_group
-                other.save
+                self.sync_group.add(other)
 
             else:
                 raise ValueError('the devices are in different sync groups')
@@ -198,14 +233,11 @@ class Device(models.Model):
         else:
             if other.sync_group == None:
                 g = SyncGroup.objects.create(user=self.user)
-                self.sync_group=g
-                self.save()
-                other.sync_group=g
-                other.save()
+                g.add(self)
+                g.add(other)
 
             else:
-                self.syn_group = other.sync_group
-                self.save()
+                oter.sync_group.add(self)
 
     def unsync(self):
         """
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index b6aae01..745251f 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -17,9 +17,14 @@
 
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
+<<<<<<< HEAD:mygpo/api/simple.py
 from mygpo.api.models import Device, SubscriptionAction
+=======
+from mygpo.api.models import Device
+>>>>>>> 0d1d0b4ff5e300df602b0e88e8798fd9fc52fe62:mygpo/api/simple.py
 from mygpo.api.opml import Exporter, Importer
 from mygpo.api.json import JsonResponse
+from django.core import serializers
 
 @require_valid_user()
 def subscriptions(request, username, device_uid, format):
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 460d33d..244415f 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -1,10 +1,17 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
+{% blocktrans %}
   <h1>my.gpodder.org</h1>
   <p>my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications.</p>
+{% endblocktrans %}
+{% blocktrans count list|length as podcast_count%}
+  <p>We are currently tracking one Podcast!</p>
+{% plural %}
   <p>We are currently tracking {{ podcast_count }} Podcasts!</p>
-
+{% endblocktrans %}
+{% blocktrans %}
    <h2>Login</h2>
    <form action="../login/" method="post">
     Username or Email-Address:<br />
@@ -17,6 +24,6 @@
   <div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px;">
    Not yet a member? <a href="/register/">Register!</a>
   </div>
-
+{% endblocktrans %}
 {% endblock %}
 

commit e4a263586e9b47bdb14c14a7b3d299e58b7d699c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 28 17:37:47 2009 +0100

    subscription_log.action from varchar to tinyint

diff --git a/install/update-04.sql b/install/update-04.sql
index df1fe3e..e793225 100644
--- a/install/update-04.sql
+++ b/install/update-04.sql
@@ -54,3 +54,11 @@ BEGIN
 END $$
 DELIMITER ;
 
+-- converting the column subscription_log.action from varchar to tinyint(1)
+alter table subscription_log add column action_tmp tinyint(1);
+update subscription_log set action_tmp = 1 where action = 'subscribe';
+update subscription_log set action_tmp = -1 where action = 'unsubscribe';
+alter table subscription_log drop column action;
+alter table subscription_log change action_tmp action tinyint(1);
+
+

commit e27452c992234e290c484034cbca9d6d4ba61e47
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sat Nov 28 16:29:50 2009 +0100

    	modified:   api/simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 27c7c2f..b6aae01 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -16,15 +16,9 @@
 #
 
 from mygpo.api.basic_auth import require_valid_user
-<<<<<<< HEAD:mygpo/api/simple.py
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
 from mygpo.api.models import Device, SubscriptionAction
-from mygpo.api.opml import Exporter
-=======
-from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
-from mygpo.api.models import Device
 from mygpo.api.opml import Exporter, Importer
->>>>>>> a85ea6372af96277f06888391f9f9d74d3911a51:mygpo/api/simple.py
 from mygpo.api.json import JsonResponse
 
 @require_valid_user()
@@ -34,21 +28,16 @@ def subscriptions(request, username, device_uid, format):
         return HttpResponseForbidden()
 
     if request.method == 'GET':
-        return format_subscriptions(get_subscriptions(username, device_uid), format)
+        return format_subscriptions(get_subscriptions(username, device_uid), format, username)
         
     elif request.method == 'PUT':
-<<<<<<< HEAD:mygpo/api/simple.py
-        return set_subscriptions(parse_subscription(request.raw_post_data, format, username, device_uid))
-=======
-	return request.raw_post_data
+	    return HttpResponse(request.raw_post_data.split('\''), mimetype='text/xml')
         #return set_subscriptions(device_uid, parse_subscription(request.raw_post_data, format))
->>>>>>> a85ea6372af96277f06888391f9f9d74d3911a51:mygpo/api/simple.py
-
     else:
         return HttpResponseBadReqest()
 
 
-def format_subscriptions(subscriptions, format):
+def format_subscriptions(subscriptions, format, username):
     if format == 'txt':
         #return subscriptions formatted as txt
         urls = [p.url for p in subscriptions]
@@ -56,21 +45,14 @@ def format_subscriptions(subscriptions, format):
         return HttpResponse(s, mimetype='text/plain')
 
     elif format == 'opml':
-        # FIXME: We could include the username in the title
-        title = 'Your subscription list'
+        title = username + '\'s subscription list'
         exporter = Exporter(title)
         opml = exporter.generate(subscriptions)
         return HttpResponse(opml, mimetype='text/xml')
 
     elif format == 'json':
-<<<<<<< HEAD:mygpo/api/simple.py
-	json_serializer = serializers.get_serializer("json")()
-	p = json_serializer.serialize(subscriptions, fields=('title', 'description', 'url'))
-        return JsonResponse(p)
-=======
-	urls = [p.url for p in subscriptions]
+        urls = [p.url for p in subscriptions]
         return JsonResponse(urls)
->>>>>>> a85ea6372af96277f06888391f9f9d74d3911a51:mygpo/api/simple.py
 
 def get_subscriptions(username, device_uid):
     #get and return subscription list from database (use backend to sync)
@@ -79,16 +61,11 @@ def get_subscriptions(username, device_uid):
 
 def parse_subscription(raw_post_data, format, username, device_uid):
     if format == 'txt':
-	urls = []
+	    urls = raw_post_data.split('\n')
 
     elif format == 'opml':
-<<<<<<< HEAD:mygpo/api/simple.py
         i = Importer(content=raw_post_data)
-	urls = [p['url'] for p in i.items]
-=======
-        i = Importer(raw_post_data)
-        return i.items
->>>>>>> a85ea6372af96277f06888391f9f9d74d3911a51:mygpo/api/simple.py
+        urls = [p['url'] for p in i.items]
 
     elif format == 'json':
         #deserialize json
@@ -109,17 +86,14 @@ def set_subscriptions(subscriptions):
     d, created = Device.objects.get_or_create(uid=subscriptions[2], user__username=subscriptions[3])
 
     for r in rem:
-	s=SubscriptionAction(podcast=r, action='unsubscribe', timestamp=datetime.now(), device=d)
-	s.save()
+	    s=SubscriptionAction(podcast=r, action='unsubscribe', timestamp=datetime.now(), device=d)
+	    s.save()
 	
     for n in new:
-	 p, created = Podcast.objects.get_or_create(url=n['url'], defaults={
-                'title' : n['title'],
-                'description': n['description'],
-                'last_update': datetime.now() })
-
-	s=SubscriptionAction(podcast=p, action='subscribe', timestamp=datetime.now(), device=d)
+        p, created = Podcast.objects.get_or_create(url=n['url'], defaults={'title' : n['title'], 'description': n['description'], 'last_update': datetime.now() })
+        
+        s=SubscriptionAction(podcast=p, action='subscribe', timestamp=datetime.now(), device=d)
         s.save()
 
-    return HttpResponse('Success', mimetype='text/plain#)
+    return HttpResponse('Success', mimetype='text/plain')
 

commit e019ce6d6503c2f61ab38a5427ab2918fb8a2c69
Merge: ca7487e... a85ea63...
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sat Nov 28 16:28:48 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src
    
    Conflicts:
    	mygpo/api/simple.py
    	mygpo/urls.py

commit 0d1d0b4ff5e300df602b0e88e8798fd9fc52fe62
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 27 16:04:17 2009 +0100

    extending synchronization
    
    SyncGroup.add() can add devices to the SyncGroup
    Device.sync_targets() returns the devices and SyncGroups for which device.sync_with() can be called
    Device.sync_with() now also withs SyncGroups

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 314a842..4a30970 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -88,6 +88,16 @@ class Episode(models.Model):
         db_table = 'episode'
 
 class SyncGroup(models.Model):
+    """
+    Devices that should be synced with each other need to be grouped
+    in a SyncGroup.
+
+    SyncGroups are automatically created by calling
+    device.sync_with(other_device), but can also be created manually.
+
+    device.sync() synchronizes the device for which the method is called
+    with the other devices in its SyncGroup.
+    """
     user = models.ForeignKey(User)
 
     def __unicode__(self):
@@ -97,6 +107,14 @@ class SyncGroup(models.Model):
     def devices(self):
         return Device.objects.filter(sync_group=self)
 
+    def add(self, device):
+        if device.sync_group == self: return
+        if device.sync_group != None:
+            device.unsync()
+
+        device.sync_group = self
+        device.save()
+
     class Meta:
         db_table = 'sync_group'
 
@@ -119,6 +137,19 @@ class Device(models.Model):
         for s in self.get_sync_actions():
             SubscriptionAction.objects.create(device=self, podcast=s.podcast, timestamp=s.timestamp, action=s.action)
 
+    def sync_targets(self):
+        """
+        returns all Devices and SyncGroups that can be used as a parameter for self.sync_with()
+        """
+        sync_targets = list(Device.objects.filter(user=self.user, sync_group=None).exclude(pk=self.id))
+
+        sync_groups = SyncGroup.objects.filter(user=self.user)
+        if self.sync_group != None: sync_groups = sync_groups.exclude(pk=self.sync_group.id)
+
+        sync_targets.extend( list(sync_groups) )
+        return sync_targets
+
+
     def get_sync_actions(self):
         """
         returns the SyncGroupSubscriptionActions correspond to the
@@ -176,21 +207,25 @@ class Device(models.Model):
 
     def sync_with(self, other):
         """
-        set the device to be synchronized with the other device.
-        this method places them in the same SyncGroup. get_sync_actions() can 
-        then return the SyncGroupSubscriptionActions for brining the device 
+        set the device to be synchronized with other, which can either be a Device or a SyncGroup.
+        this method places them in the same SyncGroup. get_sync_actions() can
+        then return the SyncGroupSubscriptionActions for brining the device
         in sync with its group
         """
         if self.user != other.user:
             raise ValueError('the devices belong to different users')
 
+        if isinstance(other, SyncGroup):
+            other.add(self)
+            self.save()
+            return
+
         if self.sync_group == other.sync_group and self.sync_group != None:
             return
 
         if self.sync_group != None:
             if other.sync_group == None:
-                other.sync_group = self.sync_group
-                other.save
+                self.sync_group.add(other)
 
             else:
                 raise ValueError('the devices are in different sync groups')
@@ -198,14 +233,11 @@ class Device(models.Model):
         else:
             if other.sync_group == None:
                 g = SyncGroup.objects.create(user=self.user)
-                self.sync_group=g
-                self.save()
-                other.sync_group=g
-                other.save()
+                g.add(self)
+                g.add(other)
 
             else:
-                self.syn_group = other.sync_group
-                self.save()
+                oter.sync_group.add(self)
 
     def unsync(self):
         """

commit 13f915a112811c191fc5a4cb4887cedb1e33a578
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 27 15:38:06 2009 +0100

    restore accidently reverted changes

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 54db289..017061b 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -16,10 +16,11 @@
 #
 
 from mygpo.api.basic_auth import require_valid_user
-from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
+from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
 from mygpo.api.models import Device
 from mygpo.api.opml import Exporter, Importer
 from mygpo.api.json import JsonResponse
+from django.core import serializers
 
 @require_valid_user()
 def subscriptions(request, username, device_uid, format):
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 460d33d..244415f 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -1,10 +1,17 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
+{% blocktrans %}
   <h1>my.gpodder.org</h1>
   <p>my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications.</p>
+{% endblocktrans %}
+{% blocktrans count list|length as podcast_count%}
+  <p>We are currently tracking one Podcast!</p>
+{% plural %}
   <p>We are currently tracking {{ podcast_count }} Podcasts!</p>
-
+{% endblocktrans %}
+{% blocktrans %}
    <h2>Login</h2>
    <form action="../login/" method="post">
     Username or Email-Address:<br />
@@ -17,6 +24,6 @@
   <div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px;">
    Not yet a member? <a href="/register/">Register!</a>
   </div>
-
+{% endblocktrans %}
 {% endblock %}
 

commit ca7487e78abff58f46460cd4223b7fe22c585f65
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Fri Nov 27 15:09:22 2009 +0100

    	modified:   simple.py
    	modified:   ../urls.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 99afb9a..9295c9a 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -1,6 +1,6 @@
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
-from mygpo.api.models import Device
+from mygpo.api.models import Device, SubscriptionAction
 from mygpo.api.opml import Exporter
 from mygpo.api.json import JsonResponse
 from django.core import serializers
@@ -15,7 +15,7 @@ def subscriptions(request, username, device_uid, format):
         return format_subscriptions(get_subscriptions(username, device_uid), format)
         
     elif request.method == 'PUT':
-        return set_subscriptions(device_uid, parse_subscription(request.raw_post_data, format))
+        return set_subscriptions(parse_subscription(request.raw_post_data, format, username, device_uid))
 
     else:
         return HttpResponseBadReqest()
@@ -33,7 +33,7 @@ def format_subscriptions(subscriptions, format):
     
     elif format == 'json':
 	json_serializer = serializers.get_serializer("json")()
-	p = json_serializer.serialize(subscriptions, ensure_ascii=False, fields=('title', 'description', 'url'))
+	p = json_serializer.serialize(subscriptions, fields=('title', 'description', 'url'))
         return JsonResponse(p)
 
 def get_subscriptions(username, device_uid):
@@ -44,20 +44,44 @@ def get_subscriptions(username, device_uid):
 	raise Http404
     return [p.podcast for p in d.get_subscriptions()]
 
-def parse_subscription(raw_post_data, format):
+def parse_subscription(raw_post_data, format, username, device_uid):
     if format == 'txt':
-        return []
+	urls = []
 
     elif format == 'opml':
         i = Importer(content=raw_post_data)
-        return i.items
+	urls = [p['url'] for p in i.items]
 
     elif format == 'json':
         #deserialize json
-        return []
+        urls = []
 
     else: raise ValueError('unsupported format %s' % format)
 
-def set_subscriptions(device_uid, subscriptions):
-    # save subscriptions in database
-    pass
+    old = [p.url for p in get_subscriptions(username, device_uid)]
+    new = [p for p in urls if urls not in old]
+    rem = [p for p in old if old not in urls]
+    return new, rem, username, device_uid
+
+
+def set_subscriptions(subscriptions):
+    new = subscriptions[0]
+    rem = subscriptions[1]
+
+    d, created = Device.objects.get_or_create(uid=subscriptions[2], user__username=subscriptions[3])
+
+    for r in rem:
+	s=SubscriptionAction(podcast=r, action='unsubscribe', timestamp=datetime.now(), device=d)
+	s.save()
+	
+    for n in new:
+	 p, created = Podcast.objects.get_or_create(url=n['url'], defaults={
+                'title' : n['title'],
+                'description': n['description'],
+                'last_update': datetime.now() })
+
+	s=SubscriptionAction(podcast=p, action='subscribe', timestamp=datetime.now(), device=d)
+        s.save()
+
+    return HttpResponse('Success', mimetype='text/plain#)
+
diff --git a/mygpo/urls.py b/mygpo/urls.py
index ea22f94..ecff0ed 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -17,7 +17,7 @@ urlpatterns = patterns('',
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
  
-    (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>(txt|opml|json))', 'mygpo.api.simple.subscriptions'),
+    (r'^subscriptions/(?P<username>\w+)/(?P<device_uid>\w+).(?P<format>(txt|opml|json))', 'mygpo.api.simple.subscriptions'),
     
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
     # to INSTALLED_APPS to enable admin documentation:

commit 345c52c2fe3af96a5c8972ec79a49c5c0443c5d0
Merge: 2db3df6... a85ea63...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 27 14:11:10 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit a85ea6372af96277f06888391f9f9d74d3911a51
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 27 12:19:18 2009 +0100

    fixed sync performance, updated tests (bug 679)
    
    the synchronisation has been removed from the database and rewritten in
    mygpo.api.models.Device

diff --git a/install/update-04.sql b/install/update-04.sql
index 2df5308..df1fe3e 100644
--- a/install/update-04.sql
+++ b/install/update-04.sql
@@ -1,5 +1,6 @@
 -- replaced by mygpo.api.models.Device.latest_actions()
 DROP VIEW IF EXISTS sync_group_subscription_log;
+DROP VIEW IF EXISTS sync_group_current_subscription;
 
 
 DELIMITER $$
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 427186a..314a842 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -134,11 +134,19 @@ class Device(models.Model):
 
         for d in devices:
             a = d.latest_actions()
-            for s in a.keys:
-                if (not s.podcast.has_key(s)) or (a[s].timestamp > sync_actions[s].timestamp):
-                    if sync_actions[s].actions != a[s].action:
+            for s in a.keys():
+                if not sync_actions.has_key(s):
+		    if a[s].action == SUBSCRIBE_ACTION:
+			sync_actions[s] = a[s]
+		elif a[s].newer_than(sync_actions[s]) and (sync_actions[s].action != a[s].action):
                         sync_actions[s] = a[s]
 
+	#remove actions that did not change
+	current_state = self.latest_actions()
+	for podcast in current_state.keys():
+	    if sync_actions[podcast] == current_state[podcast]:
+		del sync_actions[podcast]
+
         return sync_actions
 
     def latest_actions(self):
@@ -160,7 +168,7 @@ class Device(models.Model):
         """
         returns the latest action for the given podcast on this device
         """
-        actions = SubscriptionAction.objects.filter(podcast=podcast,device=self).order_by('-timestamp')
+        actions = SubscriptionAction.objects.filter(podcast=podcast,device=self).order_by('-timestamp', '-id')
         if len(actions) == 0:
             return None
         else:
@@ -260,6 +268,10 @@ class SubscriptionAction(models.Model):
     def action_string(self):
         return 'subscribe' if self.action == SUBSCRIBE_ACTION else 'unsubscribe'
 
+    def newer_than(self, action):
+        if (self.timestamp == action.timestamp): return self.id > action.id
+	return self.timestamp > action.timestamp
+
     def __unicode__(self):
         return '%s %s %s %s' % (self.device.user, self.device, self.action_string(), self.podcast)
 
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 32e360d..09a5ad4 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -39,10 +39,13 @@ class SyncTest(TestCase):
         s4 = SubscriptionAction.objects.create(device=d2, podcast=p4, action='1')
         u3 = SubscriptionAction.objects.create(device=d2, podcast=p3, action='-1')
 
+	#d1: p1, p3
+	#d2: p2, -p2, p3, p4, -p3
+
         d1.sync_with(d2)
 
-        #d1: p1, p3
-        #d2: p4
+        #d1: -p3, +p4
+        #d2: +p1
 
         sa1 = d1.get_sync_actions()
         sa2 = d2.get_sync_actions()
@@ -50,30 +53,17 @@ class SyncTest(TestCase):
         self.assertEqual( len(sa1), 2)
         self.assertEqual( len(sa2), 1)
 
-        self.assertEqual( sa1[0].device, d2)
-        self.assertEqual( sa1[0].podcast, p4)
-        self.assertEqual( sa1[0].action, 'subscribe')
-
-        self.assertEqual( sa1[1].device, d2)
-        self.assertEqual( sa1[1].podcast, p3)
-        self.assertEqual( sa1[1].action, 'unsubscribe')
-
-        self.assertEqual( sa2[0].device, d1)
-        self.assertEqual( sa2[0].podcast, p1)
-        self.assertEqual( sa2[0].action, 'subscribe')
+        self.assertEqual( sa1[p4].device, d2)
+        self.assertEqual( sa1[p4].podcast, p4)
+        self.assertEqual( sa1[p4].action, 1)
 
+        self.assertEqual( sa1[p3].device, d2)
+        self.assertEqual( sa1[p3].podcast, p3)
+        self.assertEqual( sa1[p3].action, -1)
 
-class SimpleTest(TestCase):
-    def test_basic_addition(self):
-        """
-        Tests that 1 + 1 always equals 2.
-        """
-        self.failUnlessEqual(1 + 1, 2)
+        self.assertEqual( sa2[p1].device, d1)
+        self.assertEqual( sa2[p1].podcast, p1)
+        self.assertEqual( sa2[p1].action, 1)
 
-__test__ = {"doctest": """
-Another way to test that 1 + 1 is equal to 2.
 
->>> 1 + 1 == 2
-True
-"""}
 

commit bdbce477ef9814b18b03ea41a711e594b13b0f1e
Merge: 1ae212c... 1e3811b...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Fri Nov 27 08:34:20 2009 +0000

    Merge branch 'master' of dgpo:~martin/mygpo-src
    
    Conflicts:
    
    	install/update-04.sql

commit 1ae212ce43d54d12c2b4fd290f7155eea3163efc
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 26 23:35:57 2009 +0100

    working on improving sync performance

diff --git a/install/update-04.sql b/install/update-04.sql
new file mode 100644
index 0000000..57ea956
--- /dev/null
+++ b/install/update-04.sql
@@ -0,0 +1,5 @@
+
+-- replaced by mygpo.api.models.Device.latest_actions()
+DROP VIEW IF EXISTS sync_group_subscription_log;
+
+
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 53ab196..427186a 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -89,11 +89,14 @@ class Episode(models.Model):
 
 class SyncGroup(models.Model):
     user = models.ForeignKey(User)
-    
+
     def __unicode__(self):
         devices = [d.name for d in Device.objects.filter(sync_group=self)]
         return '%s - %s' % (self.user, ', '.join(devices))
-             
+
+    def devices(self):
+        return Device.objects.filter(sync_group=self)
+
     class Meta:
         db_table = 'sync_group'
 
@@ -122,21 +125,41 @@ class Device(models.Model):
         SubscriptionActions that need to be saved for the current device
         to synchronize it with its SyncGroup
         """
-        all_sync_actions = SyncGroupSubscriptionAction.objects.filter(sync_group=self.sync_group)
-        podcasts = [p.podcast for p in Subscription.objects.filter(device=self)]
-        sync_actions = []
-        for s in all_sync_actions:
-            a = self.latest_action(s.podcast)
-
-            if a != None and s.timestamp <= a.timestamp: continue
-
-            if s.action == SUBSCRIBE_ACTION and not s.podcast in podcasts:
-                sync_actions.append(s)
-            elif s.action == UNUSBSCRIBE_ACTION and s.podcast in podcasts:
-                sync_actions.append(s)
+        if self.sync_group == None:
+            return []
+
+        devices = self.sync_group.devices().exclude(pk=self.id)
+
+        sync_actions = self.latest_actions()
+
+        for d in devices:
+            a = d.latest_actions()
+            for s in a.keys:
+                if (not s.podcast.has_key(s)) or (a[s].timestamp > sync_actions[s].timestamp):
+                    if sync_actions[s].actions != a[s].action:
+                        sync_actions[s] = a[s]
+
         return sync_actions
 
+    def latest_actions(self):
+        """
+        returns the latest action for each podcast
+        that has an action on this device
+        """
+        #all podcasts that have an action on this device
+        podcasts = [sa.podcast for sa in SubscriptionAction.objects.filter(device=self)]
+        podcasts = list(set(podcasts)) #remove duplicates
+
+        actions = {}
+        for p in podcasts:
+            actions[p] = self.latest_action(p)
+
+        return actions
+
     def latest_action(self, podcast):
+        """
+        returns the latest action for the given podcast on this device
+        """
         actions = SubscriptionAction.objects.filter(podcast=podcast,device=self).order_by('-timestamp')
         if len(actions) == 0:
             return None
@@ -228,7 +251,7 @@ class Subscription(models.Model):
     class Meta:
         db_table = 'current_subscription'
 
-class SubscriptionActionBase(models.Model):
+class SubscriptionAction(models.Model):
     device = models.ForeignKey(Device)
     podcast = models.ForeignKey(Podcast)
     action = models.IntegerField()
@@ -241,21 +264,6 @@ class SubscriptionActionBase(models.Model):
         return '%s %s %s %s' % (self.device.user, self.device, self.action_string(), self.podcast)
 
     class Meta:
-        abstract = True
-        unique_together = ('device', 'podcast', 'action', 'timestamp')
-
-class SubscriptionAction(SubscriptionActionBase):
-    
-    class Meta:
         db_table = 'subscription_log'
-
-class SyncGroupSubscriptionAction(SubscriptionActionBase):
-    """ READ ONLY MODEL """
-    sync_group = models.ForeignKey(SyncGroup)
-
-    def save(self, **kwargs):
-        raise NotImplementedError
-
-    class Meta:
-        db_table = 'sync_group_subscription_log'
+        unique_together = ('device', 'podcast', 'action', 'timestamp')
 
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 33f2dbb..32e360d 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -31,13 +31,13 @@ class SyncTest(TestCase):
         p3 = Podcast.objects.create(title='p3', url='http://p3.com/')
         p4 = Podcast.objects.create(title='p4', url='http://p4.com/')
 
-        s1 = SubscriptionAction.objects.create(device=d1, podcast=p1, action='subscribe')
-        s2 = SubscriptionAction.objects.create(device=d2, podcast=p2, action='subscribe')
-        u2 = SubscriptionAction.objects.create(device=d2, podcast=p2, action='unsubscribe')
-        s3 = SubscriptionAction.objects.create(device=d1, podcast=p3, action='subscribe')
-        s3_= SubscriptionAction.objects.create(device=d2, podcast=p3, action='subscribe')
-        s4 = SubscriptionAction.objects.create(device=d2, podcast=p4, action='subscribe')
-        u3 = SubscriptionAction.objects.create(device=d2, podcast=p3, action='unsubscribe')
+        s1 = SubscriptionAction.objects.create(device=d1, podcast=p1, action='1')
+        s2 = SubscriptionAction.objects.create(device=d2, podcast=p2, action='1')
+        u2 = SubscriptionAction.objects.create(device=d2, podcast=p2, action='-1')
+        s3 = SubscriptionAction.objects.create(device=d1, podcast=p3, action='1')
+        s3_= SubscriptionAction.objects.create(device=d2, podcast=p3, action='1')
+        s4 = SubscriptionAction.objects.create(device=d2, podcast=p4, action='1')
+        u3 = SubscriptionAction.objects.create(device=d2, podcast=p3, action='-1')
 
         d1.sync_with(d2)
 

commit 2db3df6f8f33d251f869d3efe9b017653a9aee60
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 26 20:30:09 2009 +0100

    fix failing admin views
    
    the admin views for Subscription and SubscriptionAction did not work on the
    production server. Those where the only two used with the default ModelAdmin. I
    added an empty ModelAdmin which should fix the problem.

diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 633152a..7df2be7 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -53,11 +53,19 @@ class PodcastAdmin(admin.ModelAdmin):
 class DeviceAdmin(admin.ModelAdmin):
     inlines = [SubscriptionActionInline]
 
+class SubscriptionAdmin(admin.ModelAdmin):
+    #empty ModelAdmin to work around bug 685
+    pass
+
+class SubscriptionActionAdmin(admin.ModelAdmin):
+    #empty ModelAdmin to work around bug 685
+    pass
+
 admin.site.unregister(User)
 admin.site.register(User, UserProfileAdmin)
 admin.site.register(Podcast, PodcastAdmin)
 admin.site.register(SyncGroup, SyncGroupAdmin)
 admin.site.register(Device, DeviceAdmin)
-admin.site.register(Subscription)
-admin.site.register(SubscriptionAction)
+admin.site.register(Subscription, SubscriptionAdmin)
+admin.site.register(SubscriptionAction, SubscriptionActionAdmin)
 

commit ac1af25bc8c38f1d464126280cb57b98e0ae1878
Merge: 1e3811b... 4df2d72...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 26 20:19:53 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit 4df2d722249debccd00fc319db68799c3c1d5339
Merge: 2bf22a0... 300753a...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 26 20:12:32 2009 +0100

    Merge branch 'master' of /home/stefan/mygpo-src

commit 2bf22a0240172b6a88df090eabec199ed1ef2938
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 26 20:11:38 2009 +0100

    ensured unique email address at signup
    
    done by using the registration.forms.RegistrationFormUniqueEmail

diff --git a/mygpo/urls.py b/mygpo/urls.py
index b43ee25..a99dd9f 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -1,6 +1,7 @@
 import os.path
 from django.conf.urls.defaults import *
 from registration.views import activate, register
+from registration.forms import RegistrationFormUniqueEmail
 from mygpo.api.models import UserProfile
 from django.contrib.auth.views import logout
 
@@ -15,7 +16,7 @@ urlpatterns = patterns('',
     (r'^login/$', 'mygpo.web.users.login_user'),
     (r'^logout/$', logout, {'next_page': '/'}),
     (r'^migrate/$', 'mygpo.web.users.migrate_user'),
-    (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/' }),
+    (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/', 'form_class': RegistrationFormUniqueEmail}),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
     (r'^activate/(?P<activation_key>\w+)$', activate),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),

commit 1e3811b7fdf248ba7bb4436de1f2f0019285790b
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Nov 26 15:32:43 2009 +0100

    internationalisation Bug 643

diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 460d33d..244415f 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -1,10 +1,17 @@
 {% extends "base.html" %}
+{% load i18n %}
 
 {% block content %}
+{% blocktrans %}
   <h1>my.gpodder.org</h1>
   <p>my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications.</p>
+{% endblocktrans %}
+{% blocktrans count list|length as podcast_count%}
+  <p>We are currently tracking one Podcast!</p>
+{% plural %}
   <p>We are currently tracking {{ podcast_count }} Podcasts!</p>
-
+{% endblocktrans %}
+{% blocktrans %}
    <h2>Login</h2>
    <form action="../login/" method="post">
     Username or Email-Address:<br />
@@ -17,6 +24,6 @@
   <div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px;">
    Not yet a member? <a href="/register/">Register!</a>
   </div>
-
+{% endblocktrans %}
 {% endblock %}
 

commit 9f8b4f1252b5f1a6f7cddd511c561abf52dc55da
Merge: 7bb24c4... f84272d...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Nov 26 13:28:05 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/alex/mygpo-src

commit 7bb24c45b9f810ef649cd8d617db2b5cb0ebe62c
Merge: 3c67f4a... 300753a...
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Thu Nov 26 13:27:44 2009 +0100

    Merge branch 'master' of dev.gpodder.org:/home/stefan/mygpo-src

commit 326a56cbe3e79c84b9cf734f25b6d0f8aa365b6f
Merge: 80d5751... 300753a...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Wed Nov 25 10:09:58 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit 300753a27368a793f05ed7d3116117b73d039b45
Author: Thomas Perl <thp@thpinfo.com>
Date:   Wed Nov 25 01:23:03 2009 +0100

    Initial working version of feed-downloader

diff --git a/bin/feed-downloader b/bin/feed-downloader
index 8413abf..5c151ea 100755
--- a/bin/feed-downloader
+++ b/bin/feed-downloader
@@ -22,12 +22,51 @@ USER_AGENT = 'mygpo crawler (+http://my.gpodder.org)'
 
 import os
 import sys
+import datetime
+import socket
+
+os.environ['DJANGO_SETTINGS_MODULE'] = 'mygpo.settings'
 
 sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))
 
 from mygpo import feedcore
+from mygpo.api import models
 
+socket.setdefaulttimeout(10)
 fetcher = feedcore.Fetcher(USER_AGENT)
 
-# FIXME FIXME
+UPDATE_LIMIT = datetime.datetime.now() - datetime.timedelta(days=15)
+
+#fetch_queue = models.Podcast.objects.all()
+fetch_queue = models.Podcast.objects.filter(last_update__lt=UPDATE_LIMIT)
+
+for podcast in fetch_queue:
+    # XXX: Wrong data format in the database?
+    podcast.url = podcast.url.lstrip('"')
+
+    print podcast.url
+
+    try:
+        fetcher.fetch(podcast.url)
+    except feedcore.Offline:
+        pass
+    except feedcore.InvalidFeed:
+        pass
+    except feedcore.WifiLogin:
+        pass
+    except feedcore.AuthenticationRequired:
+        pass
+    except feedcore.NewLocation, location:
+        podcast.url = location.data
+    except feedcore.UpdatedFeed, updated:
+        feed = updated.data
+        podcast.title = feed.feed.get('title', podcast.url)
+        podcast.link = feed.feed.get('link', podcast.url)
+        podcast.description = feed.feed.get('subtitle', podcast.description)
+
+    podcast.last_update = datetime.datetime.now()
+    try:
+        podcast.save()
+    except Exception, e:
+        print e
 

commit cc0a3081982c3b23b58685dfa0de2e07466e38bc
Author: Thomas Perl <thp@thpinfo.com>
Date:   Wed Nov 25 00:49:40 2009 +0100

    Initial version of feed downloader
    
    No working version so far, but the initial
    code and framework is there.

diff --git a/INSTALL b/INSTALL
index f48401f..1cbfe9a 100644
--- a/INSTALL
+++ b/INSTALL
@@ -10,6 +10,7 @@ Dependencies:
   * MySQL Server (>= 5.0)
   * python-mysqldb
   * lighttpd
+  * python-feedparser
 
 1. Creating the database
 
diff --git a/bin/feed-downloader b/bin/feed-downloader
new file mode 100755
index 0000000..8413abf
--- /dev/null
+++ b/bin/feed-downloader
@@ -0,0 +1,33 @@
+#!/usr/bin/python
+# -*- coding: utf-8 -*-
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+USER_AGENT = 'mygpo crawler (+http://my.gpodder.org)'
+
+
+import os
+import sys
+
+sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))
+
+from mygpo import feedcore
+
+fetcher = feedcore.Fetcher(USER_AGENT)
+
+# FIXME FIXME
+
diff --git a/mygpo/feedcore.py b/mygpo/feedcore.py
new file mode 100644
index 0000000..fa26333
--- /dev/null
+++ b/mygpo/feedcore.py
@@ -0,0 +1,243 @@
+# -*- coding: utf-8 -*-
+#
+# gPodder - A media aggregator and podcast client
+# Copyright (c) 2005-2009 Thomas Perl and the gPodder Team
+#
+# gPodder is free software; you can redistribute it and/or modify
+# it under the terms of the GNU General Public License as published by
+# the Free Software Foundation; either version 3 of the License, or
+# (at your option) any later version.
+#
+# gPodder is distributed in the hope that it will be useful,
+# but WITHOUT ANY WARRANTY; without even the implied warranty of
+# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+# GNU General Public License for more details.
+#
+# You should have received a copy of the GNU General Public License
+# along with this program.  If not, see <http://www.gnu.org/licenses/>.
+#
+
+#
+# Generic feed fetching module for aggregators
+# Thomas Perl <thpinfo.com>; 2009-06-11
+#
+
+import feedparser
+
+import urllib
+import urlparse
+import urllib2
+
+def patch_feedparser():
+    """Monkey-patch the Universal Feed Parser"""
+    # Detect the 'plain' content type as 'text/plain'
+    # http://code.google.com/p/feedparser/issues/detail?id=80
+    def mapContentType2(self, contentType):
+        contentType = contentType.lower()
+        if contentType == 'text' or contentType == 'plain':
+            contentType = 'text/plain'
+        elif contentType == 'html':
+            contentType = 'text/html'
+        elif contentType == 'xhtml':
+            contentType = 'application/xhtml+xml'
+        return contentType
+
+    try:
+        if feedparser._FeedParserMixin().mapContentType('plain') == 'plain':
+            feedparser._FeedParserMixin.mapContentType = mapContentType2
+    except:
+        pass
+    
+    # Fix parsing of Media RSS with feedparser, as described here: 
+    #   http://code.google.com/p/feedparser/issues/detail?id=100#c4
+    def _start_media_content(self, attrsD):
+        context = self._getContext()
+        context.setdefault('media_content', [])
+        context['media_content'].append(attrsD)
+        
+    try:
+        feedparser._FeedParserMixin._start_media_content = _start_media_content
+    except:
+        pass
+
+    # Fix problem with the EA.com official podcast
+    # https://bugs.gpodder.org/show_bug.cgi?id=588
+    if '*/*' not in feedparser.ACCEPT_HEADER.split(','):
+        feedparser.ACCEPT_HEADER += ',*/*'
+
+patch_feedparser()
+
+
+class ExceptionWithData(Exception):
+    """Base exception with additional payload"""
+    def __init__(self, data):
+        Exception.__init__(self)
+        self.data = data
+
+    def __str__(self):
+        return '%s: %s' % (self.__class__.__name__, str(self.data))
+
+
+# Temporary errors
+class Offline(Exception): pass
+class BadRequest(Exception): pass
+class InternalServerError(Exception): pass
+class WifiLogin(ExceptionWithData): pass
+
+# Fatal errors
+class Unsubscribe(Exception): pass
+class NotFound(Exception): pass
+class InvalidFeed(Exception): pass
+class UnknownStatusCode(ExceptionWithData): pass
+
+# Authentication error
+class AuthenticationRequired(Exception): pass
+
+# Successful parsing of the feed
+class UpdatedFeed(ExceptionWithData): pass
+class NewLocation(ExceptionWithData): pass
+class NotModified(ExceptionWithData): pass
+
+
+
+class Fetcher(object):
+    # Supported types, see http://feedvalidator.org/docs/warning/EncodingMismatch.html
+    FEED_TYPES = ('application/rss+xml',
+                  'application/atom+xml',
+                  'application/rdf+xml',
+                  'application/xml',
+                  'text/xml')
+
+    def __init__(self, user_agent):
+        self.user_agent = user_agent
+
+    def _get_handlers(self):
+        """Provide additional urllib2 handler objects
+
+        Subclasses can override this method to inject urllib2
+        handler objects into the feedparser.parse() call to
+        extent the functionalty of this Fetcher (for proxies, ..)
+        """
+        return []
+
+    def _resolve_url(self, url):
+        """Provide additional ways of resolving an URL
+
+        Subclasses can override this method to provide more
+        ways of resolving a given URL to a feed URL. If the
+        Fetcher is in "autodiscovery" mode, it will try this
+        method as a last resort for coming up with a feed URL.
+        """
+        return None
+
+    def _autodiscover_feed(self, feed):
+        try:
+            # First, try all <link> elements if available
+            for link in feed.feed.get('links', ()):
+                is_feed = link.get('type', '') in self.FEED_TYPES
+                is_alternate = link.get('rel', '') == 'alternate'
+                url = link.get('href', None)
+
+                if url and is_feed and is_alternate:
+                    try:
+                        self._parse_feed(url, None, None, False)
+                    except UpdatedFeed, updated:
+                        raise
+                    except Exception:
+                        pass
+
+            # Second, try to resolve the URL
+            url = self._resolve_url(feed.href)
+            if url:
+                self._parse_feed(url, None, None, False)
+        except UpdatedFeed, updated:
+            raise NewLocation(updated.data)
+        except Exception, e:
+            pass
+
+    def _check_offline(self, feed):
+        if not hasattr(feed, 'headers'):
+            raise Offline()
+
+    def _check_wifi_login_page(self, feed):
+        html_page = 'text/html' in feed.headers.get('content-type', '')
+        if not feed.version and feed.status == 302 and html_page:
+            raise WifiLogin(feed.href)
+
+    def _check_valid_feed(self, feed):
+        if feed is None:
+            raise InvalidFeed('feed is None')
+
+        if not hasattr(feed, 'status'):
+            raise InvalidFeed('feed has no status code')
+
+        if not feed.version and feed.status != 304 and feed.status != 401:
+            raise InvalidFeed('unknown feed type')
+
+    def _normalize_status(self, status):
+        # Based on Mark Pilgrim's "Atom aggregator behaviour" article
+        if status in (200, 301, 302, 304, 400, 401, 403, 404, 410, 500):
+            return status
+        elif status >= 200 and status < 300:
+            return 200
+        elif status >= 300 and status < 400:
+            return 302
+        elif status >= 400 and status < 500:
+            return 400
+        elif status >= 500 and status < 600:
+            return 500
+        else:
+            return status
+
+    def _check_statuscode(self, feed):
+        status = self._normalize_status(feed.status)
+        if status == 200:
+            raise UpdatedFeed(feed)
+        elif status == 301:
+            raise NewLocation(feed)
+        elif status == 302:
+            raise UpdatedFeed(feed)
+        elif status == 304:
+            raise NotModified(feed)
+        elif status == 400:
+            raise BadRequest('bad request')
+        elif status == 401:
+            raise AuthenticationRequired('authentication required')
+        elif status == 403:
+            raise Unsubscribe('forbidden')
+        elif status == 404:
+            raise NotFound('not found')
+        elif status == 410:
+            raise Unsubscribe('resource is gone')
+        elif status == 500:
+            raise InternalServerError('internal server error')
+        else:
+            raise UnknownStatusCode(status)
+
+    def _parse_feed(self, url, etag, modified, autodiscovery=True):
+        """Parse the feed and raise the result."""
+        feed = feedparser.parse(url,
+                agent=self.user_agent,
+                modified=modified,
+                etag=etag,
+                handlers=self._get_handlers())
+
+        self._check_offline(feed)
+        self._check_wifi_login_page(feed)
+
+        if feed.status != 304 and not feed.version and autodiscovery:
+            self._autodiscover_feed(feed)
+
+        self._check_valid_feed(feed)
+        self._check_statuscode(feed)
+
+    def fetch(self, url, etag=None, modified=None):
+        """Download a feed, with optional etag an modified values
+
+        This method will always raise an exception that tells
+        the calling code the result of the fetch operation. See
+        the code for the feedcore module for all the possible
+        exception types.
+        """
+        self._parse_feed(url, etag, modified)
+

commit 39abeb3935c17f15ff2b879d49022bbd8eebaf06
Author: Thomas Perl <thp@thpinfo.com>
Date:   Wed Nov 25 00:33:54 2009 +0100

    Implement logging using syslog (bug 681)

diff --git a/mygpo/logging.py b/mygpo/logging.py
new file mode 100644
index 0000000..6aea1f6
--- /dev/null
+++ b/mygpo/logging.py
@@ -0,0 +1,26 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+# my.gpodder.org logging module
+
+import syslog
+
+syslog.openlog('my.gpodder.org')
+
+def log(message):
+    syslog.syslog(message)
+

commit d179669cc7f59856a407e4e675da3ef3b8ce7efe
Author: Thomas Perl <thp@thpinfo.com>
Date:   Wed Nov 25 00:29:52 2009 +0100

    Clean up and refactor the OPML Importer/Exporter

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index abc0c18..4781b19 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -46,7 +46,7 @@ def upload(request):
 
     existing_urls = [e.podcast.url for e in existing]
 
-    i = Importer(content=opml)
+    i = Importer(opml)
     podcast_urls = [p['url'] for p in i.items]
 
     new = [item for item in i.items if item['url'] not in existing_urls]
@@ -78,7 +78,10 @@ def getlist(request):
         defaults = {'type': 'unknown', 'name': LEGACY_DEVICE_NAME})
 
     podcasts = [s.podcast for s in d.get_subscriptions()]
-    exporter = Exporter(filename='')
+
+    # FIXME: Get username and set a proper title (e.g. "thp's subscription list")
+    title = 'Your subscription list'
+    exporter = Exporter(title)
 
     opml = exporter.generate(podcasts)
 
diff --git a/mygpo/api/opml.py b/mygpo/api/opml.py
index d242f57..17c3138 100644
--- a/mygpo/api/opml.py
+++ b/mygpo/api/opml.py
@@ -16,134 +16,75 @@
 # along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
 #
 
+"""OPML importer and exporter (based on gPodder's "opml" module)
 
-#
-#  based on: gPodder's opml.py (2007-08-19)
-#            libopmlreader.py (2006-06-13)
-#            libopmlwriter.py (2005-12-08)
-#
-
-"""OPML import and export functionality
-
-This module contains helper classes to import subscriptions 
-from OPML files on the web and to export a list of channel 
-objects to valid OPML 1.1 files.
+This module contains helper classes to import subscriptions from OPML files on
+the web and to export a list of podcast objects to valid OPML 1.1 files.
 """
 
-from mygpo.api import util
-
-import xml.dom.minidom
-
-import urllib
-import urllib2
-import os.path
 import os
-import platform
-import shutil
+import os.path
 
-from email.Utils import formatdate
+import xml.dom.minidom
+import email.Utils
 
 
 class Importer(object):
-    """
-    Helper class to import an OPML feed from protocols
-    supported by urllib2 (e.g. HTTP) and return a GTK 
-    ListStore that can be displayed in the GUI.
-
-    This class should support standard OPML feeds and
-    contains workarounds to support odeo.com feeds.
-    """
-
-    VALID_TYPES = ( 'rss', 'link' )
-    USER_AGENT = 'my.gpodder.org'
-
-    def read_url( self, url):
-        request = urllib2.Request( url, headers = {'User-agent': self.USER_AGENT})
-        return urllib2.urlopen( request).read()
+    VALID_TYPES = ('rss', 'link')
 
-    def __init__( self, url='', content=''):
+    def __init__(self, content):
         """
-        Parses the OPML feed from the given URL into 
-        a local data structure containing channel metadata.
+        Parses the OPML feed from the given URL into a local data structure
+        containing podcast metadata.
         """
         self.items = []
         try:
-            if content != '':
-                doc = xml.dom.minidom.parseString(content)
-            elif os.path.exists(url):
-                doc = xml.dom.minidom.parse(url)
-            else:
-                doc = xml.dom.minidom.parseString(self.read_url(url))
+            doc = xml.dom.minidom.parseString(content)
 
             for outline in doc.getElementsByTagName('outline'):
-                if outline.getAttribute('type') in self.VALID_TYPES and outline.getAttribute('xmlUrl') or outline.getAttribute('url'):
+                if outline.getAttribute('type') in self.VALID_TYPES and \
+                        outline.getAttribute('xmlUrl') or \
+                        outline.getAttribute('url'):
                     channel = {
-                        'url': outline.getAttribute('xmlUrl') or outline.getAttribute('url'),
-                        'title': outline.getAttribute('title') or outline.getAttribute('text') or outline.getAttribute('xmlUrl') or outline.getAttribute('url'),
-                        'description': outline.getAttribute('text') or outline.getAttribute('xmlUrl') or outline.getAttribute('url'),
+                        'url': outline.getAttribute('xmlUrl') or \
+                               outline.getAttribute('url'),
+                        'title': outline.getAttribute('title') or \
+                                 outline.getAttribute('text') or \
+                                 outline.getAttribute('xmlUrl') or \
+                                 outline.getAttribute('url'),
+                        'description': outline.getAttribute('text') or \
+                                       outline.getAttribute('xmlUrl') or \
+                                       outline.getAttribute('url'),
                     }
 
                     if channel['description'] == channel['title']:
                         channel['description'] = channel['url']
 
-                    for attr in ( 'url', 'title', 'description' ):
+                    for attr in ('url', 'title', 'description'):
                         channel[attr] = channel[attr].strip()
 
-                    self.items.append( channel)
-                else:
-                    print 'wrong type'
-            if not len(self.items):
-                #log( 'OPML import finished, but no items found: %s', url, sender = self)
-                print 'OPML import finished, but no items found: %s' % url
-                pass
+                    self.items.append(channel)
         except Exception, e:
-            #log( 'Cannot import OPML from URL: %s', url, traceback=True, sender = self)
-            print 'Cannot import OPML from URL: %s: %s' % (url, e)
-            pass
+            # FIXME: Logging or raising the exception to the caller
+            print 'OPML read error:', e
+
 
 class Exporter(object):
     """
-    Helper class to export a list of channel objects
-    to a local file in OPML 1.1 format.
-
-    See www.opml.org for the OPML specification.
+    Helper class to export a list of channel objects to a local file in OPML
+    1.1 format. See www.opml.org for the OPML specification.
     """
 
-    FEED_TYPE = 'rss'
+    def __init__(self, title='my.gpodder.org Subscriptions'):
+        self.title = title
+        self.created = email.Utils.formatdate(localtime=True)
 
-    def __init__( self, filename=''):
-        if filename.endswith( '.opml') or filename.endswith( '.xml'):
-            self.filename = filename
-        else:
-            self.filename = '%s.opml' % ( filename, )
-
-    def create_node( self, doc, name, content):
-        """
-        Creates a simple XML Element node in a document 
-        with tag name "name" and text content "content", 
-        as in <name>content</name> and returns the element.
+    def generate(self, channels):
         """
-        node = doc.createElement( name)
-        node.appendChild( doc.createTextNode( content))
-        return node
+        Creates a XML document containing metadata for each channel object in
+        the "channels" parameter, which should be a list of channel objects.
 
-    def create_outline( self, doc, channel):
-        """
-        Creates a OPML outline as XML Element node in a
-        document for the supplied channel.
-        """
-        outline = doc.createElement( 'outline')
-        outline.setAttribute( 'title', channel.title)
-        outline.setAttribute( 'text', channel.description if channel.description != None else '')
-        outline.setAttribute( 'xmlUrl', channel.url)
-        outline.setAttribute( 'type', self.FEED_TYPE)
-        return outline
-
-    def generate( self, channels):
-        """
-        Creates a XML document containing metadata for each 
-        channel object in the "channels" parameter, which 
-        should be a list of channel objects.
+        Returns: An OPML document as string
         """
         doc = xml.dom.minidom.Document()
 
@@ -151,48 +92,30 @@ class Exporter(object):
         opml.setAttribute('version', '2.0')
         doc.appendChild(opml)
 
-        head = doc.createElement( 'head')
-        head.appendChild( self.create_node( doc, 'title', 'my.gpodder.org Subscriptions'))
-        head.appendChild( self.create_node( doc, 'dateCreated', formatdate(localtime=True)))
-        opml.appendChild( head)
-
-        body = doc.createElement( 'body')
+        def create_node(name, content):
+            node = doc.createElement(name)
+            node.appendChild(doc.createTextNode(content))
+            return node
+
+        head = doc.createElement('head')
+        head.appendChild(create_node('title', self.title))
+        head.appendChild(create_node('dateCreated', self.created))
+        opml.appendChild(head)
+
+        def create_outline(channel):
+            outline = doc.createElement('outline')
+            outline.setAttribute('title', channel.title)
+            outline.setAttribute('text', channel.description or '')
+            outline.setAttribute('xmlUrl', channel.url)
+            outline.setAttribute('type', 'rss')
+            return outline
+
+        body = doc.createElement('body')
         for channel in channels:
-            body.appendChild( self.create_outline( doc, channel))
-        opml.appendChild( body)
-        return doc.toprettyxml(encoding='utf-8', indent='    ', newl=os.linesep)
-
-    def write( self, channels):
-        """
-        Creates a XML document containing metadata for each 
-        channel object in the "channels" parameter, which 
-        should be a list of channel objects.
-
-        OPML 2.0 specification: http://www.opml.org/spec2
+            body.appendChild(create_outline(channel))
+        opml.appendChild(body)
 
-        Returns True on success or False when there was an 
-        error writing the file.
-        """
-        data = self.generate( self, channels)
-
-        try:
-            # We want to have at least 512 KiB free disk space after
-            # saving the opml data, if this is not possible, don't 
-            # try to save the new file, but keep the old one so we
-            # don't end up with a clobbed, empty opml file.
-            FREE_DISK_SPACE_AFTER = 1024*512
-            available = util.get_free_disk_space(os.path.dirname(self.filename))
-            if available < 2*len(data)+FREE_DISK_SPACE_AFTER:
-                # FIXME: get_free_disk_space still unimplemented for win32
-                #log('Not enough free disk space to save channel list to %s', self.filename, sender = self)
-                return False
-            fp = open(self.filename+'.tmp', 'w')
-            fp.write(data)
-            fp.close()
-            os.rename(self.filename+'.tmp', self.filename)
-        except:
-            #log('Could not open file for writing: %s', self.filename, sender=self, traceback=True)
-            return False
-
-        return True
+        return doc.toprettyxml(encoding='utf-8', \
+                               indent='  ', \
+                               newl=os.linesep)
 
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 4200029..54db289 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -18,7 +18,7 @@
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
 from mygpo.api.models import Device
-from mygpo.api.opml import Exporter
+from mygpo.api.opml import Exporter, Importer
 from mygpo.api.json import JsonResponse
 
 @require_valid_user()
@@ -46,8 +46,12 @@ def format_subscriptions(subscriptions, format):
         return HttpResponse(s, mimetype='text/plain')
 
     elif format == 'opml':
-        return HttpResponse(Exporter().generate(subscriptions), mimetype='text/xml')
-    
+        # FIXME: We could include the username in the title
+        title = 'Your subscription list'
+        exporter = Exporter(title)
+        opml = exporter.generate(subscriptions)
+        return HttpResponse(opml, mimetype='text/xml')
+
     elif format == 'json':
 	urls = [p.url for p in subscriptions]
         return JsonResponse(urls)
@@ -62,7 +66,7 @@ def parse_subscription(raw_post_data, format):
         return []
 
     elif format == 'opml':
-        i = Importer(content=raw_post_data)
+        i = Importer(raw_post_data)
         return i.items
 
     elif format == 'json':
diff --git a/mygpo/api/util.py b/mygpo/api/util.py
deleted file mode 100644
index 31cf956..0000000
--- a/mygpo/api/util.py
+++ /dev/null
@@ -1,33 +0,0 @@
-#
-# This file is part of my.gpodder.org.
-#
-# my.gpodder.org is free software: you can redistribute it and/or modify it
-# under the terms of the GNU Affero General Public License as published by
-# the Free Software Foundation, either version 3 of the License, or (at your
-# option) any later version.
-#
-# my.gpodder.org is distributed in the hope that it will be useful, but
-# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
-# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
-# License for more details.
-#
-# You should have received a copy of the GNU Affero General Public License
-# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
-#
-
-def get_free_disk_space(path):
-    """
-    Calculates the free disk space available to the current user
-    on the file system that contains the given path.
-
-    If the path (or its parent folder) does not yet exist, this
-    function returns zero.
-    """
-
-    if not os.path.exists(path):
-        return 0
-
-    s = os.statvfs(path)
-
-    return s.f_bavail * s.f_bsize
-

commit 336be028d6f83f3a201b8befe1f77b5ffb32c4c3
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Nov 24 23:58:09 2009 +0100

    Add installation/deployment instructions

diff --git a/INSTALL b/INSTALL
new file mode 100644
index 0000000..f48401f
--- /dev/null
+++ b/INSTALL
@@ -0,0 +1,52 @@
+
+                   Deployment instructions for my.gpodder.org
+                   ------------------------------------------
+
+Dependencies:
+
+  * python (>= 2.5)
+  * python-django
+  * django-registration
+  * MySQL Server (>= 5.0)
+  * python-mysqldb
+  * lighttpd
+
+1. Creating the database
+
+In MySQL, do the following (the SUPER grant is needed for
+triggers to work in MySQL 5.0):
+
+  CREATE DATABASE mygpo;
+  GRANT ALL ON mygpo.* TO mygpo@localhost WITH GRANT OPTION;
+  GRANT SUPER ON *.* TO MYGPO@localhost;
+  FLUSH PRIVILEGES;
+
+
+2. Initialize the database
+
+Run in the mygpo/ subdirectory (possibly after setting the
+DB parameters in mygpo/settings.py):
+
+  python manage.py syncdb
+
+When asked to create a superuser, say NO.
+
+Now, run every SQL-Script in the install/ subdirectory, starting
+with "create.sql" and working your way all the way through the
+update scripts (these are split because we are doing incremental
+schema updates on the production server).
+
+
+3. Setup the web server using lighttpd
+
+There is a mygpo.lighttpd.conf file shipped with the source. Please
+customize it to your needs, and then include it from your lighttpd
+main configuration file.
+
+4. Restart lighttpd
+
+On Debian:
+
+  /etc/init.d/lighttpd restart
+
+
diff --git a/install/crate-database.sql b/install/crate-database.sql
deleted file mode 100644
index 863056c..0000000
--- a/install/crate-database.sql
+++ /dev/null
@@ -1,195 +0,0 @@
-DROP TABLE IF EXISTS user;
-CREATE TABLE user (
-    user_ptr_id INT REFERENCES auth_user(id),
-    generated_id TINYINT(1) NOT NULL DEFAULT 0,
-    public_profile TINYINT(1) NOT NULL DEFAULT 1,
-    default_device INT REFERENCES device(id)
-);
-
-DROP TABLE IF EXISTS podcast;
-CREATE TABLE podcast (
-    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
-    url VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
-    title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
-    description TEXT,
-    link VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin,
-    last_update TIMESTAMP DEFAULT 0,
-    logo_url VARCHAR(1000)
-);
-
-DROP TABLE IF EXISTS episode;
-CREATE TABLE episode (
-    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
-    podcast_id INT REFERENCES podcast (id),
-    url VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
-    title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
-    description TEXT,
-    link VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin
-);
-
-DROP TABLE IF EXISTS episode_log;
-CREATE TABLE episode_log (
-    user_id INT REFERENCES user (user_ptr_id),
-    episode_id INT REFERENCES episode (id),
-    device_id INT REFERENCES device (id),
-    action ENUM ('download', 'play', 'sync', 'lock', 'delete') NOT NULL,
-    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
-    playmark INT DEFAULT 0,
-    PRIMARY KEY (user_id, episode_id, action, timestamp, device_id)
-);
-
-DROP TABLE IF EXISTS device;
-CREATE TABLE device (
-    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
-    user_id INT REFERENCES user (user_ptr_id),
-    name VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
-    type ENUM ('desktop', 'laptop', 'mobile', 'server', 'other') NOT NULL
-);
-
-DROP TABLE IF EXISTS subscription;
-CREATE TABLE subscription (
-    user_id INT REFERENCES user (user_ptr_id),
-    podcast_id INT REFERENCES podcast (id),
-    public TINYINT(1) NOT NULL DEFAULT 1,
-    PRIMARY KEY (user_id, podcast_id)
-);
-
-DROP TABLE IF EXISTS subscription_log;
-CREATE TABLE subscription_log (
-    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
-    device_id INT REFERENCES device (id),
-    podcast_id INT REFERENCES podcast (id),
-    action TINYINT(1) NOT NULL,
-    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
-    UNIQUE (device_id, podcast_id, action, timestamp)
-);
-
-DROP TABLE IF EXISTS current_subscription;
-DROP VIEW IF EXISTS current_subscription;
-
-CREATE VIEW current_subscription AS
-	SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since FROM
-		(subscription_log a JOIN device b on a.device_id=b.id) JOIN user c on b.user_id=c.user_ptr_id
-			WHERE action='subscribe' 
-			AND NOT EXISTS (
-				SELECT id FROM subscription_log
-					WHERE action='unsubscribe'
-                    			AND device_id=a.device_id
-					AND podcast_id=a.podcast_id
-                    			AND timestamp > a.timestamp
-				);
-
-DROP TABLE IF EXISTS Error;
-CREATE TABLE Error (                                                                                                         
-          ErrorGID int(10) unsigned NOT NULL auto_increment,                                                                         
-          Message varchar(128) default NULL,                                                                                         
-          Created timestamp NOT NULL default CURRENT_TIMESTAMP,                                         
-          PRIMARY KEY (ErrorGID),                                                                                                   
-          UNIQUE KEY ERROR (Message));
-          
-DELIMITER $$
-DROP PROCEDURE IF EXISTS Fail $$
-CREATE PROCEDURE Fail(_Message VARCHAR(128))
-BEGIN
-  INSERT INTO Error (Message) VALUES (_Message);
-  INSERT INTO Error (Message) VALUES (_Message);
-END;$$
-DELIMITER ;
-
-DELIMITER //
-CREATE TRIGGER podcast_trig_url_unique BEFORE INSERT ON podcast
-FOR EACH ROW
-BEGIN
-	declare help_url varchar(3000);
-	set help_url = null;
-  
-   	SELECT a.url into help_url FROM podcast a where a.url=new.url;
-
-	IF help_url is not null THEN
-		call Fail('This URL already exists!');
-	END IF;
-
-END;//
-DELIMITER ;
-
-DROP TABLE IF EXISTS toplist;
-CREATE TABLE toplist (
-    	podcast_id INT PRIMARY KEY REFERENCES podcast (id),
-    	subscription_count INT NOT NULL DEFAULT 0,
-        INDEX(podcast_id)
-);
-
-DELIMITER $$
-DROP PROCEDURE IF EXISTS update_toplist $$
-CREATE PROCEDURE update_toplist()
-BEGIN
-	DECLARE deadlock INT DEFAULT 0;
-    	DECLARE attempts INT DEFAULT 0;
-
-	try_loop:WHILE (attempts<3) DO
-	BEGIN
-		DECLARE deadlock_detected CONDITION FOR 1213;
-    		DECLARE EXIT HANDLER FOR deadlock_detected
-    			BEGIN
-    				ROLLBACK;
-    				SET deadlock=1;
-    			END;
-    		SET deadlock=0;
-   			
-    		START TRANSACTION;
-			DELETE FROM toplist;
-			INSERT INTO toplist (SELECT a.podcast_id, count(a.podcast_id) as count_subscription 
-				FROM current_subscription a, user b 
-				WHERE b.user_ptr_id = a.user_id
-				AND b.public_profile = 1
-				AND NOT EXISTS (SELECT * FROM subscription 
-							WHERE a.podcast_id=podcast_id
-							AND a.user_id=user_id
-							AND public = 0)
-				AND a.device_id = (SELECT min(device_id) FROM current_subscription 
-								WHERE a.podcast_id=podcast_id
-								AND a.user_id=user_id)
-				group by a.podcast_id order by count_subscription DESC);
-			
-			COMMIT;
-		END;
-		IF deadlock=0 THEN
-    			LEAVE try_loop;
-    		ELSE
-    			SET attempts=attempts+1;
-    		END IF;
-    	END WHILE try_loop;
-
-	IF deadlock=1 THEN
-		call FAIL('Toplist is not updated!');
-	END IF;
-
-END $$
-DELIMITER ;
-
-DELIMITER //
-CREATE TRIGGER subscription_log_trigger BEFORE INSERT ON subscription_log
-FOR EACH ROW
-BEGIN
-	declare help_id INT;
-	set help_id = null;
-
-   	SELECT a.user_id into help_id FROM current_subscription a 
-			where a.device_id = new.device_id
-			and a.podcast_id = new.podcast_id;
-
-	IF new.action = 'subscribe' THEN
-    		IF help_id is not null THEN
-			call Fail('This subscription already exists!');
-		END IF;
-    	ELSE
-    		IF help_id is null THEN
-			call Fail('This subscription not exists!');
-		END IF;
-    	END IF;
-
-END;//
-DELIMITER ;
-
-
-
diff --git a/install/create-db.sql b/install/create-db.sql
new file mode 100644
index 0000000..863056c
--- /dev/null
+++ b/install/create-db.sql
@@ -0,0 +1,195 @@
+DROP TABLE IF EXISTS user;
+CREATE TABLE user (
+    user_ptr_id INT REFERENCES auth_user(id),
+    generated_id TINYINT(1) NOT NULL DEFAULT 0,
+    public_profile TINYINT(1) NOT NULL DEFAULT 1,
+    default_device INT REFERENCES device(id)
+);
+
+DROP TABLE IF EXISTS podcast;
+CREATE TABLE podcast (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    url VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
+    title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+    description TEXT,
+    link VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin,
+    last_update TIMESTAMP DEFAULT 0,
+    logo_url VARCHAR(1000)
+);
+
+DROP TABLE IF EXISTS episode;
+CREATE TABLE episode (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    podcast_id INT REFERENCES podcast (id),
+    url VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
+    title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+    description TEXT,
+    link VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin
+);
+
+DROP TABLE IF EXISTS episode_log;
+CREATE TABLE episode_log (
+    user_id INT REFERENCES user (user_ptr_id),
+    episode_id INT REFERENCES episode (id),
+    device_id INT REFERENCES device (id),
+    action ENUM ('download', 'play', 'sync', 'lock', 'delete') NOT NULL,
+    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
+    playmark INT DEFAULT 0,
+    PRIMARY KEY (user_id, episode_id, action, timestamp, device_id)
+);
+
+DROP TABLE IF EXISTS device;
+CREATE TABLE device (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    user_id INT REFERENCES user (user_ptr_id),
+    name VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
+    type ENUM ('desktop', 'laptop', 'mobile', 'server', 'other') NOT NULL
+);
+
+DROP TABLE IF EXISTS subscription;
+CREATE TABLE subscription (
+    user_id INT REFERENCES user (user_ptr_id),
+    podcast_id INT REFERENCES podcast (id),
+    public TINYINT(1) NOT NULL DEFAULT 1,
+    PRIMARY KEY (user_id, podcast_id)
+);
+
+DROP TABLE IF EXISTS subscription_log;
+CREATE TABLE subscription_log (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    device_id INT REFERENCES device (id),
+    podcast_id INT REFERENCES podcast (id),
+    action TINYINT(1) NOT NULL,
+    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
+    UNIQUE (device_id, podcast_id, action, timestamp)
+);
+
+DROP TABLE IF EXISTS current_subscription;
+DROP VIEW IF EXISTS current_subscription;
+
+CREATE VIEW current_subscription AS
+	SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since FROM
+		(subscription_log a JOIN device b on a.device_id=b.id) JOIN user c on b.user_id=c.user_ptr_id
+			WHERE action='subscribe' 
+			AND NOT EXISTS (
+				SELECT id FROM subscription_log
+					WHERE action='unsubscribe'
+                    			AND device_id=a.device_id
+					AND podcast_id=a.podcast_id
+                    			AND timestamp > a.timestamp
+				);
+
+DROP TABLE IF EXISTS Error;
+CREATE TABLE Error (                                                                                                         
+          ErrorGID int(10) unsigned NOT NULL auto_increment,                                                                         
+          Message varchar(128) default NULL,                                                                                         
+          Created timestamp NOT NULL default CURRENT_TIMESTAMP,                                         
+          PRIMARY KEY (ErrorGID),                                                                                                   
+          UNIQUE KEY ERROR (Message));
+          
+DELIMITER $$
+DROP PROCEDURE IF EXISTS Fail $$
+CREATE PROCEDURE Fail(_Message VARCHAR(128))
+BEGIN
+  INSERT INTO Error (Message) VALUES (_Message);
+  INSERT INTO Error (Message) VALUES (_Message);
+END;$$
+DELIMITER ;
+
+DELIMITER //
+CREATE TRIGGER podcast_trig_url_unique BEFORE INSERT ON podcast
+FOR EACH ROW
+BEGIN
+	declare help_url varchar(3000);
+	set help_url = null;
+  
+   	SELECT a.url into help_url FROM podcast a where a.url=new.url;
+
+	IF help_url is not null THEN
+		call Fail('This URL already exists!');
+	END IF;
+
+END;//
+DELIMITER ;
+
+DROP TABLE IF EXISTS toplist;
+CREATE TABLE toplist (
+    	podcast_id INT PRIMARY KEY REFERENCES podcast (id),
+    	subscription_count INT NOT NULL DEFAULT 0,
+        INDEX(podcast_id)
+);
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_toplist $$
+CREATE PROCEDURE update_toplist()
+BEGIN
+	DECLARE deadlock INT DEFAULT 0;
+    	DECLARE attempts INT DEFAULT 0;
+
+	try_loop:WHILE (attempts<3) DO
+	BEGIN
+		DECLARE deadlock_detected CONDITION FOR 1213;
+    		DECLARE EXIT HANDLER FOR deadlock_detected
+    			BEGIN
+    				ROLLBACK;
+    				SET deadlock=1;
+    			END;
+    		SET deadlock=0;
+   			
+    		START TRANSACTION;
+			DELETE FROM toplist;
+			INSERT INTO toplist (SELECT a.podcast_id, count(a.podcast_id) as count_subscription 
+				FROM current_subscription a, user b 
+				WHERE b.user_ptr_id = a.user_id
+				AND b.public_profile = 1
+				AND NOT EXISTS (SELECT * FROM subscription 
+							WHERE a.podcast_id=podcast_id
+							AND a.user_id=user_id
+							AND public = 0)
+				AND a.device_id = (SELECT min(device_id) FROM current_subscription 
+								WHERE a.podcast_id=podcast_id
+								AND a.user_id=user_id)
+				group by a.podcast_id order by count_subscription DESC);
+			
+			COMMIT;
+		END;
+		IF deadlock=0 THEN
+    			LEAVE try_loop;
+    		ELSE
+    			SET attempts=attempts+1;
+    		END IF;
+    	END WHILE try_loop;
+
+	IF deadlock=1 THEN
+		call FAIL('Toplist is not updated!');
+	END IF;
+
+END $$
+DELIMITER ;
+
+DELIMITER //
+CREATE TRIGGER subscription_log_trigger BEFORE INSERT ON subscription_log
+FOR EACH ROW
+BEGIN
+	declare help_id INT;
+	set help_id = null;
+
+   	SELECT a.user_id into help_id FROM current_subscription a 
+			where a.device_id = new.device_id
+			and a.podcast_id = new.podcast_id;
+
+	IF new.action = 'subscribe' THEN
+    		IF help_id is not null THEN
+			call Fail('This subscription already exists!');
+		END IF;
+    	ELSE
+    		IF help_id is null THEN
+			call Fail('This subscription not exists!');
+		END IF;
+    	END IF;
+
+END;//
+DELIMITER ;
+
+
+

commit 7547b91528969900e5d2744393e02dba82664db7
Author: Thomas Perl <thp@thpinfo.com>
Date:   Tue Nov 24 23:40:48 2009 +0100

    Apply the GNU AGPLv3 to the code (bug 301)
    
    Added COPYING (AGPLv3) + AUTHORS files.

diff --git a/AUTHORS b/AUTHORS
new file mode 100644
index 0000000..7ec2fa2
--- /dev/null
+++ b/AUTHORS
@@ -0,0 +1,5 @@
+Stefan Kgl <stefan@skoegl.net>
+Thomas Perl <thp@thpinfo.com>
+Martin Wieser <wieser_martin@hotmail.de>
+Armin Mllner <armin.muellner@gmail.com>
+Alexander Duml <alexander.duml@gmail.com>
diff --git a/COPYING b/COPYING
new file mode 100644
index 0000000..dba13ed
--- /dev/null
+++ b/COPYING
@@ -0,0 +1,661 @@
+                    GNU AFFERO GENERAL PUBLIC LICENSE
+                       Version 3, 19 November 2007
+
+ Copyright (C) 2007 Free Software Foundation, Inc. <http://fsf.org/>
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+                            Preamble
+
+  The GNU Affero General Public License is a free, copyleft license for
+software and other kinds of works, specifically designed to ensure
+cooperation with the community in the case of network server software.
+
+  The licenses for most software and other practical works are designed
+to take away your freedom to share and change the works.  By contrast,
+our General Public Licenses are intended to guarantee your freedom to
+share and change all versions of a program--to make sure it remains free
+software for all its users.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+them if you wish), that you receive source code or can get it if you
+want it, that you can change the software or use pieces of it in new
+free programs, and that you know you can do these things.
+
+  Developers that use our General Public Licenses protect your rights
+with two steps: (1) assert copyright on the software, and (2) offer
+you this License which gives you legal permission to copy, distribute
+and/or modify the software.
+
+  A secondary benefit of defending all users' freedom is that
+improvements made in alternate versions of the program, if they
+receive widespread use, become available for other developers to
+incorporate.  Many developers of free software are heartened and
+encouraged by the resulting cooperation.  However, in the case of
+software used on network servers, this result may fail to come about.
+The GNU General Public License permits making a modified version and
+letting the public access it on a server without ever releasing its
+source code to the public.
+
+  The GNU Affero General Public License is designed specifically to
+ensure that, in such cases, the modified source code becomes available
+to the community.  It requires the operator of a network server to
+provide the source code of the modified version running there to the
+users of that server.  Therefore, public use of a modified version, on
+a publicly accessible server, gives the public access to the source
+code of the modified version.
+
+  An older license, called the Affero General Public License and
+published by Affero, was designed to accomplish similar goals.  This is
+a different license, not a version of the Affero GPL, but Affero has
+released a new version of the Affero GPL which permits relicensing under
+this license.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+                       TERMS AND CONDITIONS
+
+  0. Definitions.
+
+  "This License" refers to version 3 of the GNU Affero General Public License.
+
+  "Copyright" also means copyright-like laws that apply to other kinds of
+works, such as semiconductor masks.
+
+  "The Program" refers to any copyrightable work licensed under this
+License.  Each licensee is addressed as "you".  "Licensees" and
+"recipients" may be individuals or organizations.
+
+  To "modify" a work means to copy from or adapt all or part of the work
+in a fashion requiring copyright permission, other than the making of an
+exact copy.  The resulting work is called a "modified version" of the
+earlier work or a work "based on" the earlier work.
+
+  A "covered work" means either the unmodified Program or a work based
+on the Program.
+
+  To "propagate" a work means to do anything with it that, without
+permission, would make you directly or secondarily liable for
+infringement under applicable copyright law, except executing it on a
+computer or modifying a private copy.  Propagation includes copying,
+distribution (with or without modification), making available to the
+public, and in some countries other activities as well.
+
+  To "convey" a work means any kind of propagation that enables other
+parties to make or receive copies.  Mere interaction with a user through
+a computer network, with no transfer of a copy, is not conveying.
+
+  An interactive user interface displays "Appropriate Legal Notices"
+to the extent that it includes a convenient and prominently visible
+feature that (1) displays an appropriate copyright notice, and (2)
+tells the user that there is no warranty for the work (except to the
+extent that warranties are provided), that licensees may convey the
+work under this License, and how to view a copy of this License.  If
+the interface presents a list of user commands or options, such as a
+menu, a prominent item in the list meets this criterion.
+
+  1. Source Code.
+
+  The "source code" for a work means the preferred form of the work
+for making modifications to it.  "Object code" means any non-source
+form of a work.
+
+  A "Standard Interface" means an interface that either is an official
+standard defined by a recognized standards body, or, in the case of
+interfaces specified for a particular programming language, one that
+is widely used among developers working in that language.
+
+  The "System Libraries" of an executable work include anything, other
+than the work as a whole, that (a) is included in the normal form of
+packaging a Major Component, but which is not part of that Major
+Component, and (b) serves only to enable use of the work with that
+Major Component, or to implement a Standard Interface for which an
+implementation is available to the public in source code form.  A
+"Major Component", in this context, means a major essential component
+(kernel, window system, and so on) of the specific operating system
+(if any) on which the executable work runs, or a compiler used to
+produce the work, or an object code interpreter used to run it.
+
+  The "Corresponding Source" for a work in object code form means all
+the source code needed to generate, install, and (for an executable
+work) run the object code and to modify the work, including scripts to
+control those activities.  However, it does not include the work's
+System Libraries, or general-purpose tools or generally available free
+programs which are used unmodified in performing those activities but
+which are not part of the work.  For example, Corresponding Source
+includes interface definition files associated with source files for
+the work, and the source code for shared libraries and dynamically
+linked subprograms that the work is specifically designed to require,
+such as by intimate data communication or control flow between those
+subprograms and other parts of the work.
+
+  The Corresponding Source need not include anything that users
+can regenerate automatically from other parts of the Corresponding
+Source.
+
+  The Corresponding Source for a work in source code form is that
+same work.
+
+  2. Basic Permissions.
+
+  All rights granted under this License are granted for the term of
+copyright on the Program, and are irrevocable provided the stated
+conditions are met.  This License explicitly affirms your unlimited
+permission to run the unmodified Program.  The output from running a
+covered work is covered by this License only if the output, given its
+content, constitutes a covered work.  This License acknowledges your
+rights of fair use or other equivalent, as provided by copyright law.
+
+  You may make, run and propagate covered works that you do not
+convey, without conditions so long as your license otherwise remains
+in force.  You may convey covered works to others for the sole purpose
+of having them make modifications exclusively for you, or provide you
+with facilities for running those works, provided that you comply with
+the terms of this License in conveying all material for which you do
+not control copyright.  Those thus making or running the covered works
+for you must do so exclusively on your behalf, under your direction
+and control, on terms that prohibit them from making any copies of
+your copyrighted material outside their relationship with you.
+
+  Conveying under any other circumstances is permitted solely under
+the conditions stated below.  Sublicensing is not allowed; section 10
+makes it unnecessary.
+
+  3. Protecting Users' Legal Rights From Anti-Circumvention Law.
+
+  No covered work shall be deemed part of an effective technological
+measure under any applicable law fulfilling obligations under article
+11 of the WIPO copyright treaty adopted on 20 December 1996, or
+similar laws prohibiting or restricting circumvention of such
+measures.
+
+  When you convey a covered work, you waive any legal power to forbid
+circumvention of technological measures to the extent such circumvention
+is effected by exercising rights under this License with respect to
+the covered work, and you disclaim any intention to limit operation or
+modification of the work as a means of enforcing, against the work's
+users, your or third parties' legal rights to forbid circumvention of
+technological measures.
+
+  4. Conveying Verbatim Copies.
+
+  You may convey verbatim copies of the Program's source code as you
+receive it, in any medium, provided that you conspicuously and
+appropriately publish on each copy an appropriate copyright notice;
+keep intact all notices stating that this License and any
+non-permissive terms added in accord with section 7 apply to the code;
+keep intact all notices of the absence of any warranty; and give all
+recipients a copy of this License along with the Program.
+
+  You may charge any price or no price for each copy that you convey,
+and you may offer support or warranty protection for a fee.
+
+  5. Conveying Modified Source Versions.
+
+  You may convey a work based on the Program, or the modifications to
+produce it from the Program, in the form of source code under the
+terms of section 4, provided that you also meet all of these conditions:
+
+    a) The work must carry prominent notices stating that you modified
+    it, and giving a relevant date.
+
+    b) The work must carry prominent notices stating that it is
+    released under this License and any conditions added under section
+    7.  This requirement modifies the requirement in section 4 to
+    "keep intact all notices".
+
+    c) You must license the entire work, as a whole, under this
+    License to anyone who comes into possession of a copy.  This
+    License will therefore apply, along with any applicable section 7
+    additional terms, to the whole of the work, and all its parts,
+    regardless of how they are packaged.  This License gives no
+    permission to license the work in any other way, but it does not
+    invalidate such permission if you have separately received it.
+
+    d) If the work has interactive user interfaces, each must display
+    Appropriate Legal Notices; however, if the Program has interactive
+    interfaces that do not display Appropriate Legal Notices, your
+    work need not make them do so.
+
+  A compilation of a covered work with other separate and independent
+works, which are not by their nature extensions of the covered work,
+and which are not combined with it such as to form a larger program,
+in or on a volume of a storage or distribution medium, is called an
+"aggregate" if the compilation and its resulting copyright are not
+used to limit the access or legal rights of the compilation's users
+beyond what the individual works permit.  Inclusion of a covered work
+in an aggregate does not cause this License to apply to the other
+parts of the aggregate.
+
+  6. Conveying Non-Source Forms.
+
+  You may convey a covered work in object code form under the terms
+of sections 4 and 5, provided that you also convey the
+machine-readable Corresponding Source under the terms of this License,
+in one of these ways:
+
+    a) Convey the object code in, or embodied in, a physical product
+    (including a physical distribution medium), accompanied by the
+    Corresponding Source fixed on a durable physical medium
+    customarily used for software interchange.
+
+    b) Convey the object code in, or embodied in, a physical product
+    (including a physical distribution medium), accompanied by a
+    written offer, valid for at least three years and valid for as
+    long as you offer spare parts or customer support for that product
+    model, to give anyone who possesses the object code either (1) a
+    copy of the Corresponding Source for all the software in the
+    product that is covered by this License, on a durable physical
+    medium customarily used for software interchange, for a price no
+    more than your reasonable cost of physically performing this
+    conveying of source, or (2) access to copy the
+    Corresponding Source from a network server at no charge.
+
+    c) Convey individual copies of the object code with a copy of the
+    written offer to provide the Corresponding Source.  This
+    alternative is allowed only occasionally and noncommercially, and
+    only if you received the object code with such an offer, in accord
+    with subsection 6b.
+
+    d) Convey the object code by offering access from a designated
+    place (gratis or for a charge), and offer equivalent access to the
+    Corresponding Source in the same way through the same place at no
+    further charge.  You need not require recipients to copy the
+    Corresponding Source along with the object code.  If the place to
+    copy the object code is a network server, the Corresponding Source
+    may be on a different server (operated by you or a third party)
+    that supports equivalent copying facilities, provided you maintain
+    clear directions next to the object code saying where to find the
+    Corresponding Source.  Regardless of what server hosts the
+    Corresponding Source, you remain obligated to ensure that it is
+    available for as long as needed to satisfy these requirements.
+
+    e) Convey the object code using peer-to-peer transmission, provided
+    you inform other peers where the object code and Corresponding
+    Source of the work are being offered to the general public at no
+    charge under subsection 6d.
+
+  A separable portion of the object code, whose source code is excluded
+from the Corresponding Source as a System Library, need not be
+included in conveying the object code work.
+
+  A "User Product" is either (1) a "consumer product", which means any
+tangible personal property which is normally used for personal, family,
+or household purposes, or (2) anything designed or sold for incorporation
+into a dwelling.  In determining whether a product is a consumer product,
+doubtful cases shall be resolved in favor of coverage.  For a particular
+product received by a particular user, "normally used" refers to a
+typical or common use of that class of product, regardless of the status
+of the particular user or of the way in which the particular user
+actually uses, or expects or is expected to use, the product.  A product
+is a consumer product regardless of whether the product has substantial
+commercial, industrial or non-consumer uses, unless such uses represent
+the only significant mode of use of the product.
+
+  "Installation Information" for a User Product means any methods,
+procedures, authorization keys, or other information required to install
+and execute modified versions of a covered work in that User Product from
+a modified version of its Corresponding Source.  The information must
+suffice to ensure that the continued functioning of the modified object
+code is in no case prevented or interfered with solely because
+modification has been made.
+
+  If you convey an object code work under this section in, or with, or
+specifically for use in, a User Product, and the conveying occurs as
+part of a transaction in which the right of possession and use of the
+User Product is transferred to the recipient in perpetuity or for a
+fixed term (regardless of how the transaction is characterized), the
+Corresponding Source conveyed under this section must be accompanied
+by the Installation Information.  But this requirement does not apply
+if neither you nor any third party retains the ability to install
+modified object code on the User Product (for example, the work has
+been installed in ROM).
+
+  The requirement to provide Installation Information does not include a
+requirement to continue to provide support service, warranty, or updates
+for a work that has been modified or installed by the recipient, or for
+the User Product in which it has been modified or installed.  Access to a
+network may be denied when the modification itself materially and
+adversely affects the operation of the network or violates the rules and
+protocols for communication across the network.
+
+  Corresponding Source conveyed, and Installation Information provided,
+in accord with this section must be in a format that is publicly
+documented (and with an implementation available to the public in
+source code form), and must require no special password or key for
+unpacking, reading or copying.
+
+  7. Additional Terms.
+
+  "Additional permissions" are terms that supplement the terms of this
+License by making exceptions from one or more of its conditions.
+Additional permissions that are applicable to the entire Program shall
+be treated as though they were included in this License, to the extent
+that they are valid under applicable law.  If additional permissions
+apply only to part of the Program, that part may be used separately
+under those permissions, but the entire Program remains governed by
+this License without regard to the additional permissions.
+
+  When you convey a copy of a covered work, you may at your option
+remove any additional permissions from that copy, or from any part of
+it.  (Additional permissions may be written to require their own
+removal in certain cases when you modify the work.)  You may place
+additional permissions on material, added by you to a covered work,
+for which you have or can give appropriate copyright permission.
+
+  Notwithstanding any other provision of this License, for material you
+add to a covered work, you may (if authorized by the copyright holders of
+that material) supplement the terms of this License with terms:
+
+    a) Disclaiming warranty or limiting liability differently from the
+    terms of sections 15 and 16 of this License; or
+
+    b) Requiring preservation of specified reasonable legal notices or
+    author attributions in that material or in the Appropriate Legal
+    Notices displayed by works containing it; or
+
+    c) Prohibiting misrepresentation of the origin of that material, or
+    requiring that modified versions of such material be marked in
+    reasonable ways as different from the original version; or
+
+    d) Limiting the use for publicity purposes of names of licensors or
+    authors of the material; or
+
+    e) Declining to grant rights under trademark law for use of some
+    trade names, trademarks, or service marks; or
+
+    f) Requiring indemnification of licensors and authors of that
+    material by anyone who conveys the material (or modified versions of
+    it) with contractual assumptions of liability to the recipient, for
+    any liability that these contractual assumptions directly impose on
+    those licensors and authors.
+
+  All other non-permissive additional terms are considered "further
+restrictions" within the meaning of section 10.  If the Program as you
+received it, or any part of it, contains a notice stating that it is
+governed by this License along with a term that is a further
+restriction, you may remove that term.  If a license document contains
+a further restriction but permits relicensing or conveying under this
+License, you may add to a covered work material governed by the terms
+of that license document, provided that the further restriction does
+not survive such relicensing or conveying.
+
+  If you add terms to a covered work in accord with this section, you
+must place, in the relevant source files, a statement of the
+additional terms that apply to those files, or a notice indicating
+where to find the applicable terms.
+
+  Additional terms, permissive or non-permissive, may be stated in the
+form of a separately written license, or stated as exceptions;
+the above requirements apply either way.
+
+  8. Termination.
+
+  You may not propagate or modify a covered work except as expressly
+provided under this License.  Any attempt otherwise to propagate or
+modify it is void, and will automatically terminate your rights under
+this License (including any patent licenses granted under the third
+paragraph of section 11).
+
+  However, if you cease all violation of this License, then your
+license from a particular copyright holder is reinstated (a)
+provisionally, unless and until the copyright holder explicitly and
+finally terminates your license, and (b) permanently, if the copyright
+holder fails to notify you of the violation by some reasonable means
+prior to 60 days after the cessation.
+
+  Moreover, your license from a particular copyright holder is
+reinstated permanently if the copyright holder notifies you of the
+violation by some reasonable means, this is the first time you have
+received notice of violation of this License (for any work) from that
+copyright holder, and you cure the violation prior to 30 days after
+your receipt of the notice.
+
+  Termination of your rights under this section does not terminate the
+licenses of parties who have received copies or rights from you under
+this License.  If your rights have been terminated and not permanently
+reinstated, you do not qualify to receive new licenses for the same
+material under section 10.
+
+  9. Acceptance Not Required for Having Copies.
+
+  You are not required to accept this License in order to receive or
+run a copy of the Program.  Ancillary propagation of a covered work
+occurring solely as a consequence of using peer-to-peer transmission
+to receive a copy likewise does not require acceptance.  However,
+nothing other than this License grants you permission to propagate or
+modify any covered work.  These actions infringe copyright if you do
+not accept this License.  Therefore, by modifying or propagating a
+covered work, you indicate your acceptance of this License to do so.
+
+  10. Automatic Licensing of Downstream Recipients.
+
+  Each time you convey a covered work, the recipient automatically
+receives a license from the original licensors, to run, modify and
+propagate that work, subject to this License.  You are not responsible
+for enforcing compliance by third parties with this License.
+
+  An "entity transaction" is a transaction transferring control of an
+organization, or substantially all assets of one, or subdividing an
+organization, or merging organizations.  If propagation of a covered
+work results from an entity transaction, each party to that
+transaction who receives a copy of the work also receives whatever
+licenses to the work the party's predecessor in interest had or could
+give under the previous paragraph, plus a right to possession of the
+Corresponding Source of the work from the predecessor in interest, if
+the predecessor has it or can get it with reasonable efforts.
+
+  You may not impose any further restrictions on the exercise of the
+rights granted or affirmed under this License.  For example, you may
+not impose a license fee, royalty, or other charge for exercise of
+rights granted under this License, and you may not initiate litigation
+(including a cross-claim or counterclaim in a lawsuit) alleging that
+any patent claim is infringed by making, using, selling, offering for
+sale, or importing the Program or any portion of it.
+
+  11. Patents.
+
+  A "contributor" is a copyright holder who authorizes use under this
+License of the Program or a work on which the Program is based.  The
+work thus licensed is called the contributor's "contributor version".
+
+  A contributor's "essential patent claims" are all patent claims
+owned or controlled by the contributor, whether already acquired or
+hereafter acquired, that would be infringed by some manner, permitted
+by this License, of making, using, or selling its contributor version,
+but do not include claims that would be infringed only as a
+consequence of further modification of the contributor version.  For
+purposes of this definition, "control" includes the right to grant
+patent sublicenses in a manner consistent with the requirements of
+this License.
+
+  Each contributor grants you a non-exclusive, worldwide, royalty-free
+patent license under the contributor's essential patent claims, to
+make, use, sell, offer for sale, import and otherwise run, modify and
+propagate the contents of its contributor version.
+
+  In the following three paragraphs, a "patent license" is any express
+agreement or commitment, however denominated, not to enforce a patent
+(such as an express permission to practice a patent or covenant not to
+sue for patent infringement).  To "grant" such a patent license to a
+party means to make such an agreement or commitment not to enforce a
+patent against the party.
+
+  If you convey a covered work, knowingly relying on a patent license,
+and the Corresponding Source of the work is not available for anyone
+to copy, free of charge and under the terms of this License, through a
+publicly available network server or other readily accessible means,
+then you must either (1) cause the Corresponding Source to be so
+available, or (2) arrange to deprive yourself of the benefit of the
+patent license for this particular work, or (3) arrange, in a manner
+consistent with the requirements of this License, to extend the patent
+license to downstream recipients.  "Knowingly relying" means you have
+actual knowledge that, but for the patent license, your conveying the
+covered work in a country, or your recipient's use of the covered work
+in a country, would infringe one or more identifiable patents in that
+country that you have reason to believe are valid.
+
+  If, pursuant to or in connection with a single transaction or
+arrangement, you convey, or propagate by procuring conveyance of, a
+covered work, and grant a patent license to some of the parties
+receiving the covered work authorizing them to use, propagate, modify
+or convey a specific copy of the covered work, then the patent license
+you grant is automatically extended to all recipients of the covered
+work and works based on it.
+
+  A patent license is "discriminatory" if it does not include within
+the scope of its coverage, prohibits the exercise of, or is
+conditioned on the non-exercise of one or more of the rights that are
+specifically granted under this License.  You may not convey a covered
+work if you are a party to an arrangement with a third party that is
+in the business of distributing software, under which you make payment
+to the third party based on the extent of your activity of conveying
+the work, and under which the third party grants, to any of the
+parties who would receive the covered work from you, a discriminatory
+patent license (a) in connection with copies of the covered work
+conveyed by you (or copies made from those copies), or (b) primarily
+for and in connection with specific products or compilations that
+contain the covered work, unless you entered into that arrangement,
+or that patent license was granted, prior to 28 March 2007.
+
+  Nothing in this License shall be construed as excluding or limiting
+any implied license or other defenses to infringement that may
+otherwise be available to you under applicable patent law.
+
+  12. No Surrender of Others' Freedom.
+
+  If conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot convey a
+covered work so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you may
+not convey it at all.  For example, if you agree to terms that obligate you
+to collect a royalty for further conveying from those to whom you convey
+the Program, the only way you could satisfy both those terms and this
+License would be to refrain entirely from conveying the Program.
+
+  13. Remote Network Interaction; Use with the GNU General Public License.
+
+  Notwithstanding any other provision of this License, if you modify the
+Program, your modified version must prominently offer all users
+interacting with it remotely through a computer network (if your version
+supports such interaction) an opportunity to receive the Corresponding
+Source of your version by providing access to the Corresponding Source
+from a network server at no charge, through some standard or customary
+means of facilitating copying of software.  This Corresponding Source
+shall include the Corresponding Source for any work covered by version 3
+of the GNU General Public License that is incorporated pursuant to the
+following paragraph.
+
+  Notwithstanding any other provision of this License, you have
+permission to link or combine any covered work with a work licensed
+under version 3 of the GNU General Public License into a single
+combined work, and to convey the resulting work.  The terms of this
+License will continue to apply to the part which is the covered work,
+but the work with which it is combined will remain governed by version
+3 of the GNU General Public License.
+
+  14. Revised Versions of this License.
+
+  The Free Software Foundation may publish revised and/or new versions of
+the GNU Affero General Public License from time to time.  Such new versions
+will be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+  Each version is given a distinguishing version number.  If the
+Program specifies that a certain numbered version of the GNU Affero General
+Public License "or any later version" applies to it, you have the
+option of following the terms and conditions either of that numbered
+version or of any later version published by the Free Software
+Foundation.  If the Program does not specify a version number of the
+GNU Affero General Public License, you may choose any version ever published
+by the Free Software Foundation.
+
+  If the Program specifies that a proxy can decide which future
+versions of the GNU Affero General Public License can be used, that proxy's
+public statement of acceptance of a version permanently authorizes you
+to choose that version for the Program.
+
+  Later license versions may give you additional or different
+permissions.  However, no additional obligations are imposed on any
+author or copyright holder as a result of your choosing to follow a
+later version.
+
+  15. Disclaimer of Warranty.
+
+  THERE IS NO WARRANTY FOR THE PROGRAM, TO THE EXTENT PERMITTED BY
+APPLICABLE LAW.  EXCEPT WHEN OTHERWISE STATED IN WRITING THE COPYRIGHT
+HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY
+OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING, BUT NOT LIMITED TO,
+THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
+PURPOSE.  THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE PROGRAM
+IS WITH YOU.  SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
+ALL NECESSARY SERVICING, REPAIR OR CORRECTION.
+
+  16. Limitation of Liability.
+
+  IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MODIFIES AND/OR CONVEYS
+THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
+GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE
+USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF
+DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD
+PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS),
+EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF
+SUCH DAMAGES.
+
+  17. Interpretation of Sections 15 and 16.
+
+  If the disclaimer of warranty and limitation of liability provided
+above cannot be given local legal effect according to their terms,
+reviewing courts shall apply local law that most closely approximates
+an absolute waiver of all civil liability in connection with the
+Program, unless a warranty or assumption of liability accompanies a
+copy of the Program in return for a fee.
+
+                     END OF TERMS AND CONDITIONS
+
+            How to Apply These Terms to Your New Programs
+
+  If you develop a new program, and you want it to be of the greatest
+possible use to the public, the best way to achieve this is to make it
+free software which everyone can redistribute and change under these terms.
+
+  To do so, attach the following notices to the program.  It is safest
+to attach them to the start of each source file to most effectively
+state the exclusion of warranty; and each file should have at least
+the "copyright" line and a pointer to where the full notice is found.
+
+    <one line to give the program's name and a brief idea of what it does.>
+    Copyright (C) <year>  <name of author>
+
+    This program is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published by
+    the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <http://www.gnu.org/licenses/>.
+
+Also add information on how to contact you by electronic and paper mail.
+
+  If your software can interact with users remotely through a computer
+network, you should also make sure that it provides a way for users to
+get its source.  For example, if your program is a web application, its
+interface could display a "Source" link that leads users to an archive
+of the code.  There are many ways you could offer source, and different
+solutions will be better for different programs; see section 13 for the
+specific requirements.
+
+  You should also get your employer (if you work as a programmer) or school,
+if any, to sign a "copyright disclaimer" for the program, if necessary.
+For more information on this, and how to apply and follow the GNU AGPL, see
+<http://www.gnu.org/licenses/>.
diff --git a/mygpo.fcgi b/mygpo.fcgi
index 64d22ec..f36c031 100755
--- a/mygpo.fcgi
+++ b/mygpo.fcgi
@@ -1,6 +1,22 @@
 #!/usr/bin/python
 # -*- coding: utf-8 -*-
 # my.gpodder.org FastCGI handler for lighttpd (default setup)
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+
 
 import sys
 import os
diff --git a/mygpo.lighttpd.conf b/mygpo.lighttpd.conf
index 2170fc2..af55e33 100644
--- a/mygpo.lighttpd.conf
+++ b/mygpo.lighttpd.conf
@@ -1,6 +1,23 @@
 #
 # my.gpodder.org configuration file for lighttpd
 #
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+#
 # How to setup for lighttpd (on Debian):
 #   - Copy this file to /etc/lighttpd/
 #   - Edit var.mygpo_home and var.mygpo_domain below
diff --git a/mygpo/__init__.py b/mygpo/__init__.py
index e69de29..617b87b 100644
--- a/mygpo/__init__.py
+++ b/mygpo/__init__.py
@@ -0,0 +1,17 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
diff --git a/mygpo/api/__init__.py b/mygpo/api/__init__.py
index e69de29..cf69f1a 100644
--- a/mygpo/api/__init__.py
+++ b/mygpo/api/__init__.py
@@ -0,0 +1,18 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+
diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index c3850ca..633152a 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.contrib import admin
 from django import forms
 from django.contrib.auth.models import User
diff --git a/mygpo/api/basic_auth.py b/mygpo/api/basic_auth.py
index ecb054e..4fc379f 100644
--- a/mygpo/api/basic_auth.py
+++ b/mygpo/api/basic_auth.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 #from http://www.djangosnippets.org/snippets/243/
 import base64
 
diff --git a/mygpo/api/json.py b/mygpo/api/json.py
index 7f8fbc8..70fbd6f 100644
--- a/mygpo/api/json.py
+++ b/mygpo/api/json.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 #from http://www.djangosnippets.org/snippets/154/
 
 from django.core.serializers import json, serialize
diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 5d38677..abc0c18 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.http import HttpResponse
 from django.contrib.auth.models import User
 from mygpo.api.opml import Importer, Exporter
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index a6aa820..53ab196 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.db import models
 from django.contrib.auth.models import User, UserManager
 from datetime import datetime
diff --git a/mygpo/api/opml.py b/mygpo/api/opml.py
index 19e5b2b..d242f57 100644
--- a/mygpo/api/opml.py
+++ b/mygpo/api/opml.py
@@ -1,6 +1,22 @@
 # -*- coding: utf-8 -*-
 #
+# This file is part of my.gpodder.org.
 #
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+
 #
 #  based on: gPodder's opml.py (2007-08-19)
 #            libopmlreader.py (2006-06-13)
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index e0f14e2..4200029 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
 from mygpo.api.models import Device
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 5f6478f..33f2dbb 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.test import TestCase
 from django.contrib.auth.models import User
 from mygpo.api.models import Device, Podcast, SubscriptionAction
diff --git a/mygpo/api/util.py b/mygpo/api/util.py
index 3414ae8..31cf956 100644
--- a/mygpo/api/util.py
+++ b/mygpo/api/util.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 def get_free_disk_space(path):
     """
     Calculates the free disk space available to the current user
diff --git a/mygpo/api/views.py b/mygpo/api/views.py
index 60f00ef..2d20fd4 100644
--- a/mygpo/api/views.py
+++ b/mygpo/api/views.py
@@ -1 +1,18 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 # Create your views here.
diff --git a/mygpo/auth_backends.py b/mygpo/auth_backends.py
index 8f483fd..3a7c2bd 100644
--- a/mygpo/auth_backends.py
+++ b/mygpo/auth_backends.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.conf import settings
 from django.contrib.auth.models import User
 from django.contrib.auth.backends import ModelBackend
diff --git a/mygpo/manage.py b/mygpo/manage.py
index bcdd55e..74d6b5e 100755
--- a/mygpo/manage.py
+++ b/mygpo/manage.py
@@ -1,4 +1,22 @@
 #!/usr/bin/python
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+
 from django.core.management import execute_manager
 try:
     import settings # Assumed to be in the same directory.
diff --git a/mygpo/settings.py b/mygpo/settings.py
index 4e923ae..b057e2a 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -1,4 +1,20 @@
 # Django settings for mygpo project.
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
 
 import os.path
 
diff --git a/mygpo/urls.py b/mygpo/urls.py
index b43ee25..230107d 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -1,3 +1,21 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
+
 import os.path
 from django.conf.urls.defaults import *
 from registration.views import activate, register
diff --git a/mygpo/web/__init__.py b/mygpo/web/__init__.py
index e69de29..617b87b 100644
--- a/mygpo/web/__init__.py
+++ b/mygpo/web/__init__.py
@@ -0,0 +1,17 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
diff --git a/mygpo/web/models.py b/mygpo/web/models.py
index 71a8362..5d1aa0c 100644
--- a/mygpo/web/models.py
+++ b/mygpo/web/models.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.db import models
 
 # Create your models here.
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 2d8add5..8b81a38 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -1,5 +1,22 @@
 <html><head>
-
+<!--
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+-->
   <title>{% block title %}{% endblock %}my.gPodder.org</title>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <link rel="shortcut icon" href="http://gpodder.org/favicon.png">
diff --git a/mygpo/web/tests.py b/mygpo/web/tests.py
index 2247054..66e97fc 100644
--- a/mygpo/web/tests.py
+++ b/mygpo/web/tests.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 """
 This file demonstrates two different styles of tests (one doctest and one
 unittest). These will both pass when you run "manage.py test".
diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 1984e30..2e0e768 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index d226bfe..8f5386e 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -1,3 +1,20 @@
+#
+# This file is part of my.gpodder.org.
+#
+# my.gpodder.org is free software: you can redistribute it and/or modify it
+# under the terms of the GNU Affero General Public License as published by
+# the Free Software Foundation, either version 3 of the License, or (at your
+# option) any later version.
+#
+# my.gpodder.org is distributed in the hope that it will be useful, but
+# WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
+# or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Affero General Public
+# License for more details.
+#
+# You should have received a copy of the GNU Affero General Public License
+# along with my.gpodder.org. If not, see <http://www.gnu.org/licenses/>.
+#
+
 from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout

commit 3c67f4a32a0389b6695086ef3538b3df7203a4eb
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Tue Nov 24 16:23:32 2009 +0100

    update-04
    
    the toplist is now generated in a other table

diff --git a/install/update-04.sql b/install/update-04.sql
new file mode 100644
index 0000000..4e665bc
--- /dev/null
+++ b/install/update-04.sql
@@ -0,0 +1,50 @@
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_toplist $$
+CREATE PROCEDURE update_toplist()
+BEGIN
+	DECLARE deadlock INT DEFAULT 0;
+    	DECLARE attempts INT DEFAULT 0;
+
+	DROP TABLE IF EXISTS toplist_temp;
+	CREATE TABLE toplist_temp (
+    		podcast_id INT PRIMARY KEY REFERENCES podcast (id),
+    		subscription_count INT NOT NULL DEFAULT 0,
+        	INDEX(podcast_id)
+	);
+
+	try_loop:WHILE (attempts<3) DO
+	BEGIN
+		DECLARE deadlock_detected CONDITION FOR 1213;
+    		DECLARE EXIT HANDLER FOR deadlock_detected
+    			BEGIN
+    				ROLLBACK;
+    				SET deadlock=1;
+    			END;
+    		SET deadlock=0;
+   			
+    		START TRANSACTION;
+			DELETE FROM toplist_temp;
+			INSERT INTO toplist_temp (SELECT a.podcast_id, COUNT(*) AS count_subscription
+						FROM (SELECT DISTINCT podcast_id, user_id 
+							FROM public_subscription) a 
+						GROUP BY podcast_id);
+			DELETE FROM toplist;
+			INSERT INTO toplist (SELECT podcast_id, subscription_count FROM toplist_temp
+						ORDER BY subscription_count DESC LIMIT 100);
+			
+			COMMIT;
+		END;
+		IF deadlock=0 THEN
+    			LEAVE try_loop;
+    		ELSE
+    			SET attempts=attempts+1;
+    		END IF;
+    		END WHILE try_loop;
+
+		IF deadlock=1 THEN
+			call FAIL('Toplist is not updated!');
+		END IF;
+		DROP TABLE IF EXISTS toplist_temp;
+
+END $$
+DELIMITER ;

commit 80d5751cceb966fafe7ba8291824529797da053f
Merge: 5d1324c... 4e97003...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Mon Nov 23 16:05:12 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit f84272d72edabe940977cd921fde995d85b650a0
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Mon Nov 23 15:31:31 2009 +0100

    	modified:   simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index e0f14e2..99afb9a 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -1,8 +1,9 @@
 from mygpo.api.basic_auth import require_valid_user
-from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
+from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden, Http404
 from mygpo.api.models import Device
 from mygpo.api.opml import Exporter
 from mygpo.api.json import JsonResponse
+from django.core import serializers
 
 @require_valid_user()
 def subscriptions(request, username, device_uid, format):
@@ -14,8 +15,7 @@ def subscriptions(request, username, device_uid, format):
         return format_subscriptions(get_subscriptions(username, device_uid), format)
         
     elif request.method == 'PUT':
-	return request.raw_post_data
-        #return set_subscriptions(device_uid, parse_subscription(request.raw_post_data, format))
+        return set_subscriptions(device_uid, parse_subscription(request.raw_post_data, format))
 
     else:
         return HttpResponseBadReqest()
@@ -32,12 +32,16 @@ def format_subscriptions(subscriptions, format):
         return HttpResponse(Exporter().generate(subscriptions), mimetype='text/xml')
     
     elif format == 'json':
-	urls = [p.url for p in subscriptions]
-        return JsonResponse(urls)
+	json_serializer = serializers.get_serializer("json")()
+	p = json_serializer.serialize(subscriptions, ensure_ascii=False, fields=('title', 'description', 'url'))
+        return JsonResponse(p)
 
 def get_subscriptions(username, device_uid):
     #get and return subscription list from database (use backend to sync)
-    d = Device.objects.get(uid=device_uid, user__username=username)
+    try:
+    	d = Device.objects.get(uid=device_uid, user__username=username)
+    except Device.DoesNotExist:
+	raise Http404
     return [p.podcast for p in d.get_subscriptions()]
 
 def parse_subscription(raw_post_data, format):

commit 4e97003a9d645a27d150d912b54dddcd130b4a2d
Merge: 7e71837... 99a8f47...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 22 14:21:41 2009 +0100

    Merge branch 'master' of dgpo:~thp/mygpo-src

commit 99a8f47e8cab536f8ff99c78a2d340f16de579f8
Author: Thomas Perl <thp@thpinfo.com>
Date:   Sun Nov 22 14:17:09 2009 +0100

    Disable syncing subscription lists
    
    For now, we don't sync subscription lists,
    as this takes too long time (according to
    stefankoegl).

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index b1da76e..3d576bf 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -92,7 +92,7 @@ class Device(models.Model):
         return '%s (%s)' % (self.name, self.type)
 
     def get_subscriptions(self):
-        self.sync()
+        #self.sync()
         return Subscription.objects.filter(device=self)
 
     def sync(self):

commit 95428dbd56ca6e0e206c4f42b7e2887aeec7aef1
Author: Thomas Perl <thp@thpinfo.com>
Date:   Sun Nov 22 14:15:46 2009 +0100

    Fix problems with the DB migration
    
    Drop tables/views to correctly install
    the database scheme.

diff --git a/install/crate-database.sql b/install/crate-database.sql
index 43bd126..863056c 100644
--- a/install/crate-database.sql
+++ b/install/crate-database.sql
@@ -64,6 +64,7 @@ CREATE TABLE subscription_log (
     UNIQUE (device_id, podcast_id, action, timestamp)
 );
 
+DROP TABLE IF EXISTS current_subscription;
 DROP VIEW IF EXISTS current_subscription;
 
 CREATE VIEW current_subscription AS
diff --git a/install/update-02.sql b/install/update-02.sql
index 1eb380c..95efe63 100644
--- a/install/update-02.sql
+++ b/install/update-02.sql
@@ -10,6 +10,7 @@ ALTER TABLE device ADD COLUMN sync_group_id INT REFERENCES sync_group(id);
 ALTER TABLE device ADD COLUMN `uid` varchar(50) NOT NULL;
 
 -- selects the latest action for each pair (device_id, podcast_id) --
+DROP TABLE IF EXISTS sync_group_subscription_log;
 DROP VIEW IF EXISTS sync_group_subscription_log;
 CREATE VIEW sync_group_subscription_log AS
     SELECT subscription_log.id AS id, device_id, podcast_id, action, timestamp, sync_group_id

commit 7e71837e0a66bfb19b7d4420a187ad02aa89e956
Merge: 5f3e3f2... 6b27405...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 21 20:57:58 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit 5f3e3f2e4f7398adc54ad1efe712c5c32f92faad
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 21 20:57:32 2009 +0100

    added indexes to tables

diff --git a/install/update-03.sql b/install/update-03.sql
index 5c30281..528dda6 100644
--- a/install/update-03.sql
+++ b/install/update-03.sql
@@ -109,3 +109,27 @@ CREATE VIEW current_subscription AS SELECT device_id, podcast_id, c.user_ptr_id
     GROUP BY a.podcast_id, b.user_id 
     having summe>0;
 
+
+-- podcast
+create index url_index on podcast ( url (50) );
+create index title_index on podcast ( title (50) );
+create index last_update_index on podcast (last_update);
+
+-- user
+create index user_ptr_index on user (user_ptr_id);
+create index public_profile_index on user (public_profile);
+
+-- device
+create index name_index on device (name);
+create index user_index on device (user_id);
+create index type_index on device (type);
+create index uid_index on device (uid);
+create index sync_g_index on device (sync_group_id);
+
+-- subscription_log
+create index podcast_index on subscription_log(podcast_id);
+create index action_index on subscription_log(action);
+create index timestamp_index on subscription_log(timestamp);
+create index device_index on subscription_log(device_id);
+
+

commit 6b2740570c9d396d85f504f0554d99098a35925e
Merge: 2fb006d... 06492e0...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 21 20:50:59 2009 +0100

    Merge branch 'master' of /home/stefan/mygpo-src

commit 2fb006d0067636c5d057080d43cfeedb24d7c7ca
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 21 20:50:16 2009 +0100

    temporarily disabled unused syncing

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index b1da76e..3d576bf 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -92,7 +92,7 @@ class Device(models.Model):
         return '%s (%s)' % (self.name, self.type)
 
     def get_subscriptions(self):
-        self.sync()
+        #self.sync()
         return Subscription.objects.filter(device=self)
 
     def sync(self):

commit 06492e0fcf3ea31649807a1b4e1784ca7ef03653
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 21 19:35:53 2009 +0100

    showing owner's name in Device.__unicode__()

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index b1da76e..7f2106b 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -89,7 +89,7 @@ class Device(models.Model):
     sync_group = models.ForeignKey(SyncGroup, blank=True, null=True)
 
     def __unicode__(self):
-        return '%s (%s)' % (self.name, self.type)
+        return '%s - %s (%s)' % (self.user, self.name, self.type)
 
     def get_subscriptions(self):
         self.sync()

commit 726ff61a70cf7c9a7c8aca3b59b2c30b0e0b2bf6
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 21 16:33:30 2009 +0100

    create missing profile during login

diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 44036f9..1984e30 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -7,6 +7,7 @@ from django.template.defaultfilters import slugify
 from registration.forms import RegistrationForm
 from registration.views import activate, register
 from registration.models import RegistrationProfile
+from mygpo.api.models import UserProfile
 
 def login_user(request):
        try:
@@ -19,10 +20,15 @@ def login_user(request):
        if user is not None:
               login(request, user)
 
-              if user.get_profile().generated_id:
-                     return render_to_response('migrate.html', {
+              try:
+                  if user.get_profile().generated_id:
+                      return render_to_response('migrate.html', {
                            'username': user
-                     })
+                      })
+              except UserProfile.DoesNotExist:
+                  UserProfile.objects.create(user=user)
+                  return HttpResponseRedirect('/')
+
               else:
                   return HttpResponseRedirect('/')
 

commit 7bb2e1ee94b4f07e15b7db4f36f5ba07ae088105
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 23:31:03 2009 +0100

    fix wrong parameter name in user activation

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 2dc1477..b43ee25 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -17,7 +17,7 @@ urlpatterns = patterns('',
     (r'^migrate/$', 'mygpo.web.users.migrate_user'),
     (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/' }),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
-    (r'^activate/(?P<key>\w+)$', activate),
+    (r'^activate/(?P<activation_key>\w+)$', activate),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     (r'^upload$', 'mygpo.api.legacy.upload'),

commit e3f4d6caf84e545503f4716c8016f2ca9a38b580
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 23:26:38 2009 +0100

    some small gui fixes

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
index 848c754..159a3bb 100644
--- a/htdocs/media/screen.css
+++ b/htdocs/media/screen.css
@@ -5,3 +5,10 @@ div.error
     font-weight: bold;
     color: #c20000;
 }
+
+table.register th {
+    font-weight:normal;
+    width:150px;
+    text-align:left;
+}
+
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 2189697..2d8add5 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -42,12 +42,6 @@
             content: '';
             padding-left: 0px;
         }
-
-		table.register th {
-			font-weight:normal;
-			width:150px;
-			text-align:left;
-		}
     </style>
 </head><body>
 <h1 style="margin: 0px; padding: 0px; position: absolute; top: 0px; left: 20px; height: 70px; z-index: 100;">
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index d9b6250..460d33d 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -7,7 +7,7 @@
 
    <h2>Login</h2>
    <form action="../login/" method="post">
-    Username:<br />
+    Username or Email-Address:<br />
     <input name="user" type="text" style="width:90%;"/><br />
     Password:<br />
     <input name="pwd" type="password" style="width:90%;" /><br />
diff --git a/mygpo/web/templates/login.html b/mygpo/web/templates/login.html
index 7d5cb96..ad4f45a 100644
--- a/mygpo/web/templates/login.html
+++ b/mygpo/web/templates/login.html
@@ -3,7 +3,7 @@
 {% block content %}
   <h1>Login</h1>
    <form action="../login/" method="post">
-    Username:<br />
+    Username or Email-Address:<br />
     <input name="user" type="text" style="width:90%;"/><br />
     Password:<br />
     <input name="pwd" type="password" style="width:90%;" /><br />

commit 54f1d2cb1469ee7d559e47e00c077505a38edd92
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 23:26:05 2009 +0100

    allowing only slug usernames for registration

diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 2f1826f..44036f9 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -3,6 +3,7 @@ from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
 from django.contrib.auth.models import User
 from django.contrib.auth.decorators import login_required
+from django.template.defaultfilters import slugify
 from registration.forms import RegistrationForm
 from registration.views import activate, register
 from registration.models import RegistrationProfile
@@ -40,7 +41,9 @@ def migrate_user(request):
 
     if user.username != username:
         if User.objects.filter(username__exact=username).count() > 0:
-            return render_to_response('migrate.html', {'error': True, 'error_message': '%s is already taken' % username, 'username': user.username})
+            return render_to_response('migrate.html', {'error_message': '%s is already taken' % username, 'username': user.username})
+        if slugify(username) != username:
+            return render_to_response('migrate.html', {'error_message': '%s is not a valid username. Please use characters, numbers, underscore and dash only.' % username, 'username': user.username})
         else:
             user.username = username
             user.save()

commit 2fcd8c2659e0c9237c16e3a524b7fcd61a1ba30f
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 23:07:14 2009 +0100

    preventing user from using emtpy username

diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 351eef0..2f1826f 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -34,6 +34,10 @@ def login_user(request):
 def migrate_user(request):
     user = request.user
     username = request.POST.get('username', user.username)
+
+    if username == '':
+        username = user.username
+
     if user.username != username:
         if User.objects.filter(username__exact=username).count() > 0:
             return render_to_response('migrate.html', {'error': True, 'error_message': '%s is already taken' % username, 'username': user.username})

commit 3414a17ccfa3f60642f7be66e1352ea56cd209c3
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 22:53:17 2009 +0100

    style changes, simplified code
    
    lots of unrelated changes

diff --git a/htdocs/media/screen.css b/htdocs/media/screen.css
new file mode 100644
index 0000000..848c754
--- /dev/null
+++ b/htdocs/media/screen.css
@@ -0,0 +1,7 @@
+div.error
+{
+    border: thin solid: #7d0c0c;
+    padding: 2em;
+    font-weight: bold;
+    color: #c20000;
+}
diff --git a/mygpo/settings.py b/mygpo/settings.py
index 1dc74f8..4e923ae 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -99,3 +99,5 @@ DEFAULT_FROM_EMAIL = 'mygpo@my.gpodder.org'
 
 AUTH_PROFILE_MODULE = "api.UserProfile"
 
+LOGIN_URL = '/login/'
+
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 7fb7ffc..2dc1477 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -2,6 +2,7 @@ import os.path
 from django.conf.urls.defaults import *
 from registration.views import activate, register
 from mygpo.api.models import UserProfile
+from django.contrib.auth.views import logout
 
 # Uncomment the next two lines to enable the admin:
 from django.contrib import admin
@@ -12,7 +13,7 @@ urlpatterns = patterns('',
     # (r'^mygpo/', include('mygpo.foo.urls')),
     (r'^$', 'mygpo.web.views.home'),
     (r'^login/$', 'mygpo.web.users.login_user'),
-    (r'^logout/$', 'mygpo.web.users.logout_user'),
+    (r'^logout/$', logout, {'next_page': '/'}),
     (r'^migrate/$', 'mygpo.web.users.migrate_user'),
     (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/' }),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 9e400f0..2189697 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -3,6 +3,7 @@
   <title>{% block title %}{% endblock %}my.gPodder.org</title>
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <link rel="shortcut icon" href="http://gpodder.org/favicon.png">
+  <link rel="stylesheet" href="/media/screen.css" type="text/css" />
   <style type="text/css">
       	body { font-family: DeJaVu Sans, Bitstream Vera Sans, sans-serif; font-size: 12px; padding-left: 50px; padding-right: 50px;}
 	h2 { margin-top:0px;}
@@ -41,7 +42,7 @@
             content: '';
             padding-left: 0px;
         }
-		
+
 		table.register th {
 			font-weight:normal;
 			width:150px;
@@ -63,7 +64,14 @@
 </ul>
 </div>
 <hr>
+
+
 <div style="margin-right: 5%; padding-top: 80px; padding-bottom: 10px; float:left;">
+
+{% if error_message %}
+ <div class="error">{{ error_message }}</div>
+{% endif %}
+
 {% block content %}
     <h1>gPodder Web Service</h1>
     <p>...will go online soon...</p>
@@ -76,27 +84,10 @@
 <div style="padding-top: 80px; width:200px; height:70%; margin-right:-58px; padding-bottom: 10px; float:right; background-color: rgb(102, 102, 102); -moz-border-radius-bottomleft: 30px;">
 	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; background-color:rgb(102, 102, 102);">&nbsp;</span>
 	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; -moz-border-radius-topright: 30px; background-color:rgb(255,255,255);">&nbsp;</span>
-	{% if error %}
-	 <p style="margin-top:-20px; margin-left:10px; color:rgb(210,105,30);">{{ error_message }}</p>
-	{% endif %}
-	{% if authenticated %}
-	<p style="margin-left:10px; color:rgb(70%,70%,70%);">logged in as {{ login_message }}<br />
-	<a href="../logout/">logout!</a>
+	{% if user.is_authenticated %}
+	<p style="margin-left:10px; color:rgb(70%,70%,70%);">logged in as {{ user.username }}<br />
+	<a href="/logout/">logout!</a>
 	</p>
-	{% else %}
-	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%); border:1px solid rgb(70%,70%,70%);">
-		<h2>Login</h2>
-		<form action="../login/" method="post">
-		Username:<br />
-		<input name="user" type="text" style="width:90%;"/><br />
-		Password:<br />
-		<input name="pwd" type="password" style="width:90%;" /><br />
-		<input type="submit" value="Login" style="margin-left:90px; margin-top:15px;" />
-		</form>
-	</div>
-	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%);">
-		Not yet a member? <a href="../register/">Register!</a>
-	</div>
 	{% endif %}
 </div>
 <hr style="clear: both;">
diff --git a/mygpo/web/templates/home-user.html b/mygpo/web/templates/home-user.html
new file mode 100644
index 0000000..24c829b
--- /dev/null
+++ b/mygpo/web/templates/home-user.html
@@ -0,0 +1,7 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>Your Subscriptions</h1>
+  <p>This page is currently in development.</p>
+{% endblock %}
+
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 3067a17..d9b6250 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -2,6 +2,21 @@
 
 {% block content %}
   <h1>my.gpodder.org</h1>
-  <p>{{ podcast_count }} Podcasts!</p>
+  <p>my.gpodder.org is a webservice for synchronizing podcast subscriptions on several devices and applications.</p>
+  <p>We are currently tracking {{ podcast_count }} Podcasts!</p>
+
+   <h2>Login</h2>
+   <form action="../login/" method="post">
+    Username:<br />
+    <input name="user" type="text" style="width:90%;"/><br />
+    Password:<br />
+    <input name="pwd" type="password" style="width:90%;" /><br />
+    <input type="submit" value="Login" style="margin-top:15px;" />
+   </form>
+
+  <div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px;">
+   Not yet a member? <a href="/register/">Register!</a>
+  </div>
+
 {% endblock %}
 
diff --git a/mygpo/web/templates/login.html b/mygpo/web/templates/login.html
new file mode 100644
index 0000000..7d5cb96
--- /dev/null
+++ b/mygpo/web/templates/login.html
@@ -0,0 +1,18 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>Login</h1>
+   <form action="../login/" method="post">
+    Username:<br />
+    <input name="user" type="text" style="width:90%;"/><br />
+    Password:<br />
+    <input name="pwd" type="password" style="width:90%;" /><br />
+    <input type="submit" value="Login" style="margin-top:15px;" />
+   </form>
+
+  <div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px;">
+   Not yet a member? <a href="/register/">Register!</a>
+  </div>
+
+{% endblock %}
+
diff --git a/mygpo/web/templates/migrate.html b/mygpo/web/templates/migrate.html
index 0d8919d..3cc2e3c 100644
--- a/mygpo/web/templates/migrate.html
+++ b/mygpo/web/templates/migrate.html
@@ -2,12 +2,11 @@
 
 {% block content %}
   <h1>my.gpodder.org</h1>
-  <p>The username has to be accepted or changed!</p>
-  <form action="../migrate/" method="post">
-  Old Username:&nbsp;&nbsp;&nbsp;<input type="text" name="oldusername" value="{{username}}" readonly="readonly" style="background-color:lightgrey;" /><br /><br />
-  New Username:&nbsp;<input type="text" name="newusername"/><br /><br />
-  <input type="checkbox" name="leave" />&nbsp;leave old username<br /><br />
+  <p>The new my.gpodder.org uses usernames instead of email addresses. Based on your email address, we think you might like <strong>{{username}}</strong>, but you can change that if you want to.</p>
+  <form action="/migrate/" method="post">
+  Username: <input type="text" name="username" value="{{ username }}"/><br /><br />
   <input type="submit" name="submit" value="Submit" />
   </form>
+  <p>You can keep your old user settings in gPodder. Once the next version (with lots of new features) is release, you'll have to replace your email address with your username.</p>
 {% endblock %}
 
diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 7c7c3d6..351eef0 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -2,88 +2,47 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
 from django.contrib.auth.models import User
-from mygpo.api.models import Podcast
+from django.contrib.auth.decorators import login_required
 from registration.forms import RegistrationForm
 from registration.views import activate, register
 from registration.models import RegistrationProfile
 
 def login_user(request):
-       podcasts = Podcast.objects.count()
        try:
               username = request.POST['user']
               password = request.POST['pwd']
        except:
-              return render_to_response('home.html', {
-                     'error': True,
-                     'error_message': 'No user or pwd entered',
-                     'podcast_count': podcasts
-              })
+              return render_to_response('login.html')
+
        user = authenticate(username=username, password=password)
        if user is not None:
               login(request, user)
 
-              p = user.get_profile()
-              if p.generated_id:
+              if user.get_profile().generated_id:
                      return render_to_response('migrate.html', {
-                           'authenticated': True,
-                           'login_message': username,
                            'username': user
                      })
               else:
                   return HttpResponseRedirect('/')
 
        else:
-              return render_to_response('home.html', {
-                     'error': True,
-                     'error_message': 'User not known or wrong password',
-                     'podcast_count': podcasts
+              return render_to_response('login.html', {
+                     'error_message': 'Unknown user or wrong password',
               })
 
-
-
-def logout_user(request):
-       logout(request)
-       return HttpResponseRedirect('/')
-
-
+@login_required
 def migrate_user(request):
-      podcasts = Podcast.objects.count()
-      oldusername = request.POST.get('oldusername', None)
-      newusername = request.POST.get('newusername', None)
-      leave = request.POST.get('leave', None)
-      submit = request.POST.get('submit', None)
-      if leave:
-            user = request.user
-            user.generated_id = 0
+    user = request.user
+    username = request.POST.get('username', user.username)
+    if user.username != username:
+        if User.objects.filter(username__exact=username).count() > 0:
+            return render_to_response('migrate.html', {'error': True, 'error_message': '%s is already taken' % username, 'username': user.username})
+        else:
+            user.username = username
             user.save()
-            return render_to_response('home.html', {
-                 'authenticated': True,
-                 'login_message': request.user,
-                 'podcast_count': podcasts
-            })
-      else:
-            if newusername == '':
-                 return render_to_response('migrate.html', {
-                      'error': True,
-                      'error_message': 'You have to fill in a new username in order to change',
-                      'authenticated': True,
-                      'login_message': request.user,
-                      'username': request.user
-                 })
-            else:
-                 tempuser = User.objects.get(username__exact=newusername)
-                 if tempuser == '':
-                      user = request.user
-                      user.username = newusername
-                      user.generated_id = 0
-                      user.save()
-                      return HttpResponseRedirect('/')
-                 else:
-                      return render_to_response('migrate.html', {
-                           'error': True,
-                           'error_message': 'Username exists',
-                           'authenticated': True,
-                           'login_message': request.user,
-                           'username': request.user
-                      })
+
+    user.get_profile().generated_id = 0
+    user.get_profile().save()
+
+    return HttpResponseRedirect('/')
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index c5256c9..d226bfe 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -1,17 +1,15 @@
 from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
+from django.template import RequestContext
 from mygpo.api.models import Podcast
 
 def home(request):
-       podcasts = Podcast.objects.count()
        if request.user.is_authenticated():
-              return render_to_response('home.html', {
-                    'authenticated': True,
-                    'login_message': request.user,
-                    'podcast_count': podcasts
-              })
+              return render_to_response('home-user.html', context_instance=RequestContext(request))
+
        else:
+              podcasts = Podcast.objects.count()
               return render_to_response('home.html', {
                     'podcast_count': podcasts
               })

commit 56cecc3f795333b30308366b4e3de3f4195e1d1d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 20:10:04 2009 +0100

    updating model, legacy api to new database scheme

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 2866a56..5d38677 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -1,7 +1,7 @@
 from django.http import HttpResponse
 from django.contrib.auth.models import User
 from mygpo.api.opml import Importer, Exporter
-from mygpo.api.models import Subscription, Podcast, SubscriptionAction, Device
+from mygpo.api.models import Subscription, Podcast, SubscriptionAction, Device, SUBSCRIBE_ACTION, UNSUBSCRIBE_ACTION
 from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
 
@@ -40,11 +40,11 @@ def upload(request):
                 'title' : n['title'],
                 'description': n['description'],
                 'last_update': datetime.now() })
-        s = SubscriptionAction(podcast=p,action='subscribe', timestamp=datetime.now(), device=d)
+        s = SubscriptionAction(podcast=p,action=SUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
         s.save()
 
     for r in rem:
-        s = SubscriptionAction(podcast=r, action='unsubscribe', timestamp=datetime.now(), device=d)
+        s = SubscriptionAction(podcast=r, action=UNSUBSCRIBE_ACTION, timestamp=datetime.now(), device=d)
         s.save()
 
     return HttpResponse('@SUCCESS', mimetype='text/plain')
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 6e6a25c..b1da76e 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -19,10 +19,8 @@ DEVICE_TYPES = (
         ('other', 'Other')
     )
 
-SUBSCRIPTION_ACTION_TYPES = (
-        ('subscribe', 'subscribed'),
-        ('unsubscribe', 'unsubscribed')
-    )
+SUBSCRIBE_ACTION = 1
+UNSUBSCRIBE_ACTION = -1
 
 class UserProfile(models.Model):
     user = models.ForeignKey(User, unique=True, db_column='user_ptr_id')
@@ -115,9 +113,9 @@ class Device(models.Model):
 
             if a != None and s.timestamp <= a.timestamp: continue
 
-            if s.action == 'subscribe' and not s.podcast in podcasts:
+            if s.action == SUBSCRIBE_ACTION and not s.podcast in podcasts:
                 sync_actions.append(s)
-            elif s.action == 'unsubscribe' and s.podcast in podcasts:
+            elif s.action == UNUSBSCRIBE_ACTION and s.podcast in podcasts:
                 sync_actions.append(s)
         return sync_actions
 
@@ -190,7 +188,7 @@ class EpisodeAction(models.Model):
     user = models.ForeignKey(User, primary_key=True)
     episode = models.ForeignKey(Episode)
     device = models.ForeignKey(Device)
-    action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
+    action = models.IntegerField(choices=EPISODE_ACTION_TYPES)
     timestamp = models.DateTimeField(default=datetime.now)
     playmark = models.IntegerField()
 
@@ -216,11 +214,14 @@ class Subscription(models.Model):
 class SubscriptionActionBase(models.Model):
     device = models.ForeignKey(Device)
     podcast = models.ForeignKey(Podcast)
-    action = models.CharField(max_length=12, choices=SUBSCRIPTION_ACTION_TYPES)
+    action = models.IntegerField()
     timestamp = models.DateTimeField(blank=True, default=datetime.now)
 
+    def action_string(self):
+        return 'subscribe' if self.action == SUBSCRIBE_ACTION else 'unsubscribe'
+
     def __unicode__(self):
-        return '%s %s %s' % (self.device, self.action, self.podcast)
+        return '%s %s %s %s' % (self.device.user, self.device, self.action_string(), self.podcast)
 
     class Meta:
         abstract = True

commit a093fbab0c3a3405ca5f75ad27b2d0241ca79e1e
Merge: 431e1e4... 49176e4...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 19:45:39 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src
    
    Conflicts:
    	install/update-03.sql

commit 431e1e4b691a8fa51e6e40d9fb05881282f1d99a
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 18:09:38 2009 +0100

    added default values for UserProfile

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index bf0cfe1..6e6a25c 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -27,8 +27,8 @@ SUBSCRIPTION_ACTION_TYPES = (
 class UserProfile(models.Model):
     user = models.ForeignKey(User, unique=True, db_column='user_ptr_id')
 
-    public_profile = models.BooleanField()
-    generated_id = models.BooleanField()
+    public_profile = models.BooleanField(default=True)
+    generated_id = models.BooleanField(default=False)
 
     def __unicode__(self):
         return '%s (%s, %s)' % (self.user.username, self.public_profile, self.generated_id)

commit 7809cb818a686e225404931dab82c5d3de0e5933
Merge: 5723b1b... 32c59f9...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 17:56:32 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit 5723b1b64acbb375d11927896f876a27cfdbc656
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 17:55:02 2009 +0100

    replaced UserAccount by user profile
    
    The existing UserAccount class (derived from User) has been replaced by the
    standard Django behaviour of user profiles.

diff --git a/install/update-03.sql b/install/update-03.sql
index 5c32f2e..8c293e0 100644
--- a/install/update-03.sql
+++ b/install/update-03.sql
@@ -44,3 +44,6 @@ BEGIN
 END;//
 DELIMITER ;
 
+
+ALTER TABLE user ADD COLUMN id INT PRIMARY KEY AUTO_INCREMENT;
+
diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 1472fa4..c3850ca 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -1,5 +1,7 @@
 from django.contrib import admin
 from django import forms
+from django.contrib.auth.models import User
+from django.contrib.auth.admin import UserAdmin
 from mygpo.api.models import *
 
 class DeviceInline(admin.TabularInline):
@@ -18,17 +20,14 @@ class SubscriptionActionInline(admin.TabularInline):
     model = SubscriptionAction
     extra = 3
 
-class UserAccountForm(forms.ModelForm):
-    def __init__(self, *args, **kwargs):
-        super(UserAccountForm, self).__init__(*args, **kwargs)
-        self.fields['default_device'].queryset = Device.objects.filter(user=self.instance)
-
 class SyncGroupAdmin(admin.ModelAdmin):
     inlines = [DeviceInline]
 
-class UserAccountAdmin(admin.ModelAdmin):
-    inlines = [DeviceInline, EpisodeActionInline]
-    form = UserAccountForm
+class UserProfileInline(admin.StackedInline):
+    model = UserProfile
+
+class UserProfileAdmin(admin.ModelAdmin):
+    inlines = [UserProfileInline, DeviceInline, EpisodeActionInline]
 
 class PodcastAdmin(admin.ModelAdmin):
     inlines = [EpisodeInline]
@@ -37,9 +36,11 @@ class PodcastAdmin(admin.ModelAdmin):
 class DeviceAdmin(admin.ModelAdmin):
     inlines = [SubscriptionActionInline]
 
-admin.site.register(UserAccount, UserAccountAdmin)
+admin.site.unregister(User)
+admin.site.register(User, UserProfileAdmin)
 admin.site.register(Podcast, PodcastAdmin)
 admin.site.register(SyncGroup, SyncGroupAdmin)
 admin.site.register(Device, DeviceAdmin)
 admin.site.register(Subscription)
 admin.site.register(SubscriptionAction)
+
diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 19ffa1e..2866a56 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -1,6 +1,7 @@
 from django.http import HttpResponse
+from django.contrib.auth.models import User
 from mygpo.api.opml import Importer, Exporter
-from mygpo.api.models import Subscription, Podcast, UserAccount, SubscriptionAction, Device
+from mygpo.api.models import Subscription, Podcast, SubscriptionAction, Device
 from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
 
@@ -71,8 +72,8 @@ def auth(emailaddr, password):
         return None
 
     try:
-        user = UserAccount.objects.get(email__exact=emailaddr)
-    except UserAccount.DoesNotExist:
+        user = User.objects.get(email__exact=emailaddr)
+    except User.DoesNotExist:
         return None
 
     if not user.check_password(password):
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 5ecf85d..bf0cfe1 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -24,17 +24,15 @@ SUBSCRIPTION_ACTION_TYPES = (
         ('unsubscribe', 'unsubscribed')
     )
 
-#inheriting from User, as described in 
-#http://scottbarnham.com/blog/2008/08/21/extending-the-django-user-model-with-inheritance/
-class UserAccount(User):
+class UserProfile(models.Model):
+    user = models.ForeignKey(User, unique=True, db_column='user_ptr_id')
+
     public_profile = models.BooleanField()
     generated_id = models.BooleanField()
 
-    objects = UserManager()
-
     def __unicode__(self):
-        return self.username
-    
+        return '%s (%s, %s)' % (self.user.username, self.public_profile, self.generated_id)
+
     class Meta:
         db_table = 'user'
 
@@ -206,7 +204,7 @@ class EpisodeAction(models.Model):
 class Subscription(models.Model):
     device = models.ForeignKey(Device, primary_key=True)
     podcast = models.ForeignKey(Podcast)
-    user = models.ForeignKey(UserAccount)
+    user = models.ForeignKey(User)
     subscribed_since = models.DateTimeField()
 
     def __unicode__(self):
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 0748e67..5f6478f 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -1,11 +1,12 @@
 from django.test import TestCase
-from mygpo.api.models import Device, Podcast, UserAccount, SubscriptionAction
+from django.contrib.auth.models import User
+from mygpo.api.models import Device, Podcast, SubscriptionAction
 
 class SyncTest(TestCase):
     def test_sync_actions(self):
         # this test does not yet complete when run as a unit test
         # because django does not set up the views
-        u  = UserAccount.objects.create(username='u')
+        u  = User.objects.create(username='u')
         d1 = Device.objects.create(name='d1', type='other', user=u)
         d2 = Device.objects.create(name='d2', type='other', user=u)
         p1 = Podcast.objects.create(title='p1', url='http://p1.com/')
diff --git a/mygpo/auth_backends.py b/mygpo/auth_backends.py
index c11a217..8f483fd 100644
--- a/mygpo/auth_backends.py
+++ b/mygpo/auth_backends.py
@@ -1,37 +1,23 @@
-#http://scottbarnham.com/blog/2008/08/21/extending-the-django-user-model-with-inheritance/
-
 from django.conf import settings
+from django.contrib.auth.models import User
 from django.contrib.auth.backends import ModelBackend
 from django.core.exceptions import ImproperlyConfigured
 from django.forms.fields import email_re
 from django.db.models import get_model
 
-class UserAccountModelBackend(ModelBackend):
+class EmailAuthenticationBackend(ModelBackend):
     def authenticate(self, username=None, password=None):
         if email_re.search(username):
             try:
-                user = self.user_class.objects.get(email=username)
-            except self.user_class.DoesNotExist:
-                return None
-        else:
-            try:
-                user = self.user_class.objects.get(username=username)
-            except self.user_class.DoesNotExist:
+                user = User.objects.filter(email=username)[0]
+                return user if user.check_password(password) else None
+            except:
                 return None
-        if user.check_password(password):
-                    return user
+        return None
 
     def get_user(self, user_id):
         try:
-            return self.user_class.objects.get(pk=user_id)
-        except self.user_class.DoesNotExist:
+            return User.objects.get(pk=user_id)
+        except User.DoesNotExist:
             return None
 
-    @property
-    def user_class(self):
-        if not hasattr(self, '_user_class'):
-            self._user_class = get_model(*settings.CUSTOM_USER_MODEL.split('.', 2))
-            if not self._user_class:
-                raise ImproperlyConfigured('Could not get custom user model')
-        return self._user_class
-
diff --git a/mygpo/settings.py b/mygpo/settings.py
index fbd3cda..1dc74f8 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -91,7 +91,11 @@ INSTALLED_APPS = (
 ACCOUNT_ACTIVATION_DAYS = 7
 
 AUTHENTICATION_BACKENDS = (
-    'mygpo.auth_backends.UserAccountModelBackend',
+    'django.contrib.auth.backends.ModelBackend',
+    'mygpo.auth_backends.EmailAuthenticationBackend',
 )
 
-CUSTOM_USER_MODEL = 'api.UserAccount'
+DEFAULT_FROM_EMAIL = 'mygpo@my.gpodder.org'
+
+AUTH_PROFILE_MODULE = "api.UserProfile"
+
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 6d8bd92..7fb7ffc 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -1,5 +1,7 @@
 import os.path
 from django.conf.urls.defaults import *
+from registration.views import activate, register
+from mygpo.api.models import UserProfile
 
 # Uncomment the next two lines to enable the admin:
 from django.contrib import admin
@@ -12,10 +14,9 @@ urlpatterns = patterns('',
     (r'^login/$', 'mygpo.web.users.login_user'),
     (r'^logout/$', 'mygpo.web.users.logout_user'),
     (r'^migrate/$', 'mygpo.web.users.migrate_user'),
-    (r'^register/$', 'mygpo.web.users.buildregister_user'),
-    (r'^registered/$', 'mygpo.web.users.register_user'),
+    (r'^register/$',  register, {'profile_callback': UserProfile.objects.create, 'success_url': '../registration_complete/' }),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
-    (r'^activate/$', 'mygpo.web.users.activate_user'),
+    (r'^activate/(?P<key>\w+)$', activate),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     (r'^upload$', 'mygpo.api.legacy.upload'),
diff --git a/mygpo/web/templates/registration/activation_email.txt b/mygpo/web/templates/registration/activation_email.txt
index ac774bd..7d495da 100644
--- a/mygpo/web/templates/registration/activation_email.txt
+++ b/mygpo/web/templates/registration/activation_email.txt
@@ -1,5 +1,4 @@
 Click on the link below to activate your account on my.gpodder.org
 
-http://dev.gpodder.org:8000/activate?key={{activation_key}}
-
+http://{{ site.domain }}/activate/{{activation_key}}
 
diff --git a/mygpo/web/templates/registration/registration_form.html b/mygpo/web/templates/registration/registration_form.html
index 397e870..555df23 100644
--- a/mygpo/web/templates/registration/registration_form.html
+++ b/mygpo/web/templates/registration/registration_form.html
@@ -3,7 +3,7 @@
 {% block content %}
   <h1>Create a User Account</h1>
 
-  <form action="/registered/" method="POST">
+  <form action="/register/" method="POST">
   <table class="register">
    {{ form.as_table }}
    <tr><th></th><td><input type="submit" value="Register" /></td></tr>
diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index f30c6a6..7c7c3d6 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -1,13 +1,14 @@
 from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
-from mygpo.api.models import Podcast, UserAccount
+from django.contrib.auth.models import User
+from mygpo.api.models import Podcast
 from registration.forms import RegistrationForm
 from registration.views import activate, register
 from registration.models import RegistrationProfile
 
 def login_user(request):
-       podcasts = Podcast.objects.count()       
+       podcasts = Podcast.objects.count()
        try:
               username = request.POST['user']
               password = request.POST['pwd']
@@ -20,14 +21,17 @@ def login_user(request):
        user = authenticate(username=username, password=password)
        if user is not None:
               login(request, user)
-              if user.generated_id:
+
+              p = user.get_profile()
+              if p.generated_id:
                      return render_to_response('migrate.html', {
                            'authenticated': True,
                            'login_message': username,
                            'username': user
                      })
               else:
-                     return HttpResponseRedirect('/')
+                  return HttpResponseRedirect('/')
+
        else:
               return render_to_response('home.html', {
                      'error': True,
@@ -67,7 +71,7 @@ def migrate_user(request):
                       'username': request.user
                  })
             else:
-                 tempuser = UserAccount.objects.get(username__exact=newusername)
+                 tempuser = User.objects.get(username__exact=newusername)
                  if tempuser == '':
                       user = request.user
                       user.username = newusername
@@ -83,13 +87,3 @@ def migrate_user(request):
                            'username': request.user
                       })
 
-
-def buildregister_user(request):
-       return register(request,'registration.backends.default.DefaultBackend')
-
-def register_user(request):
-       return register(request, '../registration_complete/')
-       
-def activate_user(request):
-	userkey = request.GET['key']  
-	return activate(request, userkey, 'registration/activate.html', {'account' : True})

commit 49176e4c4dbf11aaaa4a8dbdd7c60877f5cfbb1c
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Fri Nov 20 16:50:45 2009 +0100

    update database

diff --git a/install/crate-database.sql b/install/crate-database.sql
index 677234a..43bd126 100644
--- a/install/crate-database.sql
+++ b/install/crate-database.sql
@@ -59,7 +59,7 @@ CREATE TABLE subscription_log (
     id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
     device_id INT REFERENCES device (id),
     podcast_id INT REFERENCES podcast (id),
-    action ENUM ('subscribe', 'unsubscribe') NOT NULL,
+    action TINYINT(1) NOT NULL,
     timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
     UNIQUE (device_id, podcast_id, action, timestamp)
 );
diff --git a/install/update-02.sql b/install/update-02.sql
index f6659af..1eb380c 100644
--- a/install/update-02.sql
+++ b/install/update-02.sql
@@ -1,18 +1,16 @@
 
--- Bug 656 --
-ALTER TABLE podcast ADD COLUMN logo_url VARCHAR(1000);
-
 -- Bug 649 --
+DROP TABLE IF EXISTS `sync_group`;
 CREATE TABLE `sync_group` (
     `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
     `user_id` integer NOT NULL
 );
 
-ALTER TABLE user DROP COLUMN default_device_id;
 ALTER TABLE device ADD COLUMN sync_group_id INT REFERENCES sync_group(id);
 ALTER TABLE device ADD COLUMN `uid` varchar(50) NOT NULL;
 
 -- selects the latest action for each pair (device_id, podcast_id) --
+DROP VIEW IF EXISTS sync_group_subscription_log;
 CREATE VIEW sync_group_subscription_log AS
     SELECT subscription_log.id AS id, device_id, podcast_id, action, timestamp, sync_group_id
     FROM subscription_log JOIN device ON device_id = device.id 
@@ -22,6 +20,7 @@ CREATE VIEW sync_group_subscription_log AS
         GROUP BY podcast_id, device_id
     );
 
+DROP VIEW IF EXISTS sync_group_current_subscription;
 CREATE VIEW sync_group_current_subscription AS
     SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since, sync_group_id
     FROM (subscription_log a JOIN device b on a.device_id=b.id) JOIN user c on b.user_id=c.user_ptr_id
diff --git a/install/update-03.sql b/install/update-03.sql
index 5c32f2e..3d9168c 100644
--- a/install/update-03.sql
+++ b/install/update-03.sql
@@ -12,7 +12,7 @@ BEGIN
 			where a.device_id = new.device_id
 			and a.podcast_id = new.podcast_id;
 
-	IF new.action = 'subscribe' THEN
+	IF new.action = 1 THEN
 		
 		IF help_id > 0 THEN
 			call Fail('This subscription already exists!');
@@ -44,3 +44,66 @@ BEGIN
 END;//
 DELIMITER ;
 
+DROP VIEW IF EXISTS public_subscription;
+CREATE VIEW public_subscription AS
+    SELECT cs.podcast_id,
+           cs.user_id,
+           ifnull(s.public, true) AS pub_subscription,
+           ifnull(u.public_profile,true) AS pub_profile
+    FROM (current_subscription cs
+       LEFT JOIN subscription s
+       ON cs.podcast_id = s.podcast_id
+       AND cs.user_id = s.user_id)
+          LEFT JOIN user u
+          ON s.user_id = u.user_ptr_id
+       HAVING pub_subscription=1
+       AND pub_profile;
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_toplist $$
+CREATE PROCEDURE update_toplist()
+BEGIN
+	DECLARE deadlock INT DEFAULT 0;
+    	DECLARE attempts INT DEFAULT 0;
+
+	try_loop:WHILE (attempts<3) DO
+	BEGIN
+		DECLARE deadlock_detected CONDITION FOR 1213;
+    		DECLARE EXIT HANDLER FOR deadlock_detected
+    			BEGIN
+    				ROLLBACK;
+    				SET deadlock=1;
+    			END;
+    		SET deadlock=0;
+   			
+    		START TRANSACTION;
+			DELETE FROM toplist;
+			INSERT INTO toplist (SELECT a.podcast_id, COUNT(*) AS count_subscription
+						FROM (SELECT DISTINCT podcast_id, user_id 
+							FROM public_subscription) a 
+						GROUP BY podcast_id);
+			
+			COMMIT;
+		END;
+		IF deadlock=0 THEN
+    			LEAVE try_loop;
+    		ELSE
+    			SET attempts=attempts+1;
+    		END IF;
+    	END WHILE try_loop;
+
+	IF deadlock=1 THEN
+		call FAIL('Toplist is not updated!');
+	END IF;
+
+END $$
+DELIMITER ;
+
+DROP VIEW IF EXISTS current_subscription;
+
+CREATE VIEW current_subscription AS SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since, sum(a.action) as summe 
+    FROM (subscription_log a JOIN device b on a.device_id=b.id) 
+        JOIN user c on b.user_id=c.user_ptr_id 
+    GROUP BY a.podcast_id, b.user_id 
+    having summe>0;
+

commit bfc91dd906426e44d1248f9bad072f1e105c55ea
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 12:17:03 2009 +0100

    removed trailing spaces

diff --git a/mygpo/auth_backends.py b/mygpo/auth_backends.py
index 54de07d..c11a217 100644
--- a/mygpo/auth_backends.py
+++ b/mygpo/auth_backends.py
@@ -15,7 +15,7 @@ class UserAccountModelBackend(ModelBackend):
                 return None
         else:
             try:
-                user = self.user_class.objects.get(username=username)                
+                user = self.user_class.objects.get(username=username)
             except self.user_class.DoesNotExist:
                 return None
         if user.check_password(password):
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 265929f..6d8bd92 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -13,17 +13,17 @@ urlpatterns = patterns('',
     (r'^logout/$', 'mygpo.web.users.logout_user'),
     (r'^migrate/$', 'mygpo.web.users.migrate_user'),
     (r'^register/$', 'mygpo.web.users.buildregister_user'),
-    (r'^registered/$', 'mygpo.web.users.register_user'), 
+    (r'^registered/$', 'mygpo.web.users.register_user'),
     (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
-    (r'^activate/$', 'mygpo.web.users.activate_user'),                   
+    (r'^activate/$', 'mygpo.web.users.activate_user'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
- 
+
     (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>(txt|opml|json))', 'mygpo.api.simple.subscriptions'),
-    
-    # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
+
+    # Uncomment the admin/doc line below and add 'django.contrib.admindocs'
     # to INSTALLED_APPS to enable admin documentation:
     # (r'^admin/doc/', include('django.contrib.admindocs.urls')),
 
@@ -33,5 +33,5 @@ urlpatterns = patterns('',
     (r'^accounts/', include('registration.urls')),
 
     (r'^media/(?P<path>.*)$', 'django.views.static.serve', {'document_root': os.path.abspath('%s/../htdocs/media/' % os.path.dirname(__file__))}),
-    
+
 )

commit 5aa253f950f02b140ff494e3084795d2ff3ad121
Merge: 336851c... 35fbd63...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 20 11:08:19 2009 +0100

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 32c59f90db980f9be6d6cf905f76910380fb1197
Merge: b0a4f56... a219f6a...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Fri Nov 20 07:11:02 2009 +0000

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit b0a4f5621247d5a0b5c436de3a2889dfbfa42e7c
Merge: 89d8ddb... 35fbd63...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Fri Nov 20 07:10:40 2009 +0000

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 89d8ddbf9cc2bd30e966732c5a0c20698743faec
Merge: 95ef6bc... 336851c...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Fri Nov 20 07:10:27 2009 +0000

    Merge branch 'master' of dgpo:mygpo-src

commit 5d1324c8d173ad92238f2a44e947383625edbde4
Merge: 35fbd63... 336851c...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Fri Nov 20 00:36:03 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src

commit 35fbd631300c057373a907f8319660dc8695f462
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Fri Nov 20 00:35:20 2009 +0100

    added the registration functionality

diff --git a/mygpo/settings.py b/mygpo/settings.py
index 6c6efec..fbd3cda 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -27,7 +27,7 @@ DATABASE_PORT = ''             # Set to empty string for default. Not used with
 # although not all choices may be available on all operating systems.
 # If running in a Windows environment this must be set to the same as your
 # system time zone.
-TIME_ZONE = 'America/Chicago'
+TIME_ZONE = 'UTC'
 
 # Language code for this installation. All choices can be found here:
 # http://www.i18nguy.com/unicode/language-identifiers.html
diff --git a/mygpo/urls.py b/mygpo/urls.py
index ea22f94..265929f 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -12,6 +12,10 @@ urlpatterns = patterns('',
     (r'^login/$', 'mygpo.web.users.login_user'),
     (r'^logout/$', 'mygpo.web.users.logout_user'),
     (r'^migrate/$', 'mygpo.web.users.migrate_user'),
+    (r'^register/$', 'mygpo.web.users.buildregister_user'),
+    (r'^registered/$', 'mygpo.web.users.register_user'), 
+    (r'^registration_complete/$', 'django.views.generic.simple.direct_to_template', {'template': 'registration/registration_complete.html'}),
+    (r'^activate/$', 'mygpo.web.users.activate_user'),                   
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     (r'^upload$', 'mygpo.api.legacy.upload'),
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 17b1bd8..9e400f0 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -41,6 +41,12 @@
             content: '';
             padding-left: 0px;
         }
+		
+		table.register th {
+			font-weight:normal;
+			width:150px;
+			text-align:left;
+		}
     </style>
 </head><body>
 <h1 style="margin: 0px; padding: 0px; position: absolute; top: 0px; left: 20px; height: 70px; z-index: 100;">
@@ -89,7 +95,7 @@
 		</form>
 	</div>
 	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%);">
-		Not yet a member? <a href="">Register!</a>
+		Not yet a member? <a href="../register/">Register!</a>
 	</div>
 	{% endif %}
 </div>
diff --git a/mygpo/web/templates/registration/activate.html b/mygpo/web/templates/registration/activate.html
index 358fd6e..29f1a6a 100644
--- a/mygpo/web/templates/registration/activate.html
+++ b/mygpo/web/templates/registration/activate.html
@@ -1,7 +1,12 @@
 {% extends "base.html" %}
 
 {% block content %}
+  {% if account %}
+  <h1>Account activated</h1>
+  <p>Your account has been activated! Enjoy using my.gpodder.org</p>
+  {% else %}
   <h1>Account not activated</h1>
   <p>Your account could not be activated successfully.</p>
+  {% endif %}
 {% endblock %}
 
diff --git a/mygpo/web/templates/registration/activation_email.txt b/mygpo/web/templates/registration/activation_email.txt
index cd8c94d..ac774bd 100644
--- a/mygpo/web/templates/registration/activation_email.txt
+++ b/mygpo/web/templates/registration/activation_email.txt
@@ -1,5 +1,5 @@
 Click on the link below to activate your account on my.gpodder.org
 
-{{activation_key}}
+http://dev.gpodder.org:8000/activate?key={{activation_key}}
 
 
diff --git a/mygpo/web/templates/registration/registration_form.html b/mygpo/web/templates/registration/registration_form.html
index bc7e725..397e870 100644
--- a/mygpo/web/templates/registration/registration_form.html
+++ b/mygpo/web/templates/registration/registration_form.html
@@ -3,9 +3,11 @@
 {% block content %}
   <h1>Create a User Account</h1>
 
-  <form action="/contact/" method="POST">
-   {{ form.as_p }}
-   <input type="submit" value="Submit" />
+  <form action="/registered/" method="POST">
+  <table class="register">
+   {{ form.as_table }}
+   <tr><th></th><td><input type="submit" value="Register" /></td></tr>
+   </table>
   </form>
 
 {% endblock %}
diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index f944dd6..f30c6a6 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -2,10 +2,12 @@ from django.shortcuts import render_to_response
 from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
 from mygpo.api.models import Podcast, UserAccount
-
+from registration.forms import RegistrationForm
+from registration.views import activate, register
+from registration.models import RegistrationProfile
 
 def login_user(request):
-       podcasts = Podcast.objects.count()
+       podcasts = Podcast.objects.count()       
        try:
               username = request.POST['user']
               password = request.POST['pwd']
@@ -15,7 +17,6 @@ def login_user(request):
                      'error_message': 'No user or pwd entered',
                      'podcast_count': podcasts
               })
-
        user = authenticate(username=username, password=password)
        if user is not None:
               login(request, user)
@@ -81,3 +82,14 @@ def migrate_user(request):
                            'login_message': request.user,
                            'username': request.user
                       })
+
+
+def buildregister_user(request):
+       return register(request,'registration.backends.default.DefaultBackend')
+
+def register_user(request):
+       return register(request, '../registration_complete/')
+       
+def activate_user(request):
+	userkey = request.GET['key']  
+	return activate(request, userkey, 'registration/activate.html', {'account' : True})

commit a219f6afd36a2b22935618a6f4bf0f4e680fd0d2
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Thu Nov 19 21:33:46 2009 +0100

    	modified:   simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index dae5ac6..e0f14e2 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -1,6 +1,8 @@
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
 from mygpo.api.models import Device
+from mygpo.api.opml import Exporter
+from mygpo.api.json import JsonResponse
 
 @require_valid_user()
 def subscriptions(request, username, device_uid, format):
@@ -9,10 +11,11 @@ def subscriptions(request, username, device_uid, format):
         return HttpResponseForbidden()
 
     if request.method == 'GET':
-        return format_subscriptions(get_subscriptions(username, device), format)
+        return format_subscriptions(get_subscriptions(username, device_uid), format)
         
     elif request.method == 'PUT':
-        return set_subscriptions(device, parse_subscription(request.raw_post_data, format))
+	return request.raw_post_data
+        #return set_subscriptions(device_uid, parse_subscription(request.raw_post_data, format))
 
     else:
         return HttpResponseBadReqest()
@@ -23,19 +26,19 @@ def format_subscriptions(subscriptions, format):
         #return subscriptions formatted as txt
         urls = [p.url for p in subscriptions]
         s = "\n".join(urls)
-        return HttpRequest(s, mimetype='text/plain')
+        return HttpResponse(s, mimetype='text/plain')
 
     elif format == 'opml':
-        e = Exporter(subscriptions)
-        return HttpRequest(e.generate(), mimetype='text/xml')
+        return HttpResponse(Exporter().generate(subscriptions), mimetype='text/xml')
     
     elif format == 'json':
-        return JsonRequest(subscriptions)
+	urls = [p.url for p in subscriptions]
+        return JsonResponse(urls)
 
 def get_subscriptions(username, device_uid):
     #get and return subscription list from database (use backend to sync)
     d = Device.objects.get(uid=device_uid, user__username=username)
-    return [p.podcast for p in device.get_subscriptions()]
+    return [p.podcast for p in d.get_subscriptions()]
 
 def parse_subscription(raw_post_data, format):
     if format == 'txt':
@@ -51,6 +54,6 @@ def parse_subscription(raw_post_data, format):
 
     else: raise ValueError('unsupported format %s' % format)
 
-def set_subscriptions(device, subscriptions):
+def set_subscriptions(device_uid, subscriptions):
     # save subscriptions in database
     pass

commit 336851cc355ed4482ae54d36b83b1580baf80008
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 19 21:20:39 2009 +0100

    removed unnecessary whitespace

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 4d1e1e2..19ffa1e 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -77,6 +77,6 @@ def auth(emailaddr, password):
 
     if not user.check_password(password):
         return None
-    
+
     return user
 

commit 8fbc981517af78a660930f770cc42b86c8ecaf3d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 19 19:31:26 2009 +0100

    some small fixes in the simple api

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index d60b99d..dae5ac6 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -3,13 +3,13 @@ from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbid
 from mygpo.api.models import Device
 
 @require_valid_user()
-def subscriptions(request, username, device, format):
+def subscriptions(request, username, device_uid, format):
     
     if request.user.username != username:
         return HttpResponseForbidden()
 
     if request.method == 'GET':
-        return format_subscriptions(get_subscriptions(device), format)
+        return format_subscriptions(get_subscriptions(username, device), format)
         
     elif request.method == 'PUT':
         return set_subscriptions(device, parse_subscription(request.raw_post_data, format))
@@ -21,7 +21,8 @@ def subscriptions(request, username, device, format):
 def format_subscriptions(subscriptions, format):
     if format == 'txt':
         #return subscriptions formatted as txt
-        s = "\n".join(subscriptions)
+        urls = [p.url for p in subscriptions]
+        s = "\n".join(urls)
         return HttpRequest(s, mimetype='text/plain')
 
     elif format == 'opml':
@@ -31,10 +32,10 @@ def format_subscriptions(subscriptions, format):
     elif format == 'json':
         return JsonRequest(subscriptions)
 
-def get_subscriptions(device):
-    # get and return subscription list from database (use backend to sync)
-    d, created = Device.objects.get_or_create(user=user, uid=device.uid, name=device.name, type=device.type)
-    return [p.podcast for p in d.get_subscriptions()]
+def get_subscriptions(username, device_uid):
+    #get and return subscription list from database (use backend to sync)
+    d = Device.objects.get(uid=device_uid, user__username=username)
+    return [p.podcast for p in device.get_subscriptions()]
 
 def parse_subscription(raw_post_data, format):
     if format == 'txt':

commit 95ef6bcc5eccf839a2d9ce8f22b05e5ecee51c41
Merge: 0f426ce... 3074764...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Wed Nov 18 07:50:24 2009 +0000

    Merge branch 'master' of dgpo:mygpo-src

commit 3074764081a487ada348f5fcfd79da49484a93b8
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 17 20:25:43 2009 +0100

    removed unnecessary code in mygpo.web.users.logout

diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 7cca19e..f944dd6 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -37,7 +37,6 @@ def login_user(request):
 
 
 def logout_user(request):
-       podcasts = Podcast.objects.count()
        logout(request)
        return HttpResponseRedirect('/')
 

commit 31bc05c5fb0a8ffa1b6efa683f1d03ad2a24797d
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 17 17:58:53 2009 +0100

    redirecting to / after successful actions

diff --git a/mygpo/web/users.py b/mygpo/web/users.py
index 6aec4ec..7cca19e 100644
--- a/mygpo/web/users.py
+++ b/mygpo/web/users.py
@@ -26,26 +26,20 @@ def login_user(request):
                            'username': user
                      })
               else:
-                     return render_to_response('home.html', {
-                           'authenticated': True,
-                           'login_message': username,
-                           'podcast_count': podcasts
-                     })
+                     return HttpResponseRedirect('/')
        else:
               return render_to_response('home.html', {
                      'error': True,
                      'error_message': 'User not known or wrong password',
                      'podcast_count': podcasts
               })
-      
+
 
 
 def logout_user(request):
        podcasts = Podcast.objects.count()
        logout(request)
-       return render_to_response('home.html', {
-             'podcast_count': podcasts
-       })
+       return HttpResponseRedirect('/')
 
 
 def migrate_user(request):
@@ -79,11 +73,7 @@ def migrate_user(request):
                       user.username = newusername
                       user.generated_id = 0
                       user.save()
-                      return render_to_response('home.html', {
-                           'authenticated': True,
-                           'login_message': user,
-                           'podcast_count': podcasts
-                      })
+                      return HttpResponseRedirect('/')
                  else:
                       return render_to_response('migrate.html', {
                            'error': True,
@@ -91,4 +81,4 @@ def migrate_user(request):
                            'authenticated': True,
                            'login_message': request.user,
                            'username': request.user
-                      })
\ No newline at end of file
+                      })

commit c125c75fe9c373e60d6033267b76efb5ea58827e
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Nov 17 17:17:18 2009 +0100

    corrected the login

diff --git a/mygpo/__init__.pyc b/mygpo/__init__.pyc
deleted file mode 100644
index c5e44b5..0000000
Binary files a/mygpo/__init__.pyc and /dev/null differ
diff --git a/mygpo/api/__init__.pyc b/mygpo/api/__init__.pyc
deleted file mode 100644
index af45add..0000000
Binary files a/mygpo/api/__init__.pyc and /dev/null differ
diff --git a/mygpo/api/admin.pyc b/mygpo/api/admin.pyc
deleted file mode 100644
index 3497b3b..0000000
Binary files a/mygpo/api/admin.pyc and /dev/null differ
diff --git a/mygpo/api/models.pyc b/mygpo/api/models.pyc
deleted file mode 100644
index 7ea6842..0000000
Binary files a/mygpo/api/models.pyc and /dev/null differ
diff --git a/mygpo/auth_backends.pyc b/mygpo/auth_backends.pyc
deleted file mode 100644
index b2348d5..0000000
Binary files a/mygpo/auth_backends.pyc and /dev/null differ
diff --git a/mygpo/settings.pyc b/mygpo/settings.pyc
deleted file mode 100644
index 470a0d6..0000000
Binary files a/mygpo/settings.pyc and /dev/null differ
diff --git a/mygpo/urls.pyc b/mygpo/urls.pyc
deleted file mode 100644
index 0c51451..0000000
Binary files a/mygpo/urls.pyc and /dev/null differ
diff --git a/mygpo/web/__init__.pyc b/mygpo/web/__init__.pyc
deleted file mode 100644
index 77c0260..0000000
Binary files a/mygpo/web/__init__.pyc and /dev/null differ
diff --git a/mygpo/web/models.pyc b/mygpo/web/models.pyc
deleted file mode 100644
index a7a9c80..0000000
Binary files a/mygpo/web/models.pyc and /dev/null differ
diff --git a/mygpo/web/users.pyc b/mygpo/web/users.pyc
deleted file mode 100644
index e5c87e6..0000000
Binary files a/mygpo/web/users.pyc and /dev/null differ
diff --git a/mygpo/web/views.pyc b/mygpo/web/views.pyc
deleted file mode 100644
index 4ea4f53..0000000
Binary files a/mygpo/web/views.pyc and /dev/null differ

commit e488985cbdadea728278f257c84a47d96962c5e3
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Nov 17 17:15:17 2009 +0100

    temporary commit^

diff --git a/mygpo/__init__.pyc b/mygpo/__init__.pyc
new file mode 100644
index 0000000..c5e44b5
Binary files /dev/null and b/mygpo/__init__.pyc differ
diff --git a/mygpo/api/__init__.pyc b/mygpo/api/__init__.pyc
new file mode 100644
index 0000000..af45add
Binary files /dev/null and b/mygpo/api/__init__.pyc differ
diff --git a/mygpo/api/admin.pyc b/mygpo/api/admin.pyc
new file mode 100644
index 0000000..3497b3b
Binary files /dev/null and b/mygpo/api/admin.pyc differ
diff --git a/mygpo/api/models.pyc b/mygpo/api/models.pyc
new file mode 100644
index 0000000..7ea6842
Binary files /dev/null and b/mygpo/api/models.pyc differ
diff --git a/mygpo/auth_backends.pyc b/mygpo/auth_backends.pyc
new file mode 100644
index 0000000..b2348d5
Binary files /dev/null and b/mygpo/auth_backends.pyc differ
diff --git a/mygpo/settings.pyc b/mygpo/settings.pyc
new file mode 100644
index 0000000..470a0d6
Binary files /dev/null and b/mygpo/settings.pyc differ
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 001e087..ea22f94 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -9,8 +9,9 @@ urlpatterns = patterns('',
     # Example:
     # (r'^mygpo/', include('mygpo.foo.urls')),
     (r'^$', 'mygpo.web.views.home'),
-    (r'^login/$', 'mygpo.web.views.login_user'),
-    (r'^logout/$', 'mygpo.web.views.logout_user'),
+    (r'^login/$', 'mygpo.web.users.login_user'),
+    (r'^logout/$', 'mygpo.web.users.logout_user'),
+    (r'^migrate/$', 'mygpo.web.users.migrate_user'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     (r'^upload$', 'mygpo.api.legacy.upload'),
diff --git a/mygpo/urls.pyc b/mygpo/urls.pyc
new file mode 100644
index 0000000..0c51451
Binary files /dev/null and b/mygpo/urls.pyc differ
diff --git a/mygpo/web/__init__.pyc b/mygpo/web/__init__.pyc
new file mode 100644
index 0000000..77c0260
Binary files /dev/null and b/mygpo/web/__init__.pyc differ
diff --git a/mygpo/web/models.pyc b/mygpo/web/models.pyc
new file mode 100644
index 0000000..a7a9c80
Binary files /dev/null and b/mygpo/web/models.pyc differ
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 28d8784..3067a17 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -2,10 +2,6 @@
 
 {% block content %}
   <h1>my.gpodder.org</h1>
-  {% if change_username %}
-  <h2>You have to accept or change your username</h2>
-  {% else %}
   <p>{{ podcast_count }} Podcasts!</p>
-  {% endif %}
 {% endblock %}
 
diff --git a/mygpo/web/templates/migrate.html b/mygpo/web/templates/migrate.html
new file mode 100644
index 0000000..0d8919d
--- /dev/null
+++ b/mygpo/web/templates/migrate.html
@@ -0,0 +1,13 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>my.gpodder.org</h1>
+  <p>The username has to be accepted or changed!</p>
+  <form action="../migrate/" method="post">
+  Old Username:&nbsp;&nbsp;&nbsp;<input type="text" name="oldusername" value="{{username}}" readonly="readonly" style="background-color:lightgrey;" /><br /><br />
+  New Username:&nbsp;<input type="text" name="newusername"/><br /><br />
+  <input type="checkbox" name="leave" />&nbsp;leave old username<br /><br />
+  <input type="submit" name="submit" value="Submit" />
+  </form>
+{% endblock %}
+
diff --git a/mygpo/web/users.py b/mygpo/web/users.py
new file mode 100644
index 0000000..6aec4ec
--- /dev/null
+++ b/mygpo/web/users.py
@@ -0,0 +1,94 @@
+from django.shortcuts import render_to_response
+from django.http import HttpResponseRedirect
+from django.contrib.auth import authenticate, login, logout
+from mygpo.api.models import Podcast, UserAccount
+
+
+def login_user(request):
+       podcasts = Podcast.objects.count()
+       try:
+              username = request.POST['user']
+              password = request.POST['pwd']
+       except:
+              return render_to_response('home.html', {
+                     'error': True,
+                     'error_message': 'No user or pwd entered',
+                     'podcast_count': podcasts
+              })
+
+       user = authenticate(username=username, password=password)
+       if user is not None:
+              login(request, user)
+              if user.generated_id:
+                     return render_to_response('migrate.html', {
+                           'authenticated': True,
+                           'login_message': username,
+                           'username': user
+                     })
+              else:
+                     return render_to_response('home.html', {
+                           'authenticated': True,
+                           'login_message': username,
+                           'podcast_count': podcasts
+                     })
+       else:
+              return render_to_response('home.html', {
+                     'error': True,
+                     'error_message': 'User not known or wrong password',
+                     'podcast_count': podcasts
+              })
+      
+
+
+def logout_user(request):
+       podcasts = Podcast.objects.count()
+       logout(request)
+       return render_to_response('home.html', {
+             'podcast_count': podcasts
+       })
+
+
+def migrate_user(request):
+      podcasts = Podcast.objects.count()
+      oldusername = request.POST.get('oldusername', None)
+      newusername = request.POST.get('newusername', None)
+      leave = request.POST.get('leave', None)
+      submit = request.POST.get('submit', None)
+      if leave:
+            user = request.user
+            user.generated_id = 0
+            user.save()
+            return render_to_response('home.html', {
+                 'authenticated': True,
+                 'login_message': request.user,
+                 'podcast_count': podcasts
+            })
+      else:
+            if newusername == '':
+                 return render_to_response('migrate.html', {
+                      'error': True,
+                      'error_message': 'You have to fill in a new username in order to change',
+                      'authenticated': True,
+                      'login_message': request.user,
+                      'username': request.user
+                 })
+            else:
+                 tempuser = UserAccount.objects.get(username__exact=newusername)
+                 if tempuser == '':
+                      user = request.user
+                      user.username = newusername
+                      user.generated_id = 0
+                      user.save()
+                      return render_to_response('home.html', {
+                           'authenticated': True,
+                           'login_message': user,
+                           'podcast_count': podcasts
+                      })
+                 else:
+                      return render_to_response('migrate.html', {
+                           'error': True,
+                           'error_message': 'Username exists',
+                           'authenticated': True,
+                           'login_message': request.user,
+                           'username': request.user
+                      })
\ No newline at end of file
diff --git a/mygpo/web/users.pyc b/mygpo/web/users.pyc
new file mode 100644
index 0000000..e5c87e6
Binary files /dev/null and b/mygpo/web/users.pyc differ
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index b54f11b..c5256c9 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -16,39 +16,3 @@ def home(request):
                     'podcast_count': podcasts
               })
 
-def login_user(request):
-       podcasts = Podcast.objects.count()
-       try:
-              username = request.POST['user']
-              password = request.POST['pwd']
-       except:
-              return render_to_response('home.html', {
-                     'error': True,
-                     'error_message': 'No user or pwd entered',
-                     'podcast_count': podcasts
-              })
-
-       user = authenticate(username=username, password=password)
-       if user is not None:
-              login(request, user)
-              return render_to_response('home.html', {
-                     'authenticated': True,
-                     'change_password': user.generated_id,
-                     'login_message': username,
-                     'podcast_count': podcasts
-              })
-       else:
-              return render_to_response('home.html', {
-                     'error': True,
-                     'error_message': 'User not known or wrong password',
-                     'podcast_count': podcasts
-              })
-      
-
-
-def logout_user(request):
-       podcasts = Podcast.objects.count()
-       logout(request)
-       return render_to_response('home.html', {
-             'podcast_count': podcasts
-       })
diff --git a/mygpo/web/views.pyc b/mygpo/web/views.pyc
new file mode 100644
index 0000000..4ea4f53
Binary files /dev/null and b/mygpo/web/views.pyc differ

commit 752cbc1a7b4157b0fe6ecb649923d4e76aef0911
Merge: b826551... d75c28b...
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Nov 17 16:08:38 2009 +0100

    Merge branch 'master' of armin@dev.gpodder.org:~/../stefan/mygpo-src
    
    Conflicts:
    
    	mygpo/web/views.py

commit b8265519939ecec1537847211808d7e37553ac6a
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Nov 17 16:06:52 2009 +0100

     :w

diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 3067a17..28d8784 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -2,6 +2,10 @@
 
 {% block content %}
   <h1>my.gpodder.org</h1>
+  {% if change_username %}
+  <h2>You have to accept or change your username</h2>
+  {% else %}
   <p>{{ podcast_count }} Podcasts!</p>
+  {% endif %}
 {% endblock %}
 
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 34d7757..f0000b6 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -32,6 +32,7 @@ def login_user(request):
               login(request, user)
               return render_to_response('home.html', {
                      'authenticated': True,
+                     'change_password': user.generated_id,
                      'login_message': username,
                      'podcast_count': podcasts
               })

commit d75c28bb890e24ea1b571265be7f7f86b13feaeb
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 17 16:04:24 2009 +0100

    added missing UserAccount.generated_id

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 104bbfd..5ecf85d 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -28,6 +28,7 @@ SUBSCRIPTION_ACTION_TYPES = (
 #http://scottbarnham.com/blog/2008/08/21/extending-the-django-user-model-with-inheritance/
 class UserAccount(User):
     public_profile = models.BooleanField()
+    generated_id = models.BooleanField()
 
     objects = UserManager()
 

commit 13d7add121a4c8fb658d37f80b261ee2ae9779bc
Merge: 08d2f08... 00e01eb...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 17 15:54:23 2009 +0100

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 08d2f0847cd90856a3214d216768ec9cb2ab2006
Merge: 65566c4... 8cee3b9...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 17 15:53:35 2009 +0100

    Merge branch 'master' of dgpo:~martin/mygpo-src

commit 00e01eb2d4380f8979f6b6d8087ff7c4e0d22a97
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Nov 17 15:52:40 2009 +0100

    Added login by mail-address

diff --git a/mygpo/auth_backends.py b/mygpo/auth_backends.py
index 0c482b5..54de07d 100644
--- a/mygpo/auth_backends.py
+++ b/mygpo/auth_backends.py
@@ -3,16 +3,23 @@
 from django.conf import settings
 from django.contrib.auth.backends import ModelBackend
 from django.core.exceptions import ImproperlyConfigured
+from django.forms.fields import email_re
 from django.db.models import get_model
 
 class UserAccountModelBackend(ModelBackend):
     def authenticate(self, username=None, password=None):
-        try:
-            user = self.user_class.objects.get(username=username)
-            if user.check_password(password):
-                return user
-        except self.user_class.DoesNotExist:
-            return None
+        if email_re.search(username):
+            try:
+                user = self.user_class.objects.get(email=username)
+            except self.user_class.DoesNotExist:
+                return None
+        else:
+            try:
+                user = self.user_class.objects.get(username=username)                
+            except self.user_class.DoesNotExist:
+                return None
+        if user.check_password(password):
+                    return user
 
     def get_user(self, user_id):
         try:
@@ -27,3 +34,4 @@ class UserAccountModelBackend(ModelBackend):
             if not self._user_class:
                 raise ImproperlyConfigured('Could not get custom user model')
         return self._user_class
+
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 9280526..17b1bd8 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -71,7 +71,7 @@
 	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; background-color:rgb(102, 102, 102);">&nbsp;</span>
 	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; -moz-border-radius-topright: 30px; background-color:rgb(255,255,255);">&nbsp;</span>
 	{% if error %}
-	 <p style="margin-left:10px; color:rgb(210,105,30);">{{ error_message }}</p>
+	 <p style="margin-top:-20px; margin-left:10px; color:rgb(210,105,30);">{{ error_message }}</p>
 	{% endif %}
 	{% if authenticated %}
 	<p style="margin-left:10px; color:rgb(70%,70%,70%);">logged in as {{ login_message }}<br />
@@ -81,15 +81,15 @@
 	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%); border:1px solid rgb(70%,70%,70%);">
 		<h2>Login</h2>
 		<form action="../login/" method="post">
-		Username:
-		<input name="user" type="text" />
-		Password:
-		<input name="pwd" type="password" />
+		Username:<br />
+		<input name="user" type="text" style="width:90%;"/><br />
+		Password:<br />
+		<input name="pwd" type="password" style="width:90%;" /><br />
 		<input type="submit" value="Login" style="margin-left:90px; margin-top:15px;" />
 		</form>
 	</div>
 	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%);">
-		Not yet a member? <a href="#">Register!</a>
+		Not yet a member? <a href="">Register!</a>
 	</div>
 	{% endif %}
 </div>
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 1dfa72e..34d7757 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -26,6 +26,7 @@ def login_user(request):
                      'error_message': 'No user or pwd entered',
                      'podcast_count': podcasts
               })
+
        user = authenticate(username=username, password=password)
        if user is not None:
               login(request, user)
@@ -40,6 +41,8 @@ def login_user(request):
                      'error_message': 'User not known or wrong password',
                      'podcast_count': podcasts
               })
+      
+
 
 def logout_user(request):
        podcasts = Podcast.objects.count()

commit 65566c4fe2db900cf433ea6b3530016096befd42
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 17 15:09:14 2009 +0100

    redirect to / after successful login

diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 1dfa72e..4b7ac0c 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -1,4 +1,5 @@
 from django.shortcuts import render_to_response
+from django.http import HttpResponseRedirect
 from django.contrib.auth import authenticate, login, logout
 from mygpo.api.models import Podcast
 
@@ -29,11 +30,7 @@ def login_user(request):
        user = authenticate(username=username, password=password)
        if user is not None:
               login(request, user)
-              return render_to_response('home.html', {
-                     'authenticated': True,
-                     'login_message': username,
-                     'podcast_count': podcasts
-              })
+              return HttpResponseRedirect('/')
        else:
               return render_to_response('home.html', {
                      'error': True,
@@ -46,4 +43,4 @@ def logout_user(request):
        logout(request)
        return render_to_response('home.html', {
              'podcast_count': podcasts
-       })
\ No newline at end of file
+       })

commit 8cee3b966220728edd93ea08d6f860534f3e65ee
Author: Martin Wieser <wieser_martin@hotmail.de>
Date:   Tue Nov 17 13:37:59 2009 +0100

    Update 03 Trigger

diff --git a/install/update-03.sql b/install/update-03.sql
new file mode 100644
index 0000000..5c32f2e
--- /dev/null
+++ b/install/update-03.sql
@@ -0,0 +1,46 @@
+
+DROP TRIGGER IF EXISTS subscription_log_trigger;
+
+DELIMITER //
+CREATE TRIGGER subscription_log_trigger BEFORE INSERT ON subscription_log
+FOR EACH ROW
+BEGIN
+	declare help_id INT;
+	set help_id = 0;
+
+	SELECT count(a.user_id) into help_id FROM current_subscription a 
+			where a.device_id = new.device_id
+			and a.podcast_id = new.podcast_id;
+
+	IF new.action = 'subscribe' THEN
+		
+		IF help_id > 0 THEN
+			call Fail('This subscription already exists!');
+		END IF;
+    	ELSE
+    		IF help_id < 1 THEN
+			call Fail('This subscription not exists!');
+		END IF;
+    	END IF;
+
+END;//
+DELIMITER ;
+
+DROP TRIGGER IF EXISTS podcast_trig_url_unique;
+
+DELIMITER //
+CREATE TRIGGER podcast_trig_url_unique BEFORE INSERT ON podcast
+FOR EACH ROW
+BEGIN
+	declare help_url varchar(3000);
+	set help_url = 0;
+  
+   	SELECT count(a.url) into help_url FROM podcast a where a.url=new.url;
+
+	IF help_url > 0 THEN
+		call Fail('This URL already exists!');
+	END IF;
+
+END;//
+DELIMITER ;
+

commit 0f426cee080b93667e25ded6cdea6b6f123b519d
Merge: 114ed89... fe46cbe...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Tue Nov 17 12:33:07 2009 +0000

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit fe46cbefe00e6576d15418e5d88315be13690da2
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Nov 17 13:32:35 2009 +0100

    pyc files deleted

diff --git a/mygpo/api/admin.pyc b/mygpo/api/admin.pyc
deleted file mode 100644
index 3497b3b..0000000
Binary files a/mygpo/api/admin.pyc and /dev/null differ

commit 114ed893f026373c04b3b97f472c7e4f8ec2553f
Merge: c2a5d36... 3c3e175...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Tue Nov 17 12:30:37 2009 +0000

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 3c3e1755c1ee7fbbabf3f11be8dcb37eca04fd3c
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Nov 17 13:28:58 2009 +0100

    login added!
    ^

diff --git a/mygpo/__init__.pyc b/mygpo/__init__.pyc
deleted file mode 100644
index c5e44b5..0000000
Binary files a/mygpo/__init__.pyc and /dev/null differ
diff --git a/mygpo/api/__init__.pyc b/mygpo/api/__init__.pyc
deleted file mode 100644
index af45add..0000000
Binary files a/mygpo/api/__init__.pyc and /dev/null differ
diff --git a/mygpo/api/models.pyc b/mygpo/api/models.pyc
deleted file mode 100644
index 744c6b2..0000000
Binary files a/mygpo/api/models.pyc and /dev/null differ
diff --git a/mygpo/auth_backends.pyc b/mygpo/auth_backends.pyc
deleted file mode 100644
index 3db4744..0000000
Binary files a/mygpo/auth_backends.pyc and /dev/null differ
diff --git a/mygpo/settings.py b/mygpo/settings.py
index 86e17e0..6c6efec 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -83,7 +83,7 @@ INSTALLED_APPS = (
     'django.contrib.sessions',
     'django.contrib.sites',
     'django.contrib.admin',
-  #  'registration',
+    'registration',
     'mygpo.api',
     'mygpo.web'
 )
diff --git a/mygpo/settings.pyc b/mygpo/settings.pyc
deleted file mode 100644
index b6da8ad..0000000
Binary files a/mygpo/settings.pyc and /dev/null differ
diff --git a/mygpo/urls.pyc b/mygpo/urls.pyc
deleted file mode 100644
index b094d02..0000000
Binary files a/mygpo/urls.pyc and /dev/null differ
diff --git a/mygpo/web/__init__.pyc b/mygpo/web/__init__.pyc
deleted file mode 100644
index 77c0260..0000000
Binary files a/mygpo/web/__init__.pyc and /dev/null differ
diff --git a/mygpo/web/models.pyc b/mygpo/web/models.pyc
deleted file mode 100644
index a7a9c80..0000000
Binary files a/mygpo/web/models.pyc and /dev/null differ
diff --git a/mygpo/web/views.pyc b/mygpo/web/views.pyc
deleted file mode 100644
index 9c52a56..0000000
Binary files a/mygpo/web/views.pyc and /dev/null differ

commit daeddf30fdf8bde64b830fdca8bec7d050d0ae49
Author: Armin Muellner <armin.muellner@gmail.com>
Date:   Tue Nov 17 13:24:55 2009 +0100

    Added the login functionality

diff --git a/mygpo/__init__.pyc b/mygpo/__init__.pyc
new file mode 100644
index 0000000..c5e44b5
Binary files /dev/null and b/mygpo/__init__.pyc differ
diff --git a/mygpo/api/__init__.pyc b/mygpo/api/__init__.pyc
new file mode 100644
index 0000000..af45add
Binary files /dev/null and b/mygpo/api/__init__.pyc differ
diff --git a/mygpo/api/admin.pyc b/mygpo/api/admin.pyc
index fa69129..3497b3b 100644
Binary files a/mygpo/api/admin.pyc and b/mygpo/api/admin.pyc differ
diff --git a/mygpo/api/models.pyc b/mygpo/api/models.pyc
new file mode 100644
index 0000000..744c6b2
Binary files /dev/null and b/mygpo/api/models.pyc differ
diff --git a/mygpo/auth_backends.pyc b/mygpo/auth_backends.pyc
new file mode 100644
index 0000000..3db4744
Binary files /dev/null and b/mygpo/auth_backends.pyc differ
diff --git a/mygpo/settings.py b/mygpo/settings.py
index 6c6efec..86e17e0 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -83,7 +83,7 @@ INSTALLED_APPS = (
     'django.contrib.sessions',
     'django.contrib.sites',
     'django.contrib.admin',
-    'registration',
+  #  'registration',
     'mygpo.api',
     'mygpo.web'
 )
diff --git a/mygpo/settings.pyc b/mygpo/settings.pyc
new file mode 100644
index 0000000..b6da8ad
Binary files /dev/null and b/mygpo/settings.pyc differ
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 96442eb..001e087 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -9,6 +9,8 @@ urlpatterns = patterns('',
     # Example:
     # (r'^mygpo/', include('mygpo.foo.urls')),
     (r'^$', 'mygpo.web.views.home'),
+    (r'^login/$', 'mygpo.web.views.login_user'),
+    (r'^logout/$', 'mygpo.web.views.logout_user'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     (r'^upload$', 'mygpo.api.legacy.upload'),
diff --git a/mygpo/urls.pyc b/mygpo/urls.pyc
new file mode 100644
index 0000000..b094d02
Binary files /dev/null and b/mygpo/urls.pyc differ
diff --git a/mygpo/web/__init__.pyc b/mygpo/web/__init__.pyc
new file mode 100644
index 0000000..77c0260
Binary files /dev/null and b/mygpo/web/__init__.pyc differ
diff --git a/mygpo/web/models.pyc b/mygpo/web/models.pyc
new file mode 100644
index 0000000..a7a9c80
Binary files /dev/null and b/mygpo/web/models.pyc differ
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 21016de..9280526 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -70,18 +70,28 @@
 <div style="padding-top: 80px; width:200px; height:70%; margin-right:-58px; padding-bottom: 10px; float:right; background-color: rgb(102, 102, 102); -moz-border-radius-bottomleft: 30px;">
 	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; background-color:rgb(102, 102, 102);">&nbsp;</span>
 	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; -moz-border-radius-topright: 30px; background-color:rgb(255,255,255);">&nbsp;</span>
-	
+	{% if error %}
+	 <p style="margin-left:10px; color:rgb(210,105,30);">{{ error_message }}</p>
+	{% endif %}
+	{% if authenticated %}
+	<p style="margin-left:10px; color:rgb(70%,70%,70%);">logged in as {{ login_message }}<br />
+	<a href="../logout/">logout!</a>
+	</p>
+	{% else %}
 	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%); border:1px solid rgb(70%,70%,70%);">
 		<h2>Login</h2>
+		<form action="../login/" method="post">
 		Username:
 		<input name="user" type="text" />
 		Password:
 		<input name="pwd" type="password" />
 		<input type="submit" value="Login" style="margin-left:90px; margin-top:15px;" />
+		</form>
 	</div>
 	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%);">
 		Not yet a member? <a href="#">Register!</a>
 	</div>
+	{% endif %}
 </div>
 <hr style="clear: both;">
 <address> 2005-2009 <a class="noextlink" href="http://thpinfo.com/">Thomas Perl</a> and
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index ec34b3e..1dfa72e 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -1,9 +1,49 @@
 from django.shortcuts import render_to_response
+from django.contrib.auth import authenticate, login, logout
 from mygpo.api.models import Podcast
 
 def home(request):
-    podcasts = Podcast.objects.count()
-    return render_to_response('home.html', {
-            'podcast_count': podcasts
-        })
+       podcasts = Podcast.objects.count()
+       if request.user.is_authenticated():
+              return render_to_response('home.html', {
+                    'authenticated': True,
+                    'login_message': request.user,
+                    'podcast_count': podcasts
+              })
+       else:
+              return render_to_response('home.html', {
+                    'podcast_count': podcasts
+              })
 
+def login_user(request):
+       podcasts = Podcast.objects.count()
+       try:
+              username = request.POST['user']
+              password = request.POST['pwd']
+       except:
+              return render_to_response('home.html', {
+                     'error': True,
+                     'error_message': 'No user or pwd entered',
+                     'podcast_count': podcasts
+              })
+       user = authenticate(username=username, password=password)
+       if user is not None:
+              login(request, user)
+              return render_to_response('home.html', {
+                     'authenticated': True,
+                     'login_message': username,
+                     'podcast_count': podcasts
+              })
+       else:
+              return render_to_response('home.html', {
+                     'error': True,
+                     'error_message': 'User not known or wrong password',
+                     'podcast_count': podcasts
+              })
+
+def logout_user(request):
+       podcasts = Podcast.objects.count()
+       logout(request)
+       return render_to_response('home.html', {
+             'podcast_count': podcasts
+       })
\ No newline at end of file
diff --git a/mygpo/web/views.pyc b/mygpo/web/views.pyc
new file mode 100644
index 0000000..9c52a56
Binary files /dev/null and b/mygpo/web/views.pyc differ

commit c2a5d36fcdfef6cb5bb7255e6bcec4377bf4f51a
Merge: 668f1a5... 3d38b8e...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Tue Nov 17 10:30:04 2009 +0000

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 3d38b8ed608fb0ae84eb5a60fac1cfe1f6bcf3c2
Author: Armin Mllner <armin@mygpo.thpinfo.com>
Date:   Mon Nov 16 21:56:36 2009 +0100

    .pyc files deleted

diff --git a/mygpo/__init__.pyc b/mygpo/__init__.pyc
deleted file mode 100644
index 6297996..0000000
Binary files a/mygpo/__init__.pyc and /dev/null differ
diff --git a/mygpo/api/__init__.pyc b/mygpo/api/__init__.pyc
deleted file mode 100644
index ed527a0..0000000
Binary files a/mygpo/api/__init__.pyc and /dev/null differ
diff --git a/mygpo/api/models.pyc b/mygpo/api/models.pyc
deleted file mode 100644
index 8354f57..0000000
Binary files a/mygpo/api/models.pyc and /dev/null differ
diff --git a/mygpo/settings.pyc b/mygpo/settings.pyc
deleted file mode 100644
index 66cc9e9..0000000
Binary files a/mygpo/settings.pyc and /dev/null differ
diff --git a/mygpo/urls.pyc b/mygpo/urls.pyc
deleted file mode 100644
index b6ef5c5..0000000
Binary files a/mygpo/urls.pyc and /dev/null differ
diff --git a/mygpo/web/__init__.pyc b/mygpo/web/__init__.pyc
deleted file mode 100644
index 43ac650..0000000
Binary files a/mygpo/web/__init__.pyc and /dev/null differ
diff --git a/mygpo/web/models.pyc b/mygpo/web/models.pyc
deleted file mode 100644
index 62c4170..0000000
Binary files a/mygpo/web/models.pyc and /dev/null differ
diff --git a/mygpo/web/views.pyc b/mygpo/web/views.pyc
deleted file mode 100644
index c770561..0000000
Binary files a/mygpo/web/views.pyc and /dev/null differ

commit 668f1a577514ae27477e55040022de57ca6e8bd2
Merge: 557b480... 144ebd8...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Mon Nov 16 14:27:56 2009 +0000

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 144ebd8d0c3a3993d11341d9153c80a90aeaba7e
Merge: c1dabf7... 37c8a78...
Author: Armin Mllner <armin@mygpo.thpinfo.com>
Date:   Mon Nov 16 10:58:13 2009 +0100

    Merge branch 'master' of /home/stefan/mygpo-src

commit 557b4802c9a8ee98883da6b0a04a5ad66f4ce4c7
Merge: 37c8a78... c1dabf7...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Mon Nov 16 08:26:16 2009 +0000

    Merge branch 'master' of dgpo:~armin/mygpo-src

commit 37c8a78ffdd50636281f61c476076b6a7753e071
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Nov 16 00:22:23 2009 +0100

    add settings, templates for registration (bug 628)

diff --git a/mygpo/settings.py b/mygpo/settings.py
index 8eba613..6c6efec 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -83,10 +83,13 @@ INSTALLED_APPS = (
     'django.contrib.sessions',
     'django.contrib.sites',
     'django.contrib.admin',
+    'registration',
     'mygpo.api',
     'mygpo.web'
 )
 
+ACCOUNT_ACTIVATION_DAYS = 7
+
 AUTHENTICATION_BACKENDS = (
     'mygpo.auth_backends.UserAccountModelBackend',
 )
diff --git a/mygpo/urls.py b/mygpo/urls.py
index ee8f345..96442eb 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -23,6 +23,8 @@ urlpatterns = patterns('',
     # Uncomment the next line to enable the admin:
     (r'^admin/(.*)', admin.site.root),
 
+    (r'^accounts/', include('registration.urls')),
+
     (r'^media/(?P<path>.*)$', 'django.views.static.serve', {'document_root': os.path.abspath('%s/../htdocs/media/' % os.path.dirname(__file__))}),
     
 )
diff --git a/mygpo/web/templates/registration/activate.html b/mygpo/web/templates/registration/activate.html
new file mode 100644
index 0000000..358fd6e
--- /dev/null
+++ b/mygpo/web/templates/registration/activate.html
@@ -0,0 +1,7 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>Account not activated</h1>
+  <p>Your account could not be activated successfully.</p>
+{% endblock %}
+
diff --git a/mygpo/web/templates/registration/activation_complete.html b/mygpo/web/templates/registration/activation_complete.html
new file mode 100644
index 0000000..7696416
--- /dev/null
+++ b/mygpo/web/templates/registration/activation_complete.html
@@ -0,0 +1,7 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>Account activated</h1>
+  <p>Your account has been activated! Enjoy using my.gpodder.org</p>
+{% endblock %}
+
diff --git a/mygpo/web/templates/registration/activation_email.txt b/mygpo/web/templates/registration/activation_email.txt
new file mode 100644
index 0000000..cd8c94d
--- /dev/null
+++ b/mygpo/web/templates/registration/activation_email.txt
@@ -0,0 +1,5 @@
+Click on the link below to activate your account on my.gpodder.org
+
+{{activation_key}}
+
+
diff --git a/mygpo/web/templates/registration/activation_email_subject.txt b/mygpo/web/templates/registration/activation_email_subject.txt
new file mode 100644
index 0000000..a214268
--- /dev/null
+++ b/mygpo/web/templates/registration/activation_email_subject.txt
@@ -0,0 +1 @@
+Activate your Account on my.gpodder.org
diff --git a/mygpo/web/templates/registration/registration_complete.html b/mygpo/web/templates/registration/registration_complete.html
new file mode 100644
index 0000000..89b1373
--- /dev/null
+++ b/mygpo/web/templates/registration/registration_complete.html
@@ -0,0 +1,7 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>Registration complete</h1>
+  <p>Please confirm your account using the email you should just have recieved.</p>
+{% endblock %}
+
diff --git a/mygpo/web/templates/registration/registration_form.html b/mygpo/web/templates/registration/registration_form.html
new file mode 100644
index 0000000..bc7e725
--- /dev/null
+++ b/mygpo/web/templates/registration/registration_form.html
@@ -0,0 +1,12 @@
+{% extends "base.html" %}
+
+{% block content %}
+  <h1>Create a User Account</h1>
+
+  <form action="/contact/" method="POST">
+   {{ form.as_p }}
+   <input type="submit" value="Submit" />
+  </form>
+
+{% endblock %}
+

commit c1dabf7fd08e112d218678e97da5c1df0c211b86
Author: Armin Mllner <armin@mygpo.thpinfo.com>
Date:   Sun Nov 15 22:11:23 2009 +0100

    Added Loginarea to HTML Template

diff --git a/mygpo/__init__.pyc b/mygpo/__init__.pyc
new file mode 100644
index 0000000..6297996
Binary files /dev/null and b/mygpo/__init__.pyc differ
diff --git a/mygpo/api/__init__.pyc b/mygpo/api/__init__.pyc
new file mode 100644
index 0000000..ed527a0
Binary files /dev/null and b/mygpo/api/__init__.pyc differ
diff --git a/mygpo/api/admin.pyc b/mygpo/api/admin.pyc
new file mode 100644
index 0000000..fa69129
Binary files /dev/null and b/mygpo/api/admin.pyc differ
diff --git a/mygpo/api/models.pyc b/mygpo/api/models.pyc
new file mode 100644
index 0000000..8354f57
Binary files /dev/null and b/mygpo/api/models.pyc differ
diff --git a/mygpo/settings.pyc b/mygpo/settings.pyc
new file mode 100644
index 0000000..66cc9e9
Binary files /dev/null and b/mygpo/settings.pyc differ
diff --git a/mygpo/urls.pyc b/mygpo/urls.pyc
new file mode 100644
index 0000000..b6ef5c5
Binary files /dev/null and b/mygpo/urls.pyc differ
diff --git a/mygpo/web/__init__.pyc b/mygpo/web/__init__.pyc
new file mode 100644
index 0000000..43ac650
Binary files /dev/null and b/mygpo/web/__init__.pyc differ
diff --git a/mygpo/web/models.pyc b/mygpo/web/models.pyc
new file mode 100644
index 0000000..62c4170
Binary files /dev/null and b/mygpo/web/models.pyc differ
diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index 66c54da..21016de 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -4,8 +4,9 @@
   <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
   <link rel="shortcut icon" href="http://gpodder.org/favicon.png">
   <style type="text/css">
-      body { font-family: DeJaVu Sans, Bitstream Vera Sans, sans-serif; font-size: 12px; padding-left: 50px; padding-right: 50px;}
-      h3 { color: #535;}
+      	body { font-family: DeJaVu Sans, Bitstream Vera Sans, sans-serif; font-size: 12px; padding-left: 50px; padding-right: 50px;}
+	h2 { margin-top:0px;}
+      	h3 { color: #535;}
         hr { border-width: 0px; border-bottom: 1px #aaa dotted; }
         img { border-width: 0px; }
         ul#gpodder-menu { margin: 10px; padding-top: 10px; z-index: 900; text-align: center; }
@@ -45,7 +46,7 @@
 <h1 style="margin: 0px; padding: 0px; position: absolute; top: 0px; left: 20px; height: 70px; z-index: 100;">
     <strong><img style="padding-top: 10px; width: 64px; height: 64px;" alt="gPodder" title="gPodder" src="http://gpodder.org/images/weblogo64.png"></strong>
 </h1>
-<div style="position: absolute; z-index: 10; top: 0px; left: 0px; right: 0px; background-color: rgb(102, 102, 102); -moz-border-radius-bottomright: 30px; padding-bottom: 10px;">
+<div style="position: absolute; z-index: 10; top: 0px; left: 0px; right: 0px; background-color: rgb(102, 102, 102); padding-bottom: 10px;">
 <ul id="gpodder-menu">
   <li><a href="http://gpodder.org/"><img src="http://gpodder.org/images/icons/go-home.png" alt="">Home</a></li>
   <li><a href="http://gpodder.org/news.html"><img src="http://gpodder.org/images/icons/accessories-text-editor.png" alt="">News</a></li>
@@ -56,7 +57,7 @@
 </ul>
 </div>
 <hr>
-<div style="margin-right: 5%; padding-top: 80px; padding-bottom: 10px;">
+<div style="margin-right: 5%; padding-top: 80px; padding-bottom: 10px; float:left;">
 {% block content %}
     <h1>gPodder Web Service</h1>
     <p>...will go online soon...</p>
@@ -66,6 +67,22 @@
     </ul>
 {% endblock %}
 </div>
+<div style="padding-top: 80px; width:200px; height:70%; margin-right:-58px; padding-bottom: 10px; float:right; background-color: rgb(102, 102, 102); -moz-border-radius-bottomleft: 30px;">
+	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; background-color:rgb(102, 102, 102);">&nbsp;</span>
+	<span style="width:20px; position:absolute; margin-top:-32px; margin-left:-20px; -moz-border-radius-topright: 30px; background-color:rgb(255,255,255);">&nbsp;</span>
+	
+	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%); border:1px solid rgb(70%,70%,70%);">
+		<h2>Login</h2>
+		Username:
+		<input name="user" type="text" />
+		Password:
+		<input name="pwd" type="password" />
+		<input type="submit" value="Login" style="margin-left:90px; margin-top:15px;" />
+	</div>
+	<div style="margin-left:10px; padding:3px; padding-bottom:10px; margin-right:10px; color:rgb(70%,70%,70%);">
+		Not yet a member? <a href="#">Register!</a>
+	</div>
+</div>
 <hr style="clear: both;">
 <address> 2005-2009 <a class="noextlink" href="http://thpinfo.com/">Thomas Perl</a> and
 the gPodder Team</address>
diff --git a/mygpo/web/views.pyc b/mygpo/web/views.pyc
new file mode 100644
index 0000000..c770561
Binary files /dev/null and b/mygpo/web/views.pyc differ

commit 635d6ec91742a50ae8a704fb5e3fedd044ecc3e6
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 15 20:57:11 2009 +0100

    using gpodder.org template as base.html (bug 627)

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
index b7546e8..66c54da 100644
--- a/mygpo/web/templates/base.html
+++ b/mygpo/web/templates/base.html
@@ -1,24 +1,72 @@
-<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
-    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
-<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
-<head>
-    <link rel="stylesheet" href="style.css" />
-    <title>{% block title %}my.gpodder.org{% endblock %}</title>
-</head>
-
-<body>
-    <div id="sidebar">
-        {% block sidebar %}
-        <ul>
-            <li><a href="/">Home</a></li>
-            <li><a href="/info/">Info</a></li>
-        </ul>
-        {% endblock %}
-    </div>
-
-    <div id="content">
-        {% block content %}{% endblock %}
-    </div>
-</body>
-</html>
+<html><head>
 
+  <title>{% block title %}{% endblock %}my.gPodder.org</title>
+  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
+  <link rel="shortcut icon" href="http://gpodder.org/favicon.png">
+  <style type="text/css">
+      body { font-family: DeJaVu Sans, Bitstream Vera Sans, sans-serif; font-size: 12px; padding-left: 50px; padding-right: 50px;}
+      h3 { color: #535;}
+        hr { border-width: 0px; border-bottom: 1px #aaa dotted; }
+        img { border-width: 0px; }
+        ul#gpodder-menu { margin: 10px; padding-top: 10px; z-index: 900; text-align: center; }
+        ul#gpodder-menu li { display: inline; font-weight: bold; padding-right: 4px; margin-bottom: 5px; }
+        ul#gpodder-menu li a { text-decoration: none; color: rgb(70%, 70%, 70%); padding: 6px; border: 1px rgb(40%, 40%, 40%) solid; -moz-border-radius: 5px; }
+        ul#gpodder-menu li a:hover { color: rgb(10%, 10%, 10%); background-color: white; border-bottom: 1px rgb(60%, 60%, 60%) solid;border-right: 1px rgb(40%, 60%, 40%) solid; border-left: 1px rgb(70%, 70%, 70%) solid;border-top: 1px rgb(70%, 70%, 70%) solid; }
+        ul#gpodder-menu li strong { background-color: white; padding: 6px; border-top: 1px solid rgb(60%, 60%, 60%); border-left: 1px solid rgb(60%, 60%, 60%); border-bottom: 1px solid rgb(70%, 70%, 70%); color: black; -moz-border-radius: 5px;}
+        ul#gpodder-menu li img { vertical-align: middle; padding-right: 2px; }
+        a { color: blue; text-decoration: none; }
+        a:hover { text-decoration: underline; }
+        p#version-info { position: absolute; top: 10px; right: 10px; text-align: right; }
+        ul.highlights { padding-left: 10px; list-style-type: none; }
+        ul.highlights strong { font-size: 13pt; } address {font-style: normal; color: #aaa; text-align:center;} address a { color: #aaaaff; }
+        table.downloads td { background-color: #eee; }
+        a[href^="http://"]:after, a[href^="https://"]:after {
+            content: url(http://gpodder.org/images/external.png);
+            padding-left: 2px;
+        }
+        /* ..but not URLs linking to the bug tracker or mygpo */
+        a[href^="http://gpodder.org"]:after, a.noextlink:after,
+          a.imgonlylink:after {
+            content: '';
+            padding-left: 0px;
+        }
+        a[href^="http://bugs.gpodder.org"]:after, a.noextlink:after,
+          a.imgonlylink:after {
+            content: '';
+            padding-left: 0px;
+        }
+        a[href^="http://my.gpodder.org"]:after, a.noextlink:after,
+          a.imgonlylink:after {
+            content: '';
+            padding-left: 0px;
+        }
+    </style>
+</head><body>
+<h1 style="margin: 0px; padding: 0px; position: absolute; top: 0px; left: 20px; height: 70px; z-index: 100;">
+    <strong><img style="padding-top: 10px; width: 64px; height: 64px;" alt="gPodder" title="gPodder" src="http://gpodder.org/images/weblogo64.png"></strong>
+</h1>
+<div style="position: absolute; z-index: 10; top: 0px; left: 0px; right: 0px; background-color: rgb(102, 102, 102); -moz-border-radius-bottomright: 30px; padding-bottom: 10px;">
+<ul id="gpodder-menu">
+  <li><a href="http://gpodder.org/"><img src="http://gpodder.org/images/icons/go-home.png" alt="">Home</a></li>
+  <li><a href="http://gpodder.org/news.html"><img src="http://gpodder.org/images/icons/accessories-text-editor.png" alt="">News</a></li>
+  <li><a href="http://gpodder.org/downloads.html"><img src="http://gpodder.org/images/icons/package-x-generic.png" alt="">Download</a></li>
+  <li><a href="http://gpodder.org/documentation.html"><img src="http://gpodder.org/images/icons/help-browser.png" alt="">Help</a></li>
+  <li><a href="http://bugs.gpodder.org/"><img src="http://gpodder.org/images/icons/dialog-warning.png" alt="">Bugs</a></li>
+  <li><strong><img src="http://gpodder.org/images/icons/mygpo.png" alt="">Web Service</strong></li>
+</ul>
+</div>
+<hr>
+<div style="margin-right: 5%; padding-top: 80px; padding-bottom: 10px;">
+{% block content %}
+    <h1>gPodder Web Service</h1>
+    <p>...will go online soon...</p>
+    <ul>
+        <li><a href="http://gpodder.org/wiki/Web_Services">Wiki page</a></li>
+        <li><a href="toplist.opml">Toplist as OPML</a></li>
+    </ul>
+{% endblock %}
+</div>
+<hr style="clear: both;">
+<address> 2005-2009 <a class="noextlink" href="http://thpinfo.com/">Thomas Perl</a> and
+the gPodder Team</address>
+</body></html>

commit 38241d94d7f883d42727851e94b8e817e89a3b48
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 15 15:35:28 2009 +0100

    using doc-root htdocs and media within (bug 669)

diff --git a/mygpo/settings.py b/mygpo/settings.py
index 01df572..8eba613 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -41,7 +41,7 @@ USE_I18N = True
 
 # Absolute path to the directory that holds media.
 # Example: "/home/media/media.lawrence.com/"
-MEDIA_ROOT = os.path.abspath('%s/../media/' % os.path.dirname(__file__))
+MEDIA_ROOT = os.path.abspath('%s/../htdocs/media/' % os.path.dirname(__file__))
 
 # URL that handles the media served from MEDIA_ROOT. Make sure to use a
 # trailing slash if there is a path component (optional in other cases).
diff --git a/mygpo/urls.py b/mygpo/urls.py
index a663769..ee8f345 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -23,6 +23,6 @@ urlpatterns = patterns('',
     # Uncomment the next line to enable the admin:
     (r'^admin/(.*)', admin.site.root),
 
-    (r'^media/(?P<path>.*)$', 'django.views.static.serve', {'document_root': os.path.abspath('%s/../media/' % os.path.dirname(__file__))}),
+    (r'^media/(?P<path>.*)$', 'django.views.static.serve', {'document_root': os.path.abspath('%s/../htdocs/media/' % os.path.dirname(__file__))}),
     
 )

commit 8d56547de9da8eb119b539356a20b519b9df83de
Merge: 4c519c9... 2cd6c23...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 15 15:29:25 2009 +0100

    Merge branch 'master' of dgpo:~alex/mygpo-src

commit 4c519c9eeeafb2144974af8f670d018659894d8e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 15 15:24:02 2009 +0100

    updated cfg for serving media files (bug 669)
    
    media files are served from media/

diff --git a/mygpo/settings.py b/mygpo/settings.py
index 27b07a3..01df572 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -1,5 +1,7 @@
 # Django settings for mygpo project.
 
+import os.path
+
 # http://code.djangoproject.com/wiki/BackwardsIncompatibleChanges#ChangedthewayURLpathsaredetermined
 FORCE_SCRIPT_NAME=""
 
@@ -39,7 +41,7 @@ USE_I18N = True
 
 # Absolute path to the directory that holds media.
 # Example: "/home/media/media.lawrence.com/"
-MEDIA_ROOT = ''
+MEDIA_ROOT = os.path.abspath('%s/../media/' % os.path.dirname(__file__))
 
 # URL that handles the media served from MEDIA_ROOT. Make sure to use a
 # trailing slash if there is a path component (optional in other cases).
@@ -49,7 +51,7 @@ MEDIA_URL = ''
 # URL prefix for admin media -- CSS, JavaScript and images. Make sure to use a
 # trailing slash.
 # Examples: "http://foo.com/media/", "/media/".
-ADMIN_MEDIA_PREFIX = '/media/'
+ADMIN_MEDIA_PREFIX = '/media/admin/'
 
 # Make this unique, and don't share it with anybody.
 SECRET_KEY = '8s(g1_%+-^@xw*ulzg&gmhj+mp5!m50-p5!721aoai3q67kym!'
diff --git a/mygpo/urls.py b/mygpo/urls.py
index d61f480..a663769 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -1,3 +1,4 @@
+import os.path
 from django.conf.urls.defaults import *
 
 # Uncomment the next two lines to enable the admin:
@@ -21,4 +22,7 @@ urlpatterns = patterns('',
 
     # Uncomment the next line to enable the admin:
     (r'^admin/(.*)', admin.site.root),
+
+    (r'^media/(?P<path>.*)$', 'django.views.static.serve', {'document_root': os.path.abspath('%s/../media/' % os.path.dirname(__file__))}),
+    
 )

commit 2cd6c235f8e4d82f0878e377f181f3f7482c8d3e
Author: Alexander Duml <alexander.duml@gmail.com>
Date:   Sat Nov 14 18:28:02 2009 +0100

    	modified:   mygpo/api/simple.py

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 7dd38cb..d60b99d 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -1,5 +1,6 @@
 from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
+from mygpo.api.models import Device
 
 @require_valid_user()
 def subscriptions(request, username, device, format):
@@ -20,7 +21,8 @@ def subscriptions(request, username, device, format):
 def format_subscriptions(subscriptions, format):
     if format == 'txt':
         #return subscriptions formatted as txt
-        return HttpRequest('', mimetype='text/plain')
+        s = "\n".join(subscriptions)
+        return HttpRequest(s, mimetype='text/plain')
 
     elif format == 'opml':
         e = Exporter(subscriptions)
@@ -31,7 +33,8 @@ def format_subscriptions(subscriptions, format):
 
 def get_subscriptions(device):
     # get and return subscription list from database (use backend to sync)
-    return []
+    d, created = Device.objects.get_or_create(user=user, uid=device.uid, name=device.name, type=device.type)
+    return [p.podcast for p in d.get_subscriptions()]
 
 def parse_subscription(raw_post_data, format):
     if format == 'txt':

commit 40be591128ba90a1a1ea64df7d8236ea36bfd306
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 23:40:06 2009 +0100

    implemented Device syncing
    
    Device.get_subscriptions() does not automatically sync the device

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 32fac84..104bbfd 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -95,8 +95,13 @@ class Device(models.Model):
         return '%s (%s)' % (self.name, self.type)
 
     def get_subscriptions(self):
+        self.sync()
         return Subscription.objects.filter(device=self)
 
+    def sync(self):
+        for s in self.get_sync_actions():
+            SubscriptionAction.objects.create(device=self, podcast=s.podcast, timestamp=s.timestamp, action=s.action)
+
     def get_sync_actions(self):
         """
         returns the SyncGroupSubscriptionActions correspond to the
@@ -104,7 +109,7 @@ class Device(models.Model):
         to synchronize it with its SyncGroup
         """
         all_sync_actions = SyncGroupSubscriptionAction.objects.filter(sync_group=self.sync_group)
-        podcasts = [p.podcast for p in self.get_subscriptions()]
+        podcasts = [p.podcast for p in Subscription.objects.filter(device=self)]
         sync_actions = []
         for s in all_sync_actions:
             a = self.latest_action(s.podcast)

commit 7beace7d23b0772bba4d9f0e7397c60876d59ad5
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 23:39:05 2009 +0100

    bugfixing legacy subscription diff
    
    legacy api diff'ed again subscription on all devices during upload, now it only
    uses the default legacy device

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 1623b1d..4d1e1e2 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -21,7 +21,10 @@ def upload(request):
     if (not user):
         return HttpResponse('@AUTHFAIL', mimetype='text/plain')
 
-    existing = Subscription.objects.filter(user__email__exact=emailaddr)
+    d, created = Device.objects.get_or_create(user=user, uid=LEGACY_DEVICE_UID,
+        defaults = {'type': 'unknown', 'name': LEGACY_DEVICE_NAME})
+
+    existing = Subscription.objects.filter(user=user, device=d)
 
     existing_urls = [e.podcast.url for e in existing]
 
@@ -31,9 +34,6 @@ def upload(request):
     new = [item for item in i.items if item['url'] not in existing_urls]
     rem = [e.podcast for e in existing if e.podcast.url not in podcast_urls]
 
-    d, created = Device.objects.get_or_create(user=user, uid=LEGACY_DEVICE_UID,
-            defaults = {'type': 'unknown', 'name': LEGACY_DEVICE_NAME})
-
     for n in new:
         p, created = Podcast.objects.get_or_create(url=n['url'], defaults={
                 'title' : n['title'],
@@ -56,7 +56,10 @@ def getlist(request):
     if user is None:
         return HttpResponse('@AUTHFAIL', mimetype='text/plain')
 
-    podcasts = [s.podcast for s in Subscription.objects.filter(user=user)]
+    d, created = Device.objects.get_or_create(user=user, uid=LEGACY_DEVICE_UID,
+        defaults = {'type': 'unknown', 'name': LEGACY_DEVICE_NAME})
+
+    podcasts = [s.podcast for s in d.get_subscriptions()]
     exporter = Exporter(filename='')
 
     opml = exporter.generate(podcasts)

commit d6f1e1649e95bbb4cad489d021313bf04bd887df
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 23:38:24 2009 +0100

    OPML Exporter can handle null podcast description

diff --git a/mygpo/api/opml.py b/mygpo/api/opml.py
index 9c24b77..19e5b2b 100644
--- a/mygpo/api/opml.py
+++ b/mygpo/api/opml.py
@@ -118,7 +118,7 @@ class Exporter(object):
         """
         outline = doc.createElement( 'outline')
         outline.setAttribute( 'title', channel.title)
-        outline.setAttribute( 'text', channel.description)
+        outline.setAttribute( 'text', channel.description if channel.description != None else '')
         outline.setAttribute( 'xmlUrl', channel.url)
         outline.setAttribute( 'type', self.FEED_TYPE)
         return outline
@@ -144,7 +144,7 @@ class Exporter(object):
         for channel in channels:
             body.appendChild( self.create_outline( doc, channel))
         opml.appendChild( body)
-        return doc.toprettyxml(encoding='utf-8', indent='    ', newl=os.linesep)       
+        return doc.toprettyxml(encoding='utf-8', indent='    ', newl=os.linesep)
 
     def write( self, channels):
         """

commit 0760e2c55782ce247a80db0a6401dd794cbcee23
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 22:26:09 2009 +0100

    added incomplete synchronisation test

diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
index 2247054..0748e67 100644
--- a/mygpo/api/tests.py
+++ b/mygpo/api/tests.py
@@ -1,11 +1,49 @@
-"""
-This file demonstrates two different styles of tests (one doctest and one
-unittest). These will both pass when you run "manage.py test".
+from django.test import TestCase
+from mygpo.api.models import Device, Podcast, UserAccount, SubscriptionAction
 
-Replace these with more appropriate tests for your application.
-"""
+class SyncTest(TestCase):
+    def test_sync_actions(self):
+        # this test does not yet complete when run as a unit test
+        # because django does not set up the views
+        u  = UserAccount.objects.create(username='u')
+        d1 = Device.objects.create(name='d1', type='other', user=u)
+        d2 = Device.objects.create(name='d2', type='other', user=u)
+        p1 = Podcast.objects.create(title='p1', url='http://p1.com/')
+        p2 = Podcast.objects.create(title='p2', url='http://p2.com/')
+        p3 = Podcast.objects.create(title='p3', url='http://p3.com/')
+        p4 = Podcast.objects.create(title='p4', url='http://p4.com/')
+
+        s1 = SubscriptionAction.objects.create(device=d1, podcast=p1, action='subscribe')
+        s2 = SubscriptionAction.objects.create(device=d2, podcast=p2, action='subscribe')
+        u2 = SubscriptionAction.objects.create(device=d2, podcast=p2, action='unsubscribe')
+        s3 = SubscriptionAction.objects.create(device=d1, podcast=p3, action='subscribe')
+        s3_= SubscriptionAction.objects.create(device=d2, podcast=p3, action='subscribe')
+        s4 = SubscriptionAction.objects.create(device=d2, podcast=p4, action='subscribe')
+        u3 = SubscriptionAction.objects.create(device=d2, podcast=p3, action='unsubscribe')
+
+        d1.sync_with(d2)
+
+        #d1: p1, p3
+        #d2: p4
+
+        sa1 = d1.get_sync_actions()
+        sa2 = d2.get_sync_actions()
+
+        self.assertEqual( len(sa1), 2)
+        self.assertEqual( len(sa2), 1)
+
+        self.assertEqual( sa1[0].device, d2)
+        self.assertEqual( sa1[0].podcast, p4)
+        self.assertEqual( sa1[0].action, 'subscribe')
+
+        self.assertEqual( sa1[1].device, d2)
+        self.assertEqual( sa1[1].podcast, p3)
+        self.assertEqual( sa1[1].action, 'unsubscribe')
+
+        self.assertEqual( sa2[0].device, d1)
+        self.assertEqual( sa2[0].podcast, p1)
+        self.assertEqual( sa2[0].action, 'subscribe')
 
-from django.test import TestCase
 
 class SimpleTest(TestCase):
     def test_basic_addition(self):

commit 169955ee8b94cc41c45e4263898bcb21be319bac
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 22:25:38 2009 +0100

    added default values, null-settings to models

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 0d81350..32fac84 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -1,5 +1,6 @@
 from django.db import models
 from django.contrib.auth.models import User, UserManager
+from datetime import datetime
 import hashlib
 
 EPISODE_ACTION_TYPES = (
@@ -41,7 +42,7 @@ class Podcast(models.Model):
     title = models.CharField(max_length=100)
     description = models.TextField()
     link = models.URLField()
-    last_update = models.DateTimeField()
+    last_update = models.DateTimeField(null=True,blank=True)
     logo_url = models.CharField(max_length=1000)
     
     def subscriptions(self):
@@ -186,7 +187,7 @@ class EpisodeAction(models.Model):
     episode = models.ForeignKey(Episode)
     device = models.ForeignKey(Device)
     action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
-    timestamp = models.DateTimeField()
+    timestamp = models.DateTimeField(default=datetime.now)
     playmark = models.IntegerField()
 
     def __unicode__(self):
@@ -212,7 +213,7 @@ class SubscriptionActionBase(models.Model):
     device = models.ForeignKey(Device)
     podcast = models.ForeignKey(Podcast)
     action = models.CharField(max_length=12, choices=SUBSCRIPTION_ACTION_TYPES)
-    timestamp = models.DateTimeField()
+    timestamp = models.DateTimeField(blank=True, default=datetime.now)
 
     def __unicode__(self):
         return '%s %s %s' % (self.device, self.action, self.podcast)

commit 1ebfd4537b88a80b59f1d48e69357519e20b43e4
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 22:09:07 2009 +0100

    bugfixing synchronisation

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 311f904..0d81350 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -102,12 +102,26 @@ class Device(models.Model):
         SubscriptionActions that need to be saved for the current device
         to synchronize it with its SyncGroup
         """
-        latest_action = SubscriptionAction.objects.all().order_by('-timestamp')[0]
-        all_sync_actions = SyncGroupSubscriptionAction.objects.filter(sync_group=self.sync_group, timestamp__gte=latest_action.timestamp)
-        subscriptions = self.get_subscriptions()
-        sync_actions = [s for s in all_sync_actions if s.device != self and not s.podcast in subscriptions]
+        all_sync_actions = SyncGroupSubscriptionAction.objects.filter(sync_group=self.sync_group)
+        podcasts = [p.podcast for p in self.get_subscriptions()]
+        sync_actions = []
+        for s in all_sync_actions:
+            a = self.latest_action(s.podcast)
+
+            if a != None and s.timestamp <= a.timestamp: continue
+
+            if s.action == 'subscribe' and not s.podcast in podcasts:
+                sync_actions.append(s)
+            elif s.action == 'unsubscribe' and s.podcast in podcasts:
+                sync_actions.append(s)
         return sync_actions
 
+    def latest_action(self, podcast):
+        actions = SubscriptionAction.objects.filter(podcast=podcast,device=self).order_by('-timestamp')
+        if len(actions) == 0:
+            return None
+        else:
+            return actions[0]
 
     def sync_with(self, other):
         """

commit 8077b6034d0f864866ba2d94463bbe3b513ce45c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 21:15:37 2009 +0100

    partially implemented SyncGroups (bug 668)
    
    Devices can now be added to SyncGroup and they can automatically receive SubscriptionActions to sync with their group

diff --git a/install/update-02.sql b/install/update-02.sql
index 7e1e567..f6659af 100644
--- a/install/update-02.sql
+++ b/install/update-02.sql
@@ -11,3 +11,26 @@ CREATE TABLE `sync_group` (
 ALTER TABLE user DROP COLUMN default_device_id;
 ALTER TABLE device ADD COLUMN sync_group_id INT REFERENCES sync_group(id);
 ALTER TABLE device ADD COLUMN `uid` varchar(50) NOT NULL;
+
+-- selects the latest action for each pair (device_id, podcast_id) --
+CREATE VIEW sync_group_subscription_log AS
+    SELECT subscription_log.id AS id, device_id, podcast_id, action, timestamp, sync_group_id
+    FROM subscription_log JOIN device ON device_id = device.id 
+    WHERE timestamp IN (
+        SELECT max(timestamp) 
+        FROM subscription_log 
+        GROUP BY podcast_id, device_id
+    );
+
+CREATE VIEW sync_group_current_subscription AS
+    SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since, sync_group_id
+    FROM (subscription_log a JOIN device b on a.device_id=b.id) JOIN user c on b.user_id=c.user_ptr_id
+    WHERE action='subscribe'
+        AND NOT EXISTS (
+            SELECT id FROM subscription_log
+            WHERE action='unsubscribe'
+                AND device_id=a.device_id
+                AND podcast_id=a.podcast_id
+                AND timestamp > a.timestamp
+        );
+
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index a02263f..311f904 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -76,7 +76,8 @@ class SyncGroup(models.Model):
     user = models.ForeignKey(User)
     
     def __unicode__(self):
-        '%s - %s' % (user, ', '.join(devices = Device.objects.filter(sync_group=self)))
+        devices = [d.name for d in Device.objects.filter(sync_group=self)]
+        return '%s - %s' % (self.user, ', '.join(devices))
              
     class Meta:
         db_table = 'sync_group'
@@ -92,6 +93,77 @@ class Device(models.Model):
     def __unicode__(self):
         return '%s (%s)' % (self.name, self.type)
 
+    def get_subscriptions(self):
+        return Subscription.objects.filter(device=self)
+
+    def get_sync_actions(self):
+        """
+        returns the SyncGroupSubscriptionActions correspond to the
+        SubscriptionActions that need to be saved for the current device
+        to synchronize it with its SyncGroup
+        """
+        latest_action = SubscriptionAction.objects.all().order_by('-timestamp')[0]
+        all_sync_actions = SyncGroupSubscriptionAction.objects.filter(sync_group=self.sync_group, timestamp__gte=latest_action.timestamp)
+        subscriptions = self.get_subscriptions()
+        sync_actions = [s for s in all_sync_actions if s.device != self and not s.podcast in subscriptions]
+        return sync_actions
+
+
+    def sync_with(self, other):
+        """
+        set the device to be synchronized with the other device.
+        this method places them in the same SyncGroup. get_sync_actions() can 
+        then return the SyncGroupSubscriptionActions for brining the device 
+        in sync with its group
+        """
+        if self.user != other.user:
+            raise ValueError('the devices belong to different users')
+
+        if self.sync_group == other.sync_group and self.sync_group != None:
+            return
+
+        if self.sync_group != None:
+            if other.sync_group == None:
+                other.sync_group = self.sync_group
+                other.save
+
+            else:
+                raise ValueError('the devices are in different sync groups')
+
+        else:
+            if other.sync_group == None:
+                g = SyncGroup.objects.create(user=self.user)
+                self.sync_group=g
+                self.save()
+                other.sync_group=g
+                other.save()
+
+            else:
+                self.syn_group = other.sync_group
+                self.save()
+
+    def unsync(self):
+        """
+        stops synchronizing the device
+        this method removes the device from its SyncGroup. If only one
+        device remains in the SyncGroup, it is removed so the device can
+        be used in other groups.
+        """
+        if self.sync_group == None:
+            raise ValueError('the device is not synced')
+
+        g = self.sync_group
+        self.sync_group = None
+        self.save()
+
+        devices = Device.objects.filter(sync_group=g)
+        if devices.count() == 1:
+            d = devices[0]
+            d.sync_group = None
+            d.save()
+
+        g.delete()
+
     class Meta:
         db_table = 'device'
 
@@ -122,7 +194,7 @@ class Subscription(models.Model):
     class Meta:
         db_table = 'current_subscription'
 
-class SubscriptionAction(models.Model):
+class SubscriptionActionBase(models.Model):
     device = models.ForeignKey(Device)
     podcast = models.ForeignKey(Podcast)
     action = models.CharField(max_length=12, choices=SUBSCRIPTION_ACTION_TYPES)
@@ -130,8 +202,23 @@ class SubscriptionAction(models.Model):
 
     def __unicode__(self):
         return '%s %s %s' % (self.device, self.action, self.podcast)
+
+    class Meta:
+        abstract = True
+        unique_together = ('device', 'podcast', 'action', 'timestamp')
+
+class SubscriptionAction(SubscriptionActionBase):
     
     class Meta:
         db_table = 'subscription_log'
-        unique_together = ('device', 'podcast', 'action', 'timestamp')
+
+class SyncGroupSubscriptionAction(SubscriptionActionBase):
+    """ READ ONLY MODEL """
+    sync_group = models.ForeignKey(SyncGroup)
+
+    def save(self, **kwargs):
+        raise NotImplementedError
+
+    class Meta:
+        db_table = 'sync_group_subscription_log'
 

commit 834d67a17ce98771b1dd17fccbc833f7b9bd6669
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 11:56:25 2009 +0100

    added function stubs to simple api

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 4f014f4..7dd38cb 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -1,7 +1,52 @@
 from mygpo.api.basic_auth import require_valid_user
-from django.http import HttpResponse
+from django.http import HttpResponse, HttpResponseBadRequest, HttpResponseForbidden
 
 @require_valid_user()
 def subscriptions(request, username, device, format):
-    return HttpResponse()
+    
+    if request.user.username != username:
+        return HttpResponseForbidden()
 
+    if request.method == 'GET':
+        return format_subscriptions(get_subscriptions(device), format)
+        
+    elif request.method == 'PUT':
+        return set_subscriptions(device, parse_subscription(request.raw_post_data, format))
+
+    else:
+        return HttpResponseBadReqest()
+
+
+def format_subscriptions(subscriptions, format):
+    if format == 'txt':
+        #return subscriptions formatted as txt
+        return HttpRequest('', mimetype='text/plain')
+
+    elif format == 'opml':
+        e = Exporter(subscriptions)
+        return HttpRequest(e.generate(), mimetype='text/xml')
+    
+    elif format == 'json':
+        return JsonRequest(subscriptions)
+
+def get_subscriptions(device):
+    # get and return subscription list from database (use backend to sync)
+    return []
+
+def parse_subscription(raw_post_data, format):
+    if format == 'txt':
+        return []
+
+    elif format == 'opml':
+        i = Importer(content=raw_post_data)
+        return i.items
+
+    elif format == 'json':
+        #deserialize json
+        return []
+
+    else: raise ValueError('unsupported format %s' % format)
+
+def set_subscriptions(device, subscriptions):
+    # save subscriptions in database
+    pass

commit 470642e4e24db84b7402ce09e54ebcf86dbd8b51
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 11:34:47 2009 +0100

    included file formats in simple api urls

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 8a64cb6..4f014f4 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -2,6 +2,6 @@ from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse
 
 @require_valid_user()
-def device_subscription(request, username, device, format):
+def subscriptions(request, username, device, format):
     return HttpResponse()
 
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 063e97a..d61f480 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -13,7 +13,7 @@ urlpatterns = patterns('',
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
  
-    (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>\w+)', 'mygpo.api.simple.device_subscription'),
+    (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>(txt|opml|json))', 'mygpo.api.simple.subscriptions'),
     
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
     # to INSTALLED_APPS to enable admin documentation:

commit 5699e5c5ff0a002399ea42d6f40aae190dac2a31
Merge: f2d53a3... 12ad7cf...
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Fri Nov 13 10:28:55 2009 +0000

    Merge branch 'master' of dgpo:mygpo-src

commit f2d53a3c085d00ace3a93d7cc4d30fca12b7703d
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Fri Nov 13 10:28:23 2009 +0000

    adding mimetype headers to legacy api

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 4f7e2d3..1623b1d 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -15,11 +15,11 @@ def upload(request):
         protocol  = request.POST['protocol']
         opml      = request.FILES['opml'].read()
     except MultiValueDictKeyError:
-        return HttpResponse("@PROTOERROR")
+        return HttpResponse("@PROTOERROR", mimetype='text/plain')
 
     user = auth(emailaddr, password)
     if (not user):
-        return HttpResponse('@AUTHFAIL')
+        return HttpResponse('@AUTHFAIL', mimetype='text/plain')
 
     existing = Subscription.objects.filter(user__email__exact=emailaddr)
 
@@ -46,7 +46,7 @@ def upload(request):
         s = SubscriptionAction(podcast=r, action='unsubscribe', timestamp=datetime.now(), device=d)
         s.save()
 
-    return HttpResponse('@SUCCESS')
+    return HttpResponse('@SUCCESS', mimetype='text/plain')
 
 def getlist(request):
     emailaddr = request.GET.get('username', None)
@@ -54,14 +54,14 @@ def getlist(request):
 
     user = auth(emailaddr, password)
     if user is None:
-        return HttpResponse('@AUTHFAIL')
+        return HttpResponse('@AUTHFAIL', mimetype='text/plain')
 
     podcasts = [s.podcast for s in Subscription.objects.filter(user=user)]
     exporter = Exporter(filename='')
 
     opml = exporter.generate(podcasts)
 
-    return HttpResponse(opml)
+    return HttpResponse(opml, mimetype='text/xml')
 
 def auth(emailaddr, password):
     if emailaddr is None or password is None:

commit 12ad7cf250efe9de19bb8836254452ac697cf953
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 13 11:17:33 2009 +0100

    clearer name for basic auth decorator
    
    renamed the decorator for requiring basic auth from logged_in_or_basicauth to
    require_valid_user

diff --git a/mygpo/api/basic_auth.py b/mygpo/api/basic_auth.py
index 02de7b2..ecb054e 100644
--- a/mygpo/api/basic_auth.py
+++ b/mygpo/api/basic_auth.py
@@ -45,7 +45,7 @@ def view_or_basicauth(view, request, test_func, realm = "", *args, **kwargs):
 
 #############################################################################
 #
-def logged_in_or_basicauth(realm = ""):
+def require_valid_user(realm = ""):
     """
     A simple decorator that requires a user to be logged in. If they are not
     logged in the request is examined for a 'authorization' header.
diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index 2efb6a6..8a64cb6 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -1,7 +1,7 @@
-from mygpo.api.basic_auth import logged_in_or_basicauth
+from mygpo.api.basic_auth import require_valid_user
 from django.http import HttpResponse
 
-@logged_in_or_basicauth
+@require_valid_user()
 def device_subscription(request, username, device, format):
     return HttpResponse()
 

commit b2c4a0bf7604b44d3122294508f7895133415668
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 12 17:46:50 2009 +0100

    removed default_device from simple api

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
index ffe66ce..2efb6a6 100644
--- a/mygpo/api/simple.py
+++ b/mygpo/api/simple.py
@@ -1,10 +1,6 @@
 from mygpo.api.basic_auth import logged_in_or_basicauth
 from django.http import HttpResponse
 
-@logged_in_or_basicauth('my.gpodder.org - Simple API')
-def all_subscriptions(request, username, format):
-    return HttpResponse()
-
 @logged_in_or_basicauth
 def device_subscription(request, username, device, format):
     return HttpResponse()
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 91c4b88..063e97a 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -13,7 +13,6 @@ urlpatterns = patterns('',
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
  
-    (r'^subscriptions/(?P<username>\w+)/default.(?P<format>\w+)', 'mygpo.api.simple.all_subscriptions'),
     (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>\w+)', 'mygpo.api.simple.device_subscription'),
     
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 

commit 3ce519da899b5cd8d87d35aceecb5598eb1fc5c0
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 12 17:42:44 2009 +0100

    legacy api uses device with uid 'legacy' (bug 649)
    
    instead of the removed default_device, the legacy api now uses the device with
    the uid 'legacy'. If no such device exists, it is created

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 4f25a31..4f7e2d3 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -4,7 +4,8 @@ from mygpo.api.models import Subscription, Podcast, UserAccount, SubscriptionAct
 from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
 
-LEGACY_DEVICE='Legacy Device'
+LEGACY_DEVICE_NAME = 'Legacy Device'
+LEGACY_DEVICE_UID  = 'legacy'
 
 def upload(request):
     try:
@@ -30,13 +31,8 @@ def upload(request):
     new = [item for item in i.items if item['url'] not in existing_urls]
     rem = [e.podcast for e in existing if e.podcast.url not in podcast_urls]
 
-    try:
-        d = user.default_device
-    except Device.DoesNotExist:
-        d = Device(user=user, type='other', name=LEGACY_DEVICE)
-        d.save()
-        user.default_device = d
-        user.save()
+    d, created = Device.objects.get_or_create(user=user, uid=LEGACY_DEVICE_UID,
+            defaults = {'type': 'unknown', 'name': LEGACY_DEVICE_NAME})
 
     for n in new:
         p, created = Podcast.objects.get_or_create(url=n['url'], defaults={

commit 2ab27db8bae964b9b9b313da5122f25604ae50ba
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 12 17:30:33 2009 +0100

    fixed typos in update-02.sql

diff --git a/install/update-02.sql b/install/update-02.sql
index efe5559..7e1e567 100644
--- a/install/update-02.sql
+++ b/install/update-02.sql
@@ -4,10 +4,10 @@ ALTER TABLE podcast ADD COLUMN logo_url VARCHAR(1000);
 
 -- Bug 649 --
 CREATE TABLE `sync_group` (
-    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY
+    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY,
     `user_id` integer NOT NULL
-)
+);
 
 ALTER TABLE user DROP COLUMN default_device_id;
-ALTER TABLE device ADD COLUMN sync_group_id REFERENCES sync_group(id);
+ALTER TABLE device ADD COLUMN sync_group_id INT REFERENCES sync_group(id);
 ALTER TABLE device ADD COLUMN `uid` varchar(50) NOT NULL;

commit 0bafad09058821b826475e3767da86c87c59198a
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 12 17:27:24 2009 +0100

    add missing field device.uid

diff --git a/install/update-02.sql b/install/update-02.sql
index 58b1ac0..efe5559 100644
--- a/install/update-02.sql
+++ b/install/update-02.sql
@@ -10,4 +10,4 @@ CREATE TABLE `sync_group` (
 
 ALTER TABLE user DROP COLUMN default_device_id;
 ALTER TABLE device ADD COLUMN sync_group_id REFERENCES sync_group(id);
-
+ALTER TABLE device ADD COLUMN `uid` varchar(50) NOT NULL;

commit 7fef2e234f4f716173b0fa1ee1b064d6b360c38a
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 12 17:15:05 2009 +0100

    replaced default_device with sync-groups (bug 649)

diff --git a/install/update-02.sql b/install/update-02.sql
index 02ef695..58b1ac0 100644
--- a/install/update-02.sql
+++ b/install/update-02.sql
@@ -1,2 +1,13 @@
+
+-- Bug 656 --
 ALTER TABLE podcast ADD COLUMN logo_url VARCHAR(1000);
 
+-- Bug 649 --
+CREATE TABLE `sync_group` (
+    `id` integer AUTO_INCREMENT NOT NULL PRIMARY KEY
+    `user_id` integer NOT NULL
+)
+
+ALTER TABLE user DROP COLUMN default_device_id;
+ALTER TABLE device ADD COLUMN sync_group_id REFERENCES sync_group(id);
+
diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index b14ffb9..1472fa4 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -23,6 +23,9 @@ class UserAccountForm(forms.ModelForm):
         super(UserAccountForm, self).__init__(*args, **kwargs)
         self.fields['default_device'].queryset = Device.objects.filter(user=self.instance)
 
+class SyncGroupAdmin(admin.ModelAdmin):
+    inlines = [DeviceInline]
+
 class UserAccountAdmin(admin.ModelAdmin):
     inlines = [DeviceInline, EpisodeActionInline]
     form = UserAccountForm
@@ -36,6 +39,7 @@ class DeviceAdmin(admin.ModelAdmin):
 
 admin.site.register(UserAccount, UserAccountAdmin)
 admin.site.register(Podcast, PodcastAdmin)
+admin.site.register(SyncGroup, SyncGroupAdmin)
 admin.site.register(Device, DeviceAdmin)
 admin.site.register(Subscription)
 admin.site.register(SubscriptionAction)
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 0ce24ce..a02263f 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -27,7 +27,6 @@ SUBSCRIPTION_ACTION_TYPES = (
 #http://scottbarnham.com/blog/2008/08/21/extending-the-django-user-model-with-inheritance/
 class UserAccount(User):
     public_profile = models.BooleanField()
-    default_device = models.ForeignKey('Device')
 
     objects = UserManager()
 
@@ -43,7 +42,7 @@ class Podcast(models.Model):
     description = models.TextField()
     link = models.URLField()
     last_update = models.DateTimeField()
-    logo_url = models.CharField(1000)
+    logo_url = models.CharField(max_length=1000)
     
     def subscriptions(self):
         return Subscription.objects.filter(podcast=self)
@@ -73,10 +72,22 @@ class Episode(models.Model):
     class Meta:
         db_table = 'episode'
 
+class SyncGroup(models.Model):
+    user = models.ForeignKey(User)
+    
+    def __unicode__(self):
+        '%s - %s' % (user, ', '.join(devices = Device.objects.filter(sync_group=self)))
+             
+    class Meta:
+        db_table = 'sync_group'
+
+
 class Device(models.Model):
     user = models.ForeignKey(User)
+    uid = models.SlugField(max_length=50)
     name = models.CharField(max_length=100)
     type = models.CharField(max_length=10, choices=DEVICE_TYPES)
+    sync_group = models.ForeignKey(SyncGroup, blank=True, null=True)
 
     def __unicode__(self):
         return '%s (%s)' % (self.name, self.type)

commit eac5b95b1f0c5bf04f284e434f480ff3e556ca48
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 12 16:44:45 2009 +0100

    added db init and upate scrict

diff --git a/install/crate-database.sql b/install/crate-database.sql
new file mode 100644
index 0000000..677234a
--- /dev/null
+++ b/install/crate-database.sql
@@ -0,0 +1,194 @@
+DROP TABLE IF EXISTS user;
+CREATE TABLE user (
+    user_ptr_id INT REFERENCES auth_user(id),
+    generated_id TINYINT(1) NOT NULL DEFAULT 0,
+    public_profile TINYINT(1) NOT NULL DEFAULT 1,
+    default_device INT REFERENCES device(id)
+);
+
+DROP TABLE IF EXISTS podcast;
+CREATE TABLE podcast (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    url VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
+    title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+    description TEXT,
+    link VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin,
+    last_update TIMESTAMP DEFAULT 0,
+    logo_url VARCHAR(1000)
+);
+
+DROP TABLE IF EXISTS episode;
+CREATE TABLE episode (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    podcast_id INT REFERENCES podcast (id),
+    url VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
+    title VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
+    description TEXT,
+    link VARCHAR(3000) CHARACTER SET utf8 COLLATE utf8_bin
+);
+
+DROP TABLE IF EXISTS episode_log;
+CREATE TABLE episode_log (
+    user_id INT REFERENCES user (user_ptr_id),
+    episode_id INT REFERENCES episode (id),
+    device_id INT REFERENCES device (id),
+    action ENUM ('download', 'play', 'sync', 'lock', 'delete') NOT NULL,
+    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
+    playmark INT DEFAULT 0,
+    PRIMARY KEY (user_id, episode_id, action, timestamp, device_id)
+);
+
+DROP TABLE IF EXISTS device;
+CREATE TABLE device (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    user_id INT REFERENCES user (user_ptr_id),
+    name VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL,
+    type ENUM ('desktop', 'laptop', 'mobile', 'server', 'other') NOT NULL
+);
+
+DROP TABLE IF EXISTS subscription;
+CREATE TABLE subscription (
+    user_id INT REFERENCES user (user_ptr_id),
+    podcast_id INT REFERENCES podcast (id),
+    public TINYINT(1) NOT NULL DEFAULT 1,
+    PRIMARY KEY (user_id, podcast_id)
+);
+
+DROP TABLE IF EXISTS subscription_log;
+CREATE TABLE subscription_log (
+    id INT PRIMARY KEY AUTO_INCREMENT NOT NULL,
+    device_id INT REFERENCES device (id),
+    podcast_id INT REFERENCES podcast (id),
+    action ENUM ('subscribe', 'unsubscribe') NOT NULL,
+    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
+    UNIQUE (device_id, podcast_id, action, timestamp)
+);
+
+DROP VIEW IF EXISTS current_subscription;
+
+CREATE VIEW current_subscription AS
+	SELECT device_id, podcast_id, c.user_ptr_id AS user_id, a.timestamp as subscribed_since FROM
+		(subscription_log a JOIN device b on a.device_id=b.id) JOIN user c on b.user_id=c.user_ptr_id
+			WHERE action='subscribe' 
+			AND NOT EXISTS (
+				SELECT id FROM subscription_log
+					WHERE action='unsubscribe'
+                    			AND device_id=a.device_id
+					AND podcast_id=a.podcast_id
+                    			AND timestamp > a.timestamp
+				);
+
+DROP TABLE IF EXISTS Error;
+CREATE TABLE Error (                                                                                                         
+          ErrorGID int(10) unsigned NOT NULL auto_increment,                                                                         
+          Message varchar(128) default NULL,                                                                                         
+          Created timestamp NOT NULL default CURRENT_TIMESTAMP,                                         
+          PRIMARY KEY (ErrorGID),                                                                                                   
+          UNIQUE KEY ERROR (Message));
+          
+DELIMITER $$
+DROP PROCEDURE IF EXISTS Fail $$
+CREATE PROCEDURE Fail(_Message VARCHAR(128))
+BEGIN
+  INSERT INTO Error (Message) VALUES (_Message);
+  INSERT INTO Error (Message) VALUES (_Message);
+END;$$
+DELIMITER ;
+
+DELIMITER //
+CREATE TRIGGER podcast_trig_url_unique BEFORE INSERT ON podcast
+FOR EACH ROW
+BEGIN
+	declare help_url varchar(3000);
+	set help_url = null;
+  
+   	SELECT a.url into help_url FROM podcast a where a.url=new.url;
+
+	IF help_url is not null THEN
+		call Fail('This URL already exists!');
+	END IF;
+
+END;//
+DELIMITER ;
+
+DROP TABLE IF EXISTS toplist;
+CREATE TABLE toplist (
+    	podcast_id INT PRIMARY KEY REFERENCES podcast (id),
+    	subscription_count INT NOT NULL DEFAULT 0,
+        INDEX(podcast_id)
+);
+
+DELIMITER $$
+DROP PROCEDURE IF EXISTS update_toplist $$
+CREATE PROCEDURE update_toplist()
+BEGIN
+	DECLARE deadlock INT DEFAULT 0;
+    	DECLARE attempts INT DEFAULT 0;
+
+	try_loop:WHILE (attempts<3) DO
+	BEGIN
+		DECLARE deadlock_detected CONDITION FOR 1213;
+    		DECLARE EXIT HANDLER FOR deadlock_detected
+    			BEGIN
+    				ROLLBACK;
+    				SET deadlock=1;
+    			END;
+    		SET deadlock=0;
+   			
+    		START TRANSACTION;
+			DELETE FROM toplist;
+			INSERT INTO toplist (SELECT a.podcast_id, count(a.podcast_id) as count_subscription 
+				FROM current_subscription a, user b 
+				WHERE b.user_ptr_id = a.user_id
+				AND b.public_profile = 1
+				AND NOT EXISTS (SELECT * FROM subscription 
+							WHERE a.podcast_id=podcast_id
+							AND a.user_id=user_id
+							AND public = 0)
+				AND a.device_id = (SELECT min(device_id) FROM current_subscription 
+								WHERE a.podcast_id=podcast_id
+								AND a.user_id=user_id)
+				group by a.podcast_id order by count_subscription DESC);
+			
+			COMMIT;
+		END;
+		IF deadlock=0 THEN
+    			LEAVE try_loop;
+    		ELSE
+    			SET attempts=attempts+1;
+    		END IF;
+    	END WHILE try_loop;
+
+	IF deadlock=1 THEN
+		call FAIL('Toplist is not updated!');
+	END IF;
+
+END $$
+DELIMITER ;
+
+DELIMITER //
+CREATE TRIGGER subscription_log_trigger BEFORE INSERT ON subscription_log
+FOR EACH ROW
+BEGIN
+	declare help_id INT;
+	set help_id = null;
+
+   	SELECT a.user_id into help_id FROM current_subscription a 
+			where a.device_id = new.device_id
+			and a.podcast_id = new.podcast_id;
+
+	IF new.action = 'subscribe' THEN
+    		IF help_id is not null THEN
+			call Fail('This subscription already exists!');
+		END IF;
+    	ELSE
+    		IF help_id is null THEN
+			call Fail('This subscription not exists!');
+		END IF;
+    	END IF;
+
+END;//
+DELIMITER ;
+
+
+
diff --git a/install/update-02.sql b/install/update-02.sql
new file mode 100644
index 0000000..02ef695
--- /dev/null
+++ b/install/update-02.sql
@@ -0,0 +1,2 @@
+ALTER TABLE podcast ADD COLUMN logo_url VARCHAR(1000);
+

commit 964e1808c64b605c1b18c8f5a81980e07708a8d8
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Thu Nov 12 16:36:50 2009 +0100

    added field for logo-url (bug 656)
    
    added the field Podcast.logo_url and the method Podcast.logo_shortname() that
    returns a string identifying the logo

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 2e740c3..0ce24ce 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -1,5 +1,6 @@
 from django.db import models
 from django.contrib.auth.models import User, UserManager
+import hashlib
 
 EPISODE_ACTION_TYPES = (
         ('download', 'downloaded'),
@@ -42,6 +43,7 @@ class Podcast(models.Model):
     description = models.TextField()
     link = models.URLField()
     last_update = models.DateTimeField()
+    logo_url = models.CharField(1000)
     
     def subscriptions(self):
         return Subscription.objects.filter(podcast=self)
@@ -49,6 +51,9 @@ class Podcast(models.Model):
     def subscription_count(self):
         return self.subscriptions().count()
 
+    def logo_shortname(self):
+        return hashlib.sha1(self.logo_url).hexdigest()
+
     def __unicode__(self):
         return self.title if self.title != '' else self.url
     

commit 94b0b9f3acc73295ef2024058431097cc887a585
Author: Thomas Perl <thp@thpinfo.com>
Date:   Wed Nov 11 20:48:44 2009 +0100

    Add FastCGI script and lighttpd config file

diff --git a/mygpo.fcgi b/mygpo.fcgi
new file mode 100755
index 0000000..64d22ec
--- /dev/null
+++ b/mygpo.fcgi
@@ -0,0 +1,17 @@
+#!/usr/bin/python
+# -*- coding: utf-8 -*-
+# my.gpodder.org FastCGI handler for lighttpd (default setup)
+
+import sys
+import os
+
+# Add this directory as custom Python path
+sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))
+
+# Set the DJANGO_SETTINGS_MODULE environment variable
+os.environ['DJANGO_SETTINGS_MODULE'] = 'mygpo.settings'
+
+# Start the FastCGI server for this application
+from django.core.servers.fastcgi import runfastcgi
+runfastcgi(method='threaded', daemonize='false')
+
diff --git a/mygpo.lighttpd.conf b/mygpo.lighttpd.conf
new file mode 100644
index 0000000..2170fc2
--- /dev/null
+++ b/mygpo.lighttpd.conf
@@ -0,0 +1,37 @@
+#
+# my.gpodder.org configuration file for lighttpd
+#
+# How to setup for lighttpd (on Debian):
+#   - Copy this file to /etc/lighttpd/
+#   - Edit var.mygpo_home and var.mygpo_domain below
+#   - Add the following line to /etc/lighttpd/lighttpd.conf:
+#     include "mygpo.lighttpd.conf"
+#
+# http://iamtgc.com/2007/07/04/django-on-lighttpd-with-fastcgi/
+# http://docs.djangoproject.com/en/dev/howto/deployment/fastcgi/
+#
+
+var.mygpo_home = "/srv/mygpo"
+var.mygpo_domain = "mygpo.thpinfo.com"
+
+$HTTP["host"] == mygpo_domain {
+	server.document-root = mygpo_home + "/htdocs",
+        server.errorlog = mygpo_home + "/logs/error.log",
+        accesslog.filename = mygpo_home + "/logs/access.log",
+        fastcgi.server = (
+		"/mygpo.fcgi" => (
+			"main" => (
+				"bin-path" => mygpo_home + "/mygpo.fcgi",
+				"socket" => "/tmp/mygpo-" + mygpo_domain + ".sock",
+				"check-local" => "disable",
+				"min-procs" => 1,
+				"max-procs" => 1,
+			)
+		)
+	)
+	url.rewrite-once = (
+		"^(/media.*)$" => "$1",
+		"^(/.*)$" => "/mygpo.fcgi$1",
+	)
+}
+

commit 7f0853c92f8566f8a4bfba3ca4fcbed1fbce11b8
Author: Thomas Perl <thp@perli.net>
Date:   Wed Nov 11 20:46:57 2009 +0100

    Fix up settings and urls to work with lighttpd

diff --git a/mygpo/settings.py b/mygpo/settings.py
index 645f7e7..27b07a3 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -1,5 +1,8 @@
 # Django settings for mygpo project.
 
+# http://code.djangoproject.com/wiki/BackwardsIncompatibleChanges#ChangedthewayURLpathsaredetermined
+FORCE_SCRIPT_NAME=""
+
 DEBUG = True
 TEMPLATE_DEBUG = DEBUG
 
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 94f4ae7..91c4b88 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -21,5 +21,5 @@ urlpatterns = patterns('',
     # (r'^admin/doc/', include('django.contrib.admindocs.urls')),
 
     # Uncomment the next line to enable the admin:
-    (r'^admin/', include(admin.site.urls)),
+    (r'^admin/(.*)', admin.site.root),
 )

commit d5c59c6454c2e1bad34551248ee8a23527581d64
Author: Thomas Perl <thp@perli.net>
Date:   Wed Nov 11 20:46:35 2009 +0100

    Fix bugs in the API modules (legacy+opml)

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index f7eede6..4f25a31 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -53,11 +53,11 @@ def upload(request):
     return HttpResponse('@SUCCESS')
 
 def getlist(request):
-    emailaddr = request.GET['username']
-    password  = request.GET['password']
+    emailaddr = request.GET.get('username', None)
+    password = request.GET.get('password', None)
 
     user = auth(emailaddr, password)
-    if (not user):
+    if user is None:
         return HttpResponse('@AUTHFAIL')
 
     podcasts = [s.podcast for s in Subscription.objects.filter(user=user)]
@@ -68,14 +68,16 @@ def getlist(request):
     return HttpResponse(opml)
 
 def auth(emailaddr, password):
+    if emailaddr is None or password is None:
+        return None
 
     try:
         user = UserAccount.objects.get(email__exact=emailaddr)
     except UserAccount.DoesNotExist:
-        return False
+        return None
 
     if not user.check_password(password):
-        return False
+        return None
     
     return user
 
diff --git a/mygpo/api/opml.py b/mygpo/api/opml.py
index 8fefdbe..9c24b77 100644
--- a/mygpo/api/opml.py
+++ b/mygpo/api/opml.py
@@ -80,7 +80,7 @@ class Importer(object):
                 #log( 'OPML import finished, but no items found: %s', url, sender = self)
                 print 'OPML import finished, but no items found: %s' % url
                 pass
-        except Exception as e:
+        except Exception, e:
             #log( 'Cannot import OPML from URL: %s', url, traceback=True, sender = self)
             print 'Cannot import OPML from URL: %s: %s' % (url, e)
             pass

commit 2fe6b9f6260529409cd215a73d18fa7084af9841
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 10 14:22:13 2009 +0100

    legacy api now uses default device from bug 649
    
    The legacy API alway operates on the default device. It the user does not have
    a default device, it is created.

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 01628ca..f7eede6 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -30,7 +30,13 @@ def upload(request):
     new = [item for item in i.items if item['url'] not in existing_urls]
     rem = [e.podcast for e in existing if e.podcast.url not in podcast_urls]
 
-    d, created = Device.objects.get_or_create(user=user, name__exact=LEGACY_DEVICE, defaults={'type': 'other'})
+    try:
+        d = user.default_device
+    except Device.DoesNotExist:
+        d = Device(user=user, type='other', name=LEGACY_DEVICE)
+        d.save()
+        user.default_device = d
+        user.save()
 
     for n in new:
         p, created = Podcast.objects.get_or_create(url=n['url'], defaults={

commit 2e02a85bb2318dfd018c6a3870efc5255c113531
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Nov 9 23:34:11 2009 +0100

    added support for a default device (bug 649)
    
    the UserAccount model now contains a field default_device
    
    On the admin page the default_device can only be set to devices belonging to
    the corresonding user

diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 6384165..b14ffb9 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -1,4 +1,5 @@
 from django.contrib import admin
+from django import forms
 from mygpo.api.models import *
 
 class DeviceInline(admin.TabularInline):
@@ -17,8 +18,14 @@ class SubscriptionActionInline(admin.TabularInline):
     model = SubscriptionAction
     extra = 3
 
+class UserAccountForm(forms.ModelForm):
+    def __init__(self, *args, **kwargs):
+        super(UserAccountForm, self).__init__(*args, **kwargs)
+        self.fields['default_device'].queryset = Device.objects.filter(user=self.instance)
+
 class UserAccountAdmin(admin.ModelAdmin):
     inlines = [DeviceInline, EpisodeActionInline]
+    form = UserAccountForm
 
 class PodcastAdmin(admin.ModelAdmin):
     inlines = [EpisodeInline]
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 0cacc0e..2e740c3 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -26,6 +26,7 @@ SUBSCRIPTION_ACTION_TYPES = (
 #http://scottbarnham.com/blog/2008/08/21/extending-the-django-user-model-with-inheritance/
 class UserAccount(User):
     public_profile = models.BooleanField()
+    default_device = models.ForeignKey('Device')
 
     objects = UserManager()
 

commit 725d7497e7d1b2add88990ff67006d012becdc6e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Nov 9 22:04:04 2009 +0100

    fixing bugs in legacy api

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 1abe9de..01628ca 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -8,14 +8,15 @@ LEGACY_DEVICE='Legacy Device'
 
 def upload(request):
     try:
-        emailaddr = request.GET['username']
-        action    = request.GET['action']
-        protocol  = request.GET['protocol']
+        emailaddr = request.POST['username']
+        password  = request.POST['password']
+        action    = request.POST['action']
+        protocol  = request.POST['protocol']
         opml      = request.FILES['opml'].read()
     except MultiValueDictKeyError:
         return HttpResponse("@PROTOERROR")
 
-    user = auth(request)
+    user = auth(emailaddr, password)
     if (not user):
         return HttpResponse('@AUTHFAIL')
 
@@ -46,8 +47,10 @@ def upload(request):
     return HttpResponse('@SUCCESS')
 
 def getlist(request):
+    emailaddr = request.GET['username']
+    password  = request.GET['password']
 
-    user = auth(request)
+    user = auth(emailaddr, password)
     if (not user):
         return HttpResponse('@AUTHFAIL')
 
@@ -58,9 +61,7 @@ def getlist(request):
 
     return HttpResponse(opml)
 
-def auth(request):
-    emailaddr = request.GET['username']
-    password  = request.GET['password']
+def auth(emailaddr, password):
 
     try:
         user = UserAccount.objects.get(email__exact=emailaddr)

commit 646380c5397363c39ada16d90d59bc5cbf3f5fbf
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 8 15:14:17 2009 +0100

    legacy api now stores podcast information
    
    The legacy API can now podcast information in the database when
    it receives a subscription of an unknown podcast

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 81f0132..1abe9de 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -32,7 +32,10 @@ def upload(request):
     d, created = Device.objects.get_or_create(user=user, name__exact=LEGACY_DEVICE, defaults={'type': 'other'})
 
     for n in new:
-        p, created = Podcast.objects.get_or_create(url=n['url'])
+        p, created = Podcast.objects.get_or_create(url=n['url'], defaults={
+                'title' : n['title'],
+                'description': n['description'],
+                'last_update': datetime.now() })
         s = SubscriptionAction(podcast=p,action='subscribe', timestamp=datetime.now(), device=d)
         s.save()
 

commit cc05128b4b2e935fccc9cca237e80336802729f0
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 8 15:07:58 2009 +0100

    implemented legacy /getlist (bug 647)

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 99bdc3e..81f0132 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -1,5 +1,5 @@
 from django.http import HttpResponse
-from mygpo.api.opml import Importer
+from mygpo.api.opml import Importer, Exporter
 from mygpo.api.models import Subscription, Podcast, UserAccount, SubscriptionAction, Device
 from datetime import datetime
 from django.utils.datastructures import MultiValueDictKeyError
@@ -43,11 +43,17 @@ def upload(request):
     return HttpResponse('@SUCCESS')
 
 def getlist(request):
-    if (not auth(request)):
+
+    user = auth(request)
+    if (not user):
         return HttpResponse('@AUTHFAIL')
 
-    # build and send list
+    podcasts = [s.podcast for s in Subscription.objects.filter(user=user)]
+    exporter = Exporter(filename='')
+
+    opml = exporter.generate(podcasts)
 
+    return HttpResponse(opml)
 
 def auth(request):
     emailaddr = request.GET['username']

commit 204d27bbe1073c9ba646918e7f97a54988f704b3
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 8 15:07:37 2009 +0100

    added Subscription.subscriebed_since

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 1e669a5..0cacc0e 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -97,6 +97,7 @@ class Subscription(models.Model):
     device = models.ForeignKey(Device, primary_key=True)
     podcast = models.ForeignKey(Podcast)
     user = models.ForeignKey(UserAccount)
+    subscribed_since = models.DateTimeField()
 
     def __unicode__(self):
         return '%s - %s on %s' % (self.device.user, self.podcast, self.device)

commit f50983daebff3c2060928d5da9890462ef518d2e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 8 15:07:04 2009 +0100

    updated OPML file title

diff --git a/mygpo/api/opml.py b/mygpo/api/opml.py
index 77aa9b7..8fefdbe 100644
--- a/mygpo/api/opml.py
+++ b/mygpo/api/opml.py
@@ -95,7 +95,7 @@ class Exporter(object):
 
     FEED_TYPE = 'rss'
 
-    def __init__( self, filename):
+    def __init__( self, filename=''):
         if filename.endswith( '.opml') or filename.endswith( '.xml'):
             self.filename = filename
         else:
@@ -136,7 +136,7 @@ class Exporter(object):
         doc.appendChild(opml)
 
         head = doc.createElement( 'head')
-        head.appendChild( self.create_node( doc, 'title', 'gPodder subscriptions'))
+        head.appendChild( self.create_node( doc, 'title', 'my.gpodder.org Subscriptions'))
         head.appendChild( self.create_node( doc, 'dateCreated', formatdate(localtime=True)))
         opml.appendChild( head)
 

commit 3edb7c2083412055210a5e0a86d60dfa585ca2d3
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 8 13:46:22 2009 +0100

    implemented legacy api upload (bug 647)

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index fbe352f..99bdc3e 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -1,48 +1,43 @@
 from django.http import HttpResponse
 from mygpo.api.opml import Importer
-from mygpo.api.models import Subscription, Podcast, UserAccount
+from mygpo.api.models import Subscription, Podcast, UserAccount, SubscriptionAction, Device
+from datetime import datetime
+from django.utils.datastructures import MultiValueDictKeyError
 
-def upload(request):
-    emailaddr = request.GET['username']
-    action    = request.GET['action']
-    protocol  = request.GET['protocol']
-    opml_file = request.FILES['opml']
-    opml      = opml_file.read()
-    
-    if (not auth(request)):
-        return HttpResponse('@AUTHFAIL')
+LEGACY_DEVICE='Legacy Device'
 
+def upload(request):
     try:
-        existing = Subscription.objects.get(user__email__exact=emailaddr)
-    except Subscription.DoesNotExist:
-        existing = []
+        emailaddr = request.GET['username']
+        action    = request.GET['action']
+        protocol  = request.GET['protocol']
+        opml      = request.FILES['opml'].read()
+    except MultiValueDictKeyError:
+        return HttpResponse("@PROTOERROR")
+
+    user = auth(request)
+    if (not user):
+        return HttpResponse('@AUTHFAIL')
 
-    print existing
+    existing = Subscription.objects.filter(user__email__exact=emailaddr)
 
     existing_urls = [e.podcast.url for e in existing]
 
-    print existing_urls
-    
-    i = Importer(content=request.raw_post_data)
-    podcasts = i.items
+    i = Importer(content=opml)
+    podcast_urls = [p['url'] for p in i.items]
 
     new = [item for item in i.items if item['url'] not in existing_urls]
-    rem = [e.podcast for e in existing if e.podcast.url not in i.items]
+    rem = [e.podcast for e in existing if e.podcast.url not in podcast_urls]
 
-    print new
-    print rem
+    d, created = Device.objects.get_or_create(user=user, name__exact=LEGACY_DEVICE, defaults={'type': 'other'})
 
     for n in new:
-        try:
-            p = Podcast.objects.get(url__exact=n['url'])
-        except Podcast.DoesNotExist:
-            p = Podcast(url=n['url'])
-            p.save()
-        s = SubscriptionAction(podcast=p,action='subscribe', timestamp=now())
+        p, created = Podcast.objects.get_or_create(url=n['url'])
+        s = SubscriptionAction(podcast=p,action='subscribe', timestamp=datetime.now(), device=d)
         s.save()
 
-    for p in rem:
-        s = SubscriptionAction(podcast=p, action='unsubscribe', timestamp=now())
+    for r in rem:
+        s = SubscriptionAction(podcast=r, action='unsubscribe', timestamp=datetime.now(), device=d)
         s.save()
 
     return HttpResponse('@SUCCESS')

commit 6abc2553c2422682d7da895a8794a86d279a0e27
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 8 13:43:12 2009 +0100

    primary key id in SubscriptionAction
    
    using automatic primary key in SubscriptionAction because
    Django currently can't handle multi-column primary keys
    
    http://code.djangoproject.com/ticket/373

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index ace54c0..1e669a5 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -49,7 +49,7 @@ class Podcast(models.Model):
         return self.subscriptions().count()
 
     def __unicode__(self):
-        return self.title
+        return self.title if self.title != '' else self.url
     
     class Meta:
         db_table = 'podcast'
@@ -105,7 +105,7 @@ class Subscription(models.Model):
         db_table = 'current_subscription'
 
 class SubscriptionAction(models.Model):
-    device = models.ForeignKey(Device, primary_key=True)
+    device = models.ForeignKey(Device)
     podcast = models.ForeignKey(Podcast)
     action = models.CharField(max_length=12, choices=SUBSCRIPTION_ACTION_TYPES)
     timestamp = models.DateTimeField()
@@ -115,4 +115,5 @@ class SubscriptionAction(models.Model):
     
     class Meta:
         db_table = 'subscription_log'
+        unique_together = ('device', 'podcast', 'action', 'timestamp')
 

commit 8b16b50e0434a27ce5756cb3949584747d206e57
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 21:29:25 2009 +0100

    partially implemented legacy upload

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index 8410821..fbe352f 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -1,20 +1,55 @@
-# Create your views here.
+from django.http import HttpResponse
+from mygpo.api.opml import Importer
+from mygpo.api.models import Subscription, Podcast, UserAccount
 
 def upload(request):
+    emailaddr = request.GET['username']
     action    = request.GET['action']
     protocol  = request.GET['protocol']
     opml_file = request.FILES['opml']
     opml      = opml_file.read()
     
-    if !auth(request):
-        #@AUTHFAIL
+    if (not auth(request)):
+        return HttpResponse('@AUTHFAIL')
+
+    try:
+        existing = Subscription.objects.get(user__email__exact=emailaddr)
+    except Subscription.DoesNotExist:
+        existing = []
+
+    print existing
+
+    existing_urls = [e.podcast.url for e in existing]
+
+    print existing_urls
     
-    #read podcasts
+    i = Importer(content=request.raw_post_data)
+    podcasts = i.items
+
+    new = [item for item in i.items if item['url'] not in existing_urls]
+    rem = [e.podcast for e in existing if e.podcast.url not in i.items]
+
+    print new
+    print rem
+
+    for n in new:
+        try:
+            p = Podcast.objects.get(url__exact=n['url'])
+        except Podcast.DoesNotExist:
+            p = Podcast(url=n['url'])
+            p.save()
+        s = SubscriptionAction(podcast=p,action='subscribe', timestamp=now())
+        s.save()
+
+    for p in rem:
+        s = SubscriptionAction(podcast=p, action='unsubscribe', timestamp=now())
+        s.save()
 
+    return HttpResponse('@SUCCESS')
 
 def getlist(request):
-    if !auth(request):
-        #@AUTHFAIL
+    if (not auth(request)):
+        return HttpResponse('@AUTHFAIL')
 
     # build and send list
 
@@ -23,12 +58,13 @@ def auth(request):
     emailaddr = request.GET['username']
     password  = request.GET['password']
 
-    user = UserAccount.objects.get(email__exact=emailaddr)
-    if !user:
-        return false
+    try:
+        user = UserAccount.objects.get(email__exact=emailaddr)
+    except UserAccount.DoesNotExist:
+        return False
 
-    if !user.check_password(password):
-        return false
+    if not user.check_password(password):
+        return False
     
     return user
 

commit db3dfe8e0ad14026c34370efe7beb1a9c534317a
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 21:29:03 2009 +0100

    added user field to Subscription model

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 3c3058a..ace54c0 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -96,6 +96,7 @@ class EpisodeAction(models.Model):
 class Subscription(models.Model):
     device = models.ForeignKey(Device, primary_key=True)
     podcast = models.ForeignKey(Podcast)
+    user = models.ForeignKey(UserAccount)
 
     def __unicode__(self):
         return '%s - %s on %s' % (self.device.user, self.podcast, self.device)

commit b2224f835ca95951fb95b750cb9d82e61397ba2c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 21:28:41 2009 +0100

    added util.py with get_free_disk_space()

diff --git a/mygpo/api/util.py b/mygpo/api/util.py
new file mode 100644
index 0000000..3414ae8
--- /dev/null
+++ b/mygpo/api/util.py
@@ -0,0 +1,16 @@
+def get_free_disk_space(path):
+    """
+    Calculates the free disk space available to the current user
+    on the file system that contains the given path.
+
+    If the path (or its parent folder) does not yet exist, this
+    function returns zero.
+    """
+
+    if not os.path.exists(path):
+        return 0
+
+    s = os.statvfs(path)
+
+    return s.f_bavail * s.f_bsize
+

commit 8d4303eaf54d0b29da19459e1101beff6e0779b4
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 21:27:55 2009 +0100

    removing db password from settings

diff --git a/mygpo/settings.py b/mygpo/settings.py
index 0ec3ed6..645f7e7 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -13,7 +13,7 @@ MANAGERS = ADMINS
 DATABASE_ENGINE = 'mysql'           # 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.
 DATABASE_NAME = 'mygpo'             # Or path to database file if using sqlite3.
 DATABASE_USER = 'mygpo'             # Not used with sqlite3.
-DATABASE_PASSWORD = 'mygpo'         # Not used with sqlite3.
+DATABASE_PASSWORD = ''         # Not used with sqlite3.
 DATABASE_HOST = ''             # Set to empty string for localhost. Not used with sqlite3.
 DATABASE_PORT = ''             # Set to empty string for default. Not used with sqlite3.
 

commit 862374507a470c96b2ac1aa1e86497494898e39c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 21:27:20 2009 +0100

    added SubscriptionAction to admin.py for debugging

diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 8e231dc..6384165 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -31,3 +31,4 @@ admin.site.register(UserAccount, UserAccountAdmin)
 admin.site.register(Podcast, PodcastAdmin)
 admin.site.register(Device, DeviceAdmin)
 admin.site.register(Subscription)
+admin.site.register(SubscriptionAction)

commit 4309ea5cb5f85420e804ea50819234a4cd950e7b
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 21:26:45 2009 +0100

    fixed typo in urls.py

diff --git a/mygpo/urls.py b/mygpo/urls.py
index a2db465..94f4ae7 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -14,7 +14,7 @@ urlpatterns = patterns('',
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
  
     (r'^subscriptions/(?P<username>\w+)/default.(?P<format>\w+)', 'mygpo.api.simple.all_subscriptions'),
-    (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>\w+)', 'mygpo.api.simple.device_subscriptions'),
+    (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>\w+)', 'mygpo.api.simple.device_subscription'),
     
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
     # to INSTALLED_APPS to enable admin documentation:

commit 7c4f8b1d4cb0d273bec3c564d8bbe6d1874aac4c
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 21:26:04 2009 +0100

    added modified version of gPodders opml library

diff --git a/mygpo/api/opml.py b/mygpo/api/opml.py
new file mode 100644
index 0000000..77aa9b7
--- /dev/null
+++ b/mygpo/api/opml.py
@@ -0,0 +1,182 @@
+# -*- coding: utf-8 -*-
+#
+#
+#
+#  based on: gPodder's opml.py (2007-08-19)
+#            libopmlreader.py (2006-06-13)
+#            libopmlwriter.py (2005-12-08)
+#
+
+"""OPML import and export functionality
+
+This module contains helper classes to import subscriptions 
+from OPML files on the web and to export a list of channel 
+objects to valid OPML 1.1 files.
+"""
+
+from mygpo.api import util
+
+import xml.dom.minidom
+
+import urllib
+import urllib2
+import os.path
+import os
+import platform
+import shutil
+
+from email.Utils import formatdate
+
+
+class Importer(object):
+    """
+    Helper class to import an OPML feed from protocols
+    supported by urllib2 (e.g. HTTP) and return a GTK 
+    ListStore that can be displayed in the GUI.
+
+    This class should support standard OPML feeds and
+    contains workarounds to support odeo.com feeds.
+    """
+
+    VALID_TYPES = ( 'rss', 'link' )
+    USER_AGENT = 'my.gpodder.org'
+
+    def read_url( self, url):
+        request = urllib2.Request( url, headers = {'User-agent': self.USER_AGENT})
+        return urllib2.urlopen( request).read()
+
+    def __init__( self, url='', content=''):
+        """
+        Parses the OPML feed from the given URL into 
+        a local data structure containing channel metadata.
+        """
+        self.items = []
+        try:
+            if content != '':
+                doc = xml.dom.minidom.parseString(content)
+            elif os.path.exists(url):
+                doc = xml.dom.minidom.parse(url)
+            else:
+                doc = xml.dom.minidom.parseString(self.read_url(url))
+
+            for outline in doc.getElementsByTagName('outline'):
+                if outline.getAttribute('type') in self.VALID_TYPES and outline.getAttribute('xmlUrl') or outline.getAttribute('url'):
+                    channel = {
+                        'url': outline.getAttribute('xmlUrl') or outline.getAttribute('url'),
+                        'title': outline.getAttribute('title') or outline.getAttribute('text') or outline.getAttribute('xmlUrl') or outline.getAttribute('url'),
+                        'description': outline.getAttribute('text') or outline.getAttribute('xmlUrl') or outline.getAttribute('url'),
+                    }
+
+                    if channel['description'] == channel['title']:
+                        channel['description'] = channel['url']
+
+                    for attr in ( 'url', 'title', 'description' ):
+                        channel[attr] = channel[attr].strip()
+
+                    self.items.append( channel)
+                else:
+                    print 'wrong type'
+            if not len(self.items):
+                #log( 'OPML import finished, but no items found: %s', url, sender = self)
+                print 'OPML import finished, but no items found: %s' % url
+                pass
+        except Exception as e:
+            #log( 'Cannot import OPML from URL: %s', url, traceback=True, sender = self)
+            print 'Cannot import OPML from URL: %s: %s' % (url, e)
+            pass
+
+class Exporter(object):
+    """
+    Helper class to export a list of channel objects
+    to a local file in OPML 1.1 format.
+
+    See www.opml.org for the OPML specification.
+    """
+
+    FEED_TYPE = 'rss'
+
+    def __init__( self, filename):
+        if filename.endswith( '.opml') or filename.endswith( '.xml'):
+            self.filename = filename
+        else:
+            self.filename = '%s.opml' % ( filename, )
+
+    def create_node( self, doc, name, content):
+        """
+        Creates a simple XML Element node in a document 
+        with tag name "name" and text content "content", 
+        as in <name>content</name> and returns the element.
+        """
+        node = doc.createElement( name)
+        node.appendChild( doc.createTextNode( content))
+        return node
+
+    def create_outline( self, doc, channel):
+        """
+        Creates a OPML outline as XML Element node in a
+        document for the supplied channel.
+        """
+        outline = doc.createElement( 'outline')
+        outline.setAttribute( 'title', channel.title)
+        outline.setAttribute( 'text', channel.description)
+        outline.setAttribute( 'xmlUrl', channel.url)
+        outline.setAttribute( 'type', self.FEED_TYPE)
+        return outline
+
+    def generate( self, channels):
+        """
+        Creates a XML document containing metadata for each 
+        channel object in the "channels" parameter, which 
+        should be a list of channel objects.
+        """
+        doc = xml.dom.minidom.Document()
+
+        opml = doc.createElement('opml')
+        opml.setAttribute('version', '2.0')
+        doc.appendChild(opml)
+
+        head = doc.createElement( 'head')
+        head.appendChild( self.create_node( doc, 'title', 'gPodder subscriptions'))
+        head.appendChild( self.create_node( doc, 'dateCreated', formatdate(localtime=True)))
+        opml.appendChild( head)
+
+        body = doc.createElement( 'body')
+        for channel in channels:
+            body.appendChild( self.create_outline( doc, channel))
+        opml.appendChild( body)
+        return doc.toprettyxml(encoding='utf-8', indent='    ', newl=os.linesep)       
+
+    def write( self, channels):
+        """
+        Creates a XML document containing metadata for each 
+        channel object in the "channels" parameter, which 
+        should be a list of channel objects.
+
+        OPML 2.0 specification: http://www.opml.org/spec2
+
+        Returns True on success or False when there was an 
+        error writing the file.
+        """
+        data = self.generate( self, channels)
+
+        try:
+            # We want to have at least 512 KiB free disk space after
+            # saving the opml data, if this is not possible, don't 
+            # try to save the new file, but keep the old one so we
+            # don't end up with a clobbed, empty opml file.
+            FREE_DISK_SPACE_AFTER = 1024*512
+            available = util.get_free_disk_space(os.path.dirname(self.filename))
+            if available < 2*len(data)+FREE_DISK_SPACE_AFTER:
+                # FIXME: get_free_disk_space still unimplemented for win32
+                #log('Not enough free disk space to save channel list to %s', self.filename, sender = self)
+                return False
+            fp = open(self.filename+'.tmp', 'w')
+            fp.write(data)
+            fp.close()
+            os.rename(self.filename+'.tmp', self.filename)
+        except:
+            #log('Could not open file for writing: %s', self.filename, sender=self, traceback=True)
+            return False
+
+        return True
+

commit ab24009d7469685c043c7aa853c28bc23f3cc1cc
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 18:12:44 2009 +0100

    reordered model definition

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 074cbf7..3c3058a 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -67,6 +67,17 @@ class Episode(models.Model):
     class Meta:
         db_table = 'episode'
 
+class Device(models.Model):
+    user = models.ForeignKey(User)
+    name = models.CharField(max_length=100)
+    type = models.CharField(max_length=10, choices=DEVICE_TYPES)
+
+    def __unicode__(self):
+        return '%s (%s)' % (self.name, self.type)
+
+    class Meta:
+        db_table = 'device'
+
 class EpisodeAction(models.Model):
     user = models.ForeignKey(User, primary_key=True)
     episode = models.ForeignKey(Episode)
@@ -81,16 +92,6 @@ class EpisodeAction(models.Model):
     class Meta:
         db_table = 'episode_log'
 
-class Device(models.Model):
-    user = models.ForeignKey(User)
-    name = models.CharField(max_length=100)
-    type = models.CharField(max_length=10, choices=DEVICE_TYPES)
-
-    def __unicode__(self):
-        return '%s (%s)' % (self.name, self.type)
-    
-    class Meta:
-        db_table = 'device'
 
 class Subscription(models.Model):
     device = models.ForeignKey(Device, primary_key=True)

commit 70bd06ba288acf8747a1fb5163a0eb1fed32b06f
Author: Stefan Kgl <stefan@stefan-dell.(none)>
Date:   Sat Nov 7 16:26:27 2009 +0100

    added new episode_log fields to model (bug 644)
    
    I've added the new db fields episode_log.device_id and
    episode_log.playmark to the model EpisodeAction

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 3455c46..074cbf7 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -70,8 +70,10 @@ class Episode(models.Model):
 class EpisodeAction(models.Model):
     user = models.ForeignKey(User, primary_key=True)
     episode = models.ForeignKey(Episode)
+    device = models.ForeignKey(Device)
     action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
     timestamp = models.DateTimeField()
+    playmark = models.IntegerField()
 
     def __unicode__(self):
         return '%s %s %s' % self.user, self.action, self.episode

commit 50a28d6d7ffaddd400ed709c70e90b4288903423
Merge: ddb0747... 6e419a3...
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 16:17:56 2009 +0100

    Merge branch 'master' of dgpo:mygpo-src

commit ddb0747319ef92114986acbbe5288d6c7b62eac4
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 16:16:48 2009 +0100

    added simple api stubs, w/ basic auth (bug 639)

diff --git a/mygpo/api/simple.py b/mygpo/api/simple.py
new file mode 100644
index 0000000..ffe66ce
--- /dev/null
+++ b/mygpo/api/simple.py
@@ -0,0 +1,11 @@
+from mygpo.api.basic_auth import logged_in_or_basicauth
+from django.http import HttpResponse
+
+@logged_in_or_basicauth('my.gpodder.org - Simple API')
+def all_subscriptions(request, username, format):
+    return HttpResponse()
+
+@logged_in_or_basicauth
+def device_subscription(request, username, device, format):
+    return HttpResponse()
+
diff --git a/mygpo/settings.py b/mygpo/settings.py
index 1a88594..0ec3ed6 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -83,8 +83,7 @@ INSTALLED_APPS = (
 )
 
 AUTHENTICATION_BACKENDS = (
-    'mygpo.UserAccountModelBackend',
+    'mygpo.auth_backends.UserAccountModelBackend',
 )
 
-CUSTOM_USER_MODEL = 'mygpo.api.models.CustomUser'
-
+CUSTOM_USER_MODEL = 'api.UserAccount'
diff --git a/mygpo/urls.py b/mygpo/urls.py
index d584932..a2db465 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -12,6 +12,9 @@ urlpatterns = patterns('',
 
     (r'^upload$', 'mygpo.api.legacy.upload'),
     (r'^getlist$', 'mygpo.api.legacy.getlist'),
+ 
+    (r'^subscriptions/(?P<username>\w+)/default.(?P<format>\w+)', 'mygpo.api.simple.all_subscriptions'),
+    (r'^subscriptions/(?P<username>\w+)/(?P<device>\w+).(?P<format>\w+)', 'mygpo.api.simple.device_subscriptions'),
     
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
     # to INSTALLED_APPS to enable admin documentation:

commit 01dd73eb552e331849c15caa5963e39f41290c7b
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 16:15:44 2009 +0100

    simplified authentication in legacy api (bug 647)

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
index a83163c..8410821 100644
--- a/mygpo/api/legacy.py
+++ b/mygpo/api/legacy.py
@@ -1,34 +1,34 @@
 # Create your views here.
 
 def upload(request):
-    emailaddr = request.GET['username']
-    password  = request.GET['password']
     action    = request.GET['action']
     protocol  = request.GET['protocol']
     opml_file = request.FILES['opml']
     opml      = opml_file.read()
     
-    user = UserAccount.objects.get(email__exact=emailaddr)
-    if !user:
+    if !auth(request):
         #@AUTHFAIL
     
-    if !user.check_password(password):
-        #@AUTHFAIL
-
     #read podcasts
 
 
 def getlist(request):
+    if !auth(request):
+        #@AUTHFAIL
+
+    # build and send list
+
+
+def auth(request):
     emailaddr = request.GET['username']
     password  = request.GET['password']
 
     user = UserAccount.objects.get(email__exact=emailaddr)
     if !user:
-        #@AUTHFAIL
+        return false
 
     if !user.check_password(password):
-        #@AUTHFAIL
-
-    # build and send list
+        return false
+    
+    return user
 
-   

commit 725558f6f27703d84783ea7d5c0ce0407252adc6
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sat Nov 7 16:15:07 2009 +0100

    added decorator for basic auth

diff --git a/mygpo/api/basic_auth.py b/mygpo/api/basic_auth.py
index 0338482..02de7b2 100644
--- a/mygpo/api/basic_auth.py
+++ b/mygpo/api/basic_auth.py
@@ -43,3 +43,65 @@ def view_or_basicauth(view, request, test_func, realm = "", *args, **kwargs):
     response['WWW-Authenticate'] = 'Basic realm="%s"' % realm
     return response
 
+#############################################################################
+#
+def logged_in_or_basicauth(realm = ""):
+    """
+    A simple decorator that requires a user to be logged in. If they are not
+    logged in the request is examined for a 'authorization' header.
+
+    If the header is present it is tested for basic authentication and
+    the user is logged in with the provided credentials.
+
+    If the header is not present a http 401 is sent back to the
+    requestor to provide credentials.
+
+    The purpose of this is that in several django projects I have needed
+    several specific views that need to support basic authentication, yet the
+    web site as a whole used django's provided authentication.
+
+    The uses for this are for urls that are access programmatically such as
+    by rss feed readers, yet the view requires a user to be logged in. Many rss
+    readers support supplying the authentication credentials via http basic
+    auth (and they do NOT support a redirect to a form where they post a
+    username/password.)
+
+    Use is simple:
+
+    @logged_in_or_basicauth
+    def your_view:
+        ...
+
+    You can provide the name of the realm to ask for authentication within.
+    """
+    def view_decorator(func):
+        def wrapper(request, *args, **kwargs):
+            return view_or_basicauth(func, request,
+                                     lambda u: u.is_authenticated(),
+                                     realm, *args, **kwargs)
+        return wrapper
+    return view_decorator
+
+#############################################################################
+#
+def has_perm_or_basicauth(perm, realm = ""):
+    """
+    This is similar to the above decorator 'logged_in_or_basicauth'
+    except that it requires the logged in user to have a specific
+    permission.
+
+    Use:
+
+    @logged_in_or_basicauth('asforums.view_forumcollection')
+    def your_view:
+        ...
+
+    """
+    def view_decorator(func):
+        def wrapper(request, *args, **kwargs):
+            return view_or_basicauth(func, request,
+                                     lambda u: u.has_perm(perm),
+                                     realm, *args, **kwargs)
+        return wrapper
+    return view_decorator
+

commit 8bb1bc357480f19971449d64adbd192f11ebbef4
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 6 18:27:40 2009 +0100

    add helper method for for basic auth
    
    code from http://www.djangosnippets.org/snippets/243/

diff --git a/mygpo/api/basic_auth.py b/mygpo/api/basic_auth.py
new file mode 100644
index 0000000..0338482
--- /dev/null
+++ b/mygpo/api/basic_auth.py
@@ -0,0 +1,45 @@
+#from http://www.djangosnippets.org/snippets/243/
+import base64
+
+from django.http import HttpResponse
+from django.contrib.auth import authenticate, login
+
+#############################################################################
+#
+def view_or_basicauth(view, request, test_func, realm = "", *args, **kwargs):
+    """
+    This is a helper function used by both 'logged_in_or_basicauth' and
+    'has_perm_or_basicauth' that does the nitty of determining if they
+    are already logged in or if they have provided proper http-authorization
+    and returning the view if all goes well, otherwise responding with a 401.
+    """
+    if test_func(request.user):
+        # Already logged in, just return the view.
+        #
+        return view(request, *args, **kwargs)
+
+    # They are not logged in. See if they provided login credentials
+    #
+    if 'HTTP_AUTHORIZATION' in request.META:
+        auth = request.META['HTTP_AUTHORIZATION'].split()
+        if len(auth) == 2:
+            # NOTE: We are only support basic authentication for now.
+            #
+            if auth[0].lower() == "basic":
+                uname, passwd = base64.b64decode(auth[1]).split(':')
+                user = authenticate(username=uname, password=passwd)
+                if user is not None:
+                    if user.is_active:
+                        login(request, user)
+                        request.user = user
+                        return view(request, *args, **kwargs)
+
+    # Either they did not provide an authorization header or
+    # something in the authorization attempt failed. Send a 401
+    # back to them to ask them to authenticate.
+    #
+    response = HttpResponse()
+    response.status_code = 401
+    response['WWW-Authenticate'] = 'Basic realm="%s"' % realm
+    return response
+

commit 83cec3444d611be3d71aec45731170fd048f2a57
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Fri Nov 6 18:00:34 2009 +0100

    added stubs for legacy api (bug 647)

diff --git a/mygpo/api/legacy.py b/mygpo/api/legacy.py
new file mode 100644
index 0000000..a83163c
--- /dev/null
+++ b/mygpo/api/legacy.py
@@ -0,0 +1,34 @@
+# Create your views here.
+
+def upload(request):
+    emailaddr = request.GET['username']
+    password  = request.GET['password']
+    action    = request.GET['action']
+    protocol  = request.GET['protocol']
+    opml_file = request.FILES['opml']
+    opml      = opml_file.read()
+    
+    user = UserAccount.objects.get(email__exact=emailaddr)
+    if !user:
+        #@AUTHFAIL
+    
+    if !user.check_password(password):
+        #@AUTHFAIL
+
+    #read podcasts
+
+
+def getlist(request):
+    emailaddr = request.GET['username']
+    password  = request.GET['password']
+
+    user = UserAccount.objects.get(email__exact=emailaddr)
+    if !user:
+        #@AUTHFAIL
+
+    if !user.check_password(password):
+        #@AUTHFAIL
+
+    # build and send list
+
+   
diff --git a/mygpo/urls.py b/mygpo/urls.py
index 139e1c1..d584932 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -10,6 +10,9 @@ urlpatterns = patterns('',
     (r'^$', 'mygpo.web.views.home'),
     (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
+    (r'^upload$', 'mygpo.api.legacy.upload'),
+    (r'^getlist$', 'mygpo.api.legacy.getlist'),
+    
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
     # to INSTALLED_APPS to enable admin documentation:
     # (r'^admin/doc/', include('django.contrib.admindocs.urls')),

commit 6e419a310ce18534e3a29c90fe27d2f54d6f775b
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Thu Nov 5 07:13:41 2009 +0000

    added class JsonResponse
    
    based on http://www.djangosnippets.org/snippets/154/

diff --git a/mygpo/api/json.py b/mygpo/api/json.py
new file mode 100644
index 0000000..7f8fbc8
--- /dev/null
+++ b/mygpo/api/json.py
@@ -0,0 +1,18 @@
+#from http://www.djangosnippets.org/snippets/154/
+
+from django.core.serializers import json, serialize
+from django.db.models.query import QuerySet
+from django.http import HttpResponse
+from django.utils import simplejson
+
+class JsonResponse(HttpResponse):
+    def __init__(self, object):
+        if isinstance(object, QuerySet):
+            content = serialize('json', object)
+        else:
+            content = simplejson.dumps(
+                object, indent=2, cls=json.DjangoJSONEncoder,
+                ensure_ascii=False)
+        super(JsonResponse, self).__init__(
+            content, content_type='application/json')
+

commit c5af8f32f0190f60ca4be966481230a950cdfaaf
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Wed Nov 4 08:12:23 2009 +0000

    intregrate with django authentication framework

diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 18912d6..8e231dc 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -17,7 +17,7 @@ class SubscriptionActionInline(admin.TabularInline):
     model = SubscriptionAction
     extra = 3
 
-class UserAdmin(admin.ModelAdmin):
+class UserAccountAdmin(admin.ModelAdmin):
     inlines = [DeviceInline, EpisodeActionInline]
 
 class PodcastAdmin(admin.ModelAdmin):
@@ -27,8 +27,7 @@ class PodcastAdmin(admin.ModelAdmin):
 class DeviceAdmin(admin.ModelAdmin):
     inlines = [SubscriptionActionInline]
 
-admin.site.register(User, UserAdmin)
+admin.site.register(UserAccount, UserAccountAdmin)
 admin.site.register(Podcast, PodcastAdmin)
 admin.site.register(Device, DeviceAdmin)
 admin.site.register(Subscription)
-
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 898720a..3455c46 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -1,4 +1,5 @@
 from django.db import models
+from django.contrib.auth.models import User, UserManager
 
 EPISODE_ACTION_TYPES = (
         ('download', 'downloaded'),
@@ -21,12 +22,13 @@ SUBSCRIPTION_ACTION_TYPES = (
         ('unsubscribe', 'unsubscribed')
     )
 
-class User(models.Model):
-    username = models.SlugField(max_length=100)
-    password = models.CharField(max_length=200)
-    email = models.EmailField()
+#inheriting from User, as described in 
+#http://scottbarnham.com/blog/2008/08/21/extending-the-django-user-model-with-inheritance/
+class UserAccount(User):
     public_profile = models.BooleanField()
 
+    objects = UserManager()
+
     def __unicode__(self):
         return self.username
     
diff --git a/mygpo/auth_backends.py b/mygpo/auth_backends.py
new file mode 100644
index 0000000..0c482b5
--- /dev/null
+++ b/mygpo/auth_backends.py
@@ -0,0 +1,29 @@
+#http://scottbarnham.com/blog/2008/08/21/extending-the-django-user-model-with-inheritance/
+
+from django.conf import settings
+from django.contrib.auth.backends import ModelBackend
+from django.core.exceptions import ImproperlyConfigured
+from django.db.models import get_model
+
+class UserAccountModelBackend(ModelBackend):
+    def authenticate(self, username=None, password=None):
+        try:
+            user = self.user_class.objects.get(username=username)
+            if user.check_password(password):
+                return user
+        except self.user_class.DoesNotExist:
+            return None
+
+    def get_user(self, user_id):
+        try:
+            return self.user_class.objects.get(pk=user_id)
+        except self.user_class.DoesNotExist:
+            return None
+
+    @property
+    def user_class(self):
+        if not hasattr(self, '_user_class'):
+            self._user_class = get_model(*settings.CUSTOM_USER_MODEL.split('.', 2))
+            if not self._user_class:
+                raise ImproperlyConfigured('Could not get custom user model')
+        return self._user_class
diff --git a/mygpo/settings.py b/mygpo/settings.py
index 28b55af..1a88594 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -81,3 +81,10 @@ INSTALLED_APPS = (
     'mygpo.api',
     'mygpo.web'
 )
+
+AUTHENTICATION_BACKENDS = (
+    'mygpo.UserAccountModelBackend',
+)
+
+CUSTOM_USER_MODEL = 'mygpo.api.models.CustomUser'
+

commit 629de45b1b6e9721d76c534edb85ec2d773be0f0
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 3 15:14:24 2009 +0100

    templates now derive from a base template

diff --git a/mygpo/web/templates/base.html b/mygpo/web/templates/base.html
new file mode 100644
index 0000000..b7546e8
--- /dev/null
+++ b/mygpo/web/templates/base.html
@@ -0,0 +1,24 @@
+<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
+    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
+<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
+<head>
+    <link rel="stylesheet" href="style.css" />
+    <title>{% block title %}my.gpodder.org{% endblock %}</title>
+</head>
+
+<body>
+    <div id="sidebar">
+        {% block sidebar %}
+        <ul>
+            <li><a href="/">Home</a></li>
+            <li><a href="/info/">Info</a></li>
+        </ul>
+        {% endblock %}
+    </div>
+
+    <div id="content">
+        {% block content %}{% endblock %}
+    </div>
+</body>
+</html>
+
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
index 1292d17..3067a17 100644
--- a/mygpo/web/templates/home.html
+++ b/mygpo/web/templates/home.html
@@ -1,10 +1,7 @@
-<html>
- <head>
-  <title>my.gpodder.org</title>
- </head>
+{% extends "base.html" %}
 
- <body>
+{% block content %}
   <h1>my.gpodder.org</h1>
   <p>{{ podcast_count }} Podcasts!</p>
- </body>
-</html>
+{% endblock %}
+
diff --git a/mygpo/web/templates/info.html b/mygpo/web/templates/info.html
index 14850ed..8998f7a 100644
--- a/mygpo/web/templates/info.html
+++ b/mygpo/web/templates/info.html
@@ -1,10 +1,8 @@
-<html>
- <head>
-  <title>Info - my.gpodder.org</title>
- </head>
+{% extends "base.html" %}
 
- <body>
+
+{% block content %}
   <h1>my.gpodder.org ist...</h1>
   <p>... noch nicht fertig</p>
- </body>
-</html>
+{% endblock %}
+

commit 6b63a6a340e2cb4fb877b48a96d1bfa14fae4b8e
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 3 15:01:58 2009 +0100

    configured admin-interface
    
    Inline editing of related Objects
    showing subscription-count of Podcasts

diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
index 4a88232..18912d6 100644
--- a/mygpo/api/admin.py
+++ b/mygpo/api/admin.py
@@ -22,6 +22,7 @@ class UserAdmin(admin.ModelAdmin):
 
 class PodcastAdmin(admin.ModelAdmin):
     inlines = [EpisodeInline]
+    list_display = ['title', 'description', 'url', 'link', 'last_update', 'subscription_count']
 
 class DeviceAdmin(admin.ModelAdmin):
     inlines = [SubscriptionActionInline]
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index 31919cd..898720a 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -39,6 +39,12 @@ class Podcast(models.Model):
     description = models.TextField()
     link = models.URLField()
     last_update = models.DateTimeField()
+    
+    def subscriptions(self):
+        return Subscription.objects.filter(podcast=self)
+    
+    def subscription_count(self):
+        return self.subscriptions().count()
 
     def __unicode__(self):
         return self.title
@@ -87,7 +93,7 @@ class Subscription(models.Model):
     podcast = models.ForeignKey(Podcast)
 
     def __unicode__(self):
-        return '(%s, %s)' % (self.user, self.podcast)
+        return '%s - %s on %s' % (self.device.user, self.podcast, self.device)
     
     class Meta:
         db_table = 'current_subscription'

commit 9baf33a3b8251eb0ec5bc0e7c27320de94f23e3a
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 3 14:50:05 2009 +0100

    added admin functionality

diff --git a/mygpo/api/admin.py b/mygpo/api/admin.py
new file mode 100644
index 0000000..4a88232
--- /dev/null
+++ b/mygpo/api/admin.py
@@ -0,0 +1,33 @@
+from django.contrib import admin
+from mygpo.api.models import *
+
+class DeviceInline(admin.TabularInline):
+    model = Device
+    extra = 3
+
+class EpisodeInline(admin.TabularInline):
+    model = Episode
+    extra = 3
+
+class EpisodeActionInline(admin.TabularInline):
+    model = EpisodeAction
+    extra = 3
+
+class SubscriptionActionInline(admin.TabularInline):
+    model = SubscriptionAction
+    extra = 3
+
+class UserAdmin(admin.ModelAdmin):
+    inlines = [DeviceInline, EpisodeActionInline]
+
+class PodcastAdmin(admin.ModelAdmin):
+    inlines = [EpisodeInline]
+
+class DeviceAdmin(admin.ModelAdmin):
+    inlines = [SubscriptionActionInline]
+
+admin.site.register(User, UserAdmin)
+admin.site.register(Podcast, PodcastAdmin)
+admin.site.register(Device, DeviceAdmin)
+admin.site.register(Subscription)
+
diff --git a/mygpo/settings.py b/mygpo/settings.py
index 658fa08..28b55af 100644
--- a/mygpo/settings.py
+++ b/mygpo/settings.py
@@ -77,6 +77,7 @@ INSTALLED_APPS = (
     'django.contrib.contenttypes',
     'django.contrib.sessions',
     'django.contrib.sites',
+    'django.contrib.admin',
     'mygpo.api',
     'mygpo.web'
 )

commit f2d4bea34310f55d8213b68f4dffdb38de2dfc37
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Tue Nov 3 14:22:53 2009 +0100

    added info page as sample for generic views

diff --git a/mygpo/urls.py b/mygpo/urls.py
index 634003a..139e1c1 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -8,6 +8,7 @@ urlpatterns = patterns('',
     # Example:
     # (r'^mygpo/', include('mygpo.foo.urls')),
     (r'^$', 'mygpo.web.views.home'),
+    (r'^info/$', 'django.views.generic.simple.direct_to_template', {'template': 'info.html'}),
 
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
     # to INSTALLED_APPS to enable admin documentation:
diff --git a/mygpo/web/templates/info.html b/mygpo/web/templates/info.html
new file mode 100644
index 0000000..14850ed
--- /dev/null
+++ b/mygpo/web/templates/info.html
@@ -0,0 +1,10 @@
+<html>
+ <head>
+  <title>Info - my.gpodder.org</title>
+ </head>
+
+ <body>
+  <h1>my.gpodder.org ist...</h1>
+  <p>... noch nicht fertig</p>
+ </body>
+</html>

commit e5b93b2379e00c478e360751533bdccfddc1f106
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Tue Nov 3 07:43:56 2009 +0000

    added simple home site, updated models

diff --git a/mygpo/api/models.py b/mygpo/api/models.py
index b7df0e3..31919cd 100644
--- a/mygpo/api/models.py
+++ b/mygpo/api/models.py
@@ -26,6 +26,9 @@ class User(models.Model):
     password = models.CharField(max_length=200)
     email = models.EmailField()
     public_profile = models.BooleanField()
+
+    def __unicode__(self):
+        return self.username
     
     class Meta:
         db_table = 'user'
@@ -36,6 +39,9 @@ class Podcast(models.Model):
     description = models.TextField()
     link = models.URLField()
     last_update = models.DateTimeField()
+
+    def __unicode__(self):
+        return self.title
     
     class Meta:
         db_table = 'podcast'
@@ -46,38 +52,54 @@ class Episode(models.Model):
     title = models.CharField(max_length=100)
     description = models.TextField()
     link = models.URLField()
+
+    def __unicode__(self):
+        return self.title
     
     class Meta:
         db_table = 'episode'
 
 class EpisodeAction(models.Model):
-    db_table = 'episode_log'
-    
-    user = models.ForeignKey(User)
+    user = models.ForeignKey(User, primary_key=True)
     episode = models.ForeignKey(Episode)
     action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
     timestamp = models.DateTimeField()
 
+    def __unicode__(self):
+        return '%s %s %s' % self.user, self.action, self.episode
+
+    class Meta:
+        db_table = 'episode_log'
+
 class Device(models.Model):
     user = models.ForeignKey(User)
     name = models.CharField(max_length=100)
     type = models.CharField(max_length=10, choices=DEVICE_TYPES)
+
+    def __unicode__(self):
+        return '%s (%s)' % (self.name, self.type)
     
     class Meta:
         db_table = 'device'
 
 class Subscription(models.Model):
-    user = models.ForeignKey(User)
+    device = models.ForeignKey(Device, primary_key=True)
     podcast = models.ForeignKey(Podcast)
+
+    def __unicode__(self):
+        return '(%s, %s)' % (self.user, self.podcast)
     
     class Meta:
         db_table = 'current_subscription'
 
 class SubscriptionAction(models.Model):
-    device = models.ForeignKey(Device)
+    device = models.ForeignKey(Device, primary_key=True)
     podcast = models.ForeignKey(Podcast)
     action = models.CharField(max_length=12, choices=SUBSCRIPTION_ACTION_TYPES)
     timestamp = models.DateTimeField()
+
+    def __unicode__(self):
+        return '%s %s %s' % (self.device, self.action, self.podcast)
     
     class Meta:
         db_table = 'subscription_log'
diff --git a/mygpo/urls.py b/mygpo/urls.py
index e3d23be..634003a 100644
--- a/mygpo/urls.py
+++ b/mygpo/urls.py
@@ -1,17 +1,18 @@
 from django.conf.urls.defaults import *
 
 # Uncomment the next two lines to enable the admin:
-# from django.contrib import admin
-# admin.autodiscover()
+from django.contrib import admin
+admin.autodiscover()
 
 urlpatterns = patterns('',
     # Example:
     # (r'^mygpo/', include('mygpo.foo.urls')),
+    (r'^$', 'mygpo.web.views.home'),
 
     # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
     # to INSTALLED_APPS to enable admin documentation:
     # (r'^admin/doc/', include('django.contrib.admindocs.urls')),
 
     # Uncomment the next line to enable the admin:
-    # (r'^admin/', include(admin.site.urls)),
+    (r'^admin/', include(admin.site.urls)),
 )
diff --git a/mygpo/web/templates/home.html b/mygpo/web/templates/home.html
new file mode 100644
index 0000000..1292d17
--- /dev/null
+++ b/mygpo/web/templates/home.html
@@ -0,0 +1,10 @@
+<html>
+ <head>
+  <title>my.gpodder.org</title>
+ </head>
+
+ <body>
+  <h1>my.gpodder.org</h1>
+  <p>{{ podcast_count }} Podcasts!</p>
+ </body>
+</html>
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
index 60f00ef..ec34b3e 100644
--- a/mygpo/web/views.py
+++ b/mygpo/web/views.py
@@ -1 +1,9 @@
-# Create your views here.
+from django.shortcuts import render_to_response
+from mygpo.api.models import Podcast
+
+def home(request):
+    podcasts = Podcast.objects.count()
+    return render_to_response('home.html', {
+            'podcast_count': podcasts
+        })
+

commit 3242dbd5fb6d99a867144ae1cda15556237ee798
Author: Stefan Koegl <stefan@k-wh.at>
Date:   Tue Nov 3 06:59:30 2009 +0000

    moved source to directoy mygpo

diff --git a/__init__.py b/__init__.py
deleted file mode 100644
index e69de29..0000000
diff --git a/api/__init__.py b/api/__init__.py
deleted file mode 100644
index e69de29..0000000
diff --git a/api/models.py b/api/models.py
deleted file mode 100644
index b7df0e3..0000000
--- a/api/models.py
+++ /dev/null
@@ -1,84 +0,0 @@
-from django.db import models
-
-EPISODE_ACTION_TYPES = (
-        ('download', 'downloaded'),
-        ('play',     'played'),
-        ('sync',     'synced'),
-        ('lock',     'locked'),
-        ('delete',   'deleted')
-    )
-
-DEVICE_TYPES = (
-        ('desktop', 'Desktop'),
-        ('laptop', 'Laptop'),
-        ('mobile', 'Mobile'),
-        ('server', 'Server'),
-        ('other', 'Other')
-    )
-
-SUBSCRIPTION_ACTION_TYPES = (
-        ('subscribe', 'subscribed'),
-        ('unsubscribe', 'unsubscribed')
-    )
-
-class User(models.Model):
-    username = models.SlugField(max_length=100)
-    password = models.CharField(max_length=200)
-    email = models.EmailField()
-    public_profile = models.BooleanField()
-    
-    class Meta:
-        db_table = 'user'
-
-class Podcast(models.Model):
-    url = models.URLField()
-    title = models.CharField(max_length=100)
-    description = models.TextField()
-    link = models.URLField()
-    last_update = models.DateTimeField()
-    
-    class Meta:
-        db_table = 'podcast'
-
-class Episode(models.Model):
-    podcast = models.ForeignKey(Podcast)
-    url = models.URLField()
-    title = models.CharField(max_length=100)
-    description = models.TextField()
-    link = models.URLField()
-    
-    class Meta:
-        db_table = 'episode'
-
-class EpisodeAction(models.Model):
-    db_table = 'episode_log'
-    
-    user = models.ForeignKey(User)
-    episode = models.ForeignKey(Episode)
-    action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
-    timestamp = models.DateTimeField()
-
-class Device(models.Model):
-    user = models.ForeignKey(User)
-    name = models.CharField(max_length=100)
-    type = models.CharField(max_length=10, choices=DEVICE_TYPES)
-    
-    class Meta:
-        db_table = 'device'
-
-class Subscription(models.Model):
-    user = models.ForeignKey(User)
-    podcast = models.ForeignKey(Podcast)
-    
-    class Meta:
-        db_table = 'current_subscription'
-
-class SubscriptionAction(models.Model):
-    device = models.ForeignKey(Device)
-    podcast = models.ForeignKey(Podcast)
-    action = models.CharField(max_length=12, choices=SUBSCRIPTION_ACTION_TYPES)
-    timestamp = models.DateTimeField()
-    
-    class Meta:
-        db_table = 'subscription_log'
-
diff --git a/api/tests.py b/api/tests.py
deleted file mode 100644
index 2247054..0000000
--- a/api/tests.py
+++ /dev/null
@@ -1,23 +0,0 @@
-"""
-This file demonstrates two different styles of tests (one doctest and one
-unittest). These will both pass when you run "manage.py test".
-
-Replace these with more appropriate tests for your application.
-"""
-
-from django.test import TestCase
-
-class SimpleTest(TestCase):
-    def test_basic_addition(self):
-        """
-        Tests that 1 + 1 always equals 2.
-        """
-        self.failUnlessEqual(1 + 1, 2)
-
-__test__ = {"doctest": """
-Another way to test that 1 + 1 is equal to 2.
-
->>> 1 + 1 == 2
-True
-"""}
-
diff --git a/api/views.py b/api/views.py
deleted file mode 100644
index 60f00ef..0000000
--- a/api/views.py
+++ /dev/null
@@ -1 +0,0 @@
-# Create your views here.
diff --git a/manage.py b/manage.py
deleted file mode 100755
index bcdd55e..0000000
--- a/manage.py
+++ /dev/null
@@ -1,11 +0,0 @@
-#!/usr/bin/python
-from django.core.management import execute_manager
-try:
-    import settings # Assumed to be in the same directory.
-except ImportError:
-    import sys
-    sys.stderr.write("Error: Can't find the file 'settings.py' in the directory containing %r. It appears you've customized things.\nYou'll have to run django-admin.py, passing it your settings module.\n(If the file settings.py does indeed exist, it's causing an ImportError somehow.)\n" % __file__)
-    sys.exit(1)
-
-if __name__ == "__main__":
-    execute_manager(settings)
diff --git a/mygpo/__init__.py b/mygpo/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/mygpo/api/__init__.py b/mygpo/api/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/mygpo/api/models.py b/mygpo/api/models.py
new file mode 100644
index 0000000..b7df0e3
--- /dev/null
+++ b/mygpo/api/models.py
@@ -0,0 +1,84 @@
+from django.db import models
+
+EPISODE_ACTION_TYPES = (
+        ('download', 'downloaded'),
+        ('play',     'played'),
+        ('sync',     'synced'),
+        ('lock',     'locked'),
+        ('delete',   'deleted')
+    )
+
+DEVICE_TYPES = (
+        ('desktop', 'Desktop'),
+        ('laptop', 'Laptop'),
+        ('mobile', 'Mobile'),
+        ('server', 'Server'),
+        ('other', 'Other')
+    )
+
+SUBSCRIPTION_ACTION_TYPES = (
+        ('subscribe', 'subscribed'),
+        ('unsubscribe', 'unsubscribed')
+    )
+
+class User(models.Model):
+    username = models.SlugField(max_length=100)
+    password = models.CharField(max_length=200)
+    email = models.EmailField()
+    public_profile = models.BooleanField()
+    
+    class Meta:
+        db_table = 'user'
+
+class Podcast(models.Model):
+    url = models.URLField()
+    title = models.CharField(max_length=100)
+    description = models.TextField()
+    link = models.URLField()
+    last_update = models.DateTimeField()
+    
+    class Meta:
+        db_table = 'podcast'
+
+class Episode(models.Model):
+    podcast = models.ForeignKey(Podcast)
+    url = models.URLField()
+    title = models.CharField(max_length=100)
+    description = models.TextField()
+    link = models.URLField()
+    
+    class Meta:
+        db_table = 'episode'
+
+class EpisodeAction(models.Model):
+    db_table = 'episode_log'
+    
+    user = models.ForeignKey(User)
+    episode = models.ForeignKey(Episode)
+    action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
+    timestamp = models.DateTimeField()
+
+class Device(models.Model):
+    user = models.ForeignKey(User)
+    name = models.CharField(max_length=100)
+    type = models.CharField(max_length=10, choices=DEVICE_TYPES)
+    
+    class Meta:
+        db_table = 'device'
+
+class Subscription(models.Model):
+    user = models.ForeignKey(User)
+    podcast = models.ForeignKey(Podcast)
+    
+    class Meta:
+        db_table = 'current_subscription'
+
+class SubscriptionAction(models.Model):
+    device = models.ForeignKey(Device)
+    podcast = models.ForeignKey(Podcast)
+    action = models.CharField(max_length=12, choices=SUBSCRIPTION_ACTION_TYPES)
+    timestamp = models.DateTimeField()
+    
+    class Meta:
+        db_table = 'subscription_log'
+
diff --git a/mygpo/api/tests.py b/mygpo/api/tests.py
new file mode 100644
index 0000000..2247054
--- /dev/null
+++ b/mygpo/api/tests.py
@@ -0,0 +1,23 @@
+"""
+This file demonstrates two different styles of tests (one doctest and one
+unittest). These will both pass when you run "manage.py test".
+
+Replace these with more appropriate tests for your application.
+"""
+
+from django.test import TestCase
+
+class SimpleTest(TestCase):
+    def test_basic_addition(self):
+        """
+        Tests that 1 + 1 always equals 2.
+        """
+        self.failUnlessEqual(1 + 1, 2)
+
+__test__ = {"doctest": """
+Another way to test that 1 + 1 is equal to 2.
+
+>>> 1 + 1 == 2
+True
+"""}
+
diff --git a/mygpo/api/views.py b/mygpo/api/views.py
new file mode 100644
index 0000000..60f00ef
--- /dev/null
+++ b/mygpo/api/views.py
@@ -0,0 +1 @@
+# Create your views here.
diff --git a/mygpo/manage.py b/mygpo/manage.py
new file mode 100755
index 0000000..bcdd55e
--- /dev/null
+++ b/mygpo/manage.py
@@ -0,0 +1,11 @@
+#!/usr/bin/python
+from django.core.management import execute_manager
+try:
+    import settings # Assumed to be in the same directory.
+except ImportError:
+    import sys
+    sys.stderr.write("Error: Can't find the file 'settings.py' in the directory containing %r. It appears you've customized things.\nYou'll have to run django-admin.py, passing it your settings module.\n(If the file settings.py does indeed exist, it's causing an ImportError somehow.)\n" % __file__)
+    sys.exit(1)
+
+if __name__ == "__main__":
+    execute_manager(settings)
diff --git a/mygpo/settings.py b/mygpo/settings.py
new file mode 100644
index 0000000..658fa08
--- /dev/null
+++ b/mygpo/settings.py
@@ -0,0 +1,82 @@
+# Django settings for mygpo project.
+
+DEBUG = True
+TEMPLATE_DEBUG = DEBUG
+
+ADMINS = (
+    ('stefan', 'stefan@skoegl.net'),
+    # ('Your Name', 'your_email@domain.com'),
+)
+
+MANAGERS = ADMINS
+
+DATABASE_ENGINE = 'mysql'           # 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.
+DATABASE_NAME = 'mygpo'             # Or path to database file if using sqlite3.
+DATABASE_USER = 'mygpo'             # Not used with sqlite3.
+DATABASE_PASSWORD = 'mygpo'         # Not used with sqlite3.
+DATABASE_HOST = ''             # Set to empty string for localhost. Not used with sqlite3.
+DATABASE_PORT = ''             # Set to empty string for default. Not used with sqlite3.
+
+# Local time zone for this installation. Choices can be found here:
+# http://en.wikipedia.org/wiki/List_of_tz_zones_by_name
+# although not all choices may be available on all operating systems.
+# If running in a Windows environment this must be set to the same as your
+# system time zone.
+TIME_ZONE = 'America/Chicago'
+
+# Language code for this installation. All choices can be found here:
+# http://www.i18nguy.com/unicode/language-identifiers.html
+LANGUAGE_CODE = 'en-us'
+
+SITE_ID = 1
+
+# If you set this to False, Django will make some optimizations so as not
+# to load the internationalization machinery.
+USE_I18N = True
+
+# Absolute path to the directory that holds media.
+# Example: "/home/media/media.lawrence.com/"
+MEDIA_ROOT = ''
+
+# URL that handles the media served from MEDIA_ROOT. Make sure to use a
+# trailing slash if there is a path component (optional in other cases).
+# Examples: "http://media.lawrence.com", "http://example.com/media/"
+MEDIA_URL = ''
+
+# URL prefix for admin media -- CSS, JavaScript and images. Make sure to use a
+# trailing slash.
+# Examples: "http://foo.com/media/", "/media/".
+ADMIN_MEDIA_PREFIX = '/media/'
+
+# Make this unique, and don't share it with anybody.
+SECRET_KEY = '8s(g1_%+-^@xw*ulzg&gmhj+mp5!m50-p5!721aoai3q67kym!'
+
+# List of callables that know how to import templates from various sources.
+TEMPLATE_LOADERS = (
+    'django.template.loaders.filesystem.load_template_source',
+    'django.template.loaders.app_directories.load_template_source',
+#     'django.template.loaders.eggs.load_template_source',
+)
+
+MIDDLEWARE_CLASSES = (
+    'django.middleware.common.CommonMiddleware',
+    'django.contrib.sessions.middleware.SessionMiddleware',
+    'django.contrib.auth.middleware.AuthenticationMiddleware',
+)
+
+ROOT_URLCONF = 'mygpo.urls'
+
+TEMPLATE_DIRS = (
+    # Put strings here, like "/home/html/django_templates" or "C:/www/django/templates".
+    # Always use forward slashes, even on Windows.
+    # Don't forget to use absolute paths, not relative paths.
+)
+
+INSTALLED_APPS = (
+    'django.contrib.auth',
+    'django.contrib.contenttypes',
+    'django.contrib.sessions',
+    'django.contrib.sites',
+    'mygpo.api',
+    'mygpo.web'
+)
diff --git a/mygpo/urls.py b/mygpo/urls.py
new file mode 100644
index 0000000..e3d23be
--- /dev/null
+++ b/mygpo/urls.py
@@ -0,0 +1,17 @@
+from django.conf.urls.defaults import *
+
+# Uncomment the next two lines to enable the admin:
+# from django.contrib import admin
+# admin.autodiscover()
+
+urlpatterns = patterns('',
+    # Example:
+    # (r'^mygpo/', include('mygpo.foo.urls')),
+
+    # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
+    # to INSTALLED_APPS to enable admin documentation:
+    # (r'^admin/doc/', include('django.contrib.admindocs.urls')),
+
+    # Uncomment the next line to enable the admin:
+    # (r'^admin/', include(admin.site.urls)),
+)
diff --git a/mygpo/web/__init__.py b/mygpo/web/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/mygpo/web/models.py b/mygpo/web/models.py
new file mode 100644
index 0000000..71a8362
--- /dev/null
+++ b/mygpo/web/models.py
@@ -0,0 +1,3 @@
+from django.db import models
+
+# Create your models here.
diff --git a/mygpo/web/tests.py b/mygpo/web/tests.py
new file mode 100644
index 0000000..2247054
--- /dev/null
+++ b/mygpo/web/tests.py
@@ -0,0 +1,23 @@
+"""
+This file demonstrates two different styles of tests (one doctest and one
+unittest). These will both pass when you run "manage.py test".
+
+Replace these with more appropriate tests for your application.
+"""
+
+from django.test import TestCase
+
+class SimpleTest(TestCase):
+    def test_basic_addition(self):
+        """
+        Tests that 1 + 1 always equals 2.
+        """
+        self.failUnlessEqual(1 + 1, 2)
+
+__test__ = {"doctest": """
+Another way to test that 1 + 1 is equal to 2.
+
+>>> 1 + 1 == 2
+True
+"""}
+
diff --git a/mygpo/web/views.py b/mygpo/web/views.py
new file mode 100644
index 0000000..60f00ef
--- /dev/null
+++ b/mygpo/web/views.py
@@ -0,0 +1 @@
+# Create your views here.
diff --git a/settings.py b/settings.py
deleted file mode 100644
index 658fa08..0000000
--- a/settings.py
+++ /dev/null
@@ -1,82 +0,0 @@
-# Django settings for mygpo project.
-
-DEBUG = True
-TEMPLATE_DEBUG = DEBUG
-
-ADMINS = (
-    ('stefan', 'stefan@skoegl.net'),
-    # ('Your Name', 'your_email@domain.com'),
-)
-
-MANAGERS = ADMINS
-
-DATABASE_ENGINE = 'mysql'           # 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.
-DATABASE_NAME = 'mygpo'             # Or path to database file if using sqlite3.
-DATABASE_USER = 'mygpo'             # Not used with sqlite3.
-DATABASE_PASSWORD = 'mygpo'         # Not used with sqlite3.
-DATABASE_HOST = ''             # Set to empty string for localhost. Not used with sqlite3.
-DATABASE_PORT = ''             # Set to empty string for default. Not used with sqlite3.
-
-# Local time zone for this installation. Choices can be found here:
-# http://en.wikipedia.org/wiki/List_of_tz_zones_by_name
-# although not all choices may be available on all operating systems.
-# If running in a Windows environment this must be set to the same as your
-# system time zone.
-TIME_ZONE = 'America/Chicago'
-
-# Language code for this installation. All choices can be found here:
-# http://www.i18nguy.com/unicode/language-identifiers.html
-LANGUAGE_CODE = 'en-us'
-
-SITE_ID = 1
-
-# If you set this to False, Django will make some optimizations so as not
-# to load the internationalization machinery.
-USE_I18N = True
-
-# Absolute path to the directory that holds media.
-# Example: "/home/media/media.lawrence.com/"
-MEDIA_ROOT = ''
-
-# URL that handles the media served from MEDIA_ROOT. Make sure to use a
-# trailing slash if there is a path component (optional in other cases).
-# Examples: "http://media.lawrence.com", "http://example.com/media/"
-MEDIA_URL = ''
-
-# URL prefix for admin media -- CSS, JavaScript and images. Make sure to use a
-# trailing slash.
-# Examples: "http://foo.com/media/", "/media/".
-ADMIN_MEDIA_PREFIX = '/media/'
-
-# Make this unique, and don't share it with anybody.
-SECRET_KEY = '8s(g1_%+-^@xw*ulzg&gmhj+mp5!m50-p5!721aoai3q67kym!'
-
-# List of callables that know how to import templates from various sources.
-TEMPLATE_LOADERS = (
-    'django.template.loaders.filesystem.load_template_source',
-    'django.template.loaders.app_directories.load_template_source',
-#     'django.template.loaders.eggs.load_template_source',
-)
-
-MIDDLEWARE_CLASSES = (
-    'django.middleware.common.CommonMiddleware',
-    'django.contrib.sessions.middleware.SessionMiddleware',
-    'django.contrib.auth.middleware.AuthenticationMiddleware',
-)
-
-ROOT_URLCONF = 'mygpo.urls'
-
-TEMPLATE_DIRS = (
-    # Put strings here, like "/home/html/django_templates" or "C:/www/django/templates".
-    # Always use forward slashes, even on Windows.
-    # Don't forget to use absolute paths, not relative paths.
-)
-
-INSTALLED_APPS = (
-    'django.contrib.auth',
-    'django.contrib.contenttypes',
-    'django.contrib.sessions',
-    'django.contrib.sites',
-    'mygpo.api',
-    'mygpo.web'
-)
diff --git a/urls.py b/urls.py
deleted file mode 100644
index e3d23be..0000000
--- a/urls.py
+++ /dev/null
@@ -1,17 +0,0 @@
-from django.conf.urls.defaults import *
-
-# Uncomment the next two lines to enable the admin:
-# from django.contrib import admin
-# admin.autodiscover()
-
-urlpatterns = patterns('',
-    # Example:
-    # (r'^mygpo/', include('mygpo.foo.urls')),
-
-    # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
-    # to INSTALLED_APPS to enable admin documentation:
-    # (r'^admin/doc/', include('django.contrib.admindocs.urls')),
-
-    # Uncomment the next line to enable the admin:
-    # (r'^admin/', include(admin.site.urls)),
-)
diff --git a/web/__init__.py b/web/__init__.py
deleted file mode 100644
index e69de29..0000000
diff --git a/web/models.py b/web/models.py
deleted file mode 100644
index 71a8362..0000000
--- a/web/models.py
+++ /dev/null
@@ -1,3 +0,0 @@
-from django.db import models
-
-# Create your models here.
diff --git a/web/tests.py b/web/tests.py
deleted file mode 100644
index 2247054..0000000
--- a/web/tests.py
+++ /dev/null
@@ -1,23 +0,0 @@
-"""
-This file demonstrates two different styles of tests (one doctest and one
-unittest). These will both pass when you run "manage.py test".
-
-Replace these with more appropriate tests for your application.
-"""
-
-from django.test import TestCase
-
-class SimpleTest(TestCase):
-    def test_basic_addition(self):
-        """
-        Tests that 1 + 1 always equals 2.
-        """
-        self.failUnlessEqual(1 + 1, 2)
-
-__test__ = {"doctest": """
-Another way to test that 1 + 1 is equal to 2.
-
->>> 1 + 1 == 2
-True
-"""}
-
diff --git a/web/views.py b/web/views.py
deleted file mode 100644
index 60f00ef..0000000
--- a/web/views.py
+++ /dev/null
@@ -1 +0,0 @@
-# Create your views here.

commit a4aa1b4d5b17d40a89a9e6dc53f0a577072b5633
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Mon Nov 2 23:18:25 2009 +0100

    implemented very basic Django models

diff --git a/api/models.py b/api/models.py
index 71a8362..b7df0e3 100644
--- a/api/models.py
+++ b/api/models.py
@@ -1,3 +1,84 @@
 from django.db import models
 
-# Create your models here.
+EPISODE_ACTION_TYPES = (
+        ('download', 'downloaded'),
+        ('play',     'played'),
+        ('sync',     'synced'),
+        ('lock',     'locked'),
+        ('delete',   'deleted')
+    )
+
+DEVICE_TYPES = (
+        ('desktop', 'Desktop'),
+        ('laptop', 'Laptop'),
+        ('mobile', 'Mobile'),
+        ('server', 'Server'),
+        ('other', 'Other')
+    )
+
+SUBSCRIPTION_ACTION_TYPES = (
+        ('subscribe', 'subscribed'),
+        ('unsubscribe', 'unsubscribed')
+    )
+
+class User(models.Model):
+    username = models.SlugField(max_length=100)
+    password = models.CharField(max_length=200)
+    email = models.EmailField()
+    public_profile = models.BooleanField()
+    
+    class Meta:
+        db_table = 'user'
+
+class Podcast(models.Model):
+    url = models.URLField()
+    title = models.CharField(max_length=100)
+    description = models.TextField()
+    link = models.URLField()
+    last_update = models.DateTimeField()
+    
+    class Meta:
+        db_table = 'podcast'
+
+class Episode(models.Model):
+    podcast = models.ForeignKey(Podcast)
+    url = models.URLField()
+    title = models.CharField(max_length=100)
+    description = models.TextField()
+    link = models.URLField()
+    
+    class Meta:
+        db_table = 'episode'
+
+class EpisodeAction(models.Model):
+    db_table = 'episode_log'
+    
+    user = models.ForeignKey(User)
+    episode = models.ForeignKey(Episode)
+    action = models.CharField(max_length=10, choices=EPISODE_ACTION_TYPES)
+    timestamp = models.DateTimeField()
+
+class Device(models.Model):
+    user = models.ForeignKey(User)
+    name = models.CharField(max_length=100)
+    type = models.CharField(max_length=10, choices=DEVICE_TYPES)
+    
+    class Meta:
+        db_table = 'device'
+
+class Subscription(models.Model):
+    user = models.ForeignKey(User)
+    podcast = models.ForeignKey(Podcast)
+    
+    class Meta:
+        db_table = 'current_subscription'
+
+class SubscriptionAction(models.Model):
+    device = models.ForeignKey(Device)
+    podcast = models.ForeignKey(Podcast)
+    action = models.CharField(max_length=12, choices=SUBSCRIPTION_ACTION_TYPES)
+    timestamp = models.DateTimeField()
+    
+    class Meta:
+        db_table = 'subscription_log'
+
diff --git a/settings.py b/settings.py
index 774c410..658fa08 100644
--- a/settings.py
+++ b/settings.py
@@ -4,15 +4,16 @@ DEBUG = True
 TEMPLATE_DEBUG = DEBUG
 
 ADMINS = (
+    ('stefan', 'stefan@skoegl.net'),
     # ('Your Name', 'your_email@domain.com'),
 )
 
 MANAGERS = ADMINS
 
-DATABASE_ENGINE = ''           # 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.
-DATABASE_NAME = ''             # Or path to database file if using sqlite3.
-DATABASE_USER = ''             # Not used with sqlite3.
-DATABASE_PASSWORD = ''         # Not used with sqlite3.
+DATABASE_ENGINE = 'mysql'           # 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.
+DATABASE_NAME = 'mygpo'             # Or path to database file if using sqlite3.
+DATABASE_USER = 'mygpo'             # Not used with sqlite3.
+DATABASE_PASSWORD = 'mygpo'         # Not used with sqlite3.
 DATABASE_HOST = ''             # Set to empty string for localhost. Not used with sqlite3.
 DATABASE_PORT = ''             # Set to empty string for default. Not used with sqlite3.
 
@@ -76,4 +77,6 @@ INSTALLED_APPS = (
     'django.contrib.contenttypes',
     'django.contrib.sessions',
     'django.contrib.sites',
+    'mygpo.api',
+    'mygpo.web'
 )

commit 462a37e1f144f0616afa7e645f1883677777fa29
Author: Stefan Koegl <stefan@skoegl.net>
Date:   Sun Nov 1 22:40:29 2009 +0100

    created Django Project with Apps api and web

diff --git a/__init__.py b/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/api/__init__.py b/api/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/api/models.py b/api/models.py
new file mode 100644
index 0000000..71a8362
--- /dev/null
+++ b/api/models.py
@@ -0,0 +1,3 @@
+from django.db import models
+
+# Create your models here.
diff --git a/api/tests.py b/api/tests.py
new file mode 100644
index 0000000..2247054
--- /dev/null
+++ b/api/tests.py
@@ -0,0 +1,23 @@
+"""
+This file demonstrates two different styles of tests (one doctest and one
+unittest). These will both pass when you run "manage.py test".
+
+Replace these with more appropriate tests for your application.
+"""
+
+from django.test import TestCase
+
+class SimpleTest(TestCase):
+    def test_basic_addition(self):
+        """
+        Tests that 1 + 1 always equals 2.
+        """
+        self.failUnlessEqual(1 + 1, 2)
+
+__test__ = {"doctest": """
+Another way to test that 1 + 1 is equal to 2.
+
+>>> 1 + 1 == 2
+True
+"""}
+
diff --git a/api/views.py b/api/views.py
new file mode 100644
index 0000000..60f00ef
--- /dev/null
+++ b/api/views.py
@@ -0,0 +1 @@
+# Create your views here.
diff --git a/manage.py b/manage.py
new file mode 100755
index 0000000..bcdd55e
--- /dev/null
+++ b/manage.py
@@ -0,0 +1,11 @@
+#!/usr/bin/python
+from django.core.management import execute_manager
+try:
+    import settings # Assumed to be in the same directory.
+except ImportError:
+    import sys
+    sys.stderr.write("Error: Can't find the file 'settings.py' in the directory containing %r. It appears you've customized things.\nYou'll have to run django-admin.py, passing it your settings module.\n(If the file settings.py does indeed exist, it's causing an ImportError somehow.)\n" % __file__)
+    sys.exit(1)
+
+if __name__ == "__main__":
+    execute_manager(settings)
diff --git a/settings.py b/settings.py
new file mode 100644
index 0000000..774c410
--- /dev/null
+++ b/settings.py
@@ -0,0 +1,79 @@
+# Django settings for mygpo project.
+
+DEBUG = True
+TEMPLATE_DEBUG = DEBUG
+
+ADMINS = (
+    # ('Your Name', 'your_email@domain.com'),
+)
+
+MANAGERS = ADMINS
+
+DATABASE_ENGINE = ''           # 'postgresql_psycopg2', 'postgresql', 'mysql', 'sqlite3' or 'oracle'.
+DATABASE_NAME = ''             # Or path to database file if using sqlite3.
+DATABASE_USER = ''             # Not used with sqlite3.
+DATABASE_PASSWORD = ''         # Not used with sqlite3.
+DATABASE_HOST = ''             # Set to empty string for localhost. Not used with sqlite3.
+DATABASE_PORT = ''             # Set to empty string for default. Not used with sqlite3.
+
+# Local time zone for this installation. Choices can be found here:
+# http://en.wikipedia.org/wiki/List_of_tz_zones_by_name
+# although not all choices may be available on all operating systems.
+# If running in a Windows environment this must be set to the same as your
+# system time zone.
+TIME_ZONE = 'America/Chicago'
+
+# Language code for this installation. All choices can be found here:
+# http://www.i18nguy.com/unicode/language-identifiers.html
+LANGUAGE_CODE = 'en-us'
+
+SITE_ID = 1
+
+# If you set this to False, Django will make some optimizations so as not
+# to load the internationalization machinery.
+USE_I18N = True
+
+# Absolute path to the directory that holds media.
+# Example: "/home/media/media.lawrence.com/"
+MEDIA_ROOT = ''
+
+# URL that handles the media served from MEDIA_ROOT. Make sure to use a
+# trailing slash if there is a path component (optional in other cases).
+# Examples: "http://media.lawrence.com", "http://example.com/media/"
+MEDIA_URL = ''
+
+# URL prefix for admin media -- CSS, JavaScript and images. Make sure to use a
+# trailing slash.
+# Examples: "http://foo.com/media/", "/media/".
+ADMIN_MEDIA_PREFIX = '/media/'
+
+# Make this unique, and don't share it with anybody.
+SECRET_KEY = '8s(g1_%+-^@xw*ulzg&gmhj+mp5!m50-p5!721aoai3q67kym!'
+
+# List of callables that know how to import templates from various sources.
+TEMPLATE_LOADERS = (
+    'django.template.loaders.filesystem.load_template_source',
+    'django.template.loaders.app_directories.load_template_source',
+#     'django.template.loaders.eggs.load_template_source',
+)
+
+MIDDLEWARE_CLASSES = (
+    'django.middleware.common.CommonMiddleware',
+    'django.contrib.sessions.middleware.SessionMiddleware',
+    'django.contrib.auth.middleware.AuthenticationMiddleware',
+)
+
+ROOT_URLCONF = 'mygpo.urls'
+
+TEMPLATE_DIRS = (
+    # Put strings here, like "/home/html/django_templates" or "C:/www/django/templates".
+    # Always use forward slashes, even on Windows.
+    # Don't forget to use absolute paths, not relative paths.
+)
+
+INSTALLED_APPS = (
+    'django.contrib.auth',
+    'django.contrib.contenttypes',
+    'django.contrib.sessions',
+    'django.contrib.sites',
+)
diff --git a/urls.py b/urls.py
new file mode 100644
index 0000000..e3d23be
--- /dev/null
+++ b/urls.py
@@ -0,0 +1,17 @@
+from django.conf.urls.defaults import *
+
+# Uncomment the next two lines to enable the admin:
+# from django.contrib import admin
+# admin.autodiscover()
+
+urlpatterns = patterns('',
+    # Example:
+    # (r'^mygpo/', include('mygpo.foo.urls')),
+
+    # Uncomment the admin/doc line below and add 'django.contrib.admindocs' 
+    # to INSTALLED_APPS to enable admin documentation:
+    # (r'^admin/doc/', include('django.contrib.admindocs.urls')),
+
+    # Uncomment the next line to enable the admin:
+    # (r'^admin/', include(admin.site.urls)),
+)
diff --git a/web/__init__.py b/web/__init__.py
new file mode 100644
index 0000000..e69de29
diff --git a/web/models.py b/web/models.py
new file mode 100644
index 0000000..71a8362
--- /dev/null
+++ b/web/models.py
@@ -0,0 +1,3 @@
+from django.db import models
+
+# Create your models here.
diff --git a/web/tests.py b/web/tests.py
new file mode 100644
index 0000000..2247054
--- /dev/null
+++ b/web/tests.py
@@ -0,0 +1,23 @@
+"""
+This file demonstrates two different styles of tests (one doctest and one
+unittest). These will both pass when you run "manage.py test".
+
+Replace these with more appropriate tests for your application.
+"""
+
+from django.test import TestCase
+
+class SimpleTest(TestCase):
+    def test_basic_addition(self):
+        """
+        Tests that 1 + 1 always equals 2.
+        """
+        self.failUnlessEqual(1 + 1, 2)
+
+__test__ = {"doctest": """
+Another way to test that 1 + 1 is equal to 2.
+
+>>> 1 + 1 == 2
+True
+"""}
+
diff --git a/web/views.py b/web/views.py
new file mode 100644
index 0000000..60f00ef
--- /dev/null
+++ b/web/views.py
@@ -0,0 +1 @@
+# Create your views here.
