name: Pull Request Build

on: [pull_request]

jobs:
  build: 

    runs-on: ubuntu 20.04

    services:
      redis:
        image: redis
        ports: 6379:6379
      postgres:
        image: postgres
        env:
          POSTGRES_PASSWORD: postgres
          ports: 5432:5432

    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Python
        uses: actions/setup-python@v2
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coveralls
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          if [ -f requirements-test.txt ]; then pip install -r requirements-test.txt; fi
        |

      - name: Setup PostgreSQL
        run: |
          psql -c 'create database mygpo_test;' -U postgres
        |
      
      - name: Check Format and Coverage
        run: |
          make check-code-format
          python -m pytest --cov=mygpo/ --cov-branch
          python -m coveralls
        |
