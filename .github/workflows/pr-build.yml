name: Pull Request Build

on: [pull_request]

jobs:
  build: 

    runs-on: ubuntu 20.04
    container: python:3.8

    services:
      redis
        image: redis
        ports: 6379:6379
      postgres
        image: postgres
        env:
          POSTGRES_PASSWORD: postgres
          ports: 

    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Python 3.8
        uses: actions/setup-python@v2
          with: 
            python-version: 3.8
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coveralls
          pip install -r requirements.txt requirements-test.txt
        |

      - name: Setup PostgreSQL
        run: |
          psql -c 'create database mygpo_test;' -U postgres
        |
      
      - name: Check Format and Coverage
        run: |
          make check-code-format
          pytest --cov=mygpo/ --cov-branch
          coveralls
        |
