{% extends "base.html" %}
{% load url from future %}
{% load i18n %}
{% load humanize %}
{% load episodes %}
{% load podcasts %}
{% load devices %}
{% load charts %}
{% load facebook %}
{% load google %}
{% load utils %}

{% load menu %}
{% block mainmenu %}{{ "/podcast/"|main_menu }}{% endblock %}
{% block sectionmenu %}
 {% if podcast.title %}
  {{ "/podcast/"|section_menu:podcast.title }}
 {% else %}
  {{ "/podcast/"|section_menu:"Unnamed Podcast" }}
 {% endif %}
{% endblock %}

{% block head %}
 {{ podcast|opengraph_podcast }}
 {% google_plus_one_head %}
{% endblock %}

{% block title %}{{ podcast.title|default:"Unnamed Podcast"|striptags }}{% endblock %}

{% block header %}

   {% if podcast.logo_url %}
    <div id="podcastlogo">{{ podcast|podcast_logo_big }}</div>
   {% endif %}

   <h1>
    {% if podcast.title %}
     {{ podcast.title|striptags }}
    {% else %}
     {% trans "Unnamed Podcast" %}
    {%endif%}
   </h1>

   <small class="description">
    {% if podcast.author %}{% trans "by" %}
     {{ podcast.author|striptags }}
    {% endif %}
    {% if podcast.twitter %}
     <a href="https://twitter.com/{{ podcast.twitter|striptags }}"><i class="icon-twitter"></i></a>
    {% endif %}&middot;
    <a href="{{podcast.url}}" title="{% trans "Feed" %}">
     <i class="icon-rss"></i>
    </a>
    {% if podcast.link %}&middot;
     <a href="{{podcast.link}}" title="{% trans "Website" %}">
      <i class="icon-external-link"></i>
     </a>
    {% endif %}
    {% if podcast.subscriber_count %}&middot;
     {{ podcast.subscriber_count }} {% trans "subscribers" %}
    {% endif %}
   </small>

   {% if related_podcasts %}
    <div class="related-podcasts">
     <strong>{% trans "Also available" %}</strong>
     {% for p in related_podcasts %}
      {% if p.group_member_name != podcast.group_member_name %}
       {% podcast_group_link p p.group_member_name %}
      {% endif %}
     {% endfor %}
    </div>
   {% endif %}

   {% if podcast.description %}
    <div class="description" {% if podcast.language %}lang="{{ podcast.language }}"{% endif %}>
     {{ podcast.description|markdown }}
    </div>
   {% endif %}

{% endblock %}



{% block content %}

  {% if episode %}
   <div class="first-episode">

    <h2>{{ episode.title }} <small>{{ episode.released|naturalday }}</small></h2>
    <div class="description" {% if episode.language or podcast.language %}lang="{% firstof episode.language podcast.language %}"{% endif %}>
     {{ episode.description|default:""|truncatewords:"100"|markdown }}
    </div>
    <a href="{% episode_link_target episode podcast %}">more...</a>

   </div>
  {% endif %}

  {% if episodes %}

  <h3>{% trans "Older Episodes" %}</h3>
   <table class="list episode_list" id="episodes">
    <tr>
     <th></th>
     <th>{% trans "Title" %}</th>
     <th>{% trans "Released" %}</th>
     <th>{% trans "Listeners" %}</th>
    </tr>

    {% for episode in episodes %}
     <tr>
      <td>{{ episode.action|episode_status_icon }}</td>
      <td class="short">
          <div class="title">{% episode_link episode podcast %}</div>
          <div class="description short">{{ episode.description|default:""|truncatewords:"20"|markdown|striptags }}</div>
      </td>
      <td>{{ episode.released|default:""|date:"Y-m-d" }}</td>
      <td>
       {% if episode.listeners %}
        {% vertical_bar episode.listeners max_listeners %}
       {% endif %}
      </td>
     </tr>
    {% endfor %}

    <tr>
     <td></td>
     <td>
      <a href="{% podcast_link_target podcast "podcast-all-episodes" %}">{% trans "All Episodes" %}</a>
     </td>
     <td></td>
     <td></td>
    </tr>

   </table>
  {% endif %}

{% endblock %}


{% block sidebar %}

  <div class="well">
   <h4>{% trans "Subscriptions" %}</h4>
   {% if not user.is_authenticated %}
    <div class="subscribe">
     <a href="{% podcast_link_target podcast "subscribe" %}">
      <img src="/media/subscribe.png" style="vertical-align: middle;" alt=""/>
      {% trans "Subscribe to this podcast" %}
     </a>
    </div>
   {% endif %}

   {% if devices or can_subscribe %}
    <table class="list">
      {% for device in devices %}
       <tr>
        <td>
         {{ device|device_icon }}
         <a href="{% url "device" device.uid %}">{{ device.name|striptags }}</a>
        </td>
        <td style="text-align: center;">
         <form class="form-inline" method="post" action="{% podcast_link_target podcast "unsubscribe" device.uid %}?return_to={% podcast_link_target podcast %}">
          {% csrf_token %}
          <button class="btn btn-danger btn-small" type="submit">
           <i class="icon-remove"></i>
          </button>
         </form>
        </td>
       </tr>
      {% endfor %}
      {% if can_subscribe %}
       <tr>
        <form class="form-inline" action="{% podcast_link_target podcast "subscribe" %}" method="post">
         <td>
          {% csrf_token %}
          <select name="targets" id="id_targets">
           {% for device in subscribe_targets %}
            <option value="{{ device.uid }}">{{ device.name }}</option>
           {% endfor %}
          </select>
         </td>
         <td>
          <button class="btn btn-success btn-small" type="submit">
           <i class="icon-ok"></i>
          </button>
         </td>
        </form>
       </tr>
      {% endif %}
     </table>
   {% endif %}

  </div>


  <div class="well">
   <h4>Tags</h4>

   {% for tag in tags %}
    {% spaceless %}
     {% if tag.is_own %}
      <span class="own">{{ tag.tag }} <a class="remove" href="{% podcast_link_target podcast "remove-tag" %}?tag={{ tag.tag }}">X</a></span>
     {% else %}
       <span class="other">{{ tag.tag }}</span>
     {% endif %}
     {% if not forloop.last %}
      <span class="seperator">,</span>
     {% endif %}
    {% endspaceless %}
   {% endfor %}

   {% if user.is_authenticated %}
    <form class="form-inline" action="{% podcast_link_target podcast "add-tag" %}">
     <div class="input-prepend btn-append">
      <span class="add-on"><i class="icon-tag"></i></span><input class="input-small" type="text" name="tag" /><button class="btn btn-success" type="submit">
      <i class="icon-plus"></i>
     </button>
     </div>
    </form>
   {% endif %}
  </div>

  <div class="well">
   <h4>{% trans "Share" %}</h4>

   {% google_plus_one_button %}
   {{ podcast|fb_like_podcast }}
   {% if can_flattr %}
    <a href="{% podcast_link_target podcast "podcast-flattr" %}">
     <img src="https://api.flattr.com/button/flattr-badge-large.png"
      alt="Flattr {{ podcast.title|default:"Unnamed Podcast"|striptags }}" />
    </a>
   {% endif %}

 </div>


  {% if history %}
  <div class="well">
   <h4>{% trans "Subscription History" %}</h4>
   <table class="list">
    {% for s in history %}
     <tr>
      <td><abbr title="{{ s.timestamp }}">{{ s.timestamp|naturalday }}</abbr></td>
      <td>{{ s|podcast_status_icon }}</td>
      <td>
       {% if s.device %}
        <a href="{% url "device" s.device.uid %}">{{ s.device|device_icon }} {{ s.device.name|striptags }}</a>
       {% endif %}
      </td>
     </tr>
    {% endfor %}
   </table>
  </div>
  {% endif %}

{% endblock %}


{% block ads %}
 {% comment %}disable ads on podcast pages{% endcomment %}
{% endblock %}
